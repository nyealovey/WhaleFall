# æ•°æ®åº“å¤§å°ç›‘æ§åŠŸèƒ½ - æ•°æ®åº“åˆå§‹åŒ–è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åˆå§‹åŒ–æ•°æ®åº“å¤§å°ç›‘æ§åŠŸèƒ½æ‰€éœ€çš„æ•°æ®åº“è¡¨ç»“æ„ã€‚

## ğŸ—‚ï¸ æ–‡ä»¶è¯´æ˜

### 1. `init_database_size_monitoring.sql`
**å®Œæ•´çš„ PostgreSQL åˆå§‹åŒ–è„šæœ¬**
- åŒ…å«æ‰€æœ‰è¡¨ç»“æ„å®šä¹‰
- æ”¯æŒåˆ†åŒºè¡¨åˆ›å»º
- åŒ…å«åˆ†åŒºç®¡ç†å‡½æ•°
- åŒ…å«è§¦å‘å™¨
- åŒ…å«è§†å›¾å’Œç¤ºä¾‹æ•°æ®

### 2. `database_size_monitoring_migration.py`
**Alembic è¿ç§»è„šæœ¬**
- ç”¨äº Alembic è¿ç§»ç³»ç»Ÿ
- åŒ…å«è¡¨ç»“æ„å®šä¹‰
- åŒ…å«åˆ†åŒºåˆ›å»ºé€»è¾‘

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šç›´æ¥æ‰§è¡Œ SQL è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿æ¥åˆ° PostgreSQL æ•°æ®åº“
psql -h your_host -U your_user -d your_database

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
\i sql/init_database_size_monitoring.sql
```

### æ–¹æ³•äºŒï¼šä½¿ç”¨ Alembic è¿ç§»

```bash
# å°†è¿ç§»è„šæœ¬å¤åˆ¶åˆ° migrations/versions/ ç›®å½•
cp sql/database_size_monitoring_migration.py migrations/versions/

# æ‰§è¡Œè¿ç§»
flask db upgrade
```

## ğŸ“Š åˆ›å»ºçš„è¡¨ç»“æ„

### 1. `database_size_stats` - åŸå§‹æ•°æ®è¡¨ï¼ˆåˆ†åŒºè¡¨ï¼‰
- **ç”¨é€”**: å­˜å‚¨æ¯æ—¥é‡‡é›†çš„æ•°æ®åº“å¤§å°æ•°æ®
- **åˆ†åŒº**: æŒ‰æœˆåˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
- **å­—æ®µ**:
  - `id`: ä¸»é”®
  - `instance_id`: å®ä¾‹IDï¼ˆå¤–é”®ï¼‰
  - `database_name`: æ•°æ®åº“åç§°
  - `size_mb`: æ€»å¤§å°ï¼ˆMBï¼‰
  - `data_size_mb`: æ•°æ®å¤§å°ï¼ˆMBï¼‰
  - `log_size_mb`: æ—¥å¿—å¤§å°ï¼ˆMBï¼ŒSQL Serverï¼‰
  - `collected_date`: é‡‡é›†æ—¥æœŸï¼ˆåˆ†åŒºé”®ï¼‰
  - `collected_at`: é‡‡é›†æ—¶é—´æˆ³
  - `created_at`: è®°å½•åˆ›å»ºæ—¶é—´

### 2. `database_size_aggregations` - èšåˆç»Ÿè®¡è¡¨
- **ç”¨é€”**: å­˜å‚¨ç»Ÿè®¡èšåˆæ•°æ®ï¼ˆå‘¨ã€æœˆã€å­£åº¦ï¼‰
- **å­—æ®µ**:
  - `id`: ä¸»é”®
  - `instance_id`: å®ä¾‹IDï¼ˆå¤–é”®ï¼‰
  - `database_name`: æ•°æ®åº“åç§°
  - `period_type`: ç»Ÿè®¡å‘¨æœŸç±»å‹
  - `period_start/end`: ç»Ÿè®¡å‘¨æœŸæ—¥æœŸèŒƒå›´
  - `avg/max/min_size_mb`: å¤§å°ç»Ÿè®¡æŒ‡æ ‡
  - `data_count`: æ•°æ®ç‚¹æ•°é‡
  - å…¶ä»–åˆ†ç±»ç»Ÿè®¡å­—æ®µ

## ğŸ”§ åˆ†åŒºç®¡ç†

### è‡ªåŠ¨åˆ†åŒºåˆ›å»º
- ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºå½“å‰æœˆä»½å’Œæœªæ¥3ä¸ªæœˆçš„åˆ†åŒº
- æ’å…¥æ•°æ®æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ‰€éœ€åˆ†åŒº

### æ‰‹åŠ¨åˆ†åŒºç®¡ç†
```sql
-- åˆ›å»ºæŒ‡å®šæœˆä»½çš„åˆ†åŒº
SELECT create_database_size_partition('2024-01-01');

-- åˆ é™¤æŒ‡å®šæœˆä»½çš„åˆ†åŒº
SELECT drop_database_size_partition('2024-01-01');

-- æ¸…ç†æ—§åˆ†åŒºï¼ˆä¿ç•™12ä¸ªæœˆï¼‰
SELECT cleanup_old_database_size_partitions(12);
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ç­–ç•¥
- **åˆ†åŒºé”®ç´¢å¼•**: `collected_date`
- **æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•**: `instance_id, collected_date`
- **å”¯ä¸€çº¦æŸ**: `instance_id, database_name, collected_date`

### åˆ†åŒºç­–ç•¥
- **åˆ†åŒºæ–¹å¼**: æŒ‰æœˆåˆ†åŒº
- **åˆ†åŒºå‘½å**: `database_size_stats_YYYY_MM`
- **è‡ªåŠ¨åˆ›å»º**: æ’å…¥æ•°æ®æ—¶è‡ªåŠ¨åˆ›å»ºåˆ†åŒº

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢æœ€è¿‘30å¤©çš„æ•°æ®
```sql
SELECT * FROM v_database_size_recent 
WHERE instance_id = 1 
ORDER BY collected_date DESC;
```

### æŸ¥è¯¢ç»Ÿè®¡èšåˆæ•°æ®
```sql
SELECT * FROM v_database_size_aggregations_recent 
WHERE period_type = 'monthly' 
AND instance_id = 1 
ORDER BY period_start DESC;
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åˆ†åŒºè¡¨é™åˆ¶**: åˆ†åŒºè¡¨çš„ä¸»é”®å¿…é¡»åŒ…å«åˆ†åŒºé”®
2. **å¤–é”®çº¦æŸ**: ç¡®ä¿ `instances` è¡¨å­˜åœ¨
3. **æƒé™è®¾ç½®**: ä¸ºåº”ç”¨ç”¨æˆ·æˆäºˆé€‚å½“çš„æƒé™
4. **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½åˆ†åŒºæ•°æ®
5. **ç›‘æ§**: ç›‘æ§åˆ†åŒºå¤§å°å’ŒæŸ¥è¯¢æ€§èƒ½

## ğŸ› ï¸ ç»´æŠ¤ä»»åŠ¡

### å®šæœŸä»»åŠ¡
1. **åˆ›å»ºæœªæ¥åˆ†åŒº**: æ¯æœˆåˆ›å»ºä¸‹æœˆåˆ†åŒº
2. **æ¸…ç†æ—§åˆ†åŒº**: å®šæœŸæ¸…ç†è¶…è¿‡ä¿ç•™æœŸçš„åˆ†åŒº
3. **ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**: å®šæœŸæ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
4. **ç´¢å¼•ç»´æŠ¤**: å®šæœŸé‡å»ºæˆ–é‡æ–°ç»„ç»‡ç´¢å¼•

### ç›‘æ§æŒ‡æ ‡
- åˆ†åŒºæ•°é‡
- åˆ†åŒºå¤§å°
- æŸ¥è¯¢æ€§èƒ½
- å­˜å‚¨ä½¿ç”¨é‡

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- é¡¹ç›®æ–‡æ¡£: `docs/features/database_size_monitoring_feature.md`
- æŠ€æœ¯è§„æ ¼: `docs/architecture/spec.md`
- å¼€å‘æŒ‡å—: `docs/development/DEVELOPMENT_SETUP.md`
