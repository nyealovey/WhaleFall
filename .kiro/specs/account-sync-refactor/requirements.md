# 需求文档

## 简介

本项目的账户同步功能在完成未使用代码清理后，仍然存在大量重复代码，需要进一步重构以提高代码可维护性和可扩展性。

### 当前状态

已完成第一阶段清理工作：
- ✅ 删除了 BaseSyncAdapter 中的非批量方法（约187行）
- ✅ 删除了 MySQLSyncAdapter 中的废弃解析方法（约14行）
- ✅ 删除了 OracleSyncAdapter 中的单用户查询方法（约184行）
- ✅ 删除了 SQLServerSyncAdapter 中未使用的单用户批量方法（约232行）
- ✅ 总计删除约617行未使用代码（占总代码量的18.2%）

### 待解决问题

当前有一个基类 `BaseSyncAdapter` 和四个数据库特定的适配器（MySQL、Oracle、PostgreSQL、SQL Server），它们之间仍存在以下重复代码问题：

1. **权限检测逻辑重复**：每个适配器都实现了相似的 `_detect_changes` 方法
2. **权限更新逻辑重复**：每个适配器都实现了相似的 `_update_account_permissions` 方法
3. **账户创建逻辑重复**：每个适配器都实现了相似的 `_create_new_account` 方法
4. **变更描述生成重复**：每个适配器都实现了相似的 `_generate_change_description` 方法
5. **过滤条件构建重复**：每个适配器都有相似的 `_build_filter_conditions` 方法
6. **缺乏统一的权限字段映射**：不同数据库的权限字段映射逻辑分散在各个适配器中

## 术语表

- **BaseSyncAdapter（基础同步适配器）**: 账户同步适配器的抽象基类，定义了同步流程和通用接口
- **Adapter（适配器）**: 数据库特定的同步适配器，继承自 BaseSyncAdapter
- **CurrentAccountSyncData（当前账户同步数据）**: 存储当前账户同步数据的数据模型
- **Permission Field（权限字段）**: 权限字段，如 global_privileges、database_privileges 等
- **Type-Specific Field（类型特定字段）**: 数据库特定字段，存储在 type_specific JSON 字段中
- **Change Detection（变更检测）**: 变更检测，比较新旧权限数据以识别变化
- **Permission Mapping（权限映射）**: 权限映射，将数据库特定的权限数据映射到统一的数据模型字段
- **Batch Manager（批量管理器）**: DatabaseBatchManager，用于批量提交数据库操作的工具类

## 需求

### 需求 1: 统一权限字段映射配置

**用户故事：** 作为开发者，我希望有一个统一的权限字段映射配置，这样我可以轻松地为不同数据库定义权限字段映射关系，而不需要在每个适配器中重复编写映射逻辑。

#### 验收标准

1. 当需要为某个数据库类型定义权限映射时，系统应当提供集中式的权限字段映射配置
2. 当添加新的数据库类型时，系统应当允许开发者通过配置定义权限字段映射
3. 系统应当支持数据库特定权限数据与 CurrentAccountSyncData 模型字段之间的映射
4. 系统应当验证每个数据库类型的所有必需权限字段都已映射

### 需求 2: 提取通用变更检测逻辑

**用户故事：** 作为开发者，我希望变更检测逻辑被提取到基类中，这样我不需要在每个适配器中重复实现相同的比较逻辑。

#### 验收标准

1. BaseSyncAdapter 应当实现一个适用于所有数据库类型的通用变更检测方法
2. 当比较新旧权限时，系统应当使用权限字段映射配置来识别需要比较的字段
3. 系统应当检测超级用户状态、活跃状态以及所有权限相关字段的变更
4. 对于列表/集合类型的字段，系统应当返回包含新增和删除项的结构化变更字典
5. 系统应当处理数据库级别和对象级别权限的嵌套字典比较

### 需求 3: 提取通用权限更新逻辑

**用户故事：** 作为开发者，我希望权限更新逻辑被提取到基类中，这样我不需要在每个适配器中重复实现相同的更新逻辑。

#### 验收标准

1. BaseSyncAdapter 应当实现一个适用于所有数据库类型的通用权限更新方法
2. 当更新账户权限时，系统应当使用权限字段映射配置来更新正确的模型字段
3. 系统应当基于映射配置更新 is_superuser、is_active 以及所有权限相关字段
4. 系统应当自动设置 last_change_type、last_change_time 和 last_sync_time
5. 系统应当在更新权限后清除账户缓存

### 需求 4: 提取通用账户创建逻辑

**用户故事：** 作为开发者，我希望账户创建逻辑被提取到基类中，这样我不需要在每个适配器中重复实现相同的创建逻辑。

#### 验收标准

1. BaseSyncAdapter 应当实现一个适用于所有数据库类型的通用账户创建方法
2. 当创建新账户时，系统应当使用权限字段映射配置来填充正确的模型字段
3. 系统应当设置 instance_id、db_type、username、is_superuser、is_active 和 session_id
4. 系统应当基于映射配置填充所有权限相关字段
5. 对于新账户，系统应当将 last_change_type 设置为 "add"

### 需求 5: 提取通用变更描述生成逻辑

**用户故事：** 作为开发者，我希望变更描述生成逻辑被提取到基类中，这样我不需要在每个适配器中重复实现相同的描述生成逻辑。

#### 验收标准

1. BaseSyncAdapter 应当实现一个通用的变更描述生成方法
2. 当生成变更描述时，系统应当使用权限字段映射配置来识别字段名称
3. 系统应当为超级用户状态变更生成人类可读的描述
4. 系统应当为权限的新增和删除生成描述
5. 系统应当处理嵌套的权限结构（例如数据库级别的权限）

### 需求 6: 简化过滤条件构建

**用户故事：** 作为开发者，我希望过滤条件构建逻辑更加简洁，这样我不需要在每个适配器中重复相似的代码。

#### 验收标准

1. BaseSyncAdapter 应当提供一个用于构建过滤条件的辅助方法
2. 当构建过滤条件时，系统应当使用带有数据库特定设置的 SafeQueryBuilder
3. 系统应当接受数据库类型、字段名、排除用户和排除模式作为参数
4. 系统应当返回一个可直接用于 SQL 查询的元组 (where_clause, params)

### 需求 7: 保持向后兼容性

**用户故事：** 作为系统管理员，我希望重构后的代码保持向后兼容，这样现有的同步功能不会受到影响。

#### 验收标准

1. 系统应当为所有适配器类维护相同的公共 API
2. 当重构完成时，系统应当产生与之前相同的同步结果
3. 系统不应当破坏现有的数据库连接或查询
4. 系统应当维护相同的日志记录行为
5. 系统不应当引入性能退化

### 需求 8: 优化批量操作性能

**用户故事：** 作为系统管理员，我希望重构后的代码能够保持或提升批量操作的性能，这样大规模账户同步时不会出现性能问题。

#### 验收标准

1. 系统应当继续使用 DatabaseBatchManager 进行批量提交
2. 当处理大量账户时，系统应当保持当前的批量处理性能
3. 系统应当在批量操作失败时能够正确回滚
4. 系统应当记录批量操作的性能指标（如处理时间、账户数量）
5. 系统不应当在重构后增加数据库查询次数
