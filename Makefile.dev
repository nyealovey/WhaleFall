# é²¸è½å¼€å‘çŽ¯å¢ƒ Makefile
# æä¾›å¼€å‘çŽ¯å¢ƒçš„æž„å»ºå’Œç®¡ç†å‘½ä»¤

.PHONY: help install start start-db start-flask stop restart status logs clean shell init-db init-db-quick health

# é»˜è®¤ç›®æ ‡
help:
	@echo "ðŸŸ é²¸è½å¼€å‘çŽ¯å¢ƒå‘½ä»¤"
	@echo "=================================="
	@echo "çŽ¯å¢ƒç®¡ç†:"
	@echo "  install     - å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  start-db    - å¯åŠ¨æ•°æ®åº“æœåŠ¡ (PostgreSQL + Redis)"
	@echo "  start-flask - å¯åŠ¨Flaskåº”ç”¨ (æ‰‹åŠ¨æ¨¡å¼)"
	@echo "  start       - å¯åŠ¨å®Œæ•´å¼€å‘çŽ¯å¢ƒ"
	@echo "  stop        - åœæ­¢å¼€å‘çŽ¯å¢ƒ"
	@echo "  restart     - é‡å¯å¼€å‘çŽ¯å¢ƒ"
	@echo "  status      - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo ""
	@echo "æ•°æ®åº“ç®¡ç†:"
	@echo "  init-db     - æ‰‹åŠ¨åˆå§‹åŒ–æ•°æ®åº“"
	@echo "  init-db-quick - å¿«é€Ÿåˆå§‹åŒ–æ•°æ®åº“"
	@echo ""
	@echo "å¼€å‘å·¥å…·:"
	@echo "  logs        - æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—"
	@echo "  logs-db     - æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—"
	@echo "  logs-redis  - æŸ¥çœ‹Redisæ—¥å¿—"
	@echo "  logs-app    - æŸ¥çœ‹åº”ç”¨æ—¥å¿—"
	@echo "  shell       - è¿›å…¥åº”ç”¨å®¹å™¨"
	@echo "  health      - å¥åº·æ£€æŸ¥"
	@echo ""
	@echo "ç»´æŠ¤å‘½ä»¤:"
	@echo "  clean       - æ¸…ç†Dockerèµ„æº"
	@echo "  clean-data  - æ¸…ç†æ•°æ®å·"
	@echo "=================================="

# å®‰è£…å¼€å‘ä¾èµ–
install:
	@echo "ðŸ“¦ å®‰è£…å¼€å‘ä¾èµ–..."
	@if command -v uv >/dev/null 2>&1; then \
		echo "ä½¿ç”¨ uv å®‰è£…ä¾èµ–..."; \
		uv sync; \
	else \
		echo "ä½¿ç”¨ pip å®‰è£…ä¾èµ–..."; \
		pip install -r requirements.txt; \
	fi
	@echo "âœ… å¼€å‘ä¾èµ–å®‰è£…å®Œæˆ"

# å¯åŠ¨æ•°æ®åº“æœåŠ¡
start-db:
	@echo "ðŸš€ å¯åŠ¨æ•°æ®åº“æœåŠ¡..."
	./scripts/dev/start-dev-db.sh

# å¯åŠ¨Flaskåº”ç”¨
start-flask:
	@echo "ðŸš€ å¯åŠ¨Flaskåº”ç”¨..."
	./scripts/dev/start-flask.sh

# å¯åŠ¨å®Œæ•´å¼€å‘çŽ¯å¢ƒ
start:
	@echo "ðŸš€ å¯åŠ¨å®Œæ•´å¼€å‘çŽ¯å¢ƒ..."
	@echo "1. å¯åŠ¨æ•°æ®åº“æœåŠ¡..."
	./scripts/dev/start-dev-db.sh
	@echo ""
	@echo "2. å¯åŠ¨Flaskåº”ç”¨..."
	@echo "è¯·åœ¨æ–°ç»ˆç«¯ä¸­è¿è¡Œ: make start-flask"
	@echo "æˆ–ç›´æŽ¥è¿è¡Œ: ./scripts/dev/start-flask.sh"

# å¯åŠ¨Flaskåº”ç”¨ (æ—§ç‰ˆæœ¬ï¼Œå·²åºŸå¼ƒ)
start-flask-old:
	@echo "ðŸš€ å¯åŠ¨Flaskåº”ç”¨..."
	@echo "ðŸ” éªŒè¯çŽ¯å¢ƒå˜é‡..."
	@./scripts/validate_env.sh
	@echo "ðŸ³ å¯åŠ¨Flaskå®¹å™¨..."
	@docker-compose -f docker-compose.dev.yml --profile flask up -d whalefall
	@echo "âœ… Flaskåº”ç”¨å¯åŠ¨å®Œæˆ"
	@echo "ðŸŒ åº”ç”¨åœ°å€: http://localhost"

# åœæ­¢å¼€å‘çŽ¯å¢ƒ
stop:
	@echo "â¹ï¸  åœæ­¢å¼€å‘çŽ¯å¢ƒ..."
	@docker compose -f docker-compose.dev.yml down
	@echo "âœ… å¼€å‘çŽ¯å¢ƒå·²åœæ­¢"
	@echo "ðŸ’¡ Flaskåº”ç”¨éœ€è¦æ‰‹åŠ¨åœæ­¢ (Ctrl+C)"

# é‡å¯å¼€å‘çŽ¯å¢ƒ
restart: stop start

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ðŸ“Š å¼€å‘çŽ¯å¢ƒæœåŠ¡çŠ¶æ€ï¼š"
	@echo "=================================="
	@docker-compose -f docker-compose.dev.yml ps
	@echo "=================================="

# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
logs:
	@echo "ðŸ“‹ æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—..."
	@docker-compose -f docker-compose.dev.yml logs -f

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
logs-db:
	@echo "ðŸ“‹ æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—..."
	@docker-compose -f docker-compose.dev.yml logs -f postgres

# æŸ¥çœ‹Redisæ—¥å¿—
logs-redis:
	@echo "ðŸ“‹ æŸ¥çœ‹Redisæ—¥å¿—..."
	@docker-compose -f docker-compose.dev.yml logs -f redis

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
logs-app:
	@echo "ðŸ“‹ æŸ¥çœ‹åº”ç”¨æ—¥å¿—..."
	@docker-compose -f docker-compose.dev.yml logs -f whalefall

# è¿›å…¥åº”ç”¨å®¹å™¨
shell:
	@echo "ðŸš è¿›å…¥åº”ç”¨å®¹å™¨..."
	@docker-compose -f docker-compose.dev.yml exec whalefall bash

# å¥åº·æ£€æŸ¥
health:
	@echo "ðŸ¥ å¥åº·æ£€æŸ¥..."
	@echo "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
	@curl -s http://localhost/health || echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
	@echo "æ£€æŸ¥PostgreSQLè¿žæŽ¥..."
	@docker-compose -f docker-compose.dev.yml exec postgres pg_isready -U whalefall_user -d whalefall_dev || echo "âŒ PostgreSQLè¿žæŽ¥å¤±è´¥"
	@echo "æ£€æŸ¥Redisè¿žæŽ¥..."
	@docker-compose -f docker-compose.dev.yml exec redis redis-cli ping || echo "âŒ Redisè¿žæŽ¥å¤±è´¥"

# æ•°æ®åº“åˆå§‹åŒ–
init-db:
	@echo "ðŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“..."
	@if [ -z "$$DB_PASSWORD" ]; then \
		echo "âŒ é”™è¯¯: è¯·è®¾ç½®çŽ¯å¢ƒå˜é‡ DB_PASSWORD"; \
		echo "ç¤ºä¾‹: DB_PASSWORD=mypassword make init-db"; \
		exit 1; \
	fi
	@./scripts/database/init_database.sh

# å¿«é€Ÿæ•°æ®åº“åˆå§‹åŒ–
init-db-quick:
	@echo "âš¡ å¿«é€Ÿåˆå§‹åŒ–æ•°æ®åº“..."
	@if [ -z "$$DB_PASSWORD" ]; then \
		echo "âŒ é”™è¯¯: è¯·è®¾ç½®çŽ¯å¢ƒå˜é‡ DB_PASSWORD"; \
		echo "ç¤ºä¾‹: DB_PASSWORD=mypassword make init-db-quick"; \
		exit 1; \
	fi
	@./scripts/database/quick_init.sh

# æ¸…ç†Dockerèµ„æº
clean:
	@echo "ðŸ§¹ æ¸…ç†Dockerèµ„æº..."
	@docker-compose -f docker-compose.dev.yml down -v
	@docker system prune -f
	@echo "âœ… Dockerèµ„æºæ¸…ç†å®Œæˆ"

# æ¸…ç†æ•°æ®å·
clean-data:
	@echo "ðŸ—‘ï¸  æ¸…ç†æ•°æ®å·..."
	@docker-compose -f docker-compose.dev.yml down -v
	@docker volume prune -f
	@echo "âœ… æ•°æ®å·æ¸…ç†å®Œæˆ"

# å·ç®¡ç†
volumes:
	@echo "ðŸ“¦ å·ç®¡ç†..."
	@./scripts/docker/volume_manager.sh list

# åˆ›å»ºå·
create-volumes:
	@echo "ðŸ“¦ åˆ›å»ºå¼€å‘çŽ¯å¢ƒå·..."
	@./scripts/docker/volume_manager.sh create dev

# å¤‡ä»½å·
backup-volumes:
	@echo "ðŸ’¾ å¤‡ä»½å¼€å‘çŽ¯å¢ƒå·..."
	@./scripts/docker/volume_manager.sh backup dev

# æ¢å¤å·
restore-volumes:
	@echo "ðŸ”„ æ¢å¤å¼€å‘çŽ¯å¢ƒå·..."
	@./scripts/docker/volume_manager.sh restore dev

# è¿ç§»æ•°æ®åˆ°å·
migrate-volumes:
	@echo "ðŸ”„ è¿ç§»æ•°æ®åˆ°å·..."
	@./scripts/docker/volume_manager.sh migrate dev

# æŸ¥çœ‹å·å¤§å°
volume-size:
	@echo "ðŸ“Š æŸ¥çœ‹å·å¤§å°..."
	@./scripts/docker/volume_manager.sh size dev

# æž„å»ºå¼€å‘é•œåƒ
build:
	@echo "ðŸ”¨ æž„å»ºå¼€å‘é•œåƒ..."
	@docker-compose -f docker-compose.dev.yml build

# è¿è¡Œæµ‹è¯•
test:
	@echo "ðŸ§ª è¿è¡Œæµ‹è¯•..."
	@if command -v uv >/dev/null 2>&1; then \
		uv run pytest tests/; \
	else \
		python -m pytest tests/; \
	fi

# ä»£ç è´¨é‡æ£€æŸ¥
quality:
	@echo "ðŸ” ä»£ç è´¨é‡æ£€æŸ¥..."
	@if command -v uv >/dev/null 2>&1; then \
		uv run ruff check .; \
		uv run mypy .; \
	else \
		ruff check .; \
		mypy .; \
	fi

# æ ¼å¼åŒ–ä»£ç 
format:
	@echo "ðŸŽ¨ æ ¼å¼åŒ–ä»£ç ..."
	@if command -v uv >/dev/null 2>&1; then \
		uv run black .; \
		uv run isort .; \
	else \
		black .; \
		isort .; \
	fi