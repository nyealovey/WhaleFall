# é²¸è½å¼€å‘ç¯å¢ƒ Makefile
# ç›®æ ‡: åœ¨æœ¬æœºå¯åŠ¨ä¾èµ–æœåŠ¡(PostgreSQL/Redis)å¹¶æä¾›æœ€å°çš„å¼€å‘è‡ªæ£€å‘½ä»¤

.PHONY: help start stop restart status logs logs-db logs-redis logs-app shell health init-db init-db-quick clean clean-data test quality format typecheck

COMPOSE ?= docker compose
DEV_COMPOSE_FILE ?= docker-compose.dev.yml

help:
	@echo "ğŸŸ é²¸è½å¼€å‘ç¯å¢ƒå‘½ä»¤"
	@echo "=================================="
	@echo "æœåŠ¡ç®¡ç†:"
	@echo "  start       - å¯åŠ¨å¼€å‘ä¾èµ–(PostgreSQL + Redis)"
	@echo "  stop        - åœæ­¢å¼€å‘ä¾èµ–"
	@echo "  restart     - é‡å¯å¼€å‘ä¾èµ–"
	@echo "  status      - æŸ¥çœ‹ä¾èµ–çŠ¶æ€"
	@echo ""
	@echo "æ—¥å¿—:"
	@echo "  logs        - æŸ¥çœ‹ä¾èµ–æ—¥å¿—"
	@echo "  logs-db     - æŸ¥çœ‹ PostgreSQL æ—¥å¿—"
	@echo "  logs-redis  - æŸ¥çœ‹ Redis æ—¥å¿—"
	@echo "  logs-app    - æŸ¥çœ‹æœ¬åœ° app.log(è‹¥å­˜åœ¨)"
	@echo ""
	@echo "æ•°æ®åº“:"
	@echo "  init-db     - è¿è¡Œè¿ç§»(flask db upgrade)"
	@echo "  init-db-quick - åŒ init-db"
	@echo ""
	@echo "æ¸…ç†:"
	@echo "  clean       - åœæ­¢å®¹å™¨(ä¿ç•™ volumes)"
	@echo "  clean-data  - åœæ­¢å¹¶åˆ é™¤ volumes(æ¸…ç©ºæ•°æ®)"
	@echo ""
	@echo "è‡ªæ£€(å¯é€‰):"
	@echo "  test        - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  quality     - ruff + pyright + unit"
	@echo "  format      - æ ¼å¼åŒ–(black/isort)"
	@echo "  typecheck   - ç±»å‹æ£€æŸ¥(pyright)"
	@echo "=================================="

start:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ä¾èµ–(PostgreSQL + Redis)..."
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) up -d postgres redis
	@echo "âœ… å¼€å‘ä¾èµ–å·²å¯åŠ¨"

stop:
	@echo "â¹ï¸  åœæ­¢å¼€å‘ä¾èµ–..."
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) down
	@echo "âœ… å¼€å‘ä¾èµ–å·²åœæ­¢"

restart: stop start

status:
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) ps

logs:
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) logs -f --tail=200

logs-db:
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) logs -f --tail=200 postgres

logs-redis:
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) logs -f --tail=200 redis

logs-app:
	@tail -n 200 -f userdata/logs/app.log

shell:
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) exec postgres psql -U "$${POSTGRES_USER:-whalefall_user}" -d "$${POSTGRES_DB:-whalefall_dev}"

health:
	@echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) exec postgres pg_isready -U "$${POSTGRES_USER:-whalefall_user}" -d "$${POSTGRES_DB:-whalefall_dev}"
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) exec redis sh -lc "redis-cli -a \"$${REDIS_PASSWORD:-dev}\" ping | grep -q PONG"
	@echo "âœ… ä¾èµ–æœåŠ¡å¥åº·"

init-db:
	@echo "ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“(è¿è¡Œè¿ç§»)..."
	@uv run flask --app app:create_app db upgrade
	@echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

init-db-quick: init-db

clean: stop

clean-data:
	@echo "ğŸ§¹ æ¸…ç†å¼€å‘ä¾èµ–(åˆ é™¤ volumes, æ•°æ®å°†ä¸¢å¤±)..."
	@$(COMPOSE) -f $(DEV_COMPOSE_FILE) down -v --remove-orphans
	@echo "âœ… å¼€å‘æ•°æ®å·²æ¸…ç©º"

test:
	@uv run pytest -m unit

quality:
	@./scripts/ci/ruff-report.sh style
	@./scripts/ci/pyright-report.sh
	@uv run pytest -m unit

format:
	@$(MAKE) format

typecheck:
	@$(MAKE) typecheck

