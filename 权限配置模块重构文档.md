# 权限配置模块重构文档

## 一、重构目标

将 `account_classification.js` 中的权限配置相关逻辑抽离到独立的模块中，实现：
1. 代码复用 - 权限配置逻辑可在多个页面使用
2. 易于维护 - 权限相关代码集中管理
3. 易于扩展 - 新增数据库类型只需添加对应策略

## 二、当前问题

### 2.1 权限配置逻辑分散

在 `account_classification.js` 中，权限相关的代码分散在多个函数中：

```javascript
// 1. 加载权限配置 (第 468 行)
function loadPermissions(prefix = '') { ... }

// 2. 显示权限配置 (第 491 行)
function displayPermissionsConfig(permissions, prefix = '', dbType = '') { ... }

// 3. 收集选中的权限 (第 768 行 - submitCreateRule)
// MySQL
const selectedGlobalPermissions = [];
const selectedDatabasePermissions = [];
checkboxes.forEach(checkbox => {
    if (checkbox.id.startsWith('global_')) { ... }
    else if (checkbox.id.startsWith('db_')) { ... }
});

// SQL Server
const selectedServerRoles = [];
const selectedServerPermissions = [];
const selectedDatabaseRoles = [];
const selectedDatabasePermissions = [];
...

// PostgreSQL
const selectedPredefinedRoles = [];
const selectedRoleAttributes = [];
...

// Oracle
const selectedRoles = [];
const selectedSystemPermissions = [];
...

// 4. 设置选中的权限 (第 1047 行)
function setSelectedPermissions(ruleExpression, prefix = '') { ... }

// 5. 显示查看权限 (第 1280 行)
function displayViewPermissions(ruleExpression, dbType) { ... }
```

### 2.2 代码重复严重

每个数据库类型的权限处理逻辑都需要在多个地方重复实现：
- 显示权限选择器（创建规则）
- 显示权限选择器（编辑规则）
- 收集选中权限（创建规则）
- 收集选中权限（更新规则）
- 设置选中权限（编辑规则）
- 显示权限详情（查看规则）

### 2.3 硬编码的数据库类型判断

```javascript
if (dbType === 'mysql') { ... }
else if (dbType === 'sqlserver') { ... }
else if (dbType === 'postgresql') { ... }
else if (dbType === 'oracle') { ... }
```

这种判断在代码中出现了 6+ 次，新增数据库类型需要修改多处。

## 三、重构方案

### 3.1 模块结构

```
app/static/js/common/
├── permission-config.js          # 权限配置主模块（新增）
└── permission-modal.js           # 权限模态框（已存在）
```

### 3.2 核心设计

#### 3.2.1 策略模式

使用策略模式处理不同数据库类型的权限逻辑：

```javascript
// 权限策略基类
class PermissionStrategy {
    constructor(dbType) {
        this.dbType = dbType;
    }
    
    // 渲染权限选择器（用于创建/编辑规则）
    renderSelector(permissions, prefix = '') { }
    
    // 收集选中的权限
    collectSelected(container, prefix = '') { }
    
    // 构建规则表达式
    buildExpression(selectedPermissions, operator) { }
    
    // 设置选中的权限（用于编辑规则）
    setSelected(ruleExpression, container, prefix = '') { }
    
    // 渲染权限显示（用于查看规则）
    renderDisplay(ruleExpression) { }
}
```

#### 3.2.2 策略注册表

```javascript
const PERMISSION_STRATEGIES = {
    'mysql': MySQLPermissionStrategy,
    'sqlserver': SQLServerPermissionStrategy,
    'postgresql': PostgreSQLPermissionStrategy,
    'oracle': OraclePermissionStrategy
};

function getPermissionStrategy(dbType) {
    const StrategyClass = PERMISSION_STRATEGIES[dbType];
    if (!StrategyClass) {
        return new DefaultPermissionStrategy(dbType);
    }
    return new StrategyClass(dbType);
}
```

### 3.3 API 设计

#### 3.3.1 PermissionConfig 主类

```javascript
class PermissionConfig {
    /**
     * 加载并显示权限配置
     * @param {string} dbType - 数据库类型
     * @param {string} containerId - 容器元素ID
     * @param {string} prefix - ID前缀（用于区分创建/编辑表单）
     * @returns {Promise<void>}
     */
    static async load(dbType, containerId, prefix = '') { }
    
    /**
     * 收集选中的权限
     * @param {string} dbType - 数据库类型
     * @param {string} containerId - 容器元素ID
     * @param {string} prefix - ID前缀
     * @returns {Object} 选中的权限数据
     */
    static collectSelected(dbType, containerId, prefix = '') { }
    
    /**
     * 构建规则表达式
     * @param {string} dbType - 数据库类型
     * @param {Object} selectedPermissions - 选中的权限
     * @param {string} operator - 操作符 (AND/OR)
     * @returns {Object} 规则表达式
     */
    static buildExpression(dbType, selectedPermissions, operator) { }
    
    /**
     * 设置选中的权限（用于编辑）
     * @param {string} dbType - 数据库类型
     * @param {Object} ruleExpression - 规则表达式
     * @param {string} containerId - 容器元素ID
     * @param {string} prefix - ID前缀
     */
    static setSelected(dbType, ruleExpression, containerId, prefix = '') { }
    
    /**
     * 渲染权限显示（用于查看）
     * @param {string} dbType - 数据库类型
     * @param {Object} ruleExpression - 规则表达式
     * @returns {string} HTML字符串
     */
    static renderDisplay(dbType, ruleExpression) { }
}
```

### 3.4 使用示例

#### 3.4.1 创建规则时加载权限配置

**重构前：**
```javascript
function loadPermissions(prefix = '') {
    const dbType = document.getElementById(prefix ? `${prefix}RuleDbType` : 'ruleDbType').value;
    if (!dbType) {
        document.getElementById(containerId).innerHTML = '请先选择数据库类型';
        return;
    }
    
    return http.get(`/account_classification/api/permissions/${dbType}`)
        .then(data => {
            if (data.success) {
                displayPermissionsConfig(data.permissions, prefix, dbType);
            }
        });
}
```

**重构后：**
```javascript
async function loadPermissions(prefix = '') {
    const dbType = document.getElementById(prefix ? `${prefix}RuleDbType` : 'ruleDbType').value;
    const containerId = prefix ? `${prefix}PermissionsConfig` : 'permissionsConfig';
    
    await PermissionConfig.load(dbType, containerId, prefix);
}
```

#### 3.4.2 创建规则时收集权限

**重构前：**
```javascript
function submitCreateRule(form) {
    const dbType = form.querySelector('#ruleDbType').value;
    const operator = form.querySelector('#ruleOperator').value;
    
    // 收集选中的权限
    const selectedPermissions = [];
    const checkboxes = document.querySelectorAll('#permissionsConfig input[type="checkbox"]:checked');
    
    let ruleExpression;
    if (dbType === 'mysql') {
        const selectedGlobalPermissions = [];
        const selectedDatabasePermissions = [];
        checkboxes.forEach(checkbox => {
            if (checkbox.id.startsWith('global_')) {
                selectedGlobalPermissions.push(checkbox.value);
            } else if (checkbox.id.startsWith('db_')) {
                selectedDatabasePermissions.push(checkbox.value);
            }
        });
        ruleExpression = {
            type: 'mysql_permissions',
            global_privileges: selectedGlobalPermissions,
            database_privileges: selectedDatabasePermissions,
            operator: operator
        };
    } else if (dbType === 'sqlserver') {
        // ... 类似的重复代码
    }
    // ... 更多数据库类型
}
```

**重构后：**
```javascript
function submitCreateRule(form) {
    const dbType = form.querySelector('#ruleDbType').value;
    const operator = form.querySelector('#ruleOperator').value;
    
    // 收集选中的权限
    const selectedPermissions = PermissionConfig.collectSelected(
        dbType, 
        'permissionsConfig', 
        ''
    );
    
    if (Object.keys(selectedPermissions).length === 0) {
        toast.warning('请至少选择一个权限');
        return;
    }
    
    // 构建规则表达式
    const ruleExpression = PermissionConfig.buildExpression(
        dbType, 
        selectedPermissions, 
        operator
    );
    
    // 提交数据
    const data = {
        classification_id: parseInt(classificationId),
        rule_name: ruleName,
        db_type: dbType,
        rule_expression: ruleExpression
    };
    
    // ... 发送请求
}
```

#### 3.4.3 编辑规则时设置权限

**重构前：**
```javascript
function setSelectedPermissions(ruleExpression, prefix = '') {
    if (!ruleExpression) return;
    
    if (ruleExpression.type === 'mysql_permissions') {
        if (ruleExpression.global_privileges) {
            ruleExpression.global_privileges.forEach(perm => {
                const checkbox = document.getElementById(`${prefix}global_${perm}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        // ... 更多代码
    } else if (ruleExpression.type === 'sqlserver_permissions') {
        // ... 类似的重复代码
    }
    // ... 更多数据库类型
}
```

**重构后：**
```javascript
function editRule(id) {
    http.get(`/account_classification/api/rules/${id}`)
        .then(data => {
            if (data.success) {
                const rule = data.data.rule;
                
                // 填充表单...
                
                // 加载权限配置并设置选中状态
                PermissionConfig.load(rule.db_type, 'editPermissionsConfig', 'edit')
                    .then(() => {
                        PermissionConfig.setSelected(
                            rule.db_type,
                            rule.rule_expression,
                            'editPermissionsConfig',
                            'edit'
                        );
                    });
            }
        });
}
```

#### 3.4.4 查看规则时显示权限

**重构前：**
```javascript
function displayViewPermissions(ruleExpression, dbType) {
    const container = document.getElementById('viewPermissionsConfig');
    
    let html = '<div class="row">';
    
    if (ruleExpression.type === 'mysql_permissions') {
        if (ruleExpression.global_privileges && ruleExpression.global_privileges.length > 0) {
            html += `<div class="col-md-6">
                <h6>全局权限</h6>
                ${ruleExpression.global_privileges.map(perm => 
                    `<span class="badge bg-primary">${perm}</span>`
                ).join('')}
            </div>`;
        }
        // ... 更多代码
    } else if (ruleExpression.type === 'sqlserver_permissions') {
        // ... 类似的重复代码
    }
    // ... 更多数据库类型
    
    html += '</div>';
    container.innerHTML = html;
}
```

**重构后：**
```javascript
function viewRule(id) {
    http.get(`/account_classification/api/rules/${id}`)
        .then(data => {
            if (data.success) {
                const rule = data.data.rule;
                
                // 填充基本信息...
                
                // 显示权限配置
                const permissionsHtml = PermissionConfig.renderDisplay(
                    rule.db_type,
                    rule.rule_expression
                );
                document.getElementById('viewPermissionsConfig').innerHTML = permissionsHtml;
                
                // 显示模态框
                const viewModal = new bootstrap.Modal(document.getElementById('viewRuleModal'));
                viewModal.show();
            }
        });
}
```

## 四、实现细节

### 4.1 MySQL 权限策略

```javascript
class MySQLPermissionStrategy extends PermissionStrategy {
    renderSelector(permissions, prefix = '') {
        return `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-globe me-2"></i>全局权限
                    </h6>
                    <div class="permission-section">
                        ${this._renderCheckboxes(
                            permissions.global_privileges, 
                            `${prefix}global_`, 
                            'primary'
                        )}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-database me-2"></i>数据库权限
                    </h6>
                    <div class="permission-section">
                        ${this._renderCheckboxes(
                            permissions.database_privileges, 
                            `${prefix}db_`, 
                            'success'
                        )}
                    </div>
                </div>
            </div>
        `;
    }
    
    collectSelected(container, prefix = '') {
        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
        const global_privileges = [];
        const database_privileges = [];
        
        checkboxes.forEach(checkbox => {
            if (checkbox.id.includes(`${prefix}global_`)) {
                global_privileges.push(checkbox.value);
            } else if (checkbox.id.includes(`${prefix}db_`)) {
                database_privileges.push(checkbox.value);
            }
        });
        
        return { global_privileges, database_privileges };
    }
    
    buildExpression(selectedPermissions, operator) {
        return {
            type: 'mysql_permissions',
            global_privileges: selectedPermissions.global_privileges || [],
            database_privileges: selectedPermissions.database_privileges || [],
            operator: operator
        };
    }
    
    setSelected(ruleExpression, container, prefix = '') {
        if (ruleExpression.global_privileges) {
            ruleExpression.global_privileges.forEach(perm => {
                const checkbox = container.querySelector(`#${prefix}global_${perm}`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        if (ruleExpression.database_privileges) {
            ruleExpression.database_privileges.forEach(perm => {
                const checkbox = container.querySelector(`#${prefix}db_${perm}`);
                if (checkbox) checkbox.checked = true;
            });
        }
    }
    
    renderDisplay(ruleExpression) {
        const sections = [];
        
        if (ruleExpression.global_privileges?.length > 0) {
            sections.push({
                title: '全局权限',
                icon: 'fa-globe',
                color: 'primary',
                items: ruleExpression.global_privileges
            });
        }
        
        if (ruleExpression.database_privileges?.length > 0) {
            sections.push({
                title: '数据库权限',
                icon: 'fa-database',
                color: 'success',
                items: ruleExpression.database_privileges
            });
        }
        
        return this._renderDisplaySections(sections);
    }
    
    _renderCheckboxes(items, prefix, color) {
        if (!items || items.length === 0) {
            return '<div class="text-muted">无权限配置</div>';
        }
        
        return items.map(item => `
            <div class="form-check mb-2">
                <input class="form-check-input" 
                       type="checkbox" 
                       value="${item.name}" 
                       id="${prefix}${item.name}">
                <label class="form-check-label d-flex align-items-center" 
                       for="${prefix}${item.name}">
                    <i class="fas fa-check text-${color} me-2"></i>
                    <div>
                        <div class="fw-bold">${item.name}</div>
                        <small class="text-muted">${item.description || ''}</small>
                    </div>
                </label>
            </div>
        `).join('');
    }
    
    _renderDisplaySections(sections) {
        if (sections.length === 0) {
            return '<div class="text-muted">无权限配置</div>';
        }
        
        return `
            <div class="row">
                ${sections.map(section => `
                    <div class="col-md-6">
                        <h6 class="text-${section.color} mb-2">
                            <i class="fas ${section.icon} me-2"></i>${section.title}
                        </h6>
                        <div class="mb-3">
                            ${section.items.map(item => 
                                `<span class="badge bg-${section.color} me-1 mb-1">${item}</span>`
                            ).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
}
```

### 4.2 其他数据库策略

SQL Server、PostgreSQL、Oracle 的策略实现类似，只是权限结构不同：

- **SQL Server**: server_roles, server_permissions, database_roles, database_privileges
- **PostgreSQL**: predefined_roles, role_attributes, database_privileges, tablespace_privileges
- **Oracle**: roles, system_privileges, tablespace_privileges, tablespace_quotas

## 五、重构收益

### 5.1 代码减少

- 原文件：1880 行
- 抽离权限配置后：约 1200 行
- 新增 permission-config.js：约 600 行
- **净减少：约 80 行**

### 5.2 代码复用

权限配置逻辑可以在以下场景复用：
- 账户分类管理页面
- 账户权限审计页面
- 权限模板管理页面
- 其他需要权限配置的页面

### 5.3 易于扩展

新增数据库类型只需：
1. 创建新的策略类（约 100 行）
2. 注册到策略表（1 行）
3. 无需修改现有代码

### 5.4 易于测试

每个策略类可以独立测试，测试覆盖率更高。

## 六、迁移步骤

### 步骤 1：创建 permission-config.js
- 实现基础框架
- 实现 MySQL 策略（最常用）
- 测试 MySQL 策略

### 步骤 2：迁移创建规则功能
- 修改 `loadPermissions()` 使用新 API
- 修改 `submitCreateRule()` 使用新 API
- 测试创建规则功能

### 步骤 3：迁移编辑规则功能
- 修改 `editRule()` 使用新 API
- 修改 `updateRule()` 使用新 API
- 测试编辑规则功能

### 步骤 4：迁移查看规则功能
- 修改 `viewRule()` 使用新 API
- 测试查看规则功能

### 步骤 5：实现其他数据库策略
- 实现 SQL Server 策略
- 实现 PostgreSQL 策略
- 实现 Oracle 策略
- 全面测试

### 步骤 6：清理旧代码
- 删除 `displayPermissionsConfig()`
- 删除 `setSelectedPermissions()`
- 删除 `displayViewPermissions()`
- 删除重复的权限收集逻辑

## 七、注意事项

### 7.1 向后兼容

在迁移过程中，保持旧 API 可用，使用适配器模式：

```javascript
// 旧 API 适配器
function displayPermissionsConfig(permissions, prefix = '', dbType = '') {
    console.warn('displayPermissionsConfig 已废弃，请使用 PermissionConfig.load');
    const strategy = getPermissionStrategy(dbType);
    const html = strategy.renderSelector(permissions, prefix);
    const containerId = prefix ? `${prefix}PermissionsConfig` : 'permissionsConfig';
    document.getElementById(containerId).innerHTML = html;
}
```

### 7.2 错误处理

所有 API 都应该有完善的错误处理：

```javascript
static async load(dbType, containerId, prefix = '') {
    try {
        if (!dbType) {
            throw new Error('数据库类型不能为空');
        }
        
        const container = document.getElementById(containerId);
        if (!container) {
            throw new Error(`找不到容器元素: ${containerId}`);
        }
        
        // 显示加载状态
        container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
        
        // 加载权限配置
        const response = await http.get(`/account_classification/api/permissions/${dbType}`);
        if (!response.success) {
            throw new Error(response.error || '加载权限配置失败');
        }
        
        // 渲染权限选择器
        const strategy = getPermissionStrategy(dbType);
        const html = strategy.renderSelector(response.data?.permissions ?? response.permissions, prefix);
        container.innerHTML = html;
        
    } catch (error) {
        logErrorWithContext(error, '加载权限配置失败', { dbType, containerId, prefix });
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    加载权限配置失败: ${error.message}
                </div>
            `;
        }
        throw error;
    }
}
```

### 7.3 性能优化

考虑缓存权限配置数据：

```javascript
class PermissionConfig {
    static _cache = new Map();
    
    static async load(dbType, containerId, prefix = '') {
        // 检查缓存
        const cacheKey = `permissions_${dbType}`;
        let permissions = this._cache.get(cacheKey);
        
        if (!permissions) {
            // 从服务器加载
            const response = await http.get(`/account_classification/api/permissions/${dbType}`);
            permissions = response.data?.permissions ?? response.permissions;
            
            // 缓存 5 分钟
            this._cache.set(cacheKey, permissions);
            setTimeout(() => this._cache.delete(cacheKey), 5 * 60 * 1000);
        }
        
        // 渲染
        const strategy = getPermissionStrategy(dbType);
        const html = strategy.renderSelector(permissions, prefix);
        document.getElementById(containerId).innerHTML = html;
    }
}
```

## 八、总结

通过将权限配置逻辑抽离到独立模块，我们实现了：

1. **代码复用** - 权限配置逻辑可在多个页面使用
2. **易于维护** - 权限相关代码集中管理，修改只需改一处
3. **易于扩展** - 使用策略模式，新增数据库类型只需添加新策略
4. **代码质量提升** - 消除重复代码，提高可测试性
5. **性能优化** - 可以添加缓存机制，减少网络请求

这是一个最小化的重构方案，不会大幅改动现有代码结构，风险可控，收益明显。
