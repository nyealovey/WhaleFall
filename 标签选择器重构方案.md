# 标签选择器重构方案（优化版）

## 背景与目标

标签选择器是平台中复用率最高的交互组件之一，广泛出现在实例创建/编辑、列表筛选与账户管理等页面。目前实现存在初始化不稳定、事件处理分散、DOM 结构不统一等问题，导致维护成本高，用户体验也因页面差异而不一致。本次重构旨在：

- 提供**统一可靠的初始化机制**，彻底消除延迟/重试等临时代码。
- 简化模态框按钮绑定与事件处理，让组件“一次写好到处使用”。
- 明确模板与脚本约定，避免各页面重复查找 DOM。
- 通过公共辅助方法封装常见集成逻辑，降低业务页接入负担。
- 在不打断现有业务流程的前提下，提高后续扩展性与可测试性。

> 批量分配标签页面因交互形态特殊（非模态、实时展示），本轮重构保持现状，后续可单独评估是否与新版选择器对齐。

---

## 现状痛点梳理

| 问题 | 表现 | 影响 |
| --- | --- | --- |
| 初始化时机混乱 | 不同页面使用 `DOMContentLoaded`、`setTimeout`、自定义重试等方式等待脚本加载 | 初始化可能失败或延迟，体验不一致 |
| 模态框按钮绑定复杂 | 依赖三次重试 + `data-bound` 标记，才能确保确认/取消按钮可用 | 代码冗长、逻辑脆弱，偶发多次触发 |
| DOM 查找缺乏统一规范 | 各页面分别设置容器 ID 并层层 query，稍有改动就需更新多处代码 | 重复劳动，容易遗漏、难排查 |
| 事件处理分散 | 同一事件在不同页面的响应逻辑不一致，有的直接关闭模态、有的自动提交表单 | 难以维护和复用 |
| 批量分配页面独立实现 | 与组件完全脱离，缺乏统一能力 | 范围有限，但对整体一致性有影响 |

---

## 目标状态设计

### 1. 统一的加载管理：`TagSelectorManager`

- 负责标记组件是否就绪，缓存实例，暴露 `whenReady(createFn)` 等方法。
- 组件脚本加载完成后主动调用 `manager.markReady()`，页面无需自行轮询。
- 好处：所有页面写法统一，不再需要 `setTimeout` 或“自旋”检测。

### 2. 简化按钮绑定：事件委托 + 语义化 `data-*`

- 在 `TagSelector` 内部使用事件委托处理确认/取消按钮，依靠 `data-tag-selector-action` 识别操作。
- 只要按钮位于同一模态框内，事件自然触发；无需重试或运行时标记。
- 附带收益：若日后添加“反选”“清空”等新按钮，只需在模板上配置 `data-tag-selector-action`，组件侧无需改动。

### 3. 标准化 DOM 结构与使用约定

- 模板提供 `<div class="tag-selector-wrapper" data-tag-selector>` 包裹块，内部包含统一 ID 的容器和模态框。
- 页面只需通过宏（或 include）引入，不再手动创建嵌套 `div` 与唯一 ID。
- 展示层优先复用 Bootstrap 自带样式（例如 `list-group`, `badge`, `btn`, `modal` 等），将自定义 CSS 减到最少，整体风格与系统其它模块保持一致。
- `TagSelector` 构造函数默认接受容器元素引用，也支持通过 `options.container` 定位自定义节点，增强灵活性。

### 4. 集成助手：`TagSelectorHelper`

封装三类常见场景，减少业务代码耦合：

| 助手方法 | 适用场景 | 核心逻辑 |
| --- | --- | --- |
| `setupForForm` | 实例创建/编辑等表单 | 维持隐藏域、标签 Chips、计数文案；可设置初始值 |
| `setupForFilter` | 列表筛选 | 确认即更新筛选条件，可选自动提交表单或触发回调 |
| `setupForInlinePreview` | 仅展示已选标签 | 供后续扩展，保持 API 完整性 |

所有助手内部都调用 `tagSelectorManager.whenReady`，确保加载顺序正确。

### 5. 统一事件模型

组件内部标准化以下事件，供外部订阅：

- `tagSelectionChange`：选择列表发生变化（实时广播）。
- `tagSelectionConfirmed`：用户点击确认按钮。
- `tagSelectionCanceled`：用户点击取消或模态关闭。

事件对象提供 `selectedTags`, `selectedIds`, `source`（触发来源）等字段，帮助业务侧区分处理。

### 6. 错误处理与降级

- 当容器缺失或接口请求失败时，组件通过 `toast` 或控制台输出明确提示。
- 若核心脚本加载失败，可在模板中提供简化的 `<select multiple>` 作为兜底（可在最终阶段评估是否保留）。

---

## 页面接入计划

| 页面 | 当前问题 | 重构动作 | 验收点 |
| --- | --- | --- | --- |
| 实例创建 | 手动延迟初始化 + 重复 DOM 查找 | 使用 `TagSelectorHelper.setupForForm` | 表单提交后可正确保存标签 |
| 实例编辑 | 同上，且初始值填充零散 | 使用 `setupForForm` 并传入初始标签 | 已选标签正确渲染、可增删 |
| 实例列表 | 重试逻辑 + 自行提交表单 | 使用 `setupForFilter`，自动提交筛选表单 | 选择后立即刷新列表、筛选条件保持 |
| 账户列表 | 初始化类似实例列表 | 同 `setupForFilter` | 行为同步 |
| 批量分配 | 特殊展示 | 暂不改动 | 确认旧功能稳定 |

> “筛选宏”中新增 `field_id` 支持，便于与 helper 保持一致（如 `tag-selector-filter` 指定唯一容器）。

---

## 实施里程碑

1. **组件核心重构（2 天）**  
   - 实现 `TagSelectorManager`、重写按钮绑定逻辑。  
   - 调整模板（tag_selector.html），增加语义化标记。  
   - 输出最小可运行示例，验证事件流。

2. **页面接入与清理（2~3 天）**  
   - 分别改造实例/账户相关页面与脚本，删除旧的重试、轮询代码。  
   - 对筛选宏进行适配，统一 DOM 结构。  
   - 梳理现有样式，优先替换为 Bootstrap 原生组件与工具类（如 `list-group-item`, `badge`, `btn`, 栅格布局等），仅保留必要的自定义补充样式。

3. **验证与文档（1 天）**  
   - 编写 README/使用指南，列出接入步骤与常见问题。  
   - 编写基础单测（可选：模块化导出核心逻辑供测试）。  
   - 回归涉及的业务流程（新建实例、编辑实例、筛选列表），确保交互与数据正确。

---

## 风险与备选方案

| 风险点 | 缓解措施 |
| --- | --- |
| 页面遗留自定义逻辑（例如特殊回调）被新助手覆盖 | 在接入时保留可配置回调（`onConfirm`, `onChange`），必要时允许传入自定义处理器 |
| 资源加载顺序导致 `TagSelectorManager` 未及时 `markReady` | 组件脚本末尾确保调用；页面如需提前初始化，可触发警告日志，便于排查 |
| 同页面存在多个选择器实例 | 通过 `containerId`/`data-tag-selector` 区分实例；`manager` 以 Map 管理，避免冲突 |
| 批量分配页面与新版组件差异扩大 | 保留旧实现，但在文档中说明差异，后续可单独排期统一 |

---

## 成果预期

- **开发效率**：业务页初始化代码减少 50% 以上，接入只需调用 helper。
- **稳定性**：不再依赖延时与重试，按钮事件一次绑定即可生效。
- **一致性**：不同页面的标签选择体验统一，便于后续产品迭代。
- **视觉统一**：依托 Bootstrap 自带样式，组件与站点其它模块风格一致，减少维护自定义 CSS 的成本。
- **可测试性**：核心逻辑集中在组件内部，易于编写单测或使用 Storybook 等工具验证。

完成以上重构后，标签选择器将成为一个真正“即插即用”的前端基础组件，有利于后续功能扩展（例如标签搜索、批量操作、权限控制等）。如需继续推进批量分配页对齐，可在此方案基础上新增“非模态/行内模式”的实现。	
