# é²¸è½ç”Ÿäº§ç¯å¢ƒ Makefile
# æä¾›ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²å’Œç®¡ç†å‘½ä»¤

.PHONY: help install config deploy start stop restart status logs backup restore update rollback clean health shell

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸŸ é²¸è½ç”Ÿäº§ç¯å¢ƒå‘½ä»¤"
	@echo "=================================="
	@echo "å®‰è£…å’Œé…ç½®:"
	@echo "  install     - å®‰è£…ç³»ç»Ÿä¾èµ–"
	@echo "  config      - é…ç½®ç¯å¢ƒæ–‡ä»¶"
	@echo ""
	@echo "éƒ¨ç½²å‘½ä»¤:"
	@echo "  deploy      - éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ"
	@echo "  start       - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ"
	@echo "  stop        - åœæ­¢ç”Ÿäº§ç¯å¢ƒ"
	@echo "  restart     - é‡å¯ç”Ÿäº§ç¯å¢ƒ"
	@echo "  status      - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo ""
	@echo "æ•°æ®åº“ç®¡ç†:"
	@echo "  init-db     - æ‰‹åŠ¨åˆå§‹åŒ–æ•°æ®åº“"
	@echo "  init-db-quick - å¿«é€Ÿåˆå§‹åŒ–æ•°æ®åº“"
	@echo ""
	@echo "æ—¥å¿—å’Œç›‘æ§:"
	@echo "  logs        - æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—"
	@echo "  logs-db     - æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—"
	@echo "  logs-redis  - æŸ¥çœ‹Redisæ—¥å¿—"
	@echo "  logs-app    - æŸ¥çœ‹åº”ç”¨æ—¥å¿—"
	@echo "  health      - å¥åº·æ£€æŸ¥"
	@echo ""
	@echo "å¤‡ä»½å’Œæ¢å¤:"
	@echo "  backup      - å¤‡ä»½æ•°æ®"
	@echo "  restore     - æ¢å¤æ•°æ®"
	@echo ""
	@echo "ç‰ˆæœ¬ç®¡ç†:"
	@echo "  update      - æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
	@echo "  rollback    - å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
	@echo ""
	@echo "ç»´æŠ¤å‘½ä»¤:"
	@echo "  clean       - æ¸…ç†Dockerèµ„æº"
	@echo "  shell       - è¿›å…¥åº”ç”¨å®¹å™¨"
	@echo "=================================="

# å®‰è£…ç³»ç»Ÿä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
	@sudo apt update
	@sudo apt install -y curl wget git docker.io docker-compose-plugin
	@sudo usermod -aG docker $$USER
	@echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
	@echo "âš ï¸  è¯·é‡æ–°ç™»å½•ä»¥ä½¿Dockerç»„æƒé™ç”Ÿæ•ˆ"

# é…ç½®ç¯å¢ƒæ–‡ä»¶
config:
	@echo "âš™ï¸  é…ç½®ç¯å¢ƒæ–‡ä»¶..."
	@if [ ! -f ".env" ]; then \
		cp env.production .env; \
		echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²åˆ›å»º: .env"; \
		echo "âš ï¸  è¯·ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®å¿…è¦çš„é…ç½®"; \
	else \
		echo "âœ… ç¯å¢ƒæ–‡ä»¶å·²å­˜åœ¨: .env"; \
	fi

# éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
deploy:
	@echo "ğŸš€ éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ..."
	@echo "ğŸ” éªŒè¯ç¯å¢ƒå˜é‡..."
	@./scripts/validate_env.sh
	@echo "ğŸ³ æ„å»ºå¹¶å¯åŠ¨Dockerå®¹å™¨..."
	@docker-compose -f docker-compose.prod.yml up -d --build
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
	@echo "ğŸŒ åº”ç”¨åœ°å€: http://localhost"

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
start:
	@echo "â–¶ï¸  å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ..."
	@echo "ğŸ” éªŒè¯ç¯å¢ƒå˜é‡..."
	@./scripts/validate_env.sh
	@echo "ğŸ³ å¯åŠ¨Dockerå®¹å™¨..."
	@docker-compose -f docker-compose.prod.yml up -d
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒå¯åŠ¨å®Œæˆ"

# åœæ­¢ç”Ÿäº§ç¯å¢ƒ
stop:
	@echo "â¹ï¸  åœæ­¢ç”Ÿäº§ç¯å¢ƒ..."
	@docker-compose -f docker-compose.prod.yml down
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒå·²åœæ­¢"

# é‡å¯ç”Ÿäº§ç¯å¢ƒ
restart: stop start

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ“Š ç”Ÿäº§ç¯å¢ƒæœåŠ¡çŠ¶æ€ï¼š"
	@echo "=================================="
	@docker-compose -f docker-compose.prod.yml ps
	@echo "=================================="

# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—..."
	@docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
logs-db:
	@echo "ğŸ“‹ æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—..."
	@docker-compose -f docker-compose.prod.yml logs -f postgres

# æŸ¥çœ‹Redisæ—¥å¿—
logs-redis:
	@echo "ğŸ“‹ æŸ¥çœ‹Redisæ—¥å¿—..."
	@docker-compose -f docker-compose.prod.yml logs -f redis

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
logs-app:
	@echo "ğŸ“‹ æŸ¥çœ‹åº”ç”¨æ—¥å¿—..."
	@docker-compose -f docker-compose.prod.yml logs -f whalefall

# è¿›å…¥åº”ç”¨å®¹å™¨
shell:
	@echo "ğŸš è¿›å…¥åº”ç”¨å®¹å™¨..."
	@docker-compose -f docker-compose.prod.yml exec whalefall bash

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
	@echo "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
	@curl -s http://localhost/health || echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
	@echo "æ£€æŸ¥PostgreSQLè¿æ¥..."
	@docker-compose -f docker-compose.prod.yml exec postgres pg_isready -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2) || echo "âŒ PostgreSQLè¿æ¥å¤±è´¥"
	@echo "æ£€æŸ¥Redisè¿æ¥..."
	@docker-compose -f docker-compose.prod.yml exec redis redis-cli ping || echo "âŒ Redisè¿æ¥å¤±è´¥"

# æ•°æ®åº“åˆå§‹åŒ–
init-db:
	@echo "ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“..."
	@if [ -z "$$DB_PASSWORD" ]; then \
		echo "âŒ é”™è¯¯: è¯·è®¾ç½®ç¯å¢ƒå˜é‡ DB_PASSWORD"; \
		echo "ç¤ºä¾‹: DB_PASSWORD=mypassword make init-db"; \
		exit 1; \
	fi
	@./scripts/database/init_database.sh

# å¿«é€Ÿæ•°æ®åº“åˆå§‹åŒ–
init-db-quick:
	@echo "âš¡ å¿«é€Ÿåˆå§‹åŒ–æ•°æ®åº“..."
	@if [ -z "$$DB_PASSWORD" ]; then \
		echo "âŒ é”™è¯¯: è¯·è®¾ç½®ç¯å¢ƒå˜é‡ DB_PASSWORD"; \
		echo "ç¤ºä¾‹: DB_PASSWORD=mypassword make init-db-quick"; \
		exit 1; \
	fi
	@./scripts/database/quick_init.sh

# å¤‡ä»½æ•°æ®
backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®..."
	@mkdir -p /opt/whale_fall_data/backups
	@docker-compose -f docker-compose.prod.yml exec postgres pg_dump -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2) > /opt/whale_fall_data/backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… æ•°æ®å¤‡ä»½å®Œæˆ"

# æ¢å¤æ•°æ®
restore:
	@echo "ğŸ”„ æ¢å¤æ•°æ®..."
	@echo "è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶: make restore FILE=backup_file.sql"
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶"; \
		exit 1; \
	fi
	@docker-compose -f docker-compose.prod.yml exec -T postgres psql -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2) < $(FILE)
	@echo "âœ… æ•°æ®æ¢å¤å®Œæˆ"

# æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
update:
	@echo "ğŸ”„ æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬..."
	@git pull origin main
	@docker-compose -f docker-compose.prod.yml down
	@docker-compose -f docker-compose.prod.yml up -d --build
	@echo "âœ… æ›´æ–°å®Œæˆ"

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
rollback:
	@echo "âª å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."
	@git log --oneline -n 2
	@echo "è¯·æ‰‹åŠ¨æ‰§è¡Œ: git reset --hard HEAD~1"
	@echo "ç„¶åæ‰§è¡Œ: make restart"

# æ¸…ç†Dockerèµ„æº
clean:
	@echo "ğŸ§¹ æ¸…ç†Dockerèµ„æº..."
	@docker system prune -f
	@docker image prune -a -f
	@echo "âœ… Dockerèµ„æºæ¸…ç†å®Œæˆ"

# å·ç®¡ç†
volumes:
	@echo "ğŸ“¦ å·ç®¡ç†..."
	@./scripts/docker/volume_manager.sh list

# åˆ›å»ºå·
create-volumes:
	@echo "ğŸ“¦ åˆ›å»ºç”Ÿäº§ç¯å¢ƒå·..."
	@./scripts/docker/volume_manager.sh create prod

# å¤‡ä»½å·
backup-volumes:
	@echo "ğŸ’¾ å¤‡ä»½ç”Ÿäº§ç¯å¢ƒå·..."
	@./scripts/docker/volume_manager.sh backup prod

# æ¢å¤å·
restore-volumes:
	@echo "ğŸ”„ æ¢å¤ç”Ÿäº§ç¯å¢ƒå·..."
	@./scripts/docker/volume_manager.sh restore prod

# è¿ç§»æ•°æ®åˆ°å·
migrate-volumes:
	@echo "ğŸ”„ è¿ç§»æ•°æ®åˆ°å·..."
	@./scripts/docker/volume_manager.sh migrate prod

# æŸ¥çœ‹å·å¤§å°
volume-size:
	@echo "ğŸ“Š æŸ¥çœ‹å·å¤§å°..."
	@./scripts/docker/volume_manager.sh size prod

# æ„å»ºç”Ÿäº§é•œåƒ
build:
	@echo "ğŸ”¨ æ„å»ºç”Ÿäº§é•œåƒ..."
	@docker-compose -f docker-compose.prod.yml build

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
version:
	@echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯ï¼š"
	@echo "åº”ç”¨ç‰ˆæœ¬: $$(grep APP_VERSION .env | cut -d'=' -f2)"
	@echo "Dockerç‰ˆæœ¬: $$(docker --version)"
	@echo "Docker Composeç‰ˆæœ¬: $$(docker-compose --version)"