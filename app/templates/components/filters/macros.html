{% macro filter_card(form_id='filter-form', action='', method='GET', submit_label='筛选', clear_label='清除', extra_classes='', auto_register=True) -%}
    {% set fields = caller() %}
    {% include 'components/ui/filter_card.html' %}
{%- endmacro %}

{% macro search_input(label='搜索', field_id='search', field_name='search', placeholder='搜索关键词', value='', col_class='col-md-2 col-12') -%}
<div class="{{ col_class }} filter-search-field">
    <label for="{{ field_id }}" class="form-label">{{ label }}</label>
    <input type="text"
           class="form-control filter-search-input"
           id="{{ field_id }}"
           name="{{ field_name }}"
           data-auto-submit
           value="{{ value }}"
           placeholder="{{ placeholder }}">
</div>
{%- endmacro %}

{% macro select_filter(label, field_id, field_name, options, current_value='', placeholder='', col_class='col-md-2 col-12', allow_empty=True, multiple=False, use_tom_select=False) -%}
{% set option_list = options or [] %}
{% set ns = namespace(has_builtin_all=False) %}
{% for option in option_list %}
    {% set opt_value = option.get('value') %}
    {% if opt_value in ('', None, 'all', 'ALL') %}
        {% set ns.has_builtin_all = True %}
    {% endif %}
{% endfor %}
<div class="{{ col_class }}">
    <label for="{{ field_id }}" class="form-label">{{ label }}</label>
    <select id="{{ field_id }}"
            name="{{ field_name }}"
            class="form-select"
            {% if multiple %}multiple{% endif %}
            {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
            {% if use_tom_select %}data-tom-select{% endif %}>
        {% if allow_empty and not ns.has_builtin_all %}
        <option value="">{{ placeholder or '全部' }}</option>
        {% endif %}
        {% for option in option_list %}
        {% set value = option['value'] %}
        {% set label_text = option['label'] %}
        {% set color = option.get('color') %}
        {% set category = option.get('category') %}
        <option value="{{ value }}"
                {% if multiple %}
                    {% if value in (current_value or []) %}selected{% endif %}
                {% else %}
                    {% if value == current_value %}selected{% endif %}
                {% endif %}
                {% if color %}data-color="{{ color }}"{% endif %}
                {% if category %}data-category="{{ category }}"{% endif %}>
            {{ label_text }}
        </option>
        {% endfor %}
    </select>
</div>
{%- endmacro %}

{% macro db_type_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('数据库类型', 'db_type', 'db_type', options, current_value, '全部类型', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro status_active_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('状态', 'status', 'status', options, current_value, '全部状态', col_class, allow_empty=False, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro status_sync_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('状态', 'status', 'status', options, current_value, '全部状态', col_class, allow_empty=False, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro credential_type_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('凭据类型', 'credential_type', 'credential_type', options, current_value, '全部类型', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro classification_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('账户分类', 'classification', 'classification', options, current_value, '全部分类', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro tag_category_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('标签分类', 'category', 'category', options, current_value, '全部分类', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro log_level_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('日志级别', 'level', 'level', options, current_value, '全部级别', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro module_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('模块', 'module', 'module', options, current_value, '全部模块', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro time_range_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('时间范围', 'time_range', 'time_range', options, current_value, '选择时间范围', col_class, allow_empty=False, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro sync_type_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('操作方式', 'sync_type', 'sync_type', options, current_value, '全部方式', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro sync_category_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('分类', 'sync_category', 'sync_category', options, current_value, '全部分类', col_class, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro period_type_filter(options, current_value='', col_class='col-md-2 col-12', use_tom_select=False) -%}
    {{ select_filter('统计周期', 'period_type', 'period_type', options, current_value, '选择周期', col_class, allow_empty=False, use_tom_select=use_tom_select) }}
{%- endmacro %}

{% macro instance_filter(options, current_value='', col_class='col-md-2 col-12', disabled=False, use_tom_select=False) -%}
<div class="{{ col_class }}">
    <label for="instance" class="form-label">实例</label>
    <select id="instance"
            name="instance"
            class="form-select"
            {% if use_tom_select %}data-tom-select{% endif %}
            {% if disabled %}disabled{% endif %}>
        <option value="">所有实例</option>
        {% for option in options or [] %}
        <option value="{{ option['value'] }}"
                {% if option['value'] == current_value %}selected{% endif %}
                data-db-type="{{ option['db_type'] }}">
            {{ option['label'] }}
        </option>
        {% endfor %}
    </select>
</div>
{%- endmacro %}

{% macro database_filter(options, current_value='', col_class='col-md-2 col-12', disabled=False, use_tom_select=False) -%}
<div class="{{ col_class }}">
    <label for="database" class="form-label">数据库</label>
    <select id="database"
            name="database_id"
            class="form-select"
            {% if use_tom_select %}data-tom-select{% endif %}
            {% if disabled %}disabled{% endif %}>
        <option value="">所有数据库</option>
        {% for option in options or [] %}
        <option value="{{ option['value'] }}"
                {% if option['value'] == current_value %}selected{% endif %}>
            {{ option['label'] }}
        </option>
        {% endfor %}
    </select>
</div>
{%- endmacro %}

{% macro tag_selector_filter(options, selected=None, field_name='tags', field_id='tag-selector', col_class='col-md-2 col-12', placeholder='选择标签', allow_clear=True) -%}
{% set selected_values = selected or [] %}
{% set ns = namespace(selected_details=[]) %}
{% for option in options or [] %}
    {% if option['value'] in selected_values %}
        {% set _ = ns.selected_details.append(option) %}
    {% endif %}
{% endfor %}
<div class="{{ col_class }}" id="{{ field_id }}-container">
    <label class="form-label" for="open-tag-filter-btn">标签筛选</label>
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <button type="button"
                class="btn btn-outline-primary flex-grow-0"
                id="open-tag-filter-btn">
            <i class="fas fa-tags me-2"></i>{{ placeholder }}
        </button>
        <span class="text-muted" id="selected-tags-count">
            {% if selected_values %}
                已选择 {{ selected_values|length }} 个标签
            {% else %}
                未选择标签
            {% endif %}
        </span>
    </div>
    <div id="selected-tags-preview" class="mt-2"{% if not selected_values %} style="display: none;"{% endif %}>
        <div class="d-flex flex-wrap gap-1" id="selected-tags-chips">
            {% for tag in ns.selected_details %}
            {% set tag_value = tag['value'] %}
            {% set tag_label = tag['label'] %}
            {% set color = tag.get('color') %}
            {% set color_value = color or '' %}
            {% if color_value.startswith('bg-') %}
                {% set normalized_color = color_value[3:] %}
            {% else %}
                {% set normalized_color = color_value %}
            {% endif %}
            {% set is_bootstrap_color = normalized_color and not normalized_color.startswith('#') and ' ' not in normalized_color %}
            {% set badge_classes = 'badge me-1 mb-1' %}
            {% if is_bootstrap_color %}
                {% set badge_classes = badge_classes ~ ' bg-' ~ normalized_color %}
            {% else %}
                {% set badge_classes = badge_classes ~ ' bg-secondary' %}
            {% endif %}
            {% set style_attr = '' %}
            {% if color_value and not is_bootstrap_color %}
                {% set style_attr = 'background-color: ' ~ color_value ~ '; color: #fff;' %}
            {% endif %}
            <span class="{{ badge_classes }}"
                  {% if style_attr %}style="{{ style_attr }}"{% endif %}
                  data-role="external-chip"
                  data-tag-id="{{ tag_value }}">
                <i class="fas fa-tag me-1"></i>{{ tag_label }}
                <button type="button"
                        class="btn-close btn-close-white ms-1"
                        style="font-size: 0.6em;"
                        data-role="external-chip-remove"
                        data-tag-id="{{ tag_value }}"></button>
            </span>
            {% endfor %}
        </div>
    </div>
    <input type="hidden"
           id="selected-tag-names"
           name="{{ field_name }}"
           value="{{ selected_values|join(',') }}">
    {% if not options %}
    <p class="filter-empty-hint mt-1 mb-0">暂无可用标签，请先在标签管理中创建。</p>
    {% endif %}
</div>
{%- endmacro %}
