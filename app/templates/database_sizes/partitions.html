{% extends "base.html" %}

{% block title %}分区管理 - 鲸落{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/database_sizes/partitions.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-layer-group me-2"></i>分区管理</h2>
        <div class="btn-group">
            <button type="button" class="btn btn-primary" id="refreshBtn">
                <i class="fas fa-sync-alt me-2"></i>刷新
            </button>
            <button type="button" class="btn btn-success" id="createPartitionBtn">
                <i class="fas fa-plus me-2"></i>创建分区
            </button>
            <button type="button" class="btn btn-warning" id="cleanupPartitionsBtn">
                <i class="fas fa-trash me-2"></i>清理旧分区
            </button>
        </div>
    </div>

    <!-- 分区状态概览 -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalPartitions">-</h4>
                            <p class="card-text">总分区数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-layer-group fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalSize">-</h4>
                            <p class="card-text">总大小</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hdd fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalRecords">-</h4>
                            <p class="card-text">总记录数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="partitionStatus">-</h4>
                            <p class="card-text">状态</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heartbeat fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分区列表 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>分区列表</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="partitionsTable">
                    <thead>
                        <tr>
                            <th>分区名称</th>
                            <th>日期</th>
                            <th>大小</th>
                            <th>记录数</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="partitionsTableBody">
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 聚合数据表 -->
    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        聚合数据表
                    </h5>
                </div>
                <div class="col-md-6">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="searchAggregationTable" placeholder="搜索实例或数据库...">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="periodTypeFilter">
                                <option value="daily">日聚合数据</option>
                                <option value="weekly">周聚合数据</option>
                                <option value="monthly">月聚合数据</option>
                                <option value="quarterly">季聚合数据</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="sortAggregationTable">
                                <option value="instance_name">按实例排序</option>
                                <option value="database_name">按数据库排序</option>
                                <option value="avg_size_mb">按平均大小排序</option>
                                <option value="max_size_mb">按最大大小排序</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="aggregationTable">
                       <thead>
                           <tr>
                               <th>周期类型</th>
                               <th>实例名称</th>
                               <th>数据库名称</th>
                               <th>统计周期</th>
                               <th>平均大小</th>
                               <th>最大大小</th>
                               <th>最小大小</th>
                               <th>数据点数</th>
                               <th>计算时间</th>
                           </tr>
                       </thead>
                    <tbody id="aggregationTableBody">
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页组件 -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="pagination-info">
                    <span class="text-muted">
                        显示第 <span id="paginationStart">1</span> - <span id="paginationEnd">10</span> 条，
                        共 <span id="paginationTotal">0</span> 条记录
                    </span>
                </div>
                <nav aria-label="分页导航">
                    <ul class="pagination pagination-sm mb-0" id="paginationNav">
                        <li class="page-item disabled" id="prevPage">
                            <a class="page-link" href="#" aria-label="上一页">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active" id="page1">
                            <a class="page-link" href="#" data-page="1">1</a>
                        </li>
                        <li class="page-item" id="nextPage">
                            <a class="page-link" href="#" aria-label="下一页">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 创建分区模态框 -->
<div class="modal fade" id="createPartitionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建分区</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPartitionForm">
                    <div class="mb-3">
                        <label for="partitionYear" class="form-label">年份</label>
                        <select class="form-select" id="partitionYear" required>
                            <option value="">请选择年份</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="partitionMonth" class="form-label">月份</label>
                        <select class="form-select" id="partitionMonth" required>
                            <option value="">请选择月份</option>
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                        <div class="form-text">选择要创建分区的年月（将创建该月的分区）</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmCreatePartition">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 清理分区模态框 -->
<div class="modal fade" id="cleanupPartitionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">清理旧分区</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cleanupPartitionsForm">
                    <div class="mb-3">
                        <label for="retentionMonths" class="form-label">保留月数</label>
                        <input type="number" class="form-control" id="retentionMonths" min="1" max="60" value="12">
                        <div class="form-text">保留最近几个月的分区，超过此期限的分区将被删除</div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>警告：</strong>此操作将永久删除旧分区及其数据，请谨慎操作！
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmCleanupPartitions">清理</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/database_sizes/partitions.js') }}"></script>
{% endblock %}
