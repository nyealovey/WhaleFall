{% extends "base.html" %}
{% set is_edit = resource is not none %}
{% set form_values = form_data if form_data else {} %}
{% set pending_tag_raw = form_values.get('tag_names') %}
{% if pending_tag_raw %}
    {% if pending_tag_raw is string %}
        {% set pending_tag_names = pending_tag_raw.split(',') %}
    {% else %}
        {% set pending_tag_names = pending_tag_raw %}
    {% endif %}
{% else %}
    {% set pending_tag_names = selected_tag_names %}
{% endif %}
{% set page_title = '编辑数据库实例' if is_edit else '添加数据库实例' %}

{% block title %}{{ page_title }} - 鲸落{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/instances/create.css') }}">
{% endblock %}

{% block content %}
<div class="row justify-content-center" id="instance-form-root"
     data-form-mode="{{ form_mode }}"
     {% if resource %}data-instance-id="{{ resource.id }}"{% endif %}>
    <div class="col-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas {{ 'fa-edit' if is_edit else 'fa-plus' }} me-2"></i>{{ page_title }}
                </h5>
                {% if is_edit %}
                <span class="badge bg-secondary">ID #{{ resource.id }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if form_errors %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>{{ form_errors }}
                </div>
                {% endif %}
                <form method="POST" id="instanceForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row">
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="name" class="form-label">实例名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name"
                                       value="{{ form_values.get('name', resource.name if is_edit else '') }}"
                                       placeholder="请输入实例名称" required>
                                <div class="form-text">用于标识此数据库实例的名称</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="db_type" class="form-label">数据库类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="db_type" name="db_type" required>
                                    <option value="">请选择数据库类型</option>
                                    {% for db_type in database_types %}
                                    {% set current = form_values.get('db_type', resource.db_type if is_edit else '') %}
                                    <option value="{{ db_type.name }}"
                                            data-port="{{ db_type.default_port }}"
                                            data-icon="{{ db_type.icon }}"
                                            data-color="{{ db_type.color }}"
                                            {% if current == db_type.name %}selected{% endif %}>
                                        {{ db_type.display_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">从配置的数据库类型中选择</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-8">
                            <div class="mb-3">
                                <label for="host" class="form-label">主机地址 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="host" name="host"
                                       value="{{ form_values.get('host', resource.host if is_edit else '') }}"
                                       placeholder="例如: localhost 或 192.168.1.100" required>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="port" class="form-label">端口号 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="port" name="port"
                                       value="{{ form_values.get('port', resource.port if is_edit else '') }}"
                                       placeholder="例如: 5432" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="credential_id" class="form-label">凭据 <span class="text-danger">*</span></label>
                                <select class="form-select" id="credential_id" name="credential_id" required>
                                    <option value="">请选择凭据</option>
                                    {% set current_credential = form_values.get('credential_id', resource.credential_id if is_edit else '') %}
                                    {% for cred in credentials %}
                                    <option value="{{ cred.id }}" {% if current_credential|int == cred.id %}selected{% endif %}>
                                        #{{ cred.id }} - {{ cred.name }} ({{ cred.credential_type }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <a href="{{ url_for('credentials.create') }}" class="text-decoration-none">
                                        <i class="fas fa-plus me-1"></i>添加新凭据
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="database-name-row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="database_name" class="form-label">数据库名称</label>
                                <input type="text" class="form-control" id="database_name" name="database_name"
                                       value="{{ form_values.get('database_name', resource.database_name if is_edit else '') }}"
                                       placeholder="例如: mysql, postgres, master, orcl">
                                <div class="form-text">
                                    <strong>MySQL</strong>: 默认 mysql；
                                    <strong>PostgreSQL</strong>: 默认 postgres；
                                    <strong>SQL Server</strong>: 默认 master；
                                    <strong>Oracle</strong>: 默认 orcl
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="请输入实例描述（可选）">{{ form_values.get('description', resource.description if is_edit else '') }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">标签</label>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button"
                                    class="btn btn-outline-primary"
                                    id="open-tag-selector-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#tagSelectorModal">
                                <i class="fas fa-tags me-2"></i>选择标签
                            </button>
                            <span class="text-muted" id="selected-tags-count">
                                {% if pending_tag_names %}
                                    已选择 {{ pending_tag_names|length }} 个标签
                                {% else %}
                                    未选择标签
                                {% endif %}
                            </span>
                        </div>
                        <div id="selected-tags-preview" class="mt-2" {% if not pending_tag_names %}style="display: none;"{% endif %}>
                            <div class="d-flex flex-wrap gap-1" id="selected-tags-chips">
                                {% for tag_name in pending_tag_names if tag_name %}
                                {% set trimmed = tag_name.strip() %}
                                {% set tag_obj = (all_tags | selectattr('name', 'equalto', trimmed) | list | first) %}
                                <span class="badge bg-{{ tag_obj.color if tag_obj and tag_obj.color else 'secondary' }}">
                                    <i class="fas fa-tag me-1"></i>{{ tag_obj.display_name if tag_obj else trimmed }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        <input type="hidden" id="selected-tag-names" name="tag_names"
                               value="{{ form_values.get('tag_names', selected_tag_names | join(',')) }}">
                    </div>

                    <div class="mb-3 form-check form-switch">
                        <input type="hidden" name="is_active" value="0">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" value="1"
                               {% set active_value = form_values.get('is_active', resource.is_active if is_edit else True) %}
                               {% if active_value in [True, '1', 'true', 'on', 1] %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">启用此实例</label>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{{ url_for('instance.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>返回列表
                        </a>
                        {% if is_edit %}
                        <button type="button" class="btn btn-outline-warning" data-action="test-connection">
                            <i class="fas fa-plug me-2"></i>测试连接
                        </button>
                        {% endif %}
                        <button type="submit" class="btn btn-primary" data-resource-submit>
                            <i class="fas fa-save me-2"></i>{{ '保存更改' if is_edit else '创建实例' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if is_edit %}
        <div class="card mt-3" id="testResult" style="display: none;">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-plug me-2"></i>连接测试结果
                </h6>
                <div id="testResultContent"></div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<div id="form-page-tag-selector">
    {% include 'components/tag_selector.html' %}
</div>
<script src="{{ url_for('static', filename='js/pages/instances/form.js') }}"></script>
{% endblock %}
