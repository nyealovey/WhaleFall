{% extends "base.html" %}
{% set page_id = 'InstanceFormPage' %}

{% from 'components/ui/page_header.html' import page_header %}

{% set is_edit = form_mode == 'edit' %}
{% set form_values = form_data if form_data else {} %}

{% block title %}{{ '编辑实例' if is_edit else '创建实例' }} - 鲸落{% endblock %}

{% block content_outer %}
{{ page_header('fas fa-server', '编辑实例' if is_edit else '创建实例', '配置数据库实例连接信息与标签') }}

<section class="page-section">
    <div class="layout-shell">
        <div class="layout-shell-inner">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-8">
                    <div class="card">
                        <div class="card-body p-4 p-lg-5">
                            {% if form_errors %}
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-circle me-2" aria-hidden="true"></i>{{ form_errors }}
                            </div>
                            {% endif %}

                            <form method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                                <div class="row g-3">
                                    <div class="col-md-6 col-12">
                                        <label for="name" class="form-label">实例名称 <span class="text-danger">*</span></label>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="name"
                                            name="name"
                                            required
                                            placeholder="唯一的实例名称"
                                            value="{{ form_values.get('name') if form_values.get('name') is not none else (resource.name if resource else '') }}"
                                        />
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label for="db_type" class="form-label">数据库类型 <span class="text-danger">*</span></label>
                                        {% set selected_db_type = form_values.get('db_type') if form_values.get('db_type') is not none else (resource.db_type if resource else '') %}
                                        <select class="form-select" id="db_type" name="db_type" required>
                                            <option value="">请选择数据库类型</option>
                                            {% for option in database_type_options or [] %}
                                            <option value="{{ option.value }}" {% if option.value == selected_db_type %}selected{% endif %}>{{ option.label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label for="host" class="form-label">主机 <span class="text-danger">*</span></label>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="host"
                                            name="host"
                                            required
                                            placeholder="例如 127.0.0.1"
                                            value="{{ form_values.get('host') if form_values.get('host') is not none else (resource.host if resource else '') }}"
                                        />
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label for="port" class="form-label">端口 <span class="text-danger">*</span></label>
                                        <input
                                            type="number"
                                            class="form-control"
                                            id="port"
                                            name="port"
                                            required
                                            placeholder="3306"
                                            value="{{ form_values.get('port') if form_values.get('port') is not none else (resource.port if resource else '') }}"
                                        />
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label for="credential_id" class="form-label">凭据</label>
                                        {% set selected_credential = form_values.get('credential_id') if form_values.get('credential_id') is not none else (resource.credential_id if resource else '') %}
                                        <select class="form-select" id="credential_id" name="credential_id">
                                            <option value="">请选择凭据</option>
                                            {% for option in credential_options or [] %}
                                            <option value="{{ option.value }}" {% if option.value|string == selected_credential|string %}selected{% endif %}>{{ option.label }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">可选, 若暂未准备凭据, 可稍后补充</div>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label for="database_name" class="form-label">数据库名称</label>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="database_name"
                                            name="database_name"
                                            placeholder="mysql / postgres / master / orcl"
                                            value="{{ form_values.get('database_name') if form_values.get('database_name') is not none else (resource.database_name if resource else '') }}"
                                        />
                                    </div>
                                    <div class="col-12">
                                        <label for="description" class="form-label">描述</label>
                                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="可选, 用于补充说明">{{ form_values.get('description') if form_values.get('description') is not none else (resource.description if resource else '') }}</textarea>
                                    </div>

                                    {% set selected_tag_list = selected_tag_names or [] %}
                                    {% if form_data %}
                                        {% if form_data.getlist is defined %}
                                            {% set selected_tag_list = form_data.getlist('tag_names') %}
                                        {% else %}
                                            {% set selected_tag_list = form_values.get('tag_names') or selected_tag_list %}
                                        {% endif %}
                                    {% endif %}
                                    <div class="col-12">
                                        <label for="tag_names" class="form-label">标签</label>
                                        <select class="form-select" id="tag_names" name="tag_names" multiple>
                                            {% for option in tag_options or [] %}
                                            <option value="{{ option.value }}" {% if option.value in selected_tag_list %}selected{% endif %}>{{ option.label }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">可选, 用于标注实例用途或环境</div>
                                    </div>
                                </div>

                                {% set is_active_raw = form_values.get('is_active') %}
                                {% if is_active_raw is none %}
                                    {% set is_active_checked = (resource.is_active if resource else True) %}
                                {% else %}
                                    {% set is_active_checked = is_active_raw in ['1', 'true', 'True', 'on', 'yes'] %}
                                {% endif %}
                                <div class="form-check form-switch mt-4 mb-4">
                                    <input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active" value="1" {% if is_active_checked %}checked{% endif %} />
                                    <label class="form-check-label" for="is_active">启用此实例</label>
                                </div>

                                <div class="d-flex flex-wrap gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2" aria-hidden="true"></i>{{ '保存' if is_edit else '创建' }}
                                    </button>
                                    <a class="btn btn-outline-secondary" href="{{ url_for('instances.index') }}">
                                        <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>返回
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

