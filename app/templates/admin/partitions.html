{% extends "base.html" %}

{% block title %}分区管理 - 鲸落{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/partitions.css') }}">
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-layer-group me-2"></i>分区管理</h2>
                <p class="mb-0">管理数据库表分区，优化查询性能</p>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-light" id="createPartitionBtn">
                    <i class="fas fa-plus me-2"></i>创建分区
                </button>
                <button type="button" class="btn btn-outline-light" id="cleanupPartitionsBtn">
                    <i class="fas fa-trash me-2"></i>清理旧分区
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">

    <!-- 分区状态概览 -->
    <div class="row row-cols-4 g-3 mb-4 align-items-stretch">
        <div class="col">
            <div class="card partition-stat-card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalPartitions">-</h4>
                            <p class="card-text">总分区数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-layer-group fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card partition-stat-card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalSize">-</h4>
                            <p class="card-text">总大小</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hdd fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card partition-stat-card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalRecords">-</h4>
                            <p class="card-text">总记录数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card partition-stat-card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="partitionStatus">-</h4>
                            <p class="card-text">状态</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heartbeat fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 聚合数据表 - 折线图展示 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>
                核心指标统计
            </h5>
        </div>
        <div class="card-body">

            <!-- 周期类型切换标签 -->
            <div class="d-flex justify-content-center mb-4">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="periodType" id="periodDaily" value="daily" checked>
                    <label class="btn btn-outline-primary" for="periodDaily">
                        <i class="fas fa-calendar-day me-2"></i>日统计
                    </label>
                    
                    <input type="radio" class="btn-check" name="periodType" id="periodWeekly" value="weekly">
                    <label class="btn btn-outline-primary" for="periodWeekly">
                        <i class="fas fa-calendar-week me-2"></i>周统计
                    </label>
                    
                    <input type="radio" class="btn-check" name="periodType" id="periodMonthly" value="monthly">
                    <label class="btn btn-outline-primary" for="periodMonthly">
                        <i class="fas fa-calendar-alt me-2"></i>月统计
                    </label>
                    
                    <input type="radio" class="btn-check" name="periodType" id="periodQuarterly" value="quarterly">
                    <label class="btn btn-outline-primary" for="periodQuarterly">
                        <i class="fas fa-calendar me-2"></i>季统计
                    </label>
                </div>
            </div>



                <!-- 图表容器 -->
                <div class="position-relative" style="height: 500px;">
                    <canvas id="aggregationsChart" style="height: 100%; width: 100%;"></canvas>
                    <div id="chartLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mb-0">正在加载图表数据...</p>
                        </div>
                    </div>
                    <div id="chartMessage" class="position-absolute top-50 start-50 translate-middle d-none">
                        <div class="text-center">
                            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                            <p class="mb-0 text-muted" id="chartMessageText">暂无数据</p>
                        </div>
                    </div>
                </div>

        </div>
    </div>

    <!-- 分区列表 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>分区列表</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="partitionsTable">
                    <thead>
                        <tr>
                            <th>表类型</th>
                            <th>分区名称</th>
                            <th>大小</th>
                            <th>记录数</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="partitionsTableBody">
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 创建分区模态框 -->
{% set create_partition_modal_body %}
    <form id="createPartitionForm">
        <div class="mb-3">
            <label for="partitionYear" class="form-label">年份</label>
            <select class="form-select" id="partitionYear" required>
                <option value="">请选择年份</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="partitionMonth" class="form-label">月份</label>
            <select class="form-select" id="partitionMonth" required>
                <option value="">请选择月份</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
            </select>
            <div class="form-text">选择要创建分区的年月（将创建该月的分区）</div>
        </div>
    </form>
{% endset %}
{% set create_partition_modal_footer %}
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-modal-cancel>取消</button>
    <button type="button" class="btn btn-primary" id="confirmCreatePartition" data-modal-confirm>创建</button>
{% endset %}
{% with
    modal_id='createPartitionModal',
    modal_label_id='createPartitionModalLabel',
    title='创建分区',
    body=create_partition_modal_body,
    footer=create_partition_modal_footer
%}
    {% include 'components/ui/modal.html' %}
{% endwith %}

<!-- 清理分区模态框 -->
{% set cleanup_partition_modal_body %}
    <form id="cleanupPartitionsForm">
        <div class="mb-3">
            <label for="retentionMonths" class="form-label">保留月数</label>
            <input type="number" class="form-control" id="retentionMonths" min="1" max="60" value="12">
            <div class="form-text">保留最近几个月的分区，超过此期限的分区将被删除</div>
        </div>
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>警告：</strong>此操作将永久删除旧分区及其数据，请谨慎操作！
        </div>
    </form>
{% endset %}
{% set cleanup_partition_modal_footer %}
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-modal-cancel>取消</button>
    <button type="button" class="btn btn-danger" id="confirmCleanupPartitions" data-modal-confirm>清理</button>
{% endset %}
{% with
    modal_id='cleanupPartitionsModal',
    modal_label_id='cleanupPartitionsModalLabel',
    title='清理旧分区',
    body=cleanup_partition_modal_body,
    footer=cleanup_partition_modal_footer
%}
    {% include 'components/ui/modal.html' %}
{% endwith %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/chartjs/chart.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/services/partition_service.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/stores/partition_store.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/admin/partitions.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/admin/aggregations-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap/admin/partitions.js') }}"></script>
{% endblock %}
