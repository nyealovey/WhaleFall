{% extends "base.html" %}

{% block title %}修改密码 - 鲸落{% endblock %}

{% block content %}
<script src="{{ url_for('static', filename='js/common/alert-utils.js') }}"></script>
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <i class="fas fa-key fa-3x text-primary mb-3"></i>
                    <h3 class="card-title">修改密码</h3>
                    <p class="text-muted">为了账户安全，请定期更新您的密码</p>
                </div>

                <form method="POST" id="changePasswordForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="old_password" class="form-label">
                            <i class="fas fa-lock me-2"></i>当前密码
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="old_password" name="old_password"
                                   placeholder="请输入当前密码" required autofocus>
                            <button class="btn btn-outline-secondary" type="button" id="toggleOldPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="new_password" class="form-label">
                            <i class="fas fa-lock me-2"></i>新密码
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="new_password" name="new_password"
                                   placeholder="请输入新密码" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">密码长度至少6位，建议包含字母和数字</div>
                    </div>

                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">
                            <i class="fas fa-lock me-2"></i>确认新密码
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                                   placeholder="请再次输入新密码" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 密码强度指示器 -->
                    <div class="mb-3">
                        <label class="form-label">密码强度</label>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="passwordStrengthText">请输入密码</small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>更新密码
                        </button>
                        <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>返回个人资料
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 密码安全提示 -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-shield-alt me-2"></i>密码安全提示
                </h6>
                <ul class="list-unstyled mb-0 small">
                    <li><i class="fas fa-check text-success me-2"></i>使用至少8个字符的密码</li>
                    <li><i class="fas fa-check text-success me-2"></i>包含大小写字母、数字和特殊字符</li>
                    <li><i class="fas fa-check text-success me-2"></i>避免使用个人信息或常见词汇</li>
                    <li><i class="fas fa-check text-success me-2"></i>定期更换密码，建议每3个月更换一次</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/common/csrf-utils.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 密码显示/隐藏切换
    const toggleOldPassword = document.getElementById('toggleOldPassword');
    const toggleNewPassword = document.getElementById('toggleNewPassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const oldPasswordInput = document.getElementById('old_password');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');

    function togglePasswordVisibility(button, input) {
        button.addEventListener('click', function() {
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);

            const icon = this.querySelector('i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        });
    }

    togglePasswordVisibility(toggleOldPassword, oldPasswordInput);
    togglePasswordVisibility(toggleNewPassword, newPasswordInput);
    togglePasswordVisibility(toggleConfirmPassword, confirmPasswordInput);

    // 密码强度检查
    newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = getPasswordStrength(password);
        updatePasswordStrength(strength);
    });

    function getPasswordStrength(password) {
        let strength = 0;
        if (password.length >= 6) strength++;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        return strength;
    }

    function updatePasswordStrength(strength) {
        const strengthBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('passwordStrengthText');

        let percentage = 0;
        let text = '请输入密码';
        let color = 'bg-secondary';

        if (strength >= 1) {
            percentage = 20;
            text = '密码强度：弱';
            color = 'bg-danger';
        }
        if (strength >= 3) {
            percentage = 60;
            text = '密码强度：中等';
            color = 'bg-warning';
        }
        if (strength >= 5) {
            percentage = 100;
            text = '密码强度：强';
            color = 'bg-success';
        }

        strengthBar.style.width = percentage + '%';
        strengthBar.className = 'progress-bar ' + color;
        strengthText.textContent = text;
    }

    // 表单验证
    const changePasswordForm = document.getElementById('changePasswordForm');
    changePasswordForm.addEventListener('submit', function(e) {
        const oldPassword = document.getElementById('old_password').value;
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;

        // 基本验证
        if (!oldPassword || !newPassword || !confirmPassword) {
            e.preventDefault();
            showWarningAlert('所有字段都不能为空', '验证失败', { form: 'change_password' });
            return;
        }

        if (newPassword.length < 6) {
            e.preventDefault();
            showWarningAlert('新密码至少需要6个字符', '密码强度不足', { form: 'change_password' });
            return;
        }

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            showWarningAlert('两次输入的新密码不一致', '密码不匹配', { form: 'change_password' });
            return;
        }

        if (oldPassword === newPassword) {
            e.preventDefault();
            showWarningAlert('新密码不能与当前密码相同', '密码重复', { form: 'change_password' });
            return;
        }

        // 显示加载状态
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>更新中...';
        submitBtn.disabled = true;

        // 如果更新失败，恢复按钮状态
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 3000);
    });
});
</script>
{% endblock %}
