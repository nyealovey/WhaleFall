{% extends "base.html" %}
{% import 'accounts/components/classification_forms.html' as classification_forms %}
{% set create_classification_ids = {
    'name': 'classificationName',
    'description': 'classificationDescription',
    'risk': 'riskLevel',
    'color': 'classificationColor',
    'priority': 'priority',
    'icon': 'classificationIcon'
} %}
{% set edit_classification_ids = {
    'name': 'editClassificationName',
    'description': 'editClassificationDescription',
    'risk': 'editClassificationRiskLevel',
    'color': 'editClassificationColor',
    'priority': 'editClassificationPriority',
    'icon': 'editClassificationIcon'
} %}
{% set create_rule_ids = {
    'classification': 'ruleClassification',
    'name': 'ruleName',
    'db_type': 'ruleDbType',
    'operator': 'ruleOperator'
} %}
{% set edit_rule_ids = {
    'classification': 'editRuleClassification',
    'name': 'editRuleName',
    'db_type': 'editRuleDbType',
    'operator': 'editRuleOperator'
} %}

{% block title %}账户分类管理 - 鲸落{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/accounts/account_classification.css') }}">
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-tags me-2"></i>账户分类管理</h2>
                {% if current_user.role == 'admin' %}
                <p class="mb-0">管理账户分类和规则，包括增删改查和自动分类</p>
                {% else %}
                <p class="mb-0">查看账户分类和规则信息（只读模式）</p>
                {% endif %}
            </div>
            <div class="btn-group">
                {% if current_user.role == 'admin' %}
                <button class="btn btn-light" onclick="autoClassifyAll(event)">
                    <i class="fas fa-magic me-2"></i>自动分类
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">


    <!-- 主要内容区域 -->
    <div class="row">
        <!-- 左侧：分类列表 -->
        <div class="col-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>账户分类
                        </h5>
                        {% if current_user.role == 'admin' %}
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createClassificationModal">
                            <i class="fas fa-plus me-1"></i>新建分类
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div id="classificationsList">
                        <!-- 分类列表将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：规则管理 -->
        <div class="col-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>规则管理
                        </h5>
                        {% if current_user.role == 'admin' %}
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createRuleModal">
                            <i class="fas fa-plus me-1"></i>新建规则
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">

                    <!-- 规则列表 -->
                    <div id="rulesList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>加载规则中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 创建分类模态框 -->
<div class="modal fade" id="createClassificationModal" tabindex="-1" aria-labelledby="createClassificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createClassificationModalLabel">
                    <i class="fas fa-plus me-2"></i>新建账户分类
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                {{ classification_forms.classification_form(
                    'createClassificationForm',
                    create_classification_ids,
                    color_options,
                    'colorPreview'
                ) }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createClassification()">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 创建规则模态框 -->
<div class="modal fade" id="createRuleModal" tabindex="-1" aria-labelledby="createRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRuleModalLabel">
                    <i class="fas fa-cogs me-2"></i>新建分类规则
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                {{ classification_forms.rule_form(
                    'createRuleForm',
                    create_rule_ids,
                    False,
                    None,
                    'permissionsConfig'
                ) }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createRule()">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑分类模态框 -->
<div class="modal fade" id="editClassificationModal" tabindex="-1" aria-labelledby="editClassificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editClassificationModalLabel">
                    <i class="fas fa-edit me-2"></i>编辑账户分类
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                {{ classification_forms.classification_form('editClassificationForm', edit_classification_ids, color_options, 'editColorPreview', hidden_id='editClassificationId') }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateClassification()">保存</button>
            </div>
        </div>
    </div>
</div>


<!-- 编辑规则模态框 -->
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-labelledby="editRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRuleModalLabel">
                    <i class="fas fa-edit me-2"></i>编辑分类规则
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                {{ classification_forms.rule_form('editRuleForm', edit_rule_ids, True, 'editRuleId', 'editPermissionsConfig') }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateRule()">更新</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看规则模态框 -->
<div class="modal fade" id="viewRuleModal" tabindex="-1" aria-labelledby="viewRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewRuleModalLabel">
                    <i class="fas fa-eye me-2"></i>查看规则详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">规则名称</label>
                        <p class="form-control-plaintext" id="viewRuleName">-</p>
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">分类</label>
                        <p class="form-control-plaintext" id="viewRuleClassification">-</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-4">
                        <label class="form-label fw-bold">数据库类型</label>
                        <p class="form-control-plaintext" id="viewRuleDbType">-</p>
                    </div>
                    <div class="col-4">
                        <label class="form-label fw-bold">匹配逻辑</label>
                        <p class="form-control-plaintext" id="viewRuleOperator">-</p>
                    </div>
                    <div class="col-4">
                        <label class="form-label fw-bold">状态</label>
                        <p class="form-control-plaintext" id="viewRuleStatus">-</p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">权限配置</label>
                    <div id="viewPermissionsConfig" class="border rounded p-3 bg-light">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">创建时间</label>
                        <p class="form-control-plaintext" id="viewRuleCreatedAt">-</p>
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">更新时间</label>
                        <p class="form-control-plaintext" id="viewRuleUpdatedAt">-</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block extra_js %}
<script>
    // 设置用户角色，供JavaScript使用
    window.currentUserRole = '{{ current_user.role }}';
</script>
<script src="{{ url_for('static', filename='js/common/permission_policy_center.js') }}"></script>
<script src="{{ url_for('static', filename='js/api/accountClassification.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/accounts/account_classification.js') }}"></script>
{% endblock %}
