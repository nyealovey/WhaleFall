{% extends "base.html" %}

{% set is_edit = resource is not none %}
{% set form_values = form_data if form_data else {} %}
{% set page_title = '编辑用户' if is_edit else '创建用户' %}
{% set password_optional_on_edit = form_definition.extra_config.get('password_optional_on_edit') %}

{% block title %}{{ page_title }} - {{ config.APP_NAME or '鲸落' }}{% endblock %}

{% block content %}
<div class="row justify-content-center" id="user-form-root"
     data-form-mode="{{ form_mode }}"
     {% if resource %}data-user-id="{{ resource.id }}"{% endif %}>
    <div class="col-lg-6 col-md-8">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="fas {{ 'fa-user-edit' if is_edit else 'fa-user-plus' }} me-2"></i>{{ page_title }}
                    </h5>
                    <small class="text-muted">统一的用户创建/编辑表单</small>
                </div>
                {% if is_edit %}
                <span class="badge bg-secondary">ID #{{ resource.id }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if form_errors %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>{{ form_errors }}
                </div>
                {% endif %}

                <form method="POST" id="userForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="mb-3">
                        <label for="username" class="form-label">用户名 <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               id="username"
                               name="username"
                               value="{{ form_values.get('username', resource.username if is_edit else '') }}"
                               placeholder="仅支持字母、数字和下划线"
                               required>
                        <div class="form-text">长度 3-20 位，仅可包含字母、数字和下划线</div>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">
                            密码 {% if not is_edit %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        <input type="password"
                               class="form-control"
                               id="password"
                               name="password"
                               placeholder="{{ '至少 8 位，包含大小写字母和数字' }}"
                               {% if not is_edit %}required{% endif %}>
                        <div class="form-text">
                            {% if is_edit and password_optional_on_edit %}
                                留空则保持原密码，输入新密码需至少8位且包含大小写字母与数字
                            {% else %}
                                至少8位且包含大小写字母与数字
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="role" class="form-label">角色 <span class="text-danger">*</span></label>
                        {% set current_role = form_values.get('role', resource.role if is_edit else '') %}
                        <select class="form-select" id="role" name="role" required>
                            <option value="">请选择角色</option>
                            {% for option in role_options %}
                            <option value="{{ option.value }}" {% if current_role == option.value %}selected{% endif %}>
                                {{ option.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-check form-switch mb-4">
                        <input type="hidden" name="is_active" value="0">
                        {% set active_value = form_values.get('is_active', resource.is_active if is_edit else True) %}
                        <input class="form-check-input"
                               type="checkbox"
                               role="switch"
                               id="is_active"
                               name="is_active"
                               value="1"
                               {% if active_value in [True, '1', 'true', 1, 'on'] %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">激活用户</label>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('users.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>返回列表
                        </a>
                        <button type="submit" class="btn btn-primary" data-resource-submit>
                            <i class="fas fa-save me-2"></i>{{ '保存更改' if is_edit else '创建用户' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/users/form.js') }}"></script>
{% endblock %}
