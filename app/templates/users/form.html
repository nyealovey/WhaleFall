{% extends "base.html" %}
{% set page_id = 'UserFormPage' %}

{% from 'components/ui/page_header.html' import page_header %}

{% set is_edit = form_mode == 'edit' %}
{% set form_values = form_data if form_data else {} %}

{% block title %}{{ '编辑用户' if is_edit else '创建用户' }} - 鲸落{% endblock %}

{% block content_outer %}
{{ page_header('fas fa-user', '编辑用户' if is_edit else '创建用户', '配置系统用户账号与权限') }}

<section class="page-section">
    <div class="layout-shell">
        <div class="layout-shell-inner">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-6">
                    <div class="card">
                        <div class="card-body p-4 p-lg-5">
                            {% if form_errors %}
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-circle me-2" aria-hidden="true"></i>{{ form_errors }}
                            </div>
                            {% endif %}

                            <form method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                                <div class="mb-3">
                                    <label for="username" class="form-label">用户名 <span class="text-danger">*</span></label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="username"
                                        name="username"
                                        required
                                        autocomplete="username"
                                        placeholder="仅支持字母、数字和下划线"
                                        value="{{ form_values.get('username') if form_values.get('username') is not none else (resource.username if resource else '') }}"
                                    />
                                    <div class="form-text">长度 3-20 位, 仅可包含字母、数字、下划线</div>
                                </div>

                                <div class="mb-3">
                                    <label for="password" class="form-label">
                                        {{ '新密码' if is_edit else '密码' }}
                                        {% if not is_edit %}<span class="text-danger">*</span>{% endif %}
                                    </label>
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="password"
                                        name="password"
                                        autocomplete="new-password"
                                        {% if not is_edit %}required{% endif %}
                                        placeholder="{{ '留空表示不修改密码' if is_edit else '至少 8 位, 包含大小写字母与数字' }}"
                                    />
                                    <div class="form-text">
                                        {% if is_edit %}
                                            留空表示保持原密码
                                        {% else %}
                                            至少 8 位, 包含大小写字母与数字
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="role" class="form-label">角色 <span class="text-danger">*</span></label>
                                    {% set selected_role = form_values.get('role') if form_values.get('role') is not none else (resource.role if resource else '') %}
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="">请选择角色</option>
                                        {% for option in role_options or [] %}
                                        <option value="{{ option.value }}" {% if option.value == selected_role %}selected{% endif %}>{{ option.label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                {% set is_active_raw = form_values.get('is_active') %}
                                {% if is_active_raw is none %}
                                    {% set is_active_checked = (resource.is_active if resource else True) %}
                                {% else %}
                                    {% set is_active_checked = is_active_raw in ['1', 'true', 'True', 'on', 'yes'] %}
                                {% endif %}
                                <div class="form-check form-switch mb-4">
                                    <input class="form-check-input" type="checkbox" role="switch" id="is_active" name="is_active" value="1" {% if is_active_checked %}checked{% endif %} />
                                    <label class="form-check-label" for="is_active">激活状态</label>
                                </div>

                                <div class="d-flex flex-wrap gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2" aria-hidden="true"></i>{{ '保存' if is_edit else '创建' }}
                                    </button>
                                    <a class="btn btn-outline-secondary" href="{{ url_for('users.index') }}">
                                        <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>返回
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

