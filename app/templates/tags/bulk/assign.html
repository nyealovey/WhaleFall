{% extends "base.html" %}

{% from 'components/ui/page_header.html' import page_header %}

{% block title %}批量分配标签 - 鲸落{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/tags/batch-assign.css') }}">
{% endblock %}

{% block content_outer %}
{% call page_header('fas fa-tasks', '批量分配标签', '批量管理数据库实例的标签分配') %}
<div class="btn-group">
    <a href="{{ url_for('tags.index') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>返回标签管理
    </a>
</div>
{% endcall %}

<section class="page-section">
    <div class="layout-shell">
        <div class="layout-shell-inner">

<div class="batch-mode-toggle" role="group">
    <input type="radio" class="chip-toggle-input" name="batchMode" id="assignMode" value="assign" checked>
    <label class="chip-toggle chip-toggle--active" for="assignMode">
        <i class="fas fa-plus me-1"></i>分配模式
    </label>

    <input type="radio" class="chip-toggle-input" name="batchMode" id="removeMode" value="remove">
    <label class="chip-toggle" for="removeMode">
        <i class="fas fa-minus me-1"></i>移除模式
    </label>
</div>

<!-- 移除模式提示 -->
<div class="batch-alert-card" id="removeModeInfo" style="display: none;">
    <div class="batch-alert-card__icon">
        <span class="status-pill status-pill--warning">
            <i class="fas fa-exclamation-triangle"></i>移除模式
        </span>
    </div>
    <p class="text-muted mb-0">选择要移除标签的实例，系统将移除这些实例上的所有标签。</p>
</div>

<!-- 选择区域 -->
<div class="batch-layout-grid" id="batchLayoutGrid" data-mode="assign">
    <!-- 实例列 -->
    <div class="batch-layout__column">
        <article class="batch-selection-card">
            <header class="batch-selection-card__header">
                <div>
                    <p class="batch-selection-card__eyebrow">实例</p>
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>选择实例</h5>
                </div>
                <span class="status-pill status-pill--info" id="selectedInstancesCount">0</span>
            </header>
            <div class="batch-selection-card__body">
                <div class="selection-panel">
                    <div class="panel-placeholder" id="instancesLoading">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">加载实例中...</p>
                    </div>
                    <div id="instancesContainer" class="selection-panel__content" style="display: none;"></div>
                </div>
            </div>
        </article>
    </div>

    <!-- 标签列 -->
    <div class="batch-layout__column" id="tagSelectionPanel">
        <article class="batch-selection-card">
            <header class="batch-selection-card__header">
                <div>
                    <p class="batch-selection-card__eyebrow">标签</p>
                    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>选择标签</h5>
                </div>
                <span class="status-pill status-pill--info" id="selectedTagsCount">0</span>
            </header>
            <div class="batch-selection-card__body">
                <div class="selection-panel">
                    <div class="panel-placeholder" id="tagsLoading">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">加载标签中...</p>
                    </div>
                    <div id="tagsContainer" class="selection-panel__content" style="display: none;"></div>
                </div>
            </div>
        </article>
    </div>

    <!-- 汇总列 -->
    <div class="batch-layout__summary">
        <form id="batchAssignForm">
            <input type="hidden" id="selectedInstancesInput" name="selected_instances" value="">
            <input type="hidden" id="selectedTagsInput" name="selected_tags" value="">
            <input type="hidden" id="batchModeField" name="mode" value="assign">

            <article class="batch-summary-card summary-card-sticky" id="selectionSummary">
                <header class="batch-summary-card__header">
                    <div>
                        <p class="batch-summary-card__eyebrow">操作概览</p>
                        <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>当前选择</h5>
                    </div>
                    <div class="summary-count-chip chip-outline chip-outline--muted">
                        <span><span id="totalSelectedInstances">0</span> 个实例</span>
                        <span class="divider">·</span>
                        <span id="summaryTagCount"><span id="totalSelectedTags">0</span> 个标签</span>
                    </div>
                </header>

                <div class="batch-summary-card__section">
                    <div class="batch-summary-card__title">
                        <span class="status-pill status-pill--muted"><i class="fas fa-database"></i>已选实例</span>
                    </div>
                    <div id="selectedInstancesList" class="ledger-chip-stack"></div>
                </div>

                <div class="batch-summary-card__section" id="selectedTagsSection">
                    <div class="batch-summary-card__title">
                        <span class="status-pill status-pill--muted"><i class="fas fa-tags"></i>已选标签</span>
                    </div>
                    <div id="selectedTagsList" class="ledger-chip-stack"></div>
                </div>

                <div class="summary-card__actions">
                    <button type="button" class="btn btn-outline-secondary" id="clearAllSelections">
                        <i class="fas fa-eraser me-1"></i>清空选择
                    </button>
                    <button type="submit" class="btn btn-primary" id="executeBatchOperation">
                        <i class="fas fa-plus me-1"></i>执行操作
                    </button>
                </div>

                <div class="batch-progress-card mt-3" id="progressContainer" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="status-pill status-pill--info"><i class="fas fa-sync-alt"></i>批量执行</span>
                        <small class="text-muted" id="progressText">准备中...</small>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </article>
        </form>
    </div>
</div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/modules/services/tag_management_service.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/stores/tag_batch_store.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/tags/batch-assign.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap/tags/batch-assign.js') }}"></script>
{% endblock %}
