{% extends "base.html" %}
{% set page_id = 'TagsIndexPage' %}
{% set page_density = 'compact' %}
{% from 'components/filters/macros.html' import filter_card, search_input, tag_category_filter, status_active_filter %}
{% from 'components/ui/page_header.html' import page_header %}
{% from 'components/ui/macros.html' import metric_card %}

{% block title %}标签管理 - 鲸落{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/gridjs/mermaid.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/tags/index.css') }}">
{% endblock %}

{% block content_outer %}
<div id="tags-page-root">
{% set tag_desc = '管理数据库实例的标签信息' if current_user.role == 'admin' else '查看数据库实例的标签信息（只读模式）' %}
{% if current_user.role == 'admin' %}
{% call page_header('fas fa-tags', '标签管理', tag_desc) %}
<div class="btn-group">
    <button class="btn btn-primary" type="button" data-action="create-tag">
        <i class="fas fa-plus me-2"></i>添加标签
    </button>
    <a href="{{ url_for('tags_bulk.batch_assign') }}" class="btn btn-outline-secondary">
        <i class="fas fa-tasks me-2"></i>批量分配
    </a>
</div>
{% endcall %}
{% else %}
{{ page_header('fas fa-tags', '标签管理', tag_desc) }}
{% endif %}

{% set stats = tag_stats or {'total': 0, 'active': 0, 'inactive': 0, 'category_count': 0} %}
{% set total_tags = stats.total or 0 %}
{% set active_tags = stats.active or 0 %}
{% set inactive_tags = stats.inactive or 0 %}
{% set tag_categories = stats.category_count or 0 %}
{% set active_rate = (active_tags / total_tags * 100) if total_tags else 0 %}
{% set inactive_rate = (inactive_tags / total_tags * 100) if total_tags else 0 %}
{% set avg_per_category = (total_tags / tag_categories) if tag_categories else 0 %}
{% set active_per_category = (active_tags / tag_categories) if tag_categories else 0 %}
<section class="page-section page-section--flush">
    <div class="layout-shell">
        <div class="layout-shell-inner">
            <div class="tags-stats-grid" id="tagStatsContainer">
                {% call metric_card('全部标签', value=total_tags, icon_class='fas fa-tags', tone='info', data_stat_key='total') %}
                    <span class="chip-outline chip-outline--muted" title="均值/分类" aria-label="均值/分类">
                        <i class="fas fa-layer-group" aria-hidden="true"></i><span id="tagsMetaAvgPerCategory" aria-hidden="true">{{ avg_per_category|round(1) }}</span>
                    </span>
                {% endcall %}
                {% call metric_card('启用率', value=('%.1f'|format(active_rate) ~ '%'), icon_class='fas fa-check-circle', tone='success', data_stat_key='active_rate') %}
                    <span class="chip-outline chip-outline--muted" title="启用" aria-label="启用">
                        <i class="fas fa-check" aria-hidden="true"></i><span id="tagsMetaActiveCount" aria-hidden="true">{{ active_tags }}</span>
                    </span>
                {% endcall %}
                {% call metric_card('停用率', value=('%.1f'|format(inactive_rate) ~ '%'), icon_class='fas fa-ban', tone='warning', data_stat_key='inactive_rate') %}
                    <span class="chip-outline chip-outline--muted" title="停用" aria-label="停用">
                        <i class="fas fa-ban" aria-hidden="true"></i><span id="tagsMetaInactiveCount" aria-hidden="true">{{ inactive_tags }}</span>
                    </span>
                {% endcall %}
                {% call metric_card('标签分类', value=tag_categories, icon_class='fas fa-tag', tone='muted', data_stat_key='category_count') %}
                    <span class="chip-outline chip-outline--muted" title="启用/分类" aria-label="启用/分类">
                        <i class="fas fa-user-check" aria-hidden="true"></i><span id="tagsMetaActivePerCategory" aria-hidden="true">{{ active_per_category|round(1) }}</span>
                    </span>
                {% endcall %}
            </div>
        </div>
    </div>
</section>

<section class="page-section page-section--stacked">
    <div class="layout-shell">
        <div class="layout-shell-inner">
            {% call filter_card(form_id='tag-filter-form', action=url_for('tags.index')) %}
                {{ search_input(value=search, placeholder='搜索标签名称或分类', col_class='col-md-2 col-12') }}
                {{ tag_category_filter(category_options, category, col_class='col-md-2 col-12') }}
                {{ status_active_filter(status_options, status, col_class='col-md-2 col-12') }}
            {% endcall %}
        </div>
    </div>
</section>

<section class="page-section page-section--stacked">
    <div class="layout-shell">
        <div class="layout-shell-inner">
            <div class="card">
                <div class="card-body">
                    <div id="tags-grid" data-can-manage="{{ 'true' if current_user.role == 'admin' else 'false' }}"></div>
                </div>
            </div>
        </div>
    </div>
</section>

{% include 'tags/modals/tag-modals.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='vendor/gridjs/gridjs.umd.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/grid-wrapper.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/ui/ui-helpers.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/grid-row-meta.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/grid-page.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/grid-plugins/filter-card.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/grid-plugins/action-delegation.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/services/tag_management_service.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/tags/modals/tag-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/tags/index.js') }}"></script>
{% endblock %}
