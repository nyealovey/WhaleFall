<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title id="page-title">{% block title %}鲸落 - 数据同步管理平台{% endblock %}</title>

    <!-- 站点图标 -->
    <link rel="icon" type="image/webp" href="{{ url_for('static', filename='img/logo.webp') }}">
    <link rel="shortcut icon" type="image/webp" href="{{ url_for('static', filename='img/logo.webp') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">

    <!-- Apple 图标 - 针对 Mac Safari 优化 -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}">
    <link rel="apple-touch-icon-precomposed"
        href="{{ url_for('static', filename='img/apple-touch-icon-precomposed.png') }}">

    <!-- Bootstrap CSS (Flatly Theme) -->
    <link href="{{ url_for('static', filename='vendor/bootstrap/bootstrap-flatly.min.css') }}" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="{{ url_for('static', filename='vendor/fontawesome/css/all.min.css') }}" rel="stylesheet">
    <!-- CSS变量定义 -->
    <link href="{{ url_for('static', filename='css/variables.css') }}" rel="stylesheet">
    <!-- 全局样式 -->
    <link href="{{ url_for('static', filename='css/global.css') }}" rel="stylesheet">
    <!-- 表格组件样式 -->
    <link href="{{ url_for('static', filename='css/components/table.css') }}" rel="stylesheet">
    <!-- Tom Select 样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/tom-select/tom-select.bootstrap5.min.css') }}">
    <!-- 筛选组件通用样式 -->
    <link href="{{ url_for('static', filename='css/components/filters/filter-common.css') }}" rel="stylesheet">

    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <img src="{{ url_for('static', filename='img/logo.webp') }}" alt="鲸落" height="40" class="me-2"
                    style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
                <span id="app-name">鲸落</span>
            </a>

            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.index') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>仪表盘
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="databaseDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-database me-1"></i>数据管理
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="databaseDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('instance.index') }}">
                                    <i class="fas fa-server me-2"></i>实例管理
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('account.list_accounts') }}">
                                    <i class="fas fa-users me-2"></i>账户管理
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('database_ledger.list_databases') }}">
                                    <i class="fas fa-database me-2"></i>数据库台账
                                </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="statisticsDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-chart-line me-1"></i>数据统计
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="statisticsDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('instance_aggr.instance_aggregations') }}">
                                    <i class="fas fa-chart-pie me-2"></i>容量统计(实例)
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('database_aggr.database_aggregations') }}">
                                    <i class="fas fa-database me-2"></i>容量统计(数据库)
                                </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="settingsDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog me-1"></i>统一设置
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="settingsDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('credentials.index') }}">
                                    <i class="fas fa-key me-2"></i>凭据管理
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('tags.index') }}">
                                    <i class="fas fa-tag me-2"></i>标签管理
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('account_classification.index') }}">
                                    <i class="fas fa-tags me-2"></i>账户分类管理
                                </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="historyDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-history me-1"></i>历史记录
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="historyDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('logs.logs_dashboard') }}">
                                    <i class="fas fa-chart-line me-2"></i>日志中心
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('sync_sessions.index') }}">
                                    <i class="fas fa-tasks me-2"></i>会话中心
                                </a></li>
                        </ul>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false" style="color: #ff6b6b; font-weight: bold;">
                            <i class="fas fa-cogs me-1"></i>{% if current_user.role == 'admin' %}管理中心{% else %}用户中心{%
                            endif %}
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('users.index') }}">
                                    <i class="fas fa-users me-2"></i>用户管理{% if current_user.role != 'admin' %}（只读）{%
                                    endif %}
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('scheduler.index') }}">
                                    <i class="fas fa-clock me-2"></i>定时任务
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('partition.partitions_page') }}">
                                    <i class="fas fa-layer-group me-2"></i>分区管理
                                </a></li>
                        </ul>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>

                <ul class="navbar-nav ms-auto">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>{{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('auth.profile') }}">
                                    <i class="fas fa-user-circle me-2"></i>个人资料
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.change_password') }}">
                                    <i class="fas fa-key me-2"></i>修改密码
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                    <i class="fas fa-sign-out-alt me-2"></i>退出登录
                                </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.login') }}">
                            <i class="fas fa-sign-in-alt me-1"></i>登录
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="main-content">
        <div class="container">
            <!-- 消息提示 -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                role="alert">
                <i
                    class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- 页面内容 -->
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <p class="mb-0">
                &copy; 2025 <span id="footer-app-name">鲸落</span> 1.2.3 - 数据同步管理平台 |
                <a href="{{ url_for('main.about') }}" class="text-white text-decoration-none">关于</a> |
            </p>
        </div>
    </footer>

    <!-- 引入 Bootstrap JS -->
    <script src="{{ url_for('static', filename='vendor/bootstrap/bootstrap.bundle.min.js') }}"></script>

    <!-- 通用工具组件 -->

    <!-- Numeral.js 及统一数字格式化工具 -->
    <script src="{{ url_for('static', filename='vendor/numeral/numeral.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common/number-format.js') }}"></script>

    <!-- Mitt 事件总线 -->
    <script src="{{ url_for('static', filename='vendor/mitt/mitt.umd.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common/event-bus.js') }}"></script>

    <!-- Lodash 及封装工具 -->
    <script src="{{ url_for('static', filename='vendor/lodash/lodash.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common/lodash-utils.js') }}"></script>

    <!-- Umbrella JS 及 DOM/HTTP 封装 -->
    <script src="{{ url_for('static', filename='vendor/umbrella/umbrella.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/dom.helpers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/http-u.js') }}"></script>

    <!-- Day.js 及插件 -->
    <script src="{{ url_for('static', filename='vendor/dayjs/dayjs.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/dayjs/plugin/utc.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/dayjs/plugin/timezone.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/dayjs/plugin/relativeTime.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/dayjs/plugin/duration.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/dayjs/plugin/customParseFormat.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/dayjs/plugin/localizedFormat.min.js') }}"></script>
    
    <script src="{{ url_for('static', filename='js/common/toast.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/just-validate/just-validate.production.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common/form-validator.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/validation-rules.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/csrf-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/common/time-utils.js') }}"></script>
<!-- 引入 Tom Select -->
<script src="{{ url_for('static', filename='vendor/tom-select/tom-select.complete.min.js') }}"></script>
<!-- 筛选组件通用脚本 -->
<script src="{{ url_for('static', filename='js/modules/ui/filter-card.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/ui/modal.js') }}"></script>

<!-- 权限查看组件 -->
<script src="{{ url_for('static', filename='js/modules/services/permission_service.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/services/connection_service.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/components/connection-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/services/tag_management_service.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/stores/tag_management_store.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/components/tags/tag-selector-view.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/components/tags/tag-selector-modal-adapter.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/views/components/tags/tag-selector-controller.js') }}"></script>

    <!-- 动态加载应用信息 -->
    <script>
        (function (global) {
            'use strict';

            const helpers = global.DOMHelpers;
            const client = global.httpU;

            if (!helpers || !client) {
                console.error('DOMHelpers 或 httpU 未正确加载，无法拉取应用信息');
                return;
            }

            const { ready, selectOne } = helpers;

            async function loadAppInfo() {
                try {
                    const payload = await client.get('/admin/api/app-info');
                    if (!payload || !payload.success || !payload.data) {
                        return;
                    }

                    const appName = payload.data.app_name;

                    const appNameElement = selectOne('#app-name');
                    if (appNameElement.length) {
                        appNameElement.text(appName);
                    }

                    const footerAppNameElement = selectOne('#footer-app-name');
                    if (footerAppNameElement.length) {
                        footerAppNameElement.text(appName);
                    }

                    const pageTitleElement = selectOne('#page-title');
                    if (pageTitleElement.length) {
                        pageTitleElement.text(`${appName} - 数据同步管理平台`);
                    }
                } catch (error) {
                    console.error('加载应用信息失败:', error);
                }
            }

            ready(loadAppInfo);
        })(window);
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>
