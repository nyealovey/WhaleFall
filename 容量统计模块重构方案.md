# 容量统计模块重构方案

## 文档信息
- 创建日期: 2025-10-30
- 当前版本: v1.1 (更新: 优化方案结构、明确交互与实施步骤)
- 状态: 待审阅
- 覆盖范围: 容量统计(实例)、容量统计(数据库)

## 背景与问题陈述
- 两个容量统计页面采用近乎相同的布局、筛选与图表渲染逻辑，前端 JS 与模板存在大量重复。
- 当前筛选器同时提供起止时间，但业务仅需要“最近 24 小时 / 7 天 / 30 天”等快捷区间，额外的日期选择导致 UI 冗余且增加校验复杂度。
- 数据转换逻辑分散在不同文件，导致缺陷修复、指标扩展需重复修改。
- 图表配置、颜色策略、TOP N 规则在各页面独立维护，易产生不一致。

## 目标与非目标
### 主要目标
1. 提炼共享能力，沉淀为 `app/static/js/common/capacity_stats/` 下的公共模块，实例页与数据库页以配置驱动。
2. 统一数据请求、转换与缓存策略，确保指标口径一致。
3. 调整筛选交互，移除“开始时间/结束时间”，以快捷时间范围+必要的实体选项替代。
4. 减少 70% 以上重复代码，并完善文档与测试覆盖。

### 非目标
- 不在本次迭代重写后端聚合 SQL 或增加新指标。
- 不引入新的图表库；继续基于现有 Chart.js 版本。
- 不支持旧版筛选 URL 兼容回退，前端改造后以新参数为准。

## 方案概览
### 模块划分
```
app/static/js/common/capacity_stats/
├── manager.js                # 核心调度器，负责初始化、数据拉取、事件绑定
├── data_source.js            # 封装 API 请求、缓存与错误处理
├── transformers.js           # 统一的数据清洗与指标计算
├── chart_renderer.js         # 图表渲染与更新
├── filters.js                # 筛选器配置/状态同步
└── summary_cards.js          # 顶部统计卡片渲染

app/static/js/pages/capacity_stats/
├── instance_aggregations.js  # 仅传入实例页面所需配置
└── database_aggregations.js  # 仅传入数据库页面所需配置
```

### 关键配置点
- `resourceType`: `"instance"` / `"database"`，用于区分接口、字段、展示名称。
- `filterSchema`: 声明各筛选项（数据库类型、实例、数据库）的数据源与是否必填。
- `chartDefinitions`: 统一声明趋势图、环比图、TopN 图在 `transformers` 中的字段映射。
- `summaryMetrics`: 统计卡片的数据来源与展示格式。

## 交互与体验调整
- **筛选器**: 移除自定义开始/结束时间，保留“最近 1 天 / 7 天 / 30 天 / 自定义区间”的快捷选择，自定义区间仅支持单一日期或时间跨度，不再出现双日期输入框。
- **筛选应用方式**: 继续采用变更即自动刷新，保持与现有页面一致的操作体验。
- **图表独立操作区**: 按钮/切换面板继续与各图表绑定（例如单图表的指标切换、TopN 控制），公共模块通过 `chartDefinitions` 暴露插槽，允许为每个图表配置独立的事件和渲染逻辑。
- **加载提示**: 公共管理器统一处理 loading/error 状态，避免重复 DOM 操作。

## 实施步骤
1. **公共模块搭建**
   - 建立 `common/capacity_stats` 目录与骨架类。
   - 将现有图表、数据处理函数迁移并编写单元测试。
2. **实例页接入**
   - 编写 `pages/capacity_stats/instance_aggregations.js`，传入实例场景配置。
   - 替换模板中旧脚本引用，确认筛选器 DOM 结构与新模块对齐。
3. **数据库页接入**
   - 复用实例页的模式，覆写 `resourceType`、`filterSchema` 等配置。
   - 调整模板中多余筛选项 (移除结束时间输入)。
4. **移除冗余文件**
   - 删除旧版 JS 与 CSS，确认无模板引用。
   - 在 Git 历史中保留记录，无需额外 `.backup` 文件。
5. **联调与对比验证**
   - 对照旧版页面截图与数据，确认指标数值、排序、翻页、导出保持一致。
   - 覆盖实例/数据库页面的所有筛选组合，确保联动无误。

## 时间计划 (预估 10 人小时)
| 阶段 | 内容 | 工时 | 产出 |
|------|------|------|------|
| T+0 | 公共模块骨架 & 单测 | 4h | `common/capacity_stats/*` |
| T+1 | 实例页改造 | 2h | 新 `instance_aggregations.js` |
| T+2 | 数据库页改造 | 2h | 新 `database_aggregations.js` |
| T+3 | 清理与文档 | 1h | README、迁移文档 |
| T+4 | 联调与测试 | 1h | 测试记录 |

## 验收标准
- **功能**: 筛选自动刷新、TopN/图表切换、导出、统计卡片均与旧版一致；移除开始/结束时间后业务确认无缺失。
- **性能**: 数据加载与首屏渲染时间无明显回退 (≤ 原有 110%)。
- **代码质量**: 通过 `make quality`，公共模块具备至少核心路径的单元测试；重复代码减少 ≥ 70%。
- **易用性**: 筛选器交互经产品确认；新模块使用方式文档化。

## 风险与缓解
- **公共模块未覆盖某些特例**: 在实施初期收集差异，允许页面层提供极简 override；联调阶段重点验证。
- **Chart.js 配置差异导致 UI 变更**: 提前梳理现有配置，将所有差异转化为配置项而非硬编码。
- **移除时间范围引发业务质疑**: 与产品确认新的时间选择逻辑，保留接口支持时间参数，若需回退可在页面层追加开关。

## 测试计划
- **单元测试**: `transformers`、`data_source` 中的数据转换与异常路径。
- **集成测试**: 在 `tests/integration/capacity_stats` 新增 API 响应模拟，验证配置驱动渲染结果。
- **手动验证**: 覆盖主要筛选组合、切换 TopN、刷新趋势图。

## 依赖与配合事项
- 后端需确认现有接口已经支持按照快捷时间范围请求；若需新增参数格式，应提前告知前端。
- UI/产品团队确认筛选器最终样式与占位文案。
- 确认其它页面未直接依赖即将删除的旧 JS 文件，避免静态引用失效。

## 后续演进建议
- 视业务需求扩展至其他容量类页面，实现真正的配置驱动页面生成。
- 在公共模块中补充性能监控钩子，逐步引入懒加载与骨架屏。
- 评估迁移至 TypeScript 提升类型安全性及可维护性。

---
**审阅人**: _______________  
**审阅日期**: _______________  
**审阅意见**: _______________
