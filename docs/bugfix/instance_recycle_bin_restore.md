# 实例误删恢复方案：回收站（软删除）+ 恢复按钮

## 1. 背景与现象

实例管理（`/instances`）目前支持删除实例，但删除后**无法在界面中恢复**。一旦误操作删除，会导致：

- 实例配置（host/port/凭据/标签等）消失，需人工重建。
- 历史同步数据（账户权限、容量统计、会话记录等）可能被清理，定位/追溯困难。

> 重要说明：如果实例已经被“硬删除”（数据库记录已物理删除），本方案上线后也无法直接“凭空恢复历史数据”。这种情况只能依赖数据库备份/快照，或手工重新创建实例并重新同步。

## 2. 目标与非目标

### 2.1 目标

1. 提供**可视化回收站**能力：在实例管理页通过“显示已删除”复选框查看已删除实例。
2. 提供**恢复按钮**：对已删除实例仅提供“恢复”操作，降低误操作风险。
3. 明确删除语义：将“删除实例”调整为“移入回收站（可恢复）”，并为“永久删除（不可恢复）”预留路径。
4. 保持交互一致：确认弹窗走统一组件（`UI.confirmDanger`/统一确认模态），禁止浏览器 `confirm()`。

### 2.2 非目标

- 不承诺“找回已硬删除的数据”；这属于备份/数据恢复流程（DBA/运维范畴）。
- 不在本阶段对所有资源（凭据/标签/分区等）统一引入回收站（可作为长期规划）。

## 3. 当前实现与根因

### 3.1 删除是硬删除（不可恢复）

当前删除入口：

- 单个删除：`POST /instances/api/<id>/delete`（见 `app/routes/instances/manage.py`）
- 批量删除：`POST /instances/batch/api/delete`（见 `app/routes/instances/batch.py`）

其底层删除服务：`InstanceBatchDeletionService`（`app/services/instances/batch_service.py`）

现状问题：

- 服务内对关联数据做 `.delete(...)`，最后对实例本体执行 `db.session.delete(instance)`，属于**物理删除**。
- 前端批量删除确认文案也明确提示“删除后将无法恢复”，与硬删除相匹配。

### 3.2 模型已具备 `deleted_at` 但未形成闭环

`Instance` 模型已包含 `deleted_at` 字段（`app/models/instance.py`），说明域模型层面具备软删除表达能力，但目前删除链路未使用该字段，因此缺失恢复闭环。

## 4. 方案概述：回收站（软删除）+ 恢复

### 4.1 删除语义调整（软删除优先）

将“删除实例”调整为：

- **移入回收站（软删除）**：仅标记 `instances.deleted_at = now()`，实例记录仍存在，可在 UI 中恢复。
- **永久删除（硬删除）**：仅在回收站里提供（或后台定期清理），对实例及其关联数据做物理删除。

> 推荐策略：默认软删除 + 保留期自动清理（例如 7/14/30 天），既能防误删，也能控制存储增长。

### 4.2 恢复语义

恢复操作：

- 将 `deleted_at` 置空（恢复实例“可见性”）。
- **不自动触发同步**（避免恢复即产生资源冲击）；恢复后由用户主动点击“同步/测试连接”。
- 恢复不应覆盖用户原有的 `is_active`（激活/停用）选择；软删除与停用是不同语义。

## 5. UI/UX 设计（按你的思路落地）

### 5.1 实例管理页增加“显示已删除”复选框

位置建议：实例列表筛选区（FilterCard）中，靠近状态筛选（`status_active_filter`）旁边。

交互：

- 默认不勾选：仅展示未删除实例（`deleted_at IS NULL`）。
- 勾选后：实例列表包含已删除实例；已删除实例行呈现“已删除”状态标签，并**仅显示“恢复”按钮**（无编辑/测试/删除等其他按钮）。

URL 同步：

- 将该开关同步到 URL：`include_deleted=true/false`，以便分享链接时行为一致。

### 5.2 已删除实例行的交互限制

已删除行建议：

- 行整体置灰（或降低对比度），减少误点击。
- 操作列只保留：
  - `恢复`（建议 `btn btn-outline-primary btn-sm`）
- 禁用/隐藏行选择复选框（避免被纳入“批量测试/批量删除”等操作）。

### 5.3 恢复操作确认与反馈

恢复属于“影响范围明确但可逆”的操作，建议仍提供二次确认（使用统一模态组件），避免误点：

- 标题：确认恢复实例
- 影响范围：实例名称 + host:port
- 提示：恢复后实例将重新出现在列表中；如需数据请手动同步

成功后：

- toast 成功提示
- 刷新 grid（恢复后该行应从“已删除”状态变为正常行，或在未勾选“显示已删除”时直接消失）

## 6. 后端/API 设计

### 6.1 列表 API：支持包含已删除实例

接口：`GET /instances/api/instances`

新增参数：

- `include_deleted`：`true|false`，默认 `false`

返回结构建议扩展：

- 在 items 中增加 `deleted_at`（ISO 字符串或 null）/ `status`（active/inactive/deleted）/ `is_deleted`（布尔）至少其一，供前端渲染“已删除”状态与按钮策略。

### 6.2 删除 API：从硬删除调整为软删除

接口：`POST /instances/api/<id>/delete`

建议行为：

- 若实例未删除：设置 `deleted_at = now()`。
- 若实例已删除：返回成功（幂等），避免重复点击造成错误提示。

返回建议：

- `instance_id`
- `deleted_at`
- `deleted_mode: "soft"`

> 注意：原硬删除返回的“删除统计信息”（deleted_sync_records 等）在软删除模式下不再合理。建议将统计信息迁移到“永久删除”路径中返回，避免误导。

### 6.3 恢复 API：新增 restore endpoint

接口建议：

- `POST /instances/api/<id>/restore`

校验：

- 实例存在且 `deleted_at` 非空，否则返回合理错误（或幂等成功：已恢复时直接成功）。
- 若关联凭据已不存在（`credential_id` 指向已删除凭据）：建议恢复时将 `credential_id` 置空并返回 warning 文案，提示用户重新绑定凭据（或直接阻断恢复并提示先修复凭据，二选一需明确）。

权限：

- 建议使用 `@update_required`（或沿用 `@delete_required`，但语义上更偏 update）。

### 6.4 永久删除（可选但推荐）

接口建议（二选一）：

1) UI 仅做回收站+恢复；永久删除由后台定期清理（见下文 7.2）。
2) 在“显示已删除”视图里增加“永久删除”（高风险）按钮，但需要更严格确认与权限控制。

## 7. 数据治理与清理策略

### 7.1 保留期（推荐）

引入可配置保留期（例如 `INSTANCE_RECYCLE_BIN_RETENTION_DAYS=14`）：

- 实例软删除后保留 X 天可恢复。
- 超过保留期自动进入永久删除流程，释放关联数据占用。

### 7.2 自动清理任务（长期或中期）

在 `app/scheduler.py` 增加定时任务：

- 每天低峰执行：扫描 `deleted_at < now - retention_days` 的实例
- 对这些实例执行“永久删除”（复用现有硬删除逻辑，但改为按条件触发）

## 8. 风险与应对

1. **存储增长风险**：软删除会保留数据；用“保留期 + 自动清理”控制。
2. **命名唯一约束冲突**：实例名目前唯一（`Instance.name` unique）。
   - 方案 A（短期）：软删除期间仍占用名称；需要恢复或永久删除后才能重建同名实例。
   - 方案 B（中期）：将唯一约束改为“仅对未删除实例唯一”（部分唯一索引），并在恢复时处理同名冲突（提示用户改名或放弃恢复）。
3. **恢复导致误触发同步**：明确“不自动同步”，仅恢复可见性与可操作性。

## 9. 验证清单

1. 删除实例后：
   - 默认列表不再显示该实例
   - 勾选“显示已删除”后可看到该实例，且操作列只有“恢复”
2. 恢复实例后：
   - 实例回到正常列表（或在未勾选显示已删除时直接出现）
   - 恢复不自动触发同步任务
3. URL 可分享：
   - `include_deleted=true` 分享链接打开后仍能看到已删除实例
4. 安全与一致性：
   - 删除/恢复确认均使用统一确认组件，代码中无 `confirm()`

## 10. 回滚方案

- 若需要回滚该特性：
  - 保留 `deleted_at` 字段与数据不影响旧逻辑（但旧界面可能无法展示/处理已删除实例）。
  - 若回滚到硬删除模式，应先执行一次“清理回收站”把软删除实例永久删除，避免“占用名称/数据残留”造成混乱。

## 11. 兼容/回退/兜底逻辑记录（便于后续清理）

- 类型：兼容
  - 描述：列表 API 增加 `include_deleted` 参数，默认 `false`，旧客户端不传参时行为不变。
- 类型：回退
  - 描述：若恢复时关联凭据不存在，可选择“回退为 credential_id=null 并提示用户修复”，避免恢复操作被完全阻断（需在实现时选定策略）。
