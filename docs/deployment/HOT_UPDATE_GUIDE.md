# é²¸è½é¡¹ç›®çƒ­æ›´æ–°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

çƒ­æ›´æ–°è„šæœ¬ `quick-update-prod-flask.sh` ä¸“é—¨ç”¨äºå¿«é€Ÿæ›´æ–°Flaskåº”ç”¨ä»£ç ï¼Œæ— éœ€é‡å»ºå®¹å™¨ï¼Œä¿ç•™æ‰€æœ‰æ•°æ®ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹ç‚¹

- **ä»£ç çƒ­æ›´æ–°** - ç›´æ¥æ‹·è´ä»£ç åˆ°è¿è¡Œä¸­çš„å®¹å™¨
- **æœ€å°åœæœºæ—¶é—´** - ä»…éœ€30-60ç§’é‡å¯æ—¶é—´
- **æ•°æ®å®Œå…¨ä¿ç•™** - ä¸é‡å»ºå®¹å™¨ï¼Œä¿ç•™æ‰€æœ‰æ•°æ®
- **è‡ªåŠ¨éªŒè¯** - æ›´æ–°åè‡ªåŠ¨éªŒè¯æœåŠ¡çŠ¶æ€
- **æ™ºèƒ½æ£€æŸ¥** - æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€

## ğŸ“ æ–‡ä»¶ä½ç½®

```
scripts/deployment/quick-update-prod-flask.sh
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/WhaleFall

# æ‰§è¡Œçƒ­æ›´æ–°
./scripts/deployment/quick-update-prod-flask.sh
```

### 2. ä½¿ç”¨å‰å‡†å¤‡

ç¡®ä¿ä»¥ä¸‹æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
- âœ… Flaskå®¹å™¨ (`whalefall`)
- âœ… PostgreSQLæ•°æ®åº“
- âœ… Redisç¼“å­˜

### 3. æ›´æ–°æµç¨‹

è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **æ£€æŸ¥ç³»ç»Ÿè¦æ±‚** - éªŒè¯Dockerå’ŒDocker Compose
2. **æ£€æŸ¥æœåŠ¡çŠ¶æ€** - ç¡®ä¿Flaskå®¹å™¨æ­£åœ¨è¿è¡Œ
3. **æ‹‰å–æœ€æ–°ä»£ç ** - ä»Gitä»“åº“æ‹‰å–æœ€æ–°ä»£ç 
4. **æ‹·è´ä»£ç åˆ°å®¹å™¨** - å°†æ–°ä»£ç æ‹·è´åˆ°è¿è¡Œä¸­çš„å®¹å™¨
5. **é‡å¯FlaskæœåŠ¡** - é‡å¯å®¹å™¨ä»¥åŠ è½½æ–°ä»£ç 
6. **ç­‰å¾…æœåŠ¡å°±ç»ª** - ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
7. **éªŒè¯æ›´æ–°** - æ‰§è¡Œå¥åº·æ£€æŸ¥éªŒè¯æ›´æ–°æˆåŠŸ

## ğŸ“Š æ›´æ–°å†…å®¹

è„šæœ¬ä¼šæ›´æ–°ä»¥ä¸‹æ–‡ä»¶å’Œç›®å½•ï¼š

```
app/                    # åº”ç”¨ä»£ç ï¼ˆåŒ…æ‹¬è·¯ç”±ã€æ¨¡å‹ã€æ¨¡æ¿ã€é™æ€èµ„æºç­‰ï¼‰
migrations/            # æ•°æ®åº“è¿ç§»
sql/                   # SQLè„šæœ¬
docs/                  # æ–‡æ¡£
tests/                 # æµ‹è¯•æ–‡ä»¶
scripts/               # è„šæœ¬æ–‡ä»¶
*.py                   # Pythonæ–‡ä»¶
*.md                   # Markdownæ–‡ä»¶
*.txt                  # æ–‡æœ¬æ–‡ä»¶
*.toml                 # é…ç½®æ–‡ä»¶
*.yml                  # YAMLé…ç½®
*.yaml                 # YAMLé…ç½®
*.sh                   # Shellè„šæœ¬
*.ini                  # INIé…ç½®
*.lock                 # é”å®šæ–‡ä»¶
```

### å¸¸è§æ›´æ–°åœºæ™¯

#### 1. å‰ç«¯èµ„æºæ›´æ–°ï¼ˆæ¨¡æ¿ã€JSã€CSSï¼‰

å½“æ›´æ–°å‰ç«¯èµ„æºæ—¶ï¼Œçƒ­æ›´æ–°ä¼šè‡ªåŠ¨åŒæ­¥ï¼š

```bash
# æ›´æ–°çš„æ–‡ä»¶ç¤ºä¾‹
app/templates/admin/partitions/index.html
app/templates/admin/partitions/charts/partitions-charts.html
app/static/js/modules/views/admin/partitions/index.js
app/static/css/pages/admin/partitions.css
```

**æ³¨æ„**ï¼šå‰ç«¯èµ„æºæ›´æ–°åï¼Œç”¨æˆ·éœ€è¦åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+F5 å¼ºåˆ¶åˆ·æ–°ï¼‰æ‰èƒ½çœ‹åˆ°æœ€æ–°æ•ˆæœã€‚

#### 2. åç«¯ä»£ç æ›´æ–°ï¼ˆè·¯ç”±ã€æ¨¡å‹ã€æœåŠ¡ï¼‰

åç«¯ä»£ç æ›´æ–°ä¼šåœ¨å®¹å™¨é‡å¯åç«‹å³ç”Ÿæ•ˆï¼š

```bash
# æ›´æ–°çš„æ–‡ä»¶ç¤ºä¾‹
app/routes/partition.py
app/models/user.py
app/services/partition_management_service.py
```

**æ³¨æ„**ï¼šå¦‚æœä¿®æ”¹äº†æ¨¡å‹å­—æ®µï¼Œå¯èƒ½éœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚

#### 3. æ•°æ®åº“è¿ç§»æ›´æ–°

å¦‚æœæ›´æ–°åŒ…å«æ•°æ®åº“ç»“æ„å˜æ›´ï¼Œéœ€è¦é¢å¤–æ‰§è¡Œè¿ç§»ï¼š

```bash
# çƒ­æ›´æ–°åæ‰§è¡Œè¿ç§»
docker exec whalefall_app_prod flask db upgrade
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### å‰ç½®æ¡ä»¶

1. **Flaskå®¹å™¨å¿…é¡»è¿è¡Œ** - å¦‚æœå®¹å™¨æœªè¿è¡Œï¼Œè„šæœ¬ä¼šæŠ¥é”™é€€å‡º
2. **ä¾èµ–æœåŠ¡å¿…é¡»è¿è¡Œ** - PostgreSQLå’ŒRediså¿…é¡»æ­£å¸¸è¿è¡Œ
3. **Gitä»“åº“çŠ¶æ€** - å½“å‰ç›®å½•å¿…é¡»æ˜¯Gitä»“åº“
4. **ç¯å¢ƒå˜é‡é…ç½®** - ç¡®ä¿`.env`æ–‡ä»¶å­˜åœ¨ä¸”é…ç½®æ­£ç¡®

### é™åˆ¶è¯´æ˜

1. **ä¸æ›´æ–°ç³»ç»Ÿä¾èµ–** - ä»…æ›´æ–°åº”ç”¨ä»£ç ï¼Œä¸æ›´æ–°PythonåŒ…
2. **ä¸æ›´æ–°æ•°æ®åº“ç»“æ„** - å¦‚éœ€æ•°æ®åº“è¿ç§»ï¼Œéœ€å•ç‹¬æ‰§è¡Œ
3. **ä¸æ›´æ–°é…ç½®æ–‡ä»¶** - å®¹å™¨å†…é…ç½®æ–‡ä»¶ä¸ä¼šæ›´æ–°
4. **ä¸æ›´æ–°Dockeré•œåƒ** - ä½¿ç”¨ç°æœ‰é•œåƒï¼Œä¸é‡æ–°æ„å»º

### æµè§ˆå™¨ç¼“å­˜é—®é¢˜

æ›´æ–°å‰ç«¯èµ„æºï¼ˆHTMLã€JSã€CSSï¼‰åï¼Œç”¨æˆ·å¯èƒ½çœ‹ä¸åˆ°æœ€æ–°æ•ˆæœï¼Œéœ€è¦ï¼š

1. **å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨** - æŒ‰ `Ctrl+F5`ï¼ˆWindows/Linuxï¼‰æˆ– `Cmd+Shift+R`ï¼ˆMacï¼‰
2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜** - åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ¸…é™¤ç¼“å­˜
3. **ä½¿ç”¨éšç§æ¨¡å¼** - åœ¨éšç§/æ— ç—•æ¨¡å¼ä¸‹æµ‹è¯•æ–°åŠŸèƒ½

### æ•°æ®æ¨¡å‹å˜æ›´

å¦‚æœæ›´æ–°æ¶‰åŠæ•°æ®æ¨¡å‹å˜æ›´ï¼ˆå¦‚ `app/models/user.py`ï¼‰ï¼Œéœ€è¦æ³¨æ„ï¼š

1. **å­—æ®µæ·»åŠ ** - é€šå¸¸å®‰å…¨ï¼Œä½†éœ€è¦è®¾ç½®é»˜è®¤å€¼
2. **å­—æ®µåˆ é™¤** - éœ€è¦å…ˆæ‰§è¡Œæ•°æ®åº“è¿ç§»
3. **å­—æ®µç±»å‹å˜æ›´** - éœ€è¦æ•°æ®è¿ç§»è„šæœ¬
4. **å…³ç³»å˜æ›´** - å¯èƒ½å½±å“ç°æœ‰æ•°æ®ï¼Œéœ€è¦è°¨æ…æµ‹è¯•

**ç¤ºä¾‹**ï¼šæœ¬æ¬¡æ›´æ–°ä¿®æ”¹äº† `User.to_dict()` æ–¹æ³•ï¼Œå°† `created_at` æ ¼å¼ä»å®Œæ•´æ—¶é—´æˆ³æ”¹ä¸ºä»…æ—¥æœŸï¼Œè¿™æ˜¯å®‰å…¨çš„æ›´æ–°ï¼Œä¸å½±å“æ•°æ®åº“ç»“æ„ã€‚

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Flaskå®¹å™¨æœªè¿è¡Œ

```bash
# é”™è¯¯ä¿¡æ¯
Flaskå®¹å™¨æœªè¿è¡Œ: Exited (1) 2 hours ago

# è§£å†³æ–¹æ¡ˆ
# å…ˆå¯åŠ¨Flaskå®¹å™¨
docker compose -f docker-compose.prod.yml up -d whalefall
```

#### 2. ä»£ç æ‹·è´å¤±è´¥

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker compose -f docker-compose.prod.yml ps whalefall

# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker compose -f docker-compose.prod.yml logs whalefall
```

#### 3. å¥åº·æ£€æŸ¥å¤±è´¥

```bash
# æ‰‹åŠ¨æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:5001/health/api/basic

# æ£€æŸ¥åº”ç”¨æ—¥å¿—
docker compose -f docker-compose.prod.yml logs whalefall --tail 50
```

### æ‰‹åŠ¨å›æ»š

å¦‚æœæ›´æ–°åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨å›æ»šï¼š

```bash
# 1. åœæ­¢å½“å‰å®¹å™¨
docker compose -f docker-compose.prod.yml stop whalefall

# 2. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git reset --hard HEAD~1

# 3. é‡æ–°æ‹·è´ä»£ç 
./scripts/deployment/quick-update-prod-flask.sh
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ›´æ–°é¢‘ç‡å»ºè®®

- **å¼€å‘ç¯å¢ƒ** - å¯ä»¥é¢‘ç¹æ›´æ–°
- **æµ‹è¯•ç¯å¢ƒ** - å»ºè®®æ¯æ—¥æ›´æ–°
- **ç”Ÿäº§ç¯å¢ƒ** - å»ºè®®åœ¨ç»´æŠ¤çª—å£æ›´æ–°

### ç›‘æ§å»ºè®®

æ›´æ–°åå»ºè®®ç›‘æ§ï¼š

```bash
# æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
docker stats whalefall_app_prod

# æ£€æŸ¥åº”ç”¨æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f whalefall

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:5001/health/api/basic
```

### æ›´æ–°åéªŒè¯æ¸…å•

å®Œæˆçƒ­æ›´æ–°åï¼Œå»ºè®®æ‰§è¡Œä»¥ä¸‹éªŒè¯ï¼š

- [ ] è®¿é—®ä¸»é¡µï¼Œç¡®è®¤åº”ç”¨æ­£å¸¸å“åº”
- [ ] æµ‹è¯•ç™»å½•åŠŸèƒ½
- [ ] æ£€æŸ¥æ›´æ–°çš„é¡µé¢/åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- [ ] æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œç¡®è®¤æ— é”™è¯¯
- [ ] æµ‹è¯•å…³é”®ä¸šåŠ¡æµç¨‹
- [ ] å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ï¼Œç¡®è®¤å‰ç«¯èµ„æºå·²æ›´æ–°

**æœ¬æ¬¡æ›´æ–°éªŒè¯ç¤ºä¾‹**ï¼š
```bash
# 1. è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢
curl -I http://localhost:5001/users/

# 2. æ£€æŸ¥åˆ›å»ºæ—¶é—´æ ¼å¼ï¼ˆåº”ä¸º YYYY-MM-DDï¼‰
# ç™»å½•åè®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢ï¼ŒæŸ¥çœ‹åˆ›å»ºæ—¶é—´åˆ—

# 3. è®¿é—®åˆ†åŒºç®¡ç†é¡µé¢
curl -I http://localhost:5001/partition/

# 4. æ£€æŸ¥ç»Ÿè®¡å¡ç‰‡å’Œå›¾è¡¨æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
# ç™»å½•åè®¿é—®åˆ†åŒºç®¡ç†é¡µé¢ï¼Œç¡®è®¤å¡ç‰‡å’Œå›¾è¡¨æ­£å¸¸
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰æ›´æ–°å†…å®¹

å¦‚æœéœ€è¦åªæ›´æ–°ç‰¹å®šæ–‡ä»¶ï¼Œå¯ä»¥ä¿®æ”¹è„šæœ¬ä¸­çš„æ‹·è´éƒ¨åˆ†ï¼š

```bash
# åªæ›´æ–°åº”ç”¨ä»£ç 
cp -r app "$temp_dir/"

# åªæ›´æ–°ç‰¹å®šæ–‡ä»¶
cp app/routes/auth.py "$temp_dir/app/routes/"
```

### 2. æ›´æ–°å‰å¤‡ä»½

å»ºè®®åœ¨æ›´æ–°å‰å¤‡ä»½é‡è¦æ•°æ®ï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
docker exec postgres pg_dump -U postgres whalefall_prod > backup_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½åº”ç”¨ä»£ç 
tar -czf app_backup_$(date +%Y%m%d_%H%M%S).tar.gz app/
```

### 3. æ‰¹é‡æ›´æ–°

å¯ä»¥åˆ›å»ºæ‰¹é‡æ›´æ–°è„šæœ¬ï¼š

```bash
#!/bin/bash
# æ‰¹é‡æ›´æ–°å¤šä¸ªç¯å¢ƒ

environments=("dev" "test" "prod")
for env in "${environments[@]}"; do
    echo "æ›´æ–° $env ç¯å¢ƒ..."
    cd "/path/to/$env/WhaleFall"
    ./scripts/deployment/quick-update-prod-flask.sh
done
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥å®¹å™¨çŠ¶æ€å’Œæ—¥å¿—
2. éªŒè¯ç½‘ç»œè¿æ¥
3. ç¡®è®¤æ–‡ä»¶æƒé™
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**æ³¨æ„**: æœ¬è„šæœ¬ä¸“ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡ï¼Œä½¿ç”¨å‰è¯·ç¡®ä¿å……åˆ†æµ‹è¯•ã€‚
