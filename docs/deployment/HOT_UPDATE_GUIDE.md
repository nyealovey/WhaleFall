# é²¸è½é¡¹ç›®çƒ­æ›´æ–°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

çƒ­æ›´æ–°è„šæœ¬ `quick-update-prod-flask.sh` ä¸“é—¨ç”¨äºå¿«é€Ÿæ›´æ–°Flaskåº”ç”¨ä»£ç ï¼Œæ— éœ€é‡å»ºå®¹å™¨ï¼Œä¿ç•™æ‰€æœ‰æ•°æ®ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹ç‚¹

- **ä»£ç çƒ­æ›´æ–°** - ç›´æ¥æ‹·è´ä»£ç åˆ°è¿è¡Œä¸­çš„å®¹å™¨
- **æœ€å°åœæœºæ—¶é—´** - ä»…éœ€30-60ç§’é‡å¯æ—¶é—´
- **æ•°æ®å®Œå…¨ä¿ç•™** - ä¸é‡å»ºå®¹å™¨ï¼Œä¿ç•™æ‰€æœ‰æ•°æ®
- **è‡ªåŠ¨éªŒè¯** - æ›´æ–°åè‡ªåŠ¨éªŒè¯æœåŠ¡çŠ¶æ€
- **æ™ºèƒ½æ£€æŸ¥** - æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€

## ğŸ“ æ–‡ä»¶ä½ç½®

```
scripts/deployment/quick-update-prod-flask.sh
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/TaifishV4

# æ‰§è¡Œçƒ­æ›´æ–°
./scripts/deployment/quick-update-prod-flask.sh
```

### 2. ä½¿ç”¨å‰å‡†å¤‡

ç¡®ä¿ä»¥ä¸‹æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
- âœ… Flaskå®¹å™¨ (`whalefall`)
- âœ… PostgreSQLæ•°æ®åº“
- âœ… Redisç¼“å­˜

### 3. æ›´æ–°æµç¨‹

è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **æ£€æŸ¥ç³»ç»Ÿè¦æ±‚** - éªŒè¯Dockerå’ŒDocker Compose
2. **æ£€æŸ¥æœåŠ¡çŠ¶æ€** - ç¡®ä¿Flaskå®¹å™¨æ­£åœ¨è¿è¡Œ
3. **æ‹‰å–æœ€æ–°ä»£ç ** - ä»Gitä»“åº“æ‹‰å–æœ€æ–°ä»£ç 
4. **æ‹·è´ä»£ç åˆ°å®¹å™¨** - å°†æ–°ä»£ç æ‹·è´åˆ°è¿è¡Œä¸­çš„å®¹å™¨
5. **é‡å¯FlaskæœåŠ¡** - é‡å¯å®¹å™¨ä»¥åŠ è½½æ–°ä»£ç 
6. **ç­‰å¾…æœåŠ¡å°±ç»ª** - ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
7. **éªŒè¯æ›´æ–°** - æ‰§è¡Œå¥åº·æ£€æŸ¥éªŒè¯æ›´æ–°æˆåŠŸ

## ğŸ“Š æ›´æ–°å†…å®¹

è„šæœ¬ä¼šæ›´æ–°ä»¥ä¸‹æ–‡ä»¶å’Œç›®å½•ï¼š

```
app/                    # åº”ç”¨ä»£ç 
migrations/            # æ•°æ®åº“è¿ç§»
sql/                   # SQLè„šæœ¬
docs/                  # æ–‡æ¡£
tests/                 # æµ‹è¯•æ–‡ä»¶
scripts/               # è„šæœ¬æ–‡ä»¶
*.py                   # Pythonæ–‡ä»¶
*.md                   # Markdownæ–‡ä»¶
*.txt                  # æ–‡æœ¬æ–‡ä»¶
*.toml                 # é…ç½®æ–‡ä»¶
*.yml                  # YAMLé…ç½®
*.yaml                 # YAMLé…ç½®
*.sh                   # Shellè„šæœ¬
*.ini                  # INIé…ç½®
*.lock                 # é”å®šæ–‡ä»¶
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### å‰ç½®æ¡ä»¶

1. **Flaskå®¹å™¨å¿…é¡»è¿è¡Œ** - å¦‚æœå®¹å™¨æœªè¿è¡Œï¼Œè„šæœ¬ä¼šæŠ¥é”™é€€å‡º
2. **ä¾èµ–æœåŠ¡å¿…é¡»è¿è¡Œ** - PostgreSQLå’ŒRediså¿…é¡»æ­£å¸¸è¿è¡Œ
3. **Gitä»“åº“çŠ¶æ€** - å½“å‰ç›®å½•å¿…é¡»æ˜¯Gitä»“åº“
4. **ç¯å¢ƒå˜é‡é…ç½®** - ç¡®ä¿`.env`æ–‡ä»¶å­˜åœ¨ä¸”é…ç½®æ­£ç¡®

### é™åˆ¶è¯´æ˜

1. **ä¸æ›´æ–°ç³»ç»Ÿä¾èµ–** - ä»…æ›´æ–°åº”ç”¨ä»£ç ï¼Œä¸æ›´æ–°PythonåŒ…
2. **ä¸æ›´æ–°æ•°æ®åº“ç»“æ„** - å¦‚éœ€æ•°æ®åº“è¿ç§»ï¼Œéœ€å•ç‹¬æ‰§è¡Œ
3. **ä¸æ›´æ–°é…ç½®æ–‡ä»¶** - å®¹å™¨å†…é…ç½®æ–‡ä»¶ä¸ä¼šæ›´æ–°
4. **ä¸æ›´æ–°Dockeré•œåƒ** - ä½¿ç”¨ç°æœ‰é•œåƒï¼Œä¸é‡æ–°æ„å»º

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Flaskå®¹å™¨æœªè¿è¡Œ

```bash
# é”™è¯¯ä¿¡æ¯
Flaskå®¹å™¨æœªè¿è¡Œ: Exited (1) 2 hours ago

# è§£å†³æ–¹æ¡ˆ
# å…ˆå¯åŠ¨Flaskå®¹å™¨
docker compose -f docker-compose.prod.yml up -d whalefall
```

#### 2. ä»£ç æ‹·è´å¤±è´¥

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker compose -f docker-compose.prod.yml ps whalefall

# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker compose -f docker-compose.prod.yml logs whalefall
```

#### 3. å¥åº·æ£€æŸ¥å¤±è´¥

```bash
# æ‰‹åŠ¨æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:5001/health

# æ£€æŸ¥åº”ç”¨æ—¥å¿—
docker compose -f docker-compose.prod.yml logs whalefall --tail 50
```

### æ‰‹åŠ¨å›æ»š

å¦‚æœæ›´æ–°åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨å›æ»šï¼š

```bash
# 1. åœæ­¢å½“å‰å®¹å™¨
docker compose -f docker-compose.prod.yml stop whalefall

# 2. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git reset --hard HEAD~1

# 3. é‡æ–°æ‹·è´ä»£ç 
./scripts/deployment/quick-update-prod-flask.sh
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ›´æ–°é¢‘ç‡å»ºè®®

- **å¼€å‘ç¯å¢ƒ** - å¯ä»¥é¢‘ç¹æ›´æ–°
- **æµ‹è¯•ç¯å¢ƒ** - å»ºè®®æ¯æ—¥æ›´æ–°
- **ç”Ÿäº§ç¯å¢ƒ** - å»ºè®®åœ¨ç»´æŠ¤çª—å£æ›´æ–°

### ç›‘æ§å»ºè®®

æ›´æ–°åå»ºè®®ç›‘æ§ï¼š

```bash
# æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
docker stats whalefall_app_prod

# æ£€æŸ¥åº”ç”¨æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f whalefall

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:5001/health
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰æ›´æ–°å†…å®¹

å¦‚æœéœ€è¦åªæ›´æ–°ç‰¹å®šæ–‡ä»¶ï¼Œå¯ä»¥ä¿®æ”¹è„šæœ¬ä¸­çš„æ‹·è´éƒ¨åˆ†ï¼š

```bash
# åªæ›´æ–°åº”ç”¨ä»£ç 
cp -r app "$temp_dir/"

# åªæ›´æ–°ç‰¹å®šæ–‡ä»¶
cp app/routes/auth.py "$temp_dir/app/routes/"
```

### 2. æ›´æ–°å‰å¤‡ä»½

å»ºè®®åœ¨æ›´æ–°å‰å¤‡ä»½é‡è¦æ•°æ®ï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
docker exec postgres pg_dump -U postgres taifish > backup_$(date +%Y%m%d_%H%M%S).sql

# å¤‡ä»½åº”ç”¨ä»£ç 
tar -czf app_backup_$(date +%Y%m%d_%H%M%S).tar.gz app/
```

### 3. æ‰¹é‡æ›´æ–°

å¯ä»¥åˆ›å»ºæ‰¹é‡æ›´æ–°è„šæœ¬ï¼š

```bash
#!/bin/bash
# æ‰¹é‡æ›´æ–°å¤šä¸ªç¯å¢ƒ

environments=("dev" "test" "prod")
for env in "${environments[@]}"; do
    echo "æ›´æ–° $env ç¯å¢ƒ..."
    cd "/path/to/$env/TaifishV4"
    ./scripts/deployment/quick-update-prod-flask.sh
done
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥å®¹å™¨çŠ¶æ€å’Œæ—¥å¿—
2. éªŒè¯ç½‘ç»œè¿æ¥
3. ç¡®è®¤æ–‡ä»¶æƒé™
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**æ³¨æ„**: æœ¬è„šæœ¬ä¸“ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡ï¼Œä½¿ç”¨å‰è¯·ç¡®ä¿å……åˆ†æµ‹è¯•ã€‚
