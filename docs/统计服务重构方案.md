# 统计服务重构方案

## 1. 背景
- 账户统计逻辑已经抽离为独立服务 `app/services/statistics/account_statistics_service.py`，提供 `fetch_summary`、`fetch_db_type_stats`、`fetch_classification_stats`、`build_aggregated_statistics` 等接口，可被页面、API 与脚本重复调用。
- 数据库与实例统计仍散落在多个路由（例如 `app/routes/dashboard.py`、`app/routes/instance_statistics.py`、`app/routes/account_stat.py`），导致：
  - 统计逻辑重复且难以单元测试；
  - 大量数据处理写在蓝图中，影响可读性；
  - 需要在多个地方同步更新“总数=活跃+已删除、活跃=正常+禁用/锁定”这套规则，风险高。
- 目标：参考账户统计服务的组织方式，在 `app/services/statistics/` 下新增“数据库统计服务”“实例统计服务”，并将相关路由中的统计逻辑迁移至这些服务，统一数据口径。

## 2. 现状盘点
- **账户统计服务**（`app/services/statistics/account_statistics_service.py`）：
  - 结构清晰：同一文件内封装私有工具方法、汇总函数及空数据构造函数；
  - 接口关注点薄：路由只负责参数解析与渲染；
  - 已实现最新的数据口径（总数、活跃、锁定、已删除、正常等）。
- **数据库/实例统计**：
  - `app/routes/dashboard.py` 中混杂大量逻辑（实例总量、活跃、禁用、已删除、容量查询等）；
  - `app/routes/instance_statistics.py` 提供实例统计 API，但依赖 ORM 直接查询；
  - 任何新指标都需要修改多个路由文件，没有公共服务层。

## 3. 重构目标
1. 创建 `app/services/statistics/database_statistics_service.py`、`app/services/statistics/instance_statistics_service.py`。
2. 复用账户统计服务的设计，提供 `fetch_summary`/`build_aggregated_statistics`/`empty_statistics` 等公共函数。
3. 将 `dashboard`、`instance_statistics` 等蓝图内的数据统计语句迁移到对应服务，并保持对外接口不变。
4. 落库统一统计口径：
   - **数据库统计**：`total = active + inactive`，其中 `active = normal + disabled`（若有停用字段），`inactive` 包含软删除/未激活；
   - **实例统计**：`total = active + deleted`，`active = normal + disabled`，细分字段由服务提供。
5. 保持 `app/services/statistics/account_statistics_service.py` 为参考，实现编码规范、日志与异常处理的一致性。

## 4. 实施步骤
1. **创建目录与骨架**
   - 在 `app/services/statistics/` 下新增 `database_statistics_service.py`、`instance_statistics_service.py`；
   - 复制账户统计服务的文档字符串/异常处理模式，保留 `SystemError` 与 `log_error` 日志。
2. **梳理路由依赖**
   - 统计 `app/routes/dashboard.py`、`app/routes/instance_statistics.py`、`app/routes/account_stat.py` 中的统计查询；
   - 记录所需模型（`InstanceDatabase`、`InstanceSizeStat` 等）与字段。
3. **迁移逻辑**
   - 先把路由中的查询复制到新服务，确保与当前输出一致；
   - 写出公共方法：如 `fetch_database_summary`, `fetch_instance_summary`, `build_aggregated_statistics`；
   - 路由调用服务方法，仅负责参数解析与响应构造。
4. **统一数据口径**
   - 落实“总数=活跃+已删除（或停用）”、“活跃=正常+禁用”，沿用账户统计服务里的同名字段；
   - 在新服务中返回 `total_*`, `active_*`, `normal_*`, `locked_*`, `deleted_*` 等键，供前端渲染。
5. **清理与校验**
   - 删除路由中遗留的统计函数；
   - 补充/更新现有文档（如本方案、对应 README 或模块说明）；
   - 手动验证 `/dashboard/`、`/account_stat/statistics`、`/instance_statistics` 等页面数据一致。

## 5. 附件与参考
- 账户统计服务示例：`app/services/statistics/account_statistics_service.py`
- 需迁移的主要路由：
  - `app/routes/dashboard.py`（系统概览、图表、状态）
  - `app/routes/instance_statistics.py`（实例统计 API）
  - `app/routes/account_stat.py`（现已基于服务，可复用模式）

通过本次重构，统计逻辑将集中在 `app/services/statistics/` 中，路由层更轻、更易维护，后续增删指标只需改动服务即可。
