# 账户分类统计（每日趋势）页面设计稿

> 日期：2026-01-19  
> 背景：为“自动分类”补齐**每日留痕**与**趋势分析**能力，支持按「分类 / 规则 / db_type / instance」组合查询与展示。

## 1. 目标与非目标

### 目标
- 在导航栏「数据统计」中新增页面入口：**账户分类统计**。
- 默认展示：某一分类在一段时间内的**去重账号数趋势**（分类维度）。
- 支持 drill-down：
  - 选择规则后，展示该规则的**命中账号数趋势**（规则维度，规则内账号天然去重）。
  - 未选择规则时，展示**规则贡献柱状图**（Top 规则，当前周期内各规则命中账号数）。
- 时间范围与周期与现有模块对齐：**日 / 周 / 月 / 季 / 年**。
  - 由于现有容量统计尚未支持“年统计周期”，本页面先将“年统计”在 UI 中**置灰并提示即将支持**。

### 非目标（本阶段不做）
- 不在该页面提供“手动触发统计”按钮（避免与定时任务概念混淆）。
- 不做跨分类对比（一次只看一个分类，避免视觉噪声与口径混乱）。

## 2. 口径与周期定义（必须与后端/数据对齐）

### 统计口径
- **分类趋势（去重账号数）**：当日命中该分类任意规则的账号去重数（同一分类下多规则命中同一账号只算 1 次）。
- **规则趋势（命中账号数）**：当日评估命中该规则的账号数（同一规则下账号天然去重）。
- **规则贡献（当前周期 Top 规则）**：当前周期内每条规则的命中账号数（规则内去重；规则之间允许重叠，因此“各规则之和”不等于分类去重总数）。

### 周期定义（与现有周期工具对齐）
- 时区：`Asia/Shanghai`（日期切分与调度一致）。
- 自然周：周一到周日（Mon–Sun）。
- 自然月：1 号到月末。
- 自然季：Q1=1-3，Q2=4-6，Q3=7-9，Q4=10-12。
- 自然年：1/1–12/31（本页面先置灰，后续放开）。

### 非日周期聚合（你确认：A + 缺失策略 B）
- 当 `period_type != daily` 时，趋势图以**均值**展示：
  - `avg = SUM(周期内每日值) / 覆盖天数`
  - 覆盖天数：该周期内实际存在数据的天数（缺失天不计入分母）。
  - UI 必须展示 `覆盖 X / Y 天`（Y=应有天数）。
- Tooltip 建议同时展示：`均值 / 累计 / 覆盖 X/Y`。

## 3. 页面入口、路由与 URL 参数

### 入口
- 顶部导航栏 → 「数据统计」下新增：**账户分类统计**。

### 建议路由
- 页面路由（示例）：`/accounts/statistics/classifications`（具体实现可根据现有 blueprint 约束微调）。

### URL 参数（用于可复现）
- `classification_id`：必选
- `period_type`：`daily|weekly|monthly|quarterly|yearly(置灰)`
- `periods`：回溯周期数量（如 7/14/30）
- `db_type`：可选
- `instance_id`：可选
- `rule_id`：可选（存在则右下展示规则趋势；不存在则右下展示规则贡献柱状图）

## 4. 页面布局（你确认：双栏分析视图）

### 顶部区域
- `page_header`：
  - 标题：账户分类统计
  - 说明：强调“按日记录，可按周期聚合（周/月/季=均值）”
  - 操作：仅保留「刷新」
- `Filter Card`：
  - 账户分类（必选；展示 `display_name`，可辅助展示 `code`）
  - 统计周期（日/周/月/季/年；年置灰并提示即将支持）
  - 数据库类型（可选）
  - 实例（可选；未选 db_type 时置灰）
  - 最近 N 个周期（chip：7/14/30，文案随周期变化：最近 7 天/7 周/7 月/7 季）

### 主体双栏
- 左栏（规则列表，约 30%）：
  - 搜索框（按规则名/备注前端过滤）
  - 状态筛选（建议）：全部/启用/已归档（默认启用）
  - 默认排序：**按近 7 天累计命中降序**（你确认：A）
  - 列表项：规则名 + db_type 标签 + `rule_id`/`v{version}` + 状态 pill + 近 7 天累计命中数
- 右栏（图表区，约 70%）：
  - 上：分类趋势（去重账号数）
  - 下：
    - 未选规则：规则贡献柱状图（Top 规则，当前周期）
    - 已选规则：该规则趋势（命中账号数）

## 5. 图表呈现细节

### 分类趋势（上图）
- 默认折线图；日显示整数；非日显示 1 位小数并标注“均值”。
- 右上角显示覆盖：`覆盖 X/Y 天`。
- Tooltip：`均值 / 累计 / 覆盖`（非日周期）。

### 规则贡献（未选规则时，下图）
- 柱状图，默认展示 TopN（建议 10，可后续再加切换）。
- “当前周期”定义：**取上方趋势图最后一个点对应的周期**（你认可）。
- 数值口径：
  - `daily`：使用当日该规则命中账号数
  - `weekly/monthly/quarterly`：使用“当前周期内每日命中账号数的均值”（缺失天不计入分母），并在 tooltip 中展示累计与覆盖
- 图下注明：规则之间可能重叠，“各规则之和”不等于分类去重总数。

### 规则趋势（选中规则时，下图）
- 折线图；口径为该规则的命中账号数。
- 标题显示：规则名 + `rule_id` + `v{version}`（如可得）。
- 右上角覆盖同上。

## 6. 状态与空数据
- 未选分类：主区域展示空状态，引导选择分类。
- 已选分类但无数据：提示“暂无统计数据（覆盖 0/Y 天）”，并建议检查定时任务是否运行。
- 已选分类但无规则：提示“该分类暂无规则，可前往账户分类管理新增”。

## 7. 后端接口/数据要求（用于实现对齐）

> 该页面建议通过 API 拉取数据（避免服务端渲染携带大量趋势数据）。

### 分类趋势接口（建议）
- 输入：`classification_id, period_type, periods, db_type?, instance_id?`
- 输出：`[{ period_start, period_end, value_avg, value_sum, coverage_days, expected_days }]`

### 规则贡献接口（建议）
- 输入：`classification_id, period_type, db_type?, instance_id?`（period_type 可为日/周/月/季；年置灰不调用）
- 输出：`[{ rule_id, rule_name, value }]`（value=当前周期内该规则命中账号数；可同时返回 `db_type`/`version` 等展示字段）

### 单规则趋势接口（建议）
- 输入：`rule_id, period_type, periods, db_type?, instance_id?`
- 输出同“分类趋势”，但 value 对应规则命中账号数

## 8. 验收清单（UI）
- 导航栏入口可用，页面可访问。
- 分类为必选；筛选联动正确（db_type → instance 置灰/启用）。
- 上图始终展示分类去重趋势；非日周期展示均值并显示覆盖。
- 未选规则时，下图展示规则贡献柱状图（当前周期=上图最后一个点）。
- 选中规则后，下图切换为规则趋势；URL 可复现（带 rule_id）。
