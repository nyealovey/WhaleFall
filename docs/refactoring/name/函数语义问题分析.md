# å‡½æ•°åç§°ä¸åŠŸèƒ½è¯­ä¹‰é—®é¢˜åˆ†æ

> æ£€æŸ¥å‡½æ•°åç§°æ˜¯å¦å‡†ç¡®åæ˜ å…¶å®é™…åŠŸèƒ½
> 
> ç”Ÿæˆæ—¶é—´: 2025-11-12

## ğŸ” åˆ†ææ–¹æ³•

æ£€æŸ¥ä»¥ä¸‹å‡ ç§å¸¸è§çš„å‘½åé—®é¢˜ï¼š
1. **å‡½æ•°åä¸å®é™…åŠŸèƒ½ä¸ç¬¦**
2. **å‘½åä¸ä¸€è‡´**ï¼ˆåŒä¸€åŠŸèƒ½ä½¿ç”¨ä¸åŒåç§°ï¼‰
3. **å‘½åæ¨¡ç³Š**ï¼ˆæ— æ³•ä»åç§°åˆ¤æ–­åŠŸèƒ½ï¼‰
4. **å‘½åå†—ä½™**ï¼ˆåŒ…å«ä¸å¿…è¦çš„ä¿¡æ¯ï¼‰

---

## ğŸ“‹ å‘ç°çš„é—®é¢˜

### 1. å‘½åä¸ä¸€è‡´é—®é¢˜

#### é—®é¢˜ 1.1: statistics vs stats æ··ç”¨

**ä½ç½®**: `app/routes/account_stat.py`

```python
# ä¸ä¸€è‡´ï¼šåŒæ—¶ä½¿ç”¨ statistics å’Œ stats
def statistics_api()                    # ä½¿ç”¨å®Œæ•´å•è¯
def statistics_summary_api()            # ä½¿ç”¨å®Œæ•´å•è¯
def statistics_db_type_api()            # ä½¿ç”¨å®Œæ•´å•è¯
def statistics_classification_api()     # ä½¿ç”¨å®Œæ•´å•è¯

# ä½†åœ¨å‡½æ•°å†…éƒ¨å’Œå…¶ä»–åœ°æ–¹ä½¿ç”¨ stats
stats = fetch_db_type_stats()           # ä½¿ç”¨ç¼©å†™
stats = fetch_classification_stats()    # ä½¿ç”¨ç¼©å†™
```

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `statistics`ï¼ˆå®Œæ•´å•è¯ï¼‰

```python
# æ¨èï¼šç»Ÿä¸€å‘½å
def get_statistics()                    # æˆ– get_account_statistics()
def get_statistics_summary()
def get_statistics_by_db_type()
def get_statistics_by_classification()

# æœåŠ¡å±‚ä¹Ÿç»Ÿä¸€
fetch_db_type_statistics()              # è€Œé fetch_db_type_stats()
fetch_classification_statistics()       # è€Œé fetch_classification_stats()
```

#### é—®é¢˜ 1.2: aggregations vs aggregation æ··ç”¨

**ä½ç½®**: å¤šä¸ªæ–‡ä»¶

```python
# è·¯ç”±æ–‡ä»¶å
database_aggr.py                        # ä½¿ç”¨ç¼©å†™
instance_aggr.py                        # ä½¿ç”¨ç¼©å†™

# å‡½æ•°å
def database_aggregations()             # å¤æ•°
def instance_aggregations()             # å¤æ•°
def get_instances_aggregations()        # é”™è¯¯ï¼šåŒé‡å¤æ•°
def aggregate_current()                 # åŠ¨è¯å½¢å¼
```

**å»ºè®®**: ç»Ÿä¸€å‘½åè§„èŒƒ

```python
# æ–‡ä»¶åï¼šä½¿ç”¨å®Œæ•´å•è¯
database_aggregations.py
instance_aggregations.py

# å‡½æ•°åï¼šç»Ÿä¸€ä½¿ç”¨å•æ•° + aggregation
def get_database_aggregation()          # å•æ•°
def get_instance_aggregation()          # å•æ•°
def aggregate_current_period()          # åŠ¨è¯ + æ˜ç¡®å¯¹è±¡
```

### 2. å‡½æ•°åæ¨¡ç³Šé—®é¢˜

#### é—®é¢˜ 2.1: index() å‡½æ•°è¿‡äºé€šç”¨

**ä½ç½®**: å¤šä¸ªè·¯ç”±æ–‡ä»¶

```python
# å¤šä¸ªæ–‡ä»¶éƒ½æœ‰ index() å‡½æ•°
# app/routes/sync_sessions.py
def index():                            # å¤ªé€šç”¨
    """ä¼šè¯ä¸­å¿ƒé¦–é¡µ"""

# app/routes/tags.py
def index():                            # å¤ªé€šç”¨
    """æ ‡ç­¾ç®¡ç†é¦–é¡µ"""

# app/routes/users.py
def index():                            # å¤ªé€šç”¨
    """ç”¨æˆ·ç®¡ç†é¦–é¡µ"""
```

**å»ºè®®**: ä½¿ç”¨æ›´å…·æè¿°æ€§çš„åç§°

```python
# æ¨èï¼šæ˜ç¡®åŠŸèƒ½
def sync_sessions_page():              # æˆ– list_sync_sessions_page()
def tags_management_page():            # æˆ– list_tags_page()
def users_management_page():           # æˆ– list_users_page()
```

**æ³¨æ„**: è¿™ä¸ªå¯èƒ½ä¸éœ€è¦æ”¹ï¼Œå› ä¸ºåœ¨ Flask è“å›¾ä¸­ï¼Œ`index()` æ˜¯çº¦å®šä¿—æˆçš„é¦–é¡µå‡½æ•°åã€‚

#### é—®é¢˜ 2.2: api_list å’Œ api_detail ä¸æ¸…æ™°

**ä½ç½®**: `app/routes/instance.py`, `app/routes/credentials.py`

```python
# å½“å‰å‘½å
def api_list():                         # åˆ—å‡ºä»€ä¹ˆï¼Ÿ
def api_detail():                       # ä»€ä¹ˆçš„è¯¦æƒ…ï¼Ÿ
```

**å»ºè®®**: ä½¿ç”¨æ›´æ˜ç¡®çš„åç§°

```python
# æ¨èï¼šæ˜ç¡®èµ„æºç±»å‹
def list_instances():                   # æ¸…æ™°
def get_instance():                     # æ¸…æ™°
def list_credentials():                 # æ¸…æ™°
def get_credential():                   # æ¸…æ™°
```

### 3. å‡½æ•°åä¸åŠŸèƒ½ä¸ç¬¦é—®é¢˜

#### é—®é¢˜ 3.1: fetch_summary å®é™…è¿”å›ç»Ÿè®¡æ•°æ®

**ä½ç½®**: `app/services/statistics/instance_statistics_service.py`

```python
def fetch_summary(*, db_type: str | None = None) -> dict[str, int]:
    """è·å–å®ä¾‹æ•°æ±‡æ€»ï¼ˆæ€»æ•°=æ´»è·ƒ+å·²åˆ é™¤ï¼Œæ´»è·ƒ=æ­£å¸¸+ç¦ç”¨ï¼‰ã€‚"""
    # å®é™…ä¸Šæ˜¯ç»Ÿè®¡æ•°æ®ï¼Œä¸åªæ˜¯æ±‡æ€»
```

**åˆ†æ**: 
- `summary` é€šå¸¸æŒ‡ç®€è¦æ¦‚è¿°
- ä½†è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯è¯¦ç»†çš„ç»Ÿè®¡æ•°æ®
- æ›´å‡†ç¡®çš„åç§°åº”è¯¥æ˜¯ `fetch_statistics` æˆ– `fetch_counts`

**å»ºè®®**:

```python
def fetch_instance_statistics(*, db_type: str | None = None) -> dict[str, int]:
    """è·å–å®ä¾‹ç»Ÿè®¡æ•°æ®ï¼ˆæ€»æ•°ã€æ´»è·ƒæ•°ã€å·²åˆ é™¤æ•°ç­‰ï¼‰ã€‚"""
```

#### é—®é¢˜ 3.2: build_aggregated_statistics å‘½åå†—ä½™

**ä½ç½®**: `app/services/statistics/account_statistics_service.py`

```python
def build_aggregated_statistics():
    """æ„å»ºèšåˆç»Ÿè®¡æ•°æ®"""
    # aggregated å’Œ statistics è¯­ä¹‰é‡å¤
```

**åˆ†æ**:
- `statistics` æœ¬èº«å°±åŒ…å«èšåˆçš„å«ä¹‰
- `aggregated` æ˜¯å†—ä½™çš„

**å»ºè®®**:

```python
def build_account_statistics():
    """æ„å»ºè´¦æˆ·ç»Ÿè®¡æ•°æ®"""
    
# æˆ–è€…æ›´æ˜ç¡®
def get_account_statistics():
    """è·å–è´¦æˆ·ç»Ÿè®¡æ•°æ®"""
```

### 4. å‘½åå†—ä½™é—®é¢˜

#### é—®é¢˜ 4.1: è·¯ç”±å‡½æ•°ä¸­çš„ _api åç¼€

**ä½ç½®**: å¤šä¸ªè·¯ç”±æ–‡ä»¶

```python
# åœ¨ API è·¯ç”±ä¸­ï¼Œ_api åç¼€æ˜¯å†—ä½™çš„
@account_stat_bp.route("/api/statistics")
def statistics_api():                   # api åç¼€å†—ä½™
    pass

@users_bp.route("/api/users")
def api_get_users():                    # api å‰ç¼€å†—ä½™
    pass
```

**å»ºè®®**: ç§»é™¤å†—ä½™çš„ api å‰ç¼€/åç¼€

```python
# æ¨èï¼šè·¯ç”±è·¯å¾„å·²ç»åŒ…å« /api/
@account_stat_bp.route("/api/statistics")
def get_statistics():                   # ç®€æ´æ˜äº†
    pass

@users_bp.route("/api/users")
def list_users():                       # ç®€æ´æ˜äº†
    pass
```

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| é—®é¢˜ç±»å‹ | æ•°é‡ | ä¼˜å…ˆçº§ |
|---------|------|--------|
| å‘½åä¸ä¸€è‡´ | 10+ | ğŸŸ¡ ä¸­ |
| å‡½æ•°åæ¨¡ç³Š | 15+ | ğŸŸ¡ ä¸­ |
| åç§°ä¸åŠŸèƒ½ä¸ç¬¦ | 5+ | ğŸŸ  ä¸­é«˜ |
| å‘½åå†—ä½™ | 30+ | ğŸŸ¡ ä¸­ |
| **æ€»è®¡** | **60+** | - |

---

## ğŸ¯ é‡æ„å»ºè®®

### é«˜ä¼˜å…ˆçº§ï¼ˆå½±å“ç†è§£ï¼‰

1. **ä¿®å¤è¯­æ³•é”™è¯¯**
   - `get_instances_aggregations` â†’ `get_instance_aggregations`
   - `get_databases_aggregations` â†’ `get_database_aggregations`

2. **ç»Ÿä¸€å‘½åé£æ ¼**
   - ç»Ÿä¸€ä½¿ç”¨ `statistics` è€Œéæ··ç”¨ `stats`
   - ç»Ÿä¸€ä½¿ç”¨å•æ•°å½¢å¼ `aggregation`

3. **ç§»é™¤å†—ä½™å‰ç¼€/åç¼€**
   - ç§»é™¤ API è·¯ç”±ä¸­çš„ `api_` å‰ç¼€
   - ç§»é™¤ API è·¯ç”±ä¸­çš„ `_api` åç¼€

### ä¸­ä¼˜å…ˆçº§ï¼ˆæ”¹å–„ä¸€è‡´æ€§ï¼‰

1. **ä½¿ç”¨æ›´æ˜ç¡®çš„åç§°**
   - `api_list` â†’ `list_resources`
   - `api_detail` â†’ `get_resource`
   - `fetch_summary` â†’ `fetch_statistics`

2. **ç§»é™¤å†—ä½™è¯æ±‡**
   - `build_aggregated_statistics` â†’ `build_statistics`
   - `get_classification_rules_cache` â†’ `get_rules_cache`

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

1. **è€ƒè™‘é‡å‘½åé€šç”¨å‡½æ•°**
   - `index()` â†’ `list_page()` æˆ–ä¿æŒä¸å˜ï¼ˆFlask çº¦å®šï¼‰

2. **ç»Ÿä¸€åŠ¨è¯ä½¿ç”¨**
   - `fetch` vs `get` vs `list` - é€‰æ‹©ä¸€ä¸ªç»Ÿä¸€ä½¿ç”¨

---

## ğŸ“ å‘½åè§„èŒƒå»ºè®®

### RESTful API å‡½æ•°å‘½å

```python
# CRUD æ“ä½œ
def list_resources():       # GET /api/resources
def get_resource(id):       # GET /api/resources/:id
def create_resource():      # POST /api/resources
def update_resource(id):    # PUT /api/resources/:id
def delete_resource(id):    # DELETE /api/resources/:id

# ç‰¹æ®Šæ“ä½œ
def search_resources():     # GET /api/resources/search
def export_resources():     # GET /api/resources/export
def import_resources():     # POST /api/resources/import
```

### ç»Ÿè®¡å’Œèšåˆå‡½æ•°å‘½å

```python
# ç»Ÿè®¡å‡½æ•°
def get_statistics():               # è·å–ç»Ÿè®¡æ•°æ®
def get_statistics_by_type():      # æŒ‰ç±»å‹ç»Ÿè®¡
def get_statistics_summary():      # ç»Ÿè®¡æ±‡æ€»

# èšåˆå‡½æ•°
def aggregate_data():               # èšåˆæ•°æ®
def aggregate_by_period():          # æŒ‰å‘¨æœŸèšåˆ
def calculate_aggregation():        # è®¡ç®—èšåˆ
```

### æœåŠ¡å±‚å‡½æ•°å‘½å

```python
# æŸ¥è¯¢å‡½æ•°
def fetch_data():                   # ä»æ•°æ®åº“è·å–
def load_data():                    # åŠ è½½æ•°æ®
def query_data():                   # æŸ¥è¯¢æ•°æ®

# å¤„ç†å‡½æ•°
def process_data():                 # å¤„ç†æ•°æ®
def transform_data():               # è½¬æ¢æ•°æ®
def validate_data():                # éªŒè¯æ•°æ®

# æ„å»ºå‡½æ•°
def build_response():               # æ„å»ºå“åº”
def format_data():                  # æ ¼å¼åŒ–æ•°æ®
def serialize_data():               # åºåˆ—åŒ–æ•°æ®
```

---

## ğŸ”§ é‡æ„ç¤ºä¾‹

### ç¤ºä¾‹ 1: account_stat.py é‡æ„

**é‡æ„å‰**:
```python
@account_stat_bp.route("/api/statistics")
def statistics_api():
    summary = build_aggregated_statistics()
    return jsonify_unified_success(data={"stats": summary})

@account_stat_bp.route("/api/statistics/db-types")
def statistics_db_type_api():
    stats = fetch_db_type_stats()
    return jsonify_unified_success(data=stats)
```

**é‡æ„å**:
```python
@account_stat_bp.route("/api/statistics")
def get_statistics():
    statistics = build_account_statistics()
    return jsonify_unified_success(data={"statistics": statistics})

@account_stat_bp.route("/api/statistics/by-db-type")
def get_statistics_by_db_type():
    statistics = fetch_db_type_statistics()
    return jsonify_unified_success(data=statistics)
```

### ç¤ºä¾‹ 2: instance.py é‡æ„

**é‡æ„å‰**:
```python
@instance_bp.route("/api")
def api_list():
    """è·å–å®ä¾‹åˆ—è¡¨API"""
    pass

@instance_bp.route("/api/<int:instance_id>")
def api_detail(instance_id):
    """è·å–å®ä¾‹è¯¦æƒ…API"""
    pass
```

**é‡æ„å**:
```python
@instance_bp.route("/api")
def list_instances():
    """è·å–å®ä¾‹åˆ—è¡¨"""
    pass

@instance_bp.route("/api/<int:instance_id>")
def get_instance(instance_id):
    """è·å–å®ä¾‹è¯¦æƒ…"""
    pass
```

---

## âœ… éªŒè¯æ¸…å•

### å‘½åä¸€è‡´æ€§æ£€æŸ¥

- [ ] åŒä¸€åŠŸèƒ½ä½¿ç”¨ç›¸åŒçš„åŠ¨è¯ï¼ˆget/fetch/listï¼‰
- [ ] ç»Ÿè®¡åŠŸèƒ½ç»Ÿä¸€ä½¿ç”¨ `statistics` è€Œé `stats`
- [ ] èšåˆåŠŸèƒ½ç»Ÿä¸€ä½¿ç”¨ `aggregation` å•æ•°å½¢å¼
- [ ] API è·¯ç”±å‡½æ•°ä¸åŒ…å« `api_` å‰ç¼€æˆ– `_api` åç¼€

### å‘½åæ¸…æ™°æ€§æ£€æŸ¥

- [ ] å‡½æ•°åæ¸…æ¥šè¡¨è¾¾å…¶åŠŸèƒ½
- [ ] é¿å…ä½¿ç”¨è¿‡äºé€šç”¨çš„åç§°ï¼ˆé™¤éæ˜¯çº¦å®šï¼‰
- [ ] å‡½æ•°åä¸æ–‡æ¡£å­—ç¬¦ä¸²ä¸€è‡´
- [ ] å‡½æ•°åä¸å®é™…è¿”å›å€¼ç±»å‹åŒ¹é…

### å‘½åç®€æ´æ€§æ£€æŸ¥

- [ ] ç§»é™¤å†—ä½™çš„è¯æ±‡
- [ ] é¿å…ä¸å¿…è¦çš„ç¼©å†™
- [ ] å‡½æ•°åé•¿åº¦é€‚ä¸­ï¼ˆä¸è¶…è¿‡ 4-5 ä¸ªå•è¯ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

### å‘½åè§„èŒƒ

- [Google Python Style Guide - Naming](https://google.github.io/styleguide/pyguide.html#s3.16-naming)
- [PEP 8 - Naming Conventions](https://www.python.org/dev/peps/pep-0008/#naming-conventions)
- [Clean Code - Meaningful Names](https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882)

### RESTful API å‘½å

- [RESTful API Design Best Practices](https://restfulapi.net/resource-naming/)
- [Microsoft REST API Guidelines](https://github.com/microsoft/api-guidelines/blob/vNext/Guidelines.md)

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. [ ] ä¿®å¤è¯­æ³•é”™è¯¯ï¼ˆ`get_instances_aggregations`ï¼‰
2. [ ] ç§»é™¤ `api_` å‰ç¼€å’Œ `_api` åç¼€
3. [ ] ç»Ÿä¸€ `statistics` vs `stats` çš„ä½¿ç”¨

### è®¡åˆ’æ‰§è¡Œï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. [ ] é‡å‘½åæ¨¡ç³Šçš„å‡½æ•°å
2. [ ] ç»Ÿä¸€åŠ¨è¯ä½¿ç”¨ï¼ˆget/fetch/listï¼‰
3. [ ] ç§»é™¤å†—ä½™è¯æ±‡

### å¯é€‰æ‰§è¡Œï¼ˆä½ä¼˜å…ˆçº§ï¼‰

1. [ ] è€ƒè™‘é‡å‘½å `index()` å‡½æ•°
2. [ ] ä¼˜åŒ–æœåŠ¡å±‚å‡½æ•°å‘½å
3. [ ] æ·»åŠ æ›´è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²

---

*å‡½æ•°å‘½åæ˜¯ä»£ç å¯è¯»æ€§çš„å…³é”®ï¼Œå€¼å¾—æŠ•å…¥æ—¶é—´ä¼˜åŒ–ï¼*
