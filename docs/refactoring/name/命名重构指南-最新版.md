# 命名规范重构指南（2025-11-27 全量扫描版）

> 本版基于 2025-11-27 对 `TaifishingV4` 仓库的实仓扫描（`rg` + `find`）重新整理，覆盖所有仍未对齐命名标准的文件、函数与脚本。每次提交前请先运行 `./scripts/refactor_naming.sh --dry-run`，若仍有输出则说明重构尚未完成。

---

## 1. 扫描摘要

| 类别 | 数量 | 说明 |
| --- | --- | --- |
| `api_` 前缀函数 | **27** | 主要集中在 `routes/`，需改为动词短语，如 `list_users` |
| `_api` 后缀函数 | **16**（路由） | `app/utils/structlog_config.py:get_api_logger` 可保留，其余需重命名 |
| `_optimized` 实现后缀 | **2** | `auto_classify_accounts_optimized`、`_get_all_users_database_permissions_batch_optimized` |
| 复数嵌套函数 | **2** | `get_databases_aggregations*` |
| `_form_view.py` 文件 | **8** | 包含 `app/views/mixins/resource_form_view.py` |
| `_form_service.py` 文件 | **9** | `app/services/form_service/` 下全部待改 |
| `*_aggr.py` 路由文件 | **2** | `database_aggr.py`、`instance_aggr.py` |

前端（含 `databases/ledger`、`capacity-stats/*` 等目录）当前已全部采用 kebab-case，不在本轮重构范围。

---

## 2. 优先事项与详细清单

### 2.1 文件仍待重命名

| 模块 | 现状 | 建议命名 |
| --- | --- | --- |
| 路由 | `app/routes/database_aggr.py` | `database_aggregations.py` |
| 路由 | `app/routes/instance_aggr.py` | `instance_aggregations.py` |
| 视图 | `app/views/account_classification_form_view.py` | `classification_forms.py` |
| 视图 | `app/views/change_password_form_view.py` | `password_forms.py` |
| 视图 | `app/views/credential_form_view.py` | `credential_forms.py` |
| 视图 | `app/views/instance_form_view.py` | `instance_forms.py` |
| 视图 | `app/views/scheduler_job_form_view.py` | `scheduler_forms.py` |
| 视图 | `app/views/tag_form_view.py` | `tag_forms.py` |
| 视图 | `app/views/user_form_view.py` | `user_forms.py` |
| 视图（混入） | `app/views/mixins/resource_form_view.py` | `resource_forms.py` |
| 服务 | `app/services/form_service/change_password_form_service.py` | `password_service.py` |
| 服务 | `.../classification_form_service.py` | `classification_service.py` |
| 服务 | `.../classification_rule_form_service.py` | `classification_rule_service.py` |
| 服务 | `.../credentials_form_service.py` | `credential_service.py` |
| 服务 | `.../instances_form_service.py` | `instance_service.py` |
| 服务 | `.../resource_form_service.py` | `resource_service.py` |
| 服务 | `.../scheduler_job_form_service.py` | `scheduler_job_service.py` |
| 服务 | `.../tags_form_service.py` | `tag_service.py` |
| 服务 | `.../users_form_service.py` | `user_service.py` |

> **提示**：重命名后记得修正 `__init__.py`、`__all__` 以及任何字符串配置（如 Celery 注册名）。

### 2.2 函数命名待整改

#### 2.2.1 `api_` 前缀（27 个）

| 文件 | 函数 | 建议命名 |
| --- | --- | --- |
| `routes/users.py` | `api_get_users` | `list_users` |
|  | `api_get_user` | `get_user` |
|  | `api_create_user` | `create_user` |
|  | `api_update_user` | `update_user` |
|  | `api_delete_user` | `delete_user` |
|  | `api_get_stats` | `get_user_stats` |
| `routes/instance.py` | `api_detail` | `get_instance_detail` |
|  | `api_get_accounts` | `list_instance_accounts` |
| `routes/credentials.py` | `api_list` | `list_credentials` |
|  | `api_detail` | `get_credential` |
| `routes/tags.py` | `api_tags` | `list_tags_v2`（或合并至已有 `list_tags`） |
|  | `api_categories` | `list_tag_categories_v2` |
|  | `api_tag_detail` | `get_tag_by_name` |
|  | `api_tag_detail_by_id` | `get_tag_by_id` |
| `routes/tags_batch.py` | `api_instance_tags` | `list_instance_tags` |
|  | `api_instances` | `list_taggable_instances` |
|  | `api_all_tags` | `list_all_tags` |
| `routes/sync_sessions.py` | `api_get_session_detail` | `get_sync_session_detail` |
|  | `api_cancel_session` | `cancel_sync_session` |
|  | `api_get_error_logs` | `list_sync_session_errors` |
| `routes/dashboard.py` | `api_overview` | `get_dashboard_overview` |
|  | `api_charts` | `get_dashboard_charts` |
|  | `api_activities` | `list_dashboard_activities` |
|  | `api_status` | `get_dashboard_status` |
| `routes/health.py` | `api_health` | `get_health` |
|  | `api_cache_health` | `get_cache_health` |
| `routes/instance_statistics.py` | `api_statistics` | `get_instance_statistics` |

#### 2.2.2 `_api` 后缀（16 个）

| 文件 | 函数 | 建议命名 |
| --- | --- | --- |
| `routes/account.py` | `list_accounts_api` | `list_accounts` |
| `routes/logs.py` | `get_log_modules_api` | `list_log_modules` |
| `routes/instance_detail.py` | `edit_api` | `update_instance_detail` |
| `routes/credentials.py` | `create_api` | `create_credential` |
|  | `edit_api` | `update_credential` |
| `routes/account_stat.py` | `statistics_api` | `get_account_statistics` |
|  | `statistics_summary_api` | `get_account_statistics_summary` |
|  | `statistics_db_type_api` | `get_account_statistics_by_db_type` |
|  | `statistics_classification_api` | `get_account_statistics_by_classification` |
| `routes/instance.py` | `create_api` | `create_instance` |
|  | `list_instances_api` | `list_instances` |
| `routes/tags.py` | `create_api` | `create_tag` |
|  | `edit_api` | `update_tag` |
|  | `list_tags_api` | `list_tags`（如与上方接口重复，可直接共用） |
| `routes/auth.py` | `login_api` | `login` |
|  | `change_password_api` | `change_password` |

> `app/utils/structlog_config.py:get_api_logger` 属于日志工具，可保留。

#### 2.2.3 `_optimized` 实现后缀

- `app/services/account_classification/orchestrator.py:auto_classify_accounts_optimized`
- `app/services/account_sync/adapters/sqlserver_adapter.py:_get_all_users_database_permissions_batch_optimized`

推荐改名：`auto_classify_accounts` / `_get_all_users_database_permissions_batch`，必要时在 docstring 中记录“使用优化策略”。

#### 2.2.4 复数嵌套

- `app/routes/database_aggr.py:get_databases_aggregations`
- `app/routes/database_aggr.py:get_databases_aggregations_summary`

统一改为 `get_database_aggregations`、`get_database_aggregations_summary`。

---

## 3. 建议执行步骤

### 3.1 文件批量重命名脚本

```bash
#!/usr/bin/env bash
set -euo pipefail

# 路由
for pair in \
  "app/routes/database_aggr.py app/routes/database_aggregations.py" \
  "app/routes/instance_aggr.py app/routes/instance_aggregations.py"; do
  src=$(echo $pair | awk '{print $1}')
  dst=$(echo $pair | awk '{print $2}')
  [ -f "$src" ] && git mv "$src" "$dst"
done

# 视图（含 mixins）
declare -A views=(
  [account_classification_form_view.py]=classification_forms.py
  [change_password_form_view.py]=password_forms.py
  [credential_form_view.py]=credential_forms.py
  [instance_form_view.py]=instance_forms.py
  [scheduler_job_form_view.py]=scheduler_forms.py
  [tag_form_view.py]=tag_forms.py
  [user_form_view.py]=user_forms.py
)
for file in "${!views[@]}"; do
  [ -f "app/views/$file" ] && git mv "app/views/$file" "app/views/${views[$file]}"
done
[ -f app/views/mixins/resource_form_view.py ] && git mv app/views/mixins/resource_form_view.py app/views/mixins/resource_forms.py

# 服务
while IFS= read -r file; do
  base=${file##*/}
  target=${base/_form_/}
  git mv "$file" "${file%/*}/${target}"
done < <(rg --files -g"*_form_service.py" app/services/form_service)
```

### 3.2 导入路径批量替换

```bash
find app -name "*.py" -type f -exec sed -i '' \
  -e 's/from app\\.routes\\.database_aggr/from app.routes.database_aggregations/g' \
  -e 's/from app\\.routes\\.instance_aggr/from app.routes.instance_aggregations/g' \
  -e 's/import database_aggr/import database_aggregations/g' \
  -e 's/import instance_aggr/import instance_aggregations/g' \
  -e 's/from app\\.views\\.account_classification_form_view/from app.views.classification_forms/g' \
  -e 's/from app\\.views\\.change_password_form_view/from app.views.password_forms/g' \
  -e 's/from app\\.views\\.credential_form_view/from app.views.credential_forms/g' \
  -e 's/from app\\.views\\.instance_form_view/from app.views.instance_forms/g' \
  -e 's/from app\\.views\\.scheduler_job_form_view/from app.views.scheduler_forms/g' \
  -e 's/from app\\.views\\.tag_form_view/from app.views.tag_forms/g' \
  -e 's/from app\\.views\\.user_form_view/from app.views.user_forms/g' \
  -e 's/from app\\.views\\.mixins\\.resource_form_view/from app.views.mixins.resource_forms/g' \
  -e 's/from app\\.services\\.form_service\\.change_password_form_service/from app.services.form_service.password_service/g' \
  -e 's/from app\\.services\\.form_service\\.classification_form_service/from app.services.form_service.classification_service/g' \
  -e 's/from app\\.services\\.form_service\\.classification_rule_form_service/from app.services.form_service.classification_rule_service/g' \
  -e 's/from app\\.services\\.form_service\\.credentials_form_service/from app.services.form_service.credential_service/g' \
  -e 's/from app\\.services\\.form_service\\.instances_form_service/from app.services.form_service.instance_service/g' \
  -e 's/from app\\.services\\.form_service\\.resource_form_service/from app.services.form_service.resource_service/g' \
  -e 's/from app\\.services\\.form_service\\.scheduler_job_form_service/from app.services.form_service.scheduler_job_service/g' \
  -e 's/from app\\.services\\.form_service\\.tags_form_service/from app.services.form_service.tag_service/g' \
  -e 's/from app\\.services\\.form_service\\.users_form_service/from app.services.form_service.user_service/g' \
  {} +
```

### 3.3 函数重命名策略

1. 使用 IDE 的 “Rename Symbol” / LSP `:rename`，一次一个函数，立即跑 `pytest -k <module>` 验证。
2. 对 REST API 保持以下映射：`list_*`, `get_*`, `create_*`, `update_*`, `delete_*`, `run_*`, `sync_*`。
3. 若同时存在 V1/V2，可在名称后追加语义（如 `list_tags_v2`），而非 `api_tags`。
4. `_optimized` 相关函数保留 `optimized` 逻辑，但名称采用业务含义，在 docstring 中说明背后策略。

---

## 4. 验证清单

```bash
# 1. 确认旧文件不存在
ls app/routes/*aggr.py && echo "❌ 仍存在 _aggr" || echo "✅ 路由已重命名"
rg --files -g"*_form_view.py" app/views && echo "❌ 仍有 _form_view" || echo "✅ 视图已重命名"
rg --files -g"*_form_service.py" app/services/form_service && echo "❌ 仍有 _form_service" || echo "✅ 服务已重命名"

# 2. 搜索函数命名
rg "def api_" app/routes && echo "❌ 仍有 api_ 前缀" || echo "✅ 无 api_"
rg "def [A-Za-z0-9_]+_api" app/routes && echo "❌ 仍有 _api 后缀" || echo "✅ 无 _api"
rg "_optimized" app/services && echo "❌ 仍有 _optimized" || echo "✅ 无 _optimized"
rg "get_databases_aggregations" app/routes/database_aggregations.py

# 3. 运行质量门禁
./scripts/refactor_naming.sh --dry-run
make test
make quality
```

---

## 5. 命名规范备忘

- **文件/模块**：全部 `snake_case`，禁止缩写（`database_aggregations.py` 而非 `database_aggr.py`）。
- **函数**：动词短语；REST 类函数统一 CRUD 动词；禁止技术细节后缀（`_api`、`_optimized`）。
- **类**：`CapWords`；**常量**：`UPPER_SNAKE_CASE`。
- **前端资源**：目录、JS、CSS 文件保持 kebab-case。
- **文档**：遇到命名重构变更，第一时间同步 `AGENTS.md` 和本指南。

---

## 6. 备注

- 新增的 `databases/ledger` 模块、标签筛选等前端文件已符合命名规范，无需在本指南中重复跟踪。
- 项目定位为桌面端控制台，请勿为命名重构引入移动端专用 @media 或与命名无关的样式改动。
- 如需拆分任务，建议以“文件重命名 → 函数重命名 → 清理引用”三阶段提交，便于代码审查。

*最后更新：2025-11-27*。
