# 命名规范重构指南（2025-11-27 二次扫描）

> 2025-11-27 重新扫描仓库：所有历史遗留的文件/函数命名（`_aggr`, `_form_service`, `api_`, `_api`, `_optimized`, 复数嵌套等）已清零。文档保留执行步骤与校验脚本，方便后续回归检查。

---

## 1. 扫描摘要

| 检查项 | 结果 | 说明 |
| --- | --- | --- |
| 路由/视图/服务文件名 | ✅ | 不存在 `_aggr.py`、`*_form_view.py`、`*_form_service.py` 文件 |
| `api_` 前缀函数 | ✅ | `app/routes/` 中不含 `def api_*` |
| `_api` 后缀函数 | ✅ | `app/routes/` 中不含 `_api` 函数 |
| `_optimized` 函数名 | ✅ | 仅保留 `use_optimized` 作为参数，无 `_optimized` 函数 |
| 复数嵌套函数 | ✅ | `get_database_aggregations` 等均为单数结构 |

如需复查，运行：

```bash
./scripts/refactor_naming.sh --dry-run
```

---

## 2. 校验脚本（已更新）

`scripts/refactor_naming.sh` 会检测以下内容：

1. 是否还存在旧文件（例如 `app/routes/database_aggr.py`）。
2. 是否存在 `def api_*`、`def *_api`、`def *_optimized`。
3. 是否存在 `databases_aggregations` 或 `instances_aggregations` 复数拼写。

任何违规都会被列在脚本输出中；命名相关 PR 需附上 `./scripts/refactor_naming.sh --dry-run` 的“无需要替换的内容”截图。

---

## 3. 执行备注

- 若未来新建路由/API，请直接使用动词短语命名（例：`list_users`, `get_health`）。
- 服务层新增文件若属于旧表单逻辑，统一放在 `app/services/form_service/` 下并使用 `*_service.py`。
- 如需再次重构，可按以下顺序执行：
  1. `git mv` 重命名文件；
  2. `rg -l old_name | xargs perl -pi -e 's/old/new/g'` 批量替换导入；
  3. 使用 IDE rename 功能依次重命名函数；
  4. 运行 `pytest`、`make quality` 与命名脚本。
- 本项目面向桌面端控制台，样式改动无需再为移动端添加专用 @media；命名任务不应夹带与命名无关的 UI 重构。

---

## 4. 参考历史（可忽略）

| 旧命名 | 现状 |
| --- | --- |
| `app/routes/database_aggr.py` | ✅ 已重命名为 `database_aggregations.py` |
| `app/views/*_form_view.py` | ✅ 全部替换为 `*_forms.py`（含 mixins） |
| `app/services/form_service/*_form_service.py` | ✅ 全部替换为 `*_service.py` |
| `api_get_users`, `api_get_session_detail`, ... | ✅ 均已改为动词短语（`list_users`, `get_sync_session_detail` 等） |
| `auto_classify_accounts_optimized` | ✅ 现为 `auto_classify_accounts` |
| `_get_all_users_database_permissions_batch_optimized` | ✅ 现为 `_get_all_users_database_permissions_batch` |

保留此表仅作为回溯记录，若再出现类似命名，应立即参考本指南处理。

---

*最后更新：2025-11-27 18:00 CST*
