# 数据库连接与账户管理重构计划

## 目标
- 统一跨数据库类型的连接适配与错误语义（PostgreSQL/MySQL/SQLServer/Oracle）。
- 强化数据库账户（凭据）安全：加密存储、最小权限、轮换策略、脱敏展示与审计。
- 标准化连接测试、健康检查与超时重试；统一日志与指标采集。
- 明确实例（`Instance`）与凭据（`Credential`）的绑定/引用模式与约束。

## 现状
- 代码位置：
  - `app/routes/connections.py`：连接相关路由（测试、管理）。
  - `app/models/instance.py`：实例模型，包含 `test_connection` 与不同数据库类型的测试实现。
  - `app/models/credential.py`：数据库账户/凭据模型。
  - `app/services/sync_adapters/`：按类型的适配器（可能用于同步/连接）。
- 验证与安全：`app/utils/validation.py`、`app/utils/security.py` 提供基础校验与安全工具。
- 问题特征：不同数据库类型的异常信息与重试策略不统一；凭据展示与审计缺少约定。

## 风险
- 凭据泄露风险：未统一脱敏展示与严格的访问审计（读取/导出）。
- 连接错误语义不一致：前端与调用方难以根据错误类型做自动化处理。
- 缺少轮换策略：数据库账户未配置轮换与过期提醒，长期风险。
- 绑定关系不清晰：实例与凭据缺少约束校验，导致数据不一致或脏引用。

## 优先级与改进
- P0：
  - 统一连接测试接口契约（入参、超时、重试、结果结构），错误码规范：`CONN_TIMEOUT`、`AUTH_FAILED`、`NETWORK_ERROR`、`DRIVER_ERROR`。
  - 凭据存储加密与脱敏展示（仅显示 `host:port` 与 `username`，不显示密码）；审计日志记录查看/测试事件。
  - 最小权限建议与校验（只授予必需权限），在文档中列出最小权限示例。
- P1：
  - 适配器接口统一（连接、查询、版本获取），集中错误映射与重试策略；在 `services/sync_adapters` 形成规范。
  - 轮换策略与提醒（按 `last_updated`/`rotation_interval`），提供脚本或操作建议。
- P2：
  - 实例-凭据绑定约束与健康检查任务（定期校验连接/权限），并写入审计日志与指标。

## 产出与检查清单
- 连接测试与错误码契约文档；前后端处理示例。
- 凭据安全策略与脱敏展示规则；审计事件清单。
- 适配器接口规范与错误映射表；重试配置建议。
- 最小权限指南：各数据库类型的权限模板与说明。