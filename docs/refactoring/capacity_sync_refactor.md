# 容量同步与数据采集重构计划

## 目标
- 统一容量/大小/配额的采集与存储模型，涵盖实例/数据库/表级维度。
- 提升同步任务的可靠性：幂等、分片/分页抓取、断点续传、失败重试与告警。
- 规范时间窗口与时区策略（内部使用 UTC），确保统计一致性。
- 明确同步频率、保留周期与归档策略，降低存储膨胀风险。

## 现状
- 代码位置：
  - 定时任务：`app/scheduler.py` 与 `app/tasks/account_sync_tasks.py`、`app/tasks/log_cleanup_tasks.py`。
  - 统计与聚合：`app/routes/aggregations.py`、`app/routes/dashboard.py` 提供相关接口与展示。
  - 会话与同步：`app/models/sync_session.py`（用于记录会话/同步过程）。
- 采集方式：不同数据库类型的采集接口差异较大，缺少统一输出契约与断点续传策略。

## 风险
- 长任务与失败恢复：无分片与断点，失败后重复与遗漏并存。
- 时区不一致导致窗口统计偏移；跳时（DST）场景未测试。
- 存储膨胀：缺少留存与归档策略，历史数据增长不可控。

## 优先级与改进
- P0：
  - 统一采集输出契约：`{resource_id, resource_type, size_bytes, collected_at_utc, context}`。
  - 任务幂等标识（`batch_id`/`window`）与重试策略（指数退避 + 最大次数）。
- P1：
  - 分片与分页采集（按实例/库/表划分），支持断点续传（记录上次成功游标）。
  - 留存与归档策略（例如：明细保留 30 天，聚合保留 180 天），提供归档脚本设计。
- P2：
  - 采集结果校验与异常报告（缺口检测、重复检测），纳入指标与告警。

## 产出与检查清单
- 采集契约文档与示例 payload；分页/断点设计说明。
- 留存策略与归档脚本说明；窗口定义与时区策略文档化。
- 幂等/重试配置建议与失败事件上报清单。
