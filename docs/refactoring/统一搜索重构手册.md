# 统一搜索重构手册

## 核心目标与边界
- **功能一致性第一**：搜索语义、筛选组合、键盘交互、URL 参数回填等所有现有行为全部保留。
- **接口与数据契约保持稳定**：模板上下文、AJAX 接口、统计埋点不可因为重构产生差异。
- **架构优化不牺牲体验**：仅在确认对用户无感知差异时才引入新的抽象或依赖。

## 现状痛点概览
- `unified_search.js` 体量大、依赖全局变量（`window.unifiedSearch`），各页面覆写方法易出错（已有 `handleSubmit(e)` 传入 `undefined` 的事故）。
- 模板依赖大量 `show_*` 条件分支，组合路径难以测试，新增筛选项需要反复改动同一文件。
- 多处硬编码选项与真实数据源脱节（例如标签、同步状态），页面间显示不一致。
- 标签操作每次触发都会整表请求 `/tags/api/tags`，浪费资源且出现竞态。
- 动态页面需要手动绑定/解绑事件，维护成本高且缺乏统一入口。

## 建议架构：原子组件 + Tom Select 的混合方案
1. **原子化组件**  
   - 将筛选器拆分成职责单一的模板（如 `search_input.html`、`db_type_filter.html`、`status_active_filter.html`），页面按需组合。
   - 通过宏或基础表单模板暴露统一接口，减少模板参数爆炸。
2. **Tom Select**  
   - 选用 Tom Select 2.x，无需 jQuery，官方提供 Bootstrap 5 主题、搜索、多选、AJAX 等能力。
   - 每个筛选器只负责配置选项和占位文本，交互由统一初始化脚本接管。
3. **基础设施**  
   - 公共样式与脚本放在 `app/static/css/components/filters/`、`app/static/js/components/filters/`。
   - 提供便捷宏（例如 `base_search_form.html`）封装行列布局、按钮区域。
4. **配置集中管理**  
   - 所有枚举常量迁移到 `app/config/filter_options.py`；路由引用后注入模板。

## 数据来源策略
- **常量配置（代码维护）**  
  数据库类型、凭据类型、同步类型、同步分类、日志级别、时间范围、统计周期、不同状态组等全部写入 `filter_options.py`，避免散落模板。
- **动态数据（数据库查询）**  
  标签、标签分类、账户分类、实例列表、数据库列表、日志模块等通过 `app/utils/filter_data.py` 中的统一方法获取，禁止硬编码。
- **标签选择器注意事项**  
  - 默认调用 `get_active_tags()`，仅返回激活标签，并维持 `name`、`display_name`、`color`、`sort_order`。
  - 在组件实例内缓存标签数据，避免重复请求 `/tags/api/tags`。
  - chip 展示、删除、URL 参数回填均需保证与现有行为一致。
- **筛选枚举统一**  
  - 模板不可直接写出 “running”等字面值，必须引用常量，确保多页面使用同一套文案。

## 推荐实施节奏（约 6 小时）
1. **基础设施（1 小时）**  
   - 在 `base.html` 引入 Tom Select 资源；建立通用 CSS/JS；创建 `filter_options.py`、`filter_data.py`。
2. **组件库（2.5 小时）**  
   - 完成 13 个核心筛选组件 + 2 个级联组件；统一参数接口（`field_id`、`field_name`、`current_value` 等）。
3. **页面迁移（1.5 小时）**  
   - 账户、实例、凭据、标签、日志、同步会话、容量统计页面依次替换；路由改用集中配置/查询；初始化脚本接入 Tom Select。
4. **测试与收尾（1 小时）**  
   - 回归全部筛选路径；验证 URL 参数、级联禁用、清除按钮、动态页面回调；清理废弃的 `unified_search*.{html,js,css}` 资源。

## 功能回归清单
- 搜索框提交参数与校验逻辑保持一致。
- 标签筛选：多选、chip 渲染、移除、URL 回填、清除流程全部符合旧版本。
- 状态筛选：实例/凭据/标签页面使用 `status_active_filter`，会话中心使用 `status_sync_filter`。
- 级联筛选：容量统计页面实现 “数据库类型 → 实例 → 数据库” 三级联动，并在上级变化时清空下级。
- 清除按钮：静态页面重定向去掉参数；动态页面触发 `clearFilters()` 并刷新数据。
- 自动化测试补充：标签一致性、状态区分、级联逻辑、常量来源检测。

## 校验与收益
- 浏览器手动验证：Chrome / Firefox / Safari + 移动端响应式。
- 投入：单人约 6 小时。
- 产出：减少约 1400 行重复代码，统一数据源，降低未来扩展/修复成本，预估首年 ROI 超过 800%。

## 建议后续步骤
1. 团队确认混合方案为唯一目标路线，冻结其他分支策略。
2. 依据本手册执行实施计划，迁移过程中记录例外场景。
3. 迁移完成后归档旧版脚本并在仓库注明弃用原因。
4. 计划迭代增强（如标签异步搜索、筛选器收藏）时继续复用组件架构，避免再次分叉。
