# 前端模块化重构计划

> 目标：提取通用函数 → 构建可复用模块 → 降低页面代码量

## 1. 背景与痛点

来源：
- `docs/reports/无构建工具的ES6模块化方案.md`
- `docs/reports/前端JS代码审计报告.md`

主要问题：
- 25 个页面文件依赖同一批全局函数，重复代码约 800 行。
- `formatSize`、加载/删除按钮、标签筛选、批量选择等函数被复制粘贴 ≥3 次。
- 缺乏统一的 `utils/`、`components/`、`api/` 分层，导致页面文件平均 200 行以上。

## 2. 重构目标

| 指标 | 现状 | 目标 |
|------|------|------|
| 重复代码 | ~800 行 | < 150 行 |
| 页面平均行数 | ~200 行 | ≤ 120 行 |
| 通用模块数 | 0 | ≥ 7 个 |
| 模块化引入方式 | `<script>` 全局 | `<script type="module">` + 局部导入 |

成功标准：新页面仅负责业务拼装，通用逻辑全部来自模块；新增页面无复制粘贴警告。

## 3. 模块分层

```
app/static/js/
├── utils/            # 纯函数工具
├── services/         # API 封装（可选）
├── components/       # UI/交互组件
└── pages/            # 页面入口，import 上述模块
```

### 3.1 核心工具（P0）

| 模块 | 说明 | 覆盖脚本 |
|------|------|----------|
| `utils/format.js` | `formatSizeFromBytes/MB/Auto` | instances/list.js, admin/* |
| `utils/ui-helpers.js` | `showButtonLoading`、`hideButtonLoading`、`toggleElement` | credentials/list.js, tags/index.js 等 |
| `utils/modal-helper.js` | `showModal`、`hideModal`、`getModal` | 多个页面 |

### 3.2 业务组件（P1）

| 模块 | 功能 | 覆盖脚本 |
|------|------|----------|
| `components/batch-selector.js` | 全选/批量按钮状态 | instances/list.js, tags/index.js, accounts/list.js |
| `components/tag-filter.js` | 标签筛选 UI + 表单回填 | instances/list.js, accounts/list.js, credentials/list.js |
| `components/search-form.js` | GET 搜索表单校验 + loading | credentials/list.js, tags/index.js, accounts/list.js |
| `components/delete-confirm.js` | 删除确认弹窗 + API | instances/list.js, tags/index.js 等 |

### 3.3 API/服务层（P2）

- `api/instances.js`、`api/accounts.js` 等：封装 `http.get/post`，页面只调用语义化方法。
- 可选 `services/http.js`，包装 axios（若后续切换 import map / ESM）。

## 4. 迁移顺序

1. **工具层 (P0)**：一周内完成 `utils/format/ui/modal`，并在 1-2 个页面验证。
2. **组件层 (P1)**：按页面优先级逐步替换（批量选择 → 标签筛选 → 搜索 → 删除确认），每完成一组件即全局替换。
3. **API 层 (P2)**：将 `/instances/api/...` 等请求统一封装；若要引入 import map，可在此阶段进行。
4. **页面瘦身**：迁移后页面入口保持 “初始化 + 少量业务 glue code”。

## 5. 具体实施

### 5.1 模块模板

```javascript
// utils/ui-helpers.js
export const UIHelpers = {
  showButtonLoading(target, text = '处理中...') {
    const btn = typeof target === 'string' ? document.getElementById(target) : target;
    if (!btn) return;
    btn.disabled = true;
    btn.dataset.originalHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
  },
  hideButtonLoading(target, text) {
    const btn = typeof target === 'string' ? document.getElementById(target) : target;
    if (!btn) return;
    btn.disabled = false;
    btn.innerHTML = text || btn.dataset.originalHtml || '提交';
  }
};
```

页面入口：
```javascript
import { UIHelpers } from '../../utils/ui-helpers.js';

document.querySelector('#submit-btn').addEventListener('click', (event) => {
  UIHelpers.showButtonLoading(event.currentTarget, '保存中...');
  // 调 API ...
});
```

### 5.2 重构步骤（每个页面）

1. `import` 新模块，删除页面内重复函数。
2. 替换 DOM 事件逻辑（如批量选择 → `new BatchSelector()`）。
3. 确保 `type="module"` 引入，并补全 `.js` 扩展名。
4. 手动/自动测试页面功能；若有多个页面依赖同一模块，逐个替换。

### 5.3 验证清单

- [ ] 页面入口文件不再定义 `formatSize`、`showLoadingState`、`deleteItem` 等通用函数。
- [ ] 所有新模块位于 `utils/` 或 `components/`，命名使用 kebab-case → `camelCase` 导出。
- [ ] HTML 模板使用 `<script type="module">` 并引用新的页面入口。
- [ ] `./scripts/refactor_naming.sh --dry-run` 无命名告警。

## 6. 交付与维护

- **周报**：记录每周完成的模块、迁移页面、减少的行数。
- **代码评审**：PR 模板新增“是否引用了公共模块”复选框；禁止提交新的重复函数。
- **后续优化**：当 utils/ 和 components/ 稳定后，可考虑引入 import map / Vite，但不是本阶段目标。

---

*版本：v0.1（2025-11-13）— 若发现新的重复模式，请补充到本文件并在 `components/` / `utils/` 中实现对应模块。*
