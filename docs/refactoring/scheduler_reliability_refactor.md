# 调度器可靠性重构计划

## 目标
- 将 APScheduler 持久化迁移到外部数据库（PostgreSQL/MySQL），通过环境变量配置连接。
- 统一时间为 `UTC` 存储，界面/日志按用户时区展示，明确触发器时区策略。
- 引入任务重试（次数、指数退避）与幂等保障；统一失败上报与指标。
- 任务命名规范与命名空间（如 `sync.instance.<id>`），便于审计与过滤。

## 现状
- 初始化：`app/scheduler.py` 使用 `SQLAlchemyJobStore(sqlite)` + `ThreadPoolExecutor(max_workers=5)`。
- 路由：`app/routes/scheduler.py` 提供管理接口（查询、暂停、恢复、立即执行、重载、更新触发器）。
- 健康：`app/services/scheduler_health_service.py` 与 `scripts/dev/check-scheduler.py`。

## 风险
- SQLite 单机锁争用与可靠性不足；跨实例不适用。
- 时区不统一可能导致计划偏移；日志与展示混乱。
- 缺少重试与幂等策略，失败无法自动恢复。
- 全删重载易丢失状态，缺少版本化的任务定义。

## 优先级与改进
- P0：外部数据库持久化、环境化连接串、统一内部 UTC。
- P1：重试/退避/幂等、统一错误路径与指标。
- P2：任务定义版本与校验、重载流程优化。

## 产出与检查清单
- 持久层迁移指南与回滚策略；连接参数文档化。
- 时区策略说明与测试用例（边界时间、DST场景）。
- 重试与幂等设计文档；失败事件采集与告警阈值。
- 任务命名规则与接口校验清单。