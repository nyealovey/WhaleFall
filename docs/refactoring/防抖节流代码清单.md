# é¡¹ç›®ä¸­çš„é˜²æŠ–å’ŒèŠ‚æµä»£ç æ¸…å•

> æ‰«ææ—¶é—´: 2025-11-18

## ğŸ“Š æ€»ç»“

| ç±»å‹ | æ•°é‡ | è¯´æ˜ |
|-----|------|------|
| æ‰‹å†™é˜²æŠ–å®ç° | 1 ä¸ª | åœ¨ filter-card.js ä¸­ |
| Lodash é˜²æŠ–/èŠ‚æµ | å¤šå¤„ | é€šè¿‡ LodashUtils å°è£…ä½¿ç”¨ |
| setTimeout å»¶è¿Ÿ | 15+ å¤„ | ç”¨äºå»¶è¿Ÿæ‰§è¡Œï¼Œéé˜²æŠ–/èŠ‚æµ |

---

## ğŸ” è¯¦ç»†æ¸…å•

### 1. æ‰‹å†™é˜²æŠ–å®ç°

#### âœ… `app/static/js/modules/ui/filter-card.js`

**ä½ç½®**: ç¬¬ 18-31 è¡Œ

**ä»£ç **:
```javascript
/**
 * ä½¿ç”¨ lodash çš„ debounceï¼Œè‹¥ä¸å¯ç”¨åˆ™é€€å›ç®€å•å®ç°ã€‚
 */
function createDebounced(fn, wait) {
  if (!wait) {
    return fn;
  }
  if (LodashUtils?.debounce) {
    return LodashUtils.debounce(fn, wait);
  }
  // æ‰‹å†™é˜²æŠ–å®ç°ï¼ˆfallbackï¼‰
  let timeout = null;
  return function debounced(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => fn.apply(this, args), wait);
  };
}
```

**ä½¿ç”¨åœºæ™¯**:
- è¡¨å•è¾“å…¥è‡ªåŠ¨æäº¤
- ä¼˜å…ˆä½¿ç”¨ Lodash çš„ debounce
- å¦‚æœ Lodash ä¸å¯ç”¨ï¼Œä½¿ç”¨æ‰‹å†™å®ç°ä½œä¸º fallback

**è°ƒç”¨ä½ç½®**: ç¬¬ 217 è¡Œ
```javascript
const handler = createDebounced(
  (event) => handleChange(event, control),
  autoSubmitDebounce,
);
```

---

### 2. Lodash é˜²æŠ–/èŠ‚æµå°è£…

#### âœ… `app/static/js/common/lodash-utils.js`

**ä½ç½®**: ç¬¬ 1-62 è¡Œ

**ä»£ç **:
```javascript
const methodsToExpose = [
  "cloneDeep",
  "merge",
  "defaultsDeep",
  "debounce",      // â† é˜²æŠ–
  "throttle",      // â† èŠ‚æµ
  "orderBy",
  // ... å…¶ä»–æ–¹æ³•
];

// åªæš´éœ²å¸¸ç”¨ä¸”ç¡®è®¤å­˜åœ¨çš„ lodash æ–¹æ³•
const LodashUtils = methodsToExpose.reduce((accumulator, methodName) => {
  const method = lodash[methodName];
  if (typeof method === "function") {
    accumulator[methodName] = wrap(method);
  }
  return accumulator;
}, {});

window.LodashUtils = Object.freeze(LodashUtils);
```

**è¯´æ˜**:
- å°è£…äº† Lodash çš„ `debounce` å’Œ `throttle` æ–¹æ³•
- é€šè¿‡ `LodashUtils.debounce()` å’Œ `LodashUtils.throttle()` å…¨å±€è°ƒç”¨
- é¡¹ç›®ä¸­å¤šå¤„ä½¿ç”¨æ­¤å°è£…

---

### 3. LodashUtils ä½¿ç”¨ç»Ÿè®¡

ä»¥ä¸‹æ–‡ä»¶ä¸­ä½¿ç”¨äº† `LodashUtils`ï¼ˆå¯èƒ½åŒ…å« debounce/throttleï¼‰:

| æ–‡ä»¶ | ä½¿ç”¨æ¬¡æ•° | ä¸»è¦ç”¨é€” |
|-----|---------|---------|
| `modules/ui/filter-card.js` | 1 æ¬¡ | é˜²æŠ–å¤„ç†è¡¨å•è¾“å…¥ |
| `modules/stores/tag_management_store.js` | 1 æ¬¡ | æ•°æ®æ’åº |
| `modules/views/credentials/list.js` | 3 æ¬¡ | æ•°æ®å¤„ç†å’Œè¿‡æ»¤ |
| `modules/views/accounts/list.js` | 2 æ¬¡ | æ•°æ®å¤„ç†å’Œè¿‡æ»¤ |
| `modules/views/instances/detail.js` | 2 æ¬¡ | æ•°æ®æ’åº |
| `modules/views/history/logs/logs.js` | 4 æ¬¡ | æ•°æ®å¤„ç†å’Œè¿‡æ»¤ |
| `modules/views/history/sessions/sync-sessions.js` | 2 æ¬¡ | æ•°æ®è¿‡æ»¤ |
| `modules/views/components/tags/tag-selector-view.js` | 4 æ¬¡ | æ•°æ®æ’åºå’Œå»é‡ |
| `modules/views/instances/statistics.js` | 3 æ¬¡ | æ•°æ®åˆ†ç»„å’Œæ’åº |
| `modules/views/components/tags/tag-selector-controller.js` | 2 æ¬¡ | æ•°æ®æ’åº |

**æ³¨æ„**: è¿™äº›æ–‡ä»¶ä¸»è¦ä½¿ç”¨ LodashUtils çš„å…¶ä»–æ–¹æ³•ï¼ˆå¦‚ orderBy, groupBy ç­‰ï¼‰ï¼Œä½†éƒ½å¯ä»¥è®¿é—® debounce å’Œ throttleã€‚

---

### 4. setTimeout å»¶è¿Ÿæ‰§è¡Œï¼ˆéé˜²æŠ–/èŠ‚æµï¼‰

ä»¥ä¸‹æ˜¯ä½¿ç”¨ `setTimeout` çš„åœºæ™¯ï¼Œä½†**ä¸æ˜¯é˜²æŠ–æˆ–èŠ‚æµ**ï¼Œè€Œæ˜¯ç®€å•çš„å»¶è¿Ÿæ‰§è¡Œï¼š

#### é¡µé¢åˆ·æ–°å»¶è¿Ÿ
```javascript
// modules/views/instances/modals/batch-create-modal.js:138
setTimeout(() => global.location.reload(), 1000);

// modules/views/instances/list.js:686
setTimeout(() => location.reload(), 1000);

// modules/views/tags/index.js:301
global.setTimeout(() => global.location.reload(), 1000);

// modules/views/dashboard/overview.js:183
global.setTimeout(() => {
  global.location.reload();
}, 1000);
```

#### é€šçŸ¥è‡ªåŠ¨æ¶ˆå¤±
```javascript
// modules/views/instances/statistics.js:353
global.setTimeout(() => {
  if (notification.parentNode) {
    notification.remove();
  }
}, 3000);

// modules/views/dashboard/overview.js:267
global.setTimeout(() => {
  if (notification.parentNode) {
    notification.remove();
  }
}, 3000);
```

#### åˆå§‹åŒ–å»¶è¿Ÿ
```javascript
// modules/views/capacity-stats/instance_aggregations.js:36
setTimeout(initManager, 50);

// modules/views/capacity-stats/database_aggregations.js:40
setTimeout(initManager, 50);

// modules/views/admin/partitions/charts/partitions-chart.js:729
window.setTimeout(initManager, 100);
```

#### UI æ›´æ–°å»¶è¿Ÿ
```javascript
// modules/views/instances/detail.js:282
setTimeout(() => {
  loadDatabaseSizes();
}, 1000);

// modules/views/tags/batch_assign.js:324
setTimeout(() => {
  if (content.scrollHeight > content.clientHeight) {
    content.style.overflowY = 'auto';
  }
}, 0);
```

---

## ğŸ¯ å»ºè®®

### 1. ç»Ÿä¸€ä½¿ç”¨ LodashUtils

**å½“å‰çŠ¶æ€**: âœ… å·²ç»åšå¾—å¾ˆå¥½
- é¡¹ç›®å·²ç»å°è£…äº† `LodashUtils`
- `filter-card.js` ä¼˜å…ˆä½¿ç”¨ Lodashï¼Œæœ‰ fallback

### 2. å¯ä»¥è€ƒè™‘æ·»åŠ çš„åœºæ™¯

ä»¥ä¸‹åœºæ™¯å¯èƒ½å—ç›Šäºé˜²æŠ–/èŠ‚æµï¼š

#### æœç´¢æ¡†è¾“å…¥ï¼ˆå¦‚æœæœ‰ï¼‰
```javascript
// å»ºè®®ä½¿ç”¨é˜²æŠ–
const searchInput = document.querySelector('#search');
const handleSearch = LodashUtils.debounce((e) => {
  // æœç´¢é€»è¾‘
}, 300);
searchInput.addEventListener('input', handleSearch);
```

#### çª—å£è°ƒæ•´å¤§å°
```javascript
// å»ºè®®ä½¿ç”¨èŠ‚æµ
const handleResize = LodashUtils.throttle(() => {
  // é‡æ–°è®¡ç®—å¸ƒå±€
}, 200);
window.addEventListener('resize', handleResize);
```

#### æ»šåŠ¨äº‹ä»¶
```javascript
// å»ºè®®ä½¿ç”¨èŠ‚æµ
const handleScroll = LodashUtils.throttle(() => {
  // æ£€æŸ¥æ»šåŠ¨ä½ç½®
}, 100);
window.addEventListener('scroll', handleScroll);
```

### 3. ä»£ç è´¨é‡

**ä¼˜ç‚¹**:
- âœ… æœ‰ç»Ÿä¸€çš„ LodashUtils å°è£…
- âœ… filter-card.js æœ‰ fallback æœºåˆ¶
- âœ… ä»£ç ç»“æ„æ¸…æ™°

**å¯æ”¹è¿›**:
- è€ƒè™‘å°†æ‰‹å†™çš„é˜²æŠ–å®ç°æå–åˆ°ç‹¬ç«‹çš„å·¥å…·å‡½æ•°
- ä¸ºå¸¸è§åœºæ™¯ï¼ˆæœç´¢ã€æ»šåŠ¨ï¼‰æä¾›é¢„é…ç½®çš„é˜²æŠ–/èŠ‚æµå‡½æ•°

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### æ¨èçš„å·¥å…·å‡½æ•°å°è£…

```javascript
// app/static/js/common/performance-utils.js
(function (window) {
  "use strict";

  const LodashUtils = window.LodashUtils;

  const PerformanceUtils = {
    // æœç´¢é˜²æŠ–ï¼ˆ300msï¼‰
    debounceSearch: (fn) => {
      return LodashUtils?.debounce 
        ? LodashUtils.debounce(fn, 300)
        : fn;
    },

    // è¾“å…¥é˜²æŠ–ï¼ˆ500msï¼‰
    debounceInput: (fn) => {
      return LodashUtils?.debounce 
        ? LodashUtils.debounce(fn, 500)
        : fn;
    },

    // æ»šåŠ¨èŠ‚æµï¼ˆ100msï¼‰
    throttleScroll: (fn) => {
      return LodashUtils?.throttle 
        ? LodashUtils.throttle(fn, 100)
        : fn;
    },

    // çª—å£è°ƒæ•´èŠ‚æµï¼ˆ200msï¼‰
    throttleResize: (fn) => {
      return LodashUtils?.throttle 
        ? LodashUtils.throttle(fn, 200)
        : fn;
    },
  };

  window.PerformanceUtils = Object.freeze(PerformanceUtils);
})(window);
```

---

## ğŸ“Š ç»Ÿè®¡æ€»ç»“

| é¡¹ç›® | æ•°é‡ |
|-----|------|
| æ‰‹å†™é˜²æŠ–å®ç° | 1 ä¸ª |
| Lodash å°è£… | 1 ä¸ªï¼ˆdebounce + throttleï¼‰ |
| ä½¿ç”¨ LodashUtils çš„æ–‡ä»¶ | 10+ ä¸ª |
| setTimeout å»¶è¿Ÿæ‰§è¡Œ | 15+ å¤„ |
| **éœ€è¦æ·»åŠ é˜²æŠ–/èŠ‚æµçš„åœºæ™¯** | å¾…è¯„ä¼° |

---

*æœ€åæ›´æ–°: 2025-11-18*
