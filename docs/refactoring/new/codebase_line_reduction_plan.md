# 代码体量削减重构方案（基于 2025-12-17 基线）

> 目标是“在功能完全等价的前提下减少 `app/` 目录代码行数”，而不是通过删功能、删校验或复制粘贴迁移来“做数字”。  
> 参考材料：`docs/reports/代码分析文档.md` 用于模块定位与大文件清单；本计划的行数与重复度以 2025-12-17 本地统计结果为准（见附录命令）。

## 1. 当前基线（2025-12-17）

### 1.1 统计口径与数据来源
- **行数口径**：仅统计 `app/` 下 `.py/.js/.css/.html/.yaml/.yml` 的总行数。
- **排除项**：`app/static/vendor`、`__pycache__`、`.git`、`node_modules`。
- **统计命令**：`python3 scripts/code/analyze_code.py app --exclude vendor __pycache__ .git node_modules`。
- **重复度口径**：`jscpd` 默认阈值（`min-lines=5`、`min-tokens=50`）统计重复行占比。

### 1.2 代码规模（按文件类型）
| 文件类型 | 文件数 | 行数 | 占比(按行数) |
| --- | ---: | ---: | ---: |
| Python (`.py`) | 219 | 48,947 | 50.9% |
| JavaScript (`.js`) | 107 | 34,875 | 36.3% |
| CSS (`.css`) | 40 | 6,326 | 6.6% |
| HTML (`.html`) | 47 | 5,791 | 6.0% |
| YAML (`.yaml/.yml`) | 3 | 235 | 0.2% |
| **合计（`app/`）** | **416** | **96,174** | **100%** |

### 1.3 目录分布（按行数排序）
| 目录 | 文件数 | 行数 | 占 `app/` |
| --- | ---: | ---: | ---: |
| `app/static/js` | 107 | 34,875 | 36.3% |
| `app/services` | 84 | 20,279 | 21.1% |
| `app/routes` | 36 | 12,168 | 12.7% |
| `app/templates` | 47 | 5,791 | 6.0% |
| `app/utils` | 21 | 5,499 | 5.7% |
| `app/static/css` | 40 | 6,326 | 6.6% |
| `app/models` | 20 | 3,184 | 3.3% |
| `app/tasks` | 6 | 2,198 | 2.3% |
| `app/types` | 11 | 803 | 0.8% |

### 1.4 体量热点（Top 20 文件，按行数）
> 用于“先攻最肥”的拆解与抽象优先级，不要求一次性重写全部。

| 排名 | 文件 | 行数 |
| ---: | --- | ---: |
| 1 | `app/static/js/modules/views/instances/list.js` | 1,318 |
| 2 | `app/static/js/modules/views/instances/detail.js` | 1,207 |
| 3 | `app/services/accounts_sync/adapters/sqlserver_adapter.py` | 1,199 |
| 4 | `app/static/js/modules/views/accounts/ledgers.js` | 1,081 |
| 5 | `app/static/js/modules/views/history/sessions/sync-sessions.js` | 1,055 |
| 6 | `app/services/aggregation/aggregation_service.py` | 1,012 |
| 7 | `app/static/js/modules/views/credentials/list.js` | 1,011 |
| 8 | `app/services/accounts_sync/permission_manager.py` | 967 |
| 9 | `app/static/js/modules/views/tags/batch-assign.js` | 957 |
| 10 | `app/static/js/modules/views/components/charts/manager.js` | 937 |
| 11 | `app/static/js/modules/views/accounts/account-classification/permissions/permission-policy-center.js` | 937 |
| 12 | `app/static/js/modules/views/admin/scheduler/index.js` | 874 |
| 13 | `app/routes/accounts/classifications.py` | 867 |
| 14 | `app/services/partition_management_service.py` | 807 |
| 15 | `app/tasks/capacity_aggregation_tasks.py` | 804 |
| 16 | `app/static/js/modules/views/tags/index.js` | 789 |
| 17 | `app/routes/instances/detail.py` | 780 |
| 18 | `app/tasks/capacity_collection_tasks.py` | 758 |
| 19 | `app/routes/instances/manage.py` | 753 |
| 20 | `app/routes/partition.py` | 745 |

### 1.5 代码重复度基线（必须长期 ≤5%）
- 当前基线（2025-12-17）：`npx -y jscpd app --format python,javascript,html,css --reporters console --silent --ignore "**/static/vendor/**"`  
  结果：**3.57% duplicated lines**（2,920 行重复）。
- 硬门禁：重构任意阶段 **不得超过 5%**；发现重复块优先“抽共享”而不是“复制粘贴”。

## 2. 目标与硬约束

### 2.1 行数削减目标（以 `app/` 为准）
- **目标（Target）**：净减少 **≥25%**（约 24,000 行），将 `app/` 从 **96,174** 降到 **≤72,000**。
- **挑战（Stretch）**：净减少 **≥30%**（约 28,800 行），将 `app/` 降到 **≤67,500**。
- 说明：允许短期“先增后减”（先引入工厂/基座，再迁移删除旧代码），但每个阶段收口时必须回到下降趋势。

### 2.2 不可违背的硬约束
1. **功能完全等价**：API 输入/输出、权限、审计日志、页面交互保持不变；如新增配置项必须默认等价。
2. **重复度上限**：`jscpd` 统计重复行占比 **≤5%**（拒绝复制粘贴式迁移）。
3. **路由异常模板**：Flask 路由必须通过 `app/utils/route_safety.py:safe_route_call` 执行业务闭包；禁止新写 `try/except Exception` 模板。
4. **类型治理**：共享结构必须沉淀到 `app/types/`，避免在业务模块内临时声明 `dict[str, Any]` 结构。
5. **前端与样式约束**：禁止新增移动端 `@media` 适配；`filter_card` 控件必须使用 `col-md-2 col-12`；颜色必须来自 `app/static/css/variables.css` 或既有 token。
6. **质量门禁**：重构过程中必须持续保持 `make format`、`make quality`、`npx pyright --warnings app`、`npm run lint:js`、`pytest` 可通过。

## 3. 缩减方案总览（按 ROI 排序）
> “预计净削减”是以基线统计估算的区间值，包含“引入抽象的新增行数”后的净值。

| 方案 | 覆盖范围（基线） | 预计净削减 | 可行性 | 达成概率 | 主要风险 |
| --- | --- | ---: | --- | ---: | --- |
| A. 前端页面工厂化（Grid/List 体系） | `app/static/js`（34,875） | 8,000 ~ 12,000 | 中-高 | 70% | 抽象过度、页面差异导致回归 |
| B. 前端 Store/事件/请求骨架统一 | `app/static/js/modules/stores`（4,738）+ 页面初始化模板 | 1,500 ~ 3,000 | 高 | 80% | 状态流转变更引发边界 bug |
| C. 账户同步适配器“表驱动/元数据化” | `app/services/accounts_sync`（5,089） | 1,500 ~ 3,000 | 中 | 65% | SQL 语义差异、跨库兼容回归 |
| D. 路由层薄化（解析/分页/统一响应） | `app/routes`（12,168） | 1,000 ~ 2,000 | 高 | 80% | 响应细节不一致、权限校验漏项 |
| E. `form_service` 服务基座抽取 | `app/services/form_service`（2,401） | 600 ~ 1,200 | 中 | 70% | 表单校验/权限审计细节回归 |
| F. 模板宏与组件块复用 | `app/templates`（5,791） | 300 ~ 900 | 高 | 85% | 宏参数不一致导致页面渲染差异 |
| G. 工具与校验去重（utils 聚合） | `app/utils`（5,499） | 400 ~ 1,200 | 中-高 | 75% | 兼容性与导入循环风险 |
| H. 缓冲/兜底（仅在缺口时启用） | `app/tasks`（2,198）等零散热点 | 500 ~ 1,500 | 中 | 60% | 需要较多回归验证，收益不稳定 |

## 4. 方案细化（含可行性与概率预测）

### A. 前端页面工厂化（Grid/List 体系）
**适用范围（现状）**
- `app/static/js/modules/views`：24,299 行 / 48 文件，存在大量“页面挂载 + 服务初始化 + 筛选卡片 + Grid + 工具栏动作 + 订阅 store”的重复骨架。
- Top 文件集中在 list/detail 页面（实例、凭据、历史、标签、调度器等）。

**实施要点（建议拆分为 4 个可控里程碑）**
1. 抽取“页面挂载生命周期”骨架：统一 `ready()`、全局依赖检查、错误兜底、销毁流程（避免每个页面重复 `global.xxx` 检测与 return）。
2. 抽取 Grid 规范化层：列定义、排序/分页、批量选择、统一空态/加载态、统一错误展示。
3. 抽取 FilterCard 规范化层：筛选项声明式配置，强制 `col-md-2 col-12` 栅格，默认行为对齐现状。
4. 引入“逃生舱（escape hooks）”：允许页面保留少量自定义逻辑（例如自定义 cell renderer、复杂批量动作、异步联动筛选）。

**预计净削减（依据基线）**
- 目标对象：优先迁移 Top 15（≥700 行）页面/组件（合计 13,875 行），按“平均压缩 45%~60%”估算可净减 **6,000~8,000 行**。
- 扩展对象：再迁移 10~15 个中等页面（400~700 行区间），净减 **2,000~4,000 行**。
- 抵消项：工厂/基座新增代码（约 800~1,500 行），已计入净值区间。

**可行性分析**
- 有利因素：前端目前是“自研组件 + 重复骨架”，抽象空间大；目录结构已模块化（`modules/views`、`modules/stores`）。
- 制约因素：页面差异可能大（例如实例详情、权限策略中心、图表管理器）；抽象过度会把复杂性转移到配置里，反而难维护。

**可能性预测**
- 达成 **8,000 行以上净削减**：概率约 **70%**（前提是按“先迁移 1~2 个典型页面验证可抽象度”迭代推进）。
- 达成 **12,000 行以上净削减**：概率约 **45%**（需要覆盖更多页面且保持抽象不过度）。

**对重复度的影响**
- 预期 **下降或持平**（抽共享模块替代复制粘贴）；若出现“配置碎片化 + 多份近似实现”，重复度会回升，必须通过 `jscpd` 门禁阻断。

**验证与回滚**
- 每迁移一个页面：提供“旧实现 vs 新实现”的功能回归清单（筛选、分页、批量、权限、导出、异常提示）。
- 回滚策略：保留旧入口脚本，允许切回（但在最终收口阶段必须删除旧实现，否则不计入净削减）。

### B. 前端 Store/事件/请求骨架统一
**适用范围（现状）**
- `app/static/js/modules/stores`：4,738 行 / 11 文件；页面层普遍存在“订阅 emitter + 状态同步 + 批量选择”模板代码。

**实施要点**
1. 定义统一的 store 基座：标准化 `init/load/update/subscribe/dispose` 的生命周期与事件名称。
2. 统一 `httpU`/请求错误处理：统一 loading、toast、重试策略与错误消息格式。
3. 统一“批量选择/checkbox 委托”能力，减少每页重复实现。

**预计净削减**
- 净减 **1,500~3,000 行**（来自 store 模板与页面订阅模板的去重，新增基座行数已抵扣）。

**可行性分析**
- 有利因素：store 目录集中、职责明确，且重复模式高度一致（初始化/订阅/更新/销毁）。
- 制约因素：部分页面可能绕过 store 直接操作 DOM 或缓存，迁移时需要逐页补齐“隐式依赖”清单。

**可能性预测**
- 达成 **≥1,500 行净削减**：概率约 **80%**。
- 达成 **≥3,000 行净削减**：概率约 **55%**（依赖于页面是否愿意统一生命周期与错误处理）。

**对重复度的影响**
- 预期下降（重复模板转为共享基座）。

**验证重点**
- 页面级订阅是否可完整释放（防止重复绑定/内存泄漏导致的行为回归）。
- 批量选择/checkbox 委托是否在翻页、筛选、刷新后保持一致。
- 统一错误提示与重试策略是否覆盖现有边界（例如 401、403、网络超时、部分失败）。

### C. 账户同步适配器“表驱动/元数据化”
**适用范围（现状）**
- `app/services/accounts_sync`：5,089 行 / 14 文件，其中 adapters 目录 2,800 行 / 7 文件，存在多数据库类型的 SQL 逻辑与字段映射重复。

**实施要点**
1. 定义 `AdapterMetadata`：字段映射、SQL 片段、差异 hook（仅暴露“差异”，不允许在各 adapter 内复制大段相同 SQL）。
2. 抽取统一渲染器：SQL 模板渲染、参数绑定、分页/增量同步通用逻辑。
3. 建立“金样测试”：同一组输入（账户/权限/对象）对不同数据库 adapter 的输出结构保持一致（差异仅体现在 metadata）。

**预计净削减**
- 净减 **1,500~3,000 行**（主要来自 `sqlserver/postgresql/mysql` adapter 的公共逻辑合并，以及部分 permission 处理的抽共享）。

**可行性分析**
- 有利因素：适配器模式天然适合元数据化；当前最大的文件就是 `sqlserver_adapter.py`（1,199 行）。
- 制约因素：不同数据库对系统表、权限语义差异大，抽象层必须允许差异存在，不能强行统一导致错误。

**可能性预测**
- 达成 **≥1,500 行净削减**：概率约 **65%**。
- 达成 **≥3,000 行净削减**：概率约 **40%**（需要进一步压缩 `permission_manager` 并保证语义一致）。

**对重复度的影响**
- 预期下降（同类 SQL/映射收敛到 metadata）；若把差异写成多份“近似 SQL”，重复度会被 `jscpd` 捕获并阻断。

### D. 路由层薄化（解析/分页/统一响应）
**适用范围（现状）**
- `app/routes`：12,168 行 / 36 文件，存在重复的分页参数解析、查询筛选、统一成功响应、权限装饰器组合等模板代码。

**实施要点**
1. 建立通用请求解析器：分页/排序/搜索参数解析统一（与现有参数完全兼容）。
2. 建立统一响应 helper：在 `app/utils/response_utils.py` 等集中封装“统一成功/统一失败”输出结构，减少各路由重复构造 dict。
3. 强制 safe route：所有路由业务闭包必须通过 `safe_route_call` 执行，并明确 `module/action/context`。

**预计净削减**
- 净减 **1,000~2,000 行**（以“模板代码去重”为主，避免改动核心业务逻辑）。

**可行性分析**
- 有利因素：路由层的重复主要来自“解析 + 权限 + 响应”模板，且可逐文件替换，不要求大爆炸改造。
- 制约因素：历史路由返回结构可能存在不一致（字段名、分页结构、错误码），需要先完成“契约冻结”再抽 helper。

**可能性预测**
- 达成 **≥1,000 行净削减**：概率约 **80%**。
- 达成 **≥2,000 行净削减**：概率约 **50%**（取决于能否统一更多蓝图的分页/筛选/响应契约）。

**验证重点**
- API 响应契约是否保持一致（字段名、分页元数据、错误码/提示文案）。
- 权限校验与事务边界是否遗漏（尤其是批量/删除/导入导出类接口）。
- `safe_route_call` 的 `module/action/context` 是否完整覆盖关键维度，便于结构化追踪。

### E. `form_service` 服务基座抽取
**适用范围（现状）**
- `app/services/form_service`：2,401 行；常见模式为“同结构 CRUD + 权限 + 审计 + 校验 + 错误映射”。

**实施要点**
1. 抽 `BaseFormService`：仅下沉稳定的 CRUD/审计/权限模板，差异点通过 hook 扩展。
2. 校验逻辑与类型结构沉淀：共享结构进入 `app/types/`，避免每个 service 重复定义输入 dict 形状。

**预计净削减**
- 净减 **600~1,200 行**（受现有 service 差异度影响较大）。

**可行性分析**
- 有利因素：`form_service` 的重复通常来自 CRUD 流程与审计/权限模板，适合用基座下沉。
- 制约因素：不同表单的字段校验、联动逻辑与权限细节差异可能较大，容易出现“抽象一半又不得不回填特例”。

**可能性预测**
- 达成 **≥600 行净削减**：概率约 **70%**（先试点 1 个重复度最高的 service）。
- 达成 **≥1,200 行净削减**：概率约 **35%**（需要多个 service 的差异度可被 hook 吸收）。

**验证重点**
- 表单校验与错误映射是否保持一致（尤其是前端依赖的字段级错误提示）。
- 权限/审计日志是否完整（新增、修改、删除的日志字段不丢失）。
- 与路由层结合是否仍满足 `safe_route_call` 约束与事务回滚要求。

### F. 模板宏与组件块复用
**适用范围（现状）**
- `app/templates`：5,791 行；已存在部分宏（例如 filters 宏），仍有“表格/弹窗/表单片段”在多个页面重复。

**实施要点**
1. 增补可复用宏/partial：表格行、批量操作栏、常见 modal 结构统一。
2. 确保前端脚本与模板契约一致（ID/data-attr 不变），避免“为了复用改 DOM 结构”造成 JS 大面积回归。

**预计净削减**
- 净减 **300~900 行**（收益不大但风险低，适合补齐缺口时做）。

**可行性分析**
- 有利因素：模板复用以“宏/partial 提取”为主，对后端逻辑影响极小，改动可控。
- 制约因素：模板与前端脚本通过 DOM 结构强耦合，宏抽取必须保持 ID、class、data-attr 不变。

**可能性预测**
- 达成 **≥300 行净削减**：概率约 **85%**。
- 达成 **≥900 行净削减**：概率约 **40%**（依赖于重复片段是否足够集中且参数差异可收敛）。

**验证重点**
- 页面渲染结构是否保持不变（避免 JS 选择器失效）。
- modal/表单组件的可访问性与默认值是否一致（提交/校验/关闭行为不回归）。

### G. 工具与校验去重（utils 聚合）
**适用范围（现状）**
- `app/utils`：5,499 行；包含校验、装饰器、日志、响应等通用能力，存在“相近 helper 在多处出现”的风险。

**实施要点**
1. 以“减少重复调用点”为目标，而不是“重写工具”：优先合并重复函数、统一入口，避免重构引入导入循环。
2. 校验/装饰器聚合：对 `data_validator.py`、`decorators.py` 等进行能力归并，避免多个模块提供相似校验。

**预计净削减**
- 净减 **400~1,200 行**（依赖于重复点的实际数量，建议先用 `rg` 定位最常复用片段）。

**可行性分析**
- 有利因素：utils 本质是“平台层”，抽取共享能直接降低全局重复与调用点复杂度。
- 制约因素：utils 容易成为“杂物间”，如果边界不清会引发导入循环与隐式依赖扩散。

**可能性预测**
- 达成 **≥400 行净削减**：概率约 **75%**。
- 达成 **≥1,200 行净削减**：概率约 **35%**（取决于重复点是否集中且可安全合并）。

**验证重点**
- 导入依赖方向是否稳定（避免循环导入与运行期懒加载违规）。
- 校验与装饰器行为是否完全等价（权限、CSRF、速率限制、输入清理等）。
- 结构化日志字段是否保持一致（避免追踪维度丢失）。

### H. 缓冲/兜底（只在缺口时启用）
**建议方向**
- `app/tasks`、零散服务与脚本中的模板代码（例如重复的日志/计时/失败处理）做轻量抽共享。
- 对超大文件做“功能聚类拆分 + 合并重复段”，避免单文件持续膨胀（拆分本身不减行数，但可为后续去重创造条件）。

**预计净削减**
- 净减 **500~1,500 行**（不确定性较高，作为补缺口使用）。

**可行性分析**
- 有利因素：任务/脚本类代码往往存在重复的日志、计时、异常处理模板，抽共享较直接。
- 制约因素：任务链路通常缺少完善测试，改动后需要更重的回归验证；且“拆分文件”本身不等价于“减少行数”。

**可能性预测**
- 达成 **≥500 行净削减**：概率约 **60%**。
- 达成 **≥1,500 行净削减**：概率约 **25%**（收益波动大，依赖于能否找到集中重复模板）。

**对重复度的影响**
- 预期持平或下降（抽共享后重复块减少）；若采用“复制粘贴微改”会直接推高重复度并被门禁阻断。

**验证重点**
- 任务是否仍在正确的 Flask `app_context()` 内执行（避免运行期 context 错误）。
- 失败回滚与日志记录是否保持一致（尤其是批量/导入导出类任务）。

## 5. 实施阶段（建议时间表）
| 阶段 | 时间范围 | 交付物 | 退出条件 |
| --- | --- | --- | --- |
| 基线与门禁 | 2025-12-17 ~ 2025-12-24 | 固化统计口径与门禁命令；完成 1 个页面工厂化试点（建议 `instances/list`） | `jscpd≤5%` 且试点页面回归通过 |
| 主迁移阶段 | 2025-12-25 ~ 2026-01-21 | 批量迁移 Top 页面（≥10 个）；完成 store 基座落地；路由薄化覆盖核心蓝图 | `app/` 行数下降趋势明确（净减≥12k） |
| 收敛与补缺口 | 2026-01-22 ~ 2026-02-05 | 适配器元数据化、模板宏补齐、utils 去重；输出重构总结与对比报告 | 达成 Target（≤72k）或 Stretch（≤67.5k） |

## 6. 验收指标（必须量化）
1. **行数指标**：`app/` 由 96,174 降至 **≤72,000**（Target），或 **≤67,500**（Stretch）。
2. **重复度指标**：`jscpd` 重复行占比 **≤5%**（重构过程全程满足）。
3. **功能与质量**：`make format`、`make quality`、`npx pyright --warnings app`、`npm run lint:js`、`pytest` 全通过。
4. **关键业务回归清单**（至少覆盖）：实例 CRUD/批量/导出、账户同步（含权限采集）、容量统计图表、调度器管理、标签批量分配、权限策略中心。

## 7. 附录：建议统一使用的统计/门禁命令
- 行数统计：`python3 scripts/code/analyze_code.py app --exclude vendor __pycache__ .git node_modules --top 50`
- 重复度统计：`npx -y jscpd app --format python,javascript,html,css --reporters console --silent --ignore "**/static/vendor/**" --threshold 5`
