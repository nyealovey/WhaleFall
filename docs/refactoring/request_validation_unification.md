# è¯·æ±‚æ ¡éªŒä¸å‚æ•°ç»Ÿä¸€æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

**ç»Ÿä¸€ç°æœ‰æ ¡éªŒæœºåˆ¶ï¼Œä¸æ–°å¢åŠŸèƒ½**

1. **ç»Ÿä¸€æ•°æ®æ ¡éªŒ**ï¼šä½¿ç”¨ç°æœ‰çš„ `DataValidator` è¿›è¡Œé¢†åŸŸæ•°æ®æ ¡éªŒ
2. **ç»Ÿä¸€å¿…å¡«å­—æ®µæ£€æŸ¥**ï¼šä½¿ç”¨ç°æœ‰çš„ `@validate_json` è£…é¥°å™¨
3. **ç»Ÿä¸€æŸ¥è¯¢å‚æ•°**ï¼šè§„èŒƒåŒ–ç°æœ‰çš„å‚æ•°å‘½åå’Œé»˜è®¤å€¼
4. **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨ç°æœ‰çš„å…¨å±€é”™è¯¯å¤„ç†å™¨

## ğŸ“Š ç°æœ‰åŸºç¡€è®¾æ–½ï¼ˆå·²å®ç°ï¼‰

### âœ… å¯ç”¨çš„è£…é¥°å™¨
| è£…é¥°å™¨ | åŠŸèƒ½ | çŠ¶æ€ |
|--------|------|------|
| `@validate_json(required_fields=[...])` | JSONæ ¼å¼å’Œå¿…å¡«å­—æ®µæ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `@login_required_json` | JSON APIç™»å½•æ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `@view_required` | æŸ¥çœ‹æƒé™æ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `@create_required` | åˆ›å»ºæƒé™æ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `@update_required` | æ›´æ–°æƒé™æ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `@delete_required` | åˆ é™¤æƒé™æ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `@admin_required` | ç®¡ç†å‘˜æƒé™æ ¡éªŒ | âœ… å®Œæ•´å®ç° |

### âœ… å¯ç”¨çš„æ•°æ®æ ¡éªŒå™¨
| æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `DataValidator.validate_instance_data()` | å®ä¾‹æ•°æ®æ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `DataValidator.validate_batch_data()` | æ‰¹é‡æ•°æ®æ ¡éªŒ | âœ… å®Œæ•´å®ç° |
| `DataValidator.sanitize_input()` | æ•°æ®æ¸…ç† | âœ… å®Œæ•´å®ç° |

### âœ… å¯ç”¨çš„é”™è¯¯å¤„ç†
- å…¨å±€é”™è¯¯å¤„ç†å™¨ï¼šç»Ÿä¸€è¿”å›æ ¼å¼
- è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼š`ValidationError`ã€`AuthenticationError`ã€`AuthorizationError`
- å¼‚å¸¸æŠ›å‡ºæœºåˆ¶ï¼šæ›¿ä»£å†…è”JSONè¿”å›

### âš ï¸ å½“å‰ä¸ä¸€è‡´çš„åœ°æ–¹

#### æŸ¥è¯¢å‚æ•°é»˜è®¤å€¼ä¸ç»Ÿä¸€
| è·¯ç”± | per_page é»˜è®¤å€¼ | éœ€è¦ç»Ÿä¸€ä¸º |
|------|----------------|-----------|
| instances, credentials, users | 10 | 20 |
| account, tags, sync_sessions | 20 | 20 âœ… |
| logs | 50 | 20 |

#### æœç´¢å‚æ•°å‘½åä¸ç»Ÿä¸€
| è·¯ç”± | å½“å‰ä½¿ç”¨ | éœ€è¦ç»Ÿä¸€ä¸º |
|------|---------|-----------|
| logs | `q` | `q` âœ… |
| å…¶ä»–è·¯ç”± | `search` | `q` |

#### è£…é¥°å™¨ä½¿ç”¨ä¸å®Œæ•´
- éƒ¨åˆ†JSONæ¥å£ç¼ºå°‘ `@validate_json` è£…é¥°å™¨
- éƒ¨åˆ†è·¯ç”±ä»ä½¿ç”¨å†…è” `jsonify({"error": "..."})` è€Œéå¼‚å¸¸æŠ›å‡º

## ğŸ“‹ ç»Ÿä¸€è§„èŒƒï¼ˆåŸºäºç°æœ‰å®ç°ï¼‰

### æŸ¥è¯¢å‚æ•°æ ‡å‡†
| å‚æ•° | ç”¨é€” | é»˜è®¤å€¼ | é™åˆ¶ |
|------|------|--------|------|
| `q` | æœç´¢å…³é”®å­— | `""` | - |
| `page` | é¡µç  | `1` | â‰¥ 1 |
| `per_page` | æ¯é¡µæ•°é‡ | `20` | 1-100 |
| `sort_by` | æ’åºå­—æ®µ | `created_at` | - |
| `order` | æ’åºæ–¹å‘ | `desc` | asc/desc |
| `status` | çŠ¶æ€ç­›é€‰ | `""` | - |
| `type` | ç±»å‹ç­›é€‰ | `""` | - |

### è·¯å¾„å‚æ•°æ ‡å‡†ï¼ˆå·²è§„èŒƒï¼‰
- `<int:instance_id>` - å®ä¾‹ID
- `<int:credential_id>` - å‡­æ®ID
- `<int:account_id>` - è´¦æˆ·ID
- `<int:user_id>` - ç”¨æˆ·ID

## ğŸ”„ ç»Ÿä¸€æ ¡éªŒæµç¨‹ï¼ˆä½¿ç”¨ç°æœ‰å·¥å…·ï¼‰

### ä¸‰å±‚æ ¡éªŒæœºåˆ¶
```
è¯·æ±‚ â†’ 1ï¸âƒ£ è£…é¥°å™¨æ ¡éªŒ â†’ 2ï¸âƒ£ æ•°æ®æ¸…ç† â†’ 3ï¸âƒ£ é¢†åŸŸæ ¡éªŒ â†’ ä¸šåŠ¡é€»è¾‘
         â†“                â†“              â†“
    ValidationError   sanitize_input  ValidationError
         â†“                              â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å…¨å±€é”™è¯¯å¤„ç†å™¨ â†â”€â”€â”˜
```

#### 1ï¸âƒ£ è£…é¥°å™¨æ ¡éªŒï¼ˆåŸºç¡€æ ¡éªŒï¼‰
- ä½¿ç”¨ `@validate_json(required_fields=[...])`
- æ£€æŸ¥ï¼šJSONæ ¼å¼ã€å¿…å¡«å­—æ®µå­˜åœ¨
- å¤±è´¥ï¼šæŠ›å‡º `ValidationError`

#### 2ï¸âƒ£ æ•°æ®æ¸…ç†
- ä½¿ç”¨ `DataValidator.sanitize_input(data)`
- å¤„ç†ï¼šå»é™¤ç©ºæ ¼ã€ç±»å‹è½¬æ¢ã€é»˜è®¤å€¼

#### 3ï¸âƒ£ é¢†åŸŸæ ¡éªŒï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰
- ä½¿ç”¨ `DataValidator.validate_instance_data(data)`
- æ£€æŸ¥ï¼šä¸šåŠ¡è§„åˆ™ã€æ•°æ®åˆæ³•æ€§
- å¤±è´¥ï¼šæŠ›å‡º `ValidationError`

### ç»Ÿä¸€é”™è¯¯è¿”å›æ ¼å¼
```json
{
  "error": "é”™è¯¯æè¿°ä¿¡æ¯",
  "status_code": 400,
  "timestamp": "2025-10-17T14:30:00+08:00"
}
```

## ğŸ’» æ ‡å‡†å®ç°æ¨¡æ¿

### JSONå†™æ¥å£ï¼ˆPOST/PUT/DELETEï¼‰
```python
from flask import request
from app.utils.decorators import validate_json, view_required
from app.utils.data_validator import DataValidator
from app.errors import ValidationError
from app.utils.response_utils import jsonify_unified_success

@validate_json(required_fields=["name", "db_type", "host", "port"])
@view_required
def create_instance_api():
    """åˆ›å»ºå®ä¾‹API - æ ‡å‡†å®ç°"""
    # è£…é¥°å™¨å·²ç¡®ä¿JSONæ ¼å¼å’Œå¿…å¡«å­—æ®µå­˜åœ¨
    data = request.get_json()
    
    # æ•°æ®æ¸…ç†
    data = DataValidator.sanitize_input(data)
    
    # ä¸¥æ ¼é¢†åŸŸæ ¡éªŒ
    is_valid, error_msg = DataValidator.validate_instance_data(data)
    if not is_valid:
        raise ValidationError(error_msg)  # æŠ›å‡ºå¼‚å¸¸ï¼Œç”±å…¨å±€é”™è¯¯å¤„ç†å™¨å¤„ç†
    
    # æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    # ... åˆ›å»ºå®ä¾‹é€»è¾‘ ...
    
    return jsonify_unified_success(message="å®ä¾‹åˆ›å»ºæˆåŠŸ")
```

### æŸ¥è¯¢æ¥å£ï¼ˆGETï¼‰
```python
from flask import request

@view_required
def list_instances_api():
    """å®ä¾‹åˆ—è¡¨API - ç»Ÿä¸€å‚æ•°å¤„ç†"""
    # åˆ†é¡µå‚æ•°ï¼ˆç»Ÿä¸€é»˜è®¤å€¼ï¼‰
    page = request.args.get("page", 1, type=int)
    per_page = min(request.args.get("per_page", 20, type=int), 100)  # ç»Ÿä¸€é»˜è®¤20ï¼Œæœ€å¤§100
    
    # æœç´¢å‚æ•°ï¼ˆå…¼å®¹ä¸¤ç§å‘½åï¼‰
    search = request.args.get("q", request.args.get("search", "")).strip()
    
    # æ’åºå‚æ•°
    sort_by = request.args.get("sort_by", "created_at")
    order = request.args.get("order", "desc")
    
    # ç­›é€‰å‚æ•°
    db_type = request.args.get("db_type", "")
    status = request.args.get("status", "")
    
    # å‚æ•°éªŒè¯
    if page < 1:
        raise ValidationError("é¡µç å¿…é¡»å¤§äº0")
    if order not in ["asc", "desc"]:
        raise ValidationError("æ’åºæ–¹å‘åªèƒ½æ˜¯ascæˆ–desc")
    
    # ... æ‰§è¡ŒæŸ¥è¯¢é€»è¾‘ ...
```

## ğŸ› ï¸ å·¥å…·ä½¿ç”¨æŒ‡å—

### è£…é¥°å™¨ä½¿ç”¨
```python
# JSONæ¥å£å¿…é¡»ä½¿ç”¨
@validate_json(required_fields=["name", "host"])
@create_required
def create_api():
    pass

# æŸ¥è¯¢æ¥å£ä½¿ç”¨
@view_required
def list_api():
    pass
```

### æ•°æ®æ ¡éªŒå™¨ä½¿ç”¨
```python
# 1. æ•°æ®æ¸…ç†
data = DataValidator.sanitize_input(data)

# 2. é¢†åŸŸæ ¡éªŒ
is_valid, error_msg = DataValidator.validate_instance_data(data)
if not is_valid:
    raise ValidationError(error_msg)
```

### é”™è¯¯å¤„ç†ä½¿ç”¨
```python
# âŒ ä¸è¦è¿™æ ·åš
if not data:
    return jsonify({"error": "æ•°æ®ä¸èƒ½ä¸ºç©º"}), 400

# âœ… åº”è¯¥è¿™æ ·åš
if not data:
    raise ValidationError("æ•°æ®ä¸èƒ½ä¸ºç©º")
```

## ğŸ“ ç»Ÿä¸€ä»»åŠ¡æ¸…å•

### ğŸ¯ ä¼˜å…ˆçº§1ï¼šæŸ¥è¯¢å‚æ•°ç»Ÿä¸€ï¼ˆå½±å“æœ€å¤§ï¼‰

#### ä»»åŠ¡1.1ï¼šç»Ÿä¸€ per_page é»˜è®¤å€¼
- [ ] `app/routes/instances.py` - æ”¹ä¸º20
- [ ] `app/routes/credentials.py` - æ”¹ä¸º20
- [ ] `app/routes/users.py` - æ”¹ä¸º20
- [ ] `app/routes/logs.py` - æ”¹ä¸º20
- [ ] æ·»åŠ æœ€å¤§å€¼100çš„é™åˆ¶

#### ä»»åŠ¡1.2ï¼šç»Ÿä¸€æœç´¢å‚æ•°ä¸º q
- [ ] æ£€æŸ¥æ‰€æœ‰ä½¿ç”¨ `search` çš„è·¯ç”±
- [ ] å…¼å®¹æ€§å¤„ç†ï¼š`q = request.args.get("q", request.args.get("search", ""))`
- [ ] é€æ­¥è¿ç§»å‰ç«¯è°ƒç”¨

### ğŸ¯ ä¼˜å…ˆçº§2ï¼šè£…é¥°å™¨è¡¥å……ï¼ˆæé«˜å®‰å…¨æ€§ï¼‰

#### ä»»åŠ¡2.1ï¼šè¡¥å…… @validate_json è£…é¥°å™¨
- [ ] æ‰«ææ‰€æœ‰ POST/PUT/DELETE æ¥å£
- [ ] ä¸ºç¼ºå°‘è£…é¥°å™¨çš„æ¥å£æ·»åŠ 
- [ ] éªŒè¯å¿…å¡«å­—æ®µåˆ—è¡¨æ˜¯å¦å®Œæ•´

#### ä»»åŠ¡2.2ï¼šè¡¥å……æƒé™è£…é¥°å™¨
- [ ] æ£€æŸ¥æ‰€æœ‰APIæ¥å£çš„æƒé™è£…é¥°å™¨
- [ ] è¡¥å……é—æ¼çš„æƒé™æ£€æŸ¥

### ğŸ¯ ä¼˜å…ˆçº§3ï¼šé”™è¯¯å¤„ç†ç»Ÿä¸€ï¼ˆæé«˜ä¸€è‡´æ€§ï¼‰

#### ä»»åŠ¡3.1ï¼šæ›¿æ¢å†…è”é”™è¯¯è¿”å›
- [ ] æœç´¢æ‰€æœ‰ `jsonify({"error": ...})`
- [ ] æ›¿æ¢ä¸º `raise ValidationError(...)`
- [ ] éªŒè¯é”™è¯¯ä¿¡æ¯å¯¹ç”¨æˆ·å‹å¥½

#### ä»»åŠ¡3.2ï¼šç»Ÿä¸€é”™è¯¯æ¶ˆæ¯
- [ ] æ£€æŸ¥æ‰€æœ‰é”™è¯¯æ¶ˆæ¯çš„æªè¾
- [ ] ç¡®ä¿é”™è¯¯æ¶ˆæ¯æ¸…æ™°ã€å‹å¥½

## âœ… éªŒæ”¶æ ‡å‡†

### ç»Ÿä¸€æ€§æ£€æŸ¥
- [ ] æ‰€æœ‰åˆ—è¡¨æ¥å£çš„ `per_page` é»˜è®¤å€¼ä¸º20ï¼Œæœ€å¤§å€¼100
- [ ] æ‰€æœ‰æœç´¢æ¥å£ä½¿ç”¨ `q` å‚æ•°ï¼ˆå…¼å®¹ `search`ï¼‰
- [ ] æ‰€æœ‰JSONå†™æ¥å£æœ‰ `@validate_json` è£…é¥°å™¨
- [ ] æ‰€æœ‰é”™è¯¯é€šè¿‡å¼‚å¸¸æŠ›å‡ºï¼Œæ— å†…è” `jsonify({"error": ...})`

### å…¼å®¹æ€§æ£€æŸ¥
- [ ] å‰ç«¯ç°æœ‰è°ƒç”¨ä¸å—å½±å“
- [ ] é”™è¯¯ä¿¡æ¯æ¸…æ™°å‹å¥½
- [ ] åˆ†é¡µæ˜¾ç¤ºæ­£å¸¸

### ä»£ç è´¨é‡æ£€æŸ¥
- [ ] æ— é‡å¤çš„æ ¡éªŒé€»è¾‘
- [ ] è£…é¥°å™¨ä½¿ç”¨æ­£ç¡®
- [ ] å¼‚å¸¸ç±»å‹ä½¿ç”¨æ°å½“

## âš ï¸ æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§ä¼˜å…ˆ
```python
# âœ… æ­£ç¡®ï¼šå…¼å®¹æ–°æ—§å‚æ•°
q = request.args.get("q", request.args.get("search", ""))

# âŒ é”™è¯¯ï¼šç›´æ¥æ”¹å˜å‚æ•°å
q = request.args.get("q", "")  # ä¼šç ´åç°æœ‰å‰ç«¯è°ƒç”¨
```

### æ¸è¿›å¼è¿ç§»
1. å…ˆæ·»åŠ æ–°å‚æ•°æ”¯æŒï¼Œä¿ç•™æ—§å‚æ•°
2. é€šçŸ¥å‰ç«¯æ›´æ–°è°ƒç”¨
3. ç¡®è®¤å‰ç«¯æ›´æ–°å®Œæˆåï¼Œå†ç§»é™¤æ—§å‚æ•°

### æµ‹è¯•éªŒè¯
- æ¯æ¬¡ä¿®æ”¹åæµ‹è¯•ç›¸å…³æ¥å£
- æ£€æŸ¥å‰ç«¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- éªŒè¯é”™è¯¯æç¤ºæ˜¯å¦å‹å¥½

## ğŸ“ æ¶‰åŠæ–‡ä»¶

### æ ¸å¿ƒå·¥å…·ï¼ˆä¸éœ€è¦ä¿®æ”¹ï¼‰
- âœ… `app/utils/decorators.py` - æ ¡éªŒè£…é¥°å™¨
- âœ… `app/utils/data_validator.py` - æ•°æ®æ ¡éªŒå™¨
- âœ… `app/utils/error_handler.py` - å…¨å±€é”™è¯¯å¤„ç†
- âœ… `app/errors.py` - è‡ªå®šä¹‰å¼‚å¸¸ç±»

### éœ€è¦ç»Ÿä¸€çš„è·¯ç”±æ–‡ä»¶
| æ–‡ä»¶ | per_page | æœç´¢å‚æ•° | è£…é¥°å™¨ | é”™è¯¯å¤„ç† |
|------|---------|---------|--------|---------|
| `instances.py` | âœ… 20 | âœ… q | âœ… | âœ… |
| `credentials.py` | âš ï¸ 10 | âš ï¸ search | âš ï¸ | âš ï¸ |
| `account.py` | âœ… 20 | âš ï¸ search | âš ï¸ | âš ï¸ |
| `logs.py` | âš ï¸ 50 | âœ… q | âš ï¸ | âš ï¸ |
| `users.py` | âš ï¸ 10 | âš ï¸ search | âš ï¸ | âš ï¸ |
| `tags.py` | âœ… 20 | âš ï¸ search | âš ï¸ | âš ï¸ |
| `sync_sessions.py` | âœ… 20 | âš ï¸ search | âš ï¸ | âš ï¸ |

## ğŸ“Š ç»Ÿä¸€è¿›åº¦è¿½è¸ª

### å½“å‰çŠ¶æ€
- âœ… åŸºç¡€è®¾æ–½å®Œæ•´ï¼š100%
- âš ï¸ å‚æ•°ç»Ÿä¸€ï¼š40%
- âš ï¸ è£…é¥°å™¨åº”ç”¨ï¼š60%
- âš ï¸ é”™è¯¯å¤„ç†ï¼š70%

### é¢„è®¡å·¥ä½œé‡
- æŸ¥è¯¢å‚æ•°ç»Ÿä¸€ï¼š2-3å°æ—¶
- è£…é¥°å™¨è¡¥å……ï¼š3-4å°æ—¶
- é”™è¯¯å¤„ç†ç»Ÿä¸€ï¼š2-3å°æ—¶
- æµ‹è¯•éªŒè¯ï¼š2-3å°æ—¶
- **æ€»è®¡**ï¼š9-13å°æ—¶

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025-10-17  
**ä¸‹æ¬¡æ£€æŸ¥**: å®Œæˆç»Ÿä¸€ä»»åŠ¡åæ›´æ–°è¿›åº¦