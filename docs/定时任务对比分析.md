
# 定时任务对比分析（账户同步对齐容量同步）

## 背景与目标
容量同步已经完成“两阶段 + 协调器”重构：先执行库存同步，再采集容量，过程中依赖统一的日志、统计以及会话治理，实现透明的观测能力。账户同步虽然引入了 `AccountSyncCoordinator`，但在任务入口的控制流、上下文管理、指标输出仍存在偏差。本文明确唯一的对齐路径，使账户同步定时任务完全复刻容量同步的运行方式。

## 容量同步任务基线
- 入口：`app.tasks.capacity_collection_tasks.collect_database_sizes`
- 控制流：建立连接 → 库存同步 → 容量采集并落库 → 关闭连接
- 上下文：
  - `create_app()` 与 `app.app_context()` 确保数据库会话可用
  - 每个实例执行前调用 `sync_session_service.start_instance_sync()`，执行成功后调用 `complete_instance_sync()`，出现异常时调用 `fail_instance_sync()`
  - 单次任务内始终贯穿同一个 `sync_session_id`，日志中附带 `session_id` 与 `instance_id`
- 日志与异常：所有阶段使用 `module="capacity_sync"`，在库存阶段失败立即写入失败记录，并标记 `phase="inventory"`
- 指标输出：`sync_details` 同时包含 `inventory` 与 `collection` 两块数据，字段包括 `created`、`refreshed`、`reactivated`、`deactivated`、`processed_records`、`saved_count`

## 账户同步任务现状
- 入口：`app.tasks.account_sync_tasks.sync_accounts`
- 控制流：建立连接 → `synchronize_inventory()` → `synchronize_permissions()` → 关闭连接
- 上下文差异：
  - 权限阶段仍以 `permissions` 命名，未与容量同步的 `collection` 对齐
  - 当库存阶段没有返回活跃账户时依旧执行权限阶段，`sync_details` 缺少 `status` 与 `skipped` 等字段
  - 日志上下文没有统一的 `phase` 与 `session_id`，难以沿用容量同步的告警配置
- 连接与资源：任务入口需要显式调用 `connect()` 与 `disconnect()`，缺乏统一的上下文写法

## 对齐要点
### 1. 上下文与控制流一致
- 在任务中使用 `with AccountSyncCoordinator(instance) as coordinator:` 管理连接生命周期，与容量同步保持完全一致
- 库存阶段返回的 `active_accounts` 为空时直接调用 `complete_instance_sync()`，同时在 `sync_details.collection` 中写入 `status="skipped"`
- 库存阶段与权限阶段分别写入 `phase="inventory"` 与 `phase="collection"`

### 2. 会话与指标结构统一
- `sync_session_service.complete_instance_sync()` 的字段含义与容量同步相同：
  - `items_created` 对应新增账户数量
  - `items_updated` 对应权限更新数量
  - `items_deleted` 对应停用账户数量
  - `items_synced` 对应权限阶段成功处理的账户数量
- `sync_details` 结构固定为 `{"inventory": {...}, "collection": {...}}`，两个阶段均写入 `status/completed/skipped/failed`、`processed_records` 以及 `created`、`refreshed`、`reactivated`、`deactivated`
- 权限阶段失败时调用 `fail_instance_sync()`，同时在 `sync_details.collection.status` 写入 `failed`

### 3. 日志、错误与上下文字段
- 日志统一使用 `module="account_sync"`，并包含 `session_id`、`instance_id`、`phase`
- 连接失败、库存失败、权限失败的日志键值沿用容量同步的命名模式，例如 `account_sync_connection_failed`、`account_sync_inventory_failed`
- 通过 `sync_logger.info` 与 `sync_logger.error` 输出结构化日志，字段命名与容量同步保持一致，方便现有解析脚本复用

### 4. 配置与调度
- `app/config/scheduler_tasks.yaml` 中的账户同步任务使用与容量同步一致的命名规则，并在调度列表中明确运行窗口
- `app/scheduler.py` 的兜底逻辑引用相同的任务标识，避免调度配置产生偏移

## 实施步骤
1. **上下文改造**：为 `AccountSyncCoordinator` 实现上下文管理接口；在任务入口采用 `with` 写法，统一连接的开启与释放
2. **阶段短路与状态输出**：库存阶段无活跃账户时直接返回完成结果，在 `sync_details.collection` 写入 `skipped` 状态
3. **同步会话字段对齐**：调整 `complete_instance_sync()` 的参数映射，统一字段语义，同时构造与容量同步一致的 `sync_details`
4. **日志与错误对齐**：修改日志字段、错误键值和异常处理流程，使其与容量同步完全一致
5. **测试与验证**：编写针对空账户、权限失败、连接失败的测试用例；执行 `pytest -m unit -k account_sync` 并进行一次手动任务验证日志与 `sync_session` 记录

经过上述步骤，账户同步定时任务在上下文处理、阶段控制、日志与指标输出方面将完整复用容量同步的成熟经验，实现统一的运维与监控体验。
