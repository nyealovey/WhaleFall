# TaifishingV4 å‡½æ•°æ–‡æ¡£

## ğŸ“– æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºäº† TaifishingV4 é¡¹ç›®ä¸­ `app` ç›®å½•ä¸‹ï¼ˆ`routes` ç›®å½•é™¤å¤–ï¼‰çš„æ ¸å¿ƒå‡½æ•°ï¼ŒæŒ‰ç…§åŠŸèƒ½æ¨¡å—è¿›è¡Œåˆ†ç±»ï¼Œæ—¨åœ¨æä¾›æ¸…æ™°çš„å‡½æ•°åŠŸèƒ½ã€å‚æ•°å’Œè¿”å›å€¼è¯´æ˜ã€‚

---

## 1. `app/utils/api_response.py`

è¯¥æ¨¡å—æä¾›äº†ä¸€è‡´çš„ API å“åº”æ ¼å¼ï¼ŒåŒ…å«æˆåŠŸå’Œå¤±è´¥ä¸¤ç§å“åº”ç±»å‹ã€‚

| å‡½æ•°/æ–¹æ³• | æè¿° | å‚æ•° | è¿”å›å€¼ |
|-----------|------|------|----------|
| `APIResponse.success(data, message)` | åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„æˆåŠŸ API å“åº”ã€‚ | `data` (Any, optional): å“åº”æ•°æ®ã€‚<br>`message` (str, optional): æˆåŠŸæ¶ˆæ¯ï¼Œé»˜è®¤ä¸º "æ“ä½œæˆåŠŸ"ã€‚ | `Response` (JSON): åŒ…å« `success: True` çš„å“åº”å¯¹è±¡ã€‚ |
| `APIResponse.error(message, code, data)` | åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„é”™è¯¯ API å“åº”ã€‚ | `message` (str, optional): é”™è¯¯æ¶ˆæ¯ï¼Œé»˜è®¤ä¸º "æ“ä½œå¤±è´¥"ã€‚ <br>`code` (int, optional): HTTP çŠ¶æ€ç ï¼Œé»˜è®¤ä¸º 400ã€‚<br>`data` (Any, optional): é¢å¤–çš„é”™è¯¯æ•°æ®ã€‚ | `Response` (JSON): åŒ…å« `success: False` å’Œé”™è¯¯ä¿¡æ¯çš„å“åº”å¯¹è±¡ã€‚ |
| `success_response(data, message)` | `APIResponse.success` çš„ä¾¿æ·å‡½æ•°ã€‚ | åŒ `APIResponse.success`ã€‚ | `APIResponse` å¯¹è±¡ã€‚ |
| `error_response(message, code, data)` | `APIResponse.error` çš„ä¾¿æ·å‡½æ•°ã€‚ | åŒ `APIResponse.error`ã€‚ | `APIResponse` å¯¹è±¡ã€‚ |

---

## 2. `app/utils/cache_manager.py`

è¯¥æ¨¡å—æä¾›äº†ä¸€ä¸ªé€šç”¨çš„ç¼“å­˜ç®¡ç†å·¥å…·ï¼ŒåŒ…æ‹¬ä¸€ä¸ª `CacheManager` ç±»ã€ç¼“å­˜è£…é¥°å™¨å’Œå¤šç§ç¼“å­˜ç®¡ç†å‡½æ•°ï¼Œç”¨äºæå‡åº”ç”¨æ€§èƒ½ã€‚

### `CacheManager` ç±»
| æ–¹æ³• | æè¿° | å‚æ•° | è¿”å›å€¼ |
|------|------|------|----------|
| `__init__(cache)` | åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨ã€‚ | `cache` (Cache): Flask-Caching å®ä¾‹ã€‚ | `None` |
| `_generate_key(prefix, *args, **kwargs)` | æ ¹æ®å‰ç¼€å’Œå‚æ•°ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ SHA256 å“ˆå¸Œç¼“å­˜é”®ã€‚ | `prefix` (str): ç¼“å­˜é”®å‰ç¼€ã€‚<br>`*args`, `**kwargs`: å‡½æ•°çš„å‚æ•°ã€‚ | `str`: ç”Ÿæˆçš„ç¼“å­˜é”®ã€‚ |
| `get(key)` | ä»ç¼“å­˜ä¸­è·å–ä¸€ä¸ªå€¼ã€‚ | `key` (str): ç¼“å­˜é”®ã€‚ | `Any | None`: ç¼“å­˜çš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–å‡ºé”™åˆ™ä¸º `None`ã€‚ |
| `set(key, value, timeout)` | åœ¨ç¼“å­˜ä¸­è®¾ç½®ä¸€ä¸ªå€¼ã€‚ | `key` (str): ç¼“å­˜é”®ã€‚<br>`value` (Any): è¦ç¼“å­˜çš„å€¼ã€‚<br>`timeout` (int, optional): è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ã€‚ | `bool`: æ“ä½œæ˜¯å¦æˆåŠŸã€‚ |
| `delete(key)` | ä»ç¼“å­˜ä¸­åˆ é™¤ä¸€ä¸ªå€¼ã€‚ | `key` (str): ç¼“å­˜é”®ã€‚ | `bool`: æ“ä½œæ˜¯å¦æˆåŠŸã€‚ |
| `clear()` | æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ã€‚ | æ— ã€‚ | `bool`: æ“ä½œæ˜¯å¦æˆåŠŸã€‚ |
| `get_or_set(key, func, timeout, *args, **kwargs)` | è·å–ç¼“å­˜ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ‰§è¡Œå‡½æ•°ã€è®¾ç½®ç¼“å­˜å¹¶è¿”å›ç»“æœã€‚ | `key` (str): ç¼“å­˜é”®ã€‚<br>`func` (Callable): ç”¨äºç”Ÿæˆå€¼çš„å‡½æ•°ã€‚<br>`timeout` (int, optional): è¶…æ—¶æ—¶é—´ã€‚<br>`*args`, `**kwargs`: `func` çš„å‚æ•°ã€‚ | `Any`: ç¼“å­˜çš„æˆ–æ–°ç”Ÿæˆçš„å€¼ã€‚ |
| `invalidate_pattern(pattern)` | æ ¹æ®æ¨¡å¼åˆ é™¤ç¼“å­˜ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼Œå¦‚ Redisï¼‰ã€‚ | `pattern` (str): åŒ¹é…é”®çš„æ¨¡å¼ã€‚ | `int`: åˆ é™¤çš„é”®æ•°é‡ã€‚ |

### æ ¸å¿ƒå‡½æ•°å’Œè£…é¥°å™¨
| å‡½æ•°/è£…é¥°å™¨ | æè¿° | å‚æ•° | è¿”å›å€¼ |
|---------------|------|------|----------|
| `init_cache_manager(cache)` | åˆå§‹åŒ–å…¨å±€çš„ `cache_manager` å®ä¾‹ã€‚ | `cache` (Cache): Flask-Caching å®ä¾‹ã€‚ | `None` |
| `@cached(timeout, key_prefix, unless, key_func)` | ä¸€ä¸ªå‡½æ•°è£…é¥°å™¨ï¼Œç”¨äºç¼“å­˜å‡½æ•°æ‰§è¡Œç»“æœã€‚ | `timeout` (int): ç¼“å­˜è¶…æ—¶ç§’æ•°ã€‚<br>`key_prefix` (str): é”®å‰ç¼€ã€‚<br>`unless` (Callable, optional): å¦‚æœè¿”å› `True`ï¼Œåˆ™è·³è¿‡ç¼“å­˜ã€‚<br>`key_func` (Callable, optional): è‡ªå®šä¹‰é”®ç”Ÿæˆå‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@cache_invalidate(pattern)` | ä¸€ä¸ªå‡½æ•°è£…é¥°å™¨ï¼Œåœ¨å‡½æ•°æ‰§è¡Œåæ ¹æ®æ¨¡å¼ä½¿ç¼“å­˜å¤±æ•ˆã€‚ | `pattern` (str): åŒ¹é…é”®çš„æ¨¡å¼ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |

### ä¾¿æ·ç¼“å­˜è£…é¥°å™¨
| è£…é¥°å™¨ | æè¿° |
|---------|------|
| `@user_cache(timeout)` | ç”¨äºç”¨æˆ·ç›¸å…³ç¼“å­˜çš„é¢„è®¾è£…é¥°å™¨ã€‚ |
| `@instance_cache(timeout)` | ç”¨äºå®ä¾‹ç›¸å…³ç¼“å­˜çš„é¢„è®¾è£…é¥°å™¨ã€‚ |
| `@task_cache(timeout)` | ç”¨äºä»»åŠ¡ç›¸å…³ç¼“å­˜çš„é¢„è®¾è£…é¥°å™¨ã€‚ |
| `@dashboard_cache(timeout)` | ç”¨äºä»ªè¡¨æ¿ç›¸å…³ç¼“å­˜çš„é¢„è®¾è£…é¥°å™¨ã€‚ |
| `@api_cache(timeout)` | ç”¨äº API ç»“æœç¼“å­˜çš„é¢„è®¾è£…é¥°å™¨ã€‚ |

### ç¼“å­˜ç®¡ç†å‡½æ•°
| å‡½æ•° | æè¿° |
|------|------|
| `clear_user_cache(user_id)` | æ¸…é™¤æŒ‡å®šç”¨æˆ·çš„ç›¸å…³ç¼“å­˜ã€‚ |
| `clear_instance_cache(instance_id)` | æ¸…é™¤æŒ‡å®šå®ä¾‹çš„ç›¸å…³ç¼“å­˜ã€‚ |
| `clear_task_cache(task_id)` | æ¸…é™¤æŒ‡å®šä»»åŠ¡çš„ç›¸å…³ç¼“å­˜ã€‚ |
| `clear_dashboard_cache()` | æ¸…é™¤ä»ªè¡¨æ¿ç›¸å…³ç¼“å­˜ã€‚ |
| `clear_all_cache()` | æ¸…é™¤æ‰€æœ‰ç¼“å­˜ã€‚ |
| `get_cache_stats()` | è·å–ç¼“å­˜åç«¯çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ |
| `warm_up_cache()` | é¢„çƒ­ç¼“å­˜ï¼Œå°†å¸¸ç”¨æ•°æ®æå‰åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚ |

---

## 3. `app/utils/data_validator.py`

è¯¥æ¨¡å—æä¾›äº†ä¸€ä¸ª `DataValidator` ç±»ï¼Œç”¨äºå¯¹è¾“å…¥æ•°æ®è¿›è¡Œä¸¥æ ¼çš„éªŒè¯å’Œæ¸…ç†ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚

### `DataValidator` ç±»
| æ–¹æ³• | æè¿° | å‚æ•° | è¿”å›å€¼ |
|------|------|------|----------|
| `validate_instance_data(data)` | éªŒè¯å•ä¸ªå®ä¾‹çš„æ•°æ®ã€‚å®ƒä¼šæ£€æŸ¥æ‰€æœ‰å¿…å¡«å­—æ®µï¼Œå¹¶å¯¹åç§°ã€æ•°æ®åº“ç±»å‹ã€ä¸»æœºã€ç«¯å£ç­‰è¿›è¡Œè¯¦ç»†éªŒè¯ã€‚ | `data` (Dict): åŒ…å«å®ä¾‹æ•°æ®çš„å­—å…¸ã€‚ | `Tuple[bool, Optional[str]]`: ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«ä¸€ä¸ªå¸ƒå°”å€¼ï¼ˆè¡¨ç¤ºæ˜¯å¦æœ‰æ•ˆï¼‰å’Œä¸€æ¡é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæ— æ•ˆï¼‰ã€‚ |
| `validate_batch_data(data_list)` | æ‰¹é‡éªŒè¯æ•°æ®åˆ—è¡¨ã€‚ | `data_list` (List[Dict]): åŒ…å«å¤šä¸ªå®ä¾‹æ•°æ®çš„åˆ—è¡¨ã€‚ | `Tuple[List[Dict], List[str]]`: ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«éªŒè¯é€šè¿‡çš„æ•°æ®åˆ—è¡¨å’Œé”™è¯¯ä¿¡æ¯åˆ—è¡¨ã€‚ |
| `sanitize_input(data)` | æ¸…ç†è¾“å…¥æ•°æ®ï¼Œä¸»è¦é€šè¿‡å»é™¤å­—ç¬¦ä¸²å€¼çš„é¦–å°¾ç©ºæ ¼ã€‚ | `data` (Dict): åŸå§‹æ•°æ®å­—å…¸ã€‚ | `Dict`: æ¸…ç†åçš„æ•°æ®å­—å…¸ã€‚ |
| `_validate_name(name)` | éªŒè¯å®ä¾‹åç§°çš„æ ¼å¼ã€é•¿åº¦å’Œå…è®¸çš„å­—ç¬¦ã€‚ | `name` (Any): å®ä¾‹åç§°ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `_validate_db_type(db_type)` | éªŒè¯æ•°æ®åº“ç±»å‹æ˜¯å¦åœ¨æ”¯æŒçš„åˆ—è¡¨ä¸­ã€‚ | `db_type` (Any): æ•°æ®åº“ç±»å‹ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `_validate_host(host)` | éªŒè¯ä¸»æœºåœ°å€çš„æ ¼å¼ï¼ˆIP æˆ–åŸŸåï¼‰å’Œé•¿åº¦ã€‚ | `host` (Any): ä¸»æœºåœ°å€ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `_validate_port(port)` | éªŒè¯ç«¯å£å·æ˜¯å¦ä¸ºæœ‰æ•ˆèŒƒå›´å†…çš„æ•´æ•°ã€‚ | `port` (Any): ç«¯å£å·ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `_validate_database_name(db_name)` | éªŒè¯æ•°æ®åº“åç§°çš„æ ¼å¼å’Œé•¿åº¦ã€‚ | `db_name` (Any): æ•°æ®åº“åç§°ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `_validate_description(description)` | éªŒè¯æè¿°ä¿¡æ¯çš„é•¿åº¦ã€‚ | `description` (Any): æè¿°ä¿¡æ¯ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `_validate_credential_id(credential_id)` | éªŒè¯å‡­æ® ID æ˜¯å¦ä¸ºæ­£æ•´æ•°ã€‚ | `credential_id` (Any): å‡­æ® IDã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `_is_valid_host(host)` | æ£€æŸ¥ç»™å®šçš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ IP åœ°å€æˆ–åŸŸåã€‚ | `host` (str): ä¸»æœºå­—ç¬¦ä¸²ã€‚ | `bool`: å¦‚æœæœ‰æ•ˆåˆ™è¿”å› `True`ï¼Œå¦åˆ™è¿”å› `False`ã€‚ |

---

## 4. `app/utils/decorators.py`

è¯¥æ¨¡å—æä¾›äº†ä¸€ç³»åˆ— Flask è£…é¥°å™¨ï¼Œç”¨äºå¤„ç†è®¤è¯ã€æˆæƒã€æ•°æ®éªŒè¯å’Œé€Ÿç‡é™åˆ¶ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚

### æƒé™å’Œè®¤è¯è£…é¥°å™¨
| è£…é¥°å™¨ | æè¿° | å‚æ•° | è¿”å›å€¼ |
|---|---|---|---|
| `@admin_required` | ç¡®ä¿åªæœ‰ç®¡ç†å‘˜è§’è‰²çš„ç”¨æˆ·æ‰èƒ½è®¿é—®è¢«è£…é¥°çš„è·¯ç”±ã€‚å¦‚æœç”¨æˆ·æœªç™»å½•æˆ–ä¸æ˜¯ç®¡ç†å‘˜ï¼Œå°†é‡å®šå‘æˆ–è¿”å› 401/403 é”™è¯¯ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@scheduler_manage_required` | ç¡®ä¿åªæœ‰ç®¡ç†å‘˜æ‰èƒ½ç®¡ç†å®šæ—¶ä»»åŠ¡ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@scheduler_view_required` | å…è®¸ä»»ä½•å·²ç™»å½•çš„ç”¨æˆ·æŸ¥çœ‹å®šæ—¶ä»»åŠ¡çš„çŠ¶æ€ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@login_required` | ç¡®ä¿ç”¨æˆ·å·²ç™»å½•ã€‚å¦‚æœæœªç™»å½•ï¼Œåˆ™é‡å®šå‘åˆ°ç™»å½•é¡µé¢ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@login_required_json` | ä¸“ä¸º JSON API è®¾è®¡çš„ç™»å½•éªŒè¯è£…é¥°å™¨ã€‚å¦‚æœæœªç™»å½•ï¼Œè¿”å› 401 JSON é”™è¯¯ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@permission_required(permission)` | ä¸€ä¸ªé€šç”¨çš„æƒé™éªŒè¯è£…é¥°å™¨ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æŒ‡å®šçš„æƒé™ã€‚ | `permission` (str): æ‰€éœ€çš„æƒé™å­—ç¬¦ä¸²ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@view_required` | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ `view` æƒé™ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@create_required` | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ `create` æƒé™ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@update_required` | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ `update` æƒé™ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@delete_required` | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ `delete` æƒé™ã€‚ | `f` (Callable): è¢«è£…é¥°çš„å‡½æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |

### æ•°æ®éªŒè¯å’Œé€Ÿç‡é™åˆ¶
| è£…é¥°å™¨ | æè¿° | å‚æ•° | è¿”å›å€¼ |
|---|---|---|---|
| `@validate_json(required_fields)` | éªŒè¯è¿›å…¥çš„è¯·æ±‚æ˜¯å¦ä¸º JSON æ ¼å¼ï¼Œå¹¶å¯é€‰æ‹©æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…éœ€çš„å­—æ®µã€‚ | `required_fields` (List[str], optional): å¿…éœ€çš„å­—æ®µåˆ—è¡¨ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |
| `@rate_limit(requests_per_minute)` | ï¼ˆå½“å‰ä¸ºå ä½ç¬¦ï¼‰ç”¨äºé™åˆ¶ç”¨æˆ·è®¿é—®é€Ÿç‡çš„è£…é¥°å™¨ã€‚ | `requests_per_minute` (int): æ¯åˆ†é’Ÿå…è®¸çš„è¯·æ±‚æ•°ã€‚ | `Callable`: åŒ…è£…åçš„å‡½æ•°ã€‚ |

### è¾…åŠ©å‡½æ•°
| å‡½æ•° | æè¿° | å‚æ•° | è¿”å›å€¼ |
|---|---|---|---|
| `has_permission(user, permission)` | æ£€æŸ¥æŒ‡å®šç”¨æˆ·æ˜¯å¦æ‹¥æœ‰ç‰¹å®šæƒé™ã€‚ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚ | `user` (User): ç”¨æˆ·å¯¹è±¡ã€‚<br>`permission` (str): æƒé™åç§°ã€‚ | `bool`: å¦‚æœç”¨æˆ·æœ‰æƒé™ï¼Œåˆ™ä¸º `True`ã€‚ |

---

## 5. `app/utils/security.py`

è¯¥æ¨¡å—æä¾›äº†ä¸€ç³»åˆ—å®‰å…¨ç›¸å…³çš„å·¥å…·å‡½æ•°ï¼Œç”¨äºè¾“å…¥æ¸…ç†ã€æ•°æ®éªŒè¯å’Œé˜²èŒƒå¸¸è§çš„å®‰å…¨æ¼æ´ã€‚

### è¾“å…¥æ¸…ç†å’ŒéªŒè¯
| å‡½æ•° | æè¿° | å‚æ•° | è¿”å›å€¼ |
|---|---|---|---|
| `sanitize_input(value)` | æ¸…ç†ç”¨æˆ·è¾“å…¥ï¼Œé€šè¿‡ HTML è½¬ä¹‰å’Œç§»é™¤å±é™©å­—ç¬¦æ¥é˜²æ­¢ XSS æ”»å‡»ã€‚ | `value` (Any): åŸå§‹è¾“å…¥å€¼ã€‚ | `str`: æ¸…ç†åçš„å­—ç¬¦ä¸²ã€‚ |
| `validate_required_fields(data, required_fields)` | éªŒè¯ç»™å®šçš„æ•°æ®å­—å…¸ä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…éœ€çš„å­—æ®µã€‚ | `data` (Dict): è¡¨å•æ•°æ®ã€‚<br>`required_fields` (List[str]): å¿…å¡«å­—æ®µåˆ—è¡¨ã€‚ | `Optional[str]`: å¦‚æœæœ‰å­—æ®µç¼ºå¤±ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `validate_username(username)` | éªŒè¯ç”¨æˆ·åçš„æ ¼å¼ï¼ŒåŒ…æ‹¬é•¿åº¦å’Œå…è®¸çš„å­—ç¬¦ã€‚ | `username` (str): ç”¨æˆ·åã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `validate_password(password)` | éªŒè¯å¯†ç çš„å¼ºåº¦ï¼Œä¸»è¦æ£€æŸ¥é•¿åº¦ã€‚ | `password` (str): å¯†ç ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `validate_db_type(db_type)` | éªŒè¯æ•°æ®åº“ç±»å‹æ˜¯å¦åœ¨é¢„å®šä¹‰çš„æ”¯æŒåˆ—è¡¨ä¸­ã€‚ | `db_type` (str): æ•°æ®åº“ç±»å‹ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `validate_credential_type(credential_type)` | éªŒè¯å‡­æ®ç±»å‹æ˜¯å¦åœ¨é¢„å®šä¹‰çš„æ”¯æŒåˆ—è¡¨ä¸­ã€‚ | `credential_type` (str): å‡­æ®ç±»å‹ã€‚ | `Optional[str]`: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼›å¦åˆ™è¿”å› `None`ã€‚ |
| `sanitize_form_data(data)` | å¯¹æ•´ä¸ªè¡¨å•æ•°æ®è¿›è¡Œæ¸…ç†ï¼Œå¯¹æ¯ä¸ªå­—æ®µå€¼åº”ç”¨ `sanitize_input`ã€‚ | `data` (Dict): åŸå§‹è¡¨å•æ•°æ®ã€‚ | `Dict`: æ¸…ç†åçš„æ•°æ®ã€‚ |

### å®‰å…¨æ¼æ´é˜²èŒƒ
| å‡½æ•° | æè¿° | å‚æ•° | è¿”å›å€¼ |
|---|---|---|---|
| `check_sql_injection(query)` | æ£€æŸ¥ç»™å®šçš„å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«æ½œåœ¨çš„ SQL æ³¨å…¥æ¨¡å¼ã€‚ | `query` (str): SQL æŸ¥è¯¢è¯­å¥ã€‚ | `bool`: å¦‚æœæ£€æµ‹åˆ°é£é™©ï¼Œè¿”å› `True`ï¼›å¦åˆ™è¿”å› `False`ã€‚ |
| `generate_csrf_token()` | ç”Ÿæˆä¸€ä¸ªç”¨äº CSRF ä¿æŠ¤çš„å®‰å…¨ä»¤ç‰Œã€‚ | æ— ã€‚ | `str`: CSRF ä»¤ç‰Œã€‚ |
| `verify_csrf_token(token, session_token)` | å®‰å…¨åœ°æ¯”è¾ƒæäº¤çš„ CSRF ä»¤ç‰Œå’Œä¼šè¯ä¸­å­˜å‚¨çš„ä»¤ç‰Œã€‚ | `token` (str): æäº¤çš„ä»¤ç‰Œã€‚<br>`session_token` (str): ä¼šè¯ä¸­çš„ä»¤ç‰Œã€‚ | `bool`: å¦‚æœä»¤ç‰ŒåŒ¹é…ï¼Œè¿”å› `True`ã€‚ |

---

## 6. `app/utils/structlog_config.py`

è¯¥æ¨¡å—é…ç½®äº† `structlog`ï¼Œæä¾›ç»“æ„åŒ–çš„ã€å¯æ‰©å±•çš„æ—¥å¿—è®°å½•åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¼‚æ­¥æ•°æ®åº“æ—¥å¿—è®°å½•ã€ä¸Šä¸‹æ–‡ç®¡ç†å’Œå¢å¼ºçš„é”™è¯¯å¤„ç†ã€‚

### `SQLAlchemyLogHandler`

- **æè¿°**: `SQLAlchemyLogHandler` æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ—¥å¿—å¤„ç†å™¨ï¼Œå®ƒç»§æ‰¿è‡ª `logging.Handler`ï¼Œç”¨äºå°†æ—¥å¿—è®°å½•å¼‚æ­¥åœ°æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚å®ƒä½¿ç”¨ä¸€ä¸ªåå°çº¿ç¨‹æ¥æ‰¹é‡å¤„ç†å’Œæ’å…¥æ—¥å¿—ï¼Œä»è€Œé¿å…é˜»å¡ä¸»åº”ç”¨ç¨‹åºã€‚
- **æ–¹æ³•**:
    - `__init__(self, app, model, batch_size=100, flush_interval=5)`: åˆå§‹åŒ–å¤„ç†å™¨ï¼Œè®¾ç½® Flask åº”ç”¨ã€æ—¥å¿—æ¨¡å‹ã€æ‰¹å¤„ç†å¤§å°å’Œåˆ·æ–°é—´éš”ã€‚
    - `build_log_entry(self, record)`: æ ¹æ®æ—¥å¿—è®°å½•æ„å»ºä¸€ä¸ªæ—¥å¿—æ¡ç›®å­—å…¸ã€‚
    - `build_context(self, record)`: ä»æ—¥å¿—è®°å½•ä¸­æå–ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
    - `emit(self, record)`: å°†æ—¥å¿—è®°å½•æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç”±åå°çº¿ç¨‹å¤„ç†ã€‚
    - `_process_queue(self)`: åå°çº¿ç¨‹çš„ç›®æ ‡å‡½æ•°ï¼Œå®šæœŸä»é˜Ÿåˆ—ä¸­è·å–æ—¥å¿—å¹¶æ‰¹é‡æ’å…¥æ•°æ®åº“ã€‚
    - `_flush_logs(self)`: å°†ç´¯ç§¯çš„æ—¥å¿—æ‰¹é‡æ’å…¥æ•°æ®åº“ã€‚
    - `shutdown(self)`: å®‰å…¨åœ°å…³é—­åå°çº¿ç¨‹ã€‚

### `StructlogConfig`

- **æè¿°**: `StructlogConfig` ç±»ç”¨äºé…ç½® `structlog`ï¼ŒåŒ…æ‹¬è®¾ç½®å¤„ç†å™¨é“¾ã€ä¸Šä¸‹æ–‡å˜é‡å’Œæ¸²æŸ“å™¨ã€‚
- **æ–¹æ³•**:
    - `__init__(self, app=None)`: åˆå§‹åŒ–é…ç½®ç±»ï¼Œå¯é€‰æ‹©æ€§åœ°ä¼ å…¥ Flask åº”ç”¨å®ä¾‹ã€‚
    - `configure(self)`: é…ç½® `structlog` çš„ä¸»è¦æ–¹æ³•ã€‚
    - `_filter_log_level(self, logger, method_name, event_dict)`: æ ¹æ®æ—¥å¿—çº§åˆ«è¿‡æ»¤æ—¥å¿—ã€‚
    - `_add_request_context(self, logger, method_name, event_dict)`: å‘æ—¥å¿—ä¸­æ·»åŠ è¯·æ±‚ç›¸å…³çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ request_idï¼‰ã€‚
    - `_add_user_context(self, logger, method_name, event_dict)`: å‘æ—¥å¿—ä¸­æ·»åŠ ç”¨æˆ·ç›¸å…³çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ user_idï¼‰ã€‚
    - `_add_global_context(self, logger, method_name, event_dict)`: å‘æ—¥å¿—ä¸­æ·»åŠ å…¨å±€ä¸Šä¸‹æ–‡ã€‚
    - `_get_console_renderer(self)`: è·å–ç”¨äºå¼€å‘ç¯å¢ƒçš„æ§åˆ¶å°æ¸²æŸ“å™¨ã€‚
    - `_get_handler(self)`: æ ¹æ®ç¯å¢ƒï¼ˆç”Ÿäº§æˆ–å¼€å‘ï¼‰è·å–é€‚å½“çš„æ—¥å¿—å¤„ç†å™¨ã€‚

### æ—¥å¿—è®°å½•å‡½æ•°

- **`get_logger(name="app")`**:
    - **æè¿°**: è·å–ä¸€ä¸ª `structlog` æ—¥å¿—è®°å½•å™¨å®ä¾‹ã€‚
    - **å‚æ•°**:
        - `name` (str): æ—¥å¿—è®°å½•å™¨çš„åç§°ã€‚
    - **è¿”å›**: `structlog.BoundLogger`

- **`configure_structlog(app)`**:
    - **æè¿°**: åœ¨ Flask åº”ç”¨ä¸­é…ç½® `structlog`ã€‚
    - **å‚æ•°**:
        - `app` (Flask): Flask åº”ç”¨å®ä¾‹ã€‚

- **`set_debug_logging_enabled(enabled)`**:
    - **æè¿°**: åŠ¨æ€åœ°å¯ç”¨æˆ–ç¦ç”¨ DEBUG çº§åˆ«çš„æ—¥å¿—è®°å½•ã€‚
    - **å‚æ•°**:
        - `enabled` (bool): æ˜¯å¦å¯ç”¨ DEBUG æ—¥å¿—ã€‚

- **`is_debug_logging_enabled()`**:
    - **æè¿°**: æ£€æŸ¥ DEBUG æ—¥å¿—è®°å½•æ˜¯å¦å·²å¯ç”¨ã€‚
    - **è¿”å›**: `bool`

- **`log_info(message, module="app", **kwargs)`**:
    - **æè¿°**: è®°å½•ä¸€æ¡ä¿¡æ¯çº§åˆ«çš„æ—¥å¿—ã€‚
- **`log_warning(message, module="app", exception=None, **kwargs)`**:
    - **æè¿°**: è®°å½•ä¸€æ¡è­¦å‘Šçº§åˆ«çš„æ—¥å¿—ã€‚
- **`log_error(message, module="app", exception=None, **kwargs)`**:
    - **æè¿°**: è®°å½•ä¸€æ¡é”™è¯¯çº§åˆ«çš„æ—¥å¿—ï¼Œå¹¶å¯é€‰æ‹©æ€§åœ°åŒ…å«å¼‚å¸¸ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ªã€‚
- **`log_critical(message, module="app", exception=None, **kwargs)`**:
    - **æè¿°**: è®°å½•ä¸€æ¡ä¸¥é‡é”™è¯¯çº§åˆ«çš„æ—¥å¿—ã€‚
- **`log_debug(message, module="app", **kwargs)`**:
    - **æè¿°**: è®°å½•ä¸€æ¡è°ƒè¯•çº§åˆ«çš„æ—¥å¿—ï¼ˆä»…åœ¨å¯ç”¨æ—¶ï¼‰ã€‚

### ä¸“ç”¨æ—¥å¿—è®°å½•å™¨

- **`get_system_logger()`**: è·å–ç”¨äºç³»ç»Ÿäº‹ä»¶çš„æ—¥å¿—è®°å½•å™¨ã€‚
- **`get_api_logger()`**: è·å–ç”¨äº API ç›¸å…³äº‹ä»¶çš„æ—¥å¿—è®°å½•å™¨ã€‚
- **`get_auth_logger()`**: è·å–ç”¨äºè®¤è¯äº‹ä»¶çš„æ—¥å¿—è®°å½•å™¨ã€‚
- **`get_db_logger()`**: è·å–ç”¨äºæ•°æ®åº“æ“ä½œçš„æ—¥å¿—è®°å½•å™¨ã€‚
- **`get_sync_logger()`**: è·å–ç”¨äºåŒæ­¥ä»»åŠ¡çš„æ—¥å¿—è®°å½•å™¨ã€‚
- **`get_task_logger()`**: è·å–ç”¨äºåå°ä»»åŠ¡çš„æ—¥å¿—è®°å½•å™¨ã€‚

### ä¸Šä¸‹æ–‡ç®¡ç†

- **`bind_context(**kwargs)`**: ç»‘å®šå…¨å±€ä¸Šä¸‹æ–‡å˜é‡ã€‚
- **`clear_context()`**: æ¸…é™¤å…¨å±€ä¸Šä¸‹æ–‡å˜é‡ã€‚
- **`get_context()`**: è·å–å½“å‰çš„å…¨å±€ä¸Šä¸‹æ–‡ã€‚
- **`bind_request_context(request_id, user_id=None)`**: ç»‘å®šè¯·æ±‚ä¸Šä¸‹æ–‡ã€‚
- **`clear_request_context()`**: æ¸…é™¤è¯·æ±‚ä¸Šä¸‹æ–‡ã€‚
- **`LogContext(**kwargs)`**: ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œç”¨äºåœ¨ç‰¹å®šä»£ç å—å†…ä¸´æ—¶æ·»åŠ æ—¥å¿—ä¸Šä¸‹æ–‡ã€‚
- **`@with_log_context(**context)`**: ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨äºä¸ºå‡½æ•°è‡ªåŠ¨ç»‘å®šæ—¥å¿—ä¸Šä¸‹æ–‡ã€‚

### å¢å¼ºçš„é”™è¯¯å¤„ç†

- **`ErrorCategory`**: ä¸€ä¸ªæšä¸¾ç±»ï¼Œå®šä¹‰äº†é”™è¯¯çš„åˆ†ç±»ï¼ˆå¦‚æ•°æ®åº“ã€éªŒè¯ã€è®¤è¯ç­‰ï¼‰ã€‚
- **`ErrorSeverity`**: ä¸€ä¸ªæšä¸¾ç±»ï¼Œå®šä¹‰äº†é”™è¯¯çš„ä¸¥é‡ç¨‹åº¦ï¼ˆå¦‚ä½ã€ä¸­ã€é«˜ã€ä¸¥é‡ï¼‰ã€‚
- **`ErrorContext`**: ä¸€ä¸ªç±»ï¼Œç”¨äºå°è£…å…³äºé”™è¯¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚é”™è¯¯å®ä¾‹ã€è¯·æ±‚ã€ç”¨æˆ· ID ç­‰ï¼‰ã€‚
- **`enhanced_error_handler(error, context=None)`**:
    - **æè¿°**: ä¸€ä¸ªå¢å¼ºçš„é”™è¯¯å¤„ç†å™¨ï¼Œå®ƒå¯¹é”™è¯¯è¿›è¡Œåˆ†ç±»ï¼Œè®°å½•è¯¦ç»†çš„æ—¥å¿—ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–çš„ã€ç”¨æˆ·å‹å¥½çš„é”™è¯¯å“åº”ã€‚
    - **å‚æ•°**:
        - `error` (Exception): å‘ç”Ÿçš„å¼‚å¸¸ã€‚
        - `context` (ErrorContext): é”™è¯¯çš„ä¸Šä¸‹æ–‡ã€‚
    - **è¿”å›**: `dict` - åŒ…å«é”™è¯¯ä¿¡æ¯çš„å­—å…¸ã€‚
- **`@error_handler`**: ä¸€ä¸ªè£…é¥°å™¨ï¼Œå®ƒæ•è·å‡½æ•°ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œå¹¶ä½¿ç”¨ `enhanced_error_handler` æ¥å¤„ç†å®ƒä»¬ã€‚å¯¹äºä¸¥é‡é”™è¯¯ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª JSON é”™è¯¯å“åº”ã€‚
- **`@error_monitor`**: ä¸€ä¸ªè£…é¥°å™¨ï¼Œå®ƒæ•è·å¼‚å¸¸ï¼Œä½¿ç”¨ `enhanced_error_handler` è®°å½•å®ƒä»¬ï¼Œç„¶åé‡æ–°æŠ›å‡ºå¼‚å¸¸ã€‚

---

## 7. `app/utils/time_utils.py`

è¯¥æ¨¡å—å®šä¹‰äº†ä¸€ä¸ª `TimeUtils` ç±»ï¼Œç”¨äºå¤„ç†æ—¶åŒºè½¬æ¢ã€æ—¶é—´æ ¼å¼åŒ–å’Œç›¸å¯¹æ—¶é—´è®¡ç®—ã€‚å®ƒè¿˜æä¾›äº†ä¸€äº›å‘åå…¼å®¹çš„å‡½æ•°ã€‚

### `TimeUtils` ç±»

- **æè¿°**: `TimeUtils` ç±»æä¾›äº†ä¸€å¥—ç»Ÿä¸€çš„å·¥å…·ï¼Œç”¨äºå¤„ç†æ—¶åŒºè½¬æ¢ã€æ—¶é—´æ ¼å¼åŒ–å’Œç›¸å¯¹æ—¶é—´è®¡ç®—ã€‚å®ƒæ”¯æŒä¸­å›½æ—¶åŒºï¼ˆ`Asia/Shanghai`ï¼‰å’Œ UTC ä¹‹é—´çš„è½¬æ¢ï¼Œå¹¶æä¾›å¤šç§æ—¶é—´æ ¼å¼åŒ–é€‰é¡¹ã€‚
- **æ–¹æ³•**:
    - `now()`: è·å–å½“å‰çš„ UTC æ—¶é—´ã€‚
    - `now_china()`: è·å–å½“å‰çš„ä¸­å›½æ—¶é—´ã€‚
    - `to_china(dt)`: å°†ç»™å®šçš„æ—¶é—´ï¼ˆå­—ç¬¦ä¸²æˆ– `datetime` å¯¹è±¡ï¼‰è½¬æ¢ä¸ºä¸­å›½æ—¶åŒºã€‚
    - `to_utc(dt)`: å°†ç»™å®šçš„æ—¶é—´è½¬æ¢ä¸º UTC æ—¶åŒºã€‚
    - `format_china_time(dt, format_str)`: å°†æ—¶é—´æ ¼å¼åŒ–ä¸ºä¸­å›½æ—¶åŒºçš„å­—ç¬¦ä¸²ã€‚
    - `format_utc_time(dt, format_str)`: å°†æ—¶é—´æ ¼å¼åŒ–ä¸º UTC æ—¶åŒºçš„å­—ç¬¦ä¸²ã€‚
    - `get_relative_time(dt)`: è·å–ç›¸å¯¹äºå½“å‰æ—¶é—´çš„æè¿°ï¼ˆä¾‹å¦‚ï¼Œâ€œ5åˆ†é’Ÿå‰â€ï¼‰ã€‚
    - `is_today(dt)`: åˆ¤æ–­ç»™å®šçš„æ—¶é—´æ˜¯å¦æ˜¯ä»Šå¤©ã€‚
    - `get_time_range(hours)`: è·å–ä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼Œä»æŒ‡å®šçš„å°æ—¶æ•°å‰åˆ°ç°åœ¨ã€‚
    - `to_json_serializable(dt)`: å°† `datetime` å¯¹è±¡è½¬æ¢ä¸º JSON å¯åºåˆ—åŒ–çš„ ISO æ ¼å¼å­—ç¬¦ä¸²ã€‚

### å‘åå…¼å®¹çš„æ—¶é—´å‡½æ•°

- **`now()`**: `time_utils.now()` çš„åˆ«åã€‚
- **`now_china()`**: `time_utils.now_china()` çš„åˆ«åã€‚
- **`utc_to_china(dt)`**: `time_utils.to_china(dt)` çš„åˆ«åã€‚
- **`format_china_time(dt, format_str)`**: `time_utils.format_china_time(dt, format_str)` çš„åˆ«åã€‚
- **`get_china_time()`**: `time_utils.now_china()` çš„åˆ«åã€‚
- **`china_to_utc(china_dt)`**: `time_utils.to_utc(china_dt)` çš„åˆ«åã€‚
- **`get_china_date()`**: è·å–å½“å‰ä¸­å›½æ—¥æœŸçš„ `date` å¯¹è±¡ã€‚
- **`get_china_today()`**: è·å–ä¸­å›½æ—¶åŒºä»Šå¤©å¼€å§‹çš„ UTC æ—¶é—´ã€‚
- **`get_china_tomorrow()`**: è·å–ä¸­å›½æ—¶åŒºæ˜å¤©å¼€å§‹çš„ UTC æ—¶é—´ã€‚

---

## 8. `app/services/account_classification_service.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `AccountClassificationService`ï¼Œè´Ÿè´£æ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™è‡ªåŠ¨å¯¹æ•°æ®åº“è´¦æˆ·è¿›è¡Œåˆ†ç±»ã€‚è¯¥æœåŠ¡ç»è¿‡äº†é«˜åº¦ä¼˜åŒ–ï¼Œåˆ©ç”¨ç¼“å­˜ã€æ‰¹é‡å¤„ç†å’ŒæŒ‰æ•°æ®åº“ç±»å‹è¿›è¡Œåˆ†ç»„æ¥é«˜æ•ˆå¤„ç†å¤§é‡è´¦æˆ·å’Œè§„åˆ™ã€‚

#### `AccountClassificationService` ç±»

è¿™æ˜¯ä¸€ä¸ªå•ä¾‹æœåŠ¡ï¼Œå°è£…äº†æ‰€æœ‰ä¸è´¦æˆ·åˆ†ç±»ç›¸å…³çš„åŠŸèƒ½ã€‚

##### ä¸»è¦æ–¹æ³•

- **`auto_classify_accounts_optimized(self, rule_ids: list[int] | None = None, account_ids: list[int] | None = None, use_cache: bool = True) -> dict[str, Any]`**
  - **åŠŸèƒ½**: å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªè´¦æˆ·æ‰§è¡Œå…¨è‡ªåŠ¨åˆ†ç±»ã€‚è¿™æ˜¯è¯¥æœåŠ¡çš„ä¸»è¦å…¥å£ç‚¹ã€‚
  - **å‚æ•°**:
    - `rule_ids` (å¯é€‰): è¦è¯„ä¼°çš„ç‰¹å®šè§„åˆ™ ID åˆ—è¡¨ã€‚å¦‚æœä¸º `None`ï¼Œåˆ™ä½¿ç”¨æ‰€æœ‰æ´»åŠ¨è§„åˆ™ã€‚
    - `account_ids` (å¯é€‰): è¦åˆ†ç±»çš„ç‰¹å®šè´¦æˆ· ID åˆ—è¡¨ã€‚å¦‚æœä¸º `None`ï¼Œåˆ™å¯¹æ‰€æœ‰æ´»åŠ¨è´¦æˆ·è¿›è¡Œåˆ†ç±»ã€‚
    - `use_cache` (å¯é€‰): æ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„è§„åˆ™å’Œè´¦æˆ·æ•°æ®ã€‚é»˜è®¤ä¸º `True`ã€‚
  - **è¿”å›**: ä¸€ä¸ªåŒ…å«åˆ†ç±»è¿‡ç¨‹æ‘˜è¦çš„å­—å…¸ï¼ŒåŒ…æ‹¬æ·»åŠ çš„åˆ†ç±»æ€»æ•°ã€æ€»åŒ¹é…æ•°å’Œå¤±è´¥è®¡æ•°ã€‚
  - **å®ç°ç»†èŠ‚**:
    1. è·å–å¹¶æŒ‰ä¼˜å…ˆçº§å¯¹åˆ†ç±»è§„åˆ™è¿›è¡Œæ’åºï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ç¼“å­˜ã€‚
    2. è·å–è¦åˆ†ç±»çš„è´¦æˆ·ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ç¼“å­˜ã€‚
    3. æŒ‰æ•°æ®åº“ç±»å‹å¯¹è´¦æˆ·å’Œè§„åˆ™è¿›è¡Œåˆ†ç»„ï¼Œä»¥è¿›è¡Œä¼˜åŒ–å¤„ç†ã€‚
    4. å¯¹æ¯ç§æ•°æ®åº“ç±»å‹ï¼Œè°ƒç”¨ `_classify_accounts_by_db_type_optimized` æ¥æ‰§è¡Œå®é™…çš„åˆ†ç±»ã€‚
    5. è®°å½•è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯ã€‚

- **`get_rule_matched_accounts_count(self, rule_id: int) -> int`**
  - **åŠŸèƒ½**: è·å–ä¸ç»™å®šè§„åˆ™ ID åŒ¹é…çš„è´¦æˆ·æ•°ã€‚å®ƒé€šè¿‡é‡æ–°è¯„ä¼°è§„åˆ™è€Œä¸æ˜¯ä¾èµ–ç°æœ‰åˆ†é…æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚
  - **å‚æ•°**: `rule_id` - è¦è¯„ä¼°çš„è§„åˆ™çš„ IDã€‚
  - **è¿”å›**: åŒ¹é…è´¦æˆ·çš„æ•°é‡ã€‚

##### å†…éƒ¨ä¼˜åŒ–å’Œå¤„ç†æ–¹æ³•

- **`_classify_accounts_by_db_type_optimized(self, db_type: str, accounts: list[CurrentAccountSyncData], rules: list[ClassificationRule]) -> dict[str, int]`**
  - **åŠŸèƒ½**: å¯¹ç»™å®šæ•°æ®åº“ç±»å‹çš„æ‰€æœ‰è´¦æˆ·å’Œè§„åˆ™æ‰§è¡Œåˆ†ç±»ã€‚
  - **å®ç°ç»†èŠ‚**:
    1. æŒ‰ä¼˜å…ˆçº§è¿­ä»£è§„åˆ™ã€‚
    2. å¯¹æ¯ä¸ªè§„åˆ™ï¼Œè°ƒç”¨ `_find_accounts_matching_rule_optimized` æ¥æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„è´¦æˆ·ã€‚
    3. å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™è°ƒç”¨ `_add_classification_to_accounts_batch` å°†åˆ†ç±»æ‰¹é‡åˆ†é…ç»™è´¦æˆ·ã€‚
    4. è®°å½•æ¯ä¸ªè§„åˆ™çš„ç»“æœã€‚

- **`_find_accounts_matching_rule_optimized(self, rule: ClassificationRule, accounts: list[CurrentAccountSyncData]) -> list[CurrentAccountSyncData]`**
  - **åŠŸèƒ½**: æ ¹æ®è§„åˆ™çš„è¡¨è¾¾å¼ï¼Œä»è´¦æˆ·åˆ—è¡¨ä¸­ç­›é€‰å‡ºåŒ¹é…çš„è´¦æˆ·ã€‚
  - **å®ç°ç»†èŠ‚**: å¯¹æ¯ä¸ªè´¦æˆ·è°ƒç”¨ `_evaluate_rule` æ–¹æ³•ã€‚

- **`_evaluate_rule(self, account: CurrentAccountSyncData, rule: ClassificationRule) -> bool`**
  - **åŠŸèƒ½**: æ ¹æ®è´¦æˆ·çš„æƒé™è¯„ä¼°å•ä¸ªè§„åˆ™ã€‚
  - **å®ç°ç»†èŠ‚**:
    1. æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰æ­¤è´¦æˆ·å’Œè§„åˆ™ç»„åˆçš„ç»“æœã€‚
    2. å¦‚æœæœªç¼“å­˜ï¼Œåˆ™æ ¹æ®è§„åˆ™çš„ `db_type` åˆ†æ´¾åˆ°ç‰¹å®šäºæ•°æ®åº“çš„è¯„ä¼°æ–¹æ³•ï¼ˆä¾‹å¦‚ `_evaluate_mysql_rule`ï¼‰ã€‚
    3. ç¼“å­˜ç»“æœä»¥ä¾›å°†æ¥ä½¿ç”¨ã€‚

- **`_evaluate_mysql_rule`, `_evaluate_sqlserver_rule`, `_evaluate_postgresql_rule`, `_evaluate_oracle_rule`**
  - **åŠŸèƒ½**: è¿™äº›æ–¹æ³•åŒ…å«ç”¨äºè¯„ä¼°ç‰¹å®šæ•°æ®åº“ç±»å‹ï¼ˆMySQLã€SQL Serverã€PostgreSQL å’Œ Oracleï¼‰çš„åˆ†ç±»è§„åˆ™çš„é€»è¾‘ã€‚
  - **å®ç°ç»†èŠ‚**: å®ƒä»¬å°†è§„åˆ™è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ï¼Œè¦æ±‚çš„æƒé™ã€è§’è‰²ï¼‰ä¸ä» `CurrentAccountSyncData` è®°å½•ä¸­æå–çš„è´¦æˆ·æƒé™è¿›è¡Œæ¯”è¾ƒã€‚å®ƒä»¬æ”¯æŒå¤æ‚çš„é€»è¾‘ï¼ŒåŒ…æ‹¬â€œANDâ€å’Œâ€œORâ€è¿ç®—ç¬¦ã€‚

- **`_add_classification_to_accounts_batch(self, matched_accounts: list[CurrentAccountSyncData], classification_id: int) -> int`**
  - **åŠŸèƒ½**: é«˜æ•ˆåœ°å°†åˆ†ç±»æ‰¹é‡åˆ†é…ç»™ä¸€ç»„è´¦æˆ·ã€‚
  - **å®ç°ç»†èŠ‚**:
    1. æ¸…ç†è¿™äº›è´¦æˆ·çš„ä»»ä½•ç°æœ‰åˆ†ç±»åˆ†é…ã€‚
    2. ä½¿ç”¨ `bulk_insert_mappings` æ‰¹é‡æ’å…¥æ–°çš„åˆ†é…è®°å½•ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°ã€‚

##### ç¼“å­˜ç®¡ç†

- **`invalidate_cache(self) -> bool`**: æ¸…é™¤æ‰€æœ‰ä¸åˆ†ç±»ç›¸å…³çš„ç¼“å­˜ã€‚
- **`invalidate_db_type_cache(self, db_type: str) -> bool`**: æ¸…é™¤ç‰¹å®šæ•°æ®åº“ç±»å‹çš„ç¼“å­˜ã€‚
- **`_rules_to_cache_data`, `_rules_from_cache_data`**: å°†è§„åˆ™å¯¹è±¡ä¸å¯ç¼“å­˜å­—å…¸ç›¸äº’è½¬æ¢çš„è¾…åŠ©æ–¹æ³•ã€‚
- **`_accounts_to_cache_data`**: å°†è´¦æˆ·å¯¹è±¡è½¬æ¢ä¸ºå¯ç¼“å­˜å­—å…¸çš„è¾…åŠ©æ–¹æ³•ã€‚

#### å…¨å±€å®ä¾‹

- **`account_classification_service = AccountClassificationService()`**: `AccountClassificationService` çš„ä¸€ä¸ªå…¨å±€å•ä¾‹å®ä¾‹ï¼Œä»¥ä¾¿åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­è½»æ¾è®¿é—®ã€‚

è¯¥æœåŠ¡çš„è®¾è®¡è¯æ˜äº†å¯¹æ€§èƒ½çš„æ·±æ€ç†Ÿè™‘ï¼Œåœ¨é€‚å½“çš„æƒ…å†µä¸‹åˆ©ç”¨ç¼“å­˜å’Œæ‰¹é‡æ“ä½œæ¥ç¡®ä¿å³ä½¿åœ¨å…·æœ‰å¤§é‡è´¦æˆ·å’Œè§„åˆ™çš„ç¯å¢ƒä¸­ä¹Ÿèƒ½å®ç°å¯æ‰©å±•æ€§ã€‚

---

## 9. `app/services/connection_factory.py`

è¯¥æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªæ•°æ®åº“è¿æ¥å·¥å‚ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£æ¥åˆ›å»ºå’Œç®¡ç†ä¸ä¸åŒç±»å‹æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLã€SQL Server å’Œ Oracleï¼‰çš„è¿æ¥ã€‚å®ƒæŠ½è±¡äº†æ¯ä¸ªæ•°æ®åº“é©±åŠ¨ç¨‹åºçš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæä¾›äº†ä¸€ç§å¹²å‡€ä¸”å¯æ‰©å±•çš„æ–¹å¼æ¥å¤„ç†æ•°æ®åº“è¿æ¥ã€‚

#### `DatabaseConnection` æŠ½è±¡åŸºç±»

è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼ˆABCï¼‰ï¼Œå®ƒå®šä¹‰äº†æ‰€æœ‰å…·ä½“æ•°æ®åº“è¿æ¥ç±»å¿…é¡»å®ç°çš„é€šç”¨æ¥å£ã€‚è¿™ç¡®ä¿äº†æ‰€æœ‰è¿æ¥å¯¹è±¡éƒ½å…·æœ‰ä¸€è‡´çš„ APIã€‚

- **`connect(self) -> bool`**: å»ºç«‹æ•°æ®åº“è¿æ¥ã€‚
- **`disconnect(self) -> None`**: æ–­å¼€æ•°æ®åº“è¿æ¥ã€‚
- **`test_connection(self) -> dict[str, Any]`**: æµ‹è¯•ä¸æ•°æ®åº“çš„è¿æ¥å¹¶è¿”å›çŠ¶æ€å’Œç‰ˆæœ¬ä¿¡æ¯ã€‚
- **`execute_query(self, query: str, params: tuple | None = None) -> Any`**: æ‰§è¡Œ SQL æŸ¥è¯¢å¹¶è¿”å›ç»“æœã€‚
- **`get_version(self) -> str | None`**: è·å–æ•°æ®åº“æœåŠ¡å™¨çš„ç‰ˆæœ¬ã€‚

#### å…·ä½“è¿æ¥ç±»

ä¸ºæ¯ä¸ªæ”¯æŒçš„æ•°æ®åº“ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œå®ç°äº† `DatabaseConnection` æ¥å£ã€‚

- **`MySQLConnection`**: ä½¿ç”¨ `pymysql` åº“è¿æ¥åˆ° MySQL æ•°æ®åº“ã€‚
- **`PostgreSQLConnection`**: ä½¿ç”¨ `psycopg` åº“è¿æ¥åˆ° PostgreSQL æ•°æ®åº“ã€‚
- **`SQLServerConnection`**: ä½¿ç”¨ `pymssql` åº“è¿æ¥åˆ° SQL Serverã€‚å®ƒè¿˜åŒ…æ‹¬ä¸€ä¸ªè¯Šæ–­å®ç”¨ç¨‹åºï¼Œç”¨äºåœ¨è¿æ¥å¤±è´¥æ—¶æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚
- **`OracleConnection`**: ä½¿ç”¨ `oracledb` åº“ä»¥â€œThickâ€æ¨¡å¼è¿æ¥åˆ° Oracle æ•°æ®åº“ï¼Œè¿™éœ€è¦ Oracle Instant Clientã€‚

#### `ConnectionFactory` ç±»

è¿™æ˜¯è¯¥æ–‡ä»¶çš„æ ¸å¿ƒï¼Œæä¾›ç”¨äºåˆ›å»ºå’Œç®¡ç†è¿æ¥çš„é™æ€æ–¹æ³•ã€‚

- **`CONNECTION_CLASSES`**: ä¸€ä¸ªå­—å…¸ï¼Œå°†æ•°æ®åº“ç±»å‹å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ï¼Œâ€œmysqlâ€ï¼‰æ˜ å°„åˆ°å®ƒä»¬ç›¸åº”çš„è¿æ¥ç±»ã€‚

- **`create_connection(instance: Instance) -> DatabaseConnection | None`**
  - **åŠŸèƒ½**: æ ¹æ® `Instance` å¯¹è±¡ä¸­æŒ‡å®šçš„ `db_type` åˆ›å»ºå¹¶è¿”å›é€‚å½“çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ã€‚
  - **è¿”å›**: ä¸€ä¸ª `DatabaseConnection` çš„å®ä¾‹ï¼Œå¦‚æœæ•°æ®åº“ç±»å‹ä¸å—æ”¯æŒï¼Œåˆ™è¿”å› `None`ã€‚

- **`test_connection(instance: Instance) -> dict[str, Any]`**
  - **åŠŸèƒ½**: æµ‹è¯•ä¸ç»™å®š `Instance` çš„æ•°æ®åº“è¿æ¥ã€‚
  - **è¿”å›**: ä¸€ä¸ªåŒ…å«æµ‹è¯•ç»“æœçš„å­—å…¸ï¼ŒåŒ…æ‹¬æˆåŠŸçŠ¶æ€ã€æ¶ˆæ¯å’Œæ•°æ®åº“ç‰ˆæœ¬ã€‚

- **`get_supported_types() -> list`**: è¿”å›å·¥å‚æ”¯æŒçš„æ‰€æœ‰æ•°æ®åº“ç±»å‹çš„åˆ—è¡¨ã€‚

- **`is_type_supported(db_type: str) -> bool`**: æ£€æŸ¥æ˜¯å¦æ”¯æŒç»™å®šçš„æ•°æ®åº“ç±»å‹ã€‚

è¯¥å·¥å‚è®¾è®¡é€šè¿‡å°†è¿æ¥åˆ›å»ºé€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œç®€åŒ–äº†åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å¤„ç†å¤šæ•°æ®åº“ç¯å¢ƒçš„è¿‡ç¨‹ï¼Œä»è€Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

---

## 10. `app/services/database_discovery_service.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `DatabaseDiscoveryService`ï¼Œå®ƒè´Ÿè´£è‡ªåŠ¨å‘ç°åœ¨ç»™å®šæ•°æ®åº“å®ä¾‹ä¸­å¯ç”¨çš„æ•°æ®åº“ï¼ˆæˆ–æ¨¡å¼ï¼‰ã€‚è¯¥æœåŠ¡å¯ä»¥è¿æ¥åˆ°ä¸åŒç±»å‹çš„æ•°æ®åº“ï¼ŒæŸ¥è¯¢å®ƒä»¬çš„ç³»ç»Ÿç›®å½•ä»¥è·å–æ•°æ®åº“åˆ—è¡¨ï¼Œå¹¶å°†æ­¤ä¿¡æ¯ä¸åº”ç”¨ç¨‹åºçš„æ•°æ®åº“åŒæ­¥ã€‚

#### `DatabaseDiscoveryService` ç±»

è¯¥æœåŠ¡æ˜¯å›´ç»•æ­¤ç±»æ„å»ºçš„ï¼Œè¯¥ç±»æ˜¯ä¸ºç‰¹å®šæ•°æ®åº“å®ä¾‹å®ä¾‹åŒ–çš„ã€‚

- **`__init__(self, instance: Instance)`**: ä½¿ç”¨ `Instance` å¯¹è±¡åˆå§‹åŒ–æœåŠ¡ã€‚

- **`discover_databases(self) -> List[str]`**
  - **åŠŸèƒ½**: æ ¹æ®å®ä¾‹çš„ `db_type` åè°ƒæ•°æ®åº“å‘ç°è¿‡ç¨‹ã€‚
  - **å®ç°**: å®ƒè°ƒç”¨ç‰¹å®šäºæ•°æ®åº“çš„ç§æœ‰æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼Œ`_discover_mysql_databases`ï¼‰æ¥æ‰§è¡Œå‘ç°ã€‚
  - **è¿”å›**: å‘ç°çš„æ•°æ®åº“åç§°åˆ—è¡¨ã€‚

- **ç‰¹å®šäºæ•°æ®åº“çš„å‘ç°æ–¹æ³•**
  - **`_discover_mysql_databases(self)`**: æ‰§è¡Œ `SHOW DATABASES` æ¥è·å– MySQL æ•°æ®åº“ã€‚
  - **`_discover_postgresql_databases(self)`**: æŸ¥è¯¢ `pg_database` ç›®å½•æ¥è·å– PostgreSQL æ•°æ®åº“ã€‚
  - **`_discover_sqlserver_databases(self)`**: æŸ¥è¯¢ `sys.databases` ç›®å½•æ¥è·å– SQL Server æ•°æ®åº“ã€‚
  - **`_discover_oracle_databases(self)`**: ç”±äº Oracle çš„ä½“ç³»ç»“æ„ï¼Œè¿™é€šå¸¸åªè¿”å›å®ä¾‹æœ¬èº«çš„åç§°ï¼Œå› ä¸ºä¸€ä¸ªå®ä¾‹é€šå¸¸ç®¡ç†ä¸€ä¸ªæ•°æ®åº“ã€‚

- **`update_database_list(self, discovered_databases: List[str]) -> Dict[str, int]`**
  - **åŠŸèƒ½**: å°†å‘ç°çš„æ•°æ®åº“åˆ—è¡¨ä¸åº”ç”¨ç¨‹åºçš„ `instance_databases` è¡¨åŒæ­¥ã€‚
  - **å®ç°**:
    1. è·å–å½“å‰ä¸ºå®ä¾‹è®°å½•çš„æ´»åŠ¨æ•°æ®åº“ã€‚
    2. å°†å½“å‰åˆ—è¡¨ä¸å‘ç°çš„åˆ—è¡¨è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æŸ¥æ‰¾æ–°çš„å’Œå·²åˆ é™¤çš„æ•°æ®åº“ã€‚
    3. å°†æ–°æ•°æ®åº“æ·»åŠ åˆ°è¡¨ä¸­ã€‚
    4. å°†å·²åˆ é™¤çš„æ•°æ®åº“æ ‡è®°ä¸ºä¸æ´»åŠ¨ã€‚
    5. æ›´æ–°ç°æœ‰æ•°æ®åº“çš„ `last_seen_date`ã€‚
  - **è¿”å›**: ä¸€ä¸ªåŒ…å«æœ‰å…³æ“ä½œçš„ç»Ÿè®¡ä¿¡æ¯çš„å­—å…¸ï¼ˆæ‰¾åˆ°çš„æ•°æ®åº“ã€æ·»åŠ çš„æ•°æ®åº“ã€åˆ é™¤çš„æ•°æ®åº“ï¼‰ã€‚

- **`connect(self) -> bool`** å’Œ **`disconnect(self)`**
  - **åŠŸèƒ½**: ä½¿ç”¨ `DatabaseConnectionService` ç®¡ç†ä¸ç›®æ ‡æ•°æ®åº“å®ä¾‹çš„è¿æ¥ã€‚

è¯¥æœåŠ¡åœ¨è‡ªåŠ¨ç»´æŠ¤ä¸æ¯ä¸ªå—ç®¡å®ä¾‹å…³è”çš„æ•°æ®åº“çš„å‡†ç¡®æ¸…å•æ–¹é¢å‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œè¿™å¯¹äºéœ€è¦äº†è§£å¯ç”¨æ•°æ®åº“èŒƒå›´çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚ï¼Œè´¦æˆ·åŒæ­¥ï¼‰è‡³å…³é‡è¦ã€‚

---

## 11. `app/services/account_sync_service.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `AccountSyncService` ç±»ï¼Œä½œä¸ºå¤„ç†æ‰€æœ‰æ•°æ®åº“å®ä¾‹è´¦æˆ·åŒæ­¥çš„ç»Ÿä¸€å…¥å£ã€‚

- **`AccountSyncService` ç±»**:
  - **`__init__(self)`**: åˆå§‹åŒ– `AccountSyncService`ï¼Œè·å–æ—¥å¿—è®°å½•å™¨å’Œ `SyncDataManager` å®ä¾‹ã€‚
  - **`sync_accounts(self, instance, sync_type, session_id, created_by)`**: ç»Ÿä¸€çš„è´¦æˆ·åŒæ­¥å…¥å£ï¼Œæ ¹æ® `sync_type`ï¼ˆ`MANUAL_SINGLE`, `MANUAL_BATCH`, `MANUAL_TASK`, `SCHEDULED_TASK`ï¼‰å†³å®šåŒæ­¥æµç¨‹ã€‚
    - **`_sync_single_instance(self, instance)`**: å¤„ç†æ‰‹åŠ¨å•å®ä¾‹åŒæ­¥ï¼Œä¸ä½¿ç”¨ä¼šè¯ç®¡ç†ã€‚
    - **`_sync_with_session(self, instance, sync_type, created_by)`**: å¤„ç†éœ€è¦æ–°ä¼šè¯çš„æ‰¹é‡ã€æ‰‹åŠ¨ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡åŒæ­¥ã€‚
    - **`_sync_with_existing_session(self, instance, session_id)`**: å¤„ç†ä½¿ç”¨ç°æœ‰ä¼šè¯çš„åŒæ­¥ã€‚
  - **`_update_database_version(self, instance, conn)`**: åœ¨åŒæ­¥å‰è·å–å¹¶æ›´æ–°å®ä¾‹çš„æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯ã€‚
  - **`_get_database_version(self, instance, connection)`**: æ ¹æ®æ•°æ®åº“ç±»å‹ï¼ˆMySQL, PostgreSQL, SQL Server, Oracleï¼‰æ‰§è¡Œç›¸åº”çš„æŸ¥è¯¢æ¥è·å–ç‰ˆæœ¬ä¿¡æ¯ã€‚

- **`account_sync_service`**: `AccountSyncService` çš„å•ä¾‹ï¼Œä¾›å…¶ä»–æ¨¡å—è°ƒç”¨ã€‚

### `app/services/sync_data_manager.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `SyncDataManager` ç±»ï¼Œå®ƒå……å½“ä»ä¸åŒæ•°æ®åº“ç±»å‹åŒæ­¥å¸æˆ·æ•°æ®çš„ç»Ÿä¸€ç®¡ç†å™¨ã€‚å®ƒä½¿ç”¨é€‚é…å™¨æ¨¡å¼å°†å®é™…çš„åŒæ­¥é€»è¾‘å§”æ‰˜ç»™æ¯ç§æ•°æ®åº“ç±»å‹çš„ç‰¹å®šé€‚é…å™¨ã€‚

- **`SyncDataManager` ç±»**:
  - **`__init__(self)`**: åˆå§‹åŒ– `SyncDataManager`ï¼Œåˆ›å»ºä¸€ä¸ªå°†æ•°æ®åº“ç±»å‹æ˜ å°„åˆ°å…¶ç›¸åº”åŒæ­¥é€‚é…å™¨ç±»çš„å­—å…¸ã€‚
  - **`sync_accounts(self, instance, connection, session_id)`**: åŒæ­¥å¸æˆ·çš„ä¸»è¦æ–¹æ³•ã€‚å®ƒä¸ºç»™å®šçš„æ•°æ®åº“ç±»å‹æ£€ç´¢é€‚å½“çš„é€‚é…å™¨ï¼Œå¹¶è°ƒç”¨å…¶ `sync_accounts` æ–¹æ³•æ¥æ‰§è¡ŒåŒæ­¥ã€‚
  - **`_get_adapter(self, db_type)`**: æ ¹æ®æ•°æ®åº“ç±»å‹è·å–æ­£ç¡®çš„åŒæ­¥é€‚é…å™¨ã€‚
  - **`get_supported_db_types(self)`**: è¿”å›æ”¯æŒçš„æ•°æ®åº“ç±»å‹åˆ—è¡¨ã€‚
  - **å…¼å®¹æ€§æ–¹æ³•**: åŒ…æ‹¬ `sync_mysql_accounts`ã€`sync_postgresql_accounts` ç­‰ï¼Œç”¨äºå‘åå…¼å®¹ã€‚
  - **é™æ€æ–¹æ³•**: åŒ…æ‹¬ `get_account_latest`ã€`get_accounts_by_instance` å’Œ `get_account_changes`ï¼Œç”¨äºä»æ•°æ®åº“æ¨¡å‹ä¸­æ£€ç´¢å¸æˆ·æ•°æ®ï¼Œä»¥å®ç°å‘åå…¼å®¹ã€‚

### `app/services/sync_session_service.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `SyncSessionService` ç±»ï¼Œè´Ÿè´£ç®¡ç†åŒæ­¥ä¼šè¯å’Œå®ä¾‹è®°å½•ã€‚è¯¥æœåŠ¡å¯¹äºå¤„ç†æ‰¹é‡ã€åŸºäºä»»åŠ¡å’Œè®¡åˆ’çš„åŒæ­¥æ“ä½œè‡³å…³é‡è¦ï¼Œä¸ºè·Ÿè¸ªæ¯ä¸ªåŒæ­¥ä½œä¸šçš„è¿›åº¦å’Œç»“æœæä¾›äº†ç»“æ„åŒ–çš„æ–¹æ³•ã€‚

- **`SyncSessionService` ç±»**:
  - **`__init__(self)`**: åˆå§‹åŒ–æœåŠ¡åŠå…¶æ—¥å¿—è®°å½•å™¨ã€‚
  - **`_clean_sync_details(self, sync_details)`**: æ¸…ç† `sync_details`ï¼Œå°† `datetime` å¯¹è±¡è½¬æ¢ä¸º ISO æ ¼å¼å­—ç¬¦ä¸²ï¼Œä»¥ç¡®ä¿ JSON å¯åºåˆ—åŒ–ã€‚
  - **`create_session(self, sync_type, sync_category, created_by)`**: åˆ›å»ºä¸€ä¸ªæ–°çš„ `SyncSession` æ¥è¡¨ç¤ºä¸€ç»„åŒæ­¥ä»»åŠ¡ã€‚
  - **`add_instance_records(self, session_id, instance_ids, sync_category)`**: å°† `SyncInstanceRecord` æ¡ç›®æ·»åŠ åˆ°ä¼šè¯ä¸­ï¼Œä»¥è·Ÿè¸ªæ¯ä¸ªå®ä¾‹çš„çŠ¶æ€ã€‚
  - **`start_instance_sync(self, record_id)`**: å°† `SyncInstanceRecord` æ ‡è®°ä¸ºâ€œrunningâ€ã€‚
  - **`complete_instance_sync(self, record_id, ...)`**: å°† `SyncInstanceRecord` æ ‡è®°ä¸ºâ€œcompletedâ€å¹¶è®°å½•ç»Ÿè®¡ä¿¡æ¯ã€‚
  - **`fail_instance_sync(self, record_id, error_message, ...)`**: å°† `SyncInstanceRecord` æ ‡è®°ä¸ºâ€œfailedâ€å¹¶è®°å½•é”™è¯¯ã€‚
  - **`_update_session_statistics(self, session_id)`**: æ›´æ–° `SyncSession` çš„èšåˆç»Ÿè®¡ä¿¡æ¯ã€‚
  - **`recover_stuck_instances(self, timeout_minutes)`**: æ¢å¤å¡ä½çš„åŒæ­¥å®ä¾‹ï¼Œå°†å…¶æ ‡è®°ä¸ºâ€œfailedâ€ã€‚
  - **`get_session_records(self, session_id)`**: æ£€ç´¢ä¼šè¯çš„æ‰€æœ‰ `SyncInstanceRecord`ã€‚
  - **`get_session_by_id(self, session_id)`**: æŒ‰ ID æ£€ç´¢ `SyncSession`ã€‚
  - **`get_sessions_by_type(self, sync_type, limit)`**: æŒ‰ç±»å‹æ£€ç´¢ä¼šè¯ã€‚
  - **`get_sessions_by_category(self, sync_category, limit)`**: æŒ‰ç±»åˆ«æ£€ç´¢ä¼šè¯ã€‚
  - **`get_recent_sessions(self, limit)`**: æ£€ç´¢æœ€è¿‘çš„ä¼šè¯ã€‚
  - **`cancel_session(self, session_id)`**: å–æ¶ˆä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä¼šè¯ã€‚

- **`sync_session_service`**: `SyncSessionService` çš„å…¨å±€å•ä¾‹å®ä¾‹ã€‚

### `app/services/cache_manager.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `CacheManager` ç±»ï¼Œå®ƒä¸ºåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ç¼“å­˜æ¥å£ï¼Œä¸»è¦åˆ©ç”¨ `Flask-Caching` æ‰©å±•æ¥å®ç°ã€‚è¿™ä¸ªç®¡ç†å™¨è´Ÿè´£å¤„ç†å„ç§ç±»å‹æ•°æ®çš„ç¼“å­˜ï¼ŒåŒ…æ‹¬æƒé™ã€è§„åˆ™å’Œè´¦æˆ·ä¿¡æ¯ï¼Œä»¥æé«˜æ€§èƒ½ã€‚

- **`CacheManager` ç±»**:
  - **`__init__(self, cache)`**: åˆå§‹åŒ– `CacheManager`ï¼Œæ¥æ”¶ä¸€ä¸ª `Flask-Caching` çš„ `Cache` å¯¹è±¡ä½œä¸ºå…¶ç¼“å­˜åç«¯ã€‚
  - **`_generate_cache_key(self, prefix, ...)`**: ç”Ÿæˆä¸€è‡´ä¸”å®‰å…¨çš„ç¼“å­˜é”®ã€‚
  - **æƒé™ç¼“å­˜**: ç®¡ç†ç‰¹å®šç”¨æˆ·åœ¨ç‰¹å®šæ•°æ®åº“ä¸Šçš„æƒé™ç¼“å­˜ä»¥åŠå•ä¸ªè´¦æˆ·çš„æƒé™ç¼“å­˜ã€‚
  - **è§„åˆ™è¯„ä¼°ç¼“å­˜**: ç¼“å­˜åˆ†ç±»è§„åˆ™å¯¹ç‰¹å®šè´¦æˆ·çš„è¯„ä¼°ç»“æœã€‚
  - **åˆ†ç±»è§„åˆ™ç¼“å­˜**: æŒ‰æ•°æ®åº“ç±»å‹ç¼“å­˜åˆ†ç±»è§„åˆ™ã€‚
  - **è´¦æˆ·ç¼“å­˜**: æŒ‰æ•°æ®åº“ç±»å‹ç¼“å­˜è´¦æˆ·ä¿¡æ¯ã€‚
  - **ç¼“å­˜å¤±æ•ˆ**: æä¾›å¤šç§æ–¹æ³•æ¥ç²¾ç¡®åœ°æ¸…é™¤ä¸å†æœ‰æ•ˆæˆ–éœ€è¦æ›´æ–°çš„ç¼“å­˜ã€‚
  - **`get_cache_stats(self)`**: è·å–ç¼“å­˜åç«¯çš„ç»Ÿè®¡ä¿¡æ¯ã€‚
  - **`health_check(self)`**: æ‰§è¡Œç®€å•çš„å¥åº·æ£€æŸ¥ä»¥éªŒè¯ç¼“å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

- **å…¨å±€å®ä¾‹å’Œåˆå§‹åŒ–**:
  - `cache_manager`: å…¨å±€çš„ `CacheManager` å®ä¾‹ã€‚
  - `init_cache_manager(cache)`: åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–å…¨å±€çš„ `cache_manager` å®ä¾‹ã€‚

### `app/services/connection_test_service.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `ConnectionTestService` ç±»ï¼Œå…¶å”¯ä¸€èŒè´£æ˜¯æµ‹è¯•ä¸æ•°æ®åº“å®ä¾‹çš„è¿æ¥ã€‚

- **`ConnectionTestService` ç±»**:
  - **`__init__(self)`**: åˆå§‹åŒ–æœåŠ¡å’Œæ—¥å¿—è®°å½•å™¨ã€‚
  - **`test_connection(self, instance)`**: æµ‹è¯•è¿æ¥çš„ä¸»è¦æ–¹æ³•ã€‚å®ƒä½¿ç”¨ `ConnectionFactory` åˆ›å»ºè¿æ¥ï¼Œè·å–æ•°æ®åº“ç‰ˆæœ¬ï¼Œæ›´æ–° `last_connected` æ—¶é—´æˆ³ï¼Œå¹¶å¤„ç†é”™è¯¯ï¼ŒåŒ…æ‹¬åŸºæœ¬çš„å®‰å…¨æ£€æŸ¥ã€‚
  - **`_get_database_version(self, instance, connection)`**: æ ¹æ®æ•°æ®åº“ç±»å‹æ‰§è¡Œç‰¹å®šçš„æŸ¥è¯¢ä»¥æ£€ç´¢ç‰ˆæœ¬å­—ç¬¦ä¸²ã€‚

- **`connection_test_service`**: `ConnectionTestService` çš„å…¨å±€å•ä¾‹å®ä¾‹ã€‚

### `app/services/database_filter_manager.py`

è¯¥æ–‡ä»¶å®šä¹‰äº† `DatabaseFilterManager` ç±»ï¼Œè´Ÿè´£ç®¡ç†æ•°æ®åº“è´¦æˆ·åŒæ­¥çš„è¿‡æ»¤è§„åˆ™ã€‚

- **`DatabaseFilterManager` ç±»**:
  - **`__init__(self)`**: åŠ è½½è¿‡æ»¤è§„åˆ™ã€‚
  - **`_load_filter_rules(self)`**: ä»é»˜è®¤é…ç½®å’Œå¯é€‰çš„ `database_filters.yaml` æ–‡ä»¶ä¸­åŠ è½½è§„åˆ™ã€‚
  - **`get_sql_filter_conditions(self, db_type, username_field)`**: ç”Ÿæˆä¸€ä¸ª SQL `WHERE` å­å¥å­—ç¬¦ä¸²ç”¨äºè¿‡æ»¤ï¼Œä½†ä¸å¤ªå®‰å…¨ã€‚
  - **`get_safe_sql_filter_conditions(self, db_type, username_field)`**: ç”Ÿæˆä¸€ä¸ªå®‰å…¨çš„ã€å‚æ•°åŒ–çš„ SQL `WHERE` å­å¥å’Œå‚æ•°ï¼Œä»¥é˜²æ­¢ SQL æ³¨å…¥ã€‚
  - **`should_include_account(self, username, db_type)`**: æ£€æŸ¥ä¸€ä¸ªè´¦æˆ·æ˜¯å¦åº”è¯¥æ ¹æ®è§„åˆ™è¢«åŒ…å«ã€‚
  - **`_match_pattern(self, text, pattern)`**: å°† SQL `LIKE` æ¨¡å¼è½¬æ¢ä¸ºæ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ã€‚
  - **`get_filter_rules(self, db_type)`**: è·å–æŒ‡å®šæ•°æ®åº“ç±»å‹æˆ–æ‰€æœ‰ç±»å‹çš„è¿‡æ»¤è§„åˆ™ã€‚
  - **`update_filter_rules(self, db_type, rules)`**: åœ¨å†…å­˜ä¸­æ›´æ–°è¿‡æ»¤è§„åˆ™ã€‚
  - **`save_filter_rules_to_file(self, file_path)`**: å°†è§„åˆ™ä¿å­˜åˆ° YAML é…ç½®æ–‡ä»¶ä¸­ã€‚
  - **`get_filter_statistics(self, db_type)`**: æä¾›å…³äºè§„åˆ™çš„ç»Ÿè®¡ä¿¡æ¯ã€‚

- **`database_filter_manager`**: `DatabaseFilterManager` çš„å…¨å±€å•ä¾‹å®ä¾‹ã€‚