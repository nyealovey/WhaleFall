# 鲸落 (TaifishV4) 核心功能

## 🎯 功能概览

鲸落是一个基于Flask的DBA数据库管理Web应用，提供多数据库实例管理、账户管理、任务调度、日志监控等功能。系统采用模块化设计，支持PostgreSQL、MySQL、SQL Server、Oracle等主流数据库。

## 🏗️ 系统架构

### 技术栈
- **后端**: Flask 3.1.2 + SQLAlchemy 1.4.54
- **前端**: Bootstrap 5.3.2 + jQuery 3.7.1
- **数据库**: PostgreSQL (主数据库) + 多数据库支持
- **缓存**: Redis 5.0.7
- **任务调度**: APScheduler 3.10.4
- **Python版本**: 3.11+

### 核心模块
1. **数据库实例管理** - 多数据库实例的统一管理
2. **账户分类管理** - 智能账户分类和权限管理
3. **数据同步管理** - 多数据库数据同步
4. **任务调度管理** - 轻量级任务调度系统
5. **日志监控中心** - 统一日志记录和监控
6. **标签管理系统** - 灵活的标签分类管理

## 🗄️ 数据库实例管理

### 功能特性
- **多数据库支持**: PostgreSQL、MySQL、SQL Server、Oracle
- **实例监控**: 实时状态监控和性能统计
- **连接管理**: 安全的数据库连接和凭据管理
- **实例统计**: 详细的实例使用统计和报告

### 核心功能
```python
# 实例管理服务
class InstanceService:
    def create_instance(self, name, host, port, db_type, credentials)
    def update_instance(self, instance_id, **kwargs)
    def delete_instance(self, instance_id)
    def test_connection(self, instance_id)
    def get_instance_stats(self, instance_id)
    def list_instances(self, filters=None)
```

### 支持的操作
- ✅ 实例创建、编辑、删除
- ✅ 连接测试和状态监控
- ✅ 实例统计和性能分析
- ✅ 批量操作和管理
- ✅ 实例分组和标签管理

## 🏷️ 账户分类管理 (核心功能)

### 功能特性
- **智能分类**: 基于权限规则的自动账户分类
- **权限扫描**: 实时更新账户权限信息
- **多分类支持**: 支持账户分配到多个分类
- **规则配置**: 支持多种数据库类型的权限规则

### 分类规则引擎
```python
# 权限规则配置
class PermissionConfig:
    def __init__(self, db_type, rules):
        self.db_type = db_type  # 数据库类型
        self.rules = rules      # 权限规则列表
    
    def match_permissions(self, account_permissions):
        # 根据规则匹配账户权限
        pass
```

### 支持的数据库类型
- **MySQL**: 支持用户权限、数据库权限、表权限
- **PostgreSQL**: 支持角色权限、数据库权限、模式权限
- **SQL Server**: 支持服务器角色、数据库角色、对象权限
- **Oracle**: 支持系统权限、对象权限、角色权限

### 核心功能
- ✅ 自动权限扫描和分类
- ✅ 自定义分类规则配置
- ✅ 批量分类和重新分类
- ✅ 分类统计和报告
- ✅ 权限变更日志记录

## 🔄 数据同步管理

### 功能特性
- **增量同步**: 支持增量数据同步
- **冲突处理**: 智能处理数据同步冲突
- **同步监控**: 实时监控同步状态和进度
- **回滚机制**: 支持同步失败时的数据回滚

### 同步适配器
```python
# 同步适配器基类
class BaseSyncAdapter:
    def sync_accounts(self, instance_id, sync_data)
    def sync_permissions(self, instance_id, permission_data)
    def handle_conflicts(self, conflicts)
    def rollback_sync(self, sync_id)
```

### 支持的同步类型
- **账户同步**: 用户账户信息同步
- **权限同步**: 权限信息同步
- **配置同步**: 数据库配置同步
- **统计同步**: 统计信息同步

### 核心功能
- ✅ 增量数据同步
- ✅ 冲突检测和处理
- ✅ 同步状态监控
- ✅ 数据回滚机制
- ✅ 同步日志记录

## ⏰ 任务调度管理

### 功能特性
- **轻量级调度**: 基于APScheduler的任务调度
- **任务持久化**: 任务状态存储在PostgreSQL数据库
- **监控日志**: 任务执行监控和日志记录
- **动态管理**: 支持任务的启用/禁用和立即执行

### 任务类型
```python
# 内置任务类型
TASK_TYPES = {
    'account_sync': '账户同步任务',
    'permission_scan': '权限扫描任务',
    'data_cleanup': '数据清理任务',
    'report_generation': '报告生成任务',
    'backup_task': '备份任务'
}
```

### 核心功能
- ✅ 定时任务调度
- ✅ 任务状态管理
- ✅ 任务执行监控
- ✅ 任务日志记录
- ✅ 动态任务管理

## 📊 日志监控中心

### 功能特性
- **统一日志**: 结构化日志记录和聚合
- **实时监控**: 系统状态和性能监控
- **日志分析**: 日志搜索、筛选和分析
- **告警通知**: 异常情况自动告警

### 日志级别
```python
# 日志级别定义
LOG_LEVELS = {
    'DEBUG': '调试信息',
    'INFO': '一般信息',
    'WARNING': '警告信息',
    'ERROR': '错误信息',
    'CRITICAL': '严重错误'
}
```

### 核心功能
- ✅ 结构化日志记录
- ✅ 日志搜索和筛选
- ✅ 实时监控面板
- ✅ 告警和通知
- ✅ 日志分析和报告

## 🏷️ 标签管理系统

### 功能特性
- **标签分类**: 支持标签按分类管理
- **批量操作**: 支持批量分配和移除标签
- **权限控制**: 基于角色的标签管理权限
- **搜索筛选**: 强大的标签搜索和筛选功能

### 标签结构
```python
# 标签模型
class Tag:
    def __init__(self, name, display_name, category, color, description):
        self.name = name          # 标签代码
        self.display_name = display_name  # 显示名称
        self.category = category  # 分类
        self.color = color        # 颜色
        self.description = description  # 描述
```

### 核心功能
- ✅ 标签创建和管理
- ✅ 标签分类管理
- ✅ 批量标签操作
- ✅ 标签搜索筛选
- ✅ 标签统计报告

## 🔐 用户认证与权限管理

### 功能特性
- **用户认证**: 基于Flask-Login的会话管理
- **角色权限**: 基于角色的访问控制
- **API认证**: JWT令牌认证支持
- **安全防护**: CSRF保护和密码加密

### 用户角色
```python
# 用户角色定义
USER_ROLES = {
    'admin': '系统管理员',
    'dba': '数据库管理员',
    'operator': '操作员',
    'viewer': '只读用户'
}
```

### 核心功能
- ✅ 用户登录和登出
- ✅ 密码修改和重置
- ✅ 角色权限管理
- ✅ API认证授权
- ✅ 安全审计日志

## 🔍 统一搜索功能

### 功能特性
- **跨页面搜索**: 支持跨页面的统一搜索
- **多条件筛选**: 支持多种筛选条件组合
- **智能检测**: 自动检测页面类型和搜索需求
- **动态更新**: 实时更新搜索结果和统计

### 搜索组件
```javascript
// 统一搜索组件
class UnifiedSearch {
    constructor(formId) {
        this.formId = formId;
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.initializeFilters();
    }
}
```

### 核心功能
- ✅ 统一搜索界面
- ✅ 多条件筛选
- ✅ 搜索结果统计
- ✅ 搜索历史记录
- ✅ 智能搜索建议

## 📈 统计和报告

### 功能特性
- **实时统计**: 实时数据统计和展示
- **图表展示**: 使用Chart.js的图表展示
- **报告生成**: 自动生成各种统计报告
- **数据导出**: 支持数据导出和下载

### 统计类型
- **实例统计**: 数据库实例使用统计
- **账户统计**: 账户数量和分类统计
- **同步统计**: 数据同步状态统计
- **性能统计**: 系统性能指标统计

### 核心功能
- ✅ 实时数据统计
- ✅ 图表可视化
- ✅ 报告生成
- ✅ 数据导出
- ✅ 历史趋势分析

## 🛠️ 系统管理

### 功能特性
- **系统监控**: 系统状态和性能监控
- **配置管理**: 系统配置和参数管理
- **缓存管理**: Redis缓存管理和清理
- **健康检查**: 系统健康状态检查

### 管理功能
- ✅ 系统状态监控
- ✅ 配置参数管理
- ✅ 缓存管理
- ✅ 健康检查
- ✅ 系统维护

## 🔧 开发工具

### 功能特性
- **代码质量**: Black、isort、Ruff、MyPy
- **测试框架**: pytest单元测试和集成测试
- **调试工具**: 详细的日志和调试信息
- **性能分析**: 性能监控和分析工具

### 开发支持
- ✅ 代码质量检查
- ✅ 自动化测试
- ✅ 调试工具
- ✅ 性能分析
- ✅ 文档生成

## 🚀 部署和运维

### 功能特性
- **容器化部署**: Docker和Docker Compose支持
- **Web服务器**: Nginx反向代理和负载均衡
- **进程管理**: Supervisor进程管理
- **监控告警**: 系统监控和告警通知

### 部署支持
- ✅ Docker容器化
- ✅ Nginx配置
- ✅ 进程管理
- ✅ 监控告警
- ✅ 日志收集

## 📊 性能优化

### 优化策略
- **数据库优化**: 索引优化和查询优化
- **缓存策略**: Redis缓存和本地缓存
- **异步处理**: 后台任务和异步操作
- **资源管理**: 连接池和资源限制

### 性能指标
- ✅ 响应时间优化
- ✅ 内存使用优化
- ✅ 数据库性能优化
- ✅ 缓存命中率优化
- ✅ 并发处理优化

---

**最后更新**: 2025-09-25  
**文档版本**: v1.1.0  
**维护团队**: TaifishingV4 Team
