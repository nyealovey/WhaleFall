# 分区管理功能技术文档

## 1. 功能概述

### 1.1 模块职责
- 提供PostgreSQL数据库表的分区创建、维护和清理功能，主要针对数据库大小统计表和聚合表。
- 实现按月分区策略，提高查询性能和数据管理效率。
- 支持多张表的分区管理，包括统计表、聚合表、实例统计表和实例聚合表。
- 集成定时任务系统，实现自动化的分区管理。

### 1.2 代码定位
- 服务：`app/services/partition_management_service.py`（分区管理核心服务）
- 任务：`app/tasks/partition_management_tasks.py`（分区管理定时任务）
- 路由：`app/routes/partition.py`（分区管理API路由）
- 前端：`app/templates/database_sizes/partitions.html`、`app/static/js/pages/database_sizes/partitions.js`

## 2. 架构设计

### 2.1 模块关系
```
┌─────────────────────────────┐
│ 前端分区管理界面             │
│  - 分区状态监控            │
│  - 分区创建和清理          │
│  - 分区信息展示            │
└───────▲───────────┬──────┘
        │AJAX        │
┌───────┴───────────▼──────┐
│ Flask 路由 (partition.py) │
│  - /partitions/          │
│  - /partitions/create     │
│  - /partitions/cleanup    │
└───────▲───────────┬──────┘
        │服务调用    │
┌───────┴───────────▼──────┐
│ 分区管理服务              │
│  - PartitionManagementService│
│  - 分区创建和清理          │
│  - 分区监控和统计          │
└────────────────────────────┘
```

### 2.2 权限控制
- 所有接口使用 `@login_required` 和 `@admin_required`。

## 3. 核心服务（`partition_management_service.py`）

### 3.1 PartitionManagementService类
- 管理四张表的分区：数据库统计表、数据库聚合表、实例统计表、实例聚合表。
- 支持按月分区策略，自动计算分区时间范围。
- 提供分区创建、清理、监控和统计功能。

### 3.2 分区表配置
- `stats`：数据库统计表（`database_size_stats`）
- `aggregations`：数据库聚合表（`database_size_aggregations`）
- `instance_stats`：实例统计表（`instance_size_stats`）
- `instance_aggregations`：实例聚合表（`instance_size_aggregations`）

### 3.3 核心方法
- `create_partition()`（52-150）：创建指定日期的分区。
- `create_future_partitions()`（200-250）：创建未来几个月的分区。
- `cleanup_old_partitions()`（300-350）：清理过期分区。
- `get_partition_status()`（400-450）：获取分区状态信息。
- `_partition_exists()`（500-550）：检查分区是否存在。
- `_create_partition_indexes()`（600-650）：为分区创建索引。

## 4. 定时任务（`partition_management_tasks.py`）

### 4.1 分区创建任务
- `create_database_size_partitions()`（14-40）：
  - 每天凌晨2点执行。
  - 创建未来3个月的分区。
  - 记录执行结果和错误信息。

### 4.2 分区清理任务
- `cleanup_database_size_partitions()`（43-80）：
  - 每天凌晨3点执行。
  - 清理6个月前的过期分区。
  - 记录清理结果和错误信息。

## 5. 路由实现（`partition.py`）

### 5.1 分区管理页面
- `GET /partitions/`（30-50）：渲染分区管理页面。
- 显示分区状态概览和操作按钮。

### 5.2 分区创建API
- `POST /partitions/create`（60-100）：
  - 创建指定日期的分区。
  - 支持批量创建未来几个月的分区。
  - 返回创建结果和详细信息。

### 5.3 分区清理API
- `POST /partitions/cleanup`（110-150）：
  - 清理过期分区。
  - 支持指定清理时间范围。
  - 返回清理结果和统计信息。

### 5.4 分区状态API
- `GET /partitions/status`（160-200）：
  - 获取分区状态信息。
  - 包括分区数量、大小、健康状态等。
  - 支持按表类型筛选。

## 6. 前端实现

### 6.1 分区管理页面（`partitions.html`）
- 分区状态概览：显示各表的分区数量和状态。
- 操作按钮：刷新、创建分区、清理旧分区。
- 分区列表：显示分区详细信息。
- 统计图表：显示分区使用情况。

### 6.2 前端JavaScript（`partitions.js`）
- `loadPartitionData()`（50-100）：加载分区数据。
- `createPartition()`（150-200）：创建分区。
- `cleanupPartitions()`（250-300）：清理分区。
- `updatePartitionStatus()`（350-400）：更新分区状态。

## 7. 核心功能实现

### 7.1 分区创建功能
- **按月分区**：根据日期自动计算分区时间范围。
- **多表支持**：同时为四张表创建分区。
- **索引创建**：为每个分区创建优化索引。
- **重复检查**：避免创建重复分区。

### 7.2 分区清理功能
- **过期清理**：自动清理指定时间前的分区。
- **安全删除**：确认分区无数据后再删除。
- **批量清理**：支持批量清理多个分区。
- **清理统计**：记录清理结果和统计信息。

### 7.3 分区监控功能
- **状态监控**：监控分区健康状态。
- **性能统计**：统计分区大小和性能。
- **使用情况**：分析分区使用情况。
- **告警通知**：异常情况告警通知。

## 8. 数据库设计

### 8.1 分区表结构
- 主表：定义分区键和约束。
- 分区表：按月创建的子表。
- 索引：为分区表创建优化索引。
- 约束：确保数据完整性。

### 8.2 分区策略
- **分区键**：使用日期字段作为分区键。
- **分区范围**：按月分区，每月一个分区。
- **分区命名**：使用表名_年月格式。
- **分区维护**：定期创建和清理分区。

## 9. 性能优化

### 9.1 查询优化
- 分区裁剪：只查询相关分区。
- 索引优化：为分区表创建合适索引。
- 统计信息：定期更新分区统计信息。
- 查询计划：优化查询执行计划。

### 9.2 存储优化
- 分区压缩：压缩旧分区数据。
- 数据清理：定期清理过期数据。
- 存储监控：监控分区存储使用情况。
- 空间回收：回收删除分区的空间。

## 10. 错误处理

### 10.1 分区创建错误
- 重复分区检查。
- 权限不足处理。
- 磁盘空间不足处理。
- 数据库连接错误处理。

### 10.2 分区清理错误
- 分区不存在处理。
- 数据依赖检查。
- 清理权限验证。
- 清理失败回滚。

## 11. 测试建议

### 11.1 功能测试
- 分区创建的准确性。
- 分区清理的完整性。
- 分区监控的实时性。
- 定时任务的可靠性。

### 11.2 性能测试
- 大量分区的查询性能。
- 分区创建和清理的效率。
- 并发操作的稳定性。
- 内存使用情况。

## 12. 后续优化方向

### 12.1 功能增强
- 支持更多分区策略。
- 添加分区数据迁移功能。
- 实现分区自动优化。
- 添加分区性能分析。

### 12.2 监控增强
- 集成监控系统。
- 添加分区告警机制。
- 实现分区趋势分析。
- 提供分区健康检查。

### 12.3 自动化增强
- 智能分区创建策略。
- 自动分区优化建议。
- 分区容量预测。
- 自动分区清理策略。
