# 凭据管理功能技术文档

## 1. 功能概述

### 1.1 模块职责
- 提供数据库连接凭据的CRUD操作，支持多种凭据类型和数据库类型。
- 实现凭据的安全存储和加密管理，支持密码强度验证。
- 提供凭据与实例的关联管理，支持标签分类和搜索筛选。
- 实现凭据的状态管理和操作审计日志。

### 1.2 代码定位
- 路由：`app/routes/credentials.py`
- 模型：`app/models/credential.py`
- 模板：`app/templates/credentials/list.html`、`create.html`、`edit.html`、`detail.html`
- 工具：`app/utils/security.py`、`app/utils/password_manager.py`

## 2. 架构设计

### 2.1 模块关系
```
┌─────────────────────────────┐
│ 前端凭据管理界面             │
│  - 凭据列表/搜索            │
│  - 创建/编辑表单            │
│  - 详情查看/状态切换        │
└───────▲───────────┬──────┘
        │AJAX        │
┌───────┴───────────▼──────┐
│ Flask 路由 (credentials_bp)│
│  - / (列表)              │
│  - /create (创建)        │
│  - /<id>/edit (编辑)     │
│  - /<id>/toggle (状态)   │
│  - /<id>/delete (删除)   │
└───────▲───────────┬──────┘
        │SQLAlchemy │安全验证
┌───────┴───────────▼──────┐
│ 数据层与安全              │
│  - Credential (模型)      │
│  - PasswordManager (加密) │
│  - SecurityUtils (验证)   │
└────────────────────────────┘
```

### 2.2 权限控制
- 所有接口使用 `@login_required`，查看操作需 `@view_required`，写操作需 `@create_required`、`@update_required`、`@delete_required`。

## 3. 数据模型（`credential.py`）

### 3.1 核心字段
- `id`：主键
- `name`：凭据名称（唯一，索引）
- `credential_type`：凭据类型（索引）
- `db_type`：数据库类型（索引）
- `username`：用户名
- `password`：加密密码
- `description`：描述
- `instance_ids`：关联实例ID列表（JSON）
- `category_id`：分类ID
- `is_active`：是否激活
- `created_at`、`updated_at`、`deleted_at`：时间戳

### 3.2 密码管理方法
- `set_password(password)`（62-70）：使用 `PasswordManager` 加密存储密码。
- `check_password(password)`（72-92）：支持多种密码格式验证（bcrypt、加密、明文）。
- `get_password_masked()`（94-103）：获取掩码密码用于显示。
- `get_plain_password()`（105-134）：获取原始密码用于数据库连接。

### 3.3 工具方法
- `to_dict(include_password=False)`（136-163）：序列化为字典，可选择是否包含密码。
- `soft_delete()`（165-178）：软删除凭据。
- `restore()`（180-193）：恢复软删除的凭据。
- `get_active_credentials()`（195-198）：获取所有活跃凭据。
- `get_by_type(credential_type)`（200-203）：根据类型获取凭据。
- `get_by_db_type(db_type)`（205-208）：根据数据库类型获取凭据。

## 4. 路由实现（`credentials.py`）

### 4.1 列表页面
- `GET /`（32-132）：
  - 支持分页、搜索、筛选（凭据类型、数据库类型、状态、标签）。
  - 使用 `outerjoin` 统计每个凭据关联的实例数量（47-49）。
  - 支持JSON和HTML两种响应格式（107-120、122-132）。

### 4.2 创建凭据
- `GET/POST /create`（135-252）：
  - 输入验证：必填字段、用户名格式、密码强度、数据库类型、凭据类型（146-186）。
  - 唯一性验证：凭据名称不能重复（188-195）。
  - 密码加密：使用 `set_password()` 方法加密存储（199-206）。
  - 操作日志：记录创建操作（212-220）。

### 4.3 编辑凭据
- `GET/POST /<id>/edit`（255-384）：
  - 支持部分更新，密码可选更新（286-292、340-341）。
  - 唯一性验证：排除当前凭据的名称重复检查（311-320）。
  - 布尔值处理：正确处理 `is_active` 字段的字符串和布尔值（332-337）。
  - 操作日志：记录更新操作（346-355）。

### 4.4 状态切换
- `POST /<id>/toggle`（387-429）：
  - 支持启用/禁用凭据状态。
  - 操作日志：记录状态切换操作（401-408）。

### 4.5 删除凭据
- `POST /<id>/delete`（432-472）：
  - 硬删除凭据记录。
  - 操作日志：记录删除操作（449-456）。

### 4.6 API接口
- `GET /api/credentials`（476-482）：获取活跃凭据列表API。
- `GET /<id>`（485-491）：查看凭据详情页面。
- `GET /api/credentials/<id>`（494-500）：获取凭据详情API。

## 5. 安全验证（`security.py`）

### 5.1 输入验证函数
- `validate_required_fields(data, fields)`：验证必填字段。
- `validate_username(username)`：验证用户名格式。
- `validate_password(password)`：验证密码强度。
- `validate_db_type(db_type)`：验证数据库类型。
- `validate_credential_type(credential_type)`：验证凭据类型。
- `sanitize_form_data(data)`：清理表单数据。

### 5.2 密码管理（`password_manager.py`）
- 支持多种加密方式：bcrypt、自定义加密。
- 密码强度验证：长度、复杂度要求。
- 密码解密：用于数据库连接。

## 6. 前端实现

### 6.1 列表页面功能
- 支持多条件搜索和筛选。
- 分页显示凭据列表。
- 显示每个凭据关联的实例数量。
- 支持按凭据类型、数据库类型、状态筛选。

### 6.2 表单功能
- 创建/编辑凭据表单。
- 实时输入验证和错误提示。
- 密码强度指示器。
- 支持标签选择和多选。

### 6.3 操作功能
- 状态切换（启用/禁用）。
- 删除确认对话框。
- 详情查看模态框。
- 批量操作支持。

## 7. 数据安全

### 7.1 密码加密
- 使用 `PasswordManager` 进行密码加密。
- 支持多种加密格式的兼容性。
- 密码存储采用加密格式，不存储明文。

### 7.2 访问控制
- 所有操作需要相应的权限验证。
- 密码字段在API响应中默认掩码。
- 操作日志记录所有敏感操作。

### 7.3 输入验证
- 严格的输入验证和清理。
- SQL注入防护。
- XSS攻击防护。

## 8. 错误处理

### 8.1 后端错误处理
- 数据库约束错误处理（236-241）。
- 输入验证错误处理。
- 异常回滚和日志记录。

### 8.2 前端错误处理
- AJAX请求错误处理。
- 表单验证错误提示。
- 用户友好的错误消息。

## 9. 性能优化

### 9.1 查询优化
- 使用索引优化查询性能。
- 分页查询避免大量数据加载。
- 使用 `outerjoin` 统计关联数据。

### 9.2 前端优化
- 异步加载和更新。
- 防抖搜索输入。
- 缓存常用数据。

## 10. 测试建议

### 10.1 功能测试
- 凭据CRUD操作的完整性。
- 密码加密和解密的正确性。
- 输入验证的有效性。

### 10.2 安全测试
- 密码强度验证。
- 输入清理和验证。
- 权限控制测试。

## 11. 后续优化方向

### 11.1 功能增强
- 添加凭据导入/导出功能。
- 实现凭据模板和快速创建。
- 支持凭据分组和批量管理。

### 11.2 安全增强
- 实现密码轮换机制。
- 添加凭据使用审计。
- 支持多因素认证。

### 11.3 用户体验
- 提供凭据使用统计。
- 添加凭据过期提醒。
- 实现凭据共享和协作。
