# 数据库概览页面需求说明

## 1. 背景与目标

为了补齐容量监控场景中的“数据库视角”管理能力，需要在「数据库管理」菜单下新增一个界面，快速查阅各实例下
数据库的基本信息、容量情况，并支持按标签筛选与导出 CSV。页面风格需与现有「账户管理」页面保持统一，保证
用户在操作习惯与交互逻辑上的一致性。

该页面主要面向 DBA/运维人员，用于：

- 统一浏览所有数据库（跨实例）的关键属性；
- 按名称或标签快速定位数据库；
- 导出当前筛选结果以便做容量报告或线下分析。

## 2. 角色与权限

- 入口位于主导航的「数据库管理」分组内，仅允许具有 `instance_management.database_overview.view` 权限的用户访问；
- 导出 CSV 需要额外的 `instance_management.database_overview.export` 权限；
- 页面本身只提供只读数据展示，不提供编辑操作。

## 3. 页面入口与路由

- 页面路径：`/database_management/databases`；
- 新增蓝图路由文件 `app/routes/database_overview.py`（与实例、账户等模块对齐）；
- 菜单更新：在 `base.html` 的「数据库管理」菜单下添加「数据库概览」条目。

## 4. 页面结构与交互

### 4.1 页面头部

- 标题：`数据库概览`，左侧图标使用 `fas fa-database`；
- 右侧操作按钮（从左到右）：
  1. `导出 CSV`：触发当前筛选条件下的数据导出。

### 4.2 检索区域

沿用「账户管理」的统一搜索组件 `components/unified_search_form.html`：

- 搜索输入框：支持名称模糊搜索（数据库名称、实例名称、IP 地址任意匹配）；
- 标签筛选：复用现有标签组件，可多选；
- 其余筛选项隐藏（不显示分类、数据库类型分组等）；
- 查询按钮、重置按钮保持现有样式；
- 搜索条件序列化为 query string 以保持可分享性。

### 4.3 数据表格

列顺序与字段定义如下：

| 列 | 字段来源 | 说明 |
| --- | --- | --- |
| 数据库名称 | `database_size_stats.database_name` | 最新容量记录中的库名 |
| 实例名称 | `instances.name` | 所属实例 |
| IP 地址 | `instances.host` | 所属实例主机 |
| 标签 | `instance.tags` | 复用实例标签，多值展示为 badge |
| 数据库类型 | `instances.db_type` | 支持 MySQL / PostgreSQL / SQL Server / Oracle 等 |
| 容量大小 | `database_size_stats.size_mb` | 最新容量（MB）；前端统一换算显示 MB/GB |

表格行为：

- 默认按容量降序排列；
- 支持分页，默认每页 20 条；
- 鼠标悬停显示完整标签列表与容量值；
- 当前需求不提供行内操作按钮。

### 4.4 空状态与错误处理

- 空数据（无匹配结果）：展示统一的空状态组件，并提示检查筛选条件；
- 数据加载失败：显示错误提示并提供重试按钮；
- 搜索请求超时要在日志中记录。

## 5. 后端接口

### 5.1 数据列表接口

- 路由：`GET /api/database-management/databases`；
- 查询参数：
  - `search`: 字符串，匹配数据库名称、实例名称、IP；
  - `tags`: 多值，基于实例标签 ID；
  - `page`: 页码，默认 1；
  - `per_page`: 每页数量，默认 20，最大 100；
- 返回数据：分页结构 `{ items: [...], total, page, per_page }`；
- 数据来源：
  1. 从 `database_size_stats` 中选取每个 `instance_id + database_name` 的最新记录；
  2. 关联 `instances`、`instance_tags`、`tags` 获取实例信息及标签；
- 需要考虑性能：查询使用窗口函数或子查询获取最新记录，并在 `instance_id, database_name, collected_date` 上利用索引。

### 5.2 导出接口

- 路由：`GET /api/database-management/databases/export`；
- 接收与列表相同的查询参数；
- 直接复用数据查询逻辑，生成 CSV 文件并返回文件下载；
- CSV 列顺序与表格一致，单位统一使用 MB；
- 记录导出操作日志（使用现有审计机制）。

## 6. 前端实现

- 新增 `app/templates/database_management/databases.html`；
- 新建脚本 `app/static/js/pages/database_management/databases.js` 负责：
  - 初始化搜索表单、读取 query 参数；
  - 调用列表接口、渲染表格、处理分页；
  - 绑定导出按钮，跳转导出接口；
- 样式复用账户管理页面，新增轻量 CSS 文件（若必要）。

## 7. 数据指标与埋点

- 记录页面访问日志，附带筛选条件；
- 导出操作写入操作日志（实例数量、筛选标签等）；
- 可选：统计标签使用频次，为后续优化提供依据。

## 8. 验收标准

1. 在菜单中能看到「数据库概览」入口，并根据权限控制显示；
2. 页面可通过搜索/标签筛选正确过滤数据；
3. 表格列展示信息完整、排序/分页正确，容量换算符合预期；
4. 导出 CSV 与当前列表数据一致，下载文件内容正确；
5. 空状态、错误提示处理得当，无前端报错；
6. 日志记录包含访问、导出操作；
7. 性能满足：默认条件下接口响应时间 < 2s（20 条），筛选后不显著退化。

## 9. 后续扩展建议

- 增加容量时间线跳转，点击库名进入历史趋势页面；
- 支持按实例或数据库类型的快速筛选；
- 引入容量阈值告警标识；
- 提供批量导出/报告生成。
