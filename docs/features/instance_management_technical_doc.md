# 实例管理功能技术文档

## 1. 功能概述

### 1.1 模块职责
- 提供数据库实例的完整生命周期管理，包括创建、编辑、删除、查询、连接测试等操作。
- 支持多种数据库类型（MySQL、PostgreSQL、SQL Server、Oracle）的实例管理。
- 实现实例的批量操作、标签管理、容量同步等高级功能。
- 提供实例统计和监控功能，支持实例状态跟踪和性能分析。

### 1.2 代码定位
- 路由：`app/routes/instances.py`（实例管理核心路由）
- 模型：`app/models/instance.py`（实例数据模型）
- 前端：`app/templates/instances/list.html`、`app/static/js/pages/instances/list.js`
- 服务：`app/services/connection_test_service.py`、`app/services/database_size_collector_service.py`

## 2. 架构设计

### 2.1 模块关系
```
┌─────────────────────────────┐
│ 前端管理界面                 │
│  - 实例列表展示            │
│  - 搜索筛选功能            │
│  - 批量操作控制            │
│  - 标签管理集成            │
└───────▲───────────┬──────┘
        │AJAX        │
┌───────┴───────────▼──────┐
│ Flask 路由 (instances.py) │
│  - CRUD操作接口          │
│  - 批量操作接口          │
│  - 连接测试接口          │
│  - 容量同步接口          │
└───────▲───────────┬──────┘
        │SQLAlchemy │服务调用
┌───────┴───────────▼──────┐
│ 数据层与服务              │
│  - Instance模型           │
│  - 连接测试服务           │
│  - 容量采集服务           │
└────────────────────────────┘
```

### 2.2 权限控制
- 所有接口使用 `@login_required` 和相应的权限装饰器。
- 创建：`@create_required`，编辑：`@update_required`，删除：`@delete_required`，查看：`@view_required`。

## 3. 数据模型（`instance.py`）

### 3.1 Instance模型结构
- `id`：主键，自增整数。
- `name`：实例名称，唯一索引，最大255字符。
- `db_type`：数据库类型，索引，支持MySQL、PostgreSQL、SQL Server、Oracle。
- `host`：主机地址，最大255字符。
- `port`：端口号，整数类型。
- `database_name`：数据库名称，可选。
- `database_version`：原始版本字符串，最大1000字符。
- `main_version`：主版本号（如8.0、13.4、14.0），最大20字符。
- `detailed_version`：详细版本号（如8.0.32、13.4、14.0.3465.1），最大50字符。
- `environment`：环境类型，默认production，索引。
- `sync_count`：同步次数，默认0。
- `credential_id`：关联凭据ID，外键。
- `description`：描述信息，文本类型。
- `status`：状态，默认active，索引。
- `is_active`：是否活跃，布尔类型。
- `last_connected`：最后连接时间，带时区的时间戳。
- `created_at`、`updated_at`、`deleted_at`：时间戳字段。

### 3.2 关系定义
- `credential`：与凭据的一对多关系。
- `tags`：与标签的多对多关系，通过`instance_tags`中间表。
- `database_size_stats`：与数据库大小统计的一对多关系。
- `instance_databases`：与实例数据库的一对多关系。

## 4. 路由实现（`instances.py`）

### 4.1 实例列表查询
- `GET /instances/`（141-200）：
  - 支持分页查询，默认每页10条记录。
  - 支持按名称、主机、描述搜索。
  - 支持按数据库类型、状态筛选。
  - 支持按标签筛选，使用多对多关系查询。
  - 返回HTML页面或JSON数据。

### 4.2 实例创建
- `GET /instances/create`（203-210）：渲染创建表单页面。
- `POST /instances/create`（213-280）：
  - 验证必填字段：名称、数据库类型、主机、端口。
  - 验证数据库类型是否支持。
  - 检查实例名称唯一性。
  - 创建实例并保存到数据库。
  - 记录操作日志。

### 4.3 实例编辑
- `GET /instances/<id>/edit`（283-300）：渲染编辑表单页面。
- `POST /instances/<id>/edit`（303-380）：
  - 验证表单数据。
  - 更新实例信息。
  - 记录操作日志。

### 4.4 实例删除
- `POST /instances/<id>/delete`（383-420）：
  - 软删除实例（设置deleted_at）。
  - 删除关联数据：分类分配、同步数据、同步记录、变更日志。
  - 记录操作日志。

### 4.5 连接测试
- `POST /instances/<id>/test-connection`（423-460）：
  - 使用`ConnectionTestService`测试数据库连接。
  - 更新最后连接时间。
  - 返回连接测试结果。

### 4.6 批量操作
- `POST /instances/batch-delete`（463-500）：批量删除选中的实例。
- `POST /instances/batch-create`（503-540）：批量创建实例，支持CSV文件上传。

## 5. 前端实现

### 5.1 实例列表页面（`list.html`）
- 搜索筛选表单：支持按名称、主机、描述搜索，按数据库类型、状态、标签筛选。
- 实例卡片展示：显示实例基本信息、状态指示器、操作按钮。
- 批量操作工具栏：全选、批量删除、批量创建功能。
- 分页导航：支持分页浏览实例列表。

### 5.2 前端JavaScript（`list.js`）
- `loadInstanceTotalSizes()`（45-82）：异步加载实例总大小信息。
- `formatSize()`（85-92）：格式化文件大小显示，统一使用GB单位。
- `initializeInstanceListTagSelector()`（95-150）：初始化标签选择器组件。
- `testConnection()`（200-250）：测试实例连接，显示加载状态和结果。
- `syncCapacity()`（300-350）：同步实例容量数据。
- `batchDelete()`（400-450）：批量删除选中的实例。
- `batchCreate()`（500-550）：批量创建实例，支持文件上传。

## 6. 核心功能实现

### 6.1 实例CRUD操作
- **创建**：表单验证 → 数据清理 → 唯一性检查 → 数据库保存 → 日志记录。
- **查询**：多条件筛选 → 分页查询 → 关联数据预加载 → 结果返回。
- **更新**：数据验证 → 权限检查 → 数据更新 → 日志记录。
- **删除**：软删除 → 关联数据清理 → 日志记录。

### 6.2 连接测试功能
- 使用`ConnectionTestService`进行数据库连接测试。
- 支持多种数据库类型的连接验证。
- 测试成功后更新`last_connected`字段。
- 提供详细的错误信息和状态反馈。

### 6.3 容量同步功能
- 集成`DatabaseSizeCollectorService`进行容量数据采集。
- 支持MySQL、SQL Server、PostgreSQL、Oracle的容量统计。
- 异步加载实例总大小信息。
- 提供容量同步状态和进度反馈。

### 6.4 标签管理功能
- 集成标签选择器组件。
- 支持多标签筛选和搜索。
- 标签与实例的多对多关系管理。
- 标签创建、编辑、删除功能。

## 7. 批量操作功能

### 7.1 批量删除
- 前端：选中多个实例 → 确认删除 → 发送批量删除请求。
- 后端：遍历实例ID → 软删除每个实例 → 清理关联数据 → 返回结果。

### 7.2 批量创建
- 支持CSV文件上传和JSON数据输入。
- 数据验证：必填字段检查、数据类型验证、唯一性检查。
- 错误处理：收集验证错误，返回详细的错误信息。
- 事务处理：确保批量操作的原子性。

## 8. 数据验证和安全

### 8.1 数据验证
- 使用`DataValidator`进行表单数据验证。
- 必填字段检查：名称、数据库类型、主机、端口。
- 数据类型验证：端口号整数验证、凭据ID验证。
- 业务规则验证：数据库类型支持检查、实例名称唯一性。

### 8.2 安全措施
- 使用`sanitize_form_data()`清理用户输入。
- 防止SQL注入：使用SQLAlchemy ORM。
- 权限控制：基于角色的访问控制。
- 操作审计：记录所有关键操作。

## 9. 性能优化

### 9.1 查询优化
- 使用索引优化查询性能。
- 分页查询避免大量数据加载。
- 预加载关联数据减少N+1查询。
- 使用窗口函数优化复杂查询。

### 9.2 前端优化
- 异步加载实例容量数据。
- 防抖搜索避免频繁请求。
- 缓存标签选择器数据。
- 懒加载和虚拟滚动。

## 10. 错误处理

### 10.1 后端错误处理
- 统一异常处理装饰器。
- 详细的错误日志记录。
- 用户友好的错误信息。
- 操作回滚和恢复机制。

### 10.2 前端错误处理
- AJAX请求错误处理。
- 用户操作错误提示。
- 网络异常处理。
- 数据验证错误显示。

## 11. 测试建议

### 11.1 功能测试
- 实例CRUD操作的正确性。
- 连接测试的准确性。
- 批量操作的功能性。
- 标签管理的完整性。

### 11.2 性能测试
- 大量实例的查询性能。
- 批量操作的执行效率。
- 并发操作的稳定性。
- 内存使用和响应时间。

## 12. 后续优化方向

### 12.1 功能增强
- 添加实例健康检查功能。
- 实现实例性能监控。
- 支持实例配置管理。
- 添加实例备份和恢复功能。

### 12.2 性能优化
- 实现实例数据缓存。
- 优化大量实例的查询性能。
- 添加实例数据预加载。
- 实现实例状态实时更新。

### 12.3 监控告警
- 集成实例监控系统。
- 添加实例异常告警。
- 实现实例性能分析。
- 提供实例使用报告。
