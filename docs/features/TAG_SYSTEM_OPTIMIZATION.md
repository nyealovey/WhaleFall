# é²¸è½æ ‡ç­¾ç³»ç»Ÿä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### å½“å‰é—®é¢˜
- æ ‡ç­¾åˆ†ç±»æ··ä¹±ï¼Œç¼ºä¹ç»Ÿä¸€çš„ç®¡ç†ä½“ç³»
- äººå‘˜ä¿¡æ¯æ— æ³•é€šè¿‡æ ‡ç­¾è¿›è¡Œç®¡ç†
- æ‰‹åŠ¨å’Œè‡ªåŠ¨æ ‡ç­¾æ··åˆç®¡ç†ï¼Œç¼ºä¹åŒºåˆ†

### ä¼˜åŒ–ç›®æ ‡
1. **èµ„æºç±»æ ‡ç­¾**: å°†ç°æœ‰æ ‡ç­¾é‡æ–°æ•´ç†ï¼Œå–æ¶ˆå…¬å¸ç±»å‹å’Œéƒ¨é—¨æ ‡ç­¾ï¼Œæ”¯æŒæ‰‹åŠ¨ç®¡ç†
2. **èº«ä»½ç±»æ ‡ç­¾**: æ–°å¢èº«ä»½ç±»æ ‡ç­¾ï¼Œä»é£ä¹¦è‡ªåŠ¨åŒæ­¥äººå‘˜ä¿¡æ¯
3. **é£ä¹¦é›†æˆ**: æ”¯æŒé£ä¹¦APIåŒæ­¥ï¼Œå¯æŒ‰éƒ¨é—¨ç­›é€‰åŒæ­¥èŒƒå›´
4. **ä¸‰çº§éƒ¨é—¨**: æ”¯æŒå…¬å¸-éƒ¨é—¨-ç§‘å®¤çš„ä¸‰çº§éƒ¨é—¨ç»“æ„

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ ‡ç­¾åˆ†ç±»ä½“ç³»

```
æ ‡ç­¾ç³»ç»Ÿ
â”œâ”€â”€ èµ„æºç±»æ ‡ç­¾ (Resource Tags) - æ‰‹åŠ¨ç®¡ç†
â”‚   â”œâ”€â”€ åœ°åŒºæ ‡ç­¾ (location)
â”‚   â”œâ”€â”€ ç¯å¢ƒæ ‡ç­¾ (environment)
â”‚   â”œâ”€â”€ é¡¹ç›®æ ‡ç­¾ (project)
â”‚   â”œâ”€â”€ è™šæ‹ŸåŒ–ç±»å‹ (virtualization)
â”‚   â”œâ”€â”€ éƒ¨ç½²æ–¹å¼ (deployment)
â”‚   â”œâ”€â”€ æ¶æ„ç±»å‹ (architecture)
â”‚   â””â”€â”€ å…¶ä»–æ ‡ç­¾ (other)
â””â”€â”€ èº«ä»½ç±»æ ‡ç­¾ (Identity Tags) - é£ä¹¦è‡ªåŠ¨åŒæ­¥
    â””â”€â”€ ç”¨æˆ·æ ‡ç­¾ (user) - ä¸ªäººç”¨æˆ·
```

### é£ä¹¦åŒæ­¥æœºåˆ¶

```
é£ä¹¦APIåŒæ­¥
â”œâ”€â”€ ç”¨æˆ·ä¿¡æ¯åŒæ­¥
â”‚   â”œâ”€â”€ åŸºæœ¬ä¿¡æ¯ (å§“åã€å·¥å·ã€é‚®ç®±)
â”‚   â”œâ”€â”€ éƒ¨é—¨ä¿¡æ¯ (ä¸‰çº§éƒ¨é—¨ç»“æ„)
â”‚   â””â”€â”€ çŠ¶æ€ä¿¡æ¯ (åœ¨èŒçŠ¶æ€)
â””â”€â”€ åŒæ­¥èŒƒå›´æ§åˆ¶
    â”œâ”€â”€ æŒ‰éƒ¨é—¨ç­›é€‰
    â”œâ”€â”€ æŒ‰çŠ¶æ€ç­›é€‰
    â””â”€â”€ å®šæ—¶åŒæ­¥ (æ¯æ—¥)
```

### æ ‡ç­¾å±æ€§è®¾è®¡

#### èµ„æºç±»æ ‡ç­¾å±æ€§
- **è¾“å…¥æ–¹å¼**: æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†
- **ç®¡ç†æƒé™**: ç®¡ç†å‘˜å’ŒDBAå¯ç®¡ç†
- **ä½¿ç”¨åœºæ™¯**: èµ„æºåˆ†ç±»ã€ç­›é€‰ã€ç»Ÿè®¡
- **æ•°æ®æ¥æº**: ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
- **åˆ†ç±»èŒƒå›´**: åœ°åŒºã€ç¯å¢ƒã€é¡¹ç›®ã€è™šæ‹ŸåŒ–ã€éƒ¨ç½²ã€æ¶æ„ã€å…¶ä»–

#### èº«ä»½ç±»æ ‡ç­¾å±æ€§
- **è¾“å…¥æ–¹å¼**: é£ä¹¦APIè‡ªåŠ¨åŒæ­¥
- **ç®¡ç†æƒé™**: ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œä¸å¯æ‰‹åŠ¨ä¿®æ”¹
- **ä½¿ç”¨åœºæ™¯**: æƒé™æ§åˆ¶ã€è´£ä»»å½’å±ã€å®¡è®¡è¿½è¸ª
- **æ•°æ®æ¥æº**: é£ä¹¦å¼€æ”¾å¹³å°API
- **åˆ†ç±»èŒƒå›´**: ç”¨æˆ·
- **åŒæ­¥é¢‘ç‡**: æ¯æ—¥å®šæ—¶åŒæ­¥
- **ç­›é€‰èŒƒå›´**: å¯æŒ‰éƒ¨é—¨å±‚çº§ç­›é€‰åŒæ­¥

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æ ‡ç­¾è¡¨ç»“æ„ä¼˜åŒ–

```sql
-- æ ‡ç­¾è¡¨ (ä¼˜åŒ–å)
CREATE TABLE IF NOT EXISTS tags (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    display_name VARCHAR(100) NOT NULL,
    category_type VARCHAR(20) NOT NULL,  -- 'resource' æˆ– 'identity'
    category VARCHAR(50) NOT NULL,       -- å…·ä½“åˆ†ç±»
    color VARCHAR(20) DEFAULT 'primary' NOT NULL,
    description TEXT,
    sort_order INTEGER DEFAULT 0 NOT NULL,
    is_active BOOLEAN DEFAULT TRUE NOT NULL,
    is_auto_sync BOOLEAN DEFAULT FALSE NOT NULL,  -- æ˜¯å¦è‡ªåŠ¨åŒæ­¥
    sync_source VARCHAR(50),                      -- åŒæ­¥æ¥æº (feishu)
    sync_id VARCHAR(100),                         -- é£ä¹¦ç”¨æˆ·ID (open_id)
    department_path VARCHAR(500),                 -- éƒ¨é—¨è·¯å¾„ (å…¬å¸-éƒ¨é—¨-ç§‘å®¤)
    user_status VARCHAR(20) DEFAULT 'active',     -- ç”¨æˆ·çŠ¶æ€ (active/inactive)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    synced_at TIMESTAMP WITH TIME ZONE            -- æœ€ååŒæ­¥æ—¶é—´
);

-- æ–°å¢ç´¢å¼•
CREATE INDEX IF NOT EXISTS ix_tags_category_type ON tags(category_type);
CREATE INDEX IF NOT EXISTS ix_tags_is_auto_sync ON tags(is_auto_sync);
CREATE INDEX IF NOT EXISTS ix_tags_sync_source ON tags(sync_source);
CREATE INDEX IF NOT EXISTS ix_tags_department_path ON tags(department_path);
```

### 2. é£ä¹¦åŒæ­¥é…ç½®è¡¨

```sql
-- é£ä¹¦åŒæ­¥é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS feishu_sync_config (
    id SERIAL PRIMARY KEY,
    app_id VARCHAR(100) NOT NULL,             -- é£ä¹¦åº”ç”¨ID
    app_secret VARCHAR(200) NOT NULL,         -- é£ä¹¦åº”ç”¨å¯†é’¥
    tenant_access_token TEXT,                 -- ç§Ÿæˆ·è®¿é—®ä»¤ç‰Œ
    token_expires_at TIMESTAMP WITH TIME ZONE, -- ä»¤ç‰Œè¿‡æœŸæ—¶é—´
    sync_departments JSONB,                   -- åŒæ­¥éƒ¨é—¨é…ç½®
    sync_users BOOLEAN DEFAULT TRUE NOT NULL, -- æ˜¯å¦åŒæ­¥ç”¨æˆ·
    is_active BOOLEAN DEFAULT TRUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- é£ä¹¦åŒæ­¥é…ç½®ç´¢å¼•
CREATE INDEX IF NOT EXISTS ix_feishu_sync_config_is_active ON feishu_sync_config(is_active);
```

### 3. é£ä¹¦åŒæ­¥æ—¥å¿—è¡¨

```sql
-- é£ä¹¦åŒæ­¥æ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS feishu_sync_logs (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(20) NOT NULL,           -- 'user'
    sync_action VARCHAR(20) NOT NULL,         -- 'create', 'update', 'delete'
    feishu_id VARCHAR(100) NOT NULL,          -- é£ä¹¦ç”¨æˆ·ID (open_id)
    local_id INTEGER,                         -- æœ¬åœ°ID
    sync_data JSONB,                          -- åŒæ­¥æ•°æ®
    status VARCHAR(20) NOT NULL,              -- 'success', 'failed', 'pending'
    error_message TEXT,                       -- é”™è¯¯ä¿¡æ¯
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åŒæ­¥æ—¥å¿—ç´¢å¼•
CREATE INDEX IF NOT EXISTS ix_feishu_sync_logs_sync_type ON feishu_sync_logs(sync_type);
CREATE INDEX IF NOT EXISTS ix_feishu_sync_logs_status ON feishu_sync_logs(status);
CREATE INDEX IF NOT EXISTS ix_feishu_sync_logs_created_at ON feishu_sync_logs(created_at);
```


## ğŸ”§ æ¨¡å‹è®¾è®¡

### 1. æ ‡ç­¾æ¨¡å‹ä¼˜åŒ–

```python
class Tag(db.Model):
    """æ ‡ç­¾æ¨¡å‹ - ä¼˜åŒ–ç‰ˆ"""
    
    __tablename__ = "tags"
    
    # åŸºç¡€å­—æ®µ
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), nullable=False, unique=True, index=True)
    display_name = db.Column(db.String(100), nullable=False)
    
    # åˆ†ç±»å­—æ®µ
    category_type = db.Column(db.String(20), nullable=False, index=True)  # 'resource' æˆ– 'identity'
    category = db.Column(db.String(50), nullable=False, index=True)
    
    # æ˜¾ç¤ºå­—æ®µ
    color = db.Column(db.String(20), default="primary", nullable=False)
    description = db.Column(db.Text, nullable=True)
    sort_order = db.Column(db.Integer, default=0, nullable=False)
    is_active = db.Column(db.Boolean, default=True, nullable=False)
    
    # åŒæ­¥å­—æ®µ
    is_auto_sync = db.Column(db.Boolean, default=False, nullable=False, index=True)
    sync_source = db.Column(db.String(50), nullable=True, index=True)  # 'feishu'
    sync_id = db.Column(db.String(100), nullable=True)  # é£ä¹¦ID
    synced_at = db.Column(db.DateTime(timezone=True), nullable=True)
    
    # èº«ä»½ç±»æ ‡ç­¾ç‰¹æœ‰å­—æ®µ
    department_path = db.Column(db.String(500), nullable=True, index=True)  # éƒ¨é—¨è·¯å¾„
    user_status = db.Column(db.String(20), default='active', nullable=False)  # ç”¨æˆ·çŠ¶æ€
    
    # æ—¶é—´å­—æ®µ
    created_at = db.Column(db.DateTime(timezone=True), default=now)
    updated_at = db.Column(db.DateTime(timezone=True), default=now, onupdate=now)
    
    # å…³ç³»
    instances = db.relationship("Instance", secondary="instance_tags", back_populates="tags")
    
    @staticmethod
    def get_category_type_choices():
        """è·å–åˆ†ç±»ç±»å‹é€‰é¡¹"""
        return [
            ("resource", "èµ„æºç±»"),
            ("identity", "èº«ä»½ç±»")
        ]
    
    @staticmethod
    def get_resource_categories():
        """è·å–èµ„æºç±»åˆ†ç±»"""
        return [
            ("location", "åœ°åŒºæ ‡ç­¾"),
            ("environment", "ç¯å¢ƒæ ‡ç­¾"),
            ("project", "é¡¹ç›®æ ‡ç­¾"),
            ("virtualization", "è™šæ‹ŸåŒ–ç±»å‹"),
            ("deployment", "éƒ¨ç½²æ–¹å¼"),
            ("architecture", "æ¶æ„ç±»å‹"),
            ("other", "å…¶ä»–æ ‡ç­¾")
        ]
    
    @staticmethod
    def get_identity_categories():
        """è·å–èº«ä»½ç±»åˆ†ç±»"""
        return [
            ("user", "ç”¨æˆ·æ ‡ç­¾")
        ]
```

### 2. é£ä¹¦åŒæ­¥é…ç½®æ¨¡å‹

```python
class FeishuSyncConfig(db.Model):
    """é£ä¹¦åŒæ­¥é…ç½®æ¨¡å‹"""
    
    __tablename__ = "feishu_sync_config"
    
    id = db.Column(db.Integer, primary_key=True)
    app_id = db.Column(db.String(100), nullable=False)
    app_secret = db.Column(db.String(200), nullable=False)
    tenant_access_token = db.Column(db.Text, nullable=True)
    token_expires_at = db.Column(db.DateTime(timezone=True), nullable=True)
    sync_departments = db.Column(db.JSON, nullable=True)  # åŒæ­¥éƒ¨é—¨é…ç½®
    sync_users = db.Column(db.Boolean, default=True, nullable=False)
    is_active = db.Column(db.Boolean, default=True, nullable=False)
    created_at = db.Column(db.DateTime(timezone=True), default=now)
    updated_at = db.Column(db.DateTime(timezone=True), default=now, onupdate=now)
    
    def to_dict(self):
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            "id": self.id,
            "app_id": self.app_id,
            "sync_departments": self.sync_departments,
            "sync_users": self.sync_users,
            "is_active": self.is_active,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None
        }
```

### 3. é£ä¹¦åŒæ­¥æ—¥å¿—æ¨¡å‹

```python
class FeishuSyncLog(db.Model):
    """é£ä¹¦åŒæ­¥æ—¥å¿—æ¨¡å‹"""
    
    __tablename__ = "feishu_sync_logs"
    
    id = db.Column(db.Integer, primary_key=True)
    sync_type = db.Column(db.String(20), nullable=False, index=True)  # 'user'
    sync_action = db.Column(db.String(20), nullable=False)  # 'create', 'update', 'delete'
    feishu_id = db.Column(db.String(100), nullable=False)  # é£ä¹¦ç”¨æˆ·ID (open_id)
    local_id = db.Column(db.Integer, nullable=True)
    sync_data = db.Column(db.JSON, nullable=True)
    status = db.Column(db.String(20), nullable=False, index=True)  # 'success', 'failed', 'pending'
    error_message = db.Column(db.Text, nullable=True)
    created_at = db.Column(db.DateTime(timezone=True), default=now, index=True)
    
    def to_dict(self):
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            "id": self.id,
            "sync_type": self.sync_type,
            "sync_action": self.sync_action,
            "feishu_id": self.feishu_id,
            "local_id": self.local_id,
            "sync_data": self.sync_data,
            "status": self.status,
            "error_message": self.error_message,
            "created_at": self.created_at.isoformat() if self.created_at else None
        }
```

## ğŸ”„ é£ä¹¦åŒæ­¥æœºåˆ¶è®¾è®¡

### 1. é£ä¹¦APIå®¢æˆ·ç«¯

```python
class FeishuAPIClient:
    """é£ä¹¦APIå®¢æˆ·ç«¯"""
    
    def __init__(self, app_id: str, app_secret: str):
        self.app_id = app_id
        self.app_secret = app_secret
        self.base_url = "https://open.feishu.cn/open-apis"
        self.tenant_access_token = None
        self.token_expires_at = None
    
    def get_tenant_access_token(self) -> str:
        """è·å–ç§Ÿæˆ·è®¿é—®ä»¤ç‰Œ"""
        if self.tenant_access_token and self.token_expires_at and now() < self.token_expires_at:
            return self.tenant_access_token
        
        url = f"{self.base_url}/auth/v3/tenant_access_token/internal"
        data = {
            "app_id": self.app_id,
            "app_secret": self.app_secret
        }
        
        response = requests.post(url, json=data)
        result = response.json()
        
        if result.get("code") == 0:
            self.tenant_access_token = result["tenant_access_token"]
            # è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
            expires_in = result.get("expire", 7200) - 300
            self.token_expires_at = now() + timedelta(seconds=expires_in)
            return self.tenant_access_token
        else:
            raise Exception(f"è·å–é£ä¹¦è®¿é—®ä»¤ç‰Œå¤±è´¥: {result.get('msg')}")
    
    def get_users(self, department_ids: list = None) -> list:
        """è·å–ç”¨æˆ·åˆ—è¡¨"""
        token = self.get_tenant_access_token()
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        }
        
        url = f"{self.base_url}/contact/v3/users"
        params = {
            "page_size": 100,
            "department_id_type": "open_department_id"
        }
        
        if department_ids:
            params["department_ids"] = department_ids
        
        all_users = []
        page_token = None
        
        while True:
            if page_token:
                params["page_token"] = page_token
            
            response = requests.get(url, headers=headers, params=params)
            result = response.json()
            
            if result.get("code") == 0:
                users = result.get("data", {}).get("items", [])
                # ç¡®ä¿æ¯ä¸ªç”¨æˆ·éƒ½æœ‰user_idå­—æ®µ
                for user in users:
                    if "user_id" not in user:
                        # å¦‚æœé£ä¹¦APIè¿”å›çš„å­—æ®µåä¸åŒï¼Œéœ€è¦æ˜ å°„
                        user["user_id"] = user.get("open_id") or user.get("union_id") or user.get("id")
                all_users.extend(users)
                
                page_token = result.get("data", {}).get("page_token")
                if not page_token:
                    break
            else:
                raise Exception(f"è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: {result.get('msg')}")
        
        return all_users
    
    def get_departments(self) -> list:
        """è·å–éƒ¨é—¨åˆ—è¡¨"""
        token = self.get_tenant_access_token()
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        }
        
        url = f"{self.base_url}/contact/v3/departments"
        params = {
            "page_size": 100,
            "department_id_type": "open_department_id"
        }
        
        all_departments = []
        page_token = None
        
        while True:
            if page_token:
                params["page_token"] = page_token
            
            response = requests.get(url, headers=headers, params=params)
            result = response.json()
            
            if result.get("code") == 0:
                departments = result.get("data", {}).get("items", [])
                all_departments.extend(departments)
                
                page_token = result.get("data", {}).get("page_token")
                if not page_token:
                    break
            else:
                raise Exception(f"è·å–éƒ¨é—¨åˆ—è¡¨å¤±è´¥: {result.get('msg')}")
        
        return all_departments
```

### 2. é£ä¹¦åŒæ­¥æœåŠ¡

```python
class FeishuSyncService:
    """é£ä¹¦åŒæ­¥æœåŠ¡"""
    
    def __init__(self):
        self.config = FeishuSyncConfig.query.filter_by(is_active=True).first()
        if not self.config:
            raise Exception("é£ä¹¦åŒæ­¥é…ç½®æœªæ‰¾åˆ°")
        
        self.client = FeishuAPIClient(self.config.app_id, self.config.app_secret)
    
    def sync_all(self) -> dict:
        """åŒæ­¥æ‰€æœ‰æ•°æ®"""
        result = {
            "users": {"created": 0, "updated": 0, "failed": 0}
        }
        
        try:
            # åŒæ­¥ç”¨æˆ·
            if self.config.sync_users:
                user_result = self.sync_users()
                result["users"] = user_result
            
            return result
            
        except Exception as e:
            log_error(f"é£ä¹¦åŒæ­¥å¤±è´¥: {str(e)}", module="feishu_sync")
            raise
    
    def sync_users(self) -> dict:
        """åŒæ­¥ç”¨æˆ·ä¿¡æ¯"""
        try:
            # è·å–åŒæ­¥éƒ¨é—¨é…ç½®
            sync_departments = self.config.sync_departments or []
            department_ids = [dept["id"] for dept in sync_departments] if sync_departments else None
            
            # è·å–é£ä¹¦ç”¨æˆ·æ•°æ®
            feishu_users = self.client.get_users(department_ids)
            
            created = 0
            updated = 0
            failed = 0
            
        for user_data in feishu_users:
            try:
                feishu_user_id = user_data["user_id"]  # è·å–é£ä¹¦ç”¨æˆ·ID
                # åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·æ ‡ç­¾
                tag_result = self._sync_user_tag(user_data)
                if tag_result == "created":
                    created += 1
                elif tag_result == "updated":
                    updated += 1
                    
                    # è®°å½•åŒæ­¥æ—¥å¿—
                    self._log_sync("user", "create" if tag_result == "created" else "update", 
                                 feishu_user_id, tag_result, user_data)
                    
                except Exception as e:
                    failed += 1
                    self._log_sync("user", "create", feishu_user_id, "failed", 
                                 user_data, str(e))
            
            return {"created": created, "updated": updated, "failed": failed}
            
        except Exception as e:
            log_error(f"åŒæ­¥ç”¨æˆ·å¤±è´¥: {str(e)}", module="feishu_sync")
            raise
    
    
    def _sync_user_tag(self, user_data: dict) -> str:
        """åŒæ­¥ç”¨æˆ·æ ‡ç­¾"""
        feishu_user_id = user_data["user_id"]  # é£ä¹¦ç”¨æˆ·ID
        display_name = user_data.get("name", "")
        email = user_data.get("email", "")
        user_status = user_data.get("status", "active")  # é£ä¹¦ç”¨æˆ·çŠ¶æ€
        
        # æ„å»ºéƒ¨é—¨è·¯å¾„
        department_path = self._build_department_path(user_data.get("department_ids", []))
        
        # æ ¹æ®ç”¨æˆ·çŠ¶æ€ç¡®å®šé¢œè‰²
        color = "info" if user_status == "active" else "secondary"
        
        # æŸ¥æ‰¾ç°æœ‰æ ‡ç­¾ï¼ˆä»¥é£ä¹¦ç”¨æˆ·IDä¸ºå‡†ï¼‰
        tag = Tag.query.filter_by(
            category_type="identity",
            category="user",
            sync_source="feishu",
            sync_id=feishu_user_id  # ä½¿ç”¨é£ä¹¦ç”¨æˆ·IDä½œä¸ºåŒæ­¥ID
        ).first()
        
        if tag:
            # æ›´æ–°ç°æœ‰æ ‡ç­¾
            tag.display_name = display_name
            tag.department_path = department_path
            tag.user_status = user_status
            tag.color = color
            tag.synced_at = now()
            db.session.commit()
            return "updated"
        else:
            # åˆ›å»ºæ–°æ ‡ç­¾
            tag = Tag(
                name=f"feishu_user_{feishu_user_id}",  # æ ‡ç­¾åç§°åŒ…å«é£ä¹¦ç”¨æˆ·ID
                display_name=display_name,
                category_type="identity",
                category="user",
                color=color,  # æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
                description=f"ç”¨æˆ·: {display_name} ({email})",
                is_auto_sync=True,
                sync_source="feishu",
                sync_id=feishu_user_id,  # å­˜å‚¨é£ä¹¦ç”¨æˆ·ID
                department_path=department_path,
                user_status=user_status,  # å­˜å‚¨ç”¨æˆ·çŠ¶æ€
                synced_at=now()
            )
            db.session.add(tag)
            db.session.commit()
            return "created"
    
    
    def _build_department_path(self, department_ids: list) -> str:
        """æ„å»ºéƒ¨é—¨è·¯å¾„"""
        # è¿™é‡Œéœ€è¦æ ¹æ®éƒ¨é—¨IDè·å–å®Œæ•´çš„éƒ¨é—¨å±‚çº§è·¯å¾„
        # ç®€åŒ–å®ç°ï¼Œå®é™…éœ€è¦é€’å½’è·å–çˆ¶éƒ¨é—¨ä¿¡æ¯
        return "å…¬å¸-éƒ¨é—¨-ç§‘å®¤"  # å ä½ç¬¦
    
    def _log_sync(self, sync_type: str, sync_action: str, feishu_id: str, 
                  status: str, sync_data: dict, error_message: str = None):
        """è®°å½•åŒæ­¥æ—¥å¿—"""
        log = FeishuSyncLog(
            sync_type=sync_type,
            sync_action=sync_action,
            feishu_id=feishu_id,
            sync_data=sync_data,
            status=status,
            error_message=error_message
        )
        db.session.add(log)
        db.session.commit()
```

### 3. å®šæ—¶ä»»åŠ¡é…ç½®

```python
# åœ¨ app/tasks.py ä¸­æ·»åŠ é£ä¹¦åŒæ­¥ä»»åŠ¡
from app.services.feishu_sync_service import FeishuSyncService

def feishu_sync_task():
    """é£ä¹¦åŒæ­¥å®šæ—¶ä»»åŠ¡"""
    try:
        log_info("å¼€å§‹æ‰§è¡Œé£ä¹¦åŒæ­¥ä»»åŠ¡", module="feishu_sync_task")
        
        sync_service = FeishuSyncService()
        result = sync_service.sync_all()
        
        log_info(
            "é£ä¹¦åŒæ­¥ä»»åŠ¡å®Œæˆ",
            module="feishu_sync_task",
            result=result
        )
        
        return result
        
    except Exception as e:
        log_error(f"é£ä¹¦åŒæ­¥ä»»åŠ¡å¤±è´¥: {str(e)}", module="feishu_sync_task")
        raise

# åœ¨ app/scheduler.py ä¸­æ³¨å†Œä»»åŠ¡
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger

def register_feishu_sync_job():
    """æ³¨å†Œé£ä¹¦åŒæ­¥ä»»åŠ¡"""
    scheduler = get_scheduler()
    
    # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œé£ä¹¦åŒæ­¥
    scheduler.add_job(
        func=feishu_sync_task,
        trigger=CronTrigger(hour=2, minute=0),
        id='feishu_sync_daily',
        name='é£ä¹¦æ¯æ—¥åŒæ­¥',
        replace_existing=True
    )
    
    log_info("é£ä¹¦åŒæ­¥ä»»åŠ¡å·²æ³¨å†Œ", module="scheduler")
```

### 4. é£ä¹¦åŒæ­¥é…ç½®ç®¡ç†

```python
class FeishuSyncConfigService:
    """é£ä¹¦åŒæ­¥é…ç½®æœåŠ¡"""
    
    @staticmethod
    def create_config(app_id: str, app_secret: str, sync_departments: list = None) -> FeishuSyncConfig:
        """åˆ›å»ºé£ä¹¦åŒæ­¥é…ç½®"""
        config = FeishuSyncConfig(
            app_id=app_id,
            app_secret=app_secret,
            sync_departments=sync_departments or []
        )
        db.session.add(config)
        db.session.commit()
        return config
    
    @staticmethod
    def update_sync_departments(config_id: int, sync_departments: list):
        """æ›´æ–°åŒæ­¥éƒ¨é—¨é…ç½®"""
        config = FeishuSyncConfig.query.get(config_id)
        if config:
            config.sync_departments = sync_departments
            db.session.commit()
    
    @staticmethod
    def test_connection(app_id: str, app_secret: str) -> bool:
        """æµ‹è¯•é£ä¹¦è¿æ¥"""
        try:
            client = FeishuAPIClient(app_id, app_secret)
            client.get_tenant_access_token()
            return True
        except Exception as e:
            log_error(f"é£ä¹¦è¿æ¥æµ‹è¯•å¤±è´¥: {str(e)}", module="feishu_config")
            return False
```

## ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

### 1. æ ‡ç­¾ç®¡ç†é¡µé¢ä¼˜åŒ–

#### åˆ†ç±»ç­›é€‰
```html
<!-- æ ‡ç­¾åˆ†ç±»ç­›é€‰ -->
<div class="tag-category-filter mb-3">
    <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="categoryType" id="all" value="all" checked>
        <label class="btn btn-outline-primary" for="all">å…¨éƒ¨</label>
        
        <input type="radio" class="btn-check" name="categoryType" id="resource" value="resource">
        <label class="btn btn-outline-success" for="resource">èµ„æºç±»</label>
        
        <input type="radio" class="btn-check" name="categoryType" id="identity" value="identity">
        <label class="btn btn-outline-info" for="identity">èº«ä»½ç±»</label>
    </div>
</div>
```

#### èº«ä»½ç±»æ ‡ç­¾æ˜¾ç¤º
```html
<!-- èº«ä»½ç±»æ ‡ç­¾ç‰¹æ®Šæ˜¾ç¤º -->
<div class="identity-tag-item" v-if="tag.category_type === 'identity'" 
     :class="{'inactive-user': tag.user_status === 'inactive'}">
    <div class="tag-icon">
        <i class="fas fa-user" :class="{'text-muted': tag.user_status === 'inactive'}"></i>
    </div>
    <div class="tag-info">
        <div class="tag-name" :class="{'text-muted': tag.user_status === 'inactive'}">
            {{ tag.display_name }}
            <span v-if="tag.user_status === 'inactive'" class="badge bg-secondary ms-1">ç¦»èŒ</span>
        </div>
        <div class="tag-department" v-if="tag.department_path" 
             :class="{'text-muted': tag.user_status === 'inactive'}">
            {{ tag.department_path }}
        </div>
        <div class="tag-sync-info">
            <small class="text-muted">æœ€ååŒæ­¥: {{ formatDate(tag.synced_at) }}</small>
        </div>
    </div>
    <div class="tag-actions">
        <span class="badge" :class="tag.user_status === 'active' ? 'bg-info' : 'bg-secondary'">
            {{ tag.user_status === 'active' ? 'åœ¨èŒ' : 'ç¦»èŒ' }}
        </span>
    </div>
</div>
```

#### æ ‡ç­¾æ“ä½œæƒé™
```javascript
// æ ¹æ®æ ‡ç­¾ç±»å‹æ§åˆ¶æ“ä½œæƒé™
function updateTagActions(tag) {
    const isIdentity = tag.category_type === 'identity';
    const isAutoSync = tag.is_auto_sync;
    
    // èº«ä»½ç±»æ ‡ç­¾ä¸å¯æ‰‹åŠ¨ç¼–è¾‘
    if (isIdentity || isAutoSync) {
        $('#edit-tag-btn').prop('disabled', true);
        $('#delete-tag-btn').prop('disabled', true);
        $('#edit-tag-btn').attr('title', 'èº«ä»½ç±»æ ‡ç­¾ä¸å¯æ‰‹åŠ¨ç¼–è¾‘');
        $('#delete-tag-btn').attr('title', 'èº«ä»½ç±»æ ‡ç­¾ä¸å¯æ‰‹åŠ¨åˆ é™¤');
    } else {
        $('#edit-tag-btn').prop('disabled', false);
        $('#delete-tag-btn').prop('disabled', false);
        $('#edit-tag-btn').removeAttr('title');
        $('#delete-tag-btn').removeAttr('title');
    }
}
```

### 2. é£ä¹¦åŒæ­¥é…ç½®é¡µé¢

#### åŒæ­¥é…ç½®è¡¨å•
```html
<!-- é£ä¹¦åŒæ­¥é…ç½® -->
<div class="feishu-sync-config">
    <div class="card">
        <div class="card-header">
            <h5><i class="fab fa-microsoft"></i> é£ä¹¦åŒæ­¥é…ç½®</h5>
        </div>
        <div class="card-body">
            <form id="feishu-config-form">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="app_id" class="form-label">åº”ç”¨ID</label>
                            <input type="text" class="form-control" id="app_id" name="app_id" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="app_secret" class="form-label">åº”ç”¨å¯†é’¥</label>
                            <input type="password" class="form-control" id="app_secret" name="app_secret" required>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">åŒæ­¥èŒƒå›´</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sync_users" name="sync_users" checked>
                        <label class="form-check-label" for="sync_users">åŒæ­¥ç”¨æˆ·</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">éƒ¨é—¨ç­›é€‰</label>
                    <div id="department-tree">
                        <!-- éƒ¨é—¨æ ‘å½¢é€‰æ‹©å™¨ -->
                    </div>
                </div>
                
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="testFeishuConnection()">
                        <i class="fas fa-plug"></i> æµ‹è¯•è¿æ¥
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> ä¿å­˜é…ç½®
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
```

#### åŒæ­¥çŠ¶æ€ç›‘æ§
```html
<!-- åŒæ­¥çŠ¶æ€ç›‘æ§ -->
<div class="sync-status-monitor">
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-sync"></i> åŒæ­¥çŠ¶æ€</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="sync-stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-users text-primary"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">ç”¨æˆ·åŒæ­¥</div>
                            <div class="stat-value">{{ syncStats.users.total }}</div>
                            <div class="stat-detail">
                                <span class="text-success">+{{ syncStats.users.created }}</span>
                                <span class="text-warning">~{{ syncStats.users.updated }}</span>
                                <span class="text-danger">-{{ syncStats.users.failed }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sync-actions mt-3">
                <button class="btn btn-primary" onclick="startSync()">
                    <i class="fas fa-play"></i> ç«‹å³åŒæ­¥
                </button>
                <button class="btn btn-outline-secondary" onclick="viewSyncLogs()">
                    <i class="fas fa-list"></i> æŸ¥çœ‹æ—¥å¿—
                </button>
            </div>
        </div>
    </div>
</div>
```

## ğŸ”Œ APIæ¥å£è®¾è®¡

### 1. æ ‡ç­¾ç®¡ç†API

#### è·å–æ ‡ç­¾åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†ç±»ç­›é€‰ï¼‰
```http
GET /api/tags?category_type=resource&category=project&page=1&per_page=20
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "success": true,
    "data": {
        "tags": [
            {
                "id": 1,
                "name": "mysql_prod",
                "display_name": "MySQLç”Ÿäº§ç¯å¢ƒ",
                "category_type": "resource",
                "category": "environment",
                "color": "danger",
                "description": "MySQLç”Ÿäº§ç¯å¢ƒæ ‡ç­¾",
                "is_auto_sync": false,
                "created_at": "2025-09-25T10:00:00Z"
            },
            {
                "id": 2,
                "name": "user_12345",
                "display_name": "å¼ ä¸‰",
                "category_type": "identity",
                "category": "user",
                "color": "info",
                "department_path": "å…¬å¸-æŠ€æœ¯éƒ¨-å¼€å‘ç»„",
                "is_auto_sync": true,
                "sync_source": "feishu",
                "synced_at": "2025-09-25T09:30:00Z"
            }
        ],
        "pagination": {
            "page": 1,
            "per_page": 20,
            "total": 2,
            "pages": 1
        }
    }
}
```

#### åˆ›å»ºèµ„æºç±»æ ‡ç­¾
```http
POST /api/tags
Content-Type: application/json

{
    "name": "new_project",
    "display_name": "æ–°é¡¹ç›®",
    "category_type": "resource",
    "category": "project",
    "color": "primary",
    "description": "æ–°é¡¹ç›®æ ‡ç­¾"
}
```

#### æ›´æ–°æ ‡ç­¾
```http
PUT /api/tags/{id}
Content-Type: application/json

{
    "display_name": "æ›´æ–°åçš„é¡¹ç›®åç§°",
    "description": "æ›´æ–°åçš„æè¿°"
}
```

#### åˆ é™¤æ ‡ç­¾
```http
DELETE /api/tags/{id}
```

### 2. é£ä¹¦åŒæ­¥API

#### è·å–é£ä¹¦åŒæ­¥é…ç½®
```http
GET /api/feishu/config
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "success": true,
    "data": {
        "id": 1,
        "app_id": "cli_xxx",
        "sync_departments": [
            {"id": "dept_123", "name": "æŠ€æœ¯éƒ¨", "level": 2},
            {"id": "dept_456", "name": "äº§å“éƒ¨", "level": 2}
        ],
        "sync_users": true,
        "is_active": true
    }
}
```

#### åˆ›å»º/æ›´æ–°é£ä¹¦åŒæ­¥é…ç½®
```http
POST /api/feishu/config
Content-Type: application/json

{
    "app_id": "cli_xxx",
    "app_secret": "xxx",
    "sync_departments": [
        {"id": "dept_123", "name": "æŠ€æœ¯éƒ¨", "level": 2}
    ],
    "sync_users": true
}
```

#### æµ‹è¯•é£ä¹¦è¿æ¥
```http
POST /api/feishu/test-connection
Content-Type: application/json

{
    "app_id": "cli_xxx",
    "app_secret": "xxx"
}
```

#### ç«‹å³åŒæ­¥
```http
POST /api/feishu/sync
Content-Type: application/json

{
    "sync_type": "all"  // "all", "users"
}
```

#### è·å–åŒæ­¥çŠ¶æ€
```http
GET /api/feishu/sync-status
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "success": true,
    "data": {
        "last_sync": "2025-09-25T02:00:00Z",
        "next_sync": "2025-09-26T02:00:00Z",
        "status": "success",
        "stats": {
            "users": {"total": 100, "created": 5, "updated": 10, "failed": 0}
        }
    }
}
```

#### è·å–åŒæ­¥æ—¥å¿—
```http
GET /api/feishu/sync-logs?status=failed&page=1&per_page=20
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "success": true,
    "data": {
        "logs": [
            {
                "id": 1,
                "sync_type": "user",
                "sync_action": "create",
                "feishu_id": "user_12345",
                "local_id": 2,
                "status": "success",
                "created_at": "2025-09-25T02:00:00Z"
            }
        ],
        "pagination": {
            "page": 1,
            "per_page": 20,
            "total": 1,
            "pages": 1
        }
    }
}
```


## ğŸ“Š ä½¿ç”¨åœºæ™¯

### 1. èµ„æºç±»æ ‡ç­¾ä½¿ç”¨åœºæ™¯
- **å®ä¾‹åˆ†ç±»**: æŒ‰åœ°åŒºã€ç¯å¢ƒã€é¡¹ç›®å¯¹æ•°æ®åº“å®ä¾‹è¿›è¡Œåˆ†ç±»
- **æƒé™ç®¡ç†**: åŸºäºé¡¹ç›®ã€ç¯å¢ƒè¿›è¡Œè®¿é—®æ§åˆ¶
- **ç»Ÿè®¡æŠ¥å‘Š**: æŒ‰åˆ†ç±»ç”Ÿæˆèµ„æºä½¿ç”¨ç»Ÿè®¡
- **æ‰¹é‡æ“ä½œ**: å¯¹åŒç±»å‹èµ„æºè¿›è¡Œæ‰¹é‡ç®¡ç†

### 2. èº«ä»½ç±»æ ‡ç­¾ä½¿ç”¨åœºæ™¯
- **è´£ä»»å½’å±**: æ˜ç¡®æ¯ä¸ªèµ„æºçš„å…·ä½“è´Ÿè´£äºº
- **æƒé™æ§åˆ¶**: åŸºäºäººå‘˜èº«ä»½è¿›è¡Œç»†ç²’åº¦æƒé™æ§åˆ¶
- **å®¡è®¡è¿½è¸ª**: è®°å½•èµ„æºå˜æ›´çš„è´£ä»»äºº
- **é€šçŸ¥å‘Šè­¦**: å‘ç›¸å…³è´£ä»»äººå‘é€å‘Šè­¦ä¿¡æ¯
- **éƒ¨é—¨ä¿¡æ¯**: æ˜¾ç¤ºç”¨æˆ·æ‰€å±çš„éƒ¨é—¨å±‚çº§ä¿¡æ¯
- **çŠ¶æ€ç®¡ç†**: é€šè¿‡é¢œè‰²å’Œæ ·å¼åŒºåˆ†åœ¨èŒ/ç¦»èŒç”¨æˆ·

## ğŸš€ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: æ•°æ®åº“ç»“æ„ä¼˜åŒ– (1-2å¤©)
1. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
2. æ›´æ–°æ ‡ç­¾æ¨¡å‹ï¼Œæ·»åŠ èº«ä»½ç±»æ”¯æŒ
3. åˆ›å»ºé£ä¹¦åŒæ­¥é…ç½®å’Œæ—¥å¿—è¡¨
4. æ•°æ®è¿ç§»å’ŒéªŒè¯

### é˜¶æ®µ2: é£ä¹¦é›†æˆå¼€å‘ (2-3å¤©)
1. å®ç°é£ä¹¦APIå®¢æˆ·ç«¯
2. å®ç°ç”¨æˆ·åŒæ­¥æœåŠ¡
3. åˆ›å»ºå®šæ—¶ä»»åŠ¡è°ƒåº¦
4. æ·»åŠ åŒæ­¥é…ç½®ç®¡ç†

### é˜¶æ®µ3: åç«¯APIå¼€å‘ (1-2å¤©)
1. æ›´æ–°æ ‡ç­¾ç®¡ç†API
2. åˆ›å»ºé£ä¹¦åŒæ­¥API
3. å®Œå–„æƒé™æ§åˆ¶

### é˜¶æ®µ4: å‰ç«¯ç•Œé¢ä¼˜åŒ– (2-3å¤©)
1. æ›´æ–°æ ‡ç­¾ç®¡ç†é¡µé¢ï¼Œæ”¯æŒåˆ†ç±»ç­›é€‰
2. åˆ›å»ºé£ä¹¦åŒæ­¥é…ç½®é¡µé¢
3. ä¼˜åŒ–ç”¨æˆ·æ ‡ç­¾æ˜¾ç¤ºï¼ˆå›¾æ ‡ã€éƒ¨é—¨è·¯å¾„ï¼‰
4. æ·»åŠ åŒæ­¥çŠ¶æ€ç›‘æ§

### é˜¶æ®µ5: æµ‹è¯•å’Œéƒ¨ç½² (1-2å¤©)
1. å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
2. é£ä¹¦APIé›†æˆæµ‹è¯•
3. ç”¨æˆ·éªŒæ”¶æµ‹è¯•
4. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### åŠŸèƒ½æå‡
- **åˆ†ç±»æ¸…æ™°**: èµ„æºç±»å’Œèº«ä»½ç±»æ ‡ç­¾åˆ†ç¦»ç®¡ç†
- **è‡ªåŠ¨åŒ–**: é£ä¹¦äººå‘˜ä¿¡æ¯è‡ªåŠ¨åŒæ­¥ï¼Œå‡å°‘æ‰‹åŠ¨ç»´æŠ¤
- **æƒé™ç²¾ç¡®**: åŸºäºäººå‘˜èº«ä»½çš„ç»†ç²’åº¦æƒé™æ§åˆ¶
- **å®¡è®¡å®Œæ•´**: å®Œæ•´çš„èµ„æºå½’å±å’Œå˜æ›´è®°å½•
- **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·å›¾æ ‡å’Œéƒ¨é—¨å±‚çº§ä¿¡æ¯æå‡ç•Œé¢å‹å¥½æ€§
- **çŠ¶æ€å¯è§†åŒ–**: é€šè¿‡é¢œè‰²å’Œæ ·å¼ç›´è§‚æ˜¾ç¤ºç”¨æˆ·åœ¨èŒ/ç¦»èŒçŠ¶æ€

### ç®¡ç†æ•ˆç‡
- **å‡å°‘ç»´æŠ¤**: é£ä¹¦è‡ªåŠ¨åŒæ­¥å‡å°‘æ‰‹åŠ¨ç»´æŠ¤å·¥ä½œ
- **æé«˜å‡†ç¡®æ€§**: è‡ªåŠ¨åŒæ­¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **å¢å¼ºå®‰å…¨æ€§**: åŸºäºäººå‘˜èº«ä»½çš„æƒé™æ§åˆ¶æ›´å®‰å…¨
- **ä¾¿äºå®¡è®¡**: æ¸…æ™°çš„å½’å±å…³ç³»ä¾¿äºå®¡è®¡è¿½è¸ª
- **çµæ´»é…ç½®**: æ”¯æŒæŒ‰éƒ¨é—¨ç­›é€‰åŒæ­¥èŒƒå›´

### æŠ€æœ¯ä¼˜åŠ¿
- **é£ä¹¦é›†æˆ**: ä¸ç°æœ‰ä¼ä¸šç³»ç»Ÿæ— ç¼é›†æˆï¼Œä»¥é£ä¹¦ç”¨æˆ·IDä¸ºå‡†
- **ä¸‰çº§éƒ¨é—¨**: æ”¯æŒå…¬å¸-éƒ¨é—¨-ç§‘å®¤çš„å®Œæ•´å±‚çº§
- **ç”¨æˆ·å›¾æ ‡**: ä½¿ç”¨Font Awesomeç”¨æˆ·å›¾æ ‡æå‡ç•Œé¢ä½“éªŒ
- **çŠ¶æ€åŒºåˆ†**: åœ¨èŒç”¨æˆ·æ˜¾ç¤ºè“è‰²ï¼Œç¦»èŒç”¨æˆ·æ˜¾ç¤ºç°è‰²ï¼Œè§†è§‰åŒºåˆ†æ˜æ˜¾
- **å®šæ—¶åŒæ­¥**: æ¯æ—¥è‡ªåŠ¨åŒæ­¥ç¡®ä¿æ•°æ®æœ€æ–°
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„åŒæ­¥æ—¥å¿—å’Œé”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### é£ä¹¦APIé›†æˆ
- **è®¤è¯æœºåˆ¶**: ä½¿ç”¨åº”ç”¨å‡­è¯è·å–ç§Ÿæˆ·è®¿é—®ä»¤ç‰Œ
- **ç”¨æˆ·æ¥å£**: è°ƒç”¨é£ä¹¦ç”¨æˆ·ç®¡ç†APIè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥open_idä½œä¸ºå”¯ä¸€æ ‡è¯†
- **åˆ†é¡µå¤„ç†**: æ”¯æŒå¤§é‡æ•°æ®çš„åˆ†é¡µè·å–
- **é”™è¯¯é‡è¯•**: å®ç°æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- **ä»¤ç‰Œåˆ·æ–°**: è‡ªåŠ¨å¤„ç†è®¿é—®ä»¤ç‰Œè¿‡æœŸ

### æ•°æ®åŒæ­¥ç­–ç•¥
- **å¢é‡åŒæ­¥**: åªåŒæ­¥å˜æ›´çš„æ•°æ®
- **ç”¨æˆ·IDæ˜ å°„**: ä»¥é£ä¹¦open_idä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œç¡®ä¿ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§
- **çŠ¶æ€åŒæ­¥**: åŒæ­¥é£ä¹¦ç”¨æˆ·çŠ¶æ€ï¼Œæ”¯æŒåœ¨èŒ/ç¦»èŒçŠ¶æ€ç®¡ç†
- **å†²çªå¤„ç†**: å¤„ç†æ•°æ®å†²çªå’Œé‡å¤
- **å›æ»šæœºåˆ¶**: åŒæ­¥å¤±è´¥æ—¶çš„æ•°æ®å›æ»š
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„åŒæ­¥æ“ä½œæ—¥å¿—

### æ€§èƒ½ä¼˜åŒ–
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡å¤„ç†æ•°æ®åº“æ“ä½œ
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜éƒ¨é—¨æ ‘å’Œç”¨æˆ·ä¿¡æ¯
- **å¼‚æ­¥å¤„ç†**: å¤§é‡æ•°æ®å¼‚æ­¥åŒæ­¥
- **èµ„æºé™åˆ¶**: æ§åˆ¶APIè°ƒç”¨é¢‘ç‡

## ğŸ“‹ é…ç½®è¦æ±‚

### é£ä¹¦åº”ç”¨é…ç½®
- **åº”ç”¨ç±»å‹**: ä¼ä¸šè‡ªå»ºåº”ç”¨
- **æƒé™èŒƒå›´**: é€šè®¯å½•è¯»å–æƒé™
- **å›è°ƒåœ°å€**: é…ç½®Webhookå›è°ƒï¼ˆå¯é€‰ï¼‰
- **IPç™½åå•**: é…ç½®æœåŠ¡å™¨IPç™½åå•

### ç³»ç»Ÿé…ç½®
- **Pythonä¾èµ–**: æ·»åŠ requestsåº“
- **ç¯å¢ƒå˜é‡**: é…ç½®é£ä¹¦åº”ç”¨å‡­è¯
- **å®šæ—¶ä»»åŠ¡**: é…ç½®APSchedulerä»»åŠ¡
- **æ•°æ®åº“**: æ”¯æŒJSONå­—æ®µå­˜å‚¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1  
**åˆ›å»ºæ—¶é—´**: 2025-09-25  
**æœ€åæ›´æ–°**: 2025-09-25  
**ç»´æŠ¤å›¢é˜Ÿ**: TaifishingV4 Team
