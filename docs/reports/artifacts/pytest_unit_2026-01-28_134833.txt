============================= test session starts ==============================
platform darwin -- Python 3.13.7, pytest-9.0.2, pluggy-1.6.0 -- /Users/apple/Github/WhaleFall/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/apple/Github/WhaleFall
configfile: pyproject.toml
testpaths: tests
plugins: cov-7.0.0
collecting ... collected 425 items / 1 deselected / 424 selected

tests/unit/api/test_instances_connections_batch_tests.py::test_execute_batch_tests_marks_instance_failed_when_test_raises PASSED [  0%]
tests/unit/constants/test_constants_immutability.py::test_http_method_collections_are_tuples PASSED [  0%]
tests/unit/constants/test_constants_immutability.py::test_status_collections_are_tuples PASSED [  0%]
tests/unit/constants/test_constants_immutability.py::test_user_role_permissions_are_immutable PASSED [  0%]
tests/unit/constants/test_constants_immutability.py::test_user_role_collections_are_tuples PASSED [  1%]
tests/unit/infra/test_log_fallback_helper.py::test_log_fallback_always_sets_fallback_fields PASSED [  1%]
tests/unit/models/test_account_classification_rule_expression.py::test_get_rule_expression_invalid_json_is_not_silent_fallback PASSED [  1%]
tests/unit/models/test_account_permission.py::test_account_permission_table_contract_has_expected_constraints PASSED [  1%]
tests/unit/models/test_account_permission.py::test_account_permission_snapshot_columns_contract PASSED [  2%]
tests/unit/models/test_account_permission.py::test_account_permission_capability_expression_uses_jsonb_contains_operator PASSED [  2%]
tests/unit/models/test_account_permission.py::test_account_permission_capability_expression_logs_fallback_when_bind_unavailable PASSED [  2%]
tests/unit/models/test_database_type_config_features_list.py::test_features_list_invalid_json_is_not_silent_fallback PASSED [  2%]
tests/unit/repositories/test_accounts_ledger_repository_tag_filter.py::test_apply_tag_filter_returns_original_query_when_join_fails PASSED [  3%]
tests/unit/repositories/test_capacity_databases_repository_filters.py::test_apply_filters_uses_period_start_bounds_for_partition_pruning PASSED [  3%]
tests/unit/repositories/test_capacity_databases_repository_summary_query.py::test_build_summary_query_avoids_tuple_in_and_uses_period_start_partition_key PASSED [  3%]
tests/unit/repositories/test_capacity_databases_repository_summary_query.py::test_summarize_latest_aggregations_returns_latest_values_within_range PASSED [  3%]
tests/unit/repositories/test_scheduler_jobs_repository_last_run_resolution.py::test_lookup_job_last_run_returns_none_when_no_task_runs PASSED [  4%]
tests/unit/repositories/test_scheduler_jobs_repository_last_run_resolution.py::test_lookup_job_last_run_returns_latest_started_at PASSED [  4%]
tests/unit/routes/test_api_v1_account_change_logs_contract.py::test_api_v1_account_change_logs_requires_auth PASSED [  4%]
tests/unit/routes/test_api_v1_account_change_logs_contract.py::test_api_v1_account_change_logs_endpoints_contract PASSED [  4%]
tests/unit/routes/test_api_v1_accounts_classifications_contract.py::test_api_v1_accounts_classifications_requires_auth PASSED [  4%]
tests/unit/routes/test_api_v1_accounts_classifications_contract.py::test_api_v1_accounts_classifications_auto_classify_contract PASSED [  5%]
tests/unit/routes/test_api_v1_accounts_classifications_contract.py::test_api_v1_accounts_classifications_endpoints_contract PASSED [  5%]
tests/unit/routes/test_api_v1_accounts_classifications_contract.py::test_api_v1_accounts_classifications_create_rule_requires_dsl_v4 PASSED [  5%]
tests/unit/routes/test_api_v1_accounts_ledgers_contract.py::test_api_v1_accounts_ledgers_contract PASSED [  5%]
tests/unit/routes/test_api_v1_accounts_ledgers_contract.py::test_api_v1_accounts_ledgers_mysql_roles_filtered_by_default PASSED [  6%]
tests/unit/routes/test_api_v1_accounts_ledgers_contract.py::test_api_v1_accounts_ledgers_permissions_contract PASSED [  6%]
tests/unit/routes/test_api_v1_accounts_ledgers_contract.py::test_api_v1_accounts_ledgers_requires_auth PASSED [  6%]
tests/unit/routes/test_api_v1_accounts_statistics_contract.py::test_api_v1_accounts_statistics_requires_auth PASSED [  6%]
tests/unit/routes/test_api_v1_accounts_statistics_contract.py::test_api_v1_accounts_statistics_endpoints_contract PASSED [  7%]
tests/unit/routes/test_api_v1_accounts_sync_contract.py::test_api_v1_accounts_sync_requires_auth PASSED [  7%]
tests/unit/routes/test_api_v1_accounts_sync_contract.py::test_api_v1_accounts_sync_endpoints_contract PASSED [  7%]
tests/unit/routes/test_api_v1_accounts_sync_contract.py::test_api_v1_accounts_sync_failure_contract PASSED [  7%]
tests/unit/routes/test_api_v1_admin_contract.py::test_api_v1_admin_app_info_contract PASSED [  8%]
tests/unit/routes/test_api_v1_auth_contract.py::test_api_v1_auth_csrf_token_contract PASSED [  8%]
tests/unit/routes/test_api_v1_auth_contract.py::test_api_v1_auth_login_me_refresh_logout_contract PASSED [  8%]
tests/unit/routes/test_api_v1_auth_contract.py::test_api_v1_auth_login_sets_remember_cookie_expire_in_7_days PASSED [  8%]
tests/unit/routes/test_api_v1_auth_contract.py::test_api_v1_auth_change_password_invalid_old_password_contract PASSED [  8%]
tests/unit/routes/test_api_v1_cache_contract.py::test_api_v1_cache_requires_auth PASSED [  9%]
tests/unit/routes/test_api_v1_cache_contract.py::test_api_v1_cache_actions_missing_payload_contract PASSED [  9%]
tests/unit/routes/test_api_v1_cache_contract.py::test_api_v1_cache_endpoints_contract PASSED [  9%]
tests/unit/routes/test_api_v1_capacity_aggregations_contract.py::test_api_v1_capacity_current_aggregation_requires_auth PASSED [  9%]
tests/unit/routes/test_api_v1_capacity_aggregations_contract.py::test_api_v1_capacity_current_aggregation_contract PASSED [ 10%]
tests/unit/routes/test_api_v1_capacity_databases_contract.py::test_api_v1_capacity_databases_requires_auth PASSED [ 10%]
tests/unit/routes/test_api_v1_capacity_databases_contract.py::test_api_v1_capacity_databases_endpoints_contract PASSED [ 10%]
tests/unit/routes/test_api_v1_capacity_instances_contract.py::test_api_v1_capacity_instances_requires_auth PASSED [ 10%]
tests/unit/routes/test_api_v1_capacity_instances_contract.py::test_api_v1_capacity_instances_endpoints_contract PASSED [ 11%]
tests/unit/routes/test_api_v1_common_options_contract.py::test_api_v1_common_instances_options_contract PASSED [ 11%]
tests/unit/routes/test_api_v1_common_options_contract.py::test_api_v1_common_databases_options_contract PASSED [ 11%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_requires_auth PASSED [ 11%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_validate_params_contract PASSED [ 12%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_validate_params_strips_whitespace_contract PASSED [ 12%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_batch_test_contract PASSED [ 12%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_batch_test_accepts_scalar_instance_id_contract PASSED [ 12%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_status_contract PASSED [ 12%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_test_connection_missing_payload_contract PASSED [ 13%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_test_connection_failure_contract PASSED [ 13%]
tests/unit/routes/test_api_v1_connections_contract.py::test_api_v1_connections_test_connection_success_contract PASSED [ 13%]
tests/unit/routes/test_api_v1_credentials_contract.py::test_api_v1_credentials_list_contract PASSED [ 13%]
tests/unit/routes/test_api_v1_credentials_contract.py::test_api_v1_credential_detail_contract PASSED [ 14%]
tests/unit/routes/test_api_v1_credentials_contract.py::test_api_v1_credentials_requires_auth PASSED [ 14%]
tests/unit/routes/test_api_v1_credentials_contract.py::test_api_v1_credentials_create_contract PASSED [ 14%]
tests/unit/routes/test_api_v1_credentials_contract.py::test_api_v1_credentials_update_contract PASSED [ 14%]
tests/unit/routes/test_api_v1_credentials_contract.py::test_api_v1_credentials_delete_contract PASSED [ 15%]
tests/unit/routes/test_api_v1_csrf_header_only_contract.py::test_api_v1_csrf_token_is_not_accepted_from_json_body PASSED [ 15%]
tests/unit/routes/test_api_v1_dashboard_contract.py::test_api_v1_dashboard_requires_auth PASSED [ 15%]
tests/unit/routes/test_api_v1_dashboard_contract.py::test_api_v1_dashboard_overview_contract PASSED [ 15%]
tests/unit/routes/test_api_v1_dashboard_contract.py::test_api_v1_dashboard_status_contract PASSED [ 16%]
tests/unit/routes/test_api_v1_dashboard_contract.py::test_api_v1_dashboard_activities_contract PASSED [ 16%]
tests/unit/routes/test_api_v1_dashboard_contract.py::test_api_v1_dashboard_charts_logs_contract PASSED [ 16%]
tests/unit/routes/test_api_v1_dashboard_contract.py::test_api_v1_dashboard_charts_syncs_contract PASSED [ 16%]
tests/unit/routes/test_api_v1_dashboard_contract.py::test_api_v1_dashboard_charts_unknown_type_returns_empty_dict PASSED [ 16%]
tests/unit/routes/test_api_v1_databases_ledgers_contract.py::test_api_v1_databases_ledgers_requires_auth PASSED [ 17%]
tests/unit/routes/test_api_v1_databases_ledgers_contract.py::test_api_v1_databases_ledgers_endpoints_contract PASSED [ 17%]
tests/unit/routes/test_api_v1_files_contract.py::test_api_v1_files_requires_auth PASSED [ 17%]
tests/unit/routes/test_api_v1_files_contract.py::test_api_v1_files_endpoints_contract PASSED [ 17%]
tests/unit/routes/test_api_v1_health_extended_contract.py::test_api_v1_health_cache_requires_auth PASSED [ 18%]
tests/unit/routes/test_api_v1_health_extended_contract.py::test_api_v1_health_cache_contract PASSED [ 18%]
tests/unit/routes/test_api_v1_health_extended_contract.py::test_api_v1_health_detailed_contract PASSED [ 18%]
tests/unit/routes/test_api_v1_health_ping_contract.py::test_api_v1_health_ping_returns_success_envelope PASSED [ 18%]
tests/unit/routes/test_api_v1_health_ping_contract.py::test_api_v1_health_basic_returns_success_envelope PASSED [ 19%]
tests/unit/routes/test_api_v1_health_ping_contract.py::test_api_v1_health_health_returns_success_envelope PASSED [ 19%]
tests/unit/routes/test_api_v1_health_ping_contract.py::test_api_v1_health_unknown_path_returns_error_envelope PASSED [ 19%]
tests/unit/routes/test_api_v1_history_logs_contract.py::test_api_v1_history_logs_requires_auth PASSED [ 19%]
tests/unit/routes/test_api_v1_history_logs_contract.py::test_api_v1_history_logs_endpoints_contract PASSED [ 20%]
tests/unit/routes/test_api_v1_history_sessions_contract.py::test_api_v1_history_sessions_requires_auth PASSED [ 20%]
tests/unit/routes/test_api_v1_history_sessions_contract.py::test_api_v1_history_sessions_endpoints_contract PASSED [ 20%]
tests/unit/routes/test_api_v1_instances_batch_contract.py::test_api_v1_instances_batch_requires_auth PASSED [ 20%]
tests/unit/routes/test_api_v1_instances_batch_contract.py::test_api_v1_instances_batch_endpoints_contract PASSED [ 20%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_list_contract PASSED [ 21%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_detail_contract PASSED [ 21%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_requires_auth PASSED [ 21%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_create_contract PASSED [ 21%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_update_contract PASSED [ 22%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_soft_delete_contract PASSED [ 22%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_restore_contract PASSED [ 22%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_accounts_list_contract PASSED [ 22%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_account_permissions_contract PASSED [ 23%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_account_change_history_contract PASSED [ 23%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_database_sizes_contract PASSED [ 23%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_database_table_sizes_snapshot_contract PASSED [ 23%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_database_table_sizes_refresh_contract PASSED [ 24%]
tests/unit/routes/test_api_v1_instances_contract.py::test_api_v1_instances_database_table_sizes_refresh_conflict_returns_reason PASSED [ 24%]
tests/unit/routes/test_api_v1_instances_statistics_contract.py::test_api_v1_instances_statistics_requires_auth PASSED [ 24%]
tests/unit/routes/test_api_v1_instances_statistics_contract.py::test_api_v1_instances_statistics_contract PASSED [ 24%]
tests/unit/routes/test_api_v1_instances_sync_capacity_contract.py::test_api_v1_instances_sync_capacity_requires_auth PASSED [ 25%]
tests/unit/routes/test_api_v1_instances_sync_capacity_contract.py::test_api_v1_instances_sync_capacity_contract PASSED [ 25%]
tests/unit/routes/test_api_v1_instances_sync_capacity_contract.py::test_api_v1_instances_sync_capacity_failure_keeps_inventory PASSED [ 25%]
tests/unit/routes/test_api_v1_instances_sync_capacity_contract.py::test_api_v1_instances_sync_capacity_exception_returns_sync_error_and_keeps_inventory PASSED [ 25%]
tests/unit/routes/test_api_v1_instances_sync_capacity_contract.py::test_api_v1_instances_sync_capacity_connect_failure_returns_connection_error PASSED [ 25%]
tests/unit/routes/test_api_v1_partition_contract.py::test_api_v1_partition_requires_auth PASSED [ 26%]
tests/unit/routes/test_api_v1_partition_contract.py::test_api_v1_partition_endpoints_contract PASSED [ 26%]
tests/unit/routes/test_api_v1_scheduler_contract.py::test_api_v1_scheduler_requires_auth PASSED [ 26%]
tests/unit/routes/test_api_v1_scheduler_contract.py::test_api_v1_scheduler_endpoints_contract PASSED [ 26%]
tests/unit/routes/test_api_v1_swagger_contract.py::test_api_v1_swagger_json_renders PASSED [ 27%]
tests/unit/routes/test_api_v1_tags_bulk_contract.py::test_api_v1_tags_bulk_requires_auth PASSED [ 27%]
tests/unit/routes/test_api_v1_tags_bulk_contract.py::test_api_v1_tags_bulk_endpoints_contract PASSED [ 27%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_list_contract PASSED [ 27%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_options_contract PASSED [ 28%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_categories_contract PASSED [ 28%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tag_detail_contract PASSED [ 28%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_requires_auth PASSED [ 28%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_create_contract PASSED [ 29%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_update_contract PASSED [ 29%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_delete_contract PASSED [ 29%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_delete_in_use_returns_conflict PASSED [ 29%]
tests/unit/routes/test_api_v1_tags_contract.py::test_api_v1_tags_batch_delete_contract PASSED [ 29%]
tests/unit/routes/test_api_v1_task_runs_contract.py::test_api_v1_task_runs_requires_auth PASSED [ 30%]
tests/unit/routes/test_api_v1_task_runs_contract.py::test_api_v1_task_runs_endpoints_contract FAILED [ 30%]
tests/unit/routes/test_api_v1_users_contract.py::test_api_v1_users_requires_auth PASSED [ 30%]
tests/unit/routes/test_api_v1_users_contract.py::test_api_v1_users_endpoints_contract PASSED [ 30%]
tests/unit/routes/test_form_service_message_key_contract.py::test_account_classification_name_exists_message_key_contract FAILED [ 31%]
tests/unit/routes/test_form_service_message_key_contract.py::test_change_password_invalid_old_password_message_key_contract PASSED [ 31%]
tests/unit/routes/test_web_auth_login_page_contract.py::test_web_auth_login_page_remember_checked_by_default PASSED [ 31%]
tests/unit/routes/test_web_auth_login_page_layout_contract.py::test_web_auth_login_page_does_not_render_marketing_hero PASSED [ 31%]
tests/unit/routes/test_web_auth_login_remember.py::test_web_auth_login_without_remember_does_not_set_remember_cookie PASSED [ 32%]
tests/unit/routes/test_web_auth_login_remember.py::test_web_auth_login_with_remember_sets_remember_cookie_expire_in_7_days PASSED [ 32%]
tests/unit/routes/test_web_main_index_redirects.py::test_main_index_redirects_to_login_when_not_authenticated PASSED [ 32%]
tests/unit/routes/test_web_main_index_redirects.py::test_main_index_redirects_to_dashboard_when_authenticated PASSED [ 32%]
tests/unit/schemas/internal_contracts/test_account_change_log_diff_v1.py::test_extract_diff_entries_rejects_legacy_list_shape PASSED [ 33%]
tests/unit/schemas/internal_contracts/test_account_change_log_diff_v1.py::test_extract_diff_entries_supports_v1_dict_shape PASSED [ 33%]
tests/unit/schemas/internal_contracts/test_sync_details_v1.py::test_normalize_sync_details_v1_rejects_missing_version PASSED [ 33%]
tests/unit/schemas/internal_contracts/test_type_specific_v1.py::test_normalize_type_specific_v1_injects_version PASSED [ 33%]
tests/unit/schemas/test_account_change_logs_query.py::test_account_change_logs_list_query_defaults PASSED [ 33%]
tests/unit/schemas/test_account_change_logs_query.py::test_account_change_logs_list_query_normalizes_and_clamps PASSED [ 34%]
tests/unit/schemas/test_account_change_logs_query.py::test_account_change_logs_list_query_fallbacks_invalid_sort_order_to_default PASSED [ 34%]
tests/unit/schemas/test_account_change_logs_query.py::test_account_change_logs_list_query_defaults_sort_field_when_blank PASSED [ 34%]
tests/unit/schemas/test_accounts_query.py::test_accounts_filters_query_defaults PASSED [ 34%]
tests/unit/schemas/test_accounts_query.py::test_accounts_filters_query_normalizes_and_clamps PASSED [ 35%]
tests/unit/schemas/test_accounts_query.py::test_accounts_ledgers_list_query_defaults PASSED [ 35%]
tests/unit/schemas/test_capacity_query.py::test_capacity_databases_aggregations_query_parses_dates_and_clamps PASSED [ 35%]
tests/unit/schemas/test_capacity_query.py::test_capacity_databases_summary_query_parses_ids PASSED [ 35%]
tests/unit/schemas/test_capacity_query.py::test_capacity_instances_aggregations_query_applies_time_range PASSED [ 36%]
tests/unit/schemas/test_capacity_query.py::test_capacity_instances_aggregations_query_ignores_time_range_when_explicit_dates_present PASSED [ 36%]
tests/unit/schemas/test_capacity_query.py::test_capacity_instances_aggregations_query_rejects_invalid_time_range PASSED [ 36%]
tests/unit/schemas/test_credentials_query.py::test_credential_list_filters_query_defaults PASSED [ 36%]
tests/unit/schemas/test_credentials_query.py::test_credential_list_filters_query_normalizes_and_clamps PASSED [ 37%]
tests/unit/schemas/test_credentials_query.py::test_credential_list_filters_query_status_rejects_unknown_value PASSED [ 37%]
tests/unit/schemas/test_credentials_query.py::test_credential_list_filters_query_choice_all_and_blank_to_none PASSED [ 37%]
tests/unit/schemas/test_credentials_query.py::test_credential_list_filters_query_fallbacks_invalid_sort_order_to_default PASSED [ 37%]
tests/unit/schemas/test_databases_query.py::test_databases_options_query_rejects_offset FAILED [ 37%]
tests/unit/schemas/test_databases_query.py::test_databases_options_query_clamps_limit_and_computes_offset PASSED [ 38%]
tests/unit/schemas/test_databases_query.py::test_databases_options_query_rejects_limit_out_of_range PASSED [ 38%]
tests/unit/schemas/test_databases_query.py::test_database_ledgers_query_normalizes_values_and_splits_tags PASSED [ 38%]
tests/unit/schemas/test_databases_query.py::test_databases_sizes_query_requires_instance_id PASSED [ 38%]
tests/unit/schemas/test_databases_query.py::test_databases_sizes_query_rejects_offset FAILED [ 39%]
tests/unit/schemas/test_databases_query.py::test_databases_sizes_query_parses_dates_and_pagination PASSED [ 39%]
tests/unit/schemas/test_databases_query.py::test_databases_sizes_query_rejects_non_positive_limit PASSED [ 39%]
tests/unit/schemas/test_databases_query.py::test_databases_sizes_query_rejects_invalid_dates PASSED [ 39%]
tests/unit/schemas/test_databases_query.py::test_database_table_sizes_query_validates_limit_max_and_rejects_offset FAILED [ 40%]
tests/unit/schemas/test_history_logs_query.py::test_history_logs_list_query_defaults PASSED [ 40%]
tests/unit/schemas/test_history_logs_query.py::test_history_logs_list_query_normalizes PASSED [ 40%]
tests/unit/schemas/test_history_logs_query.py::test_history_logs_list_query_rejects_invalid_sort_order PASSED [ 40%]
tests/unit/schemas/test_history_logs_query.py::test_history_logs_list_query_rejects_out_of_range_hours PASSED [ 41%]
tests/unit/schemas/test_history_logs_query.py::test_history_log_statistics_query_defaults_to_24_hours PASSED [ 41%]
tests/unit/schemas/test_history_sessions_query.py::test_history_sessions_list_filters_query_defaults PASSED [ 41%]
tests/unit/schemas/test_history_sessions_query.py::test_history_sessions_list_filters_query_normalizes_and_clamps PASSED [ 41%]
tests/unit/schemas/test_history_sessions_query.py::test_history_sessions_list_filters_query_fallbacks_invalid_sort_order_to_default PASSED [ 41%]
tests/unit/schemas/test_history_sessions_query.py::test_history_sessions_list_filters_query_defaults_sort_field_when_blank PASSED [ 42%]
tests/unit/schemas/test_instances_query.py::test_instance_list_filters_query_defaults PASSED [ 42%]
tests/unit/schemas/test_instances_query.py::test_instance_list_filters_query_normalizes_and_clamps PASSED [ 42%]
tests/unit/schemas/test_instances_query.py::test_instance_list_filters_query_fallbacks_invalid_sort_order_to_default PASSED [ 42%]
tests/unit/schemas/test_instances_query.py::test_instances_options_query_strips_blank_to_none PASSED [ 43%]
tests/unit/schemas/test_instances_query.py::test_instances_export_query_strips_params PASSED [ 43%]
tests/unit/schemas/test_partition_query.py::test_partitions_list_query_defaults PASSED [ 43%]
tests/unit/schemas/test_partition_query.py::test_partitions_list_query_normalizes_and_clamps PASSED [ 43%]
tests/unit/schemas/test_partition_query.py::test_partition_core_metrics_query_defaults PASSED [ 44%]
tests/unit/schemas/test_partition_query.py::test_partition_core_metrics_query_normalizes_and_compat_days_zero PASSED [ 44%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_categories_v4_postgresql_predefined_roles PASSED [ 44%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_categories_v4_sqlserver_server_roles PASSED [ 44%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_categories_v4_sqlserver_database_roles_dict PASSED [ 45%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_categories_v4_sqlserver_database_roles_list_coerces_to_mapping PASSED [ 45%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_categories_v4_oracle_roles PASSED [ 45%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_categories_v4_oracle_system_privileges_passthrough PASSED [ 45%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_parse_permission_snapshot_categories_v4_returns_error_for_invalid_payload PASSED [ 45%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_parse_permission_snapshot_categories_v4_returns_error_for_unknown_version PASSED [ 46%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_parse_permission_snapshot_categories_v4_returns_ok_for_v4 PASSED [ 46%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_parse_permission_snapshot_type_specific_v4_returns_error_for_invalid_payload PASSED [ 46%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_parse_permission_snapshot_type_specific_v4_returns_error_for_unknown_version PASSED [ 46%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_parse_permission_snapshot_type_specific_v4_returns_ok_for_v4 PASSED [ 47%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_type_specific_v4_returns_bucket_for_db_type PASSED [ 47%]
tests/unit/schemas/test_permission_snapshot_v4_internal_contract.py::test_normalize_permission_snapshot_type_specific_v4_returns_empty_dict_for_invalid_shapes PASSED [ 47%]
tests/unit/schemas/test_tags_query.py::test_tags_list_query_defaults PASSED [ 47%]
tests/unit/schemas/test_tags_query.py::test_tags_list_query_normalizes_and_clamps PASSED [ 48%]
tests/unit/schemas/test_tags_query.py::test_tag_options_query_strips_category PASSED [ 48%]
tests/unit/schemas/test_task_run_summary_schema.py::test_summary_base_has_fixed_top_level_keys PASSED [ 48%]
tests/unit/schemas/test_task_run_summary_schema.py::test_summary_validate_task_key_rejects_wrong_ext_type PASSED [ 48%]
tests/unit/schemas/test_users_query.py::test_user_list_filters_query_defaults PASSED [ 49%]
tests/unit/schemas/test_users_query.py::test_user_list_filters_query_normalizes_and_clamps PASSED [ 49%]
tests/unit/schemas/test_users_query.py::test_user_list_filters_query_fallbacks_invalid_sort_order_to_default PASSED [ 49%]
tests/unit/schemas/test_users_query.py::test_user_list_filters_query_coerces_blank_role_and_status_to_none PASSED [ 49%]
tests/unit/schemas/test_validation_error_mapping.py::test_validate_or_raise_uses_original_value_error_message PASSED [ 50%]
tests/unit/schemas/test_validation_error_mapping.py::test_validate_or_raise_maps_message_key_by_field PASSED [ 50%]
tests/unit/schemas/test_validation_error_mapping.py::test_validate_or_raise_respects_schema_message_key PASSED [ 50%]
tests/unit/services/accounts_sync/test_accounts_sync_actions_service_background.py::test_launch_background_sync_logs_when_task_raises PASSED [ 50%]
tests/unit/services/accounts_sync/test_accounts_sync_service_fail_instance_sync_logging.py::test_sync_with_session_logs_when_fail_instance_sync_raises PASSED [ 50%]
tests/unit/services/accounts_sync/test_mysql_adapter_normalize_account.py::test_normalize_account_defaults_permissions_when_missing PASSED [ 51%]
tests/unit/services/accounts_sync/test_mysql_adapter_normalize_account.py::test_normalize_account_accepts_empty_permissions_dict PASSED [ 51%]
tests/unit/services/accounts_sync/test_mysql_adapter_normalize_account.py::test_normalize_account_coerces_invalid_type_specific_to_dict PASSED [ 51%]
tests/unit/services/accounts_sync/test_mysql_adapter_normalize_account.py::test_normalize_account_does_not_override_existing_type_specific_identity PASSED [ 51%]
tests/unit/services/accounts_sync/test_mysql_adapter_roles.py::test_mysql_adapter_fetch_raw_accounts_sets_account_kind_from_is_role PASSED [ 52%]
tests/unit/services/accounts_sync/test_mysql_adapter_roles.py::test_mysql_adapter_enrich_permissions_includes_roles_direct_and_default PASSED [ 52%]
tests/unit/services/accounts_sync/test_mysql_adapter_roles.py::test_mysql_adapter_enrich_permissions_includes_role_members_for_role_accounts PASSED [ 52%]
tests/unit/services/accounts_sync/test_mysql_adapter_roles.py::test_mysql_adapter_fetch_raw_accounts_raises_on_query_failure PASSED [ 52%]
tests/unit/services/accounts_sync/test_mysql_adapter_roles.py::test_mysql_adapter_does_not_assume_is_role_on_mariadb_versions PASSED [ 53%]
tests/unit/services/accounts_sync/test_mysql_adapter_roles.py::test_mysql_adapter_fetch_raw_accounts_falls_back_when_mysql_user_missing_is_role PASSED [ 53%]
tests/unit/services/accounts_sync/test_mysql_adapter_roles.py::test_mysql57_enrich_permissions_skips_roles_tables PASSED [ 53%]
tests/unit/services/accounts_sync/test_oracle_adapter_normalize_account.py::test_normalize_account_defaults_permissions_when_missing PASSED [ 53%]
tests/unit/services/accounts_sync/test_oracle_adapter_normalize_account.py::test_normalize_account_coerces_invalid_permission_shapes PASSED [ 54%]
tests/unit/services/accounts_sync/test_postgresql_adapter_normalize_account.py::test_normalize_account_defaults_permissions_when_missing PASSED [ 54%]
tests/unit/services/accounts_sync/test_postgresql_adapter_normalize_account.py::test_normalize_account_coerces_invalid_permission_shapes PASSED [ 54%]
tests/unit/services/accounts_sync/test_sqlserver_adapter_normalize_account.py::test_normalize_account_defaults_permissions_when_missing PASSED [ 54%]
tests/unit/services/test_account_classification_dsl_v4.py::test_dsl_v4_validation_accepts_minimal_expression PASSED [ 54%]
tests/unit/services/test_account_classification_dsl_v4.py::test_dsl_v4_evaluator_short_circuits_or PASSED [ 55%]
tests/unit/services/test_account_classification_dsl_v4.py::test_dsl_v4_evaluator_short_circuits_and PASSED [ 55%]
tests/unit/services/test_account_classification_dsl_v4.py::test_dsl_v4_evaluator_reports_missing_args PASSED [ 55%]
tests/unit/services/test_account_classification_dsl_v4.py::test_dsl_v4_has_privilege_supports_scopes PASSED [ 55%]
tests/unit/services/test_account_classification_orchestrator_dsl_guard.py::test_orchestrator_accepts_dsl_v4_rules PASSED [ 56%]
tests/unit/services/test_account_classification_orchestrator_dsl_guard.py::test_orchestrator_rejects_legacy_rule_expressions PASSED [ 56%]
tests/unit/services/test_account_classification_write_service.py::test_create_classification_flags_duplicate_code PASSED [ 56%]
tests/unit/services/test_account_classification_write_service.py::test_create_classification_succeeds PASSED [ 56%]
tests/unit/services/test_account_classification_write_service.py::test_create_classification_rejects_non_integer_priority FAILED [ 57%]
tests/unit/services/test_account_classification_write_service.py::test_update_classification_rejects_non_integer_priority PASSED [ 57%]
tests/unit/services/test_account_classification_write_service.py::test_update_classification_rejects_code_change PASSED [ 57%]
tests/unit/services/test_account_classification_write_service.py::test_update_classification_allows_display_name_change FAILED [ 57%]
tests/unit/services/test_account_classification_write_service.py::test_update_system_classification_rejects_risk_level_change PASSED [ 58%]
tests/unit/services/test_account_permission_manager.py::test_apply_permissions_writes_snapshot PASSED [ 58%]
tests/unit/services/test_account_permission_manager.py::test_apply_permissions_raises_when_facts_builder_fails PASSED [ 58%]
tests/unit/services/test_account_permission_manager.py::test_apply_permissions_writes_roles_into_categories PASSED [ 58%]
tests/unit/services/test_account_permission_manager.py::test_process_existing_permission_raises_when_snapshot_missing PASSED [ 58%]
tests/unit/services/test_account_permission_manager.py::test_find_permission_record_raises_when_instance_account_id_missing PASSED [ 59%]
tests/unit/services/test_account_permission_manager.py::test_calculate_diff_uses_snapshot_view_not_legacy_columns PASSED [ 59%]
tests/unit/services/test_accounts_ledger_change_history_service.py::test_get_change_history_strips_redundant_username_prefix_in_message PASSED [ 59%]
tests/unit/services/test_accounts_ledger_change_history_service.py::test_get_change_history_returns_minimal_payload_for_add PASSED [ 59%]
tests/unit/services/test_aggregation_service_no_cover_branches.py::test_commit_with_partition_retry_wraps_unknown_flush_error PASSED [ 60%]
tests/unit/services/test_aggregation_service_no_cover_branches.py::test_execute_instance_period_returns_failed_summary_when_executor_raises PASSED [ 60%]
tests/unit/services/test_aggregation_service_no_cover_branches.py::test_aggregate_database_periods_marks_failed_when_method_raises PASSED [ 60%]
tests/unit/services/test_aggregation_service_periods.py::test_aggregate_database_periods_uses_previous_daily PASSED [ 60%]
tests/unit/services/test_aggregation_service_periods.py::test_instance_aggregations_daily_override PASSED [ 61%]
tests/unit/services/test_aggregation_tasks_read_service_period_completeness.py::test_has_aggregation_for_period_requires_all_active_instances PASSED [ 61%]
tests/unit/services/test_aggregation_tasks_read_service_period_completeness.py::test_has_aggregation_for_period_returns_true_when_fully_covered PASSED [ 61%]
tests/unit/services/test_auto_classify_actions_service_background.py::test_launch_background_auto_classify_logs_when_task_raises PASSED [ 61%]
tests/unit/services/test_base_capacity_adapter_utils.py::test_safe_to_float_invalid_input_returns_zero PASSED [ 62%]
tests/unit/services/test_cache_fallback_observability.py::test_cache_manager_get_failure_logs_fallback PASSED [ 62%]
tests/unit/services/test_cache_fallback_observability.py::test_cache_manager_set_failure_logs_fallback PASSED [ 62%]
tests/unit/services/test_cache_fallback_observability.py::test_cache_manager_delete_failure_logs_fallback PASSED [ 62%]
tests/unit/services/test_cache_fallback_observability.py::test_cache_manager_set_ttl_zero_is_preserved PASSED [ 62%]
tests/unit/services/test_cache_fallback_observability.py::test_cache_actions_clear_all_cache_logs_fallback_and_counts PASSED [ 63%]
tests/unit/services/test_cache_fallback_observability.py::test_cache_actions_classification_stats_are_derived_from_all_rules_cache PASSED [ 63%]
tests/unit/services/test_capacity_aggregation_task_runner_no_cover_branches.py::test_calculate_instance_aggregation_logs_when_service_raises PASSED [ 63%]
tests/unit/services/test_capacity_collection_actions_service_background.py::test_launch_background_collection_logs_when_task_raises PASSED [ 63%]
tests/unit/services/test_capacity_current_aggregation_actions_service_background.py::test_launch_background_aggregation_logs_when_task_raises PASSED [ 64%]
tests/unit/services/test_classification_rule_write_service.py::test_validate_accepts_builtin_db_types PASSED [ 64%]
tests/unit/services/test_classification_rule_write_service.py::test_validate_blocks_duplicate_rules PASSED [ 64%]
tests/unit/services/test_classification_rule_write_service.py::test_update_rule_does_not_overwrite_is_active_when_missing PASSED [ 64%]
tests/unit/services/test_classification_rule_write_service.py::test_update_rule_blocks_classification_change PASSED [ 65%]
tests/unit/services/test_classification_rule_write_service.py::test_update_rule_blocks_db_type_change PASSED [ 65%]
tests/unit/services/test_classification_rule_write_service.py::test_update_rule_does_not_create_new_version_when_expression_is_same PASSED [ 65%]
tests/unit/services/test_classification_rule_write_service.py::test_update_rule_creates_new_version_when_expression_changes PASSED [ 65%]
tests/unit/services/test_connection_factory_test_connection_contract.py::test_adapter_test_connection_connect_failure_includes_message PASSED [ 66%]
tests/unit/services/test_connection_factory_test_connection_contract.py::test_adapter_test_connection_exception_includes_message PASSED [ 66%]
tests/unit/services/test_database_aggregation_runner_no_cover_branches.py::test_invoke_callback_logs_warning_when_callback_raises PASSED [ 66%]
tests/unit/services/test_database_aggregation_runner_no_cover_branches.py::test_aggregate_period_logs_error_when_instance_aggregation_raises PASSED [ 66%]
tests/unit/services/test_database_aggregation_runner_no_cover_branches.py::test_apply_change_statistics_sets_default_values_when_calculation_raises PASSED [ 66%]
tests/unit/services/test_database_ledger_service.py::test_format_size_handles_megabytes PASSED [ 67%]
tests/unit/services/test_database_ledger_service.py::test_resolve_sync_status_recent PASSED [ 67%]
tests/unit/services/test_database_ledger_service.py::test_resolve_sync_status_timeout PASSED [ 67%]
tests/unit/services/test_filter_options_service_cache.py::test_filter_options_service_caches_instance_select_options_empty_list PASSED [ 67%]
tests/unit/services/test_filter_options_service_cache.py::test_filter_options_service_instance_select_options_cache_key_varies_by_db_type PASSED [ 68%]
tests/unit/services/test_history_account_change_logs_read_service.py::test_list_logs_returns_minimal_message_and_no_diffs_for_add PASSED [ 68%]
tests/unit/services/test_history_account_change_logs_read_service.py::test_get_log_detail_returns_minimal_payload_for_add PASSED [ 68%]
tests/unit/services/test_instance_aggregation_runner_no_cover_branches.py::test_invoke_callback_logs_warning_when_callback_raises PASSED [ 68%]
tests/unit/services/test_instance_aggregation_runner_no_cover_branches.py::test_aggregate_period_logs_error_when_query_stats_raises PASSED [ 69%]
tests/unit/services/test_instance_aggregation_runner_no_cover_branches.py::test_persist_instance_aggregation_wraps_sqlalchemy_error PASSED [ 69%]
tests/unit/services/test_instance_aggregation_runner_no_cover_branches.py::test_persist_instance_aggregation_wraps_unknown_commit_error PASSED [ 69%]
tests/unit/services/test_instance_aggregation_runner_no_cover_branches.py::test_apply_change_statistics_sets_defaults_when_calculation_raises PASSED [ 69%]
tests/unit/services/test_instance_batch_deletion_service_schema_usage.py::test_instance_batch_deletion_service_uses_parse_payload PASSED [ 70%]
tests/unit/services/test_instance_batch_deletion_service_schema_usage.py::test_instance_batch_deletion_service_uses_validate_or_raise PASSED [ 70%]
tests/unit/services/test_instance_connections_write_service_schema_usage.py::test_instance_connections_write_service_parse_connection_test_payload_uses_parse_payload PASSED [ 70%]
tests/unit/services/test_instance_connections_write_service_schema_usage.py::test_instance_connections_write_service_parse_connection_test_payload_uses_validate_or_raise PASSED [ 70%]
tests/unit/services/test_instance_connections_write_service_schema_usage.py::test_instance_connections_write_service_parse_connection_test_payload_rejects_empty_payload PASSED [ 70%]
tests/unit/services/test_instance_connections_write_service_schema_usage.py::test_instance_connections_write_service_parse_batch_test_payload_rejects_too_many_instance_ids PASSED [ 71%]
tests/unit/services/test_instance_write_service_tag_names.py::test_instance_schema_coerces_tag_names_string_to_list PASSED [ 71%]
tests/unit/services/test_instance_write_service_tag_names.py::test_instance_schema_accepts_tag_names_list PASSED [ 71%]
tests/unit/services/test_login_service_schema_usage.py::test_login_service_login_from_payload_uses_parse_payload PASSED [ 71%]
tests/unit/services/test_login_service_schema_usage.py::test_login_service_login_from_payload_uses_validate_or_raise PASSED [ 72%]
tests/unit/services/test_login_service_schema_usage.py::test_login_service_login_from_payload_rejects_missing_username_or_password PASSED [ 72%]
tests/unit/services/test_mysql_capacity_adapter_exception_logging.py::test_mysql_fetch_capacity_logs_and_reraises_when_tablespace_collection_fails PASSED [ 72%]
tests/unit/services/test_oracle_connection_adapter_is_thin_fallback.py::test_oracle_connection_is_thin_probe_failure_logs_fallback PASSED [ 72%]
tests/unit/services/test_oracle_table_size_adapter.py::test_oracle_table_size_adapter_fallback_to_sys_dba_segments PASSED [ 73%]
tests/unit/services/test_oracle_table_size_adapter.py::test_oracle_table_size_adapter_missing_privileges_raises_value_error PASSED [ 73%]
tests/unit/services/test_oracle_table_size_adapter.py::test_oracle_table_size_adapter_empty_result_without_tablespace_check_raises_value_error PASSED [ 73%]
tests/unit/services/test_partition_management_service_cleanup.py::test_partition_management_service_does_not_expose_create_future_partitions PASSED [ 73%]
tests/unit/services/test_partition_management_service_cleanup.py::test_create_partition_does_not_create_partition_indexes PASSED [ 74%]
tests/unit/services/test_partition_management_service_cleanup_schema_usage.py::test_partition_management_service_cleanup_old_partitions_from_payload_uses_parse_payload PASSED [ 74%]
tests/unit/services/test_partition_management_service_cleanup_schema_usage.py::test_partition_management_service_cleanup_old_partitions_from_payload_uses_validate_or_raise PASSED [ 74%]
tests/unit/services/test_partition_management_service_create_partition_schema_usage.py::test_partition_management_service_create_partition_from_payload_uses_parse_payload PASSED [ 74%]
tests/unit/services/test_partition_management_service_create_partition_schema_usage.py::test_partition_management_service_create_partition_from_payload_uses_validate_or_raise PASSED [ 75%]
tests/unit/services/test_partition_management_service_create_partition_schema_usage.py::test_partition_management_service_create_partition_from_payload_rejects_past_month PASSED [ 75%]
tests/unit/services/test_partition_management_service_no_cover_branches.py::test_create_partition_logs_and_reports_failure_when_create_partition_table_raises PASSED [ 75%]
tests/unit/services/test_partition_management_service_no_cover_branches.py::test_cleanup_old_partitions_logs_and_reports_failure_when_drop_partition_table_raises PASSED [ 75%]
tests/unit/services/test_partition_management_service_no_cover_branches.py::test_get_table_partitions_skips_bad_row_when_extract_date_raises PASSED [ 75%]
tests/unit/services/test_partition_read_service_missing_partitions.py::test_partition_read_service_only_checks_current_and_next_month PASSED [ 76%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_sqlserver_includes_database_roles_in_roles PASSED [ 76%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_sqlserver_does_not_treat_is_disabled_as_locked PASSED [ 76%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_sqlserver_adds_locked_for_connect_denied PASSED [ 76%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_postgresql_maps_role_attributes_to_capabilities PASSED [ 77%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_includes_internal_contract_error_in_meta PASSED [ 77%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_includes_internal_contract_error_when_version_is_not_int PASSED [ 77%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_includes_type_specific_contract_error_when_shape_invalid PASSED [ 77%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_mysql_roles_include_direct_and_default PASSED [ 78%]
tests/unit/services/test_permission_facts_builder.py::test_build_permission_facts_mysql_role_does_not_add_locked PASSED [ 78%]
tests/unit/services/test_permission_snapshot_view.py::test_permission_snapshot_view_returns_snapshot_when_present PASSED [ 78%]
tests/unit/services/test_permission_snapshot_view.py::test_permission_snapshot_view_does_not_fallback_to_legacy_columns PASSED [ 78%]
tests/unit/services/test_scheduler_actions_service_background_error_logging.py::test_run_job_in_background_logs_when_job_func_raises PASSED [ 79%]
tests/unit/services/test_scheduler_job_write_service_schema_usage.py::test_scheduler_job_write_service_upsert_uses_parse_payload PASSED [ 79%]
tests/unit/services/test_scheduler_job_write_service_schema_usage.py::test_scheduler_job_write_service_upsert_uses_validate_or_raise PASSED [ 79%]
tests/unit/services/test_scheduler_job_write_service_type_checking_guard.py::test_scheduler_job_write_service_type_checking_guard_sets_job_types_to_object PASSED [ 79%]
tests/unit/services/test_sqlserver_adapter_permissions.py::test_aggregate_database_permissions_writes_entries PASSED [ 79%]
tests/unit/services/test_sqlserver_adapter_permissions.py::test_get_all_users_database_permissions_batch_uses_database_batches PASSED [ 80%]
tests/unit/services/test_sqlserver_adapter_permissions.py::test_fetch_raw_accounts_collects_sqlserver_login_status_fields PASSED [ 80%]
tests/unit/services/test_sqlserver_adapter_permissions.py::test_normalize_account_does_not_infer_sqlserver_is_locked_from_type_specific PASSED [ 80%]
tests/unit/services/test_sqlserver_adapter_permissions.py::test_normalize_account_does_not_infer_sqlserver_is_locked_from_is_disabled PASSED [ 80%]
tests/unit/services/test_sync_session_service_cleanup.py::test_clean_sync_details_rejects_missing_version PASSED [ 81%]
tests/unit/services/test_sync_session_service_cleanup.py::test_create_session_disallows_custom_session_id PASSED [ 81%]
tests/unit/services/test_sync_session_service_cleanup.py::test_add_instance_records_rejects_missing_instance_ids PASSED [ 81%]
tests/unit/services/test_sync_session_service_cleanup.py::test_complete_instance_sync_raises_on_write_error PASSED [ 81%]
tests/unit/services/test_sync_session_service_cleanup.py::test_fail_instance_sync_raises_on_write_error PASSED [ 82%]
tests/unit/services/test_sync_session_service_cleanup.py::test_get_session_records_raises_on_query_error PASSED [ 82%]
tests/unit/services/test_sync_session_service_cleanup.py::test_get_session_by_id_raises_on_query_error PASSED [ 82%]
tests/unit/services/test_sync_session_service_cleanup.py::test_cancel_session_returns_false_when_session_not_running PASSED [ 82%]
tests/unit/services/test_sync_session_service_cleanup.py::test_start_instance_sync_raises_when_record_missing PASSED [ 83%]
tests/unit/services/test_sync_session_service_cleanup.py::test_start_instance_sync_raises_on_write_error PASSED [ 83%]
tests/unit/services/test_sync_session_service_cleanup.py::test_complete_instance_sync_raises_when_record_missing PASSED [ 83%]
tests/unit/services/test_sync_session_service_cleanup.py::test_fail_instance_sync_raises_when_record_missing PASSED [ 83%]
tests/unit/services/test_tag_write_service_batch_delete_error_logging.py::test_tag_write_service_batch_delete_logs_when_delete_fails PASSED [ 83%]
tests/unit/services/test_tag_write_service_batch_delete_schema_usage.py::test_tag_write_service_batch_delete_from_payload_uses_parse_payload PASSED [ 84%]
tests/unit/services/test_tag_write_service_batch_delete_schema_usage.py::test_tag_write_service_batch_delete_from_payload_uses_validate_or_raise PASSED [ 84%]
tests/unit/services/test_task_run_summary_actions_service_envelope.py::test_prepare_background_auto_classify_uses_summary_envelope PASSED [ 84%]
tests/unit/services/test_task_run_summary_actions_service_envelope.py::test_prepare_background_capacity_aggregate_current_uses_summary_envelope PASSED [ 84%]
tests/unit/services/test_task_run_summary_builders.py::test_build_sync_accounts_summary_has_common_metrics_and_ext_data PASSED [ 85%]
tests/unit/services/test_task_run_summary_builders.py::test_build_sync_databases_summary_has_ext_data PASSED [ 85%]
tests/unit/services/test_task_run_summary_builders.py::test_build_calculate_database_aggregations_summary_has_periods PASSED [ 85%]
tests/unit/services/test_task_run_summary_builders.py::test_build_calculate_account_classification_summary_has_scope_time PASSED [ 85%]
tests/unit/services/test_task_run_summary_builders.py::test_build_auto_classify_accounts_summary_has_ext_data PASSED [ 86%]
tests/unit/services/test_task_run_summary_builders.py::test_build_capacity_aggregate_current_summary_has_ext_data PASSED [ 86%]
tests/unit/services/test_task_runs_read_service.py::test_task_runs_read_service_list_runs_returns_paginated_items PASSED [ 86%]
tests/unit/services/test_task_runs_write_service.py::test_task_runs_write_service_start_run_creates_task_run PASSED [ 86%]
tests/unit/services/test_task_runs_write_service.py::test_task_runs_write_service_start_run_rejects_raw_dict_summary PASSED [ 87%]
tests/unit/services/test_task_runs_write_service.py::test_task_runs_write_service_init_items_creates_pending_items_and_updates_total PASSED [ 87%]
tests/unit/services/test_task_runs_write_service.py::test_task_runs_write_service_finalize_run_aggregates_item_statuses PASSED [ 87%]
tests/unit/services/test_task_runs_write_service.py::test_task_runs_write_service_cancel_run_marks_pending_running_items_cancelled PASSED [ 87%]
tests/unit/services/test_task_runs_write_service.py::test_task_runs_write_service_serializes_date_values_in_json_columns PASSED [ 87%]
tests/unit/services/test_user_write_service.py::test_update_prevents_disabling_last_admin PASSED [ 88%]
tests/unit/services/test_user_write_service.py::test_update_allows_change_when_other_admin_exists PASSED [ 88%]
tests/unit/services/test_user_write_service.py::test_create_returns_username_exists_message_key PASSED [ 88%]
tests/unit/services/test_user_write_service.py::test_user_write_service_supports_default_repository PASSED [ 88%]
tests/unit/services/test_user_write_service.py::test_update_requires_is_active_field PASSED [ 89%]
tests/unit/services/test_yaml_config_validation_filters.py::test_account_filters_yaml_validated_at_entry PASSED [ 89%]
tests/unit/services/test_yaml_config_validation_filters.py::test_account_filters_yaml_invalid_schema_raises_value_error PASSED [ 89%]
tests/unit/services/test_yaml_config_validation_filters.py::test_database_filters_yaml_validated_at_entry PASSED [ 89%]
tests/unit/services/test_yaml_config_validation_filters.py::test_database_filters_yaml_invalid_schema_raises_value_error PASSED [ 90%]
tests/unit/services/test_yaml_config_validation_filters.py::test_database_filters_yaml_invalid_syntax_raises_value_error PASSED [ 90%]
tests/unit/services/test_yaml_config_validation_scheduler_tasks.py::test_read_default_task_configs_validates_and_canonicalizes PASSED [ 90%]
tests/unit/services/test_yaml_config_validation_scheduler_tasks.py::test_read_default_task_configs_raises_value_error_when_schema_invalid PASSED [ 90%]
tests/unit/tasks/test_capacity_aggregation_tasks_no_cover_branches.py::test_handle_aggregation_task_exception_suppresses_rollback_errors PASSED [ 91%]
tests/unit/tasks/test_capacity_collection_tasks_no_cover_branches.py::test_process_instance_with_fallback_rolls_back_and_marks_failed PASSED [ 91%]
tests/unit/tasks/test_capacity_collection_tasks_no_cover_branches.py::test_sync_databases_unclassified_exception_finalizes_run PASSED [ 91%]
tests/unit/test_settings_cache_options_ttl.py::test_settings_cache_options_ttl_can_be_overridden PASSED [ 91%]
tests/unit/test_settings_cache_options_ttl.py::test_settings_cache_options_ttl_rejects_negative PASSED [ 91%]
tests/unit/test_settings_database_url_policy.py::test_settings_fails_fast_when_database_url_missing_in_production PASSED [ 92%]
tests/unit/test_settings_database_url_policy.py::test_settings_does_not_mutate_dyld_library_path PASSED [ 92%]
tests/unit/test_settings_database_url_policy.py::test_settings_does_not_log_database_url_when_sqlite_fallback PASSED [ 92%]
tests/unit/test_settings_enable_scheduler_flag.py::test_settings_enable_scheduler_can_be_disabled PASSED [ 92%]
tests/unit/test_settings_password_encryption_key_validation.py::test_settings_fails_fast_when_password_encryption_key_invalid PASSED [ 93%]
tests/unit/types/test_request_payload.py::test_parse_payload_multidict_trims_strings_by_default PASSED [ 93%]
tests/unit/types/test_request_payload.py::test_parse_payload_multidict_preserves_password_raw_value PASSED [ 93%]
tests/unit/types/test_request_payload.py::test_parse_payload_multidict_list_fields_are_always_list PASSED [ 93%]
tests/unit/types/test_request_payload.py::test_parse_payload_multidict_non_list_fields_take_last_value PASSED [ 94%]
tests/unit/types/test_request_payload.py::test_parse_payload_mapping_list_field_accepts_scalar_and_list PASSED [ 94%]
tests/unit/types/test_request_payload.py::test_parse_payload_sets_missing_boolean_fields_to_false_for_multidict PASSED [ 94%]
tests/unit/types/test_request_payload.py::test_parse_payload_guard_allows_single_call_per_request PASSED [ 94%]
tests/unit/types/test_request_payload.py::test_parse_payload_guard_raises_when_called_twice_in_request PASSED [ 95%]
tests/unit/utils/test_query_filter_utils_classification_options.py::test_build_classification_options_prefers_display_name PASSED [ 95%]
tests/unit/utils/test_redirect_safety.py::test_is_safe_redirect_target_enforces_minimal_policy PASSED [ 95%]
tests/unit/utils/test_redirect_safety.py::test_resolve_safe_redirect_target_returns_fallback_when_target_missing PASSED [ 95%]
tests/unit/utils/test_redirect_safety.py::test_resolve_safe_redirect_target_returns_fallback_when_target_unsafe PASSED [ 95%]
tests/unit/utils/test_redirect_safety.py::test_resolve_safe_redirect_target_returns_normalized_target PASSED [ 96%]
tests/unit/utils/test_request_logging_wide_events.py::test_request_id_is_propagated_and_injected_into_unified_log_context PASSED [ 96%]
tests/unit/utils/test_request_logging_wide_events.py::test_http_request_completed_is_emitted_for_errors_by_default PASSED [ 96%]
tests/unit/utils/test_request_logging_wide_events.py::test_error_envelope_contains_request_id PASSED [ 96%]
tests/unit/utils/test_sensitive_data.py::test_scrub_sensitive_fields_masks_nested_values PASSED [ 97%]
tests/unit/utils/test_sensitive_data.py::test_scrub_sensitive_fields_supports_extra_keys PASSED [ 97%]
tests/unit/utils/test_spreadsheet_formula_safety.py::test_sanitize_csv_cell_returns_empty_string_for_none PASSED [ 97%]
tests/unit/utils/test_spreadsheet_formula_safety.py::test_sanitize_csv_cell_prefixes_risky_values PASSED [ 97%]
tests/unit/utils/test_spreadsheet_formula_safety.py::test_sanitize_csv_cell_keeps_safe_values PASSED [ 98%]
tests/unit/utils/test_spreadsheet_formula_safety.py::test_sanitize_csv_row_sanitizes_each_cell PASSED [ 98%]
tests/unit/utils/test_structlog_log_entry_schema.py::test_build_log_entry_returns_minimum_fields_for_non_dict_event PASSED [ 98%]
tests/unit/utils/test_structlog_log_entry_schema.py::test_build_log_entry_extracts_module_from_logger_when_missing PASSED [ 98%]
tests/unit/utils/test_structlog_log_entry_schema.py::test_build_log_entry_filters_system_fields_into_context PASSED [ 99%]
tests/unit/utils/test_structlog_log_entry_schema.py::test_build_log_entry_drops_debug_level PASSED [ 99%]
tests/unit/utils/test_structlog_log_entry_schema.py::test_build_log_entry_defaults_invalid_level_to_info PASSED [ 99%]
tests/unit/utils/test_time_utils_parsing.py::test_to_china_invalid_iso_returns_none PASSED [ 99%]
tests/unit/utils/test_time_utils_parsing.py::test_format_china_time_invalid_returns_dash PASSED [100%]

=================================== FAILURES ===================================
___________________ test_api_v1_task_runs_endpoints_contract ___________________
tests/unit/routes/test_api_v1_task_runs_contract.py:32: in test_api_v1_task_runs_endpoints_contract
    from app.services.task_runs.task_runs_write_service import task_runs_write_service
E   ImportError: cannot import name 'task_runs_write_service' from 'app.services.task_runs.task_runs_write_service' (/Users/apple/Github/WhaleFall/app/services/task_runs/task_runs_write_service.py)
------------------------------ Captured log setup ------------------------------
WARNING  app.settings:settings.py:462    PASSWORD_ENCRYPTION_KEY,()
INFO     app.settings:settings.py:463  PASSWORD_ENCRYPTION_KEY(: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")
INFO     system:cache_utils.py:185 {"module": "cache", "event": "", "timestamp": "2026-01-28T05:48:57.985129Z", "level": "info", "app_name": "", "app_version": "1.4.0", "logger_name": "system"}
_________ test_account_classification_name_exists_message_key_contract _________
tests/unit/routes/test_form_service_message_key_contract.py:43: in test_account_classification_name_exists_message_key_contract
    assert response.status_code == 201
E   assert 400 == 201
E    +  where 400 = <WrapperTestResponse streamed [400 BAD REQUEST]>.status_code
------------------------------ Captured log call -------------------------------
WARNING  app.settings:settings.py:462    PASSWORD_ENCRYPTION_KEY,()
INFO     app.settings:settings.py:463  PASSWORD_ENCRYPTION_KEY(: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")
INFO     system:cache_utils.py:185 {"module": "cache", "event": "", "timestamp": "2026-01-28T05:48:58.776076Z", "level": "info", "app_name": "", "app_version": "1.4.0", "logger_name": "system"}
WARNING  app:route_safety.py:75 {"module": "accounts_classifications", "action": "create_classification", "actor_id": 1, "classification_name": "dup_classification", "error_type": "ValidationError", "error_message": "(code)", "event": "create_classification", "timestamp": "2026-01-28T05:48:59.020238Z", "level": "warning", "request_id": "req_0a3887e9e5854308ba9d77354a95eadb", "user_id": 1, "current_user_id": 1, "current_username": "admin", "app_name": "", "app_version": "4.0.0-dev", "environment": "testing", "build_hash": "9d606135649b55a70cd87d0ea966b700", "region": "local", "runtime_instance_id": "Mac-mini.local", "host": "localhost", "logger_name": "app"}
WARNING  app:structlog_config.py:344 {"module": "error_handler", "exception": "(code)", "error_id": "15d57a2a6d2e4647bd71942e47909600", "category": "validation", "severity": "low", "context": {"request_id": "req_0a3887e9e5854308ba9d77354a95eadb", "user_id": 1, "url": "http://localhost/api/v1/accounts/classifications", "method": "POST", "meta": {"ip_address": "127.0.0.1"}}, "event": "(code)", "timestamp": "2026-01-28T05:48:59.020398Z", "level": "warning", "request_id": "req_0a3887e9e5854308ba9d77354a95eadb", "user_id": 1, "current_user_id": 1, "current_username": "admin", "app_name": "", "app_version": "4.0.0-dev", "environment": "testing", "build_hash": "9d606135649b55a70cd87d0ea966b700", "region": "local", "runtime_instance_id": "Mac-mini.local", "host": "localhost", "logger_name": "app"}
INFO     http:request_middleware.py:104 {"module": "http", "action": "POST /api/v1/accounts/classifications", "status_code": 400, "outcome": "error", "duration_ms": 1, "route": "/api/v1/accounts/classifications", "endpoint": "api_v1.accounts_classifications_account_classifications_resource", "error_id": null, "error_type": null, "event": "http_request_completed", "timestamp": "2026-01-28T05:48:59.020527Z", "level": "info", "request_id": "req_0a3887e9e5854308ba9d77354a95eadb", "user_id": 1, "current_user_id": 1, "current_username": "admin", "app_name": "", "app_version": "4.0.0-dev", "environment": "testing", "build_hash": "9d606135649b55a70cd87d0ea966b700", "region": "local", "runtime_instance_id": "Mac-mini.local", "host": "localhost", "logger_name": "http"}
ERROR    app:structlog_config.py:287 {"module": "system", "exception": "assert 400 == 201\n +  where 400 = <WrapperTestResponse streamed [400 BAD REQUEST]>.status_code", "event": "", "timestamp": "2026-01-28T05:48:59.020713Z", "level": "error", "app_name": "", "app_version": "4.0.0-dev", "environment": "testing", "build_hash": "9d606135649b55a70cd87d0ea966b700", "region": "local", "runtime_instance_id": "Mac-mini.local", "logger_name": "app"}
_________________ test_databases_options_query_rejects_offset __________________
tests/unit/schemas/test_databases_query.py:18: in test_databases_options_query_rejects_offset
    with pytest.raises(ValidationError) as excinfo:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE <class 'app.core.exceptions.ValidationError'>
__________________ test_databases_sizes_query_rejects_offset ___________________
tests/unit/schemas/test_databases_query.py:73: in test_databases_sizes_query_rejects_offset
    with pytest.raises(ValidationError) as excinfo:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE <class 'app.core.exceptions.ValidationError'>
____ test_database_table_sizes_query_validates_limit_max_and_rejects_offset ____
tests/unit/schemas/test_databases_query.py:117: in test_database_table_sizes_query_validates_limit_max_and_rejects_offset
    with pytest.raises(ValidationError) as excinfo:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   Failed: DID NOT RAISE <class 'app.core.exceptions.ValidationError'>
___________ test_create_classification_rejects_non_integer_priority ____________
tests/unit/services/test_account_classification_write_service.py:87: in test_create_classification_rejects_non_integer_priority
    assert str(exc.value) == ""
E   AssertionError: assert '(code)' == ''
E     
E     - 
E     + (code)
____________ test_update_classification_allows_display_name_change _____________
tests/unit/services/test_account_classification_write_service.py:181: in test_update_classification_allows_display_name_change
    assert updated.display_name == "()"
E   AssertionError: assert '' == '()'
E     
E     - ()
E     + 
------------------------------ Captured log call -------------------------------
INFO     app:structlog_config.py:318 {"module": "account_classification", "classification_id": null, "operator_id": null, "event": "", "timestamp": "2026-01-28T05:49:00.930354Z", "level": "info", "app_name": "", "app_version": "1.4.0", "logger_name": "app"}
=========================== short test summary info ============================
FAILED tests/unit/routes/test_api_v1_task_runs_contract.py::test_api_v1_task_runs_endpoints_contract
FAILED tests/unit/routes/test_form_service_message_key_contract.py::test_account_classification_name_exists_message_key_contract
FAILED tests/unit/schemas/test_databases_query.py::test_databases_options_query_rejects_offset
FAILED tests/unit/schemas/test_databases_query.py::test_databases_sizes_query_rejects_offset
FAILED tests/unit/schemas/test_databases_query.py::test_database_table_sizes_query_validates_limit_max_and_rejects_offset
FAILED tests/unit/services/test_account_classification_write_service.py::test_create_classification_rejects_non_integer_priority
FAILED tests/unit/services/test_account_classification_write_service.py::test_update_classification_allows_display_name_change
================= 7 failed, 417 passed, 1 deselected in 27.37s =================
