# ESLint 全量扫描报告（生成：2025-12-11 16:05）

> 执行命令：`npm run lint:js`（基于 eslint@9 + eslint-plugin-import + eslint-plugin-security）。本次扫描覆盖 `app/static/js/**/*.js`，命中 **275** 条问题（104 errors / 171 warnings）。

## 1. 主要规则概览

| 规则 | 触发次数（约） | 代表文件 | 修复建议 |
| --- | --- | --- | --- |
| **no-undef** | 60+ | `modules/views/admin/scheduler/index.js`、`modules/views/instances/detail.js`、`common/csrf-utils.js` | 为全局依赖加 `/* global */`、转为显式 import（若打包），或在模块顶部挂载引用。确保 `toast`、`timeUtils`、`connectionManager` 等来源明确。 |
| **no-unused-vars** | 40+ | `modules/views/accounts/account-classification/**`、`modules/views/scheduler/**`、`modules/views/credentials/**` | 清理未使用的参数/变量，或改为 `_unused` 前缀；对只为类型/调试存在的变量可移除。 |
| **security/detect-object-injection** | 150+ | `common/grid-wrapper.js`、`modules/stores/**`、`modules/views/**` | 所涉代码普遍将用户输入当作对象键/调用，需校验白名单、改用 `Map` 或 `switch`，不可直接信任动态 key。 |
| **no-useless-escape** | 10 | `common/validation-rules.js`、`modules/ui/modal.js`、`modules/theme/color-tokens.js` 等 | 去掉不必要的反斜杠；若需保留，应使用 `String.raw` 或注释说明。 |
| **no-unused-vars（模态/表单）** | —— | `modules/views/tags/*`, `modules/views/auth/*` | 多个 modal 文件中存在 `bootstrap`、`selectOne` 等定义未使用，建议合并或删除冗余模块。 |

## 2. 高优先级问题（P0）

1. **全局依赖未声明 (`no-undef`)**  
   - 受影响文件：`modules/views/admin/scheduler/index.js`、`modules/views/instances/detail.js`、`modules/views/tags/batch-assign.js` 等共 20+。  
   - 说明：`toast`、`timeUtils`、`connectionManager`、`FormValidator` 等均来自全局脚本，目前 ESLint 视为未定义。  
   - 动作：在文件首部添加 `/* global toast, timeUtils */`，或引入模块化封装；若依赖通过 DOM 注入，需统一封装一个 `window.AppGlobals` 来集中导出。  

2. **安全规则 `security/detect-object-injection` 普遍告警**  
   - 受影响文件：`common/grid-wrapper.js`、`common/toast.js`、`modules/stores/*`、`modules/views/*`。  
   - 说明：大量代码直接通过 `obj[key]` 读写并执行函数，且 `key` 多来自用户筛选条件/接口响应。虽然部分场景是受控配置，但需逐一评估。  
   - 动作：对真实风险点添加白名单校验，如 `const allowed = new Set(['asc','desc']); if (!allowed.has(order)) return;`。如果确认安全，则在局部以注释 `// eslint-disable-next-line security/detect-object-injection -- 说明` 放行。  

3. **批量未使用变量 (`no-unused-vars`)**  
   - 受影响文件：`modules/views/accounts/account-classification/rule-modals.js`、`modules/views/admin/partitions/index.js`、`modules/views/credentials/modals/credential-modals.js` 等。  
   - 说明：遗留组件在重构后保留了旧参数或 helper。  
   - 动作：删除无用变量或将其转换为 doc-only 参数；若需占位，可使用 `_` 或 `unusedVar` 并关闭特定规则。  

4. **字符串转义冗余 (`no-useless-escape`)**  
   - 受影响文件：`common/validation-rules.js`、`modules/ui/modal.js`、`modules/theme/color-tokens.js`、`modules/views/auth/modals/user-modals.js` 等。  
   - 说明：多处在普通字符串中对 `/`、`"`、`-` 等进行了冗余转义，影响可读性。  
   - 动作：清理多余反斜杠；若运行时确需 literal，可使用 `RegExp` 构造或 `String.raw`.  

## 3. 建议治理顺序

1. **声明全局依赖**：整理所有可复用工具（`toast`, `timeUtils`, `FormValidator`, `ValidationRules`, `connectionManager` 等）到单独入口，或在 `.globals.js` 文件中集中附加到 `window` 并在 ESLint 配置 `languageOptions.globals` 中声明，优先消除 100+ `no-undef`。  
2. **清理未使用变量**：围绕 modal/store/view 进行模块内自查，顺便删除废弃 helper，有助于下一步压缩打包体积。  
3. **安全告警分类**：将 `security/detect-object-injection` 命中点分为“确需动态 key”的配置型代码和“高风险用户输入”，前者可写 helper 并在函数内部消化告警，后者要加白名单或 `Object.hasOwn` 守卫。  
4. **整理字符串转义**：配合 Prettier 或简单查找，集中修复 `no-useless-escape`，避免影响阅读。  

## 4. 验证建议

- 修复后执行 `npm run lint:js`，并针对高风险模块（scheduler/instances/tags）补充 Cypress 或最少 Smoke 测试，确保全局变量声明不会影响运行。  
- 若将前端构建纳入 CI，可在 `Makefile` 中增加 `make lint-js` 目标，结合 Ruff 质量门禁统一执行。  

## 5. 附录

- **命令输出摘要**：275 问题（104 errors、171 warnings），详见终端 `npm run lint:js` 日志。  
- **依赖版本**：eslint@9.39.1、eslint-plugin-import@2.32.0、eslint-plugin-security@3.0.1。  

