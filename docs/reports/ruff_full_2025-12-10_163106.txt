C901 `configure_app` is too complex (11 > 10)
   --> app/__init__.py:145:5
    |
145 | def configure_app(app: Flask, config_name: str | None = None) -> None:  # noqa: ARG001, PLR0915
    |     ^^^^^^^^^^^^^
146 |     """配置 Flask 应用的核心参数.
    |

E501 Line too long (154 > 120)
   --> app/__init__.py:237:121
    |
235 | …
236 | …
237 | …" or request.is_secure or request.headers.get(HttpHeaders.X_FORWARDED_SSL) == "on":
    |                                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
238 | …
239 | …
    |

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/config.py:57:33
   |
55 |           raise ValueError(msg)
56 |       SQLALCHEMY_TRACK_MODIFICATIONS = False
57 |       SQLALCHEMY_ENGINE_OPTIONS = {
   |  _________________________________^
58 | |         "pool_pre_ping": True,
59 | |         "pool_recycle": 300,
60 | |         "pool_timeout": CONNECTION_TIMEOUT,
61 | |         "max_overflow": 10,
62 | |         "pool_size": MAX_CONNECTIONS,
63 | |         "echo": DEBUG,  # 开发环境显示SQL,生产环境不显示
64 | |     }
   | |_____^
65 |
66 |       # Redis缓存配置
   |

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> app/constants/user_roles.py:7:1
  |
6 | from types import MappingProxyType
7 | from typing import ClassVar, Mapping
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |
help: Import from `collections.abc`

PLR0913 Too many arguments in function definition (6 > 5)
  --> app/errors/__init__.py:70:9
   |
68 |     )
69 |
70 |     def __init__(
   |         ^^^^^^^^
71 |         self,
72 |         message: str | None = None,
   |

E501 Line too long (122 > 120)
   --> app/errors/__init__.py:223:121
    |
221 |         category=ErrorCategory.SECURITY,
222 |         severity=ErrorSeverity.MEDIUM,
223 |         default_message_key="RATE_LIMIT_EXCEEDED" if hasattr(ErrorMessages, "RATE_LIMIT_EXCEEDED") else "INVALID_REQUEST",
    |                                                                                                                         ^^
224 |     )
    |

PLC0105 `TypeVar` name "ContextResourceT" does not reflect its contravariance; consider renaming it to "ContextResourceT_contra"
  --> app/forms/definitions/base.py:58:20
   |
57 | ResourceModelT = TypeVar("ResourceModelT", bound=SupportsResourceId)
58 | ContextResourceT = TypeVar("ContextResourceT", bound=SupportsResourceId, contravariant=True)
   |                    ^^^^^^^
   |

UP037 [*] Remove quotes from type annotation
   --> app/forms/definitions/base.py:98:25
    |
 96 |     name: str
 97 |     template: str
 98 |     service_class: type["BaseResourceService[ResourceModelT]"]
    |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 99 |     fields: list[ResourceFormField] = field(default_factory=list)
100 |     success_message: str = "保存成功"
    |
help: Remove quotes

PLR0913 Too many arguments in function definition (8 > 5)
  --> app/models/credential.py:49:9
   |
47 |     deleted_at = db.Column(db.DateTime(timezone=True), nullable=True)
48 |
49 |     def __init__(
   |         ^^^^^^^^
50 |         self,
51 |         name: str,
   |

PLR2004 Magic value used in comparison, consider replacing `8` with a constant variable
   --> app/models/credential.py:128:33
    |
127 |         """
128 |         if len(self.password) > 8:
    |                                 ^
129 |             return "*" * (len(self.password) - 4) + self.password[-4:]
130 |         return "*" * len(self.password)
    |

D205 1 blank line required between summary line and description
 --> app/models/database_size_aggregation.py:1:1
  |
1 | / """数据库大小聚合统计模型
2 | | 存储每周、每月、每季度的统计信息.
3 | | """
  | |___^
4 |
5 |   from sqlalchemy import (
  |
help: Insert single blank line

D205 1 blank line required between summary line and description
 --> app/models/database_size_stat.py:1:1
  |
1 | / """数据库大小统计模型
2 | | 存储每个数据库在特定时间点的大小统计信息
3 | | 支持 PostgreSQL 分区表,按日期分区.
4 | | """
  | |___^
5 |
6 |   from sqlalchemy import (
  |
help: Insert single blank line

E501 Line too long (121 > 120)
  --> app/models/database_size_stat.py:64:115
   |
62 |     )
63 |     updated_at = Column(
64 |         DateTime(timezone=True), nullable=False, default=time_utils.now, onupdate=time_utils.now, comment="记录更新时间",
   |                                                                                                                         ^
65 |     )
   |

D205 1 blank line required between summary line and description
 --> app/models/database_type_config.py:1:1
  |
1 | / """鲸落 - 数据库类型配置模型
2 | | 管理数据库类型的配置信息.
3 | | """
  | |___^
4 |
5 |   import json
  |
help: Insert single blank line

PLR0913 Too many arguments in function definition (9 > 5)
  --> app/models/instance.py:95:9
   |
93 |     # sync_data关系已移除,因为SyncData表已删除
94 |
95 |     def __init__(
   |         ^^^^^^^^
96 |         self,
97 |         name: str,
   |

D205 1 blank line required between summary line and description
 --> app/models/instance_account.py:1:1
  |
1 | / """鲸落 - 实例账户关系模型
2 | | 用于维护实例包含哪些账户,以及账户的存在状态.
3 | | """
  | |___^
4 |
5 |   from app import db
  |
help: Insert single blank line

E501 Line too long (121 > 120)
  --> app/models/instance_account.py:37:115
   |
35 |     db_type = db.Column(db.String(50), nullable=False, comment="数据库类型")
36 |     is_active = db.Column(db.Boolean, default=True, nullable=False, comment="账户是否活跃")
37 |     first_seen_at = db.Column(db.DateTime(timezone=True), nullable=False, default=time_utils.now, comment="首次发现时间")
   |                                                                                                                         ^
38 |     last_seen_at = db.Column(db.DateTime(timezone=True), nullable=False, default=time_utils.now, comment="最后发现时间")
39 |     deleted_at = db.Column(db.DateTime(timezone=True), nullable=True, comment="删除时间")
   |

D205 1 blank line required between summary line and description
 --> app/models/instance_database.py:1:1
  |
1 | / """鲸落 - 实例数据库关系模型
2 | | 用于维护实例包含哪些数据库,以及数据库的状态变化.
3 | | """
  | |___^
4 |
5 |   from datetime import date
  |
help: Insert single blank line

D205 1 blank line required between summary line and description
 --> app/models/instance_size_aggregation.py:1:1
  |
1 | / """实例大小聚合统计模型
2 | | 存储实例级别的每周、每月、每季度的统计信息.
3 | | """
  | |___^
4 |
5 |   from sqlalchemy import (
  |
help: Insert single blank line

D205 1 blank line required between summary line and description
 --> app/models/instance_size_stat.py:1:1
  |
1 | / """鲸落 - 实例大小统计模型
2 | | 存储数据库实例的总大小统计数据.
3 | | """
  | |___^
4 |
5 |   from app import db
  |
help: Insert single blank line

E501 Line too long (123 > 120)
  --> app/models/instance_size_stat.py:41:118
   |
39 |     deleted_at = db.Column(db.DateTime(timezone=True), nullable=True, comment="删除时间")
40 |     created_at = db.Column(db.DateTime(timezone=True), default=time_utils.now, comment="创建时间")
41 |     updated_at = db.Column(db.DateTime(timezone=True), default=time_utils.now, onupdate=time_utils.now, comment="更新时间")
   |                                                                                                                          ^^
42 |
43 |     # 关系
   |

D205 1 blank line required between summary line and description
 --> app/models/unified_log.py:1:1
  |
1 | / """鲸落 - 统一日志系统数据模型
2 | | 基于structlog的统一日志存储模型.
3 | | """
  | |___^
4 |
5 |   from datetime import datetime, timedelta
  |
help: Insert single blank line

PLR0913 Too many arguments in function definition (6 > 5)
  --> app/models/unified_log.py:83:9
   |
82 |     @classmethod
83 |     def create_log_entry(
   |         ^^^^^^^^^^^^^^^^
84 |         cls,
85 |         level: LogLevel,
   |

PLC0415 `import` should be at the top-level of a file
   --> app/models/unified_log.py:111:13
    |
109 |         elif timestamp.tzinfo is None:
110 |             # 如果没有时区信息,假设为UTC时间
111 |             from app.utils.time_utils import UTC_TZ
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
112 |
113 |             timestamp = timestamp.replace(tzinfo=UTC_TZ)
    |

PLC0415 `import` should be at the top-level of a file
   --> app/models/unified_log.py:135:9
    |
134 |         """
135 |         from sqlalchemy import func
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
136 |
137 |         start_time = time_utils.now() - timedelta(hours=hours)
    |

PLR2004 Magic value used in comparison, consider replacing `8` with a constant variable
  --> app/models/user.py:69:28
   |
67 |         """
68 |         # 增加密码强度验证
69 |         if len(password) < 8:
   |                            ^
70 |             error_msg = "密码长度至少8位"
71 |             raise ValueError(error_msg)
   |

D102 Missing docstring in public method
  --> app/routes/accounts/ledgers.py:36:9
   |
34 |     """最小化 Query 接口,便于类型标注."""
35 |
36 |     def join(self, *args: object, **kwargs: object) -> Self:
   |         ^^^^
37 |         ...
   |

D102 Missing docstring in public method
  --> app/routes/accounts/ledgers.py:39:9
   |
37 |         ...
38 |
39 |     def filter(self, *args: object, **kwargs: object) -> Self:
   |         ^^^^^^
40 |         ...
   |

D102 Missing docstring in public method
  --> app/routes/accounts/ledgers.py:42:9
   |
40 |         ...
41 |
42 |     def filter_by(self, **kwargs: object) -> Self:
   |         ^^^^^^^^^
43 |         ...
   |

D102 Missing docstring in public method
  --> app/routes/accounts/ledgers.py:45:9
   |
43 |         ...
44 |
45 |     def order_by(self, *args: object, **kwargs: object) -> Self:
   |         ^^^^^^^^
46 |         ...
   |

D102 Missing docstring in public method
  --> app/routes/accounts/ledgers.py:48:9
   |
46 |         ...
47 |
48 |     def paginate(self, *args: object, **kwargs: object) -> Pagination:
   |         ^^^^^^^^
49 |         ...
   |

D102 Missing docstring in public method
  --> app/routes/accounts/ledgers.py:51:9
   |
49 |         ...
50 |
51 |     def count(self) -> int:
   |         ^^^^^
52 |         ...
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:121:23
    |
120 | def _build_account_query(filters: AccountFilters) -> AccountQuery:
121 |     base_query = cast(AccountQuery, AccountPermission.query)
    |                       ^^^^^^^^^^^^
122 |     relationship_clause = cast(Any, AccountPermission.instance_account)
123 |     query = base_query.join(InstanceAccount, relationship_clause)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:122:32
    |
120 | def _build_account_query(filters: AccountFilters) -> AccountQuery:
121 |     base_query = cast(AccountQuery, AccountPermission.query)
122 |     relationship_clause = cast(Any, AccountPermission.instance_account)
    |                                ^^^
123 |     query = base_query.join(InstanceAccount, relationship_clause)
124 |     query = query.filter(InstanceAccount.is_active.is_(True))
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:141:28
    |
139 |         return query
140 |     query = query.join(Instance, AccountPermission.instance_id == Instance.id)
141 |     username_column = cast(Any, AccountPermission.username)
    |                            ^^^
142 |     instance_name_column = cast(Any, Instance.name)
143 |     instance_host_column = cast(Any, Instance.host)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:142:33
    |
140 |     query = query.join(Instance, AccountPermission.instance_id == Instance.id)
141 |     username_column = cast(Any, AccountPermission.username)
142 |     instance_name_column = cast(Any, Instance.name)
    |                                 ^^^
143 |     instance_host_column = cast(Any, Instance.host)
144 |     return query.filter(
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:143:33
    |
141 |     username_column = cast(Any, AccountPermission.username)
142 |     instance_name_column = cast(Any, Instance.name)
143 |     instance_host_column = cast(Any, Instance.host)
    |                                 ^^^
144 |     return query.filter(
145 |         or_(
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:172:33
    |
170 |         return query
171 |     try:
172 |         tag_relationship = cast(Any, Instance.tags)
    |                                 ^^^
173 |         tag_name_column = cast(Any, Tag.name)
174 |         return query.join(Instance).join(tag_relationship).filter(tag_name_column.in_(tags))
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:173:32
    |
171 |     try:
172 |         tag_relationship = cast(Any, Instance.tags)
173 |         tag_name_column = cast(Any, Tag.name)
    |                                ^^^
174 |         return query.join(Instance).join(tag_relationship).filter(tag_name_column.in_(tags))
175 |     except Exception as exc:  # pragma: no cover - 日志用于排查
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/accounts/ledgers.py:175:12
    |
173 |         tag_name_column = cast(Any, Tag.name)
174 |         return query.join(Instance).join(tag_relationship).filter(tag_name_column.in_(tags))
175 |     except Exception as exc:  # pragma: no cover - 日志用于排查
    |            ^^^^^^^^^
176 |         log_error("标签过滤失败", module="accounts_ledgers", tags=tags, error=str(exc))
177 |         return query
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:203:23
    |
202 | def _calculate_account_stats() -> dict[str, int]:
203 |     base_query = cast(AccountQuery, AccountPermission.query)
    |                       ^^^^^^^^^^^^
204 |     relationship_clause = cast(Any, AccountPermission.instance_account)
205 |     base_query = base_query.join(InstanceAccount, relationship_clause)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/accounts/ledgers.py:204:32
    |
202 | def _calculate_account_stats() -> dict[str, int]:
203 |     base_query = cast(AccountQuery, AccountPermission.query)
204 |     relationship_clause = cast(Any, AccountPermission.instance_account)
    |                                ^^^
205 |     base_query = base_query.join(InstanceAccount, relationship_clause)
206 |     base_query = base_query.filter(InstanceAccount.is_active.is_(True))
    |
help: Add quotes

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/routes/accounts/ledgers.py:253:5
    |
253 | def _build_accounts_json_response(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
254 |     pagination: Pagination,
255 |     stats: dict[str, int],
    |

PLC0415 `import` should be at the top-level of a file
  --> app/routes/accounts/statistics.py:39:5
   |
37 |         flash("获取账户统计信息失败,请稍后重试", FlashCategory.ERROR)
38 |
39 |     from app.models.sync_session import SyncSession
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
40 |
41 |     recent_syncs = SyncSession.query.order_by(SyncSession.created_at.desc()).limit(10).all()
   |

TRY301 Abstract `raise` to an inner function
   --> app/routes/accounts/sync.py:102:13
    |
100 |             )
101 |             msg = "没有找到活跃的数据库实例"
102 |             raise AppValidationError(msg)
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
103 |
104 |         created_by = getattr(current_user, "id", None)
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/accounts/sync.py:107:13
    |
106 |         def _run_sync_task(captured_created_by: int | None) -> None:
107 |             from app.tasks.accounts_sync_tasks import sync_accounts
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
108 |
109 |             try:
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/accounts/sync.py:111:20
    |
109 |             try:
110 |                 sync_accounts(manual_run=True, created_by=captured_created_by)
111 |             except Exception as exc:  # pragma: no cover - 后台线程日志
    |                    ^^^^^^^^^
112 |                 log_error(
113 |                     "后台批量账户同步失败",
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/auth.py:310:5
    |
309 |     """
310 |     from flask_wtf.csrf import generate_csrf
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
311 |     return jsonify_unified_success(
312 |         data={"csrf_token": generate_csrf()},
    |

D205 1 blank line required between summary line and description
 --> app/routes/cache.py:2:1
  |
2 | / """鲸落 - 缓存管理路由
3 | | 提供缓存管理相关的API接口.
4 | | """
  | |___^
5 |
6 |   from flask import Blueprint, Response, request
  |
help: Insert single blank line

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/cache.py:176:16
    |
174 |             if cache_manager.invalidate_instance_cache(instance.id):
175 |                 cleared_count += 1
176 |         except Exception as exc:
    |                ^^^^^^^^^
177 |             log_error(
178 |                 "清除实例缓存失败",
    |

E501 Line too long (121 > 120)
   --> app/routes/cache.py:190:112
    |
188 |         operator_id=getattr(current_user, "id", None),
189 |     )
190 |     return jsonify_unified_success(message=f"已清除 {cleared_count} 个实例的缓存", data={"cleared_count": cleared_count})
    |                                                                                                                         ^
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/cache.py:302:16
    |
300 |                 "rules_count": len(rules_cache) if rules_cache else 0,
301 |             }
302 |         except Exception as exc:
    |                ^^^^^^^^^
303 |             log_error(
304 |                 "获取数据库类型缓存统计失败",
    |

C901 `aggregate_current` is too complex (28 > 10)
  --> app/routes/capacity/aggregations.py:58:5
   |
56 | @view_required
57 | @require_csrf
58 | def aggregate_current() -> Response:  # noqa: PLR0912, PLR0915
   |     ^^^^^^^^^^^^^^^^^
59 |     """手动触发当前周期数据聚合.
   |

D205 1 blank line required between summary line and description
 --> app/routes/capacity/databases.py:1:1
  |
1 | / """数据库统计 API 路由
2 | | 提供数据库大小监控、历史数据、统计聚合等接口
3 | | 专注于数据库层面的统计功能.
4 | | """
  | |___^
5 |
6 |   import contextlib
  |
help: Insert single blank line

TRY301 Abstract `raise` to an inner function
   --> app/routes/capacity/databases.py:205:13
    |
203 |         if parsed_dt is None:
204 |             msg = "无法解析日期"
205 |             raise ValueError(msg)
    |             ^^^^^^^^^^^^^^^^^^^^^
206 |         return parsed_dt.date()
207 |     except Exception as exc:
    |

D202 [*] No blank lines allowed after function docstring (found 1)
  --> app/routes/capacity/instances.py:47:9
   |
45 |     @property
46 |     def offset(self) -> int:
47 |         """计算分页偏移."""
   |         ^^^^^^^^^^^^^^^^^^^
48 |
49 |         return max(self.page - 1, 0) * self.per_page
   |
help: Remove blank line(s) after function docstring

C901 `fetch_instance_summary` is too complex (13 > 10)
   --> app/routes/capacity/instances.py:186:5
    |
184 | @login_required
185 | @view_required
186 | def fetch_instance_summary() -> Response:
    |     ^^^^^^^^^^^^^^^^^^^^^^
187 |     """获取实例聚合汇总信息(实例统计层面).
    |

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:289:5
    |
288 | def _extract_instance_metrics_filters() -> InstanceMetricsFilters:
289 |     """解析列表查询参数."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^
290 |
291 |     instance_id = request.args.get("instance_id", type=int)
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:320:5
    |
318 |     time_range: str | None,
319 | ) -> tuple[str | None, str | None]:
320 |     """根据快捷时间范围填充起止日期."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
321 |
322 |     if time_range and not start_date and not end_date:
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:331:5
    |
330 | def _build_instance_metrics_query(filters: InstanceMetricsFilters) -> InstanceAggregationQuery:
331 |     """根据过滤条件构建实例聚合查询."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
332 |
333 |     base_query = InstanceSizeAggregation.query.join(Instance).filter(
    |
help: Remove blank line(s) after function docstring

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/capacity/instances.py:337:18
    |
335 |         Instance.deleted_at.is_(None),
336 |     )
337 |     query = cast(InstanceAggregationQuery, base_query)
    |                  ^^^^^^^^^^^^^^^^^^^^^^^^
338 |     if filters.instance_id:
339 |         query = query.filter(InstanceSizeAggregation.instance_id == filters.instance_id)
    |
help: Add quotes

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:357:5
    |
355 |     filters: InstanceMetricsFilters,
356 | ) -> tuple[list[InstanceSizeAggregation], int]:
357 |     """查询实例聚合记录."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^
358 |
359 |     if filters.get_all:
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:391:5
    |
389 |     aggregations: list[InstanceSizeAggregation],
390 | ) -> list[dict[str, Any]]:
391 |     """转换聚合记录,补充实例元数据."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
392 |
393 |     serialized: list[dict[str, Any]] = []
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:411:5
    |
409 |     filters: InstanceMetricsFilters,
410 | ) -> dict[str, Any]:
411 |     """构造返回给前端的分页载荷."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
412 |
413 |     total_pages = max((total + filters.per_page - 1) // filters.per_page, 1)
    |
help: Remove blank line(s) after function docstring

D205 1 blank line required between summary line and description
 --> app/routes/common.py:1:1
  |
1 | / """通用 API 路由
2 | | 提供跨模块使用的通用接口.
3 | | """
  | |___^
4 |
5 |   from flask import Blueprint, Response, request
  |
help: Insert single blank line

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/connections.py:110:17
    |
109 |     """
110 |     data = cast(JsonDict | None, request.get_json(silent=True))
    |                 ^^^^^^^^^^^^^^^
111 |     if not data:
112 |         msg = "请求数据不能为空"
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/connections.py:222:17
    |
221 |     """
222 |     data = cast(JsonDict | None, request.get_json(silent=True))
    |                 ^^^^^^^^^^^^^^^
223 |     if not data:
224 |         msg = "请求数据不能为空"
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/connections.py:251:27
    |
249 |                 log_warning("批量连接测试遇到不存在的实例", module="connections", instance_id=instance_id)
250 |                 continue
251 |             result = cast(BatchTestResult, connection_test_service.test_connection(instance))
    |                           ^^^^^^^^^^^^^^^
252 |             result["instance_id"] = instance_id
253 |             result["instance_name"] = instance.name
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/connections.py:259:16
    |
257 |                 fail_count += 1
258 |             results.append(result)
259 |         except Exception as exc:  # pragma: no cover - 单个实例失败记录
    |                ^^^^^^^^^
260 |             results.append({"instance_id": instance_id, "success": False, "error": f"测试失败: {exc!s}"})
261 |             fail_count += 1
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/connections.py:288:17
    |
286 |         msg = "请求数据格式必须是 JSON 对象"
287 |         raise ValidationError(msg)
288 |     data = cast(JsonDict, raw_data)
    |                 ^^^^^^^^
289 |     if "instance_ids" not in data:
290 |         msg = "缺少实例ID列表"
    |
help: Add quotes

C901 `index` is too complex (12 > 10)
   --> app/routes/credentials.py:156:5
    |
154 | @login_required
155 | @view_required
156 | def index() -> str:
    |     ^^^^^
157 |     """凭据管理首页.
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/credentials.py:217:9
    |
215 |     # 标签筛选
216 |     if tags:
217 |         from app.models.tag import Tag
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
218 |         query = query.join(Credential.tags).filter(Tag.name.in_(tags))
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/credentials.py:384:16
    |
382 |             db.session.delete(credential)
383 |             db.session.commit()
384 |         except Exception as exc:
    |                ^^^^^^^^^
385 |             _handle_db_exception("删除凭据", exc)
386 |     except DatabaseError as exc:
    |

C901 `list_credentials` is too complex (11 > 10)
   --> app/routes/credentials.py:415:5
    |
413 | @login_required
414 | @view_required
415 | def list_credentials() -> "Response":
    |     ^^^^^^^^^^^^^^^^
416 |     """获取凭据列表 API.
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/credentials.py:475:9
    |
474 |     if tag_params:
475 |         from app.models.tag import Tag
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
476 |         query = query.join(Credential.tags).filter(Tag.name.in_(tag_params))
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/dashboard.py:219:12
    |
217 |             },
218 |         }
219 |     except Exception as exc:
    |            ^^^^^^^^^
220 |         db.session.rollback()
221 |         log_error("获取系统概览失败", module="dashboard", error=str(exc))
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/dashboard.py:262:12
    |
260 |             charts["sync_trend"] = get_sync_trend_data()
261 |
262 |     except Exception as exc:
    |            ^^^^^^^^^
263 |         log_error("获取图表数据失败", module="dashboard", error=str(exc))
264 |         charts = {}
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/dashboard.py:312:12
    |
311 |         return [{"status": status, "count": count} for status, count in status_count.items()]
312 |     except Exception as exc:
    |            ^^^^^^^^^
313 |         log_error("获取任务状态分布失败", module="dashboard", error=str(exc))
314 |         return []
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/dashboard.py:394:12
    |
392 |                 },
393 |             )
394 |     except Exception as exc:
    |            ^^^^^^^^^
395 |         log_error("获取同步趋势数据失败", module="dashboard", error=str(exc))
396 |         trend_data = []
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/dashboard.py:445:12
    |
443 |             "uptime": get_system_uptime(),
444 |         }
445 |     except Exception as exc:
    |            ^^^^^^^^^
446 |         log_error("获取系统状态失败", module="dashboard", error=str(exc))
447 |         return {
    |

D205 1 blank line required between summary line and description
 --> app/routes/databases/capacity_sync.py:1:1
  |
1 | / """数据库域:容量同步 API 路由
2 | | 专注于数据同步功能,不包含统计功能.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

BLE001 Do not catch blind exception: `Exception`
  --> app/routes/databases/capacity_sync.py:74:16
   |
72 |         try:
73 |             inventory_result = collector.synchronize_database_inventory()
74 |         except Exception as inventory_error:
   |                ^^^^^^^^^
75 |             log_error(
76 |                 "同步数据库列表失败",
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/databases/capacity_sync.py:115:16
    |
113 |         try:
114 |             saved_count = collector.save_collected_data(databases_data)
115 |         except Exception as exc:
    |                ^^^^^^^^^
116 |             log_error(
117 |                 "保存数据库容量数据失败",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/databases/capacity_sync.py:136:16
    |
134 |             aggregation_service.calculate_daily_database_aggregations_for_instance(instance.id)
135 |             aggregation_service.calculate_daily_aggregations_for_instance(instance.id)
136 |         except Exception as exc:
    |                ^^^^^^^^^
137 |             log_warning(
138 |                 "容量聚合刷新失败",
    |

TRY301 Abstract `raise` to an inner function
   --> app/routes/databases/capacity_sync.py:218:9
    |
216 |         )
217 |         error_message = result.get("message") or result.get("error") or "实例容量同步失败"
218 |         raise SystemError(error_message)
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
219 |
220 |     except NotFoundError:
    |

D205 1 blank line required between summary line and description
 --> app/routes/files.py:1:1
  |
1 | / """文件导入导出路由
2 | | 统一处理全局的导出/上传相关接口.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/files.py:5:1
   |
 3 |   """
 4 |
 5 | / from __future__ import annotations
 6 | |
 7 | | import csv
 8 | | import io
 9 | | import json
10 | | from collections.abc import Iterable, Mapping
11 | | from itertools import groupby
12 | | from dataclasses import dataclass
13 | | from datetime import datetime
14 | | from typing import cast
15 | |
16 | | from flask import Blueprint, Response, request
17 | | from flask_login import login_required
18 | | from sqlalchemy import desc, or_
19 | |
20 | | from app import db
21 | | from app.constants import DatabaseType, HttpHeaders
22 | | from app.constants.import_templates import (
23 | |     INSTANCE_IMPORT_TEMPLATE_HEADERS,
24 | |     INSTANCE_IMPORT_TEMPLATE_SAMPLE,
25 | | )
26 | | from app.errors import SystemError, ValidationError
27 | | from app.models.account_permission import AccountPermission
28 | | from app.models.account_classification import AccountClassificationAssignment
29 | | from app.models.instance import Instance
30 | | from app.models.instance_account import InstanceAccount
31 | | from app.models.tag import Tag
32 | | from app.models.unified_log import LogLevel, UnifiedLog
33 | | from app.services.ledgers.database_ledger_service import DatabaseLedgerService
34 | | from app.types import QueryProtocol
35 | | from app.utils.decorators import view_required
36 | | from app.utils.structlog_config import log_error
37 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
38 |
39 |   # 创建蓝图
   |
help: Organize imports

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
  --> app/routes/files.py:10:29
   |
 8 | import io
 9 | import json
10 | from collections.abc import Iterable, Mapping
   |                             ^^^^^^^^
11 | from itertools import groupby
12 | from dataclasses import dataclass
   |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
  --> app/routes/files.py:10:39
   |
 8 | import io
 9 | import json
10 | from collections.abc import Iterable, Mapping
   |                                       ^^^^^^^
11 | from itertools import groupby
12 | from dataclasses import dataclass
   |
help: Move into type-checking block

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/routes/files.py:84:18
   |
82 | def _build_account_export_query(filters: AccountExportFilters) -> AccountQuery:
83 |     base_query = AccountPermission.query.join(InstanceAccount, AccountPermission.instance_account)
84 |     query = cast(AccountQuery, base_query)
   |                  ^^^^^^^^^^^^
85 |     query = query.filter(InstanceAccount.is_active.is_(True))
   |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/files.py:126:12
    |
124 |     try:
125 |         return query.join(Instance).join(Instance.tags).filter(Tag.name.in_(tags))
126 |     except Exception as exc:  # pragma: no cover - 记录异常
    |            ^^^^^^^^^
127 |         log_error("导出账户时标签过滤失败", module="files", error=str(exc))
128 |         return query
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/files.py:194:18
    |
193 | def _build_log_query(params: Mapping[str, str]) -> UnifiedLogQuery:
194 |     query = cast(UnifiedLogQuery, UnifiedLog.query)
    |                  ^^^^^^^^^^^^^^^
195 |     start_time = params.get("start_time")
196 |     end_time = params.get("end_time")
    |
help: Add quotes

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/files.py:508:5
    |
506 | @login_required
507 | def export_logs() -> Response:
508 |     """导出日志 API."""
    |     ^^^^^^^^^^^^^^^^^^^
509 |
510 |     format_type = request.args.get("format", "json")
    |
help: Remove blank line(s) after function docstring

PLC0415 `import` should be at the top-level of a file
   --> app/routes/health.py:125:9
    |
123 |     db_status = "connected"
124 |     try:
125 |         from sqlalchemy import text
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
126 |
127 |         db.session.execute(text("SELECT 1"))
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/health.py:128:12
    |
127 |         db.session.execute(text("SELECT 1"))
128 |     except Exception:
    |            ^^^^^^^^^
129 |         db_status = "error"
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/health.py:135:12
    |
133 |     try:
134 |         redis_status = "connected" if cache_manager and cache_manager.health_check() else "error"
135 |     except Exception:
    |            ^^^^^^^^^
136 |         redis_status = "error"
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/health.py:198:9
    |
196 |     try:
197 |         start_time = time.time()
198 |         from sqlalchemy import text
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
199 |         db.session.execute(text("SELECT 1"))
200 |         response_time = (time.time() - start_time) * 1000  # 毫秒
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/health.py:207:12
    |
205 |             "status": "connected",
206 |         }
207 |     except Exception as exc:
    |            ^^^^^^^^^
208 |         log_error("数据库健康检查失败", module="health", error=str(exc))
209 |         return {"healthy": False, "error": str(exc), "status": "disconnected"}
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/health.py:234:12
    |
232 |             "status": "connected" if result == "ok" else "error",
233 |         }
234 |     except Exception as exc:
    |            ^^^^^^^^^
235 |         log_error("缓存健康检查失败", module="health", error=str(exc))
236 |         return {"healthy": False, "error": str(exc), "status": "disconnected"}
    |

PLR2004 Magic value used in comparison, consider replacing `90` with a constant variable
   --> app/routes/health.py:269:31
    |
267 |         healthy = all(
268 |             [
269 |                 cpu_percent < 90,  # CPU使用率低于90%
    |                               ^^
270 |                 memory_percent < 90,  # 内存使用率低于90%
271 |                 disk_percent < 90,  # 磁盘使用率低于90%
    |

PLR2004 Magic value used in comparison, consider replacing `90` with a constant variable
   --> app/routes/health.py:270:34
    |
268 |             [
269 |                 cpu_percent < 90,  # CPU使用率低于90%
270 |                 memory_percent < 90,  # 内存使用率低于90%
    |                                  ^^
271 |                 disk_percent < 90,  # 磁盘使用率低于90%
272 |             ],
    |

PLR2004 Magic value used in comparison, consider replacing `90` with a constant variable
   --> app/routes/health.py:271:32
    |
269 |                 cpu_percent < 90,  # CPU使用率低于90%
270 |                 memory_percent < 90,  # 内存使用率低于90%
271 |                 disk_percent < 90,  # 磁盘使用率低于90%
    |                                ^^
272 |             ],
273 |         )
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/health.py:282:12
    |
280 |             "status": "healthy" if healthy else "warning",
281 |         }
282 |     except Exception as exc:
    |            ^^^^^^^^^
283 |         log_error("系统健康检查失败", module="health", error=str(exc))
284 |         return {"healthy": False, "error": str(exc), "status": "error"}
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/health.py:296:9
    |
294 |     """
295 |     try:
296 |         from app import app_start_time
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
297 |
298 |         current_time = time_utils.now_china()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/routes/health.py:305:9
    |
303 |         minutes, _ = divmod(remainder, 60)
304 |
305 |         return f"{days}天 {hours}小时 {minutes}分钟"
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
306 |     except Exception:
307 |         return "未知"
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/health.py:306:12
    |
305 |         return f"{days}天 {hours}小时 {minutes}分钟"
306 |     except Exception:
    |            ^^^^^^^^^
307 |         return "未知"
    |

D205 1 blank line required between summary line and description
 --> app/routes/history/logs.py:2:1
  |
2 | / """鲸落 - 统一日志系统API路由
3 | | 提供日志查询、展示和管理的RESTful API.
4 | | """
  | |___^
5 |
6 |   from datetime import datetime, timedelta
  |
help: Insert single blank line

C901 `search_logs` is too complex (17 > 10)
   --> app/routes/history/logs.py:102:5
    |
100 | @logs_bp.route("/api/search", methods=["GET"])
101 | @login_required
102 | def search_logs() -> Response:
    |     ^^^^^^^^^^^
103 |     """搜索日志 API.
    |

PLR0912 Too many branches (17 > 12)
   --> app/routes/history/logs.py:102:5
    |
100 | @logs_bp.route("/api/search", methods=["GET"])
101 | @login_required
102 | def search_logs() -> Response:
    |     ^^^^^^^^^^^
103 |     """搜索日志 API.
    |

PLR0915 Too many statements (67 > 50)
   --> app/routes/history/logs.py:102:5
    |
100 | @logs_bp.route("/api/search", methods=["GET"])
101 | @login_required
102 | def search_logs() -> Response:
    |     ^^^^^^^^^^^
103 |     """搜索日志 API.
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/routes/history/logs.py:211:13
    |
209 |         logs = []
210 |         for log_entry in pagination.items:
211 |             logs.append(log_entry.to_dict())
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
212 |
213 |         response_data = {
    |
help: Replace for loop with list comprehension

C901 `list_logs` is too complex (11 > 10)
   --> app/routes/history/logs.py:238:5
    |
236 | @logs_bp.route("/api/list", methods=["GET"])
237 | @login_required
238 | def list_logs() -> Response:
    |     ^^^^^^^^^
239 |     """Grid.js 日志列表 API.
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/history/logs.py:395:9
    |
393 |     """
394 |     try:
395 |         from sqlalchemy import distinct
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
396 |
397 |         # 获取所有模块
    |

C901 `get_log_stats` is too complex (11 > 10)
   --> app/routes/history/logs.py:413:5
    |
411 | @logs_bp.route("/api/stats", methods=["GET"])
412 | @login_required
413 | def get_log_stats() -> tuple[dict, int]:
    |     ^^^^^^^^^^^^^
414 |     """获取日志统计 API(兼容旧前端).
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/history/logs.py:472:9
    |
471 |         # 活跃模块数
472 |         from sqlalchemy import distinct
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
473 |         modules_query = db.session.query(distinct(UnifiedLog.module))
    |

TRY301 Abstract `raise` to an inner function
   --> app/routes/history/sessions.py:149:13
    |
147 |         if not session:
148 |             msg = "会话不存在"
149 |             raise NotFoundError(msg)
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
150 |
151 |         # 获取实例记录
    |

TRY301 Abstract `raise` to an inner function
   --> app/routes/history/sessions.py:208:9
    |
206 |             return jsonify_unified_success(message="会话已取消")
207 |         msg = "取消会话失败,会话不存在或已结束"
208 |         raise NotFoundError(msg)
    |         ^^^^^^^^^^^^^^^^^^^^^^^^
209 |
210 |     except Exception as e:
    |

TRY301 Abstract `raise` to an inner function
   --> app/routes/history/sessions.py:245:13
    |
243 |         if not session:
244 |             msg = "会话不存在"
245 |             raise NotFoundError(msg)
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
246 |
247 |         # 获取所有实例记录
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/instances/batch.py:3:1
   |
 1 |   """Instances 域:批量创建与删除路由."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import csv
 6 | | import io
 7 | | from typing import Any
 8 | |
 9 | | from werkzeug.datastructures import FileStorage
10 | |
11 | | from flask import Blueprint, Response, request
12 | | from flask_login import current_user, login_required
13 | |
14 | | from app import db
15 | | from app.constants import HttpStatus
16 | | from app.constants.import_templates import (
17 | |     INSTANCE_IMPORT_REQUIRED_FIELDS,
18 | |     INSTANCE_IMPORT_TEMPLATE_HEADERS,
19 | | )
20 | | from app.constants.system_constants import ErrorCategory
21 | | from app.errors import SystemError, ValidationError
22 | | from app.services.instances import InstanceBatchCreationService, InstanceBatchDeletionService
23 | | from app.utils.decorators import create_required, delete_required, require_csrf
24 | | from app.utils.response_utils import jsonify_unified_error_message, jsonify_unified_success
25 | | from app.utils.structlog_config import log_error
   | |________________________________________________^
26 |
27 |   instances_batch_bp = Blueprint(
   |
help: Organize imports

TC002 Move third-party import `werkzeug.datastructures.FileStorage` into a type-checking block
  --> app/routes/instances/batch.py:9:37
   |
 7 | from typing import Any
 8 |
 9 | from werkzeug.datastructures import FileStorage
   |                                     ^^^^^^^^^^^
10 |
11 | from flask import Blueprint, Response, request
   |
help: Move into type-checking block

TRY301 Abstract `raise` to an inner function
   --> app/routes/instances/batch.py:129:13
    |
127 |         if not uploaded_file or not uploaded_file.filename.endswith(".csv"):
128 |             msg = "请上传CSV格式文件"
129 |             raise ValidationError(msg)
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^
130 |
131 |         return _process_csv_file(uploaded_file)
    |

TRY301 Abstract `raise` to an inner function
   --> app/routes/instances/batch.py:173:13
    |
171 |         if not instances_data:
172 |             msg = "CSV文件为空或未包含有效数据"
173 |             raise ValidationError(msg)
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^
174 |
175 |         return _create_instances(instances_data)
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/instances/detail.py:3:1
   |
 1 |   """实例详情相关接口."""
 2 |
 3 | / from collections.abc import Mapping, Sequence
 4 | | from datetime import date, datetime
 5 | | from types import SimpleNamespace
 6 | | from typing import Any, cast
 7 | |
 8 | | from flask import Blueprint, Response, render_template, request
 9 | | from flask_login import current_user, login_required
10 | | from sqlalchemy import or_
11 | |
12 | | from app import db
13 | | from app.constants.database_types import DatabaseType
14 | | from app.errors import ConflictError, SystemError, ValidationError
15 | | from app.models.account_permission import AccountPermission
16 | | from app.models.credential import Credential
17 | | from app.models.database_size_stat import DatabaseSizeStat
18 | | from app.models.instance import Instance
19 | | from app.models.instance_database import InstanceDatabase
20 | | from app.services.accounts_sync.account_query_service import get_accounts_by_instance
21 | | from app.services.database_type_service import DatabaseTypeService
22 | | from app.utils.data_validator import DataValidator
23 | | from app.types import QueryProtocol
24 | | from app.utils.decorators import require_csrf, update_required, view_required
25 | | from app.utils.response_utils import jsonify_unified_success
26 | | from app.utils.structlog_config import log_error, log_info
27 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
28 |
29 |   instances_detail_bp = Blueprint("instances_detail", __name__, url_prefix="/instances")
   |
help: Organize imports

PLR0911 Too many return statements (7 > 6)
  --> app/routes/instances/detail.py:37:5
   |
37 | def _parse_is_active_value(data: object, *, default: bool = False) -> bool:
   |     ^^^^^^^^^^^^^^^^^^^^^^
38 |     """从请求数据中解析 is_active,兼容表单/JSON/checkbox.
   |

B009 [*] Do not call `getattr` with a constant attribute value. It is not any safer than normal property access.
  --> app/routes/instances/detail.py:50:18
   |
48 |     value: object | None
49 |     if hasattr(data, "getlist"):
50 |         values = getattr(data, "getlist")("is_active")
   |                  ^^^^^^^^^^^^^^^^^^^^^^^^
51 |         value = values[-1] if values else None  # 取最后一个值(checkbox优先)
52 |     elif isinstance(data, Mapping):
   |
help: Replace `getattr` with attribute access

PLC0415 `import` should be at the top-level of a file
   --> app/routes/instances/detail.py:186:5
    |
184 |     instance = Instance.query.get_or_404(instance_id)
185 |
186 |     from app.models.account_permission import AccountPermission
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
187 |
188 |     account = AccountPermission.query.filter_by(id=account_id, instance_id=instance_id).first_or_404()
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/instances/detail.py:191:9
    |
190 |     try:
191 |         from app.models.account_change_log import AccountChangeLog
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
192 |
193 |         change_logs = (
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/routes/instances/detail.py:206:13
    |
204 |           history = []
205 |           for log in change_logs:
206 | /             history.append(
207 | |                 {
208 | |                     "id": log.id,
209 | |                     "change_type": log.change_type,
210 | |                     "change_time": (time_utils.format_china_time(log.change_time) if log.change_time else "未知"),
211 | |                     "status": log.status,
212 | |                     "message": log.message,
213 | |                     "privilege_diff": log.privilege_diff,
214 | |                     "other_diff": log.other_diff,
215 | |                     "session_id": log.session_id,
216 | |                 },
217 | |             )
    | |_____________^
218 |
219 |           return jsonify_unified_success(
    |
help: Replace for loop with list comprehension

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/instances/detail.py:527:18
    |
525 |     )
526 |
527 |     query = cast(CapacityQuery, base_query)
    |                  ^^^^^^^^^^^^^
528 |
529 |     if database_name:
    |
help: Add quotes

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/routes/instances/detail.py:589:5
    |
589 | def _fetch_latest_database_sizes(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
590 |     instance_id: int,
591 |     database_name: str | None,
    |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/routes/instances/detail.py:690:5
    |
690 | def _fetch_historical_database_sizes(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
691 |     instance_id: int,
692 |     database_name: str | None,
    |

PLC0415 `import` should be at the top-level of a file
  --> app/routes/instances/manage.py:66:5
   |
65 |     # 获取数据库类型配置
66 |     from app.services.database_type_service import DatabaseTypeService
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
67 |
68 |     database_type_configs = DatabaseTypeService.get_active_types()
   |

C901 `list_instances_data` is too complex (13 > 10)
   --> app/routes/instances/manage.py:253:5
    |
251 | @login_required
252 | @view_required
253 | def list_instances_data() -> Response:
    |     ^^^^^^^^^^^^^^^^^^^
254 |     """Grid.js 实例列表 API.
    |

PLR0915 Too many statements (53 > 50)
   --> app/routes/instances/manage.py:253:5
    |
251 | @login_required
252 | @view_required
253 | def list_instances_data() -> Response:
    |     ^^^^^^^^^^^^^^^^^^^
254 |     """Grid.js 实例列表 API.
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/routes/instances/manage.py:402:13
    |
400 |           items = []
401 |           for instance in pagination.items:
402 | /             items.append(
403 | |                 {
404 | |                     "id": instance.id,
405 | |                     "name": instance.name,
406 | |                     "db_type": instance.db_type,
407 | |                     "host": instance.host,
408 | |                     "port": instance.port,
409 | |                     "description": instance.description or "",
410 | |                     "is_active": instance.is_active,
411 | |                     "main_version": instance.main_version,
412 | |                     "active_db_count": active_database_counts.get(instance.id, 0),
413 | |                     "active_account_count": active_account_counts.get(instance.id, 0),
414 | |                     "last_sync_time": (
415 | |                         last_sync_times.get(instance.id).isoformat()
416 | |                         if last_sync_times.get(instance.id)
417 | |                         else None
418 | |                     ),
419 | |                     "tags": tags_map.get(instance.id, []),
420 | |                 },
421 | |             )
    | |_____________^
422 |
423 |           return jsonify_unified_success(
    |
help: Replace for loop with list comprehension

PLC0415 `import` should be at the top-level of a file
   --> app/routes/instances/manage.py:614:5
    |
612 |   def _load_related_blueprints() -> None:
613 |       """确保实例管理相关蓝图被导入注册."""
614 | /     from . import (  # noqa: F401
615 | |         detail,
616 | |         statistics,
617 | |     )
    | |_____^
    |

C901 `get_core_aggregation_metrics` is too complex (40 > 10)
   --> app/routes/partition.py:378:5
    |
376 | @login_required
377 | @view_required
378 | def get_core_aggregation_metrics() -> Response:  # noqa: PLR0912, PLR0915
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
379 |     """获取核心聚合指标数据.
    |

E501 Line too long (129 > 120)
   --> app/routes/partition.py:539:121
    |
537 |             for period_key, metrics in period_metrics.items():
538 |                 if metrics["days_in_period"] > 0:
539 |                     daily_metrics[period_key]["instance_count"] = round(metrics["instance_count"] / metrics["days_in_period"], 1)
    |                                                                                                                         ^^^^^^^^^
540 |                     daily_metrics[period_key]["database_count"] = round(metrics["database_count"] / metrics["days_in_period"], 1)
541 |                     daily_metrics[period_key]["instance_aggregation_count"] = metrics["instance_aggregation_count"]
    |

E501 Line too long (129 > 120)
   --> app/routes/partition.py:540:121
    |
538 |                 if metrics["days_in_period"] > 0:
539 |                     daily_metrics[period_key]["instance_count"] = round(metrics["instance_count"] / metrics["days_in_period"], 1)
540 |                     daily_metrics[period_key]["database_count"] = round(metrics["database_count"] / metrics["days_in_period"], 1)
    |                                                                                                                         ^^^^^^^^^
541 |                     daily_metrics[period_key]["instance_aggregation_count"] = metrics["instance_aggregation_count"]
542 |                     daily_metrics[period_key]["database_aggregation_count"] = metrics["database_aggregation_count"]
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/scheduler.py:3:1
   |
 2 |   """定时任务管理路由."""
 3 | / import threading
 4 | | from datetime import timedelta
 5 | | from typing import cast
 6 | |
 7 | | from apscheduler.job import Job
 8 | | from apscheduler.schedulers.background import BackgroundScheduler
 9 | | from flask import Blueprint, Response, render_template
10 | | from flask_login import current_user, login_required  # type: ignore[import-untyped]  # Flask-Login 未提供类型存根, 后续在 third_party_         …
11 | |
12 | | from app import create_app
13 | | from app.constants.scheduler_jobs import BUILTIN_TASK_IDS
14 | | from app.constants.sync_constants import SyncCategory, SyncOperationType
15 | | from app.errors import NotFoundError, SystemError
16 | | from app.models.unified_log import UnifiedLog
17 | | from app.scheduler import _reload_all_jobs, get_scheduler
18 | | from app.services.sync_session_service import sync_session_service
19 | | from app.utils.decorators import require_csrf, scheduler_manage_required, scheduler_view_required
20 | | from app.utils.response_utils import jsonify_unified_success
21 | | from app.utils.structlog_config import log_error, log_info, log_warning
22 | | from app.utils.time_utils import time_utils
23 | | from app.views.scheduler_forms import SchedulerJobFormView
   | |__________________________________________________________^
24 |
25 |   # 创建蓝图
   |
help: Organize imports

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/routes/scheduler.py:48:22
   |
47 |     """
48 |     scheduler = cast(BackgroundScheduler | None, get_scheduler())
   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
49 |     if scheduler is None or not scheduler.running:
50 |         log_warning("调度器未启动", module="scheduler")
   |
help: Add quotes

PLR2004 Magic value used in comparison, consider replacing `8` with a constant variable
   --> app/routes/scheduler.py:115:52
    |
113 |         return trigger_type, trigger_args
114 |
115 |     if isinstance(fields, list) and len(fields) >= 8:
    |                                                    ^
116 |         trigger_args["second"] = str(fields[7] or "0")
117 |         trigger_args["minute"] = str(fields[6] or "0")
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/scheduler.py:155:12
    |
153 |         if recent_log:
154 |             return recent_log.timestamp.isoformat()
155 |     except Exception as lookup_error:  # pragma: no cover - 记录告警
    |            ^^^^^^^^^
156 |         log_warning(
157 |             "获取任务上次运行时间失败",
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/routes/scheduler.py:195:21
    |
193 |     scheduler = _ensure_scheduler_running()
194 |     try:
195 |         jobs = cast(list[SchedulerJob], scheduler.get_jobs())
    |                     ^^^^^^^^^^^^^^^^^^
196 |         jobs_data = [_build_job_payload(job, scheduler) for job in jobs]
197 |         jobs_data.sort(key=lambda item: item["id"])
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/scheduler.py:332:12
    |
330 |     try:
331 |         user_is_authenticated = current_user.is_authenticated  # type: ignore[attr-defined]  # current_user 由 Flask-Login 动态注入,     …
332 |     except Exception:  # pragma: no cover - 防御性捕获
    |            ^^^^^^^^^
333 |         user_is_authenticated = False
334 |     if user_is_authenticated:
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/scheduler.py:356:16
    |
354 |                 job_name=job.name,
355 |             )
356 |         except Exception as func_error:  # pragma: no cover - 防御性日志
    |                ^^^^^^^^^
357 |             log_error(
358 |                 "任务函数执行失败",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/scheduler.py:404:20
    |
402 |             try:
403 |                 scheduler.remove_job(job_id)
404 |             except Exception as del_err:
    |                    ^^^^^^^^^
405 |                 log_error(
406 |                     "重新加载-删除任务失败",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/tags/manage.py:201:12
    |
199 |         return redirect(url_for("tags.index"))
200 |
201 |     except Exception as e:
    |            ^^^^^^^^^
202 |         db.session.rollback()
203 |         log_error(
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/routes/tags/manage.py:264:16
    |
262 |             _delete_tag_record(tag, operator_id=operator_id)
263 |             results.append({"tag_id": tag_id, "status": "deleted"})
264 |         except Exception as exc:
    |                ^^^^^^^^^
265 |             db.session.rollback()
266 |             has_failure = True
    |

BLE001 Do not catch blind exception: `Exception`
  --> app/routes/users.py:60:12
   |
58 |         )
59 |
60 |     except Exception as e:
   |            ^^^^^^^^^
61 |         log_error(
62 |             "加载用户管理页面失败",
   |

UP035 [*] Import from `collections.abc` instead: `Callable`
  --> app/scheduler.py:9:1
   |
 7 | import os
 8 | from pathlib import Path
 9 | from typing import IO, Callable
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |
11 | try:
   |
help: Import from `collections.abc`

BLE001 Do not catch blind exception: `Exception`
   --> app/scheduler.py:274:16
    |
272 |         try:  # pragma: no cover - 防御性释放
273 |             _LOCK_STATE.handle.close()
274 |         except Exception as close_error:
    |                ^^^^^^^^^
275 |             logger.warning("继承的调度器锁句柄关闭失败", error=str(close_error))
276 |         _LOCK_STATE.handle = None
    |

TRY300 Consider moving this statement to an `else` block
   --> app/scheduler.py:292:9
    |
290 |         _LOCK_STATE.pid = current_pid
291 |         logger.info("调度器锁已获取,当前进程负责运行定时任务", pid=os.getpid())
292 |         return True
    |         ^^^^^^^^^^^
293 |     except BlockingIOError:
294 |         handle.close()
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/scheduler.py:314:12
    |
312 |     try:  # pragma: no cover
313 |         fcntl.flock(_LOCK_STATE.handle, fcntl.LOCK_UN)
314 |     except Exception as unlock_error:
    |            ^^^^^^^^^
315 |         logger.warning("释放调度器文件锁失败", error=str(unlock_error))
316 |     try:  # pragma: no cover
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/scheduler.py:318:12
    |
316 |     try:  # pragma: no cover
317 |         _LOCK_STATE.handle.close()
318 |     except Exception as close_error:
    |            ^^^^^^^^^
319 |         logger.warning("关闭调度器锁文件失败", error=str(close_error))
320 |     finally:
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:394:9
    |
393 |         # 等待调度器完全启动
394 |         import time
    |         ^^^^^^^^^^^
395 |         time.sleep(2)
    |

TRY300 Consider moving this statement to an `else` block
   --> app/scheduler.py:404:9
    |
403 |         logger.info("调度器初始化完成")
404 |         return scheduler
    |         ^^^^^^^^^^^^^^^^
405 |     except Exception:
406 |         logger.exception("调度器初始化失败")
    |

C901 `_load_tasks_from_config` is too complex (22 > 10)
   --> app/scheduler.py:482:5
    |
482 | def _load_tasks_from_config(*, force: bool = False) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
483 |     """从配置文件加载默认任务并注册.
    |

PLR0912 Too many branches (23 > 12)
   --> app/scheduler.py:482:5
    |
482 | def _load_tasks_from_config(*, force: bool = False) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
483 |     """从配置文件加载默认任务并注册.
    |

PLR0915 Too many statements (75 > 50)
   --> app/scheduler.py:482:5
    |
482 | def _load_tasks_from_config(*, force: bool = False) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
483 |     """从配置文件加载默认任务并注册.
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:492:5
    |
491 |     """
492 |     import yaml
    |     ^^^^^^^^^^^
493 |
494 |     from app.tasks.accounts_sync_tasks import sync_accounts
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:494:5
    |
492 |     import yaml
493 |
494 |     from app.tasks.accounts_sync_tasks import sync_accounts
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
495 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
496 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:495:5
    |
494 |     from app.tasks.accounts_sync_tasks import sync_accounts
495 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
496 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
497 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:496:5
    |
494 |     from app.tasks.accounts_sync_tasks import sync_accounts
495 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
496 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
497 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
498 |     from app.tasks.partition_management_tasks import monitor_partition_health
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:497:5
    |
495 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
496 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
497 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
498 |     from app.tasks.partition_management_tasks import monitor_partition_health
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:498:5
    |
496 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
497 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
498 |     from app.tasks.partition_management_tasks import monitor_partition_health
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
499 |
500 |     # 如果不是强制模式,检查是否已有任务
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/scheduler.py:564:28
    |
562 |                             task_id=task_id,
563 |                         )
564 |                     except Exception as remove_error:
    |                            ^^^^^^^^^
565 |                         logger.warning(
566 |                             "强制模式-删除现有任务失败",
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:574:21
    |
572 |                 # 对于cron触发器,确保使用正确的时区
573 |                 if trigger_type == "cron":
574 |                     from apscheduler.triggers.cron import CronTrigger
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
575 |                     # 只传递实际配置的字段,避免APScheduler自动填充默认值
576 |                     cron_kwargs = {}
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/account_classification/auto_classify_service.py:3:1
   |
 1 |   """账户自动分类服务,将路由层与编排器解耦."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from dataclasses import dataclass, field
 6 | | from typing import Mapping, Sequence
 7 | |
 8 | | from app.types import ClassificationEngineResult, JsonDict, JsonValue
 9 | | from app.services.account_classification.orchestrator import AccountClassificationService
10 | | from app.utils.structlog_config import log_error, log_info
   | |__________________________________________________________^
   |
help: Organize imports

UP035 [*] Import from `collections.abc` instead: `Mapping`, `Sequence`
 --> app/services/account_classification/auto_classify_service.py:6:1
  |
5 | from dataclasses import dataclass, field
6 | from typing import Mapping, Sequence
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |
8 | from app.types import ClassificationEngineResult, JsonDict, JsonValue
  |
help: Import from `collections.abc`

F401 [*] `typing.Mapping` imported but unused
 --> app/services/account_classification/auto_classify_service.py:6:20
  |
5 | from dataclasses import dataclass, field
6 | from typing import Mapping, Sequence
  |                    ^^^^^^^
7 |
8 | from app.types import ClassificationEngineResult, JsonDict, JsonValue
  |
help: Remove unused import

F401 [*] `typing.Sequence` imported but unused
 --> app/services/account_classification/auto_classify_service.py:6:29
  |
5 | from dataclasses import dataclass, field
6 | from typing import Mapping, Sequence
  |                             ^^^^^^^^
7 |
8 | from app.types import ClassificationEngineResult, JsonDict, JsonValue
  |
help: Remove unused import

TC001 Move application import `app.types.ClassificationEngineResult` into a type-checking block
  --> app/services/account_classification/auto_classify_service.py:8:23
   |
 6 | from typing import Mapping, Sequence
 7 |
 8 | from app.types import ClassificationEngineResult, JsonDict, JsonValue
   |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^
 9 | from app.services.account_classification.orchestrator import AccountClassificationService
10 | from app.utils.structlog_config import log_error, log_info
   |
help: Move into type-checking block

TC001 Move application import `app.types.JsonDict` into a type-checking block
  --> app/services/account_classification/auto_classify_service.py:8:51
   |
 6 | from typing import Mapping, Sequence
 7 |
 8 | from app.types import ClassificationEngineResult, JsonDict, JsonValue
   |                                                   ^^^^^^^^
 9 | from app.services.account_classification.orchestrator import AccountClassificationService
10 | from app.utils.structlog_config import log_error, log_info
   |
help: Move into type-checking block

F401 [*] `app.types.JsonValue` imported but unused
  --> app/services/account_classification/auto_classify_service.py:8:61
   |
 6 | from typing import Mapping, Sequence
 7 |
 8 | from app.types import ClassificationEngineResult, JsonDict, JsonValue
   |                                                             ^^^^^^^^^
 9 | from app.services.account_classification.orchestrator import AccountClassificationService
10 | from app.utils.structlog_config import log_error, log_info
   |
help: Remove unused import: `app.types.JsonValue`

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> app/services/account_classification/cache.py:5:1
  |
3 | from __future__ import annotations
4 |
5 | from typing import TYPE_CHECKING, Mapping
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
6 |
7 | from app.services.cache_service import CacheService, cache_manager
  |
help: Import from `collections.abc`

TC001 Move application import `app.types.JsonDict` into a type-checking block
 --> app/services/account_classification/cache.py:8:23
  |
7 | from app.services.cache_service import CacheService, cache_manager
8 | from app.types import JsonDict, JsonValue
  |                       ^^^^^^^^
9 | from app.utils.structlog_config import log_error
  |
help: Move into type-checking block

TC001 Move application import `app.types.JsonValue` into a type-checking block
 --> app/services/account_classification/cache.py:8:33
  |
7 | from app.services.cache_service import CacheService, cache_manager
8 | from app.types import JsonDict, JsonValue
  |                                 ^^^^^^^^^
9 | from app.utils.structlog_config import log_error
  |
help: Move into type-checking block

UP037 [*] Remove quotes from type annotation
  --> app/services/account_classification/classifiers/base.py:35:69
   |
34 |     @abstractmethod
35 |     def evaluate(self, account: AccountPermission, rule_expression: "RuleExpression") -> bool:
   |                                                                     ^^^^^^^^^^^^^^^^
36 |         """评估账户是否满足规则表达式.
   |
help: Remove quotes

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/account_classification/classifiers/mysql_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
9 | from typing import Any, cast
  |
help: Remove unused import

F401 [*] `collections.abc.Sequence` imported but unused
 --> app/services/account_classification/classifiers/mysql_classifier.py:8:38
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                                      ^^^^^^^^
9 | from typing import Any, cast
  |
help: Remove unused import

F401 [*] `typing.Any` imported but unused
  --> app/services/account_classification/classifiers/mysql_classifier.py:9:20
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import Any, cast
   |                    ^^^
10 |
11 | from app.models.account_permission import AccountPermission
   |
help: Remove unused import

F401 [*] `typing.cast` imported but unused
  --> app/services/account_classification/classifiers/mysql_classifier.py:9:25
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import Any, cast
   |                         ^^^^
10 |
11 | from app.models.account_permission import AccountPermission
   |
help: Remove unused import

TC001 Move application import `app.models.account_permission.AccountPermission` into a type-checking block
  --> app/services/account_classification/classifiers/mysql_classifier.py:11:43
   |
 9 | from typing import Any, cast
10 |
11 | from app.models.account_permission import AccountPermission
   |                                           ^^^^^^^^^^^^^^^^^
12 | from app.types import RuleExpression
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

TC001 Move application import `app.types.RuleExpression` into a type-checking block
  --> app/services/account_classification/classifiers/mysql_classifier.py:12:23
   |
11 | from app.models.account_permission import AccountPermission
12 | from app.types import RuleExpression
   |                       ^^^^^^^^^^^^^^
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

C901 `evaluate` is too complex (41 > 10)
  --> app/services/account_classification/classifiers/mysql_classifier.py:41:9
   |
39 |     db_type = "mysql"
40 |
41 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
42 |         """评估账户是否满足 MySQL 规则表达式.
   |

PLR0911 Too many return statements (10 > 6)
  --> app/services/account_classification/classifiers/mysql_classifier.py:41:9
   |
39 |     db_type = "mysql"
40 |
41 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
42 |         """评估账户是否满足 MySQL 规则表达式.
   |

PLR0912 Too many branches (43 > 12)
  --> app/services/account_classification/classifiers/mysql_classifier.py:41:9
   |
39 |     db_type = "mysql"
40 |
41 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
42 |         """评估账户是否满足 MySQL 规则表达式.
   |

PLR0915 Too many statements (85 > 50)
  --> app/services/account_classification/classifiers/mysql_classifier.py:41:9
   |
39 |     db_type = "mysql"
40 |
41 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
42 |         """评估账户是否满足 MySQL 规则表达式.
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/account_classification/classifiers/mysql_classifier.py:173:13
    |
171 |                     return False
172 |
173 |             return True
    |             ^^^^^^^^^^^
174 |         except Exception as exc:
175 |             log_error("评估MySQL规则失败", module="account_classification", error=str(exc))
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/classifiers/mysql_classifier.py:174:16
    |
173 |             return True
174 |         except Exception as exc:
    |                ^^^^^^^^^
175 |             log_error("评估MySQL规则失败", module="account_classification", error=str(exc))
176 |             return False
    |

TC001 Move application import `app.models.account_permission.AccountPermission` into a type-checking block
  --> app/services/account_classification/classifiers/oracle_classifier.py:11:43
   |
 9 | from typing import Any, cast
10 |
11 | from app.models.account_permission import AccountPermission
   |                                           ^^^^^^^^^^^^^^^^^
12 | from app.types import RuleExpression
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

TC001 Move application import `app.types.RuleExpression` into a type-checking block
  --> app/services/account_classification/classifiers/oracle_classifier.py:12:23
   |
11 | from app.models.account_permission import AccountPermission
12 | from app.types import RuleExpression
   |                       ^^^^^^^^^^^^^^
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

C901 `evaluate` is too complex (15 > 10)
  --> app/services/account_classification/classifiers/oracle_classifier.py:39:9
   |
37 |     db_type = "oracle"
38 |
39 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
40 |         """评估账户是否满足 Oracle 规则表达式.
   |

PLR0912 Too many branches (14 > 12)
  --> app/services/account_classification/classifiers/oracle_classifier.py:39:9
   |
37 |     db_type = "oracle"
38 |
39 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
40 |         """评估账户是否满足 Oracle 规则表达式.
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/oracle_classifier.py:70:35
   |
68 |             match_results: list[bool] = []
69 |
70 |             required_roles = cast(Sequence[str] | None, rule_expression.get("roles")) or []
   |                                   ^^^^^^^^^^^^^^^^^^^^
71 |             if required_roles:
72 |                 actual_roles = (
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/oracle_classifier.py:82:42
   |
80 |                 match_results.append(all(role in role_names for role in required_roles))
81 |
82 |             required_system_privs = cast(Sequence[str] | None, rule_expression.get("system_privileges")) or []
   |                                          ^^^^^^^^^^^^^^^^^^^^
83 |             if required_system_privs:
84 |                 system_privileges = (
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/account_classification/classifiers/oracle_classifier.py:98:42
    |
 96 |                 )
 97 |
 98 |             required_object_privs = cast(Sequence[Mapping[str, str]] | None, rule_expression.get("object_privileges")) or []
    |                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 99 |             if required_object_privs:
100 |                 object_privileges = permissions.get("object_privileges", [])
    |
help: Add quotes

E501 Line too long (124 > 120)
   --> app/services/account_classification/classifiers/oracle_classifier.py:98:121
    |
 96 |                 )
 97 |
 98 |             required_object_privs = cast(Sequence[Mapping[str, str]] | None, rule_expression.get("object_privileges")) or []
    |                                                                                                                         ^^^^
 99 |             if required_object_privs:
100 |                 object_privileges = permissions.get("object_privileges", [])
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/account_classification/classifiers/oracle_classifier.py:117:40
    |
115 |                 match_results.append(object_match)
116 |
117 |             required_tablespace = cast(Sequence[Mapping[str, str]] | None, rule_expression.get("tablespace_privileges")) or []
    |                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
118 |             if required_tablespace:
119 |                 tablespace_privileges = self._normalize_tablespace_privileges(
    |
help: Add quotes

E501 Line too long (126 > 120)
   --> app/services/account_classification/classifiers/oracle_classifier.py:117:121
    |
115 |                 match_results.append(object_match)
116 |
117 |             required_tablespace = cast(Sequence[Mapping[str, str]] | None, rule_expression.get("tablespace_privileges")) or []
    |                                                                                                                         ^^^^^^
118 |             if required_tablespace:
119 |                 tablespace_privileges = self._normalize_tablespace_privileges(
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/classifiers/oracle_classifier.py:141:16
    |
140 |             return self._combine_results(match_results, operator)
141 |         except Exception as exc:
    |                ^^^^^^^^^
142 |             log_error("评估Oracle规则失败", module="account_classification", error=str(exc))
143 |             return False
    |

PERF401 Use `list.extend` to create a transformed list
   --> app/services/account_classification/classifiers/oracle_classifier.py:179:21
    |
177 |                   perms = privileges if isinstance(privileges, list) else [privileges]
178 |                   for privilege in perms:
179 | /                     normalized.append(
180 | |                         {
181 | |                             "tablespace_name": tablespace_name,
182 | |                             "privilege": privilege,
183 | |                         },
184 | |                     )
    | |_____________________^
185 |           elif isinstance(source, list):
186 |               normalized = [item for item in source if isinstance(item, dict)]
    |
help: Replace for loop with list.extend

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/account_classification/classifiers/postgresql_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
9 | from typing import Any, cast
  |
help: Remove unused import: `collections.abc.Mapping`

F401 [*] `typing.Any` imported but unused
  --> app/services/account_classification/classifiers/postgresql_classifier.py:9:20
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import Any, cast
   |                    ^^^
10 |
11 | from app.models.account_permission import AccountPermission
   |
help: Remove unused import: `typing.Any`

TC001 Move application import `app.models.account_permission.AccountPermission` into a type-checking block
  --> app/services/account_classification/classifiers/postgresql_classifier.py:11:43
   |
 9 | from typing import Any, cast
10 |
11 | from app.models.account_permission import AccountPermission
   |                                           ^^^^^^^^^^^^^^^^^
12 | from app.types import RuleExpression
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

TC001 Move application import `app.types.RuleExpression` into a type-checking block
  --> app/services/account_classification/classifiers/postgresql_classifier.py:12:23
   |
11 | from app.models.account_permission import AccountPermission
12 | from app.types import RuleExpression
   |                       ^^^^^^^^^^^^^^
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

C901 `evaluate` is too complex (11 > 10)
  --> app/services/account_classification/classifiers/postgresql_classifier.py:40:9
   |
38 |     db_type = "postgresql"
39 |
40 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
41 |         """评估账户是否满足 PostgreSQL 规则表达式.
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/postgresql_classifier.py:72:46
   |
70 |             match_results: list[bool] = []
71 |
72 |             required_predefined_roles = cast(Sequence[str] | None, rule_expression.get("predefined_roles")) or []
   |                                              ^^^^^^^^^^^^^^^^^^^^
73 |             if required_predefined_roles:
74 |                 actual_predefined_roles = permissions.get("predefined_roles", [])
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/postgresql_classifier.py:80:40
   |
78 |                 match_results.append(all(role in predefined_roles_set for role in required_predefined_roles))
79 |
80 |             required_role_attrs = cast(Sequence[str] | None, rule_expression.get("role_attributes")) or []
   |                                        ^^^^^^^^^^^^^^^^^^^^
81 |             if required_role_attrs:
82 |                 role_attrs = permissions.get("role_attributes", {})
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/postgresql_classifier.py:85:44
   |
83 |                 match_results.append(all(role_attrs.get(attr, False) for attr in required_role_attrs))
84 |
85 |             required_database_perms = cast(Sequence[str] | None, rule_expression.get("database_privileges")) or []
   |                                            ^^^^^^^^^^^^^^^^^^^^
86 |             if required_database_perms:
87 |                 database_perms = permissions.get("database_privileges", {})
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/postgresql_classifier.py:96:46
   |
94 |                 match_results.append(database_match)
95 |
96 |             required_tablespace_perms = cast(Sequence[str] | None, rule_expression.get("tablespace_privileges")) or []
   |                                              ^^^^^^^^^^^^^^^^^^^^
97 |             if required_tablespace_perms:
98 |                 tablespace_perms = permissions.get("tablespace_privileges", {})
   |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/classifiers/postgresql_classifier.py:108:16
    |
107 |             return self._combine_results(match_results, operator)
108 |         except Exception as exc:
    |                ^^^^^^^^^
109 |             log_error("评估PostgreSQL规则失败", module="account_classification", error=str(exc))
110 |             return False
    |

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/account_classification/classifiers/sqlserver_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
9 | from typing import Any, cast
  |
help: Remove unused import: `collections.abc.Mapping`

F401 [*] `typing.Any` imported but unused
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:9:20
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import Any, cast
   |                    ^^^
10 |
11 | from app.models.account_permission import AccountPermission
   |
help: Remove unused import: `typing.Any`

TC001 Move application import `app.models.account_permission.AccountPermission` into a type-checking block
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:11:43
   |
 9 | from typing import Any, cast
10 |
11 | from app.models.account_permission import AccountPermission
   |                                           ^^^^^^^^^^^^^^^^^
12 | from app.types import RuleExpression
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

TC001 Move application import `app.types.RuleExpression` into a type-checking block
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:12:23
   |
11 | from app.models.account_permission import AccountPermission
12 | from app.types import RuleExpression
   |                       ^^^^^^^^^^^^^^
13 | from app.utils.structlog_config import log_error
   |
help: Move into type-checking block

C901 `evaluate` is too complex (11 > 10)
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:40:9
   |
38 |     db_type = "sqlserver"
39 |
40 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
41 |         """评估账户是否满足 SQL Server 规则表达式.
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:72:42
   |
70 |             match_results: list[bool] = []
71 |
72 |             required_server_roles = cast(Sequence[str] | None, rule_expression.get("server_roles")) or []
   |                                          ^^^^^^^^^^^^^^^^^^^^
73 |             if required_server_roles:
74 |                 actual_server_roles = permissions.get("server_roles", [])
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:80:44
   |
78 |                 match_results.append(all(role in actual_server_role_names for role in required_server_roles))
79 |
80 |             required_database_roles = cast(Sequence[str] | None, rule_expression.get("database_roles")) or []
   |                                            ^^^^^^^^^^^^^^^^^^^^
81 |             if required_database_roles:
82 |                 database_roles = permissions.get("database_roles", {})
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:91:42
   |
89 |                 match_results.append(role_match)
90 |
91 |             required_server_perms = cast(Sequence[str] | None, rule_expression.get("server_permissions")) or []
   |                                          ^^^^^^^^^^^^^^^^^^^^
92 |             if required_server_perms:
93 |                 actual_server_perms = permissions.get("server_permissions", [])
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/account_classification/classifiers/sqlserver_classifier.py:103:44
    |
101 |                 )
102 |
103 |             required_database_perms = cast(Sequence[str] | None, rule_expression.get("database_permissions")) or []
    |                                            ^^^^^^^^^^^^^^^^^^^^
104 |             if required_database_perms:
105 |                 database_permissions = permissions.get("database_permissions", {})
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/classifiers/sqlserver_classifier.py:118:16
    |
117 |             return self._combine_results(match_results, operator)
118 |         except Exception as exc:
    |                ^^^^^^^^^
119 |             log_error("评估SQL Server规则失败", module="account_classification", error=str(exc))
120 |             return False
    |

TRY300 Consider moving this statement to an `else` block
  --> app/services/account_classification/orchestrator.py:95:13
   |
93 |             )
94 |
95 |             return {"success": True, "message": "自动分类完成", **result}
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
96 |         except Exception as exc:
97 |             log_error("优化后的自动分类失败", module="account_classification", error=str(exc))
   |

BLE001 Do not catch blind exception: `Exception`
  --> app/services/account_classification/orchestrator.py:96:16
   |
95 |             return {"success": True, "message": "自动分类完成", **result}
96 |         except Exception as exc:
   |                ^^^^^^^^^
97 |             log_error("优化后的自动分类失败", module="account_classification", error=str(exc))
98 |             return {"success": False, "error": f"自动分类失败: {exc}"}
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/orchestrator.py:109:16
    |
107 |         try:
108 |             return self.cache.invalidate_all()
109 |         except Exception as exc:
    |                ^^^^^^^^^
110 |             log_error("清除分类缓存失败", module="account_classification", error=str(exc))
111 |             return False
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/orchestrator.py:125:16
    |
123 |         try:
124 |             return self.cache.invalidate_db_type(db_type)
125 |         except Exception as exc:
    |                ^^^^^^^^^
126 |             log_error("清除数据库类型缓存失败", module="account_classification", db_type=db_type, error=str(exc))
127 |             return False
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/orchestrator.py:259:20
    |
257 |                 all_errors.extend(result["errors"])
258 |                 db_type_results[db_type] = result
259 |             except Exception as exc:
    |                    ^^^^^^^^^
260 |                 error_msg = f"数据库类型 {db_type} 分类失败: {exc}"
261 |                 log_error(error_msg, module="account_classification")
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/orchestrator.py:324:20
    |
322 |                     matched_accounts=len(matched_accounts),
323 |                 )
324 |             except Exception as exc:
    |                    ^^^^^^^^^
325 |                 error_msg = f"规则 {rule.rule_name} 处理失败: {exc}"
326 |                 log_error(error_msg, module="account_classification", rule_id=rule.id, db_type=db_type)
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/services/account_classification/orchestrator.py:363:17
    |
361 |         for account in filtered_accounts:
362 |             if self._evaluate_rule(account, rule):
363 |                 matched_accounts.append(account)
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
364 |         return matched_accounts
    |
help: Replace for loop with list comprehension

TRY300 Consider moving this statement to an `else` block
  --> app/services/account_classification/repositories.py:89:13
   |
87 |                 )
88 |             db.session.commit()
89 |             return deleted
   |             ^^^^^^^^^^^^^^
90 |         except Exception as exc:
91 |             db.session.rollback()
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/repositories.py:160:16
    |
159 |             return len(new_assignments)
160 |         except Exception as exc:
    |                ^^^^^^^^^
161 |             log_error(
162 |                 "批量写入分类分配失败",
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/services/account_classification/repositories.py:184:13
    |
182 |           payload: list[dict] = []
183 |           for rule in rules:
184 | /             payload.append(
185 | |                 {
186 | |                     "id": rule.id,
187 | |                     "classification_id": rule.classification_id,
188 | |                     "db_type": rule.db_type,
189 | |                     "rule_name": rule.rule_name,
190 | |                     "rule_expression": rule.rule_expression,
191 | |                     "is_active": rule.is_active,
192 | |                     "created_at": rule.created_at.isoformat() if rule.created_at else None,
193 | |                     "updated_at": rule.updated_at.isoformat() if rule.updated_at else None,
194 | |                 },
195 | |             )
    | |_____________^
196 |           return payload
    |
help: Replace for loop with list comprehension

BLE001 Do not catch blind exception: `Exception`
   --> app/services/account_classification/repositories.py:220:20
    |
218 |                 rule.is_active = data.get("is_active", True)
219 |                 hydrated.append(rule)
220 |             except Exception as exc:
    |                    ^^^^^^^^^
221 |                 log_error("反序列化规则缓存失败", module="account_classification", error=str(exc))
222 |         return hydrated
    |

TRY301 Abstract `raise` to an inner function
  --> app/services/accounts_sync/accounts_sync_filters.py:59:17
   |
57 |                 logger.error("配置文件格式错误,缺少 account_filters 节点")
58 |                 msg = "配置文件格式错误,缺少 account_filters 节点"
59 |                 raise ValueError(msg)
   |                 ^^^^^^^^^^^^^^^^^^^^^
60 |
61 |             raw_rules = config["account_filters"] or {}
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/accounts_sync/accounts_sync_filters.py:62:33
   |
61 |             raw_rules = config["account_filters"] or {}
62 |             filter_rules = cast(DatabaseFilterRules, raw_rules)
   |                                 ^^^^^^^^^^^^^^^^^^^
63 |             logger.info("成功加载账户过滤规则配置文件", config_path=self.config_path_str)
64 |             logger.info(
   |
help: Add quotes

TRY300 Consider moving this statement to an `else` block
  --> app/services/accounts_sync/accounts_sync_filters.py:70:13
   |
68 |             )
69 |
70 |             return filter_rules
   |             ^^^^^^^^^^^^^^^^^^^
71 |
72 |         except yaml.YAMLError as exc:
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/accounts_sync/accounts_sync_filters.py:97:39
   |
95 |         where_clause, params = build_safe_filter_conditions(db_type, username_field, self.filter_rules)
96 |         if isinstance(params, dict):
97 |             return where_clause, cast(dict[str, str], params)
   |                                       ^^^^^^^^^^^^^^
98 |         return where_clause, cast(list[str], params)
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/accounts_sync_filters.py:98:35
    |
 96 |         if isinstance(params, dict):
 97 |             return where_clause, cast(dict[str, str], params)
 98 |         return where_clause, cast(list[str], params)
    |                                   ^^^^^^^^^
 99 |
100 |     def _match_pattern(self, text: str, pattern: str) -> bool:
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/accounts_sync_filters.py:130:56
    |
128 |         """
129 |         if db_type:
130 |             return self.filter_rules.get(db_type, cast(FilterRule, {}))
    |                                                        ^^^^^^^^^^
131 |         return self.filter_rules
    |
help: Add quotes

E501 Line too long (144 > 120)
   --> app/services/accounts_sync/accounts_sync_service.py:102:121
    |
100 | …
101 | …
102 | … SyncOperationType.MANUAL_TASK.value, SyncOperationType.SCHEDULED_TASK.value]:
    |                                                        ^^^^^^^^^^^^^^^^^^^^^^^^
103 | …
104 | …
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/accounts_sync_service.py:246:32
    |
244 |             # 更新实例同步状态
245 |             if result["success"]:
246 |                 details = cast(SyncStagesSummary | None, result.get("details"))
    |                                ^^^^^^^^^^^^^^^^^^^^^^^^
247 |                 inventory = cast(InventorySummary, {})
248 |                 collection = cast(CollectionSummary, {})
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/accounts_sync_service.py:247:34
    |
245 |             if result["success"]:
246 |                 details = cast(SyncStagesSummary | None, result.get("details"))
247 |                 inventory = cast(InventorySummary, {})
    |                                  ^^^^^^^^^^^^^^^^
248 |                 collection = cast(CollectionSummary, {})
249 |                 if isinstance(details, dict):
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/accounts_sync_service.py:248:35
    |
246 |                 details = cast(SyncStagesSummary | None, result.get("details"))
247 |                 inventory = cast(InventorySummary, {})
248 |                 collection = cast(CollectionSummary, {})
    |                                   ^^^^^^^^^^^^^^^^^
249 |                 if isinstance(details, dict):
250 |                     inventory = cast(InventorySummary, details.get("inventory", {}))
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/accounts_sync_service.py:250:38
    |
248 |                 collection = cast(CollectionSummary, {})
249 |                 if isinstance(details, dict):
250 |                     inventory = cast(InventorySummary, details.get("inventory", {}))
    |                                      ^^^^^^^^^^^^^^^^
251 |                     collection = cast(CollectionSummary, details.get("collection", {}))
252 |                 sync_session_service.complete_instance_sync(
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/accounts_sync_service.py:251:39
    |
249 |                 if isinstance(details, dict):
250 |                     inventory = cast(InventorySummary, details.get("inventory", {}))
251 |                     collection = cast(CollectionSummary, details.get("collection", {}))
    |                                       ^^^^^^^^^^^^^^^^^
252 |                 sync_session_service.complete_instance_sync(
253 |                     record.id,
    |
help: Add quotes

UP035 [*] Import from `collections.abc` instead: `Sequence`
 --> app/services/accounts_sync/adapters/base_adapter.py:6:1
  |
5 | from abc import ABC, abstractmethod
6 | from typing import Sequence
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |
8 | from app.models.instance import Instance
  |
help: Import from `collections.abc`

TC001 Move application import `app.models.instance.Instance` into a type-checking block
 --> app/services/accounts_sync/adapters/base_adapter.py:8:33
  |
6 | from typing import Sequence
7 |
8 | from app.models.instance import Instance
  |                                 ^^^^^^^^
9 | from app.types import RawAccount, RemoteAccount
  |
help: Move into type-checking block

TC001 Move application import `app.types.RawAccount` into a type-checking block
 --> app/services/accounts_sync/adapters/base_adapter.py:9:23
  |
8 | from app.models.instance import Instance
9 | from app.types import RawAccount, RemoteAccount
  |                       ^^^^^^^^^^
  |
help: Move into type-checking block

TC001 Move application import `app.types.RemoteAccount` into a type-checking block
 --> app/services/accounts_sync/adapters/base_adapter.py:9:35
  |
8 | from app.models.instance import Instance
9 | from app.types import RawAccount, RemoteAccount
  |                                   ^^^^^^^^^^^^^
  |
help: Move into type-checking block

PERF401 Use a list comprehension to create a transformed list
  --> app/services/accounts_sync/adapters/base_adapter.py:35:13
   |
33 |         normalized: list[RemoteAccount] = []
34 |         for account in raw_accounts:
35 |             normalized.append(self._normalize_account(instance, account))
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
36 |         return normalized
   |
help: Replace for loop with list comprehension

ARG002 Unused method argument: `instance`
  --> app/services/accounts_sync/adapters/base_adapter.py:40:9
   |
38 |     def enrich_permissions(
39 |         self,
40 |         instance: Instance,
   |         ^^^^^^^^
41 |         connection: object,
42 |         accounts: list[RemoteAccount],
   |

ARG002 Unused method argument: `connection`
  --> app/services/accounts_sync/adapters/base_adapter.py:41:9
   |
39 |         self,
40 |         instance: Instance,
41 |         connection: object,
   |         ^^^^^^^^^^
42 |         accounts: list[RemoteAccount],
43 |         *,
   |

ARG002 Unused method argument: `usernames`
  --> app/services/accounts_sync/adapters/base_adapter.py:44:9
   |
42 |         accounts: list[RemoteAccount],
43 |         *,
44 |         usernames: Sequence[str] | None = None,
   |         ^^^^^^^^^
45 |     ) -> list[RemoteAccount]:
46 |         """为账号列表补全权限信息.
   |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/adapters/mysql_adapter.py:6:29
  |
5 | import re
6 | from collections.abc import Sequence
  |                             ^^^^^^^^
7 | from typing import cast
  |
help: Move into type-checking block

TC001 Move application import `app.models.instance.Instance` into a type-checking block
  --> app/services/accounts_sync/adapters/mysql_adapter.py:10:33
   |
 9 | from app.constants import DatabaseType
10 | from app.models.instance import Instance
   |                                 ^^^^^^^^
11 | from app.services.accounts_sync.accounts_sync_filters import DatabaseFilterManager
12 | from app.services.accounts_sync.adapters.base_adapter import BaseAccountAdapter
   |
help: Move into type-checking block

F401 [*] `app.types.JsonValue` imported but unused
  --> app/services/accounts_sync/adapters/mysql_adapter.py:13:33
   |
11 | from app.services.accounts_sync.accounts_sync_filters import DatabaseFilterManager
12 | from app.services.accounts_sync.adapters.base_adapter import BaseAccountAdapter
13 | from app.types import JsonDict, JsonValue, PermissionSnapshot, RawAccount, RemoteAccount
   |                                 ^^^^^^^^^
14 | from app.utils.safe_query_builder import SafeQueryBuilder
15 | from app.utils.structlog_config import get_sync_logger
   |
help: Remove unused import: `app.types.JsonValue`

S608 Possible SQL injection vector through string-based query construction
  --> app/services/accounts_sync/adapters/mysql_adapter.py:81:17
   |
79 |               where_clause, params = self._build_filter_conditions()
80 |               user_sql = (
81 | /                 "SELECT "
82 | |                 "    User as username, "
83 | |                 "    Host as host, "
84 | |                 "    Super_priv as is_superuser, "
85 | |                 "    account_locked as is_locked, "
86 | |                 "    Grant_priv as can_grant, "
87 | |                 "    plugin as plugin, "
88 | |                 "    password_last_changed as password_last_changed "
89 | |                 "FROM mysql.user "
90 | |                 f"WHERE User != '' AND {where_clause} "
91 | |                 "ORDER BY User, Host"
   | |_____________________________________^
92 |               )
93 |               users = connection.execute_query(user_sql, params)
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/mysql_adapter.py:193:30
    |
191 |         filter_rules = self.filter_manager.get_filter_rules("mysql")
192 |         builder = SafeQueryBuilder(db_type="mysql")
193 |         exclude_users = cast(list[str], filter_rules.get("exclude_users", []))
    |                              ^^^^^^^^^
194 |         exclude_patterns = cast(list[str], filter_rules.get("exclude_patterns", []))
195 |         builder.add_database_specific_condition("User", exclude_users, exclude_patterns)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/mysql_adapter.py:194:33
    |
192 |         builder = SafeQueryBuilder(db_type="mysql")
193 |         exclude_users = cast(list[str], filter_rules.get("exclude_users", []))
194 |         exclude_patterns = cast(list[str], filter_rules.get("exclude_patterns", []))
    |                                 ^^^^^^^^^
195 |         builder.add_database_specific_condition("User", exclude_users, exclude_patterns)
196 |         return builder.build_where_clause()
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/mysql_adapter.py:307:42
    |
305 |             if not username or username not in target_usernames:
306 |                 continue
307 |             permissions_container = cast(PermissionSnapshot, account.get("permissions") or {})
    |                                          ^^^^^^^^^^^^^^^^^^
308 |             existing_type_specific = cast(JsonDict, permissions_container.get("type_specific") or {})
309 |             original_username = existing_type_specific.get("original_username") or account.get("original_username")
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/mysql_adapter.py:308:43
    |
306 |                 continue
307 |             permissions_container = cast(PermissionSnapshot, account.get("permissions") or {})
308 |             existing_type_specific = cast(JsonDict, permissions_container.get("type_specific") or {})
    |                                           ^^^^^^^^
309 |             original_username = existing_type_specific.get("original_username") or account.get("original_username")
310 |             host = existing_type_specific.get("host") if "host" in existing_type_specific else account.get("host")
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/mysql_adapter.py:321:38
    |
319 |             try:
320 |                 permissions = self._get_user_permissions(connection, original_username, host)
321 |                 type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
    |                                      ^^^^^^^^
322 |                 for key, value in existing_type_specific.items():
323 |                     if value is not None:
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/services/accounts_sync/adapters/mysql_adapter.py:401:16
    |
399 |                     existing.append("GRANT OPTION")
400 |                 return
401 |         except Exception as exc:
    |                ^^^^^^^^^
402 |             self.logger.warning(
403 |                 "mysql_parse_grant_failed",
    |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/adapters/oracle_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import cast
  |
help: Move into type-checking block

TC001 Move application import `app.models.instance.Instance` into a type-checking block
  --> app/services/accounts_sync/adapters/oracle_adapter.py:9:33
   |
 8 | from app.constants import DatabaseType
 9 | from app.models.instance import Instance
   |                                 ^^^^^^^^
10 | from app.services.accounts_sync.accounts_sync_filters import DatabaseFilterManager
11 | from app.services.accounts_sync.adapters.base_adapter import BaseAccountAdapter
   |
help: Move into type-checking block

TRY300 Consider moving this statement to an `else` block
  --> app/services/accounts_sync/adapters/oracle_adapter.py:77:13
   |
75 |                 account_count=len(accounts),
76 |             )
77 |             return accounts
   |             ^^^^^^^^^^^^^^^
78 |         except Exception as exc:
79 |             self.logger.exception(
   |

ARG002 Unused method argument: `instance`
  --> app/services/accounts_sync/adapters/oracle_adapter.py:87:34
   |
85 |             return []
86 |
87 |     def _normalize_account(self, instance: Instance, account: RawAccount) -> RemoteAccount:
   |                                  ^^^^^^^^
88 |         """规范化 Oracle 账户信息.
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/oracle_adapter.py:100:28
    |
 99 |         """
100 |         permissions = cast(PermissionSnapshot, account.get("permissions") or {})
    |                            ^^^^^^^^^^^^^^^^^^
101 |         type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
102 |         account_status = type_specific.get("account_status")
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/oracle_adapter.py:101:30
    |
 99 |         """
100 |         permissions = cast(PermissionSnapshot, account.get("permissions") or {})
101 |         type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
    |                              ^^^^^^^^
102 |         account_status = type_specific.get("account_status")
103 |         is_locked = bool(account.get("is_locked", False))
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/oracle_adapter.py:133:30
    |
131 |         """
132 |         filter_rules = self.filter_manager.get_filter_rules("oracle")
133 |         exclude_users = cast(list[str], filter_rules.get("exclude_users", []))
    |                              ^^^^^^^^^
134 |         placeholders = ",".join([f":{i}" for i in range(1, len(exclude_users) + 1)]) or "''"
    |
help: Add quotes

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/oracle_adapter.py:137:13
    |
136 |           sql = (
137 | /             "SELECT username, account_status, default_tablespace "
138 | |             "FROM dba_users "
139 | |             f"WHERE username NOT IN ({placeholders})"
    | |_____________________________________________________^
140 |           )
141 |           params = {f":{i+1}": user for i, user in enumerate(exclude_users)}
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/services/accounts_sync/adapters/oracle_adapter.py:145:13
    |
143 |           results: list[RawAccount] = []
144 |           for row in rows:
145 | /             results.append(
146 | |                 {
147 | |                     "username": row[0],
148 | |                     "account_status": row[1],
149 | |                     "default_tablespace": row[2],
150 | |                     "is_dba": row[0] == "SYS",
151 | |                 },
152 | |             )
    | |_____________^
153 |           return results
    |
help: Replace for loop with list comprehension

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/oracle_adapter.py:207:38
    |
205 |             try:
206 |                 permissions = self._get_user_permissions(connection, username)
207 |                 type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
    |                                      ^^^^^^^^
208 |                 account["permissions"] = permissions
209 |                 account_status = type_specific.get("account_status")
    |
help: Add quotes

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/adapters/postgresql_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import cast
  |
help: Move into type-checking block

TC001 Move application import `app.models.instance.Instance` into a type-checking block
  --> app/services/accounts_sync/adapters/postgresql_adapter.py:9:33
   |
 8 | from app.constants import DatabaseType
 9 | from app.models.instance import Instance
   |                                 ^^^^^^^^
10 | from app.services.accounts_sync.accounts_sync_filters import DatabaseFilterManager
11 | from app.services.accounts_sync.adapters.base_adapter import BaseAccountAdapter
   |
help: Move into type-checking block

S608 Possible SQL injection vector through string-based query construction
  --> app/services/accounts_sync/adapters/postgresql_adapter.py:55:17
   |
53 |               where_clause, params = self._build_filter_conditions()
54 |               roles_sql = (
55 | /                 "SELECT "
56 | |                 "    rolname as username, "
57 | |                 "    rolsuper as is_superuser, "
58 | |                 "    rolcreaterole as can_create_role, "
59 | |                 "    rolcreatedb as can_create_db, "
60 | |                 "    rolreplication as can_replicate, "
61 | |                 "    rolbypassrls as can_bypass_rls, "
62 | |                 "    rolcanlogin as can_login, "
63 | |                 "    rolinherit as can_inherit, "
64 | |                 "    CASE "
65 | |                 "        WHEN rolvaliduntil = 'infinity'::timestamp THEN NULL "
66 | |                 "        WHEN rolvaliduntil = '-infinity'::timestamp THEN NULL "
67 | |                 "        ELSE rolvaliduntil "
68 | |                 "    END as valid_until "
69 | |                 "FROM pg_roles "
70 | |                 f"WHERE {where_clause} "
71 | |                 "ORDER BY rolname"
   | |__________________________________^
72 |               )
73 |               rows = connection.execute_query(roles_sql, params)
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:123:13
    |
121 |                 account_count=len(accounts),
122 |             )
123 |             return accounts
    |             ^^^^^^^^^^^^^^^
124 |         except Exception as exc:
125 |             self.logger.exception(
    |

ARG002 Unused method argument: `instance`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:133:34
    |
131 |             return []
132 |
133 |     def _normalize_account(self, instance: Instance, account: RawAccount) -> RemoteAccount:
    |                                  ^^^^^^^^
134 |         """规范化 PostgreSQL 账户信息.
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:146:28
    |
145 |         """
146 |         permissions = cast(PermissionSnapshot, account.get("permissions") or {})
    |                            ^^^^^^^^^^^^^^^^^^
147 |         type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
148 |         permissions.setdefault("role_attributes", {})
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:147:30
    |
145 |         """
146 |         permissions = cast(PermissionSnapshot, account.get("permissions") or {})
147 |         type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
    |                              ^^^^^^^^
148 |         permissions.setdefault("role_attributes", {})
149 |         if "can_login" not in type_specific and account.get("can_login") is not None:
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:181:30
    |
179 |         rules = self.filter_manager.get_filter_rules("postgresql")
180 |         builder = SafeQueryBuilder(db_type="postgresql")
181 |         exclude_users = cast(list[str], rules.get("exclude_users", []))
    |                              ^^^^^^^^^
182 |         exclude_patterns = cast(list[str], rules.get("exclude_patterns", []))
183 |         builder.add_database_specific_condition("rolname", exclude_users, exclude_patterns)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:182:33
    |
180 |         builder = SafeQueryBuilder(db_type="postgresql")
181 |         exclude_users = cast(list[str], rules.get("exclude_users", []))
182 |         exclude_patterns = cast(list[str], rules.get("exclude_patterns", []))
    |                                 ^^^^^^^^^
183 |         builder.add_database_specific_condition("rolname", exclude_users, exclude_patterns)
184 |         return builder.build_where_clause()
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:214:16
    |
212 |         try:
213 |             permissions["role_attributes"] = self._get_role_attributes(connection, username)
214 |         except Exception as exc:
    |                ^^^^^^^^^
215 |             self.logger.warning(
216 |                 "fetch_pg_role_attributes_failed",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:223:16
    |
221 |         try:
222 |             permissions["predefined_roles"] = self._get_predefined_roles(connection, username)
223 |         except Exception as exc:
    |                ^^^^^^^^^
224 |             self.logger.warning(
225 |                 "fetch_pg_predefined_roles_failed",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:232:16
    |
230 |         try:
231 |             permissions["database_privileges_pg"] = self._get_database_privileges(connection, username)
232 |         except Exception as exc:
    |                ^^^^^^^^^
233 |             self.logger.warning(
234 |                 "fetch_pg_database_privileges_failed",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:241:16
    |
239 |         try:
240 |             permissions["tablespace_privileges"] = self._get_tablespace_privileges(connection, username)
241 |         except Exception as exc:
    |                ^^^^^^^^^
242 |             self.logger.warning(
243 |                 "fetch_pg_tablespace_privileges_failed",
    |

C901 `enrich_permissions` is too complex (13 > 10)
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:252:9
    |
250 |         return permissions
251 |
252 |     def enrich_permissions(
    |         ^^^^^^^^^^^^^^^^^^
253 |         self,
254 |         instance: Instance,
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:285:45
    |
283 |             processed += 1
284 |             try:
285 |                 existing_permissions = cast(PermissionSnapshot, account.get("permissions") or {})
    |                                             ^^^^^^^^^^^^^^^^^^
286 |                 seed_type_specific = cast(JsonDict, existing_permissions.get("type_specific") or {})
287 |                 seed_role_attributes = cast(JsonDict, existing_permissions.get("role_attributes") or {})
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:286:43
    |
284 |             try:
285 |                 existing_permissions = cast(PermissionSnapshot, account.get("permissions") or {})
286 |                 seed_type_specific = cast(JsonDict, existing_permissions.get("type_specific") or {})
    |                                           ^^^^^^^^
287 |                 seed_role_attributes = cast(JsonDict, existing_permissions.get("role_attributes") or {})
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:287:45
    |
285 |                 existing_permissions = cast(PermissionSnapshot, account.get("permissions") or {})
286 |                 seed_type_specific = cast(JsonDict, existing_permissions.get("type_specific") or {})
287 |                 seed_role_attributes = cast(JsonDict, existing_permissions.get("role_attributes") or {})
    |                                             ^^^^^^^^
288 |
289 |                 permissions = self._get_role_permissions(
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:294:38
    |
292 |                     is_superuser=bool(account.get("is_superuser")),
293 |                 )
294 |                 type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
    |                                      ^^^^^^^^
295 |                 for key, value in seed_type_specific.items():
296 |                     if value is not None:
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:298:40
    |
296 |                     if value is not None:
297 |                         type_specific.setdefault(key, value)
298 |                 role_attributes = cast(JsonDict, permissions.setdefault("role_attributes", {}))
    |                                        ^^^^^^^^
299 |                 for key, value in seed_role_attributes.items():
300 |                     if value is not None:
    |
help: Add quotes

TC001 Move application import `app.models.instance.Instance` into a type-checking block
  --> app/services/accounts_sync/adapters/sqlserver_adapter.py:12:33
   |
11 | from app.constants import DatabaseType
12 | from app.models.instance import Instance
   |                                 ^^^^^^^^
13 | from app.services.accounts_sync.accounts_sync_filters import DatabaseFilterManager
14 | from app.services.accounts_sync.adapters.base_adapter import BaseAccountAdapter
   |
help: Move into type-checking block

TRY300 Consider moving this statement to an `else` block
  --> app/services/accounts_sync/adapters/sqlserver_adapter.py:80:13
   |
78 |                 account_count=len(accounts),
79 |             )
80 |             return accounts
   |             ^^^^^^^^^^^^^^^
81 |         except Exception as exc:
82 |             self.logger.exception(
   |

ARG002 Unused method argument: `instance`
  --> app/services/accounts_sync/adapters/sqlserver_adapter.py:90:34
   |
88 |             return []
89 |
90 |     def _normalize_account(self, instance: Instance, account: RawAccount) -> RemoteAccount:
   |                                  ^^^^^^^^
91 |         """规范化 SQL Server 账户信息.
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:103:28
    |
102 |         """
103 |         permissions = cast(PermissionSnapshot, account.get("permissions") or {})
    |                            ^^^^^^^^^^^^^^^^^^
104 |         type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
105 |         if "is_disabled" not in type_specific:
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:104:30
    |
102 |         """
103 |         permissions = cast(PermissionSnapshot, account.get("permissions") or {})
104 |         type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
    |                              ^^^^^^^^
105 |         if "is_disabled" not in type_specific:
106 |             type_specific["is_disabled"] = bool(account.get("is_disabled", False))
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:158:25
    |
156 |         db_batch_permissions = self._get_all_users_database_permissions_batch(connection, usernames_list)
157 |         db_permissions_map: dict[str, JsonValue] = {
158 |             login: cast(JsonValue, data.get("permissions", {}))
    |                         ^^^^^^^^^
159 |             for login, data in db_batch_permissions.items()
160 |         }
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:180:38
    |
178 |                     precomputed_db_permissions=db_permissions_map,
179 |                 )
180 |                 type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
    |                                      ^^^^^^^^
181 |                 existing_type_specific = cast(
182 |                     JsonDict,
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:182:21
    |
180 |                 type_specific = cast(JsonDict, permissions.setdefault("type_specific", {}))
181 |                 existing_type_specific = cast(
182 |                     JsonDict,
    |                     ^^^^^^^^
183 |                     account.get("permissions", {}).get("type_specific", {}) or {},
184 |                 )
    |
help: Add quotes

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:286:9
    |
284 |         return compiled
285 |
286 |     def _get_login_permissions(
    |         ^^^^^^^^^^^^^^^^^^^^^^
287 |         self,
288 |         connection: object,
    |

ARG002 Unused method argument: `connection`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:288:9
    |
286 |     def _get_login_permissions(
287 |         self,
288 |         connection: object,
    |         ^^^^^^^^^^
289 |         login_name: str,
290 |         *,
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:399:73
    |
397 |                 copied[db_name] = db_entry
398 |             elif isinstance(perms, list):
399 |                 copied[db_name] = self._deduplicate_preserve_order(cast(Sequence[str], perms))
    |                                                                         ^^^^^^^^^^^^^
400 |         return copied
    |
help: Add quotes

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:418:15
    |
417 |           placeholders = ", ".join(["%s"] * len(normalized))
418 |           sql = f"""
    |  _______________^
419 | |             SELECT member.name AS login_name, role.name AS role_name
420 | |             FROM sys.server_role_members rm
421 | |             JOIN sys.server_principals role ON rm.role_principal_id = role.principal_id
422 | |             JOIN sys.server_principals member ON rm.member_principal_id = member.principal_id
423 | |             WHERE member.name IN ({placeholders})
424 | |         """
    | |___________^
425 |           rows = connection.execute_query(sql, tuple(normalized))
426 |           result: dict[str, list[str]] = {}
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:451:15
    |
450 |           placeholders = ", ".join(["%s"] * len(normalized))
451 |           sql = f"""
    |  _______________^
452 | |             SELECT sp.name AS login_name, perm.permission_name
453 | |             FROM sys.server_permissions perm
454 | |             JOIN sys.server_principals sp ON perm.grantee_principal_id = sp.principal_id
455 | |             WHERE sp.name IN ({placeholders})
456 | |         """
    | |___________^
457 |           rows = connection.execute_query(sql, tuple(normalized))
458 |           result: dict[str, list[str]] = {}
    |

C901 `_get_all_users_database_permissions_batch` is too complex (32 > 10)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:467:9
    |
465 |         return result
466 |
467 |     def _get_all_users_database_permissions_batch(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
468 |         self,
469 |         connection: object,
    |

PLR0912 Too many branches (31 > 12)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:467:9
    |
465 |         return result
466 |
467 |     def _get_all_users_database_permissions_batch(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
468 |         self,
469 |         connection: object,
    |

PLR0915 Too many statements (88 > 50)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:467:9
    |
465 |         return result
466 |
467 |     def _get_all_users_database_permissions_batch(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
468 |         self,
469 |         connection: object,
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:511:30
    |
509 |               unique_usernames = list(dict.fromkeys(usernames))
510 |               placeholders = ", ".join(["%s"] * len(unique_usernames))
511 |               login_sids_sql = f"""
    |  ______________________________^
512 | |                 SELECT name, sid
513 | |                 FROM sys.server_principals
514 | |                 WHERE name IN ({placeholders})
515 | |                   AND type IN ('S', 'U', 'G')
516 | |             """
    | |_______________^
517 |               login_rows = connection.execute_query(login_sids_sql, tuple(unique_usernames))
518 |               sid_to_logins: dict[bytes, list[str]] = {}
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:542:21
    |
540 |                   quoted_db = self._quote_identifier(db)
541 |                   principals_parts.append(
542 | /                     f"""
543 | |                     SELECT '{db}' AS db_name,
544 | |                            name COLLATE SQL_Latin1_General_CP1_CI_AS AS user_name,
545 | |                            principal_id,
546 | |                            sid
547 | |                     FROM {quoted_db}.sys.database_principals
548 | |                     WHERE type IN ('S', 'U', 'G')
549 | |                       AND name != 'dbo'
550 | |                       AND sid IN ({sid_filter})
551 | |                     """,
    | |_______________________^
552 |                   )
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:555:21
    |
554 |                   roles_parts.append(
555 | /                     f"""
556 | |                     SELECT '{db}' AS db_name,
557 | |                            role.name COLLATE SQL_Latin1_General_CP1_CI_AS AS role_name,
558 | |                            member.principal_id AS member_principal_id
559 | |                     FROM {quoted_db}.sys.database_role_members drm
560 | |                     JOIN {quoted_db}.sys.database_principals role
561 | |                       ON drm.role_principal_id = role.principal_id
562 | |                     JOIN {quoted_db}.sys.database_principals member
563 | |                       ON drm.member_principal_id = member.principal_id
564 | |                     WHERE member.sid IN ({sid_filter})
565 | |                     """,
    | |_______________________^
566 |                   )
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:569:21
    |
568 |   …     perms_parts.append(
569 | / …         f"""
570 | | …         SELECT '{db}' AS db_name,
571 | | …                perm.permission_name COLLATE SQL_Latin1_General_CP1_CI_AS AS permission_name,
572 | | …                perm.grantee_principal_id,
573 | | …                perm.major_id,
574 | | …                perm.minor_id,
575 | | …                CASE
576 | | …                    WHEN perm.class_desc = 'DATABASE' THEN 'DATABASE'
577 | | …                    WHEN perm.class_desc = 'SCHEMA' THEN 'SCHEMA'
578 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id = 0 THEN 'OBJECT'
579 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id > 0 THEN 'COLUMN'
580 | | …                    ELSE perm.class_desc
581 | | …                END AS permission_scope,
582 | | …                CASE
583 | | …                    WHEN perm.class_desc = 'SCHEMA' THEN SCHEMA_NAME(perm.major_id)
584 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' THEN OBJECT_SCHEMA_NAME(perm.major_id)
585 | | …                    ELSE NULL
586 | | …                END AS schema_name,
587 | | …                CASE
588 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' THEN OBJECT_NAME(perm.major_id)
589 | | …                    ELSE NULL
590 | | …                END AS object_name,
591 | | …                CASE
592 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id > 0 THEN COL_NAME(perm.major_id, perm.minor_id)
593 | | …                    ELSE NULL
594 | | …                END AS column_name
595 | | …         FROM {quoted_db}.sys.database_permissions perm
596 | | …         JOIN {quoted_db}.sys.database_principals dp
597 | | …           ON perm.grantee_principal_id = dp.principal_id
598 | | …         WHERE perm.state = 'G'
599 | | …           AND dp.sid IN ({sid_filter})
600 | | …         """,
    | |_____________^
601 |   …     )
    |

E501 Line too long (138 > 120)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:592:121
    |
590 | …                     END AS object_name,
591 | …                     CASE
592 | …                         WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id > 0 THEN COL_NAME(perm.major_id, perm.minor_id)
    |                                                                                                                    ^^^^^^^^^^^^^^^^^^
593 | …                         ELSE NULL
594 | …                     END AS column_name
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:700:13
    |
698 |             )
699 |
700 |             return result
    |             ^^^^^^^^^^^^^
701 |         except Exception as exc:
702 |             self.logger.exception(
    |

TC003 Move standard library import `types.TracebackType` into a type-checking block
 --> app/services/accounts_sync/coordinator.py:6:19
  |
5 | from contextlib import AbstractContextManager
6 | from types import TracebackType
  |                   ^^^^^^^^^^^^^
7 | from typing import TYPE_CHECKING, Self
  |
help: Move into type-checking block

TC001 Move application import `app.types.CollectionSummary` into a type-checking block
  --> app/services/accounts_sync/coordinator.py:14:5
   |
12 | from app.services.connection_adapters.connection_factory import ConnectionFactory
13 | from app.types import (
14 |     CollectionSummary,
   |     ^^^^^^^^^^^^^^^^^
15 |     InventorySummary,
16 |     RemoteAccount,
   |
help: Move into type-checking block

TC001 Move application import `app.types.InventorySummary` into a type-checking block
  --> app/services/accounts_sync/coordinator.py:15:5
   |
13 | from app.types import (
14 |     CollectionSummary,
15 |     InventorySummary,
   |     ^^^^^^^^^^^^^^^^
16 |     RemoteAccount,
17 |     RemoteAccountMap,
   |
help: Move into type-checking block

TC001 Move application import `app.types.RemoteAccount` into a type-checking block
  --> app/services/accounts_sync/coordinator.py:16:5
   |
14 |     CollectionSummary,
15 |     InventorySummary,
16 |     RemoteAccount,
   |     ^^^^^^^^^^^^^
17 |     RemoteAccountMap,
18 |     SyncConnection,
   |
help: Move into type-checking block

F401 [*] `app.types.RemoteAccountMap` imported but unused
  --> app/services/accounts_sync/coordinator.py:17:5
   |
15 |     InventorySummary,
16 |     RemoteAccount,
17 |     RemoteAccountMap,
   |     ^^^^^^^^^^^^^^^^
18 |     SyncConnection,
19 |     SyncStagesSummary,
   |
help: Remove unused import: `app.types.RemoteAccountMap`

TC001 Move application import `app.types.SyncConnection` into a type-checking block
  --> app/services/accounts_sync/coordinator.py:18:5
   |
16 |     RemoteAccount,
17 |     RemoteAccountMap,
18 |     SyncConnection,
   |     ^^^^^^^^^^^^^^
19 |     SyncStagesSummary,
20 | )
   |
help: Move into type-checking block

TC001 Move application import `app.types.SyncStagesSummary` into a type-checking block
  --> app/services/accounts_sync/coordinator.py:19:5
   |
17 |     RemoteAccountMap,
18 |     SyncConnection,
19 |     SyncStagesSummary,
   |     ^^^^^^^^^^^^^^^^^
20 | )
21 | from app.utils.structlog_config import get_sync_logger
   |
help: Move into type-checking block

PLR0911 Too many return statements (7 > 6)
   --> app/services/accounts_sync/coordinator.py:101:9
    |
 99 |         self.disconnect()
100 |
101 |     def connect(self) -> bool:
    |         ^^^^^^^
102 |         """建立到数据库实例的连接.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/coordinator.py:171:13
    |
169 |                 module=MODULE,
170 |             )
171 |             return False
    |             ^^^^^^^^^^^^
172 |         except Exception as exc:
173 |             self._connection_failed = True
    |

E501 Line too long (122 > 120)
   --> app/services/accounts_sync/coordinator.py:372:121
    |
370 |         active_usernames = [account.username for account in active_accounts if getattr(account, "username", None)]
371 |         enriched_usernames = getattr(self, "_enriched_usernames", set())
372 |         pending_usernames = [username for username in active_usernames if username and username not in enriched_usernames]
    |                                                                                                                         ^^
373 |         if pending_usernames:
374 |             self._ensure_connection()
    |

E501 Line too long (121 > 120)
   --> app/services/accounts_sync/coordinator.py:410:121
    |
408 |             "updated": summary.get("updated", 0),
409 |             "skipped": summary.get("skipped", 0),
410 |             "processed_records": summary.get("processed_records", summary.get("created", 0) + summary.get("updated", 0)),
    |                                                                                                                         ^
411 |             "errors": summary.get("errors", []),
412 |             "message": summary.get("message"),
    |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> app/services/accounts_sync/permission_manager.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, cast
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/permission_manager.py:5:39
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                                       ^^^^^^^^
6 | from typing import TYPE_CHECKING, cast
  |
help: Move into type-checking block

C901 `synchronize` is too complex (11 > 10)
   --> app/services/accounts_sync/permission_manager.py:105:9
    |
103 |         self.logger = get_sync_logger()
104 |
105 |     def synchronize(
    |         ^^^^^^^^^^^
106 |         self,
107 |         instance: Instance,
    |

PLR0915 Too many statements (62 > 50)
   --> app/services/accounts_sync/permission_manager.py:105:9
    |
103 |         self.logger = get_sync_logger()
104 |
105 |     def synchronize(
    |         ^^^^^^^^^^^
106 |         self,
107 |         instance: Instance,
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/permission_manager.py:156:42
    |
154 |                 continue
155 |
156 |             permissions: JsonDict = cast(JsonDict, remote.get("permissions", {}))
    |                                          ^^^^^^^^
157 |             is_superuser = bool(remote.get("is_superuser", False))
158 |             is_locked = bool(remote.get("is_locked", False))
    |
help: Add quotes

C901 `_calculate_diff` is too complex (11 > 10)
   --> app/services/accounts_sync/permission_manager.py:342:9
    |
340 |                 setattr(record, field, None)
341 |
342 |     def _calculate_diff(
    |         ^^^^^^^^^^^^^^^
343 |         self,
344 |         record: AccountPermission,
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/permission_manager.py:437:31
    |
435 |             return
436 |
437 |         privilege_diff = cast(list[PrivilegeDiffEntry], diff_payload.get("privilege_diff", []))
    |                               ^^^^^^^^^^^^^^^^^^^^^^^^
438 |         other_diff = cast(list[OtherDiffEntry], diff_payload.get("other_diff", []))
439 |         summary = self._build_change_summary(username, change_type, privilege_diff, other_diff)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/accounts_sync/permission_manager.py:438:27
    |
437 |         privilege_diff = cast(list[PrivilegeDiffEntry], diff_payload.get("privilege_diff", []))
438 |         other_diff = cast(list[OtherDiffEntry], diff_payload.get("other_diff", []))
    |                           ^^^^^^^^^^^^^^^^^^^^
439 |         summary = self._build_change_summary(username, change_type, privilege_diff, other_diff)
    |
help: Add quotes

C901 `_build_change_summary` is too complex (11 > 10)
   --> app/services/accounts_sync/permission_manager.py:673:9
    |
671 |         return f"{label} 已更新"
672 |
673 |     def _build_change_summary(
    |         ^^^^^^^^^^^^^^^^^^^^^
674 |         self,
675 |         username: str,
    |

ARG002 Unused method argument: `target_date`
  --> app/services/aggregation/aggregation_service.py:94:42
   |
92 |         return instance
93 |
94 |     def _ensure_partition_for_date(self, target_date: date) -> None:
   |                                          ^^^^^^^^^^^
95 |         """保留接口,当前环境无需分区预处理.
   |

ARG002 Unused method argument: `aggregation`
   --> app/services/aggregation/aggregation_service.py:106:44
    |
104 |         return
105 |
106 |     def _commit_with_partition_retry(self, aggregation: object, start_date: date) -> None:
    |                                            ^^^^^^^^^^^
107 |         """提交聚合记录,移除分区重试逻辑.
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/aggregation/aggregation_service.py:325:20
    |
323 |             try:
324 |                 period_result = method(use_current_period=use_current)
325 |             except Exception as exc:  # pragma: no cover - 防御性日志
    |                    ^^^^^^^^^
326 |                 log_error(
327 |                     "数据库级聚合执行失败",
    |

E501 Line too long (121 > 120)
   --> app/services/aggregation/aggregation_service.py:375:121
    |
374 |         failed_periods = [
375 |             period for period, result in period_results.items() if result.get("status") == AggregationStatus.FAILED.value
    |                                                                                                                         ^
376 |         ]
377 |         failed_instance_periods = [
    |

C901 `aggregate_current_period` is too complex (11 > 10)
   --> app/services/aggregation/aggregation_service.py:444:9
    |
442 |         )
443 |
444 |     def aggregate_current_period(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^
445 |         self,
446 |         period_type: str = "daily",
    |

C901 `calculate_instance_aggregations` is too complex (11 > 10)
   --> app/services/aggregation/aggregation_service.py:681:9
    |
679 |         )
680 |
681 |     def calculate_instance_aggregations(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
682 |         self,
683 |         instance_id: int,
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/aggregation/aggregation_service.py:726:20
    |
724 |             try:
725 |                 result = func(instance_id, use_current_period=use_current_period)
726 |             except Exception as exc:  # pragma: no cover - 防御性日志
    |                    ^^^^^^^^^
727 |                 log_error(
728 |                     "实例周期聚合执行失败",
    |

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
 --> app/services/aggregation/calculator.py:6:29
  |
5 | from calendar import monthrange
6 | from collections.abc import Callable
  |                             ^^^^^^^^
7 | from datetime import date, timedelta
  |
help: Move into type-checking block

BLE001 Do not catch blind exception: `Exception`
  --> app/services/aggregation/database_aggregation_runner.py:77:16
   |
75 |         try:
76 |             callback(*args)
77 |         except Exception as exc:  # pragma: no cover - 防御性处理
   |                ^^^^^^^^^
78 |             log_warning(
79 |                 "聚合回调执行失败",
   |

PLR0913 Too many arguments in function definition (6 > 5)
  --> app/services/aggregation/database_aggregation_runner.py:85:9
   |
83 |             )
84 |
85 |     def aggregate_period(
   |         ^^^^^^^^^^^^^^^^
86 |         self,
87 |         period_type: str,
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/aggregation/database_aggregation_runner.py:187:20
    |
185 |                 }
186 |                 self._invoke_callback(on_instance_complete, instance, result_payload)
187 |             except Exception as exc:  # pragma: no cover - 防御性日志
    |                    ^^^^^^^^^
188 |                 db.session.rollback()
189 |                 summary.failed_instances += 1
    |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/services/aggregation/database_aggregation_runner.py:366:9
    |
364 |         return grouped
365 |
366 |     def _persist_database_aggregation(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
367 |         self,
368 |         *,
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/aggregation/database_aggregation_runner.py:503:9
    |
501 |             ) from exc
502 |
503 |     def _apply_change_statistics(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^
504 |         self,
505 |         *,
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/aggregation/database_aggregation_runner.py:583:16
    |
581 |             aggregation.log_size_change_percent = None
582 |             aggregation.growth_rate = aggregation.size_change_percent
583 |         except Exception as exc:  # pragma: no cover - 防御性日志
    |                ^^^^^^^^^
584 |             log_error(
585 |                 "计算数据库增量统计失败,使用默认值",
    |

BLE001 Do not catch blind exception: `Exception`
  --> app/services/aggregation/instance_aggregation_runner.py:77:16
   |
75 |         try:
76 |             callback(*args)
77 |         except Exception as exc:  # pragma: no cover
   |                ^^^^^^^^^
78 |             log_warning(
79 |                 "聚合回调执行失败",
   |

PLR0913 Too many arguments in function definition (6 > 5)
  --> app/services/aggregation/instance_aggregation_runner.py:85:9
   |
83 |             )
84 |
85 |     def aggregate_period(
   |         ^^^^^^^^^^^^^^^^
86 |         self,
87 |         period_type: str,
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/aggregation/instance_aggregation_runner.py:182:20
    |
180 |                 }
181 |                 self._invoke_callback(on_instance_complete, instance, result_payload)
182 |             except Exception as exc:  # pragma: no cover - 防御性日志
    |                    ^^^^^^^^^
183 |                 db.session.rollback()
184 |                 summary.failed_instances += 1
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/aggregation/instance_aggregation_runner.py:315:9
    |
313 |         ).all()
314 |
315 |     def _persist_instance_aggregation(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
316 |         self,
317 |         *,
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> app/services/aggregation/instance_aggregation_runner.py:519:56
    |
517 |             aggregation.growth_rate = aggregation.total_size_change_percent
518 |
519 |             if aggregation.total_size_change_percent > 5:
    |                                                        ^
520 |                 aggregation.trend_direction = "growing"
521 |             elif aggregation.total_size_change_percent < -5:
    |

PLR2004 Magic value used in comparison, consider replacing `-5` with a constant variable
   --> app/services/aggregation/instance_aggregation_runner.py:521:58
    |
519 |             if aggregation.total_size_change_percent > 5:
520 |                 aggregation.trend_direction = "growing"
521 |             elif aggregation.total_size_change_percent < -5:
    |                                                          ^^
522 |                 aggregation.trend_direction = "shrinking"
523 |             else:
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/aggregation/instance_aggregation_runner.py:525:16
    |
523 |             else:
524 |                 aggregation.trend_direction = "stable"
525 |         except Exception as exc:  # pragma: no cover - defensive logging
    |                ^^^^^^^^^
526 |             log_error(
527 |                 "计算实例增量统计失败,使用默认值",
    |

E501 Line too long (131 > 120)
   --> app/services/cache_service.py:360:121
    |
358 |         return rules
359 |
360 |     def set_classification_rules_by_db_type_cache(self, db_type: str, rules: list[dict[str, Any]], ttl: int | None = None) -> bool:
    |                                                                                                                         ^^^^^^^^^^^
361 |         """设置按数据库类型分类的规则缓存.
    |

D205 1 blank line required between summary line and description
 --> app/services/connection_adapters/__init__.py:1:1
  |
1 | / """鲸落 - 连接适配器模块
2 | | 集中提供数据库连接工厂与连接测试服务.
3 | | """
  | |___^
4 |
5 |   from .connection_factory import ConnectionFactory
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/services/connection_adapters/adapters/base.py:63:9
   |
61 |     """
62 |
63 |     def __init__(self, instance: Instance) -> None:
   |         ^^^^^^^^
64 |         self.instance = instance
65 |         self.db_logger = get_db_logger()
   |

TC001 Move application import `app.types.JsonValue` into a type-checking block
 --> app/services/connection_adapters/adapters/mysql_adapter.py:7:23
  |
5 | from collections.abc import Mapping, Sequence
6 |
7 | from app.types import JsonValue
  |                       ^^^^^^^^^
8 |
9 | from .base import (
  |
help: Move into type-checking block

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/mysql_adapter.py:29:13
   |
27 |         """
28 |         try:
29 |             import pymysql
   |             ^^^^^^^^^^^^^^
30 |
31 |             password = self.instance.credential.get_plain_password() if self.instance.credential else ""
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/mysql_adapter.py:47:13
   |
45 |             )
46 |             self.is_connected = True
47 |             return True
   |             ^^^^^^^^^^^
48 |         except Exception as exc:
49 |             self.db_logger.exception(
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/mysql_adapter.py:87:13
   |
86 |               version = self.get_version()
87 | /             return {
88 | |                 "success": True,
89 | |                 "message": f"MySQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
90 | |                 "database_version": version,
91 | |             }
   | |_____________^
92 |           except Exception as exc:
93 |               return {"success": False, "error": str(exc)}
   |

E501 Line too long (121 > 120)
  --> app/services/connection_adapters/adapters/mysql_adapter.py:89:111
   |
87 |             return {
88 |                 "success": True,
89 |                 "message": f"MySQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
   |                                                                                                                         ^
90 |                 "database_version": version,
91 |             }
   |

BLE001 Do not catch blind exception: `Exception`
  --> app/services/connection_adapters/adapters/mysql_adapter.py:92:16
   |
90 |                 "database_version": version,
91 |             }
92 |         except Exception as exc:
   |                ^^^^^^^^^
93 |             return {"success": False, "error": str(exc)}
94 |         finally:
   |

SIM108 Use ternary operator `bound_params = params if isinstance(params, Mapping) else tuple(params or [])` instead of `if`-`else`-block
   --> app/services/connection_adapters/adapters/mysql_adapter.py:119:13
    |
117 |           try:
118 |               bound_params: Sequence[JsonValue] | Mapping[str, JsonValue]
119 | /             if isinstance(params, Mapping):
120 | |                 bound_params = params
121 | |             else:
122 | |                 bound_params = tuple(params or [])
    | |__________________________________________________^
123 |               cursor.execute(query, bound_params)
124 |               rows = cursor.fetchall()
    |
help: Replace `if`-`else`-block with `bound_params = params if isinstance(params, Mapping) else tuple(params or [])`

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/mysql_adapter.py:140:13
    |
138 |             if result:
139 |                 return result[0][0]
140 |             return None
    |             ^^^^^^^^^^^
141 |         except Exception:
142 |             return None
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/adapters/mysql_adapter.py:141:16
    |
139 |                 return result[0][0]
140 |             return None
141 |         except Exception:
    |                ^^^^^^^^^
142 |             return None
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/connection_adapters/adapters/oracle_adapter.py:3:1
   |
 1 |   """Oracle 数据库连接适配器."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from pathlib import Path
 6 | | from collections.abc import Mapping, Sequence
 7 | |
 8 | | from app.types import JsonValue
 9 | |
10 | | from .base import (
11 | |     ConnectionAdapterError,
12 | |     DatabaseConnection,
13 | |     QueryParams,
14 | |     QueryResult,
15 | | )
   | |_^
   |
help: Organize imports

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/connection_adapters/adapters/oracle_adapter.py:6:29
  |
5 | from pathlib import Path
6 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
7 |
8 | from app.types import JsonValue
  |
help: Remove unused import

F401 [*] `collections.abc.Sequence` imported but unused
 --> app/services/connection_adapters/adapters/oracle_adapter.py:6:38
  |
5 | from pathlib import Path
6 | from collections.abc import Mapping, Sequence
  |                                      ^^^^^^^^
7 |
8 | from app.types import JsonValue
  |
help: Remove unused import

F401 [*] `app.types.JsonValue` imported but unused
  --> app/services/connection_adapters/adapters/oracle_adapter.py:8:23
   |
 6 | from collections.abc import Mapping, Sequence
 7 |
 8 | from app.types import JsonValue
   |                       ^^^^^^^^^
 9 |
10 | from .base import (
   |
help: Remove unused import: `app.types.JsonValue`

F401 [*] `.base.QueryParams` imported but unused
  --> app/services/connection_adapters/adapters/oracle_adapter.py:13:5
   |
11 |     ConnectionAdapterError,
12 |     DatabaseConnection,
13 |     QueryParams,
   |     ^^^^^^^^^^^
14 |     QueryResult,
15 | )
   |
help: Remove unused import

F401 [*] `.base.QueryResult` imported but unused
  --> app/services/connection_adapters/adapters/oracle_adapter.py:14:5
   |
12 |     DatabaseConnection,
13 |     QueryParams,
14 |     QueryResult,
   |     ^^^^^^^^^^^
15 | )
   |
help: Remove unused import

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/oracle_adapter.py:30:13
   |
28 |         username_for_connection = None
29 |         try:
30 |             import os
   |             ^^^^^^^^^
31 |
32 |             import oracledb
   |

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/oracle_adapter.py:32:13
   |
30 |             import os
31 |
32 |             import oracledb
   |             ^^^^^^^^^^^^^^^
33 |
34 |             password = self.instance.credential.get_plain_password() if self.instance.credential else ""
   |

E501 Line too long (129 > 120)
  --> app/services/connection_adapters/adapters/oracle_adapter.py:40:121
   |
38 |             port = self.instance.port
39 |             service_name = self.instance.database_name or "ORCL"
40 |             dsn = f"(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST={host})(PORT={port}))(CONNECT_DATA=(SERVICE_NAME={service_name})))"
   |                                                                                                                         ^^^^^^^^^
41 |
42 |             if not hasattr(oracledb, "is_thin") or not oracledb.is_thin():
   |

BLE001 Do not catch blind exception: `Exception`
  --> app/services/connection_adapters/adapters/oracle_adapter.py:61:24
   |
59 |                     else:
60 |                         oracledb.init_oracle_client()
61 |                 except Exception as init_error:
   |                        ^^^^^^^^^
62 |                     if "already been initialized" not in str(init_error).lower():
63 |                         self.db_logger.warning(
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/oracle_adapter.py:82:13
   |
80 |                 username=username_for_connection,
81 |             )
82 |             return True
   |             ^^^^^^^^^^^
83 |         except Exception as exc:
84 |             self.db_logger.exception(
   |

F821 Undefined name `Any`
   --> app/services/connection_adapters/adapters/oracle_adapter.py:119:44
    |
117 |                 self.is_connected = False
118 |
119 |     def test_connection(self) -> dict[str, Any]:
    |                                            ^^^
120 |         """测试 Oracle 连接并返回版本信息."""
121 |         try:
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/oracle_adapter.py:126:13
    |
125 |               version = self.get_version()
126 | /             return {
127 | |                 "success": True,
128 | |                 "message": f"Oracle连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
129 | |                 "database_version": version,
130 | |             }
    | |_____________^
131 |           except Exception as exc:
132 |               return {"success": False, "error": str(exc)}
    |

E501 Line too long (122 > 120)
   --> app/services/connection_adapters/adapters/oracle_adapter.py:128:111
    |
126 |             return {
127 |                 "success": True,
128 |                 "message": f"Oracle连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
    |                                                                                                                         ^^
129 |                 "database_version": version,
130 |             }
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/adapters/oracle_adapter.py:131:16
    |
129 |                 "database_version": version,
130 |             }
131 |         except Exception as exc:
    |                ^^^^^^^^^
132 |             return {"success": False, "error": str(exc)}
133 |         finally:
    |

F821 Undefined name `Any`
   --> app/services/connection_adapters/adapters/oracle_adapter.py:136:80
    |
134 |             self.disconnect()
135 |
136 |     def execute_query(self, query: str, params: tuple | dict | None = None) -> Any:
    |                                                                                ^^^
137 |         """执行 SQL 查询并返回全部行.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/oracle_adapter.py:169:13
    |
167 |             if result:
168 |                 return result[0][0]
169 |             return None
    |             ^^^^^^^^^^^
170 |         except Exception:
171 |             return None
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/adapters/oracle_adapter.py:170:16
    |
168 |                 return result[0][0]
169 |             return None
170 |         except Exception:
    |                ^^^^^^^^^
171 |             return None
    |

TC001 Move application import `app.types.JsonValue` into a type-checking block
 --> app/services/connection_adapters/adapters/postgresql_adapter.py:7:23
  |
5 | from collections.abc import Mapping, Sequence
6 |
7 | from app.types import JsonValue
  |                       ^^^^^^^^^
8 |
9 | from .base import (
  |
help: Move into type-checking block

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:29:13
   |
27 |         """
28 |         try:
29 |             import psycopg
   |             ^^^^^^^^^^^^^^
30 |
31 |             password = self.instance.credential.get_plain_password() if self.instance.credential else ""
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:43:13
   |
41 |             )
42 |             self.is_connected = True
43 |             return True
   |             ^^^^^^^^^^^
44 |         except Exception as exc:
45 |             self.db_logger.exception(
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:83:13
   |
82 |   …         version = self.get_version()
83 | / …         return {
84 | | …             "success": True,
85 | | …             "message": f"PostgreSQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
86 | | …             "database_version": version,
87 | | …         }
   | |___________^
88 |   …     except Exception as exc:
89 |   …         return {"success": False, "error": str(exc)}
   |

E501 Line too long (126 > 120)
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:85:112
   |
83 | …     return {
84 | …         "success": True,
85 | …         "message": f"PostgreSQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
   |                                                                                                                    ^^^^^
86 | …         "database_version": version,
87 | …     }
   |

BLE001 Do not catch blind exception: `Exception`
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:88:16
   |
86 |                 "database_version": version,
87 |             }
88 |         except Exception as exc:
   |                ^^^^^^^^^
89 |             return {"success": False, "error": str(exc)}
90 |         finally:
   |

SIM108 Use ternary operator `bound_params = params if isinstance(params, Mapping) else tuple(params or [])` instead of `if`-`else`-block
   --> app/services/connection_adapters/adapters/postgresql_adapter.py:115:13
    |
113 |           try:
114 |               bound_params: Sequence[JsonValue] | Mapping[str, JsonValue]
115 | /             if isinstance(params, Mapping):
116 | |                 bound_params = params
117 | |             else:
118 | |                 bound_params = tuple(params or [])
    | |__________________________________________________^
119 |               cursor.execute(query, bound_params)
120 |               rows = cursor.fetchall()
    |
help: Replace `if`-`else`-block with `bound_params = params if isinstance(params, Mapping) else tuple(params or [])`

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/postgresql_adapter.py:136:13
    |
134 |             if result:
135 |                 return result[0][0]
136 |             return None
    |             ^^^^^^^^^^^
137 |         except Exception:
138 |             return None
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/adapters/postgresql_adapter.py:137:16
    |
135 |                 return result[0][0]
136 |             return None
137 |         except Exception:
    |                ^^^^^^^^^
138 |             return None
    |

TC001 Move application import `app.models.instance.Instance` into a type-checking block
 --> app/services/connection_adapters/adapters/sqlserver_adapter.py:7:33
  |
5 | from collections.abc import Mapping, Sequence
6 |
7 | from app.models.instance import Instance
  |                                 ^^^^^^^^
8 | from app.types import JsonValue
9 | from app.utils.sqlserver_connection_utils import sqlserver_connection_utils
  |
help: Move into type-checking block

TC001 Move application import `app.types.JsonValue` into a type-checking block
 --> app/services/connection_adapters/adapters/sqlserver_adapter.py:8:23
  |
7 | from app.models.instance import Instance
8 | from app.types import JsonValue
  |                       ^^^^^^^^^
9 | from app.utils.sqlserver_connection_utils import sqlserver_connection_utils
  |
help: Move into type-checking block

D107 Missing docstring in `__init__`
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:23:9
   |
21 |     """SQL Server 数据库连接."""
22 |
23 |     def __init__(self, instance: Instance) -> None:
   |         ^^^^^^^^
24 |         super().__init__(instance)
25 |         self.driver_type: str | None = None
   |

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:68:13
   |
66 |         """
67 |         try:
68 |             import pymssql
   |             ^^^^^^^^^^^^^^
69 |
70 |             self.connection = pymssql.connect(
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:82:13
   |
80 |             self.is_connected = True
81 |             self.driver_type = "pymssql"
82 |             return True
   |             ^^^^^^^^^^^
83 |         except ImportError:
84 |             self.db_logger.exception(
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:120:20
    |
118 |             try:
119 |                 self.connection.close()
120 |             except Exception as exc:
    |                    ^^^^^^^^^
121 |                 self.db_logger.warning(
122 |                     "SQL Server断开连接出现异常",
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:139:13
    |
138 |   …         version = self.get_version()
139 | / …         return {
140 | | …             "success": True,
141 | | …             "message": f"SQL Server连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
142 | | …             "database_version": version,
143 | | …         }
    | |___________^
144 |   …     except Exception as exc:
145 |   …         return {"success": False, "error": str(exc)}
    |

E501 Line too long (126 > 120)
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:141:112
    |
139 | …     return {
140 | …         "success": True,
141 | …         "message": f"SQL Server连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
    |                                                                                                                    ^^^^^
142 | …         "database_version": version,
143 | …     }
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:144:16
    |
142 |                 "database_version": version,
143 |             }
144 |         except Exception as exc:
    |                ^^^^^^^^^
145 |             return {"success": False, "error": str(exc)}
146 |         finally:
    |

SIM108 Use ternary operator `bound_params = params if isinstance(params, Mapping) else tuple(params or [])` instead of `if`-`else`-block
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:171:13
    |
169 |           try:
170 |               bound_params: Sequence[JsonValue] | Mapping[str, JsonValue]
171 | /             if isinstance(params, Mapping):
172 | |                 bound_params = params
173 | |             else:
174 | |                 bound_params = tuple(params or [])
    | |__________________________________________________^
175 |               cursor.execute(query, bound_params)
176 |               rows = cursor.fetchall()
    |
help: Replace `if`-`else`-block with `bound_params = params if isinstance(params, Mapping) else tuple(params or [])`

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:192:13
    |
190 |             if result:
191 |                 return result[0][0]
192 |             return None
    |             ^^^^^^^^^^^
193 |         except Exception:
194 |             return None
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:193:16
    |
191 |                 return result[0][0]
192 |             return None
193 |         except Exception:
    |                ^^^^^^^^^
194 |             return None
    |

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/services/connection_adapters/connection_factory.py:37:26
   |
35 |       """
36 |
37 |       CONNECTION_CLASSES = {
   |  __________________________^
38 | |         "mysql": MySQLConnection,
39 | |         "postgresql": PostgreSQLConnection,
40 | |         "sqlserver": SQLServerConnection,
41 | |         "oracle": OracleConnection,
42 | |     }
   | |_____^
43 |
44 |       @staticmethod
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/connection_test_service.py:80:13
   |
78 |               db.session.commit()
79 |
80 | /             return {
81 | |                 "success": True,
82 | |                 "message": f"连接成功,数据库版本: {formatted_version}",
83 | |                 "version": formatted_version,
84 | |                 "database_version": instance.database_version,
85 | |                 "main_version": instance.main_version,
86 | |                 "detailed_version": instance.detailed_version,
87 | |             }
   | |_____________^
88 |
89 |           except Exception as e:
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/connection_adapters/connection_test_service.py:134:24
    |
132 |                 try:
133 |                     connection_obj.disconnect()
134 |                 except Exception as close_error:
    |                        ^^^^^^^^^
135 |                     self.test_logger.warning(
136 |                         "关闭数据库连接时发生错误",
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/adapters/base_adapter.py:31:9
   |
29 |     """
30 |
31 |     def __init__(self) -> None:
   |         ^^^^^^^^
32 |         self.logger = get_system_logger()
   |

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/base_adapter.py:37:21
   |
35 |         self,
36 |         instance: Instance,
37 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
38 |     ) -> list[dict[str, object]]:
39 |         """列出实例当前的数据库/表空间.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/base_adapter.py:59:21
   |
57 |         self,
58 |         instance: Instance,
59 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
60 |         target_databases: Sequence[str] | None = None,
61 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/services/database_sync/adapters/mysql_adapter.py:35:25
   |
33 |     """
34 |
35 |     _SYSTEM_DATABASES = {"information_schema", "performance_schema", "mysql", "sys"}
   |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
36 |
37 |     def fetch_inventory(
   |

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/mysql_adapter.py:39:19
   |
37 |     def fetch_inventory(
38 |         self,
39 |         instance: "Instance",
   |                   ^^^^^^^^^^
40 |         connection: "DatabaseConnection",
41 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/mysql_adapter.py:40:21
   |
38 |         self,
39 |         instance: "Instance",
40 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
41 |     ) -> list[dict[str, object]]:
42 |         """列出 MySQL 实例当前的数据库清单.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/mysql_adapter.py:85:19
   |
83 |     def fetch_capacity(
84 |         self,
85 |         instance: "Instance",
   |                   ^^^^^^^^^^
86 |         connection: "DatabaseConnection",
87 |         target_databases: Sequence[str] | None = None,
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/mysql_adapter.py:86:21
   |
84 |         self,
85 |         instance: "Instance",
86 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
87 |         target_databases: Sequence[str] | None = None,
88 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/adapters/mysql_adapter.py:114:25
    |
112 |             tablespace_stats = self._collect_tablespace_sizes(connection, instance)
113 |         except Exception as exc:  # pragma: no cover - defensive logging
114 |             self.logger.error(
    |                         ^^^^^
115 |                 "mysql_tablespace_collection_failed",
116 |                 instance=instance.name,
    |

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/adapters/mysql_adapter.py:139:46
    |
137 |         return data
138 |
139 |     def _assert_permission(self, connection: "DatabaseConnection", instance: "Instance") -> None:
    |                                              ^^^^^^^^^^^^^^^^^^^^
140 |         """验证 MySQL 权限.
    |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/adapters/mysql_adapter.py:139:78
    |
137 |         return data
138 |
139 |     def _assert_permission(self, connection: "DatabaseConnection", instance: "Instance") -> None:
    |                                                                              ^^^^^^^^^^
140 |         """验证 MySQL 权限.
    |
help: Remove quotes

C901 `_collect_tablespace_sizes` is too complex (15 > 10)
   --> app/services/database_sync/adapters/mysql_adapter.py:171:9
    |
169 |         )
170 |
171 |     def _collect_tablespace_sizes(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^
172 |         self,
173 |         connection: "DatabaseConnection",
    |

PLR0912 Too many branches (15 > 12)
   --> app/services/database_sync/adapters/mysql_adapter.py:171:9
    |
169 |         )
170 |
171 |     def _collect_tablespace_sizes(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^
172 |         self,
173 |         connection: "DatabaseConnection",
    |

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/adapters/mysql_adapter.py:173:21
    |
171 |     def _collect_tablespace_sizes(
172 |         self,
173 |         connection: "DatabaseConnection",
    |                     ^^^^^^^^^^^^^^^^^^^^
174 |         instance: "Instance",
175 |     ) -> dict[str, int]:
    |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/adapters/mysql_adapter.py:174:19
    |
172 |         self,
173 |         connection: "DatabaseConnection",
174 |         instance: "Instance",
    |                   ^^^^^^^^^^
175 |     ) -> dict[str, int]:
176 |         """采集 MySQL 表空间大小.
    |
help: Remove quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/services/database_sync/adapters/mysql_adapter.py:229:20
    |
227 |                         view=label,
228 |                     )
229 |             except Exception as exc:
    |                    ^^^^^^^^^
230 |                 self.logger.warning(
231 |                     "mysql_tablespace_query_failed",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/database_sync/adapters/mysql_adapter.py:249:16
    |
247 |                         continue
248 |                     aggregated.setdefault(db_name, 0)
249 |         except Exception as exc:
    |                ^^^^^^^^^
250 |             self.logger.warning(
251 |                 "mysql_show_databases_failed",
    |

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/adapters/mysql_adapter.py:261:19
    |
259 |     def _build_stats_from_tablespaces(
260 |         self,
261 |         instance: "Instance",
    |                   ^^^^^^^^^^
262 |         stats: dict[str, int],
263 |     ) -> list[dict[str, object]]:
    |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/adapters/mysql_adapter.py:338:51
    |
336 |         return re.sub(r"@([0-9A-Fa-f]{4})", _replace, raw_name)
337 |
338 |     def _build_tablespace_queries(self, instance: "Instance") -> list[tuple[str, str]]:
    |                                                   ^^^^^^^^^^
339 |         """构建表空间查询语句列表.
    |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/oracle_adapter.py:32:19
   |
30 |     def fetch_inventory(
31 |         self,
32 |         instance: "Instance",
   |                   ^^^^^^^^^^
33 |         connection: "DatabaseConnection",
34 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/oracle_adapter.py:33:21
   |
31 |         self,
32 |         instance: "Instance",
33 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
34 |     ) -> list[dict[str, object]]:
35 |         """列出 Oracle 实例当前的表空间清单.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/oracle_adapter.py:78:19
   |
76 |     def fetch_capacity(
77 |         self,
78 |         instance: "Instance",
   |                   ^^^^^^^^^^
79 |         connection: "DatabaseConnection",
80 |         target_databases: Sequence[str] | None = None,
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/oracle_adapter.py:79:21
   |
77 |         self,
78 |         instance: "Instance",
79 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
80 |         target_databases: Sequence[str] | None = None,
81 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/services/database_sync/adapters/postgresql_adapter.py:33:25
   |
31 |     """
32 |
33 |     _SYSTEM_DATABASES = {"postgres"}
   |                         ^^^^^^^^^^^^
34 |
35 |     def fetch_inventory(
   |

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/postgresql_adapter.py:37:19
   |
35 |     def fetch_inventory(
36 |         self,
37 |         instance: "Instance",
   |                   ^^^^^^^^^^
38 |         connection: "DatabaseConnection",
39 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/postgresql_adapter.py:38:21
   |
36 |         self,
37 |         instance: "Instance",
38 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
39 |     ) -> list[dict[str, object]]:
40 |         """列出 PostgreSQL 实例当前的数据库清单.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/postgresql_adapter.py:84:19
   |
82 |     def fetch_capacity(
83 |         self,
84 |         instance: "Instance",
   |                   ^^^^^^^^^^
85 |         connection: "DatabaseConnection",
86 |         target_databases: Sequence[str] | None = None,
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/postgresql_adapter.py:85:21
   |
83 |         self,
84 |         instance: "Instance",
85 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
86 |         target_databases: Sequence[str] | None = None,
87 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/sqlserver_adapter.py:32:19
   |
30 |     def fetch_inventory(
31 |         self,
32 |         instance: "Instance",
   |                   ^^^^^^^^^^
33 |         connection: "DatabaseConnection",
34 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/sqlserver_adapter.py:33:21
   |
31 |         self,
32 |         instance: "Instance",
33 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
34 |     ) -> list[dict[str, object]]:
35 |         """列出 SQL Server 实例当前的数据库清单.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/sqlserver_adapter.py:78:19
   |
76 |     def fetch_capacity(
77 |         self,
78 |         instance: "Instance",
   |                   ^^^^^^^^^^
79 |         connection: "DatabaseConnection",
80 |         target_databases: Sequence[str] | None = None,
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/services/database_sync/adapters/sqlserver_adapter.py:79:21
   |
77 |         self,
78 |         instance: "Instance",
79 |         connection: "DatabaseConnection",
   |                     ^^^^^^^^^^^^^^^^^^^^
80 |         target_databases: Sequence[str] | None = None,
81 |     ) -> list[dict[str, object]]:
   |
help: Remove quotes

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/coordinator.py:105:25
    |
103 |                 return True
104 |         except Exception as exc:
105 |             self.logger.error(
    |                         ^^^^^
106 |                 "capacity_sync_connection_error",
107 |                 instance=self.instance.name,
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/database_sync/coordinator.py:130:20
    |
128 |             try:
129 |                 self._connection.disconnect()
130 |             except Exception as exc:
    |                    ^^^^^^^^^
131 |                 self.logger.warning(
132 |                     "capacity_sync_disconnect_error",
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/coordinator.py:292:29
    |
290 |             except Exception as exc:
291 |                 db.session.rollback()
292 |                 self.logger.error(
    |                             ^^^^^
293 |                     "capacity_sync_commit_failed",
294 |                     instance=self.instance.name,
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/database_filters.py:37:9
   |
35 |     """负责加载数据库发现/容量同步所需的过滤配置."""
36 |
37 |     def __init__(self, config_path: str | Path | None = None) -> None:
   |         ^^^^^^^^
38 |         self._config_path = Path(config_path) if config_path else _DEFAULT_CONFIG_PATH
39 |         self._normalized_rules: dict[str, _FilterRule] = {}
   |

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/database_filters.py:119:49
    |
117 |         return re.compile(regex, re.IGNORECASE)
118 |
119 |     def should_exclude_database(self, instance: "Instance", database_name: str | None) -> tuple[bool, str | None]:
    |                                                 ^^^^^^^^^^
120 |         """判断给定实例下的数据库是否需要被过滤.
    |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/database_filters.py:151:47
    |
149 |         return False, None
150 |
151 |     def filter_database_names(self, instance: "Instance", names: Iterable[str]) -> tuple[list[str], list[str]]:
    |                                               ^^^^^^^^^^
152 |         """过滤数据库名称,返回保留与排除列表.
    |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
   --> app/services/database_sync/database_filters.py:174:19
    |
172 |     def filter_capacity_payload(
173 |         self,
174 |         instance: "Instance",
    |                   ^^^^^^^^^^
175 |         payload: Sequence[dict[str, object]],
176 |     ) -> tuple[list[dict[str, object]], list[str]]:
    |
help: Remove quotes

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/database_sync/database_sync_service.py:7:1
   |
 5 |   """
 6 |
 7 | / from __future__ import annotations
 8 | |
 9 | | from typing import TYPE_CHECKING, Any, Self
10 | | from types import TracebackType
11 | |
12 | | from app.utils.structlog_config import get_system_logger
13 | |
14 | | from .coordinator import CapacitySyncCoordinator
   | |________________________________________________^
15 |
16 |   if TYPE_CHECKING:
   |
help: Organize imports

TC003 Move standard library import `types.TracebackType` into a type-checking block
  --> app/services/database_sync/database_sync_service.py:10:19
   |
 9 | from typing import TYPE_CHECKING, Any, Self
10 | from types import TracebackType
   |                   ^^^^^^^^^^^^^
11 |
12 | from app.utils.structlog_config import get_system_logger
   |
help: Move into type-checking block

PLC0415 `import` should be at the top-level of a file
   --> app/services/database_sync/database_sync_service.py:215:5
    |
214 |     """
215 |     from app.models.instance import Instance
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
216 |
217 |     logger = get_system_logger()
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/database_sync_service.py:257:20
    |
255 |         except Exception as exc:
256 |             error_msg = f"实例 {instance.name} 采集失败: {exc}"
257 |             logger.error(
    |                    ^^^^^
258 |                 "capacity_collection_failed",
259 |                 instance=instance.name,
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/inventory_manager.py:27:9
   |
25 |     """负责维护 instance_databases 表的增量同步逻辑."""
26 |
27 |     def __init__(
   |         ^^^^^^^^
28 |         self,
29 |         filter_manager: DatabaseSyncFilterManager = database_sync_filter_manager,
   |

C901 `synchronize` is too complex (11 > 10)
  --> app/services/database_sync/inventory_manager.py:34:9
   |
32 |         self.filter_manager = filter_manager
33 |
34 |     def synchronize(
   |         ^^^^^^^^^^^
35 |         self,
36 |         instance: Instance,
   |

PLR0915 Too many statements (54 > 50)
  --> app/services/database_sync/inventory_manager.py:34:9
   |
32 |         self.filter_manager = filter_manager
33 |
34 |     def synchronize(
   |         ^^^^^^^^^^^
35 |         self,
36 |         instance: Instance,
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/inventory_manager.py:127:25
    |
125 |         except SQLAlchemyError as exc:
126 |             db.session.rollback()
127 |             self.logger.error(
    |                         ^^^^^
128 |                 "inventory_sync_commit_failed",
129 |                 instance=instance.name,
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/persistence.py:27:9
   |
25 |     """负责容量采集相关的数据持久化."""
26 |
27 |     def __init__(self) -> None:
   |         ^^^^^^^^
28 |         self.logger = get_system_logger()
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:101:25
    |
 99 |         except SQLAlchemyError as exc:
100 |             db.session.rollback()
101 |             self.logger.error(
    |                         ^^^^^
102 |                 "save_database_stats_upsert_failed",
103 |                 instance=instance.name,
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:118:25
    |
116 |         except SQLAlchemyError as exc:
117 |             db.session.rollback()
118 |             self.logger.error(
    |                         ^^^^^
119 |                 "save_database_stats_commit_failed",
120 |                 instance=instance.name,
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/database_sync/persistence.py:191:13
    |
189 |                 database_count=database_count,
190 |             )
191 |             return True
    |             ^^^^^^^^^^^
192 |         except SQLAlchemyError as exc:
193 |             self.logger.error(
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:193:25
    |
191 |             return True
192 |         except SQLAlchemyError as exc:
193 |             self.logger.error(
    |                         ^^^^^
194 |                 "save_instance_stats_failed",
195 |                 instance=instance.name,
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:250:29
    |
248 |             except SQLAlchemyError as exc:
249 |                 db.session.rollback()
250 |                 self.logger.error(
    |                             ^^^^^
251 |                     "update_instance_total_size_commit_failed",
252 |                     instance=instance.name,
    |

D205 1 blank line required between summary line and description
 --> app/services/database_type_service.py:1:1
  |
1 | / """鲸落 - 数据库类型管理服务
2 | | 提供数据库类型的CRUD操作和业务逻辑.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/classification_rule_service.py:3:1
   |
 1 |   """账户分类规则表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import json
 6 | |
 7 | | from typing import cast
 8 | |
 9 | | from flask_login import current_user
10 | |
11 | | from app import db
12 | | from app.forms.definitions.account_classification_rule_constants import DB_TYPE_OPTIONS, OPERATOR_OPTIONS
13 | | from app.models.account_classification import AccountClassification, ClassificationRule
14 | | from app.services.account_classification.orchestrator import AccountClassificationService
15 | | from app.services.database_type_service import DatabaseTypeService
16 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
17 | | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
18 | | from app.types.converters import as_bool, as_int, as_optional_str, as_str
19 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
20 |
21 |   class ClassificationRuleFormService(BaseResourceService[ClassificationRule]):
   |
help: Organize imports

TC001 Move application import `app.types.ContextDict` into a type-checking block
  --> app/services/form_service/classification_rule_service.py:17:23
   |
15 | from app.services.database_type_service import DatabaseTypeService
16 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
17 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                       ^^^^^^^^^^^
18 | from app.types.converters import as_bool, as_int, as_optional_str, as_str
19 | from app.utils.structlog_config import log_info
   |
help: Move into type-checking block

TC001 Move application import `app.types.MutablePayloadDict` into a type-checking block
  --> app/services/form_service/classification_rule_service.py:17:36
   |
15 | from app.services.database_type_service import DatabaseTypeService
16 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
17 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                    ^^^^^^^^^^^^^^^^^^
18 | from app.types.converters import as_bool, as_int, as_optional_str, as_str
19 | from app.utils.structlog_config import log_info
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadMapping` into a type-checking block
  --> app/services/form_service/classification_rule_service.py:17:56
   |
15 | from app.services.database_type_service import DatabaseTypeService
16 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
17 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                                        ^^^^^^^^^^^^^^
18 | from app.types.converters import as_bool, as_int, as_optional_str, as_str
19 | from app.utils.structlog_config import log_info
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadValue` into a type-checking block
  --> app/services/form_service/classification_rule_service.py:17:72
   |
15 | from app.services.database_type_service import DatabaseTypeService
16 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
17 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                                                        ^^^^^^^^^^^^
18 | from app.types.converters import as_bool, as_int, as_optional_str, as_str
19 | from app.utils.structlog_config import log_info
   |
help: Move into type-checking block

E501 Line too long (126 > 120)
  --> app/services/form_service/classification_rule_service.py:45:121
   |
43 |         return dict(payload or {})
44 |
45 |     def validate(self, data: MutablePayloadDict, *, resource: ClassificationRule | None) -> ServiceResult[MutablePayloadDict]:
   |                                                                                                                         ^^^^^^
46 |         """校验分类规则数据.
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:123:35
    |
122 |         """
123 |         instance.rule_name = cast(str, data["rule_name"])
    |                                   ^^^
124 |         instance.classification_id = cast(int, data["classification_id"])
125 |         instance.db_type = cast(str, data["db_type"])
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:124:43
    |
122 |         """
123 |         instance.rule_name = cast(str, data["rule_name"])
124 |         instance.classification_id = cast(int, data["classification_id"])
    |                                           ^^^
125 |         instance.db_type = cast(str, data["db_type"])
126 |         instance.operator = cast(str, data["operator"])
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:125:33
    |
123 |         instance.rule_name = cast(str, data["rule_name"])
124 |         instance.classification_id = cast(int, data["classification_id"])
125 |         instance.db_type = cast(str, data["db_type"])
    |                                 ^^^
126 |         instance.operator = cast(str, data["operator"])
127 |         instance.rule_expression = cast(str, data["rule_expression"])
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:126:34
    |
124 |         instance.classification_id = cast(int, data["classification_id"])
125 |         instance.db_type = cast(str, data["db_type"])
126 |         instance.operator = cast(str, data["operator"])
    |                                  ^^^
127 |         instance.rule_expression = cast(str, data["rule_expression"])
128 |         instance.is_active = cast(bool, data["is_active"])
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:127:41
    |
125 |         instance.db_type = cast(str, data["db_type"])
126 |         instance.operator = cast(str, data["operator"])
127 |         instance.rule_expression = cast(str, data["rule_expression"])
    |                                         ^^^
128 |         instance.is_active = cast(bool, data["is_active"])
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:128:35
    |
126 |         instance.operator = cast(str, data["operator"])
127 |         instance.rule_expression = cast(str, data["rule_expression"])
128 |         instance.is_active = cast(bool, data["is_active"])
    |                                   ^^^^
129 |
130 |     def after_save(self, instance: ClassificationRule, data: MutablePayloadDict) -> None:
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/services/form_service/classification_rule_service.py:151:16
    |
149 |             service = AccountClassificationService()
150 |             service.invalidate_cache()
151 |         except Exception as exc:
    |                ^^^^^^^^^
152 |             log_info(
153 |                 "清除分类缓存失败",
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:257:34
    |
256 |     def _rule_name_exists(self, data: MutablePayloadDict, resource: ClassificationRule | None) -> bool:
257 |         classification_id = cast(int, data["classification_id"])
    |                                  ^^^
258 |         db_type = cast(str, data["db_type"])
259 |         rule_name = cast(str, data["rule_name"])
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:258:24
    |
256 |     def _rule_name_exists(self, data: MutablePayloadDict, resource: ClassificationRule | None) -> bool:
257 |         classification_id = cast(int, data["classification_id"])
258 |         db_type = cast(str, data["db_type"])
    |                        ^^^
259 |         rule_name = cast(str, data["rule_name"])
260 |         query = ClassificationRule.query.filter_by(
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:259:26
    |
257 |         classification_id = cast(int, data["classification_id"])
258 |         db_type = cast(str, data["db_type"])
259 |         rule_name = cast(str, data["rule_name"])
    |                          ^^^
260 |         query = ClassificationRule.query.filter_by(
261 |             classification_id=classification_id,
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:266:32
    |
264 |         )
265 |         if resource:
266 |             resource_id = cast(int, resource.id)
    |                                ^^^
267 |             query = query.filter(ClassificationRule.id != resource_id)
268 |         return db.session.query(query.exists()).scalar()
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/classification_rule_service.py:281:32
    |
279 |         )
280 |         if resource:
281 |             resource_id = cast(int, resource.id)
    |                                ^^^
282 |             query = query.filter(ClassificationRule.id != resource_id)
283 |         return db.session.query(query.exists()).scalar()
    |
help: Add quotes

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/classification_service.py:3:1
   |
 1 |   """账户分类表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | |
 6 | | from flask_login import current_user
 7 | |
 8 | | from app import db
 9 | | from app.constants.colors import ThemeColors
10 | | from app.forms.definitions.account_classification_constants import ICON_OPTIONS, RISK_LEVEL_OPTIONS
11 | | from app.models.account_classification import AccountClassification
12 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | | from app.types import (
14 | |     ColorOptionDict,
15 | |     ColorToken,
16 | |     ContextDict,
17 | |     MutablePayloadDict,
18 | |     PayloadMapping,
19 | |     PayloadValue,
20 | | )
21 | | from app.types.converters import as_int, as_str
22 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
   |
help: Organize imports

TC001 Move application import `app.types.ColorOptionDict` into a type-checking block
  --> app/services/form_service/classification_service.py:14:5
   |
12 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | from app.types import (
14 |     ColorOptionDict,
   |     ^^^^^^^^^^^^^^^
15 |     ColorToken,
16 |     ContextDict,
   |
help: Move into type-checking block

TC001 Move application import `app.types.ColorToken` into a type-checking block
  --> app/services/form_service/classification_service.py:15:5
   |
13 | from app.types import (
14 |     ColorOptionDict,
15 |     ColorToken,
   |     ^^^^^^^^^^
16 |     ContextDict,
17 |     MutablePayloadDict,
   |
help: Move into type-checking block

TC001 Move application import `app.types.ContextDict` into a type-checking block
  --> app/services/form_service/classification_service.py:16:5
   |
14 |     ColorOptionDict,
15 |     ColorToken,
16 |     ContextDict,
   |     ^^^^^^^^^^^
17 |     MutablePayloadDict,
18 |     PayloadMapping,
   |
help: Move into type-checking block

TC001 Move application import `app.types.MutablePayloadDict` into a type-checking block
  --> app/services/form_service/classification_service.py:17:5
   |
15 |     ColorToken,
16 |     ContextDict,
17 |     MutablePayloadDict,
   |     ^^^^^^^^^^^^^^^^^^
18 |     PayloadMapping,
19 |     PayloadValue,
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadMapping` into a type-checking block
  --> app/services/form_service/classification_service.py:18:5
   |
16 |     ContextDict,
17 |     MutablePayloadDict,
18 |     PayloadMapping,
   |     ^^^^^^^^^^^^^^
19 |     PayloadValue,
20 | )
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadValue` into a type-checking block
  --> app/services/form_service/classification_service.py:19:5
   |
17 |     MutablePayloadDict,
18 |     PayloadMapping,
19 |     PayloadValue,
   |     ^^^^^^^^^^^^
20 | )
21 | from app.types.converters import as_int, as_str
   |
help: Move into type-checking block

PLR0911 Too many return statements (7 > 6)
  --> app/services/form_service/classification_service.py:49:9
   |
47 |         return dict(payload or {})
48 |
49 |     def validate(self, data: MutablePayloadDict, *, resource: AccountClassification | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
50 |         """校验账户分类数据.
   |

E501 Line too long (129 > 120)
  --> app/services/form_service/classification_service.py:49:121
   |
47 |         return dict(payload or {})
48 |
49 |     def validate(self, data: MutablePayloadDict, *, resource: AccountClassification | None) -> ServiceResult[MutablePayloadDict]:
   |                                                                                                                         ^^^^^^^^^
50 |         """校验账户分类数据.
   |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/credential_service.py:3:1
   |
 1 |   """凭据资源表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import os
 6 | | import secrets
 7 | |
 8 | | from flask_login import current_user
 9 | |
10 | | from app.constants import CREDENTIAL_TYPES, DATABASE_TYPES
11 | | from app.models.credential import Credential
12 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
14 | | from app.types.converters import as_bool, as_optional_str, as_str
15 | | from app.utils.data_validator import (
16 | |     sanitize_form_data,
17 | |     validate_credential_type,
18 | |     validate_db_type,
19 | |     validate_password,
20 | |     validate_required_fields,
21 | |     validate_username,
22 | | )
23 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
24 |
25 |   class CredentialFormService(BaseResourceService[Credential]):
   |
help: Organize imports

TC001 Move application import `app.types.ContextDict` into a type-checking block
  --> app/services/form_service/credential_service.py:13:23
   |
11 | from app.models.credential import Credential
12 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                       ^^^^^^^^^^^
14 | from app.types.converters import as_bool, as_optional_str, as_str
15 | from app.utils.data_validator import (
   |
help: Move into type-checking block

TC001 Move application import `app.types.MutablePayloadDict` into a type-checking block
  --> app/services/form_service/credential_service.py:13:36
   |
11 | from app.models.credential import Credential
12 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                    ^^^^^^^^^^^^^^^^^^
14 | from app.types.converters import as_bool, as_optional_str, as_str
15 | from app.utils.data_validator import (
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadMapping` into a type-checking block
  --> app/services/form_service/credential_service.py:13:56
   |
11 | from app.models.credential import Credential
12 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                                        ^^^^^^^^^^^^^^
14 | from app.types.converters import as_bool, as_optional_str, as_str
15 | from app.utils.data_validator import (
   |
help: Move into type-checking block

F401 [*] `app.types.PayloadValue` imported but unused
  --> app/services/form_service/credential_service.py:13:72
   |
11 | from app.models.credential import Credential
12 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                                                        ^^^^^^^^^^^^
14 | from app.types.converters import as_bool, as_optional_str, as_str
15 | from app.utils.data_validator import (
   |
help: Remove unused import: `app.types.PayloadValue`

FBT001 Boolean-typed positional argument in function definition
   --> app/services/form_service/credential_service.py:145:9
    |
143 |         self,
144 |         data: PayloadMapping,
145 |         require_password: bool,
    |         ^^^^^^^^^^^^^^^^
146 |     ) -> ServiceResult[MutablePayloadDict] | None:
147 |         """对凭据表单的核心字段执行逐项校验."""
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/instance_service.py:3:1
   |
 1 |   """实例资源表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | |
 6 | | from app import db
 7 | | from app.models.credential import Credential
 8 | | from app.models.instance import Instance
 9 | | from app.models.tag import Tag
10 | | from app.services.database_type_service import DatabaseTypeService
11 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
12 | | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
13 | | from app.types.converters import as_bool, as_int, as_list_of_str, as_optional_str, as_str
14 | | from app.utils.data_validator import DataValidator
15 | | from app.utils.structlog_config import log_error, log_info
   | |__________________________________________________________^
16 |
17 |   class InstanceFormService(BaseResourceService[Instance]):
   |
help: Organize imports

TC001 Move application import `app.types.ContextDict` into a type-checking block
  --> app/services/form_service/instance_service.py:12:23
   |
10 | from app.services.database_type_service import DatabaseTypeService
11 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
12 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                       ^^^^^^^^^^^
13 | from app.types.converters import as_bool, as_int, as_list_of_str, as_optional_str, as_str
14 | from app.utils.data_validator import DataValidator
   |
help: Move into type-checking block

TC001 Move application import `app.types.MutablePayloadDict` into a type-checking block
  --> app/services/form_service/instance_service.py:12:36
   |
10 | from app.services.database_type_service import DatabaseTypeService
11 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
12 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                    ^^^^^^^^^^^^^^^^^^
13 | from app.types.converters import as_bool, as_int, as_list_of_str, as_optional_str, as_str
14 | from app.utils.data_validator import DataValidator
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadMapping` into a type-checking block
  --> app/services/form_service/instance_service.py:12:56
   |
10 | from app.services.database_type_service import DatabaseTypeService
11 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
12 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                                        ^^^^^^^^^^^^^^
13 | from app.types.converters import as_bool, as_int, as_list_of_str, as_optional_str, as_str
14 | from app.utils.data_validator import DataValidator
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadValue` into a type-checking block
  --> app/services/form_service/instance_service.py:12:72
   |
10 | from app.services.database_type_service import DatabaseTypeService
11 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
12 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping, PayloadValue
   |                                                                        ^^^^^^^^^^^^
13 | from app.types.converters import as_bool, as_int, as_list_of_str, as_optional_str, as_str
14 | from app.utils.data_validator import DataValidator
   |
help: Move into type-checking block

BLE001 Do not catch blind exception: `Exception`
   --> app/services/form_service/instance_service.py:249:16
    |
247 |                     tags=added,
248 |                 )
249 |         except Exception as exc:
    |                ^^^^^^^^^
250 |             db.session.rollback()
251 |             log_error(
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/password_service.py:3:1
   |
 1 |   """修改密码表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | |
 6 | | from flask_login import current_user
 7 | |
 8 | | from app import db
 9 | | from app.models.user import User
10 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
11 | | from app.types import MutablePayloadDict, PayloadMapping
12 | | from app.types.converters import as_str
13 | | from app.utils.data_validator import sanitize_form_data, validate_password
14 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
15 |
16 |   class ChangePasswordFormService(BaseResourceService[User]):
   |
help: Organize imports

TC001 Move application import `app.types.MutablePayloadDict` into a type-checking block
  --> app/services/form_service/password_service.py:11:23
   |
 9 | from app.models.user import User
10 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
11 | from app.types import MutablePayloadDict, PayloadMapping
   |                       ^^^^^^^^^^^^^^^^^^
12 | from app.types.converters import as_str
13 | from app.utils.data_validator import sanitize_form_data, validate_password
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadMapping` into a type-checking block
  --> app/services/form_service/password_service.py:11:43
   |
 9 | from app.models.user import User
10 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
11 | from app.types import MutablePayloadDict, PayloadMapping
   |                                           ^^^^^^^^^^^^^^
12 | from app.types.converters import as_str
13 | from app.utils.data_validator import sanitize_form_data, validate_password
   |
help: Move into type-checking block

PLR0911 Too many return statements (7 > 6)
  --> app/services/form_service/password_service.py:40:9
   |
38 |         return sanitize_form_data(payload or {})
39 |
40 |     def validate(self, data: MutablePayloadDict, *, resource: User | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
41 |         """校验密码修改数据.
   |

E501 Line too long (131 > 120)
   --> app/services/form_service/password_service.py:124:117
    |
122 | …rce)
123 | …
124 | …"验证失败", message_key=validation.message_key, extra=validation.extra)
    |                                                              ^^^^^^^^^^^
125 | …
126 | …
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/form_service/password_service.py:135:16
    |
133 |             db.session.add(instance)
134 |             db.session.commit()
135 |         except Exception as exc:
    |                ^^^^^^^^^
136 |             db.session.rollback()
137 |             return ServiceResult.fail("密码修改失败,请稍后再试", extra={"exception": str(exc)})
    |

D205 1 blank line required between summary line and description
 --> app/services/form_service/resource_service.py:1:1
  |
1 | / """通用资源表单服务基类.
2 | | ---------------------------------
3 | | 负责封装表单校验、模型赋值、数据库提交与统一的结果返回.
4 | | """
  | |___^
5 |
6 |   from __future__ import annotations
  |
help: Insert single blank line

PLR1711 [*] Useless `return` statement at end of function
   --> app/services/form_service/resource_service.py:173:9
    |
171 |         """
172 |         del instance, data
173 |         return
    |         ^^^^^^
174 |
175 |     def build_context(self, *, resource: ResourceT | None) -> ContextDict:
    |
help: Remove useless `return` statement

E501 Line too long (131 > 120)
   --> app/services/form_service/resource_service.py:207:117
    |
205 | …rce)
206 | …
207 | …"验证失败", message_key=validation.message_key, extra=validation.extra)
    |                                                              ^^^^^^^^^^^
208 | …
209 | …
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/scheduler_job_service.py:20:1
   |
18 |           APSchedulerError = Exception  # type: ignore[misc]
19 |
20 | / from apscheduler.job import Job
21 | | from apscheduler.schedulers.base import BaseScheduler
22 | | from apscheduler.triggers.cron import CronTrigger
23 | | from apscheduler.triggers.date import DateTrigger
24 | | from apscheduler.triggers.interval import IntervalTrigger
25 | |
26 | | from app.constants.scheduler_jobs import BUILTIN_TASK_IDS
27 | | from app.errors import NotFoundError, SystemError, ValidationError
28 | | from app.scheduler import get_scheduler
29 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
30 | | from app.types import MutablePayloadDict, PayloadMapping, ResourceIdentifier, SupportsResourceId
31 | | from app.types.converters import as_int, as_optional_str, as_str
32 | | from app.utils.time_utils import time_utils
33 | | from app.utils.structlog_config import log_error, log_info
   | |__________________________________________________________^
34 |
35 |   TriggerUnion = CronTrigger | IntervalTrigger | DateTrigger
   |
help: Organize imports

TC002 Move third-party import `apscheduler.job.Job` into a type-checking block
  --> app/services/form_service/scheduler_job_service.py:20:29
   |
18 |         APSchedulerError = Exception  # type: ignore[misc]
19 |
20 | from apscheduler.job import Job
   |                             ^^^
21 | from apscheduler.schedulers.base import BaseScheduler
22 | from apscheduler.triggers.cron import CronTrigger
   |
help: Move into type-checking block

D105 Missing docstring in magic method
  --> app/services/form_service/scheduler_job_service.py:45:9
   |
43 |     id: ResourceIdentifier = field(init=False)
44 |
45 |     def __post_init__(self) -> None:
   |         ^^^^^^^^^^^^^
46 |         self.id = str(getattr(self.job, "id", ""))
   |

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/form_service/scheduler_job_service.py:96:26
   |
94 |         """
95 |         job_id = str(resource_id)
96 |         scheduler = cast(BaseScheduler | None, get_scheduler())
   |                          ^^^^^^^^^^^^^^^^^^^^
97 |         if scheduler is None or not scheduler.running:
98 |             log_error("调度器未启动,无法加载任务", module="scheduler")
   |
help: Add quotes

E501 Line too long (128 > 120)
   --> app/services/form_service/scheduler_job_service.py:109:121
    |
107 |         return SchedulerJobResource(scheduler=scheduler, job=job)
108 |
109 |     def validate(self, data: MutablePayloadDict, *, resource: SchedulerJobResource | None) -> ServiceResult[MutablePayloadDict]:
    |                                                                                                                         ^^^^^^^^
110 |         """校验触发器配置是否合法.
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/scheduler_job_service.py:135:24
    |
133 |             return ServiceResult.fail("无效的触发器配置", message_key="VALIDATION_ERROR")
134 |
135 |         payload = cast(MutablePayloadDict, {"trigger": trigger})
    |                        ^^^^^^^^^^^^^^^^^^
136 |         return ServiceResult.ok(payload)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/services/form_service/scheduler_job_service.py:151:24
    |
149 |         scheduler = instance.scheduler
150 |         job = instance.job
151 |         trigger = cast(TriggerUnion, data["trigger"])
    |                        ^^^^^^^^^^^^
152 |         scheduler.modify_job(job.id, trigger=trigger)
    |
help: Add quotes

E501 Line too long (131 > 120)
   --> app/services/form_service/scheduler_job_service.py:177:121
    |
175 |         )
176 |
177 |     def upsert(self, payload: PayloadMapping, resource: SchedulerJobResource | None = None) -> ServiceResult[SchedulerJobResource]:
    |                                                                                                                         ^^^^^^^^^^^
178 |         """更新内置任务的触发器配置.
    |

E501 Line too long (131 > 120)
   --> app/services/form_service/scheduler_job_service.py:191:117
    |
189 | …rce)
190 | …
191 | …"验证失败", message_key=validation.message_key, extra=validation.extra)
    |                                                              ^^^^^^^^^^^
192 | …
193 | …
    |

C901 `_build_trigger` is too complex (25 > 10)
   --> app/services/form_service/scheduler_job_service.py:207:9
    |
205 |         return ServiceResult.ok(resource)
206 |
207 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
208 |         """根据表单数据构建 APScheduler 触发器.
    |

PLR0911 Too many return statements (10 > 6)
   --> app/services/form_service/scheduler_job_service.py:207:9
    |
205 |         return ServiceResult.ok(resource)
206 |
207 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
208 |         """根据表单数据构建 APScheduler 触发器.
    |

PLR0912 Too many branches (21 > 12)
   --> app/services/form_service/scheduler_job_service.py:207:9
    |
205 |         return ServiceResult.ok(resource)
206 |
207 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
208 |         """根据表单数据构建 APScheduler 触发器.
    |

PLR0915 Too many statements (59 > 50)
   --> app/services/form_service/scheduler_job_service.py:207:9
    |
205 |         return ServiceResult.ok(resource)
206 |
207 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
208 |         """根据表单数据构建 APScheduler 触发器.
    |

PLR2004 Magic value used in comparison, consider replacing `7` with a constant variable
   --> app/services/form_service/scheduler_job_service.py:239:30
    |
237 |             year = pick("year")
238 |
239 |             if len(parts) == 7:
    |                              ^
240 |                 second, minute, hour, day, month, day_of_week, year = [
241 |                     pick_value or part
    |

PLR2004 Magic value used in comparison, consider replacing `6` with a constant variable
   --> app/services/form_service/scheduler_job_service.py:248:32
    |
246 |                     )
247 |                 ]
248 |             elif len(parts) == 6:
    |                                ^
249 |                 second, minute, hour, day, month, day_of_week = [
250 |                     pick_value or part
    |

PLR2004 Magic value used in comparison, consider replacing `5` with a constant variable
   --> app/services/form_service/scheduler_job_service.py:257:32
    |
255 |                     )
256 |                 ]
257 |             elif len(parts) == 5:
    |                                ^
258 |                 minute, hour, day, month, day_of_week = [
259 |                     pick_value or part
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/tag_service.py:3:1
   |
 1 |   """标签表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import re
 6 | | from typing import Any, cast
 7 | |
 8 | | from flask_login import current_user
 9 | |
10 | | from app.constants.colors import ThemeColors
11 | | from app.models.tag import Tag
12 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
13 | | from app.types import (
14 | |     CategoryOptionDict,
15 | |     ColorOptionDict,
16 | |     ColorToken,
17 | |     ContextDict,
18 | |     MutablePayloadDict,
19 | |     PayloadMapping,
20 | | )
21 | | from app.types.converters import as_bool, as_str
22 | | from app.utils.data_validator import sanitize_form_data, validate_required_fields
23 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
24 |
25 |   class TagFormService(BaseResourceService[Tag]):
   |
help: Organize imports

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/form_service/tag_service.py:73:27
   |
71 |             return ServiceResult.fail(str(exc))
72 |
73 |         name_value = cast(str, normalized["name"])
   |                           ^^^
74 |         color_value = cast(ColorToken, normalized["color"])
   |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
  --> app/services/form_service/tag_service.py:74:28
   |
73 |         name_value = cast(str, normalized["name"])
74 |         color_value = cast(ColorToken, normalized["color"])
   |                            ^^^^^^^^^^
75 |
76 |         # 代码格式校验
   |
help: Add quotes

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/user_service.py:3:1
   |
 1 |   """用户表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import re
 6 | | from typing import ClassVar
 7 | |
 8 | | from flask_login import current_user
 9 | |
10 | | from app.constants import UserRole
11 | | from app.models.user import User
12 | | from sqlalchemy.orm import Query
13 | |
14 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
15 | | from app.types import ContextDict, MutablePayloadDict, PayloadMapping
16 | | from app.types.converters import as_bool, as_optional_str, as_str
17 | | from app.utils.data_validator import sanitize_form_data
18 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
19 |
20 |   class UserFormService(BaseResourceService[User]):
   |
help: Organize imports

TC002 Move third-party import `sqlalchemy.orm.Query` into a type-checking block
  --> app/services/form_service/user_service.py:12:28
   |
10 | from app.constants import UserRole
11 | from app.models.user import User
12 | from sqlalchemy.orm import Query
   |                            ^^^^^
13 |
14 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
   |
help: Move into type-checking block

TC001 Move application import `app.types.ContextDict` into a type-checking block
  --> app/services/form_service/user_service.py:15:23
   |
14 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
15 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping
   |                       ^^^^^^^^^^^
16 | from app.types.converters import as_bool, as_optional_str, as_str
17 | from app.utils.data_validator import sanitize_form_data
   |
help: Move into type-checking block

TC001 Move application import `app.types.MutablePayloadDict` into a type-checking block
  --> app/services/form_service/user_service.py:15:36
   |
14 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
15 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping
   |                                    ^^^^^^^^^^^^^^^^^^
16 | from app.types.converters import as_bool, as_optional_str, as_str
17 | from app.utils.data_validator import sanitize_form_data
   |
help: Move into type-checking block

TC001 Move application import `app.types.PayloadMapping` into a type-checking block
  --> app/services/form_service/user_service.py:15:56
   |
14 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
15 | from app.types import ContextDict, MutablePayloadDict, PayloadMapping
   |                                                        ^^^^^^^^^^^^^^
16 | from app.types.converters import as_bool, as_optional_str, as_str
17 | from app.utils.data_validator import sanitize_form_data
   |
help: Move into type-checking block

C901 `validate` is too complex (11 > 10)
  --> app/services/form_service/user_service.py:51:9
   |
49 |         return sanitize_form_data(payload or {})
50 |
51 |     def validate(self, data: MutablePayloadDict, *, resource: User | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
52 |         """校验用户数据.
   |

PLR0911 Too many return statements (8 > 6)
  --> app/services/form_service/user_service.py:51:9
   |
49 |         return sanitize_form_data(payload or {})
50 |
51 |     def validate(self, data: MutablePayloadDict, *, resource: User | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
52 |         """校验用户数据.
   |

F821 Undefined name `resource`
   --> app/services/form_service/user_service.py:152:13
    |
150 |         """
151 |         del resource
152 |         del resource
    |             ^^^^^^^^
153 |         return {
154 |             "role_options": [
    |

PLR2004 Magic value used in comparison, consider replacing `8` with a constant variable
   --> app/services/form_service/user_service.py:216:28
    |
215 |         """
216 |         if len(password) < 8:
    |                            ^
217 |             return "密码长度至少8位"
218 |         if not any(char.isupper() for char in password):
    |

C901 `create_instances` is too complex (11 > 10)
  --> app/services/instances/batch_service.py:60:9
   |
58 |     """
59 |
60 |     def create_instances(
   |         ^^^^^^^^^^^^^^^^
61 |         self,
62 |         instances_data: list[dict[str, Any]],
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/instances/batch_service.py:299:13
    |
297 |             stats["deleted_sync_data"] = stats["deleted_account_permissions"]
298 |
299 |             return stats
    |             ^^^^^^^^^^^^
300 |         except SQLAlchemyError as exc:
301 |             db.session.rollback()
    |

TC002 Move third-party import `sqlalchemy.orm.Query` into a type-checking block
  --> app/services/ledgers/database_ledger_service.py:13:28
   |
12 | from sqlalchemy import and_, func, or_
13 | from sqlalchemy.orm import Query, Session
   |                            ^^^^^
14 |
15 | from app import db
   |
help: Move into type-checking block

TC002 Move third-party import `sqlalchemy.orm.Session` into a type-checking block
  --> app/services/ledgers/database_ledger_service.py:13:35
   |
12 | from sqlalchemy import and_, func, or_
13 | from sqlalchemy.orm import Query, Session
   |                                   ^^^^^^^
14 |
15 | from app import db
   |
help: Move into type-checking block

TRY300 Consider moving this statement to an `else` block
   --> app/services/ledgers/database_ledger_service.py:98:13
    |
 96 |               ]
 97 |
 98 | /             return {
 99 | |                 "items": rows,
100 | |                 "total": total,
101 | |                 "page": page,
102 | |                 "per_page": per_page,
103 | |             }
    | |_____________^
104 |           except Exception as exc:
105 |               log_error(
    |

PLR2004 Magic value used in comparison, consider replacing `6` with a constant variable
   --> app/services/ledgers/database_ledger_service.py:423:27
    |
421 |         delay_hours = (now - collected_at).total_seconds() / 3600
422 |
423 |         if delay_hours <= 6:
    |                           ^
424 |             return {"value": SyncStatus.COMPLETED, "label": "已更新", "variant": "success"}
425 |         if delay_hours <= 48:
    |

PLR2004 Magic value used in comparison, consider replacing `48` with a constant variable
   --> app/services/ledgers/database_ledger_service.py:425:27
    |
423 |         if delay_hours <= 6:
424 |             return {"value": SyncStatus.COMPLETED, "label": "已更新", "variant": "success"}
425 |         if delay_hours <= 48:
    |                           ^^
426 |             return {"value": SyncStatus.RUNNING, "label": "待刷新", "variant": "warning"}
427 |         return {"value": SyncStatus.FAILED, "label": "超时", "variant": "danger"}
    |

PLR2004 Magic value used in comparison, consider replacing `1024` with a constant variable
   --> app/services/ledgers/database_ledger_service.py:443:23
    |
441 |         if size_mb is None:
442 |             return "未采集"
443 |         if size_mb >= 1024:
    |                       ^^^^
444 |             size_gb = size_mb / 1024
445 |             return f"{size_gb:.2f} GB"
    |

D205 1 blank line required between summary line and description
 --> app/services/partition_management_service.py:1:1
  |
1 | / """分区管理服务
2 | | 负责创建、清理与查询数据库容量相关表的分区信息.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/services/partition_management_service.py:50:9
   |
48 |     """PostgreSQL 分区管理服务."""
49 |
50 |     def __init__(self) -> None:
   |         ^^^^^^^^
51 |         self.tables: dict[str, dict[str, str]] = {
52 |             "stats": {
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/partition_management_service.py:187:20
    |
185 |                     exception=exc,
186 |                 )
187 |             except Exception as exc:  # pragma: no cover - 防御性分支
    |                    ^^^^^^^^^
188 |                 failures.append(
189 |                     {
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/partition_management_service.py:285:20
    |
283 |                     issues=exc.extra,
284 |                 )
285 |             except Exception as exc:
    |                    ^^^^^^^^^
286 |                 issues.append({"month": target_month.isoformat(), "message": str(exc)})
287 |                 log_error(
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/partition_management_service.py:376:24
    |
374 |                         exception=exc,
375 |                     )
376 |                 except Exception as exc:  # pragma: no cover - 防御性分支
    |                        ^^^^^^^^^
377 |                     failures.append(
378 |                         {
    |

PLR2004 Magic value used in comparison, consider replacing `12` with a constant variable
   --> app/services/partition_management_service.py:438:33
    |
436 |         """
437 |         month_start = target_date.replace(day=1)
438 |         if month_start.month == 12:
    |                                 ^^
439 |             month_end = month_start.replace(year=month_start.year + 1, month=1)
440 |         else:
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/partition_management_service.py:500:20
    |
498 |                     },
499 |                 )
500 |             except Exception as exc:  # pragma: no cover - 单条记录失败不影响总体
    |                    ^^^^^^^^^
501 |                 log_warning(
502 |                     "处理单个分区信息失败",
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/partition_management_service.py:624:17
    |
623 |         """
624 |         query = f"SELECT COUNT(*) FROM {partition_name};"
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
625 |         try:
626 |             result = db.session.execute(text(query)).scalar()
    |

PLR2004 Magic value used in comparison, consider replacing `1024` with a constant variable
   --> app/services/partition_management_service.py:734:25
    |
733 |         """
734 |         if size_bytes < 1024:
    |                         ^^^^
735 |             return f"{size_bytes} B"
736 |         if size_bytes < 1024**2:
    |

PYI034 `__enter__` methods in classes like `_RollbackContext` usually return `self` at runtime
   --> app/services/partition_management_service.py:755:17
    |
753 |         """
754 |         class _RollbackContext(contextlib.AbstractContextManager[None]):
755 |             def __enter__(self) -> _RollbackContext:
    |                 ^^^^^^^^^
756 |                 return self
    |
help: Use `Self` as return type

INP001 File `app/services/statistics/account_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/account_statistics_service.py:1:1

INP001 File `app/services/statistics/database_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/database_statistics_service.py:1:1

TRY300 Consider moving this statement to an `else` block
  --> app/services/statistics/database_statistics_service.py:67:9
   |
65 |           deleted_databases = deleted_databases.scalar() or 0
66 |
67 | /         return {
68 | |             "total_databases": total_databases,
69 | |             "active_databases": active_databases,
70 | |             "inactive_databases": inactive_databases,
71 | |             "deleted_databases": deleted_databases,
72 | |         }
   | |_________^
73 |       except Exception as exc:
74 |           log_error("获取数据库统计失败", module="database_statistics", exception=exc)
   |

C901 `fetch_aggregations` is too complex (12 > 10)
  --> app/services/statistics/database_statistics_service.py:94:5
   |
94 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
95 |     *,
96 |     instance_id: int | None,
   |

PLR0913 Too many arguments in function definition (11 > 5)
  --> app/services/statistics/database_statistics_service.py:94:5
   |
94 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
95 |     *,
96 |     instance_id: int | None,
   |

PLR0912 Too many branches (13 > 12)
  --> app/services/statistics/database_statistics_service.py:94:5
   |
94 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
95 |     *,
96 |     instance_id: int | None,
   |

E501 Line too long (129 > 120)
   --> app/services/statistics/database_statistics_service.py:199:121
    |
197 |             pair_values = [(row.instance_id, row.database_name) for row in top_pairs]
198 |             aggregations = (
199 |                 query.filter(tuple_(DatabaseSizeAggregation.instance_id, DatabaseSizeAggregation.database_name).in_(pair_values))
    |                                                                                                                         ^^^^^^^^^
200 |                 .order_by(DatabaseSizeAggregation.period_start.asc())
201 |                 .all()
    |

C901 `fetch_aggregation_summary` is too complex (11 > 10)
   --> app/services/statistics/database_statistics_service.py:235:5
    |
235 | def fetch_aggregation_summary(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
236 |     *,
237 |     instance_id: int | None,
    |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/services/statistics/database_statistics_service.py:235:5
    |
235 | def fetch_aggregation_summary(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
236 |     *,
237 |     instance_id: int | None,
    |

INP001 File `app/services/statistics/instance_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/instance_statistics_service.py:1:1

TRY300 Consider moving this statement to an `else` block
  --> app/services/statistics/instance_statistics_service.py:55:9
   |
53 |           normal_instances = active_instances
54 |
55 | /         return {
56 | |             "total_instances": total_instances,
57 | |             "active_instances": active_instances,
58 | |             "normal_instances": normal_instances,
59 | |             "disabled_instances": disabled_instances,
60 | |             "deleted_instances": deleted_instances,
61 | |         }
   | |_________^
62 |       except Exception as exc:
63 |           log_error("获取实例汇总失败", module="instance_statistics", exception=exc)
   |

PLC0415 `import` should be at the top-level of a file
  --> app/services/statistics/instance_statistics_service.py:89:9
   |
87 |     """
88 |     try:
89 |         from app.models.instance_size_stat import InstanceSizeStat
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
90 |
91 |         recent_date = time_utils.now_china().date() - timedelta(days=recent_days)
   |

INP001 File `app/services/statistics/log_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/log_statistics_service.py:1:1

BLE001 Do not catch blind exception: `Exception`
   --> app/services/statistics/log_statistics_service.py:126:12
    |
124 |             )
125 |
126 |     except Exception as exc:
    |            ^^^^^^^^^
127 |         log_error("获取日志趋势数据失败", module="log_statistics", exception=exc)
128 |         return []
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/services/statistics/log_statistics_service.py:159:12
    |
158 |         return [{"level": stat.level.value, "count": stat.count} for stat in level_stats]
159 |     except Exception as exc:
    |            ^^^^^^^^^
160 |         log_error("获取日志级别分布失败", module="log_statistics", exception=exc)
161 |         return []
    |

INP001 File `app/services/statistics/partition_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/partition_statistics_service.py:1:1

D205 1 blank line required between summary line and description
 --> app/services/sync_session_service.py:1:1
  |
1 | / """鲸落 - 同步会话服务
2 | | 管理同步会话和实例记录的业务逻辑.
3 | | """
  | |___^
4 |
5 |   from sqlalchemy import func
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/services/sync_session_service.py:28:9
   |
26 |     """
27 |
28 |     def __init__(self) -> None:
   |         ^^^^^^^^
29 |         self.system_logger = get_system_logger()
30 |         self.sync_logger = get_sync_logger()
   |

E501 Line too long (123 > 120)
  --> app/services/sync_session_service.py:59:121
   |
57 |         return clean_value(sync_details)
58 |
59 |     def create_session(self, sync_type: str, sync_category: str = "account", created_by: int | None = None) -> SyncSession:
   |                                                                                                                         ^^^
60 |         """创建同步会话.
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/sync_session_service.py:93:13
   |
91 |             )
92 |
93 |             return session
   |             ^^^^^^^^^^^^^^
94 |         except Exception as e:
95 |             db.session.rollback()
   |

E501 Line too long (137 > 120)
   --> app/services/sync_session_service.py:105:121
    |
103 | …
104 | …
105 | …s: list[int], sync_category: str = "account") -> list[SyncInstanceRecord]:
    |                                                           ^^^^^^^^^^^^^^^^^
106 | …
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:150:13
    |
148 |             )
149 |
150 |             return records
    |             ^^^^^^^^^^^^^^
151 |         except Exception as e:
152 |             db.session.rollback()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:190:13
    |
188 |             )
189 |
190 |             return True
    |             ^^^^^^^^^^^
191 |         except Exception as e:
192 |             db.session.rollback()
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/sync_session_service.py:201:9
    |
199 |             return False
200 |
201 |     def complete_instance_sync(
    |         ^^^^^^^^^^^^^^^^^^^^^^
202 |         self,
203 |         record_id: int,
    |

F821 Undefined name `Any`
   --> app/services/sync_session_service.py:208:33
    |
206 |         items_updated: int = 0,
207 |         items_deleted: int = 0,
208 |         sync_details: dict[str, Any] | None = None,
    |                                 ^^^
209 |     ) -> bool:
210 |         """完成实例同步.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:255:13
    |
253 |             )
254 |
255 |             return True
    |             ^^^^^^^^^^^
256 |         except Exception as e:
257 |             db.session.rollback()
    |

F821 Undefined name `Any`
   --> app/services/sync_session_service.py:266:94
    |
264 |             return False
265 |
266 |     def fail_instance_sync(self, record_id: int, error_message: str, sync_details: dict[str, Any] | None = None) -> bool:
    |                                                                                              ^^^
267 |         """标记实例同步失败.
    |

E501 Line too long (121 > 120)
   --> app/services/sync_session_service.py:266:121
    |
264 |             return False
265 |
266 |     def fail_instance_sync(self, record_id: int, error_message: str, sync_details: dict[str, Any] | None = None) -> bool:
    |                                                                                                                         ^
267 |         """标记实例同步失败.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:300:13
    |
298 |             )
299 |
300 |             return True
    |             ^^^^^^^^^^^
301 |         except Exception as e:
302 |             db.session.rollback()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:493:13
    |
491 |                 self.sync_logger.info("取消同步会话", module="sync_session", session_id=session_id)
492 |
493 |             return True
    |             ^^^^^^^^^^^
494 |         except Exception as e:
495 |             db.session.rollback()
    |

PLR0915 Too many statements (66 > 50)
  --> app/tasks/accounts_sync_tasks.py:13:5
   |
13 | def sync_accounts(*, manual_run: bool = False, created_by: int | None = None, **_: object) -> None:
   |     ^^^^^^^^^^^^^
14 |     """同步账户任务 - 同步所有实例的账户信息.
   |

E501 Line too long (136 > 120)
   --> app/tasks/accounts_sync_tasks.py:113:121
    |
111 | …         continue
112 | …     except PermissionSyncError as permission_error:
113 | …         sync_session_service.fail_instance_sync(record.id, str(permission_error), sync_details=permission_error.summary)
    |                                                                                                           ^^^^^^^^^^^^^^^^
114 | …         sync_logger.exception(
115 | …             "账户同步权限阶段失败",
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/tasks/accounts_sync_tasks.py:167:33
    |
165 |                     sync_session_service.fail_instance_sync(record.id, str(exc))
166 |
167 |                     sync_logger.error(
    |                                 ^^^^^
168 |                         "实例账户同步异常",
169 |                         module="accounts_sync",
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/tasks/accounts_sync_tasks.py:203:25
    |
201 |                 db.session.commit()
202 |
203 |             sync_logger.error(
    |                         ^^^^^
204 |                 "账户同步任务失败",
205 |                 module="accounts_sync",
    |

D205 1 blank line required between summary line and description
 --> app/tasks/capacity_aggregation_tasks.py:1:1
  |
1 | / """数据库大小统计聚合定时任务
2 | | 负责计算每周、每月、每季度的统计聚合数据.
3 | | """
  | |___^
4 |
5 |   from collections.abc import Sequence
  |
help: Insert single blank line

C901 `calculate_database_size_aggregations` is too complex (24 > 10)
   --> app/tasks/capacity_aggregation_tasks.py:114:5
    |
114 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
115 |     *,
116 |     manual_run: bool = False,
    |

PLR0912 Too many branches (28 > 12)
   --> app/tasks/capacity_aggregation_tasks.py:114:5
    |
114 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
115 |     *,
116 |     manual_run: bool = False,
    |

PLR0915 Too many statements (111 > 50)
   --> app/tasks/capacity_aggregation_tasks.py:114:5
    |
114 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
115 |     *,
116 |     manual_run: bool = False,
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_aggregation_tasks.py:531:13
    |
529 |                 message=result.get("message"),
530 |             )
531 |             return result
    |             ^^^^^^^^^^^^^
532 |
533 |         except Exception as exc:
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/tasks/capacity_aggregation_tasks.py:533:16
    |
531 |             return result
532 |
533 |         except Exception as exc:
    |                ^^^^^^^^^
534 |             log_error(
535 |                 "计算实例统计聚合失败",
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_aggregation_tasks.py:584:13
    |
582 |             )
583 |
584 |             return result
    |             ^^^^^^^^^^^^^
585 |
586 |         except Exception as exc:
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/tasks/capacity_aggregation_tasks.py:586:16
    |
584 |             return result
585 |
586 |         except Exception as exc:
    |                ^^^^^^^^^
587 |             log_error(
588 |                 "计算指定周期统计聚合失败",
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/tasks/capacity_aggregation_tasks.py:638:16
    |
636 |             }
637 |
638 |         except Exception as exc:
    |                ^^^^^^^^^
639 |             log_error(
640 |                 "获取聚合状态失败",
    |

PLR2004 Magic value used in comparison, consider replacing `23` with a constant variable
   --> app/tasks/capacity_aggregation_tasks.py:667:96
    |
665 |         # 检查聚合时间配置
666 |         aggregation_hour = getattr(Config, "AGGREGATION_HOUR", 4)
667 |         if not isinstance(aggregation_hour, int) or aggregation_hour < 0 or aggregation_hour > 23:
    |                                                                                                ^^
668 |             config_issues.append("聚合时间配置无效,应为0-23之间的整数")
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/tasks/capacity_aggregation_tasks.py:683:12
    |
681 |         }
682 |
683 |     except Exception as exc:
    |            ^^^^^^^^^
684 |         log_error(
685 |             "验证聚合配置失败",
    |

D205 1 blank line required between summary line and description
 --> app/tasks/capacity_collection_tasks.py:1:1
  |
1 | / """数据库大小采集定时任务
2 | | 负责每日自动采集所有数据库实例的大小信息.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

C901 `collect_database_sizes` is too complex (12 > 10)
  --> app/tasks/capacity_collection_tasks.py:19:5
   |
19 | def collect_database_sizes() -> dict[str, Any]:
   |     ^^^^^^^^^^^^^^^^^^^^^^
20 |     """容量同步定时任务.
   |

PLR0915 Too many statements (97 > 50)
  --> app/tasks/capacity_collection_tasks.py:19:5
   |
19 | def collect_database_sizes() -> dict[str, Any]:
   |     ^^^^^^^^^^^^^^^^^^^^^^
20 |     """容量同步定时任务.
   |

E501 Line too long (140 > 120)
  --> app/tasks/capacity_collection_tasks.py:71:121
   |
69 | …
70 | …]
71 | …session.session_id, instance_ids, sync_category=SyncCategory.CAPACITY.value)
   |                                                          ^^^^^^^^^^^^^^^^^^^^
72 | …
   |

E501 Line too long (124 > 120)
   --> app/tasks/capacity_collection_tasks.py:150:121
    |
148 | …                     items_synced=0,
149 | …                     items_created=inventory_result.get("created", 0),
150 | …                     items_updated=inventory_result.get("refreshed", 0) + inventory_result.get("reactivated", 0),
    |                                                                                                               ^^^^
151 | …                     items_deleted=inventory_result.get("deactivated", 0),
152 | …                     sync_details={
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:316:13
    |
314 |             )
315 |
316 |             return result
    |             ^^^^^^^^^^^^^
317 |
318 |         except Exception as e:
    |

C901 `collect_specific_instance_database_sizes` is too complex (11 > 10)
   --> app/tasks/capacity_collection_tasks.py:339:5
    |
339 | def collect_specific_instance_database_sizes(instance_id: int) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
340 |     """采集指定实例的数据库大小信息.
    |

PLR0911 Too many return statements (9 > 6)
   --> app/tasks/capacity_collection_tasks.py:339:5
    |
339 | def collect_specific_instance_database_sizes(instance_id: int) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
340 |     """采集指定实例的数据库大小信息.
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/tasks/capacity_collection_tasks.py:551:24
    |
549 |                     else:
550 |                         errors.append(f"实例 {instance.name}: {result['message']}")
551 |                 except Exception as e:
    |                        ^^^^^^^^^
552 |                     errors.append(f"实例 {instance.name}: {e!s}")
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:554:13
    |
552 |                       errors.append(f"实例 {instance.name}: {e!s}")
553 |
554 | /             return {
555 | |                 "success": True,
556 | |                 "message": f"{db_type} 类型数据库大小采集完成",
557 | |                 "instances_processed": total_processed,
558 | |                 "total_size_mb": total_size_mb,
559 | |                 "errors": errors,
560 | |             }
    | |_____________^
561 |
562 |           except Exception as e:
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:640:9
    |
638 |           DatabaseSizeCollectorService()
639 |
640 | /         return {
641 | |             "success": True,
642 | |             "config": config_checks,
643 | |             "service_available": True,
644 | |             "message": "配置验证通过",
645 | |         }
    | |_________^
646 |
647 |       except Exception as e:
    |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/log_cleanup_tasks.py:36:13
   |
34 |             cleaned_files = _cleanup_temp_files()
35 |
36 |             from app.models.sync_instance_record import SyncInstanceRecord
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
37 |             from app.models.sync_session import SyncSession
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/log_cleanup_tasks.py:37:13
   |
36 |             from app.models.sync_instance_record import SyncInstanceRecord
37 |             from app.models.sync_session import SyncSession
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
38 |
39 |             deleted_sync_sessions = SyncSession.query.filter(SyncSession.created_at < cutoff_date).delete()
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
  --> app/tasks/log_cleanup_tasks.py:61:25
   |
59 |         except Exception as exc:
60 |             db.session.rollback()
61 |             task_logger.error(
   |                         ^^^^^
62 |                 "定时任务清理失败",
63 |                 module="task",
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/tasks/log_cleanup_tasks.py:99:12
    |
 97 |                         cleaned_count += 1
 98 |
 99 |     except Exception as exc:
    |            ^^^^^^^^^
100 |         get_task_logger().warning(f"清理临时文件时出错: {exc}")
    |

D205 1 blank line required between summary line and description
 --> app/tasks/partition_management_tasks.py:1:1
  |
1 | / """分区管理定时任务
2 | | 负责自动创建、清理和监控数据库大小统计表的分区.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

TRY300 Consider moving this statement to an `else` block
  --> app/tasks/partition_management_tasks.py:56:9
   |
54 |             message="分区创建任务已完成",
55 |         )
56 |         return payload
   |         ^^^^^^^^^^^^^^
57 |     except Exception as exc:
58 |         app_error = _as_app_error(exc)
   |

BLE001 Do not catch blind exception: `Exception`
  --> app/tasks/partition_management_tasks.py:57:12
   |
55 |         )
56 |         return payload
57 |     except Exception as exc:
   |            ^^^^^^^^^
58 |         app_error = _as_app_error(exc)
59 |         log_error("分区创建任务失败", module=MODULE, exception=exc)
   |

TRY300 Consider moving this statement to an `else` block
  --> app/tasks/partition_management_tasks.py:93:9
   |
91 |             message="旧分区清理任务已完成",
92 |         )
93 |         return payload
   |         ^^^^^^^^^^^^^^
94 |     except Exception as exc:
95 |         app_error = _as_app_error(exc)
   |

BLE001 Do not catch blind exception: `Exception`
  --> app/tasks/partition_management_tasks.py:94:12
   |
92 |         )
93 |         return payload
94 |     except Exception as exc:
   |            ^^^^^^^^^
95 |         app_error = _as_app_error(exc)
96 |         log_error("旧分区清理任务失败", module=MODULE, exception=exc)
   |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/partition_management_tasks.py:157:9
    |
155 |             message="分区健康监控完成",
156 |         )
157 |         return payload
    |         ^^^^^^^^^^^^^^
158 |     except Exception as exc:
159 |         app_error = _as_app_error(exc)
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/tasks/partition_management_tasks.py:158:12
    |
156 |         )
157 |         return payload
158 |     except Exception as exc:
    |            ^^^^^^^^^
159 |         app_error = _as_app_error(exc)
160 |         log_error("分区健康监控任务失败", module=MODULE, exception=exc)
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/types/__init__.py:6:1
   |
 4 |   """
 5 |
 6 | / from app.types.accounts import PermissionSnapshot, RawAccount, RemoteAccount
 7 | | from app.types.classification import ClassificationEngineResult, RuleExpression
 8 | | from app.types.resources import (
 9 | |     ResourceContext,
10 | |     ResourceIdentifier,
11 | |     ResourceInstance,
12 | |     ResourcePayload,
13 | |     SupportsResourceId,
14 | |     TemplateContext,
15 | | )
16 | | from app.types.structures import (
17 | |     CategoryOptionDict,
18 | |     ColorHex,
19 | |     ColorName,
20 | |     ColorOptionDict,
21 | |     ColorToken,
22 | |     ContextDict,
23 | |     ContextMapping,
24 | |     ContextValue,
25 | |     CssClassName,
26 | |     FormErrorMapping,
27 | |     JsonDict,
28 | |     JsonValue,
29 | |     LoggerExtra,
30 | |     LoggerProtocol,
31 | |     MutablePayloadDict,
32 | |     NumericLike,
33 | |     PayloadMapping,
34 | |     PayloadValue,
35 | |     StructlogEventDict,
36 | | )
37 | | from app.types.query_protocols import QueryProtocol
38 | | from app.types.sync import (
39 | |     CollectionSummary,
40 | |     DiffEntry,
41 | |     InventorySummary,
42 | |     OtherDiffEntry,
43 | |     PermissionDiffPayload,
44 | |     PrivilegeDiffEntry,
45 | |     RemoteAccountMap,
46 | |     SyncConnection,
47 | |     SyncOperationResult,
48 | |     SyncStagesSummary,
49 | |     SyncSummary,
50 | | )
   | |_^
51 |
52 |   __all__ = [
   |
help: Organize imports

RUF022 [*] `__all__` is not sorted
  --> app/types/__init__.py:52:11
   |
50 |   )
51 |
52 |   __all__ = [
   |  ___________^
53 | |     "PermissionSnapshot",
54 | |     "RemoteAccount",
55 | |     "RawAccount",
56 | |     "ClassificationEngineResult",
57 | |     "RuleExpression",
58 | |     "SyncConnection",
59 | |     "SyncSummary",
60 | |     "RemoteAccountMap",
61 | |     "PermissionDiffPayload",
62 | |     "DiffEntry",
63 | |     "PrivilegeDiffEntry",
64 | |     "OtherDiffEntry",
65 | |     "InventorySummary",
66 | |     "CollectionSummary",
67 | |     "SyncStagesSummary",
68 | |     "SyncOperationResult",
69 | |     "ResourceContext",
70 | |     "ResourceIdentifier",
71 | |     "ResourceInstance",
72 | |     "ResourcePayload",
73 | |     "SupportsResourceId",
74 | |     "TemplateContext",
75 | |     "CategoryOptionDict",
76 | |     "ColorHex",
77 | |     "ColorName",
78 | |     "ColorOptionDict",
79 | |     "ColorToken",
80 | |     "ContextDict",
81 | |     "ContextMapping",
82 | |     "ContextValue",
83 | |     "CssClassName",
84 | |     "FormErrorMapping",
85 | |     "JsonDict",
86 | |     "JsonValue",
87 | |     "LoggerExtra",
88 | |     "LoggerProtocol",
89 | |     "MutablePayloadDict",
90 | |     "NumericLike",
91 | |     "PayloadMapping",
92 | |     "PayloadValue",
93 | |     "StructlogEventDict",
94 | |     "QueryProtocol",
95 | | ]
   | |_^
   |
help: Apply an isort-style sorting to `__all__`

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> app/types/accounts.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Mapping
  |                             ^^^^^^^
6 | from typing import TypedDict
  |
help: Move into type-checking block

RUF022 [*] `__all__` is not sorted
  --> app/types/accounts.py:37:11
   |
35 | RawAccount = dict[str, JsonValue | JsonDict | PermissionSnapshot]
36 |
37 | __all__ = ["PermissionSnapshot", "RemoteAccount", "RawAccount"]
   |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
help: Apply an isort-style sorting to `__all__`

I001 [*] Import block is un-sorted or un-formatted
 --> app/types/classification.py:3:1
  |
1 |   """账户分类相关类型定义."""
2 |
3 | / from __future__ import annotations
4 | |
5 | | from typing import Mapping, TypedDict, TypeAlias
6 | |
7 | | from app.types.structures import JsonDict, JsonValue
  | |____________________________________________________^
8 |
9 |   RuleExpression: TypeAlias = Mapping[str, JsonValue]
  |
help: Organize imports

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> app/types/classification.py:5:1
  |
3 | from __future__ import annotations
4 |
5 | from typing import Mapping, TypedDict, TypeAlias
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
6 |
7 | from app.types.structures import JsonDict, JsonValue
  |
help: Import from `collections.abc`

RUF022 [*] `__all__` is not sorted
  --> app/types/classification.py:28:11
   |
28 | __all__ = ["RuleExpression", "ClassificationEngineResult"]
   |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
help: Apply an isort-style sorting to `__all__`

TC001 Move application import `app.types.structures.PayloadValue` into a type-checking block
  --> app/types/converters.py:11:34
   |
 9 | from collections.abc import Mapping, Sequence
10 |
11 | from app.types.structures import PayloadValue
   |                                  ^^^^^^^^^^^^
12 |
13 | _STRING_LIKE_TYPES = (str, bytes, bytearray)
   |
help: Move into type-checking block

D103 Missing docstring in public function
  --> app/types/converters.py:24:5
   |
24 | def as_str(value: PayloadValue | None, *, default: str = "") -> str:
   |     ^^^^^^
25 |     base = _unwrap_sequence(value)
26 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:35:5
   |
35 | def as_optional_str(value: PayloadValue | None) -> str | None:
   |     ^^^^^^^^^^^^^^^
36 |     cleaned = as_str(value, default="").strip()
37 |     return cleaned or None
   |

PLR0911 Too many return statements (7 > 6)
  --> app/types/converters.py:40:5
   |
40 | def as_int(value: PayloadValue | None, *, default: int | None = None) -> int | None:
   |     ^^^^^^
41 |     base = _unwrap_sequence(value)
42 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:40:5
   |
40 | def as_int(value: PayloadValue | None, *, default: int | None = None) -> int | None:
   |     ^^^^^^
41 |     base = _unwrap_sequence(value)
42 |     if base is None:
   |

PLR0911 Too many return statements (7 > 6)
  --> app/types/converters.py:59:5
   |
59 | def as_bool(value: PayloadValue | None, *, default: bool = False) -> bool:
   |     ^^^^^^^
60 |     base = _unwrap_sequence(value)
61 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:59:5
   |
59 | def as_bool(value: PayloadValue | None, *, default: bool = False) -> bool:
   |     ^^^^^^^
60 |     base = _unwrap_sequence(value)
61 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:77:5
   |
77 | def as_list_of_str(value: PayloadValue | None) -> list[str]:
   |     ^^^^^^^^^^^^^^
78 |     base = _unwrap_sequence(value)
79 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:93:5
   |
93 | def ensure_mapping(value: PayloadValue | None) -> Mapping[str, PayloadValue] | None:
   |     ^^^^^^^^^^^^^^
94 |     base = _unwrap_sequence(value)
95 |     if isinstance(base, Mapping):
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:13:9
   |
11 |     """最小化的 SQLAlchemy Query 协议,用于类型标注."""
12 |
13 |     def join(self, *args: object, **kwargs: object) -> "QueryProtocol[T_co]":
   |         ^^^^
14 |         ...
   |

UP037 [*] Remove quotes from type annotation
  --> app/types/query_protocols.py:13:56
   |
11 |     """最小化的 SQLAlchemy Query 协议,用于类型标注."""
12 |
13 |     def join(self, *args: object, **kwargs: object) -> "QueryProtocol[T_co]":
   |                                                        ^^^^^^^^^^^^^^^^^^^^^
14 |         ...
   |
help: Remove quotes

D102 Missing docstring in public method
  --> app/types/query_protocols.py:16:9
   |
14 |         ...
15 |
16 |     def filter(self, *args: object, **kwargs: object) -> "QueryProtocol[T_co]":
   |         ^^^^^^
17 |         ...
   |

UP037 [*] Remove quotes from type annotation
  --> app/types/query_protocols.py:16:58
   |
14 |         ...
15 |
16 |     def filter(self, *args: object, **kwargs: object) -> "QueryProtocol[T_co]":
   |                                                          ^^^^^^^^^^^^^^^^^^^^^
17 |         ...
   |
help: Remove quotes

D102 Missing docstring in public method
  --> app/types/query_protocols.py:19:9
   |
17 |         ...
18 |
19 |     def filter_by(self, **kwargs: object) -> "QueryProtocol[T_co]":
   |         ^^^^^^^^^
20 |         ...
   |

UP037 [*] Remove quotes from type annotation
  --> app/types/query_protocols.py:19:46
   |
17 |         ...
18 |
19 |     def filter_by(self, **kwargs: object) -> "QueryProtocol[T_co]":
   |                                              ^^^^^^^^^^^^^^^^^^^^^
20 |         ...
   |
help: Remove quotes

D102 Missing docstring in public method
  --> app/types/query_protocols.py:22:9
   |
20 |         ...
21 |
22 |     def order_by(self, *args: object, **kwargs: object) -> "QueryProtocol[T_co]":
   |         ^^^^^^^^
23 |         ...
   |

UP037 [*] Remove quotes from type annotation
  --> app/types/query_protocols.py:22:60
   |
20 |         ...
21 |
22 |     def order_by(self, *args: object, **kwargs: object) -> "QueryProtocol[T_co]":
   |                                                            ^^^^^^^^^^^^^^^^^^^^^
23 |         ...
   |
help: Remove quotes

D102 Missing docstring in public method
  --> app/types/query_protocols.py:25:9
   |
23 |         ...
24 |
25 |     def limit(self, count: int) -> "QueryProtocol[T_co]":
   |         ^^^^^
26 |         ...
   |

UP037 [*] Remove quotes from type annotation
  --> app/types/query_protocols.py:25:36
   |
23 |         ...
24 |
25 |     def limit(self, count: int) -> "QueryProtocol[T_co]":
   |                                    ^^^^^^^^^^^^^^^^^^^^^
26 |         ...
   |
help: Remove quotes

D102 Missing docstring in public method
  --> app/types/query_protocols.py:28:9
   |
26 |         ...
27 |
28 |     def all(self) -> list[T_co]:
   |         ^^^
29 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:31:9
   |
29 |         ...
30 |
31 |     def count(self) -> int:
   |         ^^^^^
32 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:34:9
   |
32 |         ...
33 |
34 |     def first(self) -> T_co | None:
   |         ^^^^^
35 |         ...
   |

E501 Line too long (134 > 120)
  --> app/types/structures.py:39:121
   |
37 |     label: str
38 |
39 | ContextValue: TypeAlias = ScalarValue | Sequence["ContextValue"] | Mapping[str, "ContextValue"] | ColorOptionDict | CategoryOptionDict
   |                                                                                                                         ^^^^^^^^^^^^^^
40 | ContextMapping: TypeAlias = Mapping[str, ContextValue]
41 | ContextDict: TypeAlias = dict[str, ContextValue]
   |

D102 Missing docstring in public method
  --> app/types/structures.py:51:9
   |
49 |     """结构化日志协议,统一 logger 的最小接口."""
50 |
51 |     def bind(self, **kwargs: JsonValue) -> "LoggerProtocol":
   |         ^^^^
52 |         ...
   |

UP037 [*] Remove quotes from type annotation
  --> app/types/structures.py:51:44
   |
49 |     """结构化日志协议,统一 logger 的最小接口."""
50 |
51 |     def bind(self, **kwargs: JsonValue) -> "LoggerProtocol":
   |                                            ^^^^^^^^^^^^^^^^
52 |         ...
   |
help: Remove quotes

D102 Missing docstring in public method
  --> app/types/structures.py:54:9
   |
52 |         ...
53 |
54 |     def new(self, **kwargs: JsonValue) -> "LoggerProtocol":
   |         ^^^
55 |         ...
   |

UP037 [*] Remove quotes from type annotation
  --> app/types/structures.py:54:43
   |
52 |         ...
53 |
54 |     def new(self, **kwargs: JsonValue) -> "LoggerProtocol":
   |                                           ^^^^^^^^^^^^^^^^
55 |         ...
   |
help: Remove quotes

D102 Missing docstring in public method
  --> app/types/structures.py:57:9
   |
55 |         ...
56 |
57 |     def debug(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^
58 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:60:9
   |
58 |         ...
59 |
60 |     def info(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^
61 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:63:9
   |
61 |         ...
62 |
63 |     def warning(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^^^
64 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:66:9
   |
64 |         ...
65 |
66 |     def error(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^
67 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:69:9
   |
67 |         ...
68 |
69 |     def exception(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^^^^^
70 |         ...
   |

RUF022 [*] `__all__` is not sorted
  --> app/types/structures.py:72:11
   |
70 |           ...
71 |
72 |   __all__ = [
   |  ___________^
73 | |     "ScalarValue",
74 | |     "PayloadValue",
75 | |     "PayloadMapping",
76 | |     "MutablePayloadDict",
77 | |     "ContextValue",
78 | |     "ContextMapping",
79 | |     "ContextDict",
80 | |     "FormErrorMapping",
81 | |     "NumericLike",
82 | |     "ColorToken",
83 | |     "ColorHex",
84 | |     "ColorName",
85 | |     "CssClassName",
86 | |     "ColorOptionDict",
87 | |     "CategoryOptionDict",
88 | |     "JsonValue",
89 | |     "JsonDict",
90 | |     "StructlogEventDict",
91 | |     "LoggerExtra",
92 | |     "LoggerProtocol",
93 | | ]
   | |_^
   |
help: Apply an isort-style sorting to `__all__`

I001 [*] Import block is un-sorted or un-formatted
 --> app/types/sync.py:3:1
  |
1 |   """账户/数据库同步相关类型别名."""
2 |
3 | / from __future__ import annotations
4 | |
5 | | from collections.abc import Iterable, Mapping, Sequence
6 | | from typing import Literal, Protocol, TypedDict, TypeAlias
7 | |
8 | | from app.types.accounts import PermissionSnapshot, RemoteAccount
9 | | from app.types.structures import JsonDict, JsonValue
  | |____________________________________________________^
  |
help: Organize imports

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> app/types/sync.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Mapping, Sequence
  |                             ^^^^^^^^
6 | from typing import Literal, Protocol, TypedDict, TypeAlias
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> app/types/sync.py:5:39
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Mapping, Sequence
  |                                       ^^^^^^^
6 | from typing import Literal, Protocol, TypedDict, TypeAlias
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/types/sync.py:5:48
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Mapping, Sequence
  |                                                ^^^^^^^^
6 | from typing import Literal, Protocol, TypedDict, TypeAlias
  |
help: Move into type-checking block

F401 [*] `app.types.accounts.PermissionSnapshot` imported but unused
 --> app/types/sync.py:8:32
  |
6 | from typing import Literal, Protocol, TypedDict, TypeAlias
7 |
8 | from app.types.accounts import PermissionSnapshot, RemoteAccount
  |                                ^^^^^^^^^^^^^^^^^^
9 | from app.types.structures import JsonDict, JsonValue
  |
help: Remove unused import: `app.types.accounts.PermissionSnapshot`

TC001 Move application import `app.types.structures.JsonDict` into a type-checking block
 --> app/types/sync.py:9:34
  |
8 | from app.types.accounts import PermissionSnapshot, RemoteAccount
9 | from app.types.structures import JsonDict, JsonValue
  |                                  ^^^^^^^^
  |
help: Move into type-checking block

TC001 Move application import `app.types.structures.JsonValue` into a type-checking block
 --> app/types/sync.py:9:44
  |
8 | from app.types.accounts import PermissionSnapshot, RemoteAccount
9 | from app.types.structures import JsonDict, JsonValue
  |                                            ^^^^^^^^^
  |
help: Move into type-checking block

D102 Missing docstring in public method
  --> app/types/sync.py:15:9
   |
13 |     """数据库连接对象协议."""
14 |
15 |     def connect(self) -> bool:  # pragma: no cover - protocol
   |         ^^^^^^^
16 |         ...
   |

D102 Missing docstring in public method
  --> app/types/sync.py:18:9
   |
16 |         ...
17 |
18 |     def disconnect(self) -> None:  # pragma: no cover - protocol
   |         ^^^^^^^^^^
19 |         ...
   |

D102 Missing docstring in public method
  --> app/types/sync.py:21:9
   |
19 |         ...
20 |
21 |     def execute_query(self, query: str, params: Sequence[JsonValue] | Mapping[str, JsonValue] | None = None) -> Iterable[Sequence[Json…
   |         ^^^^^^^^^^^^^
22 |         ...
   |

E501 Line too long (142 > 120)
  --> app/types/sync.py:21:121
   |
19 | …
20 | …
21 | …e] | Mapping[str, JsonValue] | None = None) -> Iterable[Sequence[JsonValue]]:  # noqa: D401
   |                                                         ^^^^^^^^^^^^^^^^^^^^^^
22 | …
   |

RUF100 [*] Unused `noqa` directive (unused: `D401`)
  --> app/types/sync.py:21:145
   |
19 | …
20 | …
21 | …sonValue] | None = None) -> Iterable[Sequence[JsonValue]]:  # noqa: D401
   |                                                              ^^^^^^^^^^^^
22 | …
   |
help: Remove unused `noqa` directive

RUF022 [*] `__all__` is not sorted
   --> app/types/sync.py:118:11
    |
118 |   __all__ = [
    |  ___________^
119 | |     "SyncConnection",
120 | |     "SyncSummary",
121 | |     "RemoteAccountMap",
122 | |     "PermissionDiffPayload",
123 | |     "DiffEntry",
124 | |     "PrivilegeDiffEntry",
125 | |     "OtherDiffEntry",
126 | |     "InventorySummary",
127 | |     "CollectionSummary",
128 | |     "SyncStagesSummary",
129 | |     "SyncOperationResult",
130 | | ]
    | |_^
    |
help: Apply an isort-style sorting to `__all__`

D205 1 blank line required between summary line and description
 --> app/utils/cache_utils.py:1:1
  |
1 | / """鲸落 - 缓存管理工具
2 | | 基于Flask-Caching的通用缓存管理器,提供装饰器和通用缓存功能.
3 | | """
  | |___^
4 |
5 |   import hashlib
  |
help: Insert single blank line

UP035 [*] Import from `collections.abc` instead: `Callable`
  --> app/utils/cache_utils.py:9:1
   |
 7 | from collections.abc import Callable
 8 | from functools import wraps
 9 | from typing import Callable as TypingCallable, ParamSpec, TypeVar, cast
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |
11 | from flask_caching import Cache
   |
help: Import from `collections.abc`

D107 Missing docstring in `__init__`
  --> app/utils/cache_utils.py:31:9
   |
29 |     """
30 |
31 |     def __init__(self, cache: Cache) -> None:
   |         ^^^^^^^^
32 |         self.cache = cache
33 |         self.default_timeout = 300  # 5分钟默认超时
   |

BLE001 Do not catch blind exception: `Exception`
  --> app/utils/cache_utils.py:85:16
   |
83 |         try:
84 |             return self.cache.get(key)
85 |         except Exception as e:
   |                ^^^^^^^^^
86 |             self.system_logger.warning("获取缓存失败", module="cache", key=key, exception=str(e))
87 |             return None
   |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/cache_utils.py:104:16
    |
102 |             timeout = timeout or self.default_timeout
103 |             self.cache.set(key, value, timeout=timeout)
104 |         except Exception as e:
    |                ^^^^^^^^^
105 |             self.system_logger.warning("设置缓存失败", module="cache", key=key, exception=str(e))
106 |             return False
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/cache_utils.py:121:16
    |
119 |         try:
120 |             self.cache.delete(key)
121 |         except Exception:
    |                ^^^^^^^^^
122 |             self.system_logger.warning("删除缓存失败: {key}, 错误: {e}")
123 |             return False
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/cache_utils.py:135:16
    |
133 |         try:
134 |             self.cache.clear()
135 |         except Exception:
    |                ^^^^^^^^^
136 |             self.system_logger.warning("清空缓存失败: {e}")
137 |             return False
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/utils/cache_utils.py:166:21
    |
164 |             self.set(key, result, timeout)
165 |             return result
166 |         return cast(R, value)
    |                     ^
167 |
168 |     def invalidate_pattern(self, pattern: str) -> int:
    |
help: Add quotes

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/cache_utils.py:182:16
    |
180 |                 return self.cache.cache.delete_pattern(pattern)
181 |             self.system_logger.warning("当前缓存后端不支持模式删除")
182 |         except Exception:
    |                ^^^^^^^^^
183 |             self.system_logger.warning("模式删除缓存失败: {pattern}, 错误: {e}")
184 |             return 0
    |

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/utils/cache_utils.py:253:29
    |
251 |                 system_logger = get_system_logger()
252 |                 system_logger.debug("缓存命中", module="cache", cache_key=cache_key)
253 |                 return cast(R, cached_value)
    |                             ^
254 |
255 |             # 执行函数并缓存结果
    |
help: Add quotes

PLR2004 Magic value used in comparison, consider replacing `255` with a constant variable
   --> app/utils/data_validator.py:284:42
    |
282 |         if re.match(ip_pattern, host):
283 |             parts = host.split(".")
284 |             return all(0 <= int(part) <= 255 for part in parts)
    |                                          ^^^
285 |
286 |         # 检查域名格式
    |

E501 Line too long (123 > 120)
   --> app/utils/data_validator.py:287:121
    |
286 |         # 检查域名格式
287 |         domain_pattern = r"^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$"
    |                                                                                                                         ^^^
288 |         return bool(re.match(domain_pattern, host))
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/data_validator.py:476:16
    |
474 |             if dynamic_types:
475 |                 return dynamic_types
476 |         except Exception as exc:
    |                ^^^^^^^^^
477 |             logger.warning("获取数据库类型配置失败,回退到静态白名单: %s", exc)
    |

PLR2004 Magic value used in comparison, consider replacing `3` with a constant variable
   --> app/utils/data_validator.py:527:30
    |
526 |         normalized = username.strip()
527 |         if len(normalized) < 3:
    |                              ^
528 |             return "用户名长度至少3个字符"
    |

PLR2004 Magic value used in comparison, consider replacing `50` with a constant variable
   --> app/utils/data_validator.py:530:30
    |
528 |             return "用户名长度至少3个字符"
529 |
530 |         if len(normalized) > 50:
    |                              ^^
531 |             return "用户名长度不能超过50个字符"
    |

PLR2004 Magic value used in comparison, consider replacing `6` with a constant variable
   --> app/utils/data_validator.py:557:28
    |
555 |             return "密码必须是字符串"
556 |
557 |         if len(password) < 6:
    |                            ^
558 |             return "密码长度至少6个字符"
    |

PLR2004 Magic value used in comparison, consider replacing `128` with a constant variable
   --> app/utils/data_validator.py:560:28
    |
558 |             return "密码长度至少6个字符"
559 |
560 |         if len(password) > 128:
    |                            ^^^
561 |             return "密码长度不能超过128个字符"
    |

D205 1 blank line required between summary line and description
 --> app/utils/database_batch_manager.py:1:1
  |
1 | / """鲸落 - 数据库批量操作管理器
2 | | 提供高效的批量提交机制,优化大量数据处理性能.
3 | | """
  | |___^
4 |
5 |   from types import TracebackType
  |
help: Insert single blank line

TRY300 Consider moving this statement to an `else` block
   --> app/utils/database_batch_manager.py:163:13
    |
161 |             # 清空当前批次
162 |             self.pending_operations.clear()
163 |             return True
    |             ^^^^^^^^^^^
164 |
165 |         except Exception as e:
    |

UP035 [*] Import from `collections.abc` instead: `Callable`
 --> app/utils/decorators.py:4:1
  |
3 | from functools import wraps
4 | from typing import Callable, Optional, ParamSpec, Protocol, TypeVar, overload
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
5 |
6 | from flask import flash, redirect, request, url_for
  |
help: Import from `collections.abc`

F401 [*] `typing.Optional` imported but unused
 --> app/utils/decorators.py:4:30
  |
3 | from functools import wraps
4 | from typing import Callable, Optional, ParamSpec, Protocol, TypeVar, overload
  |                              ^^^^^^^^
5 |
6 | from flask import flash, redirect, request, url_for
  |
help: Remove unused import: `typing.Optional`

D101 Missing docstring in public class
  --> app/utils/decorators.py:19:7
   |
19 | class PermissionUser(Protocol):
   |       ^^^^^^^^^^^^^^
20 |     is_authenticated: bool
21 |     role: str
   |

D417 Missing argument description in the docstring for `admin_required`: `func`
  --> app/utils/decorators.py:26:5
   |
24 | SAFE_CSRF_METHODS = {"GET", "HEAD", "OPTIONS", "TRACE"}
25 |
26 | def admin_required(func: Callable[P, R]) -> Callable[P, R]:
   |     ^^^^^^^^^^^^^^
27 |     """确保被装饰函数仅允许管理员访问的装饰器.
   |

D417 Missing argument description in the docstring for `login_required`: `func`
   --> app/utils/decorators.py:119:5
    |
119 | def login_required(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^^^
120 |     """要求调用者已登录的装饰器.
    |

D417 Missing argument description in the docstring for `require_csrf`: `func`
   --> app/utils/decorators.py:291:5
    |
291 | def require_csrf(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^
292 |     """统一的 CSRF 校验装饰器.
    |

D417 Missing argument description in the docstring for `view_required`: `func`
   --> app/utils/decorators.py:400:5
    |
400 | def view_required(
    |     ^^^^^^^^^^^^^
401 |     func: Callable[P, R] | None = None,
402 |     *,
    |

D417 Missing argument description in the docstring for `create_required`: `func`
   --> app/utils/decorators.py:434:5
    |
434 | def create_required(
    |     ^^^^^^^^^^^^^^^
435 |     func: Callable[P, R] | None = None,
436 |     *,
    |

D417 Missing argument description in the docstring for `update_required`: `func`
   --> app/utils/decorators.py:468:5
    |
468 | def update_required(
    |     ^^^^^^^^^^^^^^^
469 |     func: Callable[P, R] | None = None,
470 |     *,
    |

D417 Missing argument description in the docstring for `delete_required`: `func`
   --> app/utils/decorators.py:502:5
    |
502 | def delete_required(
    |     ^^^^^^^^^^^^^^^
503 |     func: Callable[P, R] | None = None,
504 |     *,
    |

D417 Missing argument description in the docstring for `scheduler_view_required`: `func`
   --> app/utils/decorators.py:526:5
    |
526 | def scheduler_view_required(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
527 |     """定时任务查看权限装饰器.
    |

D417 Missing argument description in the docstring for `scheduler_manage_required`: `func`
   --> app/utils/decorators.py:539:5
    |
539 | def scheduler_manage_required(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
540 |     """定时任务管理权限装饰器.
    |

PLC0415 `import` should be at the top-level of a file
  --> app/utils/logging/error_adapter.py:60:13
   |
58 |         """
59 |         if self.request is None and has_request_context():
60 |             from flask import request as flask_request
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |
62 |             self.request = flask_request
   |

TC001 Move application import `app.utils.logging.queue_worker.LogQueueWorker` into a type-checking block
  --> app/utils/logging/handlers.py:14:44
   |
12 | from app.constants.system_constants import LogLevel
13 | from app.utils.logging.context_vars import request_id_var, user_id_var
14 | from app.utils.logging.queue_worker import LogQueueWorker
   |                                            ^^^^^^^^^^^^^^
15 | from app.utils.time_utils import UTC_TZ, time_utils
   |
help: Move into type-checking block

ARG002 Unused method argument: `logger`
  --> app/utils/logging/handlers.py:50:24
   |
48 |         self.enabled = enabled
49 |
50 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
   |                        ^^^^^^
51 |         """处理日志事件,根据配置决定是否丢弃 DEBUG 日志.
   |

ARG002 Unused method argument: `method_name`
  --> app/utils/logging/handlers.py:50:55
   |
48 |         self.enabled = enabled
49 |
50 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
   |                                                       ^^^^^^^^^^^
51 |         """处理日志事件,根据配置决定是否丢弃 DEBUG 日志.
   |

ARG002 Unused method argument: `logger`
   --> app/utils/logging/handlers.py:100:24
    |
 98 |         self.worker = worker
 99 |
100 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
    |                        ^^^^^^
101 |         """处理日志事件,将其入队等待写入数据库.
    |

ARG002 Unused method argument: `method_name`
   --> app/utils/logging/handlers.py:100:55
    |
 98 |         self.worker = worker
 99 |
100 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
    |                                                       ^^^^^^^^^^^
101 |         """处理日志事件,将其入队等待写入数据库.
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/logging/handlers.py:158:16
    |
156 |         try:
157 |             timestamp = time_utils.to_utc(timestamp)
158 |         except Exception:
    |                ^^^^^^^^^
159 |             timestamp = time_utils.now()
160 |     if timestamp is None:
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/logging/handlers.py:232:12
    |
230 |             else:
231 |                 context["is_admin"] = bool(is_admin)
232 |     except Exception as exc:
    |            ^^^^^^^^^
233 |         _logger.warning("logging_handler_extract_user_failed", error=str(exc))
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/logging/handlers.py:243:20
    |
241 |             try:
242 |                 context[key] = value.to_dict()
243 |             except Exception:
    |                    ^^^^^^^^^
244 |                 context[key] = str(value)
245 |         else:
    |

TC002 Move third-party import `flask.Flask` into a type-checking block
  --> app/utils/logging/queue_worker.py:13:19
   |
11 | from typing import TYPE_CHECKING
12 |
13 | from flask import Flask
   |                   ^^^^^
14 | from flask_sqlalchemy import SQLAlchemy
   |
help: Move into type-checking block

TC002 Move third-party import `flask_sqlalchemy.SQLAlchemy` into a type-checking block
  --> app/utils/logging/queue_worker.py:14:30
   |
13 | from flask import Flask
14 | from flask_sqlalchemy import SQLAlchemy
   |                              ^^^^^^^^^^
15 |
16 | from app.types import JsonValue
   |
help: Move into type-checking block

N806 Variable `UnifiedLog` in function should be lowercase
   --> app/utils/logging/queue_worker.py:181:17
    |
179 |         db: SQLAlchemy | None = None
180 |         try:
181 |             db, UnifiedLog = _get_logging_dependencies()
    |                 ^^^^^^^^^^
182 |             with self.app.app_context():
183 |                 models = [UnifiedLog.create_log_entry(**entry) for entry in entries]
    |

D205 1 blank line required between summary line and description
 --> app/utils/password_crypto_utils.py:1:1
  |
1 | / """密码管理工具
2 | | 用于安全地存储和获取数据库密码.
3 | | """
  | |___^
4 |
5 |   import base64
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/utils/password_crypto_utils.py:31:9
   |
29 |     """
30 |
31 |     def __init__(self) -> None:
   |         ^^^^^^^^
32 |         self.key = self._get_or_create_key()
33 |         self.cipher = Fernet(self.key)
   |

PLC0415 `import` should be at the top-level of a file
  --> app/utils/password_crypto_utils.py:51:17
   |
49 |             # 延迟导入避免循环导入
50 |             try:
51 |                 from app.utils.structlog_config import get_system_logger
   |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
52 |                 system_logger = get_system_logger()
53 |                 system_logger.warning("没有设置PASSWORD_ENCRYPTION_KEY环境变量", module="password_manager")
   |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/password_crypto_utils.py:100:13
    |
 98 |             return decrypted.decode()
 99 |         except Exception as e:
100 |             from app.utils.structlog_config import get_system_logger
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
101 |
102 |             system_logger = get_system_logger()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/utils/password_crypto_utils.py:126:13
    |
124 |         try:
125 |             base64.b64decode(password.encode())
126 |             return True
    |             ^^^^^^^^^^^
127 |         except Exception:
128 |             return False
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/password_crypto_utils.py:127:16
    |
125 |             base64.b64decode(password.encode())
126 |             return True
127 |         except Exception:
    |                ^^^^^^^^^
128 |             return False
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/query_filter_utils.py:264:9
    |
262 |     query = db.session.query(distinct(UnifiedLog.module))
263 |     if limit_hours is not None:
264 |         from datetime import timedelta
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
265 |
266 |         from app.utils.time_utils import time_utils
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/query_filter_utils.py:266:9
    |
264 |         from datetime import timedelta
265 |
266 |         from app.utils.time_utils import time_utils
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
267 |
268 |         start_time = time_utils.now() - timedelta(hours=limit_hours)
    |

BLE001 Do not catch blind exception: `Exception`
  --> app/utils/rate_limiter.py:88:20
   |
86 |             try:
87 |                 return self._check_cache(identifier, endpoint, limit, window, current_time, window_start)
88 |             except Exception as e:
   |                    ^^^^^^^^^
89 |                 system_logger = get_system_logger()
90 |                 system_logger.warning(
   |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/rate_limiter.py:100:9
    |
 98 |             return self._check_memory(identifier, endpoint, limit, window, current_time, window_start)
 99 |
100 |     def _check_cache(
    |         ^^^^^^^^^^^^
101 |         self,
102 |         identifier: str,
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/rate_limiter.py:153:9
    |
151 |         }
152 |
153 |     def _check_memory(
    |         ^^^^^^^^^^^^^
154 |         self,
155 |         identifier: str,
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/rate_limiter.py:239:5
    |
238 |     """
239 |     from app.config import Config
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
240 |
241 |     if limit is None:
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/rate_limiter.py:336:5
    |
335 |     """
336 |     from app.config import Config
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
337 |
338 |     if limit is None:
    |

D205 1 blank line required between summary line and description
 --> app/utils/response_utils.py:1:1
  |
1 | / """鲸落 - 统一响应工具
2 | | 提供统一的成功/错误响应结构,避免在业务层散落 JSON 拼装逻辑.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> app/utils/response_utils.py:7:1
  |
5 | from __future__ import annotations
6 |
7 | from typing import Mapping
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^
8 |
9 | from flask import Response, jsonify
  |
help: Import from `collections.abc`

TC001 Move application import `app.types.JsonDict` into a type-checking block
  --> app/utils/response_utils.py:14:23
   |
12 | from app.constants.system_constants import ErrorCategory, ErrorSeverity, SuccessMessages
13 | from app.errors import AppError, map_exception_to_status
14 | from app.types import JsonDict, JsonValue
   |                       ^^^^^^^^
15 | from app.utils.structlog_config import ErrorContext, enhanced_error_handler
16 | from app.utils.time_utils import time_utils
   |
help: Move into type-checking block

TC001 Move application import `app.types.JsonValue` into a type-checking block
  --> app/utils/response_utils.py:14:33
   |
12 | from app.constants.system_constants import ErrorCategory, ErrorSeverity, SuccessMessages
13 | from app.errors import AppError, map_exception_to_status
14 | from app.types import JsonDict, JsonValue
   |                                 ^^^^^^^^^
15 | from app.utils.structlog_config import ErrorContext, enhanced_error_handler
16 | from app.utils.time_utils import time_utils
   |
help: Move into type-checking block

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/response_utils.py:111:5
    |
111 | def jsonify_unified_error_message(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
112 |     message: str,
113 |     *,
    |

D205 1 blank line required between summary line and description
 --> app/utils/safe_query_builder.py:1:1
  |
1 | / """鲸落 - 安全查询构建器
2 | | 提供安全的SQL查询构建功能,防止SQL注入攻击
3 | | 支持MySQL、PostgreSQL、SQL Server、Oracle等多种数据库.
4 | | """
  | |___^
5 |
6 |   from collections.abc import Mapping, Sequence
  |
help: Insert single blank line

TC001 Move application import `app.types.JsonValue` into a type-checking block
  --> app/utils/sensitive_data.py:11:23
   |
 9 | from collections.abc import Mapping, Sequence
10 |
11 | from app.types import JsonValue
   |                       ^^^^^^^^^
12 |
13 | DEFAULT_SENSITIVE_KEYS = {
   |
help: Move into type-checking block

TRY300 Consider moving this statement to an `else` block
   --> app/utils/sqlserver_connection_utils.py:150:13
    |
148 |         try:
149 |             socket.gethostbyname(host)
150 |             return True
    |             ^^^^^^^^^^^
151 |         except socket.gaierror:
152 |             return False
    |

TRY300 Consider moving this statement to an `else` block
   --> app/utils/sqlserver_connection_utils.py:172:13
    |
170 |             result = sock.connect_ex((host, port))
171 |             sock.close()
172 |             return result == 0
    |             ^^^^^^^^^^^^^^^^^^
173 |         except Exception:
174 |             return False
    |

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/sqlserver_connection_utils.py:173:16
    |
171 |             sock.close()
172 |             return result == 0
173 |         except Exception:
    |                ^^^^^^^^^
174 |             return False
    |

E501 Line too long (124 > 120)
   --> app/utils/sqlserver_connection_utils.py:176:121
    |
174 |             return False
175 |
176 |     def get_connection_string_suggestions(self, host: str, port: int, username: str, database: str = "master") -> list[str]:
    |                                                                                                                         ^^^^
177 |         """获取连接字符串建议.
    |

E501 Line too long (126 > 120)
   --> app/utils/sqlserver_connection_utils.py:204:121
    |
203 |         # 带超时的连接字符串
204 |         suggestions.append(f"Server={host},{port};Database={database};User Id={username};Password=***;Connection Timeout=60;")
    |                                                                                                                         ^^^^^^
205 |
206 |         # 带加密的连接字符串
    |

E501 Line too long (145 > 120)
   --> app/utils/sqlserver_connection_utils.py:207:121
    |
206 | …
207 | …e};User Id={username};Password=***;Encrypt=True;TrustServerCertificate=True;")
    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^
208 | …
209 | …
    |

E501 Line too long (146 > 120)
   --> app/utils/sqlserver_connection_utils.py:210:121
    |
209 | …
210 | …e};User Id={username};Password=***;Connection Timeout=60;Command Timeout=300;")
    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^
211 | …
212 | …
    |

E501 Line too long (138 > 120)
   --> app/utils/sqlserver_connection_utils.py:237:121
    |
235 | …
236 | …
237 | …ower() for keyword in ["timeout", "connection", "network", "unreachable"]),
    |                                                           ^^^^^^^^^^^^^^^^^^
238 | …r() for keyword in ["login", "authentication", "password", "user"]),
239 | …wer() for keyword in ["server", "service", "database", "sql"]),
    |

E501 Line too long (131 > 120)
   --> app/utils/sqlserver_connection_utils.py:238:121
    |
236 | …
237 | …e.lower() for keyword in ["timeout", "connection", "network", "unreachable"]),
238 | …ower() for keyword in ["login", "authentication", "password", "user"]),
    |                                                              ^^^^^^^^^^^
239 | ….lower() for keyword in ["server", "service", "database", "sql"]),
240 | …sage.lower() for keyword in ["permission", "access", "denied", "unauthorized"]),
    |

E501 Line too long (126 > 120)
   --> app/utils/sqlserver_connection_utils.py:239:121
    |
237 | …         "has_network_error": any(keyword in error_message.lower() for keyword in ["timeout", "connection", "network", "unreachable"…
238 | …         "has_auth_error": any(keyword in error_message.lower() for keyword in ["login", "authentication", "password", "user"]),
239 | …         "has_server_error": any(keyword in error_message.lower() for keyword in ["server", "service", "database", "sql"]),
    |                                                                                                                       ^^^^^^
240 | …         "has_permission_error": any(keyword in error_message.lower() for keyword in ["permission", "access", "denied", "unauthorize…
241 | …     }
    |

E501 Line too long (140 > 120)
   --> app/utils/sqlserver_connection_utils.py:240:121
    |
238 | …() for keyword in ["login", "authentication", "password", "user"]),
239 | …er() for keyword in ["server", "service", "database", "sql"]),
240 | ….lower() for keyword in ["permission", "access", "denied", "unauthorized"]),
    |                                                          ^^^^^^^^^^^^^^^^^^^^
241 | …
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/utils/structlog_config.py:3:1
   |
 1 |   """WhaleFall 项目的结构化日志配置与辅助函数."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import atexit
 6 | | import sys
 7 | | from collections.abc import Callable
 8 | | from contextlib import suppress
 9 | | from functools import wraps
10 | | from typing import ParamSpec
11 | |
12 | | import structlog
13 | | from flask import Flask, current_app, g, has_request_context, jsonify
14 | | from flask.typing import ResponseReturnValue
15 | | from flask_login import current_user
16 | | from structlog.typing import BindableLogger, Processor
17 | |
18 | | from app.constants.system_constants import ErrorSeverity
19 | | from app.errors import map_exception_to_status
20 | | from app.utils.logging.context_vars import request_id_var, user_id_var
21 | | from app.utils.logging.error_adapter import (
22 | |     ErrorContext,
23 | |     ErrorMetadata,
24 | |     build_public_context,
25 | |     derive_error_metadata,
26 | |     get_error_suggestions,
27 | | )
28 | | from app.utils.logging.handlers import DatabaseLogHandler, DebugFilter
29 | | from app.utils.logging.queue_worker import LogQueueWorker
30 | | from app.types import ContextDict, JsonValue, LoggerExtra, StructlogEventDict
   | |_____________________________________________________________________________^
31 |
32 |   P = ParamSpec("P")
   |
help: Organize imports

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
 --> app/utils/structlog_config.py:7:29
  |
5 | import atexit
6 | import sys
7 | from collections.abc import Callable
  |                             ^^^^^^^^
8 | from contextlib import suppress
9 | from functools import wraps
  |
help: Move into type-checking block

TC002 Move third-party import `flask.typing.ResponseReturnValue` into a type-checking block
  --> app/utils/structlog_config.py:14:26
   |
12 | import structlog
13 | from flask import Flask, current_app, g, has_request_context, jsonify
14 | from flask.typing import ResponseReturnValue
   |                          ^^^^^^^^^^^^^^^^^^^
15 | from flask_login import current_user
16 | from structlog.typing import BindableLogger, Processor
   |
help: Move into type-checking block

TC002 Move third-party import `structlog.typing.BindableLogger` into a type-checking block
  --> app/utils/structlog_config.py:16:30
   |
14 | from flask.typing import ResponseReturnValue
15 | from flask_login import current_user
16 | from structlog.typing import BindableLogger, Processor
   |                              ^^^^^^^^^^^^^^
17 |
18 | from app.constants.system_constants import ErrorSeverity
   |
help: Move into type-checking block

TC002 Move third-party import `structlog.typing.Processor` into a type-checking block
  --> app/utils/structlog_config.py:16:46
   |
14 | from flask.typing import ResponseReturnValue
15 | from flask_login import current_user
16 | from structlog.typing import BindableLogger, Processor
   |                                              ^^^^^^^^^
17 |
18 | from app.constants.system_constants import ErrorSeverity
   |
help: Move into type-checking block

BLE001 Do not catch blind exception: `Exception`
   --> app/utils/structlog_config.py:579:16
    |
577 |         try:
578 |             return func(*args, **kwargs)
579 |         except Exception as error:
    |                ^^^^^^^^^
580 |             context = ErrorContext(error)
581 |             payload = enhanced_error_handler(error, context)
    |

PLC0415 `import` should be at the top-level of a file
  --> app/utils/time_utils.py:94:13
   |
92 |             return dt.astimezone(CHINA_TZ)
93 |         except (ValueError, TypeError) as e:
94 |             from app.utils.structlog_config import get_system_logger
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
95 |
96 |             get_system_logger().warning(f"时间转换错误: {e}")
   |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/time_utils.py:127:13
    |
125 |             return dt.astimezone(UTC_TZ)
126 |         except (ValueError, TypeError) as e:
127 |             from app.utils.structlog_config import get_system_logger
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
128 |
129 |             get_system_logger().warning(f"时间转换错误: {e}")
    |

PLR0911 Too many return statements (7 > 6)
   --> app/utils/time_utils.py:177:9
    |
176 |     @staticmethod
177 |     def get_relative_time(dt: str | date | datetime | None) -> str:
    |         ^^^^^^^^^^^^^^^^^
178 |         """获取相对时间描述.
    |

PLR2004 Magic value used in comparison, consider replacing `60` with a constant variable
   --> app/utils/time_utils.py:197:39
    |
195 |             diff = now - china_dt
196 |
197 |             if diff.total_seconds() < 60:
    |                                       ^^
198 |                 return "刚刚"
199 |             if diff.total_seconds() < TimeConstants.ONE_HOUR:
    |

PLR2004 Magic value used in comparison, consider replacing `7` with a constant variable
   --> app/utils/time_utils.py:205:28
    |
203 |                 hours = int(diff.total_seconds() / TimeConstants.ONE_HOUR)
204 |                 return f"{hours}小时前"
205 |             if diff.days < 7:
    |                            ^
206 |                 return f"{diff.days}天前"
207 |             return TimeUtils.format_china_time(china_dt)
    |

PLR2004 Magic value used in comparison, consider replacing `24` with a constant variable
   --> app/utils/time_utils.py:245:20
    |
243 |         now = TimeUtils.now_china()
244 |         start = now.replace(hour=0, minute=0, second=0, microsecond=0)
245 |         if hours < 24:
    |                    ^^
246 |             start = now.replace(hour=now.hour - hours, minute=0, second=0, microsecond=0)
    |

TRY300 Consider moving this statement to an `else` block
   --> app/utils/time_utils.py:276:13
    |
274 |             if isinstance(dt, date):
275 |                 return dt.isoformat()
276 |             return None
    |             ^^^^^^^^^^^
277 |         except (ValueError, TypeError):
278 |             return None
    |

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/utils/version_parser.py:29:24
   |
28 |       # 版本提取正则表达式
29 |       VERSION_PATTERNS = {
   |  ________________________^
30 | |         "mysql": [
31 | |             r"(\d+\.\d+\.\d+)",  # 8.0.32
32 | |             r"(\d+\.\d+)",  # 8.0
33 | |         ],
34 | |         "postgresql": [
35 | |             r"PostgreSQL\s+(\d+\.\d+)",  # PostgreSQL 13.4
36 | |             r"(\d+\.\d+)",  # 13.4
37 | |         ],
38 | |         "sqlserver": [
39 | |             r"Microsoft SQL Server \d+\s+\([^)]+\)\s+\([^)]+\)\s+-\s+(\d+\.\d+\.\d+\.\d+)",  # 14.0.3465.1
40 | |             r"(\d+\.\d+\.\d+\.\d+)",  # 14.0.3465.1
41 | |         ],
42 | |         "oracle": [
43 | |             r"Oracle Database \d+g Release (\d+\.\d+\.\d+\.\d+\.\d+)",  # Oracle Database 11g Release 11.2.0.1.0
44 | |             r"(\d+\.\d+\.\d+\.\d+\.\d+)",  # 11.2.0.1.0
45 | |         ],
46 | |     }
   | |_____^
47 |
48 |       @classmethod
   |

PLR2004 Magic value used in comparison, consider replacing `50` with a constant variable
  --> app/utils/version_parser.py:87:86
   |
85 |         return {
86 |             "main_version": "未知",
87 |             "detailed_version": version_string[:50] + "..." if len(version_string) > 50 else version_string,
   |                                                                                      ^^
88 |             "original": version_string,
89 |         }
   |

C901 `_extract_main_version` is too complex (11 > 10)
  --> app/utils/version_parser.py:92:9
   |
91 |     @classmethod
92 |     def _extract_main_version(cls, version: str, db_type: str) -> str:
   |         ^^^^^^^^^^^^^^^^^^^^^
93 |         """提取主版本号.
   |

PLR0911 Too many return statements (11 > 6)
  --> app/utils/version_parser.py:92:9
   |
91 |     @classmethod
92 |     def _extract_main_version(cls, version: str, db_type: str) -> str:
   |         ^^^^^^^^^^^^^^^^^^^^^
93 |         """提取主版本号.
   |

PLR2004 Magic value used in comparison, consider replacing `2` with a constant variable
   --> app/utils/version_parser.py:116:30
    |
114 |             # MySQL: 8.0.32 -> 8.0
115 |             parts = version.split(".")
116 |             if len(parts) >= 2:
    |                              ^
117 |                 return f"{parts[0]}.{parts[1]}"
118 |             return version
    |

PLR2004 Magic value used in comparison, consider replacing `2` with a constant variable
   --> app/utils/version_parser.py:123:30
    |
121 |             # PostgreSQL: 13.4 -> 13.4
122 |             parts = version.split(".")
123 |             if len(parts) >= 2:
    |                              ^
124 |                 return f"{parts[0]}.{parts[1]}"
125 |             return version
    |

PLR2004 Magic value used in comparison, consider replacing `2` with a constant variable
   --> app/utils/version_parser.py:130:30
    |
128 |             # SQL Server: 14.0.3465.1 -> 14.0
129 |             parts = version.split(".")
130 |             if len(parts) >= 2:
    |                              ^
131 |                 return f"{parts[0]}.{parts[1]}"
132 |             return version
    |

PLR2004 Magic value used in comparison, consider replacing `2` with a constant variable
   --> app/utils/version_parser.py:137:30
    |
135 |             # Oracle: 11.2.0.1.0 -> 11.2
136 |             parts = version.split(".")
137 |             if len(parts) >= 2:
    |                              ^
138 |                 return f"{parts[0]}.{parts[1]}"
139 |             return version
    |

PLR2004 Magic value used in comparison, consider replacing `2` with a constant variable
   --> app/utils/version_parser.py:142:26
    |
141 |         parts = version.split(".")
142 |         if len(parts) >= 2:
    |                          ^
143 |             return f"{parts[0]}.{parts[1]}"
144 |         return version
    |

UP037 [*] Remove quotes from type annotation
  --> app/views/classification_forms.py:28:51
   |
26 |     form_definition = CLASSIFICATION_FORM_DEFINITION
27 |
28 |     def _resolve_success_redirect(self, instance: "AccountClassification") -> str:
   |                                                   ^^^^^^^^^^^^^^^^^^^^^^^
29 |         """解析成功后的重定向地址.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/classification_forms.py:41:50
   |
39 |         return url_for("account_classification.index")
40 |
41 |     def _success_redirect_kwargs(self, instance: "AccountClassification") -> dict[str, object]:
   |                                                  ^^^^^^^^^^^^^^^^^^^^^^^
42 |         """获取重定向的额外参数.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/classification_forms.py:54:45
   |
52 |         return {}
53 |
54 |     def get_success_message(self, instance: "AccountClassification") -> str:
   |                                             ^^^^^^^^^^^^^^^^^^^^^^^
55 |         """获取成功消息.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/classification_forms.py:80:51
   |
78 |     form_definition = CLASSIFICATION_RULE_FORM_DEFINITION
79 |
80 |     def _resolve_success_redirect(self, instance: "AccountClassificationRule") -> str:
   |                                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^
81 |         """解析成功后的重定向地址.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/classification_forms.py:93:45
   |
91 |         return url_for("account_classification.index")
92 |
93 |     def get_success_message(self, instance: "AccountClassificationRule") -> str:
   |                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
94 |         """获取成功消息.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/credential_forms.py:26:51
   |
24 |     form_definition = CREDENTIAL_FORM_DEFINITION
25 |
26 |     def _resolve_success_redirect(self, instance: "Credential") -> str:
   |                                                   ^^^^^^^^^^^^
27 |         """解析成功后的重定向地址.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/credential_forms.py:40:45
   |
38 |         return super()._resolve_success_redirect(instance)
39 |
40 |     def get_success_message(self, instance: "Credential") -> str:
   |                                             ^^^^^^^^^^^^
41 |         """获取成功消息.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/instance_forms.py:26:51
   |
24 |     form_definition = INSTANCE_FORM_DEFINITION
25 |
26 |     def _resolve_success_redirect(self, instance: "Instance") -> str:
   |                                                   ^^^^^^^^^^
27 |         """解析成功后的重定向地址.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/instance_forms.py:40:45
   |
38 |         return super()._resolve_success_redirect(instance)
39 |
40 |     def get_success_message(self, instance: "Instance") -> str:
   |                                             ^^^^^^^^^^
41 |         """获取成功消息.
   |
help: Remove quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/views/mixins/resource_forms.py:156:25
    |
154 |         """
155 |         if req.is_json:
156 |             return cast(ResourcePayload, req.get_json(silent=True) or {})
    |                         ^^^^^^^^^^^^^^^
157 |         return cast(ResourcePayload, req.form)
    |
help: Add quotes

TC006 [*] Add quotes to type expression in `typing.cast()`
   --> app/views/mixins/resource_forms.py:157:21
    |
155 |         if req.is_json:
156 |             return cast(ResourcePayload, req.get_json(silent=True) or {})
157 |         return cast(ResourcePayload, req.form)
    |                     ^^^^^^^^^^^^^^^
158 |
159 |     def _build_context(
    |
help: Add quotes

I001 [*] Import block is un-sorted or un-formatted
  --> app/views/scheduler_forms.py:3:1
   |
 1 |   """定时任务表单视图."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from typing import Never, TYPE_CHECKING
 6 | |
 7 | | from flask import Response, request
 8 | |
 9 | | from app.errors import NotFoundError, SystemError, ValidationError
10 | | from app.forms.definitions.scheduler_job import SCHEDULER_JOB_FORM_DEFINITION
11 | | from app.utils.response_utils import jsonify_unified_error_message, jsonify_unified_success
12 | | from app.views.mixins.resource_forms import ResourceFormView
   | |____________________________________________________________^
13 |
14 |   if TYPE_CHECKING:
   |
help: Organize imports

BLE001 Do not catch blind exception: `Exception`
  --> app/views/scheduler_forms.py:86:16
   |
84 |         except (NotFoundError, ValidationError, SystemError):
85 |             raise
86 |         except Exception as exc:
   |                ^^^^^^^^^
87 |             return jsonify_unified_error_message(message="任务更新失败", extra={"exception": str(exc)})
   |

UP037 [*] Remove quotes from type annotation
  --> app/views/scheduler_forms.py:89:46
   |
87 |             return jsonify_unified_error_message(message="任务更新失败", extra={"exception": str(exc)})
88 |
89 |     def _load_resource(self, job_id: str) -> "SchedulerJobResource":
   |                                              ^^^^^^^^^^^^^^^^^^^^^^
90 |         """加载任务资源.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/tag_forms.py:26:51
   |
24 |     form_definition = TAG_FORM_DEFINITION
25 |
26 |     def _resolve_success_redirect(self, instance: "Tag") -> str:
   |                                                   ^^^^^
27 |         """解析成功后的重定向地址.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/tag_forms.py:40:45
   |
38 |         return super()._resolve_success_redirect(instance)
39 |
40 |     def get_success_message(self, instance: "Tag") -> str:
   |                                             ^^^^^
41 |         """获取成功消息.
   |
help: Remove quotes

UP037 [*] Remove quotes from type annotation
  --> app/views/user_forms.py:26:45
   |
24 |     form_definition = USER_FORM_DEFINITION
25 |
26 |     def get_success_message(self, instance: "User") -> str:
   |                                             ^^^^^^
27 |         """获取成功消息.
   |
help: Remove quotes

INP001 File `migrations/env.py` is part of an implicit namespace package. Add an `__init__.py`.
--> migrations/env.py:1:1

ANN201 Missing return type annotation for public function `get_engine`
  --> migrations/env.py:22:5
   |
22 | def get_engine():
   |     ^^^^^^^^^^
23 |     """获取当前 Flask 应用绑定的 SQLAlchemy Engine.
   |
help: Add return type annotation

ANN201 Missing return type annotation for public function `get_engine_url`
  --> migrations/env.py:43:5
   |
43 | def get_engine_url():
   |     ^^^^^^^^^^^^^^
44 |     """生成数据库连接串,供 Alembic 配置使用.
   |
help: Add return type annotation

ANN201 Missing return type annotation for public function `get_metadata`
  --> migrations/env.py:65:5
   |
63 | target_db = current_app.extensions["migrate"].db
64 |
65 | def get_metadata():
   |     ^^^^^^^^^^^^
66 |     """获取迁移需要的元数据对象.
   |
help: Add return type annotation

ANN001 Missing type annotation for function argument `_context`
   --> migrations/env.py:119:37
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                     ^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

ANN001 Missing type annotation for function argument `_revision`
   --> migrations/env.py:119:47
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                               ^^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

ANN001 Missing type annotation for function argument `directives`
   --> migrations/env.py:119:58
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                                          ^^^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

N999 Invalid module name: 'gunicorn-dev.conf'
--> nginx/gunicorn/gunicorn-dev.conf.py:1:1

N999 Invalid module name: 'gunicorn-prod.conf'
--> nginx/gunicorn/gunicorn-prod.conf.py:1:1

Found 800 errors.
[*] 202 fixable with the `--fix` option (86 hidden fixes can be enabled with the `--unsafe-fixes` option).
