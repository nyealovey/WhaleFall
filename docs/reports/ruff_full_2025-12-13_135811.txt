TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/account_classification/classifiers/postgresql_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Sequence
  |                             ^^^^^^^^
9 | from typing import TYPE_CHECKING, cast
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/account_classification/classifiers/sqlserver_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Sequence
  |                             ^^^^^^^^
9 | from typing import TYPE_CHECKING, cast
  |
help: Move into type-checking block

D417 Missing argument description in the docstring for `aggregate_period`: `callbacks`
   --> app/services/aggregation/database_aggregation_runner.py:108:9
    |
106 |             )
107 |
108 |     def aggregate_period(
    |         ^^^^^^^^^^^^^^^^
109 |         self,
110 |         period_type: str,
    |

D417 Missing argument description in the docstring for `aggregate_period`: `callbacks`
   --> app/services/aggregation/instance_aggregation_runner.py:110:9
    |
108 |             )
109 |
110 |     def aggregate_period(
    |         ^^^^^^^^^^^^^^^^
111 |         self,
112 |         period_type: str,
    |

D417 Missing argument description in the docstring for `_persist_instance_aggregation`: `context`
   --> app/services/aggregation/instance_aggregation_runner.py:331:9
    |
329 |         ).all()
330 |
331 |     def _persist_instance_aggregation(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
332 |         self,
333 |         *,
    |

COM812 [*] Trailing comma missing
   --> app/services/cache_service.py:361:80
    |
360 |     def set_classification_rules_by_db_type_cache(
361 |         self, db_type: str, rules: list[dict[str, Any]], ttl: int | None = None
    |                                                                                ^
362 |     ) -> bool:
363 |         """设置按数据库类型分类的规则缓存.
    |
help: Add trailing comma

ANN401 Dynamically typed expressions (typing.Any) are disallowed in `execute_query`
   --> app/services/connection_adapters/adapters/oracle_adapter.py:169:80
    |
167 |         return result
168 |
169 |     def execute_query(self, query: str, params: tuple | dict | None = None) -> Any:
    |                                                                                ^^^
170 |         """执行 SQL 查询并返回全部行.
    |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> app/services/database_sync/adapters/base_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/base_adapter.py:5:39
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                                       ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

D107 Missing docstring in `__init__`
  --> app/services/database_sync/adapters/base_adapter.py:33:9
   |
31 |     """
32 |
33 |     def __init__(self) -> None:
   |         ^^^^^^^^
34 |         self.logger = get_system_logger()
   |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/mysql_adapter.py:7:29
  |
5 | import math
6 | import re
7 | from collections.abc import Sequence
  |                             ^^^^^^^^
8 | from typing import TYPE_CHECKING, Any, ClassVar
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/oracle_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/postgresql_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any, ClassVar
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/sqlserver_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

D107 Missing docstring in `__init__`
  --> app/services/database_sync/database_filters.py:39:9
   |
37 |     """负责加载数据库发现/容量同步所需的过滤配置."""
38 |
39 |     def __init__(self, config_path: str | Path | None = None) -> None:
   |         ^^^^^^^^
40 |         self._config_path = Path(config_path) if config_path else _DEFAULT_CONFIG_PATH
41 |         self._normalized_rules: dict[str, _FilterRule] = {}
   |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/database_sync/database_sync_service.py:7:1
   |
 5 |   """
 6 |
 7 | / from __future__ import annotations
 8 | |
 9 | | from typing import TYPE_CHECKING, Any, Self
10 | | from types import TracebackType
11 | |
12 | | from sqlalchemy.exc import SQLAlchemyError
13 | |
14 | | from app.errors import AppError
15 | | from app.models.instance import Instance
16 | | from app.services.connection_adapters.adapters.base import ConnectionAdapterError
17 | | from app.utils.structlog_config import get_system_logger
18 | |
19 | | from .coordinator import CapacitySyncCoordinator
   | |________________________________________________^
20 |
21 |   if TYPE_CHECKING:
   |
help: Organize imports

TC003 Move standard library import `types.TracebackType` into a type-checking block
  --> app/services/database_sync/database_sync_service.py:10:19
   |
 9 | from typing import TYPE_CHECKING, Any, Self
10 | from types import TracebackType
   |                   ^^^^^^^^^^^^^
11 |
12 | from sqlalchemy.exc import SQLAlchemyError
   |
help: Move into type-checking block

D107 Missing docstring in `__init__`
  --> app/services/database_sync/inventory_manager.py:27:9
   |
25 |     """负责维护 instance_databases 表的增量同步逻辑."""
26 |
27 |     def __init__(
   |         ^^^^^^^^
28 |         self,
29 |         filter_manager: DatabaseSyncFilterManager = database_sync_filter_manager,
   |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/services/database_sync/inventory_manager.py:147:9
    |
145 |             raise
146 |
147 |     def _build_summary(
    |         ^^^^^^^^^^^^^^
148 |         self,
149 |         *,
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/persistence.py:27:9
   |
25 |     """负责容量采集相关的数据持久化."""
26 |
27 |     def __init__(self) -> None:
   |         ^^^^^^^^
28 |         self.logger = get_system_logger()
   |

D205 1 blank line required between summary line and description
 --> app/services/database_type_service.py:1:1
  |
1 | / """鲸落 - 数据库类型管理服务
2 | | 提供数据库类型的CRUD操作和业务逻辑.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/classification_rule_service.py:3:1
   |
 1 |   """账户分类规则表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import json
 6 | |
 7 | | from typing import TYPE_CHECKING, Any, cast
 8 | |
 9 | | from flask_login import current_user
10 | |
11 | | from app import db
12 | | from app.forms.definitions.account_classification_rule_constants import DB_TYPE_OPTIONS, OPERATOR_OPTIONS
13 | | from app.models.account_classification import AccountClassification, ClassificationRule
14 | | from app.services.account_classification.orchestrator import (
15 | |     CACHE_INVALIDATION_EXCEPTIONS,
16 | |     AccountClassificationService,
17 | | )
18 | | from app.services.database_type_service import DatabaseTypeService
19 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
20 | | from app.types.converters import as_bool, as_int, as_optional_str, as_str
21 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
22 |
23 |   if TYPE_CHECKING:
   |
help: Organize imports

COM812 [*] Trailing comma missing
  --> app/services/form_service/classification_rule_service.py:57:79
   |
56 |     def validate(
57 |         self, data: MutablePayloadDict, *, resource: ClassificationRule | None
   |                                                                               ^
58 |     ) -> ServiceResult[MutablePayloadDict]:
59 |         """校验分类规则数据.
   |
help: Add trailing comma

PLR0911 Too many return statements (7 > 6)
  --> app/services/form_service/classification_service.py:59:9
   |
57 |         return dict(payload or {})
58 |
59 |     def validate(
   |         ^^^^^^^^
60 |         self, data: MutablePayloadDict, *, resource: AccountClassification | None
61 |     ) -> ServiceResult[MutablePayloadDict]:
   |

COM812 [*] Trailing comma missing
  --> app/services/form_service/classification_service.py:60:82
   |
59 |     def validate(
60 |         self, data: MutablePayloadDict, *, resource: AccountClassification | None
   |                                                                                  ^
61 |     ) -> ServiceResult[MutablePayloadDict]:
62 |         """校验账户分类数据.
   |
help: Add trailing comma

FBT001 Boolean-typed positional argument in function definition
   --> app/services/form_service/credential_service.py:154:9
    |
152 |         self,
153 |         data: PayloadMapping,
154 |         require_password: bool,
    |         ^^^^^^^^^^^^^^^^
155 |     ) -> ServiceResult[MutablePayloadDict] | None:
156 |         """对凭据表单的核心字段执行逐项校验."""
    |

COM812 [*] Trailing comma missing
   --> app/services/form_service/password_service.py:130:105
    |
128 |         if not validation.success:
129 |             return ServiceResult.fail(
130 |                 validation.message or "验证失败", message_key=validation.message_key, extra=validation.extra
    |                                                                                                             ^
131 |             )
    |
help: Add trailing comma

D205 1 blank line required between summary line and description
 --> app/services/form_service/resource_service.py:1:1
  |
1 | / """通用资源表单服务基类.
2 | | ---------------------------------
3 | | 负责封装表单校验、模型赋值、数据库提交与统一的结果返回.
4 | | """
  | |___^
5 |
6 |   from __future__ import annotations
  |
help: Insert single blank line

COM812 [*] Trailing comma missing
   --> app/services/form_service/resource_service.py:207:105
    |
205 |         if not validation.success:
206 |             return ServiceResult.fail(
207 |                 validation.message or "验证失败", message_key=validation.message_key, extra=validation.extra
    |                                                                                                             ^
208 |             )
    |
help: Add trailing comma

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/scheduler_job_service.py:6:1
   |
 4 |   """
 5 |
 6 | / from __future__ import annotations
 7 | |
 8 | | from dataclasses import dataclass, field
 9 | | from collections.abc import Callable
10 | | from typing import cast
11 | | from zoneinfo import ZoneInfo
   | |_____________________________^
12 |
13 |   try:
   |
help: Organize imports

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
  --> app/services/form_service/scheduler_job_service.py:9:29
   |
 8 | from dataclasses import dataclass, field
 9 | from collections.abc import Callable
   |                             ^^^^^^^^
10 | from typing import cast
11 | from zoneinfo import ZoneInfo
   |
help: Move into type-checking block

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/scheduler_job_service.py:21:1
   |
19 |           APSchedulerError = Exception  # type: ignore[misc]
20 |
21 | / from apscheduler.job import Job
22 | | from apscheduler.schedulers.base import BaseScheduler
23 | | from apscheduler.triggers.cron import CronTrigger
24 | | from apscheduler.triggers.date import DateTrigger
25 | | from apscheduler.triggers.interval import IntervalTrigger
26 | |
27 | | from app.constants.scheduler_jobs import BUILTIN_TASK_IDS
28 | | from app.errors import NotFoundError, SystemError, ValidationError
29 | | from app.scheduler import get_scheduler
30 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
31 | | from app.types import MutablePayloadDict, PayloadMapping, ResourceIdentifier, SupportsResourceId
32 | | from app.types.converters import as_int, as_optional_str, as_str
33 | | from app.utils.time_utils import time_utils
34 | | from app.utils.structlog_config import log_error, log_info
   | |__________________________________________________________^
35 |
36 |   CRON_PARTS_WITH_YEAR = 7
   |
help: Organize imports

TC002 Move third-party import `apscheduler.job.Job` into a type-checking block
  --> app/services/form_service/scheduler_job_service.py:21:29
   |
19 |         APSchedulerError = Exception  # type: ignore[misc]
20 |
21 | from apscheduler.job import Job
   |                             ^^^
22 | from apscheduler.schedulers.base import BaseScheduler
23 | from apscheduler.triggers.cron import CronTrigger
   |
help: Move into type-checking block

TC002 Move third-party import `apscheduler.schedulers.base.BaseScheduler` into a type-checking block
  --> app/services/form_service/scheduler_job_service.py:22:41
   |
21 | from apscheduler.job import Job
22 | from apscheduler.schedulers.base import BaseScheduler
   |                                         ^^^^^^^^^^^^^
23 | from apscheduler.triggers.cron import CronTrigger
24 | from apscheduler.triggers.date import DateTrigger
   |
help: Move into type-checking block

D105 Missing docstring in magic method
  --> app/services/form_service/scheduler_job_service.py:51:9
   |
49 |     id: ResourceIdentifier = field(init=False)
50 |
51 |     def __post_init__(self) -> None:
   |         ^^^^^^^^^^^^^
52 |         self.id = str(getattr(self.job, "id", ""))
   |

COM812 [*] Trailing comma missing
   --> app/services/form_service/scheduler_job_service.py:116:81
    |
115 |     def validate(
116 |         self, data: MutablePayloadDict, *, resource: SchedulerJobResource | None
    |                                                                                 ^
117 |     ) -> ServiceResult[MutablePayloadDict]:
118 |         """校验触发器配置是否合法.
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/services/form_service/scheduler_job_service.py:186:84
    |
185 |     def upsert(
186 |         self, payload: PayloadMapping, resource: SchedulerJobResource | None = None
    |                                                                                    ^
187 |     ) -> ServiceResult[SchedulerJobResource]:
188 |         """更新内置任务的触发器配置.
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/services/form_service/scheduler_job_service.py:202:105
    |
200 |         if not validation.success:
201 |             return ServiceResult.fail(
202 |                 validation.message or "验证失败", message_key=validation.message_key, extra=validation.extra
    |                                                                                                             ^
203 |             )
    |
help: Add trailing comma

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/user_service.py:3:1
   |
 1 |   """用户表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import re
 6 | | from typing import TYPE_CHECKING, ClassVar
 7 | |
 8 | | from flask_login import current_user
 9 | |
10 | | from app.constants import UserRole
11 | | from app.models.user import MIN_USER_PASSWORD_LENGTH, User
12 | | from sqlalchemy.orm import Query
13 | |
14 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
15 | | from app.types.converters import as_bool, as_optional_str, as_str
16 | | from app.utils.data_validator import sanitize_form_data
17 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
18 |
19 |   if TYPE_CHECKING:
   |
help: Organize imports

TC002 Move third-party import `sqlalchemy.orm.Query` into a type-checking block
  --> app/services/form_service/user_service.py:12:28
   |
10 | from app.constants import UserRole
11 | from app.models.user import MIN_USER_PASSWORD_LENGTH, User
12 | from sqlalchemy.orm import Query
   |                            ^^^^^
13 |
14 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
   |
help: Move into type-checking block

TC002 Move third-party import `sqlalchemy.orm.Query` into a type-checking block
  --> app/services/ledgers/database_ledger_service.py:13:28
   |
12 | from sqlalchemy import and_, func, or_
13 | from sqlalchemy.orm import Query, Session
   |                            ^^^^^
14 |
15 | from app import db
   |
help: Move into type-checking block

TC002 Move third-party import `sqlalchemy.orm.Session` into a type-checking block
  --> app/services/ledgers/database_ledger_service.py:13:35
   |
12 | from sqlalchemy import and_, func, or_
13 | from sqlalchemy.orm import Query, Session
   |                                   ^^^^^^^
14 |
15 | from app import db
   |
help: Move into type-checking block

TRY300 Consider moving this statement to an `else` block
   --> app/services/ledgers/database_ledger_service.py:103:13
    |
101 |               ]
102 |
103 | /             return {
104 | |                 "items": rows,
105 | |                 "total": total,
106 | |                 "page": page,
107 | |                 "per_page": per_page,
108 | |             }
    | |_____________^
109 |           except Exception as exc:
110 |               log_error(
    |

D205 1 blank line required between summary line and description
 --> app/services/partition_management_service.py:1:1
  |
1 | / """分区管理服务
2 | | 负责创建、清理与查询数据库容量相关表的分区信息.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/partition_management_service.py:16:1
   |
14 |       from types import TracebackType
15 |
16 | / from sqlalchemy import func, select, text
17 | | from sqlalchemy.sql import table
18 | | from sqlalchemy.exc import SQLAlchemyError
19 | |
20 | | from app import db
21 | | from app.errors import DatabaseError
22 | | from app.utils.structlog_config import log_error, log_info, log_warning
23 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
24 |
25 |   MODULE = "partition_service"
   |
help: Organize imports

D107 Missing docstring in `__init__`
  --> app/services/partition_management_service.py:67:9
   |
65 |     """PostgreSQL 分区管理服务."""
66 |
67 |     def __init__(self) -> None:
   |         ^^^^^^^^
68 |         self.tables: dict[str, dict[str, str]] = {
69 |             "stats": {
   |

INP001 File `app/services/statistics/account_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/account_statistics_service.py:1:1

INP001 File `app/services/statistics/database_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/database_statistics_service.py:1:1

COM812 [*] Trailing comma missing
  --> app/services/statistics/database_statistics_service.py:47:72
   |
45 |     try:
46 |         query = InstanceDatabase.query.join(Instance, Instance.id == InstanceDatabase.instance_id).filter(
47 |             Instance.is_active.is_(True), Instance.deleted_at.is_(None)
   |                                                                        ^
48 |         )
   |
help: Add trailing comma

TRY300 Consider moving this statement to an `else` block
  --> app/services/statistics/database_statistics_service.py:66:9
   |
64 |           deleted_databases = deleted_databases.scalar() or 0
65 |
66 | /         return {
67 | |             "total_databases": total_databases,
68 | |             "active_databases": active_databases,
69 | |             "inactive_databases": inactive_databases,
70 | |             "deleted_databases": deleted_databases,
71 | |         }
   | |_________^
72 |       except Exception as exc:
73 |           log_error("获取数据库统计失败", module="database_statistics", exception=exc)
   |

C901 `fetch_aggregations` is too complex (12 > 10)
  --> app/services/statistics/database_statistics_service.py:93:5
   |
93 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
94 |     *,
95 |     instance_id: int | None,
   |

PLR0913 Too many arguments in function definition (11 > 5)
  --> app/services/statistics/database_statistics_service.py:93:5
   |
93 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
94 |     *,
95 |     instance_id: int | None,
   |

PLR0912 Too many branches (13 > 12)
  --> app/services/statistics/database_statistics_service.py:93:5
   |
93 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
94 |     *,
95 |     instance_id: int | None,
   |

COM812 [*] Trailing comma missing
   --> app/services/statistics/database_statistics_service.py:208:120
    |
206 |             aggregations = (
207 |                 query.filter(
208 |                     tuple_(DatabaseSizeAggregation.instance_id, DatabaseSizeAggregation.database_name).in_(pair_values)
    |                                                                                                                        ^
209 |                 )
210 |                 .order_by(DatabaseSizeAggregation.period_start.asc())
    |
help: Add trailing comma

C901 `fetch_aggregation_summary` is too complex (11 > 10)
   --> app/services/statistics/database_statistics_service.py:245:5
    |
245 | def fetch_aggregation_summary(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
246 |     *,
247 |     instance_id: int | None,
    |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/services/statistics/database_statistics_service.py:245:5
    |
245 | def fetch_aggregation_summary(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
246 |     *,
247 |     instance_id: int | None,
    |

INP001 File `app/services/statistics/instance_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/instance_statistics_service.py:1:1

TRY300 Consider moving this statement to an `else` block
  --> app/services/statistics/instance_statistics_service.py:55:9
   |
53 |           normal_instances = active_instances
54 |
55 | /         return {
56 | |             "total_instances": total_instances,
57 | |             "active_instances": active_instances,
58 | |             "normal_instances": normal_instances,
59 | |             "disabled_instances": disabled_instances,
60 | |             "deleted_instances": deleted_instances,
61 | |         }
   | |_________^
62 |       except Exception as exc:
63 |           log_error("获取实例汇总失败", module="instance_statistics", exception=exc)
   |

PLC0415 `import` should be at the top-level of a file
  --> app/services/statistics/instance_statistics_service.py:89:9
   |
87 |     """
88 |     try:
89 |         from app.models.instance_size_stat import InstanceSizeStat
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
90 |
91 |         recent_date = time_utils.now_china().date() - timedelta(days=recent_days)
   |

INP001 File `app/services/statistics/log_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/log_statistics_service.py:1:1

INP001 File `app/services/statistics/partition_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/partition_statistics_service.py:1:1

D205 1 blank line required between summary line and description
 --> app/services/sync_session_service.py:1:1
  |
1 | / """鲸落 - 同步会话服务
2 | | 管理同步会话和实例记录的业务逻辑.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/services/sync_session_service.py:30:9
   |
28 |     """
29 |
30 |     def __init__(self) -> None:
   |         ^^^^^^^^
31 |         self.system_logger = get_system_logger()
32 |         self.sync_logger = get_sync_logger()
   |

COM812 [*] Trailing comma missing
  --> app/services/sync_session_service.py:62:92
   |
61 |     def create_session(
62 |         self, sync_type: str, sync_category: str = "account", created_by: int | None = None
   |                                                                                            ^
63 |     ) -> SyncSession:
64 |         """创建同步会话.
   |
help: Add trailing comma

TRY300 Consider moving this statement to an `else` block
  --> app/services/sync_session_service.py:97:13
   |
95 |             )
96 |
97 |             return session
   |             ^^^^^^^^^^^^^^
98 |         except Exception as e:
99 |             db.session.rollback()
   |

COM812 [*] Trailing comma missing
   --> app/services/sync_session_service.py:110:87
    |
109 |     def add_instance_records(
110 |         self, session_id: str, instance_ids: list[int], sync_category: str = "account"
    |                                                                                       ^
111 |     ) -> list[SyncInstanceRecord]:
112 |         """为会话添加实例记录.
    |
help: Add trailing comma

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:156:13
    |
154 |             )
155 |
156 |             return records
    |             ^^^^^^^^^^^^^^
157 |         except Exception as e:
158 |             db.session.rollback()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:196:13
    |
194 |             )
195 |
196 |             return True
    |             ^^^^^^^^^^^
197 |         except Exception as e:
198 |             db.session.rollback()
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/sync_session_service.py:207:9
    |
205 |             return False
206 |
207 |     def complete_instance_sync(
    |         ^^^^^^^^^^^^^^^^^^^^^^
208 |         self,
209 |         record_id: int,
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:261:13
    |
259 |             )
260 |
261 |             return True
    |             ^^^^^^^^^^^
262 |         except Exception as e:
263 |             db.session.rollback()
    |

COM812 [*] Trailing comma missing
   --> app/services/sync_session_service.py:273:93
    |
272 |     def fail_instance_sync(
273 |         self, record_id: int, error_message: str, sync_details: dict[str, Any] | None = None
    |                                                                                             ^
274 |     ) -> bool:
275 |         """标记实例同步失败.
    |
help: Add trailing comma

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:308:13
    |
306 |             )
307 |
308 |             return True
    |             ^^^^^^^^^^^
309 |         except Exception as e:
310 |             db.session.rollback()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:501:13
    |
499 |                 self.sync_logger.info("取消同步会话", module="sync_session", session_id=session_id)
500 |
501 |             return True
    |             ^^^^^^^^^^^
502 |         except Exception as e:
503 |             db.session.rollback()
    |

SLF001 Private member accessed: `_get_current_object`
  --> app/tasks/accounts_sync_tasks.py:24:16
   |
22 |     """在可用上下文中返回应用实例,避免循环导入."""
23 |     try:
24 |         return current_app._get_current_object()
   |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
25 |     except RuntimeError:
26 |         from app import create_app
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/accounts_sync_tasks.py:26:9
   |
24 |         return current_app._get_current_object()
25 |     except RuntimeError:
26 |         from app import create_app
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^
27 |
28 |         return create_app(init_scheduler_on_start=False)
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/accounts_sync_tasks.py:33:5
   |
31 | def _get_db() -> SQLAlchemy:
32 |     """延迟获取 SQLAlchemy 实例,避免循环导入."""
33 |     from app import db as db_instance
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
34 |
35 |     return db_instance
   |

PLR0915 Too many statements (73 > 50)
  --> app/tasks/accounts_sync_tasks.py:38:5
   |
38 | def sync_accounts(*, manual_run: bool = False, created_by: int | None = None, **_: object) -> None:
   |     ^^^^^^^^^^^^^
39 |     """同步账户任务 - 同步所有实例的账户信息.
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/accounts_sync_tasks.py:60:9
   |
58 |         db_handle = _get_db()
59 |
60 |         from app.services.accounts_sync.coordinator import AccountSyncCoordinator
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |         from app.services.accounts_sync.permission_manager import PermissionSyncError
62 |         from app.services.connection_adapters.adapters.base import ConnectionAdapterError
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/accounts_sync_tasks.py:61:9
   |
60 |         from app.services.accounts_sync.coordinator import AccountSyncCoordinator
61 |         from app.services.accounts_sync.permission_manager import PermissionSyncError
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
62 |         from app.services.connection_adapters.adapters.base import ConnectionAdapterError
63 |         from app.services.sync_session_service import sync_session_service
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/accounts_sync_tasks.py:62:9
   |
60 |         from app.services.accounts_sync.coordinator import AccountSyncCoordinator
61 |         from app.services.accounts_sync.permission_manager import PermissionSyncError
62 |         from app.services.connection_adapters.adapters.base import ConnectionAdapterError
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
63 |         from app.services.sync_session_service import sync_session_service
64 |         sync_logger = get_sync_logger()
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/accounts_sync_tasks.py:63:9
   |
61 |         from app.services.accounts_sync.permission_manager import PermissionSyncError
62 |         from app.services.connection_adapters.adapters.base import ConnectionAdapterError
63 |         from app.services.sync_session_service import sync_session_service
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
64 |         sync_logger = get_sync_logger()
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/accounts_sync_tasks.py:66:9
   |
64 |         sync_logger = get_sync_logger()
65 |
66 |         from app.models.instance import Instance
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
67 |         account_task_exceptions: tuple[type[BaseException], ...] = (
68 |             AppError,
   |

COM812 [*] Trailing comma missing
   --> app/tasks/accounts_sync_tasks.py:160:100
    |
158 |                     except PermissionSyncError as permission_error:
159 |                         sync_session_service.fail_instance_sync(
160 |                             record.id, str(permission_error), sync_details=permission_error.summary
    |                                                                                                    ^
161 |                         )
162 |                         sync_logger.exception(
    |
help: Add trailing comma

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/tasks/accounts_sync_tasks.py:215:33
    |
213 |                     sync_session_service.fail_instance_sync(record.id, str(exc))
214 |
215 |                     sync_logger.error(
    |                                 ^^^^^
216 |                         "实例账户同步异常",
217 |                         module="accounts_sync",
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/tasks/accounts_sync_tasks.py:251:25
    |
249 |                 db_handle.session.commit()
250 |
251 |             sync_logger.error(
    |                         ^^^^^
252 |                 "账户同步任务失败",
253 |                 module="accounts_sync",
    |

D205 1 blank line required between summary line and description
 --> app/tasks/capacity_aggregation_tasks.py:1:1
  |
1 | / """数据库大小统计聚合定时任务
2 | | 负责计算每周、每月、每季度的统计聚合数据.
3 | | """
  | |___^
4 |
5 |   from collections.abc import Sequence
  |
help: Insert single blank line

C901 `calculate_database_size_aggregations` is too complex (24 > 10)
   --> app/tasks/capacity_aggregation_tasks.py:127:5
    |
127 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
128 |     *,
129 |     manual_run: bool = False,
    |

PLR0912 Too many branches (28 > 12)
   --> app/tasks/capacity_aggregation_tasks.py:127:5
    |
127 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
128 |     *,
129 |     manual_run: bool = False,
    |

PLR0915 Too many statements (111 > 50)
   --> app/tasks/capacity_aggregation_tasks.py:127:5
    |
127 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
128 |     *,
129 |     manual_run: bool = False,
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_aggregation_tasks.py:541:13
    |
539 |                 message=result.get("message"),
540 |             )
541 |             return result
    |             ^^^^^^^^^^^^^
542 |
543 |         except AGGREGATION_TASK_EXCEPTIONS as exc:
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_aggregation_tasks.py:594:13
    |
592 |             )
593 |
594 |             return result
    |             ^^^^^^^^^^^^^
595 |
596 |         except AGGREGATION_TASK_EXCEPTIONS as exc:
    |

D205 1 blank line required between summary line and description
 --> app/tasks/capacity_collection_tasks.py:1:1
  |
1 | / """数据库大小采集定时任务
2 | | 负责每日自动采集所有数据库实例的大小信息.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

C901 `collect_database_sizes` is too complex (12 > 10)
  --> app/tasks/capacity_collection_tasks.py:36:5
   |
36 | def collect_database_sizes() -> dict[str, Any]:
   |     ^^^^^^^^^^^^^^^^^^^^^^
37 |     """容量同步定时任务.
   |

PLR0915 Too many statements (97 > 50)
  --> app/tasks/capacity_collection_tasks.py:36:5
   |
36 | def collect_database_sizes() -> dict[str, Any]:
   |     ^^^^^^^^^^^^^^^^^^^^^^
37 |     """容量同步定时任务.
   |

COM812 [*] Trailing comma missing
  --> app/tasks/capacity_collection_tasks.py:89:92
   |
87 |             instance_ids = [inst.id for inst in active_instances]
88 |             records = sync_session_service.add_instance_records(
89 |                 session.session_id, instance_ids, sync_category=SyncCategory.CAPACITY.value
   |                                                                                            ^
90 |             )
91 |             session.total_instances = len(active_instances)
   |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/tasks/capacity_collection_tasks.py:138:34
    |
136 | …                             "success": False,
137 | …                             "error": error_msg,
138 | …                         }
    |                            ^
139 | …                     )
140 | …                     continue
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/tasks/capacity_collection_tasks.py:162:34
    |
160 | …                             "success": False,
161 | …                             "error": error_msg,
162 | …                         }
    |                            ^
163 | …                     )
164 | …                     continue
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/tasks/capacity_collection_tasks.py:197:34
    |
195 | …                             "inventory": inventory_result,
196 | …                             "message": "未发现活跃数据库,已仅同步数据库列表",
197 | …                         }
    |                            ^
198 | …                     )
199 | …                     continue
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/tasks/capacity_collection_tasks.py:222:34
    |
220 | …                             "success": False,
221 | …                             "error": error_msg,
222 | …                         }
    |                            ^
223 | …                     )
224 | …                     continue
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/tasks/capacity_collection_tasks.py:244:34
    |
242 | …                             "success": False,
243 | …                             "error": error_msg,
244 | …                         }
    |                            ^
245 | …                     )
246 | …                     continue
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/tasks/capacity_collection_tasks.py:298:30
    |
296 |                                 "databases": databases_data,
297 |                                 "inventory": inventory_result,
298 |                             }
    |                              ^
299 |                         )
300 |                     finally:
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/tasks/capacity_collection_tasks.py:321:26
    |
319 |                             "success": False,
320 |                             "error": str(exc),
321 |                         }
    |                          ^
322 |                     )
    |
help: Add trailing comma

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:350:13
    |
348 |             )
349 |
350 |             return result
    |             ^^^^^^^^^^^^^
351 |
352 |         except CAPACITY_TASK_EXCEPTIONS as exc:
    |

C901 `collect_specific_instance_database_sizes` is too complex (11 > 10)
   --> app/tasks/capacity_collection_tasks.py:373:5
    |
373 | def collect_specific_instance_database_sizes(instance_id: int) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
374 |     """采集指定实例的数据库大小信息.
    |

PLR0911 Too many return statements (9 > 6)
   --> app/tasks/capacity_collection_tasks.py:373:5
    |
373 | def collect_specific_instance_database_sizes(instance_id: int) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
374 |     """采集指定实例的数据库大小信息.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:588:13
    |
586 |                       errors.append(f"实例 {instance.name}: {exc!s}")
587 |
588 | /             return {
589 | |                 "success": True,
590 | |                 "message": f"{db_type} 类型数据库大小采集完成",
591 | |                 "instances_processed": total_processed,
592 | |                 "total_size_mb": total_size_mb,
593 | |                 "errors": errors,
594 | |             }
    | |_____________^
595 |
596 |           except CAPACITY_TASK_EXCEPTIONS as exc:
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:674:9
    |
672 |           DatabaseSizeCollectorService()
673 |
674 | /         return {
675 | |             "success": True,
676 | |             "config": config_checks,
677 | |             "service_available": True,
678 | |             "message": "配置验证通过",
679 | |         }
    | |_________^
680 |
681 |       except CAPACITY_TASK_EXCEPTIONS as exc:
    |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/log_cleanup_tasks.py:45:13
   |
43 |             cleaned_files = _cleanup_temp_files()
44 |
45 |             from app.models.sync_instance_record import SyncInstanceRecord
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
46 |             from app.models.sync_session import SyncSession
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/log_cleanup_tasks.py:46:13
   |
45 |             from app.models.sync_instance_record import SyncInstanceRecord
46 |             from app.models.sync_session import SyncSession
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
47 |
48 |             deleted_sync_sessions = SyncSession.query.filter(SyncSession.created_at < cutoff_date).delete()
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
  --> app/tasks/log_cleanup_tasks.py:70:25
   |
68 |         except LOG_CLEANUP_EXCEPTIONS as exc:
69 |             db.session.rollback()
70 |             task_logger.error(
   |                         ^^^^^
71 |                 "定时任务清理失败",
72 |                 module="task",
   |

D205 1 blank line required between summary line and description
 --> app/tasks/partition_management_tasks.py:1:1
  |
1 | / """分区管理定时任务
2 | | 负责自动创建、清理和监控数据库大小统计表的分区.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

TRY300 Consider moving this statement to an `else` block
  --> app/tasks/partition_management_tasks.py:69:9
   |
67 |             message="分区创建任务已完成",
68 |         )
69 |         return payload
   |         ^^^^^^^^^^^^^^
70 |     except PARTITION_TASK_EXCEPTIONS as exc:
71 |         app_error = _as_app_error(exc)
   |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/partition_management_tasks.py:106:9
    |
104 |             message="旧分区清理任务已完成",
105 |         )
106 |         return payload
    |         ^^^^^^^^^^^^^^
107 |     except PARTITION_TASK_EXCEPTIONS as exc:
108 |         app_error = _as_app_error(exc)
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/partition_management_tasks.py:170:9
    |
168 |             message="分区健康监控完成",
169 |         )
170 |         return payload
    |         ^^^^^^^^^^^^^^
171 |     except PARTITION_TASK_EXCEPTIONS as exc:
172 |         app_error = _as_app_error(exc)
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/types/__init__.py:6:1
   |
 4 |   """
 5 |
 6 | / from app.types.accounts import PermissionSnapshot, RawAccount, RemoteAccount
 7 | | from app.types.classification import ClassificationEngineResult, RuleExpression
 8 | | from app.types.resources import (
 9 | |     ResourceContext,
10 | |     ResourceIdentifier,
11 | |     ResourceInstance,
12 | |     ResourcePayload,
13 | |     SupportsResourceId,
14 | |     TemplateContext,
15 | | )
16 | | from app.types.structures import (
17 | |     CategoryOptionDict,
18 | |     ColorHex,
19 | |     ColorName,
20 | |     ColorOptionDict,
21 | |     ColorToken,
22 | |     ContextDict,
23 | |     ContextMapping,
24 | |     ContextValue,
25 | |     CssClassName,
26 | |     FormErrorMapping,
27 | |     JsonDict,
28 | |     JsonValue,
29 | |     LoggerExtra,
30 | |     LoggerProtocol,
31 | |     MutablePayloadDict,
32 | |     NumericLike,
33 | |     PayloadMapping,
34 | |     PayloadValue,
35 | |     RouteSafetyOptions,
36 | |     StructlogEventDict,
37 | | )
38 | | from app.types.query_protocols import QueryProtocol
39 | | from app.types.sync import (
40 | |     CollectionSummary,
41 | |     DiffEntry,
42 | |     InventorySummary,
43 | |     OtherDiffEntry,
44 | |     PermissionDiffPayload,
45 | |     PrivilegeDiffEntry,
46 | |     RemoteAccountMap,
47 | |     SyncConnection,
48 | |     SyncOperationResult,
49 | |     SyncStagesSummary,
50 | |     SyncSummary,
51 | | )
   | |_^
52 |
53 |   __all__ = [
   |
help: Organize imports

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> app/types/accounts.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Mapping
  |                             ^^^^^^^
6 | from typing import TypedDict
  |
help: Move into type-checking block

I001 [*] Import block is un-sorted or un-formatted
  --> app/types/classification.py:3:1
   |
 1 |   """账户分类相关类型定义."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from typing import TypedDict, TypeAlias
 6 | | from collections.abc import Mapping
 7 | |
 8 | | from app.types.structures import JsonDict, JsonValue
   | |____________________________________________________^
 9 |
10 |   RuleExpression: TypeAlias = Mapping[str, JsonValue]
   |
help: Organize imports

D103 Missing docstring in public function
  --> app/types/converters.py:26:5
   |
26 | def as_str(value: PayloadValue | None, *, default: str = "") -> str:
   |     ^^^^^^
27 |     base = _unwrap_sequence(value)
28 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:37:5
   |
37 | def as_optional_str(value: PayloadValue | None) -> str | None:
   |     ^^^^^^^^^^^^^^^
38 |     cleaned = as_str(value, default="").strip()
39 |     return cleaned or None
   |

D103 Missing docstring in public function
  --> app/types/converters.py:42:5
   |
42 | def as_int(value: PayloadValue | None, *, default: int | None = None) -> int | None:
   |     ^^^^^^
43 |     base = _unwrap_sequence(value)
44 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:60:5
   |
60 | def as_bool(value: PayloadValue | None, *, default: bool = False) -> bool:
   |     ^^^^^^^
61 |     base = _unwrap_sequence(value)
62 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:79:5
   |
79 | def as_list_of_str(value: PayloadValue | None) -> list[str]:
   |     ^^^^^^^^^^^^^^
80 |     base = _unwrap_sequence(value)
81 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:95:5
   |
95 | def ensure_mapping(value: PayloadValue | None) -> Mapping[str, PayloadValue] | None:
   |     ^^^^^^^^^^^^^^
96 |     base = _unwrap_sequence(value)
97 |     if isinstance(base, Mapping):
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:13:9
   |
11 |     """最小化的 SQLAlchemy Query 协议,用于类型标注."""
12 |
13 |     def join(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
   |         ^^^^
14 |
15 |     def filter(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:15:9
   |
13 |     def join(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
14 |
15 |     def filter(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
   |         ^^^^^^
16 |
17 |     def filter_by(self, **kwargs: object) -> QueryProtocol[T_co]: ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:17:9
   |
15 |     def filter(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
16 |
17 |     def filter_by(self, **kwargs: object) -> QueryProtocol[T_co]: ...
   |         ^^^^^^^^^
18 |
19 |     def order_by(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:19:9
   |
17 |     def filter_by(self, **kwargs: object) -> QueryProtocol[T_co]: ...
18 |
19 |     def order_by(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
   |         ^^^^^^^^
20 |
21 |     def limit(self, count: int) -> QueryProtocol[T_co]: ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:21:9
   |
19 |     def order_by(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]: ...
20 |
21 |     def limit(self, count: int) -> QueryProtocol[T_co]: ...
   |         ^^^^^
22 |
23 |     def all(self) -> list[T_co]: ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:23:9
   |
21 |     def limit(self, count: int) -> QueryProtocol[T_co]: ...
22 |
23 |     def all(self) -> list[T_co]: ...
   |         ^^^
24 |
25 |     def count(self) -> int: ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:25:9
   |
23 |     def all(self) -> list[T_co]: ...
24 |
25 |     def count(self) -> int: ...
   |         ^^^^^
26 |
27 |     def first(self) -> T_co | None: ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:27:9
   |
25 |     def count(self) -> int: ...
26 |
27 |     def first(self) -> T_co | None: ...
   |         ^^^^^
   |

D102 Missing docstring in public method
  --> app/types/structures.py:57:9
   |
55 |     """结构化日志协议,统一 logger 的最小接口."""
56 |
57 |     def bind(self, **kwargs: JsonValue) -> LoggerProtocol: ...
   |         ^^^^
58 |
59 |     def new(self, **kwargs: JsonValue) -> LoggerProtocol: ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:59:9
   |
57 |     def bind(self, **kwargs: JsonValue) -> LoggerProtocol: ...
58 |
59 |     def new(self, **kwargs: JsonValue) -> LoggerProtocol: ...
   |         ^^^
60 |
61 |     def debug(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:61:9
   |
59 |     def new(self, **kwargs: JsonValue) -> LoggerProtocol: ...
60 |
61 |     def debug(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |         ^^^^^
62 |
63 |     def info(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:63:9
   |
61 |     def debug(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
62 |
63 |     def info(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |         ^^^^
64 |
65 |     def warning(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:65:9
   |
63 |     def info(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
64 |
65 |     def warning(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |         ^^^^^^^
66 |
67 |     def error(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:67:9
   |
65 |     def warning(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
66 |
67 |     def error(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |         ^^^^^
68 |
69 |     def exception(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:69:9
   |
67 |     def error(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
68 |
69 |     def exception(self, event: str, *args: object, **kwargs: JsonValue) -> object: ...
   |         ^^^^^^^^^
   |

I001 [*] Import block is un-sorted or un-formatted
 --> app/types/sync.py:3:1
  |
1 |   """账户/数据库同步相关类型别名."""
2 |
3 | / from __future__ import annotations
4 | |
5 | | from collections.abc import Iterable, Mapping, Sequence
6 | | from typing import TYPE_CHECKING, Any, Literal, Protocol, TypedDict, TypeAlias
  | |______________________________________________________________________________^
7 |
8 |   if TYPE_CHECKING:
  |
help: Organize imports

D102 Missing docstring in public method
  --> app/types/sync.py:21:9
   |
19 |     """数据库连接对象协议."""
20 |
21 |     def connect(self) -> bool:  # pragma: no cover - protocol
   |         ^^^^^^^
22 |         ...
   |

D102 Missing docstring in public method
  --> app/types/sync.py:24:9
   |
22 |         ...
23 |
24 |     def disconnect(self) -> None:  # pragma: no cover - protocol
   |         ^^^^^^^^^^
25 |         ...
   |

D102 Missing docstring in public method
  --> app/types/sync.py:27:9
   |
25 |         ...
26 |
27 |     def execute_query(
   |         ^^^^^^^^^^^^^
28 |         self, query: str, params: Sequence[JsonValue] | Mapping[str, JsonValue] | None = None
29 |     ) -> Iterable[Sequence[JsonValue]]:
   |

COM812 [*] Trailing comma missing
  --> app/types/sync.py:28:94
   |
27 |     def execute_query(
28 |         self, query: str, params: Sequence[JsonValue] | Mapping[str, JsonValue] | None = None
   |                                                                                              ^
29 |     ) -> Iterable[Sequence[JsonValue]]:
30 |         ...
   |
help: Add trailing comma

TC002 Move third-party import `flask_caching.Cache` into a type-checking block
  --> app/utils/cache_utils.py:14:27
   |
12 | from typing import ParamSpec, TypeAlias, TypeVar, cast
13 |
14 | from flask_caching import Cache
   |                           ^^^^^
15 |
16 | from app.utils.structlog_config import get_system_logger
   |
help: Move into type-checking block

D107 Missing docstring in `__init__`
  --> app/utils/cache_utils.py:42:9
   |
40 |     """
41 |
42 |     def __init__(self, cache: Cache) -> None:
   |         ^^^^^^^^
43 |         self.cache = cache
44 |         self.default_timeout = 300  # 5分钟默认超时
   |

ARG002 Unused method argument: `logger`
  --> app/utils/logging/handlers.py:59:24
   |
57 |         self.enabled = enabled
58 |
59 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
   |                        ^^^^^^
60 |         """处理日志事件,根据配置决定是否丢弃 DEBUG 日志.
   |

ARG002 Unused method argument: `method_name`
  --> app/utils/logging/handlers.py:59:55
   |
57 |         self.enabled = enabled
58 |
59 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
   |                                                       ^^^^^^^^^^^
60 |         """处理日志事件,根据配置决定是否丢弃 DEBUG 日志.
   |

ARG002 Unused method argument: `logger`
   --> app/utils/logging/handlers.py:109:24
    |
107 |         self.worker = worker
108 |
109 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
    |                        ^^^^^^
110 |         """处理日志事件,将其入队等待写入数据库.
    |

ARG002 Unused method argument: `method_name`
   --> app/utils/logging/handlers.py:109:55
    |
107 |         self.worker = worker
108 |
109 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
    |                                                       ^^^^^^^^^^^
110 |         """处理日志事件,将其入队等待写入数据库.
    |

TC002 Move third-party import `flask.Flask` into a type-checking block
  --> app/utils/logging/queue_worker.py:14:19
   |
12 | from typing import TYPE_CHECKING
13 |
14 | from flask import Flask
   |                   ^^^^^
15 | from flask_sqlalchemy import SQLAlchemy
   |
help: Move into type-checking block

TC002 Move third-party import `flask_sqlalchemy.SQLAlchemy` into a type-checking block
  --> app/utils/logging/queue_worker.py:15:30
   |
14 | from flask import Flask
15 | from flask_sqlalchemy import SQLAlchemy
   |                              ^^^^^^^^^^
16 |
17 | from app.types import JsonValue
   |
help: Move into type-checking block

N806 Variable `UnifiedLog` in function should be lowercase
   --> app/utils/logging/queue_worker.py:183:17
    |
181 |         db: SQLAlchemy | None = None
182 |         try:
183 |             db, UnifiedLog = _get_logging_dependencies()
    |                 ^^^^^^^^^^
184 |             with self.app.app_context():
185 |                 models = [UnifiedLog.create_log_entry(**entry) for entry in entries]
    |

D107 Missing docstring in `__init__`
  --> app/utils/password_crypto_utils.py:35:9
   |
33 |     """
34 |
35 |     def __init__(self) -> None:
   |         ^^^^^^^^
36 |         self.key = self._get_or_create_key()
37 |         self.cipher = Fernet(self.key)
   |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/rate_limiter.py:107:9
    |
105 |             return self._check_memory(identifier, endpoint, limit, window, current_time, window_start)
106 |
107 |     def _check_cache(
    |         ^^^^^^^^^^^^
108 |         self,
109 |         identifier: str,
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/rate_limiter.py:160:9
    |
158 |         }
159 |
160 |     def _check_memory(
    |         ^^^^^^^^^^^^^
161 |         self,
162 |         identifier: str,
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/response_utils.py:116:5
    |
116 | def jsonify_unified_error_message(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
117 |     message: str,
118 |     *,
    |

TC001 Move application import `app.types.ContextDict` into a type-checking block
  --> app/utils/route_safety.py:20:23
   |
18 |     from collections.abc import Callable
19 |
20 | from app.types import ContextDict, LoggerExtra, RouteSafetyOptions
   |                       ^^^^^^^^^^^
21 |
22 | P = ParamSpec("P")
   |
help: Move into type-checking block

TC001 Move application import `app.types.LoggerExtra` into a type-checking block
  --> app/utils/route_safety.py:20:36
   |
18 |     from collections.abc import Callable
19 |
20 | from app.types import ContextDict, LoggerExtra, RouteSafetyOptions
   |                                    ^^^^^^^^^^^
21 |
22 | P = ParamSpec("P")
   |
help: Move into type-checking block

TC001 Move application import `app.types.RouteSafetyOptions` into a type-checking block
  --> app/utils/route_safety.py:20:49
   |
18 |     from collections.abc import Callable
19 |
20 | from app.types import ContextDict, LoggerExtra, RouteSafetyOptions
   |                                                 ^^^^^^^^^^^^^^^^^^
21 |
22 | P = ParamSpec("P")
   |
help: Move into type-checking block

COM812 [*] Trailing comma missing
   --> app/utils/sqlserver_connection_utils.py:179:76
    |
178 |     def get_connection_string_suggestions(
179 |         self, host: str, port: int, username: str, database: str = "master"
    |                                                                            ^
180 |     ) -> list[str]:
181 |         """获取连接字符串建议.
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/utils/sqlserver_connection_utils.py:209:111
    |
207 |         # 带超时的连接字符串
208 |         suggestions.append(
209 |             f"Server={host},{port};Database={database};User Id={username};Password=***;Connection Timeout=60;"
    |                                                                                                               ^
210 |         )
    |
help: Add trailing comma

E501 Line too long (129 > 120)
   --> app/utils/sqlserver_connection_utils.py:214:121
    |
212 |         # 带加密的连接字符串
213 |         suggestions.append(
214 |             f"Server={host},{port};Database={database};User Id={username};Password=***;Encrypt=True;TrustServerCertificate=True;"
    |                                                                                                                         ^^^^^^^^^
215 |         )
    |

COM812 [*] Trailing comma missing
   --> app/utils/sqlserver_connection_utils.py:214:130
    |
212 |         # 带加密的连接字符串
213 |         suggestions.append(
214 |             f"Server={host},{port};Database={database};User Id={username};Password=***;Encrypt=True;TrustServerCertificate=True;"
    |                                                                                                                                  ^
215 |         )
    |
help: Add trailing comma

E501 Line too long (130 > 120)
   --> app/utils/sqlserver_connection_utils.py:219:121
    |
217 |         # 带重试的连接字符串
218 |         suggestions.append(
219 |             f"Server={host},{port};Database={database};User Id={username};Password=***;Connection Timeout=60;Command Timeout=300;"
    |                                                                                                                         ^^^^^^^^^^
220 |         )
    |

COM812 [*] Trailing comma missing
   --> app/utils/sqlserver_connection_utils.py:219:131
    |
217 |         # 带重试的连接字符串
218 |         suggestions.append(
219 |             f"Server={host},{port};Database={database};User Id={username};Password=***;Connection Timeout=60;Command Timeout=300;"
    |                                                                                                                                   ^
220 |         )
    |
help: Add trailing comma

C901 `_extract_main_version` is too complex (11 > 10)
   --> app/utils/version_parser.py:100:9
    |
 99 |     @classmethod
100 |     def _extract_main_version(cls, version: str, db_type: str) -> str:  # noqa: PLR0911
    |         ^^^^^^^^^^^^^^^^^^^^^
101 |         """提取主版本号.
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/views/scheduler_forms.py:3:1
   |
 1 |   """定时任务表单视图."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from typing import Never, TYPE_CHECKING, Any
 6 | |
 7 | | from flask import Response, request
 8 | | from sqlalchemy.exc import SQLAlchemyError
 9 | |
10 | | from app.errors import NotFoundError, SystemError, ValidationError
11 | | from app.forms.definitions.scheduler_job import SCHEDULER_JOB_FORM_DEFINITION
12 | | from app.utils.response_utils import jsonify_unified_error_message, jsonify_unified_success
13 | | from app.views.mixins.resource_forms import ResourceFormView
   | |____________________________________________________________^
14 |
15 |   if TYPE_CHECKING:
   |
help: Organize imports

INP001 File `migrations/env.py` is part of an implicit namespace package. Add an `__init__.py`.
--> migrations/env.py:1:1

ANN201 Missing return type annotation for public function `get_engine`
  --> migrations/env.py:22:5
   |
22 | def get_engine():
   |     ^^^^^^^^^^
23 |     """获取当前 Flask 应用绑定的 SQLAlchemy Engine.
   |
help: Add return type annotation

ANN201 Missing return type annotation for public function `get_engine_url`
  --> migrations/env.py:43:5
   |
43 | def get_engine_url():
   |     ^^^^^^^^^^^^^^
44 |     """生成数据库连接串,供 Alembic 配置使用.
   |
help: Add return type annotation

ANN201 Missing return type annotation for public function `get_metadata`
  --> migrations/env.py:65:5
   |
63 | target_db = current_app.extensions["migrate"].db
64 |
65 | def get_metadata():
   |     ^^^^^^^^^^^^
66 |     """获取迁移需要的元数据对象.
   |
help: Add return type annotation

ANN001 Missing type annotation for function argument `_context`
   --> migrations/env.py:119:37
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                     ^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

ANN001 Missing type annotation for function argument `_revision`
   --> migrations/env.py:119:47
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                               ^^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

ANN001 Missing type annotation for function argument `directives`
   --> migrations/env.py:119:58
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                                          ^^^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

N999 Invalid module name: 'gunicorn-dev.conf'
--> nginx/gunicorn/gunicorn-dev.conf.py:1:1

N999 Invalid module name: 'gunicorn-prod.conf'
--> nginx/gunicorn/gunicorn-prod.conf.py:1:1

D100 Missing docstring in public module
--> tmp_ble_test.py:1:1

I001 [*] Import block is un-sorted or un-formatted
 --> tmp_ble_test.py:1:1
  |
1 | import contextlib
  | ^^^^^^^^^^^^^^^^^
2 | with contextlib.suppress(BaseException):
3 |     pass
  |
help: Organize imports

Found 178 errors.
[*] 38 fixable with the `--fix` option (22 hidden fixes can be enabled with the `--unsafe-fixes` option).
