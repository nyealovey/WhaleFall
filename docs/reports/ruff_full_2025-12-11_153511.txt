TC001 Move application import `app.types.structures.LoggerExtra` into a type-checking block
  --> app/errors/__init__.py:15:34
   |
13 | from app.constants import HttpStatus
14 | from app.constants.system_constants import ErrorCategory, ErrorMessages, ErrorSeverity
15 | from app.types.structures import LoggerExtra
   |                                  ^^^^^^^^^^^
   |
help: Move into type-checking block

D413 [*] Missing blank line after last section ("Returns")
  --> app/errors/__init__.py:41:9
   |
39 |         """根据 message key 获取默认文案.
40 |
41 |         Returns:
   |         ^^^^^^^
42 |             str: 对应 `ErrorMessages` 中的默认消息.
43 |         """
   |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
  --> app/errors/__init__.py:50:9
   |
48 |         """根据严重度判断是否可恢复.
49 |
50 |         Returns:
   |         ^^^^^^^
51 |             bool: 当严重度为 LOW/MEDIUM 时返回 True.
52 |         """
   |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Args")
  --> app/errors/__init__.py:95:9
   |
93 |         """初始化基础业务异常.
94 |
95 |         Args:
   |         ^^^^
96 |             message: 直接使用的错误提示,缺省时会根据 message_key 推导.
97 |             options: 包含 message_key、extra、severity、category、status_code 的配置对象.
   |
help: Add blank line after "Args"

D413 [*] Missing blank line after last section ("Returns")
   --> app/errors/__init__.py:113:9
    |
111 |         """返回异常实例对应的严重度.
112 |
113 |         Returns:
    |         ^^^^^^^
114 |             ErrorSeverity: 结合元数据或动态覆写后的严重度枚举值.
115 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/errors/__init__.py:122:9
    |
120 |         """返回异常所属的业务分类.
121 |
122 |         Returns:
    |         ^^^^^^^
123 |             ErrorCategory: 统一的错误分类,用于统计与监控.
124 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/errors/__init__.py:131:9
    |
129 |         """返回异常对应的 HTTP 状态码.
130 |
131 |         Returns:
    |         ^^^^^^^
132 |             int: 对外暴露的 HTTP 状态码,默认为异常元数据配置.
133 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/errors/__init__.py:140:9
    |
138 |         """表示该异常是否可恢复.
139 |
140 |         Returns:
    |         ^^^^^^^
141 |             bool: 严重度为 LOW 或 MEDIUM 时为 True,表示可重试或自动修复.
142 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/errors/__init__.py:339:5
    |
337 |         default: 无法匹配时的默认状态码.
338 |
339 |     Returns:
    |     ^^^^^^^
340 |         int: 与异常对应的 HTTP 状态码.
341 |     """
    |
help: Add blank line after "Returns"

PLR0913 Too many arguments in function definition (8 > 5)
  --> app/models/credential.py:52:9
   |
50 |     deleted_at = db.Column(db.DateTime(timezone=True), nullable=True)
51 |
52 |     def __init__(
   |         ^^^^^^^^
53 |         self,
54 |         name: str,
   |

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/database_size_aggregation.py:123:9
    |
121 |         """返回聚合记录的调试字符串.
122 |
123 |         Returns:
    |         ^^^^^^^
124 |             str: 包含实例、数据库与周期信息的可读文本.
125 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/database_size_aggregation.py:136:9
    |
134 |         将日期与 Decimal 等字段转换为 JSON 友好的基础类型,便于响应体或日志输出.
135 |
136 |         Returns:
    |         ^^^^^^^
137 |             dict: 包含统计周期、大小指标与增长率的字典数据.
138 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/database_size_stat.py:108:9
    |
106 |         """返回统计记录的文本表示.
107 |
108 |         Returns:
    |         ^^^^^^^
109 |             str: 包含实例与采集日期的调试信息.
110 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/database_size_stat.py:121:9
    |
119 |         将日期与时间字段转换为 ISO 字符串,以便 API 响应或任务日志消费.
120 |
121 |         Returns:
    |         ^^^^^^^
122 |             dict: 含大小指标与采集时间的序列化结果.
123 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
  --> app/models/database_type_config.py:66:9
   |
64 |         """返回数据库类型配置的调试表示.
65 |
66 |         Returns:
   |         ^^^^^^^
67 |             str: 含名称的可读文本,便于日志排查.
68 |         """
   |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
  --> app/models/database_type_config.py:75:9
   |
73 |         """获取 JSON 存储的特性列表.
74 |
75 |         Returns:
   |         ^^^^^^^
76 |             list[str]: 解码后的特性集合,解析失败时返回空列表.
77 |         """
   |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
  --> app/models/database_type_config.py:92:9
   |
90 |             value: 需要持久化的特性名称列表.
91 |
92 |         Returns:
   |         ^^^^^^^
93 |             None: 属性赋值完成即结束.
94 |         """
   |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/database_type_config.py:100:9
    |
 98 |         """转换为易于序列化的字典.
 99 |
100 |         Returns:
    |         ^^^^^^^
101 |             dict[str, Any]: 包含显示信息、连接参数及元数据的字典.
102 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/database_type_config.py:126:9
    |
124 |         """查询启用状态的数据库类型.
125 |
126 |         Returns:
    |         ^^^^^^^
127 |             list[DatabaseTypeConfig]: 已激活且按排序规则排列的配置列表.
128 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/database_type_config.py:138:9
    |
136 |             name: 数据库类型唯一标识.
137 |
138 |         Returns:
    |         ^^^^^^^
139 |             DatabaseTypeConfig: 匹配到的配置实例,若不存在则返回 None.
140 |         """
    |
help: Add blank line after "Returns"

PLR0913 Too many arguments in function definition (9 > 5)
  --> app/models/instance.py:95:9
   |
93 |     # sync_data关系已移除,因为SyncData表已删除
94 |
95 |     def __init__(
   |         ^^^^^^^^
96 |         self,
97 |         name: str,
   |

E501 Line too long (121 > 120)
  --> app/models/instance_account.py:38:115
   |
36 |     db_type = db.Column(db.String(50), nullable=False, comment="数据库类型")
37 |     is_active = db.Column(db.Boolean, default=True, nullable=False, comment="账户是否活跃")
38 |     first_seen_at = db.Column(db.DateTime(timezone=True), nullable=False, default=time_utils.now, comment="首次发现时间")
   |                                                                                                                         ^
39 |     last_seen_at = db.Column(db.DateTime(timezone=True), nullable=False, default=time_utils.now, comment="最后发现时间")
40 |     deleted_at = db.Column(db.DateTime(timezone=True), nullable=True, comment="删除时间")
   |

E501 Line too long (123 > 120)
  --> app/models/instance_size_stat.py:42:118
   |
40 |     deleted_at = db.Column(db.DateTime(timezone=True), nullable=True, comment="删除时间")
41 |     created_at = db.Column(db.DateTime(timezone=True), default=time_utils.now, comment="创建时间")
42 |     updated_at = db.Column(db.DateTime(timezone=True), default=time_utils.now, onupdate=time_utils.now, comment="更新时间")
   |                                                                                                                          ^^
43 |
44 |     # 关系
   |

D413 [*] Missing blank line after last section ("Returns")
  --> app/models/unified_log.py:65:9
   |
63 |         """返回统一日志记录的调试字符串.
64 |
65 |         Returns:
   |         ^^^^^^^
66 |             str: 含日志 ID、级别、模块及时间戳的文本.
67 |         """
   |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
  --> app/models/unified_log.py:73:9
   |
71 |         """转换为字典格式.
72 |
73 |         Returns:
   |         ^^^^^^^
74 |             dict[str, Any]: 包含时间、级别、模块与上下文的序列化结果.
75 |         """
   |
help: Add blank line after "Returns"

PLR0913 Too many arguments in function definition (6 > 5)
  --> app/models/unified_log.py:92:9
   |
91 |     @classmethod
92 |     def create_log_entry(
   |         ^^^^^^^^^^^^^^^^
93 |         cls,
94 |         level: LogLevel,
   |

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/unified_log.py:111:9
    |
109 |             timestamp: 指定日志时间,未提供时使用当前时间.
110 |
111 |         Returns:
    |         ^^^^^^^
112 |             UnifiedLog: 尚未持久化的日志模型对象.
113 |         """
    |
help: Add blank line after "Returns"

D413 [*] Missing blank line after last section ("Returns")
   --> app/models/unified_log.py:137:9
    |
135 |             hours: 统计的时间范围(小时),默认 24 小时.
136 |
137 |         Returns:
    |         ^^^^^^^
138 |             dict[str, Any]: 包含总数、分级别、分模块等统计指标的字典.
139 |         """
    |
help: Add blank line after "Returns"

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/routes/accounts/ledgers.py:274:5
    |
274 | def _build_accounts_json_response(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
275 |     pagination: Pagination,
276 |     stats: dict[str, int],
    |

PLC0415 `import` should be at the top-level of a file
   --> app/routes/auth.py:310:5
    |
309 |     """
310 |     from flask_wtf.csrf import generate_csrf
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
311 |     return jsonify_unified_success(
312 |         data={"csrf_token": generate_csrf()},
    |

D205 1 blank line required between summary line and description
 --> app/routes/cache.py:2:1
  |
2 | / """鲸落 - 缓存管理路由
3 | | 提供缓存管理相关的API接口.
4 | | """
  | |___^
5 |
6 |   from flask import Blueprint, Response, request
  |
help: Insert single blank line

C901 `aggregate_current` is too complex (26 > 10)
  --> app/routes/capacity/aggregations.py:59:5
   |
57 | @view_required
58 | @require_csrf
59 | def aggregate_current() -> Response:  # noqa: PLR0915
   |     ^^^^^^^^^^^^^^^^^
60 |     """手动触发当前周期数据聚合.
   |

C901 `_execute` is too complex (25 > 10)
  --> app/routes/capacity/aggregations.py:75:9
   |
73 |     }
74 |
75 |     def _execute() -> Response:  # noqa: PLR0912, PLR0915
   |         ^^^^^^^^
76 |         period_type = "daily"
77 |         scope = requested_scope
   |

D205 1 blank line required between summary line and description
 --> app/routes/capacity/databases.py:1:1
  |
1 | / """数据库统计 API 路由
2 | | 提供数据库大小监控、历史数据、统计聚合等接口
3 | | 专注于数据库层面的统计功能.
4 | | """
  | |___^
5 |
6 |   import contextlib
  |
help: Insert single blank line

D202 [*] No blank lines allowed after function docstring (found 1)
  --> app/routes/capacity/instances.py:49:9
   |
47 |     @property
48 |     def offset(self) -> int:
49 |         """计算分页偏移."""
   |         ^^^^^^^^^^^^^^^^^^^
50 |
51 |         return max(self.page - 1, 0) * self.per_page
   |
help: Remove blank line(s) after function docstring

C901 `fetch_instance_summary` is too complex (12 > 10)
   --> app/routes/capacity/instances.py:192:5
    |
190 | @login_required
191 | @view_required
192 | def fetch_instance_summary() -> Response:
    |     ^^^^^^^^^^^^^^^^^^^^^^
193 |     """获取实例聚合汇总信息(实例统计层面).
    |

C901 `_execute` is too complex (11 > 10)
   --> app/routes/capacity/instances.py:209:9
    |
207 |     query_params = request.args.to_dict(flat=False)
208 |
209 |     def _execute() -> Response:
    |         ^^^^^^^^
210 |         instance_id = request.args.get("instance_id", type=int)
211 |         db_type = request.args.get("db_type")
    |

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:296:5
    |
295 | def _extract_instance_metrics_filters() -> InstanceMetricsFilters:
296 |     """解析列表查询参数."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^
297 |
298 |     instance_id = request.args.get("instance_id", type=int)
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:327:5
    |
325 |     time_range: str | None,
326 | ) -> tuple[str | None, str | None]:
327 |     """根据快捷时间范围填充起止日期."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
328 |
329 |     if time_range and not start_date and not end_date:
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:338:5
    |
337 | def _build_instance_metrics_query(filters: InstanceMetricsFilters) -> InstanceAggregationQuery:
338 |     """根据过滤条件构建实例聚合查询."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
339 |
340 |     base_query = InstanceSizeAggregation.query.join(Instance).filter(
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:364:5
    |
362 |     filters: InstanceMetricsFilters,
363 | ) -> tuple[list[InstanceSizeAggregation], int]:
364 |     """查询实例聚合记录."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^
365 |
366 |     if filters.get_all:
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:398:5
    |
396 |     aggregations: list[InstanceSizeAggregation],
397 | ) -> list[dict[str, Any]]:
398 |     """转换聚合记录,补充实例元数据."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
399 |
400 |     serialized: list[dict[str, Any]] = []
    |
help: Remove blank line(s) after function docstring

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/capacity/instances.py:418:5
    |
416 |     filters: InstanceMetricsFilters,
417 | ) -> dict[str, Any]:
418 |     """构造返回给前端的分页载荷."""
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
419 |
420 |     total_pages = max((total + filters.per_page - 1) // filters.per_page, 1)
    |
help: Remove blank line(s) after function docstring

D205 1 blank line required between summary line and description
 --> app/routes/common.py:1:1
  |
1 | / """通用 API 路由
2 | | 提供跨模块使用的通用接口.
3 | | """
  | |___^
4 |
5 |   from flask import Blueprint, Response, request
  |
help: Insert single blank line

C901 `index` is too complex (12 > 10)
   --> app/routes/credentials.py:160:5
    |
158 | @login_required
159 | @view_required
160 | def index() -> str:
    |     ^^^^^
161 |     """凭据管理首页.
    |

C901 `list_credentials` is too complex (11 > 10)
   --> app/routes/credentials.py:418:5
    |
416 | @login_required
417 | @view_required
418 | def list_credentials() -> "Response":
    |     ^^^^^^^^^^^^^^^^
419 |     """获取凭据列表 API.
    |

D205 1 blank line required between summary line and description
 --> app/routes/databases/capacity_sync.py:1:1
  |
1 | / """数据库域:容量同步 API 路由
2 | | 专注于数据同步功能,不包含统计功能.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

D205 1 blank line required between summary line and description
 --> app/routes/files.py:1:1
  |
1 | / """文件导入导出路由
2 | | 统一处理全局的导出/上传相关接口.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/files.py:5:1
   |
 3 |   """
 4 |
 5 | / from __future__ import annotations
 6 | |
 7 | | import csv
 8 | | import io
 9 | | import json
10 | | from collections.abc import Iterable, Mapping
11 | | from itertools import groupby
12 | | from dataclasses import dataclass
13 | | from datetime import datetime
14 | | from typing import cast
15 | |
16 | | from flask import Blueprint, Response, request
17 | | from flask_login import login_required
18 | | from sqlalchemy import desc, or_
19 | | from sqlalchemy.exc import SQLAlchemyError
20 | |
21 | | from app import db
22 | | from app.constants import DatabaseType, HttpHeaders
23 | | from app.constants.import_templates import (
24 | |     INSTANCE_IMPORT_TEMPLATE_HEADERS,
25 | |     INSTANCE_IMPORT_TEMPLATE_SAMPLE,
26 | | )
27 | | from app.errors import ValidationError
28 | | from app.models.account_permission import AccountPermission
29 | | from app.models.account_classification import AccountClassificationAssignment
30 | | from app.models.instance import Instance
31 | | from app.models.instance_account import InstanceAccount
32 | | from app.models.tag import Tag
33 | | from app.models.unified_log import LogLevel, UnifiedLog
34 | | from app.services.ledgers.database_ledger_service import DatabaseLedgerService
35 | | from app.types import QueryProtocol
36 | | from app.utils.decorators import view_required
37 | | from app.utils.route_safety import log_with_context, safe_route_call
38 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
39 |
40 |   # 创建蓝图
   |
help: Organize imports

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
  --> app/routes/files.py:10:29
   |
 8 | import io
 9 | import json
10 | from collections.abc import Iterable, Mapping
   |                             ^^^^^^^^
11 | from itertools import groupby
12 | from dataclasses import dataclass
   |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
  --> app/routes/files.py:10:39
   |
 8 | import io
 9 | import json
10 | from collections.abc import Iterable, Mapping
   |                                       ^^^^^^^
11 | from itertools import groupby
12 | from dataclasses import dataclass
   |
help: Move into type-checking block

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/routes/files.py:538:5
    |
536 | @login_required
537 | def export_logs() -> Response:
538 |     """导出日志 API."""
    |     ^^^^^^^^^^^^^^^^^^^
539 |
540 |     format_type = request.args.get("format", "json")
    |
help: Remove blank line(s) after function docstring

RUF005 Consider `(*CACHE_EXCEPTIONS, ConnectionError)` instead of concatenation
  --> app/routes/health.py:27:60
   |
26 | DATABASE_HEALTH_EXCEPTIONS: tuple[type[BaseException], ...] = (SQLAlchemyError,)
27 | CACHE_HEALTH_EXCEPTIONS: tuple[type[BaseException], ...] = CACHE_EXCEPTIONS + (ConnectionError,)
   |                                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
28 | SYSTEM_HEALTH_EXCEPTIONS: tuple[type[BaseException], ...] = (psutil.Error, OSError, ValueError)
29 | UPTIME_EXCEPTIONS: tuple[type[BaseException], ...] = (AttributeError, TypeError, ValueError)
   |
help: Replace with `(*CACHE_EXCEPTIONS, ConnectionError)`

D205 1 blank line required between summary line and description
 --> app/routes/history/logs.py:2:1
  |
2 | / """鲸落 - 统一日志系统API路由
3 | | 提供日志查询、展示和管理的RESTful API.
4 | | """
  | |___^
5 |
6 |   from datetime import datetime, timedelta
  |
help: Insert single blank line

C901 `_search_logs_impl` is too complex (15 > 10)
   --> app/routes/history/logs.py:141:5
    |
141 | def _search_logs_impl() -> Response:  # noqa: PLR0912, PLR0915
    |     ^^^^^^^^^^^^^^^^^
142 |     page = int(request.args.get("page", 1))
143 |     per_page = int(request.args.get("per_page", 50))
    |

C901 `get_log_stats` is too complex (11 > 10)
   --> app/routes/history/logs.py:417:5
    |
415 | @logs_bp.route("/api/stats", methods=["GET"])
416 | @login_required
417 | def get_log_stats() -> tuple[dict, int]:
    |     ^^^^^^^^^^^^^
418 |     """获取日志统计 API(兼容旧前端).
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/instances/batch.py:3:1
   |
 1 |   """Instances 域:批量创建与删除路由."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import csv
 6 | | import io
 7 | | from typing import Any
 8 | |
 9 | | from werkzeug.datastructures import FileStorage
10 | |
11 | | from flask import Blueprint, Response, request
12 | | from flask_login import current_user, login_required
13 | |
14 | | from app import db
15 | | from app.constants import HttpStatus
16 | | from app.constants.import_templates import (
17 | |     INSTANCE_IMPORT_REQUIRED_FIELDS,
18 | |     INSTANCE_IMPORT_TEMPLATE_HEADERS,
19 | | )
20 | | from app.constants.system_constants import ErrorCategory
21 | | from app.errors import SystemError, ValidationError
22 | | from app.services.instances import InstanceBatchCreationService, InstanceBatchDeletionService
23 | | from app.utils.decorators import create_required, delete_required, require_csrf
24 | | from app.utils.response_utils import jsonify_unified_error_message, jsonify_unified_success
25 | | from app.utils.route_safety import safe_route_call
   | |__________________________________________________^
26 |
27 |   instances_batch_bp = Blueprint(
   |
help: Organize imports

TC002 Move third-party import `werkzeug.datastructures.FileStorage` into a type-checking block
  --> app/routes/instances/batch.py:9:37
   |
 7 | from typing import Any
 8 |
 9 | from werkzeug.datastructures import FileStorage
   |                                     ^^^^^^^^^^^
10 |
11 | from flask import Blueprint, Response, request
   |
help: Move into type-checking block

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/instances/detail.py:3:1
   |
 1 |   """实例详情相关接口."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from collections.abc import Mapping, Sequence
 6 | | from datetime import date, datetime
 7 | | from types import SimpleNamespace
 8 | | from typing import Any, cast
 9 | |
10 | | from flask import Blueprint, Response, render_template, request
11 | | from flask_login import current_user, login_required
12 | | from sqlalchemy import or_
13 | |
14 | | from app import db
15 | | from app.constants.database_types import DatabaseType
16 | | from app.errors import ConflictError, ValidationError
17 | | from app.models.account_change_log import AccountChangeLog
18 | | from app.models.account_permission import AccountPermission
19 | | from app.models.credential import Credential
20 | | from app.models.database_size_stat import DatabaseSizeStat
21 | | from app.models.instance import Instance
22 | | from app.models.instance_database import InstanceDatabase
23 | | from app.services.accounts_sync.account_query_service import get_accounts_by_instance
24 | | from app.services.database_type_service import DatabaseTypeService
25 | | from app.utils.data_validator import DataValidator
26 | | from app.types import QueryProtocol
27 | | from app.utils.decorators import require_csrf, update_required, view_required
28 | | from app.utils.response_utils import jsonify_unified_success
29 | | from app.utils.route_safety import safe_route_call
30 | | from app.utils.structlog_config import log_info
31 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
32 |
33 |   instances_detail_bp = Blueprint("instances_detail", __name__, url_prefix="/instances")
   |
help: Organize imports

PERF401 Use a list comprehension to create a transformed list
   --> app/routes/instances/detail.py:210:13
    |
208 |           history = []
209 |           for log in change_logs:
210 | /             history.append(
211 | |                 {
212 | |                     "id": log.id,
213 | |                     "change_type": log.change_type,
214 | |                     "change_time": (time_utils.format_china_time(log.change_time) if log.change_time else "未知"),
215 | |                     "status": log.status,
216 | |                     "message": log.message,
217 | |                     "privilege_diff": log.privilege_diff,
218 | |                     "other_diff": log.other_diff,
219 | |                     "session_id": log.session_id,
220 | |                 },
221 | |             )
    | |_____________^
222 |
223 |           return jsonify_unified_success(
    |
help: Replace for loop with list comprehension

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/routes/instances/detail.py:589:5
    |
589 | def _fetch_latest_database_sizes(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
590 |     instance_id: int,
591 |     database_name: str | None,
    |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/routes/instances/detail.py:690:5
    |
690 | def _fetch_historical_database_sizes(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
691 |     instance_id: int,
692 |     database_name: str | None,
    |

C901 `list_instances_data` is too complex (13 > 10)
   --> app/routes/instances/manage.py:245:5
    |
243 | @login_required
244 | @view_required
245 | def list_instances_data() -> Response:
    |     ^^^^^^^^^^^^^^^^^^^
246 |     """Grid.js 实例列表 API.
    |

C901 `_execute` is too complex (12 > 10)
   --> app/routes/instances/manage.py:255:9
    |
254 |     """
255 |     def _execute() -> Response:
    |         ^^^^^^^^
256 |         page = max(request.args.get("page", 1, type=int), 1)
257 |         limit = min(max(request.args.get("limit", 20, type=int), 1), 100)
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/routes/instances/manage.py:394:13
    |
392 |           items = []
393 |           for instance in pagination.items:
394 | /             items.append(
395 | |                 {
396 | |                     "id": instance.id,
397 | |                     "name": instance.name,
398 | |                     "db_type": instance.db_type,
399 | |                     "host": instance.host,
400 | |                     "port": instance.port,
401 | |                     "description": instance.description or "",
402 | |                     "is_active": instance.is_active,
403 | |                     "main_version": instance.main_version,
404 | |                     "active_db_count": active_database_counts.get(instance.id, 0),
405 | |                     "active_account_count": active_account_counts.get(instance.id, 0),
406 | |                     "last_sync_time": (
407 | |                         last_sync_times.get(instance.id).isoformat()
408 | |                         if last_sync_times.get(instance.id)
409 | |                         else None
410 | |                     ),
411 | |                     "tags": tags_map.get(instance.id, []),
412 | |                 },
413 | |             )
    | |_____________^
414 |
415 |           return jsonify_unified_success(
    |
help: Replace for loop with list comprehension

C901 `get_core_aggregation_metrics` is too complex (39 > 10)
   --> app/routes/partition.py:382:5
    |
380 | @login_required
381 | @view_required
382 | def get_core_aggregation_metrics() -> Response:  # noqa: PLR0915
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
383 |     """获取核心聚合指标数据.
    |

C901 `_execute` is too complex (38 > 10)
   --> app/routes/partition.py:395:9
    |
393 |     requested_days = request.args.get("days", 7, type=int)
394 |
395 |     def _execute() -> Response:  # noqa: PLR0912, PLR0915
    |         ^^^^^^^^
396 |         period_type = requested_period_type
397 |         days = requested_days
    |

E501 Line too long (129 > 120)
   --> app/routes/partition.py:532:121
    |
530 |             for period_key, metrics in period_metrics.items():
531 |                 if metrics["days_in_period"] > 0:
532 |                     daily_metrics[period_key]["instance_count"] = round(metrics["instance_count"] / metrics["days_in_period"], 1)
    |                                                                                                                         ^^^^^^^^^
533 |                     daily_metrics[period_key]["database_count"] = round(metrics["database_count"] / metrics["days_in_period"], 1)
534 |                     daily_metrics[period_key]["instance_aggregation_count"] = metrics["instance_aggregation_count"]
    |

E501 Line too long (129 > 120)
   --> app/routes/partition.py:533:121
    |
531 |                 if metrics["days_in_period"] > 0:
532 |                     daily_metrics[period_key]["instance_count"] = round(metrics["instance_count"] / metrics["days_in_period"], 1)
533 |                     daily_metrics[period_key]["database_count"] = round(metrics["database_count"] / metrics["days_in_period"], 1)
    |                                                                                                                         ^^^^^^^^^
534 |                     daily_metrics[period_key]["instance_aggregation_count"] = metrics["instance_aggregation_count"]
535 |                     daily_metrics[period_key]["database_aggregation_count"] = metrics["database_aggregation_count"]
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/scheduler.py:4:1
   |
 2 |   """定时任务管理路由."""
 3 |
 4 | / from __future__ import annotations
 5 | |
 6 | | import threading
 7 | | from datetime import timedelta
 8 | | from typing import cast
 9 | |
10 | | from apscheduler.job import Job
11 | | from apscheduler.jobstores.base import JobLookupError
12 | | from apscheduler.schedulers.background import BackgroundScheduler
13 | | from flask import Blueprint, Response, render_template
14 | | from flask_login import current_user, login_required  # type: ignore[import-untyped]  # Flask-Login 未提供类型存根, 后续在 third_party_         …
15 | | from sqlalchemy.exc import SQLAlchemyError
16 | |
17 | | from app import create_app
18 | | from app.constants.scheduler_jobs import BUILTIN_TASK_IDS
19 | | from app.constants.sync_constants import SyncCategory, SyncOperationType
20 | | from app.errors import AppError, ConflictError, NotFoundError, SystemError
21 | | from app.models.unified_log import UnifiedLog
22 | | from app.scheduler import _reload_all_jobs, get_scheduler
23 | | from app.services.sync_session_service import sync_session_service
24 | | from app.utils.decorators import require_csrf, scheduler_manage_required, scheduler_view_required
25 | | from app.utils.response_utils import jsonify_unified_success
26 | | from app.utils.route_safety import log_with_context, safe_route_call
27 | | from app.utils.structlog_config import log_info, log_warning
28 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
29 |
30 |   CRON_FIELD_COUNT = 8
   |
help: Organize imports

TC002 Move third-party import `apscheduler.schedulers.background.BackgroundScheduler` into a type-checking block
  --> app/routes/scheduler.py:12:47
   |
10 | from apscheduler.job import Job
11 | from apscheduler.jobstores.base import JobLookupError
12 | from apscheduler.schedulers.background import BackgroundScheduler
   |                                               ^^^^^^^^^^^^^^^^^^^
13 | from flask import Blueprint, Response, render_template
14 | from flask_login import current_user, login_required  # type: ignore[import-untyped]  # Flask-Login 未提供类型存根, 后续在 third_party_         …
   |
help: Move into type-checking block

E402 Module level import not at top of file
  --> app/routes/scheduler.py:38:1
   |
36 | CRON_MINUTE_INDEX = 6
37 | CRON_SECOND_INDEX = 7
38 | from app.views.scheduler_forms import SchedulerJobFormView
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
39 |
40 | # 创建蓝图
   |

I001 [*] Import block is un-sorted or un-formatted
  --> app/routes/users.py:4:1
   |
 2 |   """鲸落 - 用户管理路由."""
 3 |
 4 | / from flask import Blueprint, Response, flash, render_template, request
 5 | | from flask_login import current_user, login_required
 6 | |
 7 | | from app import db
 8 | | from app.constants import STATUS_ACTIVE_OPTIONS, FlashCategory, HttpStatus, UserRole
 9 | | from app.errors import ConflictError, SystemError, ValidationError
10 | | from app.models.user import User
11 | | from app.services.users import UserFormService
12 | | from app.utils.decorators import (
13 | |     create_required,
14 | |     delete_required,
15 | |     require_csrf,
16 | |     update_required,
17 | |     view_required,
18 | | )
19 | | from app.utils.response_utils import jsonify_unified_success
20 | | from app.utils.sensitive_data import scrub_sensitive_fields
21 | | from app.utils.route_safety import safe_route_call
22 | | from app.utils.structlog_config import log_info
23 | | from app.views.user_forms import UserFormView
   | |_____________________________________________^
24 |
25 |   # 创建蓝图
   |
help: Organize imports

UP035 [*] Import from `collections.abc` instead: `Callable`
  --> app/scheduler.py:9:1
   |
 7 | import os
 8 | from pathlib import Path
 9 | from typing import IO, Callable
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
10 |
11 | import yaml
   |
help: Import from `collections.abc`

TRY300 Consider moving this statement to an `else` block
   --> app/scheduler.py:322:9
    |
320 |         _LOCK_STATE.pid = current_pid
321 |         logger.info("调度器锁已获取,当前进程负责运行定时任务", pid=os.getpid())
322 |         return True
    |         ^^^^^^^^^^^
323 |     except BlockingIOError:
324 |         handle.close()
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:424:9
    |
423 |         # 等待调度器完全启动
424 |         import time
    |         ^^^^^^^^^^^
425 |         time.sleep(2)
    |

TRY300 Consider moving this statement to an `else` block
   --> app/scheduler.py:434:9
    |
433 |         logger.info("调度器初始化完成")
434 |         return scheduler
    |         ^^^^^^^^^^^^^^^^
435 |     except SCHEDULER_INIT_EXCEPTIONS as init_error:
436 |         logger.exception("调度器初始化失败", error=str(init_error))
    |

C901 `_load_tasks_from_config` is too complex (22 > 10)
   --> app/scheduler.py:512:5
    |
512 | def _load_tasks_from_config(*, force: bool = False) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
513 |     """从配置文件加载默认任务并注册.
    |

PLR0912 Too many branches (23 > 12)
   --> app/scheduler.py:512:5
    |
512 | def _load_tasks_from_config(*, force: bool = False) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
513 |     """从配置文件加载默认任务并注册.
    |

PLR0915 Too many statements (74 > 50)
   --> app/scheduler.py:512:5
    |
512 | def _load_tasks_from_config(*, force: bool = False) -> None:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
513 |     """从配置文件加载默认任务并注册.
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:522:5
    |
521 |     """
522 |     from app.tasks.accounts_sync_tasks import sync_accounts
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
523 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
524 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:523:5
    |
521 |     """
522 |     from app.tasks.accounts_sync_tasks import sync_accounts
523 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
524 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
525 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:524:5
    |
522 |     from app.tasks.accounts_sync_tasks import sync_accounts
523 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
524 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
525 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
526 |     from app.tasks.partition_management_tasks import monitor_partition_health
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:525:5
    |
523 |     from app.tasks.capacity_aggregation_tasks import calculate_database_size_aggregations
524 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
525 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
526 |     from app.tasks.partition_management_tasks import monitor_partition_health
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:526:5
    |
524 |     from app.tasks.capacity_collection_tasks import collect_database_sizes
525 |     from app.tasks.log_cleanup_tasks import cleanup_old_logs
526 |     from app.tasks.partition_management_tasks import monitor_partition_health
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
527 |
528 |     # 如果不是强制模式,检查是否已有任务
    |

PLC0415 `import` should be at the top-level of a file
   --> app/scheduler.py:602:21
    |
600 |                 # 对于cron触发器,确保使用正确的时区
601 |                 if trigger_type == "cron":
602 |                     from apscheduler.triggers.cron import CronTrigger
    |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
603 |                     # 只传递实际配置的字段,避免APScheduler自动填充默认值
604 |                     cron_kwargs = {}
    |

UP035 [*] Import from `collections.abc` instead: `Mapping`, `Sequence`
 --> app/services/account_classification/auto_classify_service.py:6:1
  |
5 | from dataclasses import dataclass, field
6 | from typing import TYPE_CHECKING, Mapping, Sequence
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |
8 | if TYPE_CHECKING:
  |
help: Import from `collections.abc`

F401 [*] `typing.Mapping` imported but unused
 --> app/services/account_classification/auto_classify_service.py:6:35
  |
5 | from dataclasses import dataclass, field
6 | from typing import TYPE_CHECKING, Mapping, Sequence
  |                                   ^^^^^^^
7 |
8 | if TYPE_CHECKING:
  |
help: Remove unused import

F401 [*] `typing.Sequence` imported but unused
 --> app/services/account_classification/auto_classify_service.py:6:44
  |
5 | from dataclasses import dataclass, field
6 | from typing import TYPE_CHECKING, Mapping, Sequence
  |                                            ^^^^^^^^
7 |
8 | if TYPE_CHECKING:
  |
help: Remove unused import

F401 [*] `app.types.JsonValue` imported but unused
  --> app/services/account_classification/auto_classify_service.py:9:65
   |
 8 | if TYPE_CHECKING:
 9 |     from app.types import ClassificationEngineResult, JsonDict, JsonValue
   |                                                                 ^^^^^^^^^
10 | from app.services.account_classification.orchestrator import AccountClassificationService
11 | from app.utils.structlog_config import log_error, log_info
   |
help: Remove unused import: `app.types.JsonValue`

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> app/services/account_classification/cache.py:5:1
  |
3 | from __future__ import annotations
4 |
5 | from typing import TYPE_CHECKING, Mapping
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
6 |
7 | from app.services.cache_service import CacheService, cache_manager
  |
help: Import from `collections.abc`

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/account_classification/cache.py:11:5
   |
10 |   if TYPE_CHECKING:
11 | /     from collections.abc import Iterable
12 | |     from app.types import JsonDict, JsonValue
   | |_____________________________________________^
   |
help: Organize imports

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/account_classification/classifiers/mysql_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Remove unused import

F401 [*] `collections.abc.Sequence` imported but unused
 --> app/services/account_classification/classifiers/mysql_classifier.py:8:38
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                                      ^^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Remove unused import

F401 [*] `typing.Any` imported but unused
  --> app/services/account_classification/classifiers/mysql_classifier.py:9:35
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import TYPE_CHECKING, Any, cast
   |                                   ^^^
10 |
11 | from app.utils.structlog_config import log_error
   |
help: Remove unused import

F401 [*] `typing.cast` imported but unused
  --> app/services/account_classification/classifiers/mysql_classifier.py:9:40
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import TYPE_CHECKING, Any, cast
   |                                        ^^^^
10 |
11 | from app.utils.structlog_config import log_error
   |
help: Remove unused import

C901 `evaluate` is too complex (41 > 10)
  --> app/services/account_classification/classifiers/mysql_classifier.py:43:9
   |
41 |     db_type = "mysql"
42 |
43 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
44 |         """评估账户是否满足 MySQL 规则表达式.
   |

PLR0911 Too many return statements (10 > 6)
  --> app/services/account_classification/classifiers/mysql_classifier.py:43:9
   |
41 |     db_type = "mysql"
42 |
43 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
44 |         """评估账户是否满足 MySQL 规则表达式.
   |

PLR0912 Too many branches (43 > 12)
  --> app/services/account_classification/classifiers/mysql_classifier.py:43:9
   |
41 |     db_type = "mysql"
42 |
43 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
44 |         """评估账户是否满足 MySQL 规则表达式.
   |

PLR0915 Too many statements (85 > 50)
  --> app/services/account_classification/classifiers/mysql_classifier.py:43:9
   |
41 |     db_type = "mysql"
42 |
43 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
44 |         """评估账户是否满足 MySQL 规则表达式.
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/account_classification/classifiers/mysql_classifier.py:175:13
    |
173 |                     return False
174 |
175 |             return True
    |             ^^^^^^^^^^^
176 |         except CLASSIFIER_EVALUATION_EXCEPTIONS as exc:
177 |             log_error("评估MySQL规则失败", module="account_classification", error=str(exc))
    |

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> app/services/account_classification/classifiers/oracle_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/account_classification/classifiers/oracle_classifier.py:8:38
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                                      ^^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

C901 `evaluate` is too complex (15 > 10)
  --> app/services/account_classification/classifiers/oracle_classifier.py:41:9
   |
39 |     db_type = "oracle"
40 |
41 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
42 |         """评估账户是否满足 Oracle 规则表达式.
   |

PLR0912 Too many branches (14 > 12)
  --> app/services/account_classification/classifiers/oracle_classifier.py:41:9
   |
39 |     db_type = "oracle"
40 |
41 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
42 |         """评估账户是否满足 Oracle 规则表达式.
   |

COM812 [*] Trailing comma missing
   --> app/services/account_classification/classifiers/oracle_classifier.py:101:95
    |
100 |             required_object_privs = cast(
101 |                 "Sequence[Mapping[str, str]] | None", rule_expression.get("object_privileges")
    |                                                                                               ^
102 |             ) or []
103 |             if required_object_privs:
    |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/services/account_classification/classifiers/oracle_classifier.py:122:99
    |
121 |             required_tablespace = cast(
122 |                 "Sequence[Mapping[str, str]] | None", rule_expression.get("tablespace_privileges")
    |                                                                                                   ^
123 |             ) or []
124 |             if required_tablespace:
    |
help: Add trailing comma

PERF401 Use `list.extend` to create a transformed list
   --> app/services/account_classification/classifiers/oracle_classifier.py:185:21
    |
183 |                   perms = privileges if isinstance(privileges, list) else [privileges]
184 |                   for privilege in perms:
185 | /                     normalized.append(
186 | |                         {
187 | |                             "tablespace_name": tablespace_name,
188 | |                             "privilege": privilege,
189 | |                         },
190 | |                     )
    | |_____________________^
191 |           elif isinstance(source, list):
192 |               normalized = [item for item in source if isinstance(item, dict)]
    |
help: Replace for loop with list.extend

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/account_classification/classifiers/postgresql_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Remove unused import: `collections.abc.Mapping`

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/account_classification/classifiers/postgresql_classifier.py:8:38
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                                      ^^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

F401 [*] `typing.Any` imported but unused
  --> app/services/account_classification/classifiers/postgresql_classifier.py:9:35
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import TYPE_CHECKING, Any, cast
   |                                   ^^^
10 |
11 | from app.utils.structlog_config import log_error
   |
help: Remove unused import: `typing.Any`

C901 `evaluate` is too complex (11 > 10)
  --> app/services/account_classification/classifiers/postgresql_classifier.py:42:9
   |
40 |     db_type = "postgresql"
41 |
42 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
43 |         """评估账户是否满足 PostgreSQL 规则表达式.
   |

COM812 [*] Trailing comma missing
  --> app/services/account_classification/classifiers/postgresql_classifier.py:75:80
   |
74 |             required_predefined_roles = cast(
75 |                 "Sequence[str] | None", rule_expression.get("predefined_roles")
   |                                                                                ^
76 |             ) or []
77 |             if required_predefined_roles:
   |
help: Add trailing comma

COM812 [*] Trailing comma missing
  --> app/services/account_classification/classifiers/postgresql_classifier.py:90:83
   |
89 |             required_database_perms = cast(
90 |                 "Sequence[str] | None", rule_expression.get("database_privileges")
   |                                                                                   ^
91 |             ) or []
92 |             if required_database_perms:
   |
help: Add trailing comma

COM812 [*] Trailing comma missing
   --> app/services/account_classification/classifiers/postgresql_classifier.py:103:85
    |
102 |             required_tablespace_perms = cast(
103 |                 "Sequence[str] | None", rule_expression.get("tablespace_privileges")
    |                                                                                     ^
104 |             ) or []
105 |             if required_tablespace_perms:
    |
help: Add trailing comma

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/account_classification/classifiers/sqlserver_classifier.py:8:29
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Remove unused import: `collections.abc.Mapping`

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/account_classification/classifiers/sqlserver_classifier.py:8:38
  |
6 | from __future__ import annotations
7 |
8 | from collections.abc import Mapping, Sequence
  |                                      ^^^^^^^^
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

F401 [*] `typing.Any` imported but unused
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:9:35
   |
 8 | from collections.abc import Mapping, Sequence
 9 | from typing import TYPE_CHECKING, Any, cast
   |                                   ^^^
10 |
11 | from app.utils.structlog_config import log_error
   |
help: Remove unused import: `typing.Any`

C901 `evaluate` is too complex (11 > 10)
  --> app/services/account_classification/classifiers/sqlserver_classifier.py:42:9
   |
40 |     db_type = "sqlserver"
41 |
42 |     def evaluate(self, account: AccountPermission, rule_expression: RuleExpression) -> bool:
   |         ^^^^^^^^
43 |         """评估账户是否满足 SQL Server 规则表达式.
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/account_classification/orchestrator.py:111:13
    |
109 |             )
110 |
111 |             return {"success": True, "message": "自动分类完成", **result}
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
112 |         except CLASSIFICATION_RUNTIME_EXCEPTIONS as exc:
113 |             log_error("优化后的自动分类失败", module="account_classification", error=str(exc))
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/services/account_classification/orchestrator.py:379:17
    |
377 |         for account in filtered_accounts:
378 |             if self._evaluate_rule(account, rule):
379 |                 matched_accounts.append(account)
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
380 |         return matched_accounts
    |
help: Replace for loop with list comprehension

TRY300 Consider moving this statement to an `else` block
  --> app/services/account_classification/repositories.py:97:13
   |
95 |                 )
96 |             db.session.commit()
97 |             return deleted
   |             ^^^^^^^^^^^^^^
98 |         except SQLAlchemyError as exc:
99 |             db.session.rollback()
   |

PERF401 Use a list comprehension to create a transformed list
   --> app/services/account_classification/repositories.py:192:13
    |
190 |           payload: list[dict] = []
191 |           for rule in rules:
192 | /             payload.append(
193 | |                 {
194 | |                     "id": rule.id,
195 | |                     "classification_id": rule.classification_id,
196 | |                     "db_type": rule.db_type,
197 | |                     "rule_name": rule.rule_name,
198 | |                     "rule_expression": rule.rule_expression,
199 | |                     "is_active": rule.is_active,
200 | |                     "created_at": rule.created_at.isoformat() if rule.created_at else None,
201 | |                     "updated_at": rule.updated_at.isoformat() if rule.updated_at else None,
202 | |                 },
203 | |             )
    | |_____________^
204 |           return payload
    |
help: Replace for loop with list comprehension

TRY300 Consider moving this statement to an `else` block
  --> app/services/accounts_sync/accounts_sync_filters.py:74:13
   |
72 |             )
73 |
74 |             return filter_rules
   |             ^^^^^^^^^^^^^^^^^^^
75 |
76 |         except yaml.YAMLError as exc:
   |

E501 Line too long (144 > 120)
   --> app/services/accounts_sync/accounts_sync_service.py:128:121
    |
126 | …
127 | …
128 | … SyncOperationType.MANUAL_TASK.value, SyncOperationType.SCHEDULED_TASK.value]:
    |                                                        ^^^^^^^^^^^^^^^^^^^^^^^^
129 | …
130 | …
    |

UP035 [*] Import from `collections.abc` instead: `Sequence`
 --> app/services/accounts_sync/adapters/base_adapter.py:6:1
  |
5 | from abc import ABC, abstractmethod
6 | from typing import TYPE_CHECKING, Any, Sequence
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
7 |
8 | if TYPE_CHECKING:
  |
help: Import from `collections.abc`

PERF401 Use a list comprehension to create a transformed list
  --> app/services/accounts_sync/adapters/base_adapter.py:40:13
   |
38 |         normalized: list[RemoteAccount] = []
39 |         for account in raw_accounts:
40 |             normalized.append(self._normalize_account(instance, account))
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
41 |         return normalized
   |
help: Replace for loop with list comprehension

ARG002 Unused method argument: `instance`
  --> app/services/accounts_sync/adapters/base_adapter.py:45:9
   |
43 |     def enrich_permissions(
44 |         self,
45 |         instance: Instance,
   |         ^^^^^^^^
46 |         connection: object,
47 |         accounts: list[RemoteAccount],
   |

ARG002 Unused method argument: `connection`
  --> app/services/accounts_sync/adapters/base_adapter.py:46:9
   |
44 |         self,
45 |         instance: Instance,
46 |         connection: object,
   |         ^^^^^^^^^^
47 |         accounts: list[RemoteAccount],
48 |         *,
   |

ARG002 Unused method argument: `usernames`
  --> app/services/accounts_sync/adapters/base_adapter.py:49:9
   |
47 |         accounts: list[RemoteAccount],
48 |         *,
49 |         usernames: Sequence[str] | None = None,
   |         ^^^^^^^^^
50 |     ) -> list[RemoteAccount]:
51 |         """为账号列表补全权限信息.
   |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/adapters/mysql_adapter.py:6:29
  |
5 | import re
6 | from collections.abc import Sequence
  |                             ^^^^^^^^
7 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/mysql_adapter.py:99:17
    |
 97 |               where_clause, params = self._build_filter_conditions()
 98 |               user_sql = (
 99 | /                 "SELECT "
100 | |                 "    User as username, "
101 | |                 "    Host as host, "
102 | |                 "    Super_priv as is_superuser, "
103 | |                 "    account_locked as is_locked, "
104 | |                 "    Grant_priv as can_grant, "
105 | |                 "    plugin as plugin, "
106 | |                 "    password_last_changed as password_last_changed "
107 | |                 "FROM mysql.user "
108 | |                 f"WHERE User != '' AND {where_clause} "
109 | |                 "ORDER BY User, Host"
    | |_____________________________________^
110 |               )
111 |               users = connection.execute_query(user_sql, params)
    |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/adapters/oracle_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

PGH003 Use specific rule codes when ignoring type issues
  --> app/services/accounts_sync/adapters/oracle_adapter.py:25:22
   |
24 | try:  # pragma: no cover - 运行环境可能未安装 oracledb
25 |     import oracledb  # type: ignore
   |                      ^^^^^^^^^^^^^^
26 | except ImportError:  # pragma: no cover - optional dependency
27 |     oracledb = None  # type: ignore[assignment]
   |

C408 Unnecessary `tuple()` call (rewrite as a literal)
  --> app/services/accounts_sync/adapters/oracle_adapter.py:32:32
   |
30 |     ORACLE_DRIVER_EXCEPTIONS: tuple[type[BaseException], ...] = (oracledb.Error,)
31 | else:  # pragma: no cover - optional dependency
32 |     ORACLE_DRIVER_EXCEPTIONS = tuple()
   |                                ^^^^^^^
33 |
34 | ORACLE_ADAPTER_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |
help: Rewrite as a literal

RUF005 Consider iterable unpacking instead of concatenation
  --> app/services/accounts_sync/adapters/oracle_adapter.py:34:62
   |
32 |       ORACLE_DRIVER_EXCEPTIONS = tuple()
33 |
34 |   ORACLE_ADAPTER_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |  ______________________________________________________________^
35 | |     ConnectionAdapterError,
36 | |     RuntimeError,
37 | |     LookupError,
38 | |     ValueError,
39 | |     TypeError,
40 | |     KeyError,
41 | |     AttributeError,
42 | |     ConnectionError,
43 | |     TimeoutError,
44 | | ) + ORACLE_DRIVER_EXCEPTIONS
   | |____________________________^
   |
help: Replace with iterable unpacking

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/adapters/oracle_adapter.py:108:13
    |
106 |                 account_count=len(accounts),
107 |             )
108 |             return accounts
    |             ^^^^^^^^^^^^^^^
109 |         except ORACLE_ADAPTER_EXCEPTIONS as exc:
110 |             self.logger.exception(
    |

ARG002 Unused method argument: `instance`
   --> app/services/accounts_sync/adapters/oracle_adapter.py:118:34
    |
116 |             return []
117 |
118 |     def _normalize_account(self, instance: Instance, account: RawAccount) -> RemoteAccount:
    |                                  ^^^^^^^^
119 |         """规范化 Oracle 账户信息.
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/oracle_adapter.py:168:13
    |
167 |           sql = (
168 | /             "SELECT username, account_status, default_tablespace "
169 | |             "FROM dba_users "
170 | |             f"WHERE username NOT IN ({placeholders})"
    | |_____________________________________________________^
171 |           )
172 |           params = {f":{i+1}": user for i, user in enumerate(exclude_users)}
    |

PERF401 Use a list comprehension to create a transformed list
   --> app/services/accounts_sync/adapters/oracle_adapter.py:176:13
    |
174 |           results: list[RawAccount] = []
175 |           for row in rows:
176 | /             results.append(
177 | |                 {
178 | |                     "username": row[0],
179 | |                     "account_status": row[1],
180 | |                     "default_tablespace": row[2],
181 | |                     "is_dba": row[0] == "SYS",
182 | |                 },
183 | |             )
    | |_____________^
184 |           return results
    |
help: Replace for loop with list comprehension

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/adapters/postgresql_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

S608 Possible SQL injection vector through string-based query construction
  --> app/services/accounts_sync/adapters/postgresql_adapter.py:71:17
   |
69 |               where_clause, params = self._build_filter_conditions()
70 |               roles_sql = (
71 | /                 "SELECT "
72 | |                 "    rolname as username, "
73 | |                 "    rolsuper as is_superuser, "
74 | |                 "    rolcreaterole as can_create_role, "
75 | |                 "    rolcreatedb as can_create_db, "
76 | |                 "    rolreplication as can_replicate, "
77 | |                 "    rolbypassrls as can_bypass_rls, "
78 | |                 "    rolcanlogin as can_login, "
79 | |                 "    rolinherit as can_inherit, "
80 | |                 "    CASE "
81 | |                 "        WHEN rolvaliduntil = 'infinity'::timestamp THEN NULL "
82 | |                 "        WHEN rolvaliduntil = '-infinity'::timestamp THEN NULL "
83 | |                 "        ELSE rolvaliduntil "
84 | |                 "    END as valid_until "
85 | |                 "FROM pg_roles "
86 | |                 f"WHERE {where_clause} "
87 | |                 "ORDER BY rolname"
   | |__________________________________^
88 |               )
89 |               rows = connection.execute_query(roles_sql, params)
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:139:13
    |
137 |                 account_count=len(accounts),
138 |             )
139 |             return accounts
    |             ^^^^^^^^^^^^^^^
140 |         except self.POSTGRES_ADAPTER_EXCEPTIONS as exc:
141 |             self.logger.exception(
    |

ARG002 Unused method argument: `instance`
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:149:34
    |
147 |             return []
148 |
149 |     def _normalize_account(self, instance: Instance, account: RawAccount) -> RemoteAccount:
    |                                  ^^^^^^^^
150 |         """规范化 PostgreSQL 账户信息.
    |

C901 `enrich_permissions` is too complex (13 > 10)
   --> app/services/accounts_sync/adapters/postgresql_adapter.py:268:9
    |
266 |         return permissions
267 |
268 |     def enrich_permissions(
    |         ^^^^^^^^^^^^^^^^^^
269 |         self,
270 |         instance: Instance,
    |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> app/services/accounts_sync/adapters/sqlserver_adapter.py:7:29
  |
5 | import re
6 | import time
7 | from collections.abc import Iterable, Sequence
  |                             ^^^^^^^^
8 | from re import Pattern
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/adapters/sqlserver_adapter.py:7:39
  |
5 | import re
6 | import time
7 | from collections.abc import Iterable, Sequence
  |                                       ^^^^^^^^
8 | from re import Pattern
9 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

PGH003 Use specific rule codes when ignoring type issues
  --> app/services/accounts_sync/adapters/sqlserver_adapter.py:29:21
   |
28 | try:  # pragma: no cover - 运行环境可能未安装 SQL Server 驱动
29 |     import pymssql  # type: ignore
   |                     ^^^^^^^^^^^^^^
30 | except ImportError:  # pragma: no cover
31 |     pymssql = None  # type: ignore[assignment]
   |

C408 Unnecessary `tuple()` call (rewrite as a literal)
  --> app/services/accounts_sync/adapters/sqlserver_adapter.py:36:35
   |
34 |     SQLSERVER_DRIVER_EXCEPTIONS: tuple[type[BaseException], ...] = (pymssql.Error,)
35 | else:  # pragma: no cover - optional dependency
36 |     SQLSERVER_DRIVER_EXCEPTIONS = tuple()
   |                                   ^^^^^^^
37 |
38 | SQLSERVER_ADAPTER_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |
help: Rewrite as a literal

RUF005 Consider iterable unpacking instead of concatenation
  --> app/services/accounts_sync/adapters/sqlserver_adapter.py:38:65
   |
36 |       SQLSERVER_DRIVER_EXCEPTIONS = tuple()
37 |
38 |   SQLSERVER_ADAPTER_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |  _________________________________________________________________^
39 | |     ConnectionAdapterError,
40 | |     RuntimeError,
41 | |     LookupError,
42 | |     ValueError,
43 | |     TypeError,
44 | |     KeyError,
45 | |     AttributeError,
46 | |     ConnectionError,
47 | |     TimeoutError,
48 | |     OSError,
49 | | ) + SQLSERVER_DRIVER_EXCEPTIONS
   | |_______________________________^
   |
help: Replace with iterable unpacking

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:113:13
    |
111 |                 account_count=len(accounts),
112 |             )
113 |             return accounts
    |             ^^^^^^^^^^^^^^^
114 |         except SQLSERVER_ADAPTER_EXCEPTIONS as exc:
115 |             self.logger.exception(
    |

ARG002 Unused method argument: `instance`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:123:34
    |
121 |             return []
122 |
123 |     def _normalize_account(self, instance: Instance, account: RawAccount) -> RemoteAccount:
    |                                  ^^^^^^^^
124 |         """规范化 SQL Server 账户信息.
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:319:9
    |
317 |         return compiled
318 |
319 |     def _get_login_permissions(
    |         ^^^^^^^^^^^^^^^^^^^^^^
320 |         self,
321 |         connection: object,
    |

ARG002 Unused method argument: `connection`
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:321:9
    |
319 |     def _get_login_permissions(
320 |         self,
321 |         connection: object,
    |         ^^^^^^^^^^
322 |         login_name: str,
323 |         *,
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:451:15
    |
450 |           placeholders = ", ".join(["%s"] * len(normalized))
451 |           sql = f"""
    |  _______________^
452 | |             SELECT member.name AS login_name, role.name AS role_name
453 | |             FROM sys.server_role_members rm
454 | |             JOIN sys.server_principals role ON rm.role_principal_id = role.principal_id
455 | |             JOIN sys.server_principals member ON rm.member_principal_id = member.principal_id
456 | |             WHERE member.name IN ({placeholders})
457 | |         """
    | |___________^
458 |           rows = connection.execute_query(sql, tuple(normalized))
459 |           result: dict[str, list[str]] = {}
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:484:15
    |
483 |           placeholders = ", ".join(["%s"] * len(normalized))
484 |           sql = f"""
    |  _______________^
485 | |             SELECT sp.name AS login_name, perm.permission_name
486 | |             FROM sys.server_permissions perm
487 | |             JOIN sys.server_principals sp ON perm.grantee_principal_id = sp.principal_id
488 | |             WHERE sp.name IN ({placeholders})
489 | |         """
    | |___________^
490 |           rows = connection.execute_query(sql, tuple(normalized))
491 |           result: dict[str, list[str]] = {}
    |

C901 `_get_all_users_database_permissions_batch` is too complex (32 > 10)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:500:9
    |
498 |         return result
499 |
500 |     def _get_all_users_database_permissions_batch(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
501 |         self,
502 |         connection: object,
    |

PLR0912 Too many branches (31 > 12)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:500:9
    |
498 |         return result
499 |
500 |     def _get_all_users_database_permissions_batch(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
501 |         self,
502 |         connection: object,
    |

PLR0915 Too many statements (88 > 50)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:500:9
    |
498 |         return result
499 |
500 |     def _get_all_users_database_permissions_batch(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
501 |         self,
502 |         connection: object,
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:544:30
    |
542 |               unique_usernames = list(dict.fromkeys(usernames))
543 |               placeholders = ", ".join(["%s"] * len(unique_usernames))
544 |               login_sids_sql = f"""
    |  ______________________________^
545 | |                 SELECT name, sid
546 | |                 FROM sys.server_principals
547 | |                 WHERE name IN ({placeholders})
548 | |                   AND type IN ('S', 'U', 'G')
549 | |             """
    | |_______________^
550 |               login_rows = connection.execute_query(login_sids_sql, tuple(unique_usernames))
551 |               sid_to_logins: dict[bytes, list[str]] = {}
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:575:21
    |
573 |                   quoted_db = self._quote_identifier(db)
574 |                   principals_parts.append(
575 | /                     f"""
576 | |                     SELECT '{db}' AS db_name,
577 | |                            name COLLATE SQL_Latin1_General_CP1_CI_AS AS user_name,
578 | |                            principal_id,
579 | |                            sid
580 | |                     FROM {quoted_db}.sys.database_principals
581 | |                     WHERE type IN ('S', 'U', 'G')
582 | |                       AND name != 'dbo'
583 | |                       AND sid IN ({sid_filter})
584 | |                     """,
    | |_______________________^
585 |                   )
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:588:21
    |
587 |                   roles_parts.append(
588 | /                     f"""
589 | |                     SELECT '{db}' AS db_name,
590 | |                            role.name COLLATE SQL_Latin1_General_CP1_CI_AS AS role_name,
591 | |                            member.principal_id AS member_principal_id
592 | |                     FROM {quoted_db}.sys.database_role_members drm
593 | |                     JOIN {quoted_db}.sys.database_principals role
594 | |                       ON drm.role_principal_id = role.principal_id
595 | |                     JOIN {quoted_db}.sys.database_principals member
596 | |                       ON drm.member_principal_id = member.principal_id
597 | |                     WHERE member.sid IN ({sid_filter})
598 | |                     """,
    | |_______________________^
599 |                   )
    |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:602:21
    |
601 |   …     perms_parts.append(
602 | / …         f"""
603 | | …         SELECT '{db}' AS db_name,
604 | | …                perm.permission_name COLLATE SQL_Latin1_General_CP1_CI_AS AS permission_name,
605 | | …                perm.grantee_principal_id,
606 | | …                perm.major_id,
607 | | …                perm.minor_id,
608 | | …                CASE
609 | | …                    WHEN perm.class_desc = 'DATABASE' THEN 'DATABASE'
610 | | …                    WHEN perm.class_desc = 'SCHEMA' THEN 'SCHEMA'
611 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id = 0 THEN 'OBJECT'
612 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id > 0 THEN 'COLUMN'
613 | | …                    ELSE perm.class_desc
614 | | …                END AS permission_scope,
615 | | …                CASE
616 | | …                    WHEN perm.class_desc = 'SCHEMA' THEN SCHEMA_NAME(perm.major_id)
617 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' THEN OBJECT_SCHEMA_NAME(perm.major_id)
618 | | …                    ELSE NULL
619 | | …                END AS schema_name,
620 | | …                CASE
621 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' THEN OBJECT_NAME(perm.major_id)
622 | | …                    ELSE NULL
623 | | …                END AS object_name,
624 | | …                CASE
625 | | …                    WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id > 0 THEN COL_NAME(perm.major_id, perm.minor_id)
626 | | …                    ELSE NULL
627 | | …                END AS column_name
628 | | …         FROM {quoted_db}.sys.database_permissions perm
629 | | …         JOIN {quoted_db}.sys.database_principals dp
630 | | …           ON perm.grantee_principal_id = dp.principal_id
631 | | …         WHERE perm.state = 'G'
632 | | …           AND dp.sid IN ({sid_filter})
633 | | …         """,
    | |_____________^
634 |   …     )
    |

E501 Line too long (138 > 120)
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:625:121
    |
623 | …                     END AS object_name,
624 | …                     CASE
625 | …                         WHEN perm.class_desc = 'OBJECT_OR_COLUMN' AND perm.minor_id > 0 THEN COL_NAME(perm.major_id, perm.minor_id)
    |                                                                                                                    ^^^^^^^^^^^^^^^^^^
626 | …                         ELSE NULL
627 | …                     END AS column_name
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/adapters/sqlserver_adapter.py:733:13
    |
731 |             )
732 |
733 |             return result
    |             ^^^^^^^^^^^^^
734 |         except SQLSERVER_ADAPTER_EXCEPTIONS as exc:
735 |             self.logger.exception(
    |

TC003 Move standard library import `types.TracebackType` into a type-checking block
 --> app/services/accounts_sync/coordinator.py:6:19
  |
5 | from contextlib import AbstractContextManager
6 | from types import TracebackType
  |                   ^^^^^^^^^^^^^
7 | from typing import TYPE_CHECKING, Any, Self
  |
help: Move into type-checking block

PLR0911 Too many return statements (7 > 6)
   --> app/services/accounts_sync/coordinator.py:120:9
    |
118 |         self.disconnect()
119 |
120 |     def connect(self) -> bool:
    |         ^^^^^^^
121 |         """建立到数据库实例的连接.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/accounts_sync/coordinator.py:190:13
    |
188 |                 module=MODULE,
189 |             )
190 |             return False
    |             ^^^^^^^^^^^^
191 |         except CONNECTION_EXCEPTIONS as exc:
192 |             self._connection_failed = True
    |

E501 Line too long (122 > 120)
   --> app/services/accounts_sync/coordinator.py:391:121
    |
389 |         active_usernames = [account.username for account in active_accounts if getattr(account, "username", None)]
390 |         enriched_usernames = getattr(self, "_enriched_usernames", set())
391 |         pending_usernames = [username for username in active_usernames if username and username not in enriched_usernames]
    |                                                                                                                         ^^
392 |         if pending_usernames:
393 |             self._ensure_connection()
    |

E501 Line too long (121 > 120)
   --> app/services/accounts_sync/coordinator.py:429:121
    |
427 |             "updated": summary.get("updated", 0),
428 |             "skipped": summary.get("skipped", 0),
429 |             "processed_records": summary.get("processed_records", summary.get("created", 0) + summary.get("updated", 0)),
    |                                                                                                                         ^
430 |             "errors": summary.get("errors", []),
431 |             "message": summary.get("message"),
    |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> app/services/accounts_sync/permission_manager.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/accounts_sync/permission_manager.py:5:39
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                                       ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any, cast
  |
help: Move into type-checking block

C901 `synchronize` is too complex (11 > 10)
   --> app/services/accounts_sync/permission_manager.py:123:9
    |
121 |         self.logger = get_sync_logger()
122 |
123 |     def synchronize(
    |         ^^^^^^^^^^^
124 |         self,
125 |         instance: Instance,
    |

PLR0915 Too many statements (62 > 50)
   --> app/services/accounts_sync/permission_manager.py:123:9
    |
121 |         self.logger = get_sync_logger()
122 |
123 |     def synchronize(
    |         ^^^^^^^^^^^
124 |         self,
125 |         instance: Instance,
    |

C901 `_calculate_diff` is too complex (11 > 10)
   --> app/services/accounts_sync/permission_manager.py:360:9
    |
358 |                 setattr(record, field, None)
359 |
360 |     def _calculate_diff(
    |         ^^^^^^^^^^^^^^^
361 |         self,
362 |         record: AccountPermission,
    |

C901 `_build_change_summary` is too complex (11 > 10)
   --> app/services/accounts_sync/permission_manager.py:691:9
    |
689 |         return f"{label} 已更新"
690 |
691 |     def _build_change_summary(
    |         ^^^^^^^^^^^^^^^^^^^^^
692 |         self,
693 |         username: str,
    |

ARG002 Unused method argument: `target_date`
   --> app/services/aggregation/aggregation_service.py:106:42
    |
104 |         return instance
105 |
106 |     def _ensure_partition_for_date(self, target_date: date) -> None:
    |                                          ^^^^^^^^^^^
107 |         """保留接口,当前环境无需分区预处理.
    |

ARG002 Unused method argument: `aggregation`
   --> app/services/aggregation/aggregation_service.py:118:44
    |
116 |         return
117 |
118 |     def _commit_with_partition_retry(self, aggregation: object, start_date: date) -> None:
    |                                            ^^^^^^^^^^^
119 |         """提交聚合记录,移除分区重试逻辑.
    |

E501 Line too long (121 > 120)
   --> app/services/aggregation/aggregation_service.py:387:121
    |
386 |         failed_periods = [
387 |             period for period, result in period_results.items() if result.get("status") == AggregationStatus.FAILED.value
    |                                                                                                                         ^
388 |         ]
389 |         failed_instance_periods = [
    |

C901 `aggregate_current_period` is too complex (11 > 10)
   --> app/services/aggregation/aggregation_service.py:456:9
    |
454 |         )
455 |
456 |     def aggregate_current_period(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^
457 |         self,
458 |         period_type: str = "daily",
    |

C901 `calculate_instance_aggregations` is too complex (11 > 10)
   --> app/services/aggregation/aggregation_service.py:693:9
    |
691 |         )
692 |
693 |     def calculate_instance_aggregations(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
694 |         self,
695 |         instance_id: int,
    |

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
 --> app/services/aggregation/calculator.py:6:29
  |
5 | from calendar import monthrange
6 | from collections.abc import Callable
  |                             ^^^^^^^^
7 | from datetime import date, timedelta
  |
help: Move into type-checking block

PLR0913 Too many arguments in function definition (6 > 5)
  --> app/services/aggregation/database_aggregation_runner.py:94:9
   |
92 |             )
93 |
94 |     def aggregate_period(
   |         ^^^^^^^^^^^^^^^^
95 |         self,
96 |         period_type: str,
   |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/services/aggregation/database_aggregation_runner.py:375:9
    |
373 |         return grouped
374 |
375 |     def _persist_database_aggregation(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
376 |         self,
377 |         *,
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/aggregation/database_aggregation_runner.py:512:9
    |
510 |             ) from exc
511 |
512 |     def _apply_change_statistics(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^
513 |         self,
514 |         *,
    |

PLR0913 Too many arguments in function definition (6 > 5)
  --> app/services/aggregation/instance_aggregation_runner.py:97:9
   |
95 |             )
96 |
97 |     def aggregate_period(
   |         ^^^^^^^^^^^^^^^^
98 |         self,
99 |         period_type: str,
   |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/aggregation/instance_aggregation_runner.py:327:9
    |
325 |         ).all()
326 |
327 |     def _persist_instance_aggregation(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
328 |         self,
329 |         *,
    |

E501 Line too long (131 > 120)
   --> app/services/cache_service.py:360:121
    |
358 |         return rules
359 |
360 |     def set_classification_rules_by_db_type_cache(self, db_type: str, rules: list[dict[str, Any]], ttl: int | None = None) -> bool:
    |                                                                                                                         ^^^^^^^^^^^
361 |         """设置按数据库类型分类的规则缓存.
    |

D205 1 blank line required between summary line and description
 --> app/services/connection_adapters/__init__.py:1:1
  |
1 | / """鲸落 - 连接适配器模块
2 | | 集中提供数据库连接工厂与连接测试服务.
3 | | """
  | |___^
4 |
5 |   from .connection_factory import ConnectionFactory
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/services/connection_adapters/adapters/base.py:63:9
   |
61 |     """
62 |
63 |     def __init__(self, instance: Instance) -> None:
   |         ^^^^^^^^
64 |         self.instance = instance
65 |         self.db_logger = get_db_logger()
   |

PGH003 Use specific rule codes when ignoring type issues
  --> app/services/connection_adapters/adapters/mysql_adapter.py:14:21
   |
13 | try:  # pragma: no cover - 运行环境可能未安装 pymysql
14 |     import pymysql  # type: ignore
   |                     ^^^^^^^^^^^^^^
15 | except ImportError:  # pragma: no cover
16 |     pymysql = None  # type: ignore[assignment]
   |

C408 Unnecessary `tuple()` call (rewrite as a literal)
  --> app/services/connection_adapters/adapters/mysql_adapter.py:29:31
   |
27 |     MYSQL_DRIVER_EXCEPTIONS: tuple[type[BaseException], ...] = (pymysql.MySQLError,)
28 | else:  # pragma: no cover - optional dependency
29 |     MYSQL_DRIVER_EXCEPTIONS = tuple()
   |                               ^^^^^^^
30 |
31 | MYSQL_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |
help: Rewrite as a literal

RUF005 Consider iterable unpacking instead of concatenation
  --> app/services/connection_adapters/adapters/mysql_adapter.py:31:64
   |
29 |       MYSQL_DRIVER_EXCEPTIONS = tuple()
30 |
31 |   MYSQL_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |  ________________________________________________________________^
32 | |     ConnectionAdapterError,
33 | |     RuntimeError,
34 | |     ValueError,
35 | |     TypeError,
36 | |     ConnectionError,
37 | |     TimeoutError,
38 | |     OSError,
39 | | ) + MYSQL_DRIVER_EXCEPTIONS
   | |___________________________^
   |
help: Replace with iterable unpacking

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/mysql_adapter.py:53:13
   |
51 |         """
52 |         try:
53 |             import pymysql
   |             ^^^^^^^^^^^^^^
54 |
55 |             password = self.instance.credential.get_plain_password() if self.instance.credential else ""
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/mysql_adapter.py:71:13
   |
69 |             )
70 |             self.is_connected = True
71 |             return True
   |             ^^^^^^^^^^^
72 |         except MYSQL_CONNECTION_EXCEPTIONS as exc:
73 |             self.db_logger.exception(
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/mysql_adapter.py:111:13
    |
110 |               version = self.get_version()
111 | /             return {
112 | |                 "success": True,
113 | |                 "message": f"MySQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
114 | |                 "database_version": version,
115 | |             }
    | |_____________^
116 |           except MYSQL_CONNECTION_EXCEPTIONS as exc:
117 |               return {"success": False, "error": str(exc)}
    |

E501 Line too long (121 > 120)
   --> app/services/connection_adapters/adapters/mysql_adapter.py:113:111
    |
111 |             return {
112 |                 "success": True,
113 |                 "message": f"MySQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
    |                                                                                                                         ^
114 |                 "database_version": version,
115 |             }
    |

SIM108 Use ternary operator `bound_params = params if isinstance(params, Mapping) else tuple(params or [])` instead of `if`-`else`-block
   --> app/services/connection_adapters/adapters/mysql_adapter.py:143:13
    |
141 |           try:
142 |               bound_params: Sequence[JsonValue] | Mapping[str, JsonValue]
143 | /             if isinstance(params, Mapping):
144 | |                 bound_params = params
145 | |             else:
146 | |                 bound_params = tuple(params or [])
    | |__________________________________________________^
147 |               cursor.execute(query, bound_params)
148 |               rows = cursor.fetchall()
    |
help: Replace `if`-`else`-block with `bound_params = params if isinstance(params, Mapping) else tuple(params or [])`

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/mysql_adapter.py:164:13
    |
162 |             if result:
163 |                 return result[0][0]
164 |             return None
    |             ^^^^^^^^^^^
165 |         except MYSQL_CONNECTION_EXCEPTIONS:
166 |             return None
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/connection_adapters/adapters/oracle_adapter.py:3:1
   |
 1 |   """Oracle 数据库连接适配器."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from pathlib import Path
 6 | | from collections.abc import Mapping, Sequence
 7 | |
 8 | | from app.types import JsonValue
   | |_______________________________^
 9 |
10 |   try:  # pragma: no cover - 运行环境可能未安装 oracledb
   |
help: Organize imports

F401 [*] `collections.abc.Mapping` imported but unused
 --> app/services/connection_adapters/adapters/oracle_adapter.py:6:29
  |
5 | from pathlib import Path
6 | from collections.abc import Mapping, Sequence
  |                             ^^^^^^^
7 |
8 | from app.types import JsonValue
  |
help: Remove unused import

F401 [*] `collections.abc.Sequence` imported but unused
 --> app/services/connection_adapters/adapters/oracle_adapter.py:6:38
  |
5 | from pathlib import Path
6 | from collections.abc import Mapping, Sequence
  |                                      ^^^^^^^^
7 |
8 | from app.types import JsonValue
  |
help: Remove unused import

F401 [*] `app.types.JsonValue` imported but unused
  --> app/services/connection_adapters/adapters/oracle_adapter.py:8:23
   |
 6 | from collections.abc import Mapping, Sequence
 7 |
 8 | from app.types import JsonValue
   |                       ^^^^^^^^^
 9 |
10 | try:  # pragma: no cover - 运行环境可能未安装 oracledb
   |
help: Remove unused import: `app.types.JsonValue`

PGH003 Use specific rule codes when ignoring type issues
  --> app/services/connection_adapters/adapters/oracle_adapter.py:11:22
   |
10 | try:  # pragma: no cover - 运行环境可能未安装 oracledb
11 |     import oracledb  # type: ignore
   |                      ^^^^^^^^^^^^^^
12 | except ImportError:  # pragma: no cover
13 |     oracledb = None  # type: ignore[assignment]
   |

F401 [*] `.base.QueryParams` imported but unused
  --> app/services/connection_adapters/adapters/oracle_adapter.py:18:5
   |
16 |     ConnectionAdapterError,
17 |     DatabaseConnection,
18 |     QueryParams,
   |     ^^^^^^^^^^^
19 |     QueryResult,
20 | )
   |
help: Remove unused import

F401 [*] `.base.QueryResult` imported but unused
  --> app/services/connection_adapters/adapters/oracle_adapter.py:19:5
   |
17 |     DatabaseConnection,
18 |     QueryParams,
19 |     QueryResult,
   |     ^^^^^^^^^^^
20 | )
   |
help: Remove unused import

C408 Unnecessary `tuple()` call (rewrite as a literal)
  --> app/services/connection_adapters/adapters/oracle_adapter.py:25:32
   |
23 |     ORACLE_DRIVER_EXCEPTIONS: tuple[type[BaseException], ...] = (oracledb.Error,)
24 | else:  # pragma: no cover - optional dependency
25 |     ORACLE_DRIVER_EXCEPTIONS = tuple()
   |                                ^^^^^^^
26 |
27 | ORACLE_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |
help: Rewrite as a literal

RUF005 Consider iterable unpacking instead of concatenation
  --> app/services/connection_adapters/adapters/oracle_adapter.py:27:65
   |
25 |       ORACLE_DRIVER_EXCEPTIONS = tuple()
26 |
27 |   ORACLE_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |  _________________________________________________________________^
28 | |     ConnectionAdapterError,
29 | |     RuntimeError,
30 | |     ValueError,
31 | |     TypeError,
32 | |     ConnectionError,
33 | |     TimeoutError,
34 | |     OSError,
35 | | ) + ORACLE_DRIVER_EXCEPTIONS
   | |____________________________^
   |
help: Replace with iterable unpacking

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/oracle_adapter.py:50:13
   |
48 |         username_for_connection = None
49 |         try:
50 |             import os
   |             ^^^^^^^^^
51 |
52 |             import oracledb
   |

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/oracle_adapter.py:52:13
   |
50 |             import os
51 |
52 |             import oracledb
   |             ^^^^^^^^^^^^^^^
53 |
54 |             password = self.instance.credential.get_plain_password() if self.instance.credential else ""
   |

E501 Line too long (129 > 120)
  --> app/services/connection_adapters/adapters/oracle_adapter.py:60:121
   |
58 |             port = self.instance.port
59 |             service_name = self.instance.database_name or "ORCL"
60 |             dsn = f"(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST={host})(PORT={port}))(CONNECT_DATA=(SERVICE_NAME={service_name})))"
   |                                                                                                                         ^^^^^^^^^
61 |
62 |             if not hasattr(oracledb, "is_thin") or not oracledb.is_thin():
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/oracle_adapter.py:102:13
    |
100 |                 username=username_for_connection,
101 |             )
102 |             return True
    |             ^^^^^^^^^^^
103 |         except ORACLE_CONNECTION_EXCEPTIONS as exc:
104 |             self.db_logger.exception(
    |

F821 Undefined name `Any`
   --> app/services/connection_adapters/adapters/oracle_adapter.py:139:44
    |
137 |                 self.is_connected = False
138 |
139 |     def test_connection(self) -> dict[str, Any]:
    |                                            ^^^
140 |         """测试 Oracle 连接并返回版本信息."""
141 |         try:
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/oracle_adapter.py:146:13
    |
145 |               version = self.get_version()
146 | /             return {
147 | |                 "success": True,
148 | |                 "message": f"Oracle连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
149 | |                 "database_version": version,
150 | |             }
    | |_____________^
151 |           except ORACLE_CONNECTION_EXCEPTIONS as exc:
152 |               return {"success": False, "error": str(exc)}
    |

E501 Line too long (122 > 120)
   --> app/services/connection_adapters/adapters/oracle_adapter.py:148:111
    |
146 |             return {
147 |                 "success": True,
148 |                 "message": f"Oracle连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
    |                                                                                                                         ^^
149 |                 "database_version": version,
150 |             }
    |

F821 Undefined name `Any`
   --> app/services/connection_adapters/adapters/oracle_adapter.py:156:80
    |
154 |             self.disconnect()
155 |
156 |     def execute_query(self, query: str, params: tuple | dict | None = None) -> Any:
    |                                                                                ^^^
157 |         """执行 SQL 查询并返回全部行.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/oracle_adapter.py:189:13
    |
187 |             if result:
188 |                 return result[0][0]
189 |             return None
    |             ^^^^^^^^^^^
190 |         except ORACLE_CONNECTION_EXCEPTIONS:
191 |             return None
    |

PGH003 Use specific rule codes when ignoring type issues
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:14:21
   |
13 | try:  # pragma: no cover - 运行环境可能未安装 psycopg
14 |     import psycopg  # type: ignore
   |                     ^^^^^^^^^^^^^^
15 | except ImportError:  # pragma: no cover
16 |     psycopg = None  # type: ignore[assignment]
   |

C408 Unnecessary `tuple()` call (rewrite as a literal)
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:29:34
   |
27 |     POSTGRES_DRIVER_EXCEPTIONS: tuple[type[BaseException], ...] = (psycopg.Error,)
28 | else:  # pragma: no cover - optional dependency
29 |     POSTGRES_DRIVER_EXCEPTIONS = tuple()
   |                                  ^^^^^^^
30 |
31 | POSTGRES_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |
help: Rewrite as a literal

RUF005 Consider iterable unpacking instead of concatenation
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:31:67
   |
29 |       POSTGRES_DRIVER_EXCEPTIONS = tuple()
30 |
31 |   POSTGRES_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |  ___________________________________________________________________^
32 | |     ConnectionAdapterError,
33 | |     RuntimeError,
34 | |     ValueError,
35 | |     TypeError,
36 | |     ConnectionError,
37 | |     TimeoutError,
38 | |     OSError,
39 | | ) + POSTGRES_DRIVER_EXCEPTIONS
   | |______________________________^
   |
help: Replace with iterable unpacking

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:53:13
   |
51 |         """
52 |         try:
53 |             import psycopg
   |             ^^^^^^^^^^^^^^
54 |
55 |             password = self.instance.credential.get_plain_password() if self.instance.credential else ""
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/connection_adapters/adapters/postgresql_adapter.py:67:13
   |
65 |             )
66 |             self.is_connected = True
67 |             return True
   |             ^^^^^^^^^^^
68 |         except POSTGRES_CONNECTION_EXCEPTIONS as exc:
69 |             self.db_logger.exception(
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/postgresql_adapter.py:107:13
    |
106 |   …         version = self.get_version()
107 | / …         return {
108 | | …             "success": True,
109 | | …             "message": f"PostgreSQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
110 | | …             "database_version": version,
111 | | …         }
    | |___________^
112 |   …     except POSTGRES_CONNECTION_EXCEPTIONS as exc:
113 |   …         return {"success": False, "error": str(exc)}
    |

E501 Line too long (126 > 120)
   --> app/services/connection_adapters/adapters/postgresql_adapter.py:109:112
    |
107 | …     return {
108 | …         "success": True,
109 | …         "message": f"PostgreSQL连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
    |                                                                                                                    ^^^^^
110 | …         "database_version": version,
111 | …     }
    |

SIM108 Use ternary operator `bound_params = params if isinstance(params, Mapping) else tuple(params or [])` instead of `if`-`else`-block
   --> app/services/connection_adapters/adapters/postgresql_adapter.py:139:13
    |
137 |           try:
138 |               bound_params: Sequence[JsonValue] | Mapping[str, JsonValue]
139 | /             if isinstance(params, Mapping):
140 | |                 bound_params = params
141 | |             else:
142 | |                 bound_params = tuple(params or [])
    | |__________________________________________________^
143 |               cursor.execute(query, bound_params)
144 |               rows = cursor.fetchall()
    |
help: Replace `if`-`else`-block with `bound_params = params if isinstance(params, Mapping) else tuple(params or [])`

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/postgresql_adapter.py:160:13
    |
158 |             if result:
159 |                 return result[0][0]
160 |             return None
    |             ^^^^^^^^^^^
161 |         except POSTGRES_CONNECTION_EXCEPTIONS:
162 |             return None
    |

PGH003 Use specific rule codes when ignoring type issues
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:11:21
   |
10 | try:  # pragma: no cover - 运行环境可能未安装 pymssql
11 |     import pymssql  # type: ignore
   |                     ^^^^^^^^^^^^^^
12 | except ImportError:  # pragma: no cover
13 |     pymssql = None  # type: ignore[assignment]
   |

C408 Unnecessary `tuple()` call (rewrite as a literal)
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:26:35
   |
24 |     SQLSERVER_DRIVER_EXCEPTIONS: tuple[type[BaseException], ...] = (pymssql.Error,)
25 | else:  # pragma: no cover - optional dependency
26 |     SQLSERVER_DRIVER_EXCEPTIONS = tuple()
   |                                   ^^^^^^^
27 |
28 | SQLSERVER_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |
help: Rewrite as a literal

RUF005 Consider iterable unpacking instead of concatenation
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:28:68
   |
26 |       SQLSERVER_DRIVER_EXCEPTIONS = tuple()
27 |
28 |   SQLSERVER_CONNECTION_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |  ____________________________________________________________________^
29 | |     ConnectionAdapterError,
30 | |     RuntimeError,
31 | |     ValueError,
32 | |     TypeError,
33 | |     ConnectionError,
34 | |     TimeoutError,
35 | |     OSError,
36 | | ) + SQLSERVER_DRIVER_EXCEPTIONS
   | |_______________________________^
   |
help: Replace with iterable unpacking

D107 Missing docstring in `__init__`
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:50:9
   |
48 |     """SQL Server 数据库连接."""
49 |
50 |     def __init__(self, instance: Instance) -> None:
   |         ^^^^^^^^
51 |         super().__init__(instance)
52 |         self.driver_type: str | None = None
   |

PLC0415 `import` should be at the top-level of a file
  --> app/services/connection_adapters/adapters/sqlserver_adapter.py:95:13
   |
93 |         """
94 |         try:
95 |             import pymssql
   |             ^^^^^^^^^^^^^^
96 |
97 |             self.connection = pymssql.connect(
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:109:13
    |
107 |             self.is_connected = True
108 |             self.driver_type = "pymssql"
109 |             return True
    |             ^^^^^^^^^^^
110 |         except ImportError:
111 |             self.db_logger.exception(
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:166:13
    |
165 |   …         version = self.get_version()
166 | / …         return {
167 | | …             "success": True,
168 | | …             "message": f"SQL Server连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
169 | | …             "database_version": version,
170 | | …         }
    | |___________^
171 |   …     except SQLSERVER_CONNECTION_EXCEPTIONS as exc:
172 |   …         return {"success": False, "error": str(exc)}
    |

E501 Line too long (126 > 120)
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:168:112
    |
166 | …     return {
167 | …         "success": True,
168 | …         "message": f"SQL Server连接成功 (主机: {self.instance.host}:{self.instance.port}, 版本: {version or '未知'})",
    |                                                                                                                    ^^^^^
169 | …         "database_version": version,
170 | …     }
    |

SIM108 Use ternary operator `bound_params = params if isinstance(params, Mapping) else tuple(params or [])` instead of `if`-`else`-block
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:198:13
    |
196 |           try:
197 |               bound_params: Sequence[JsonValue] | Mapping[str, JsonValue]
198 | /             if isinstance(params, Mapping):
199 | |                 bound_params = params
200 | |             else:
201 | |                 bound_params = tuple(params or [])
    | |__________________________________________________^
202 |               cursor.execute(query, bound_params)
203 |               rows = cursor.fetchall()
    |
help: Replace `if`-`else`-block with `bound_params = params if isinstance(params, Mapping) else tuple(params or [])`

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/adapters/sqlserver_adapter.py:219:13
    |
217 |             if result:
218 |                 return result[0][0]
219 |             return None
    |             ^^^^^^^^^^^
220 |         except SQLSERVER_CONNECTION_EXCEPTIONS:
221 |             return None
    |

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/services/connection_adapters/connection_factory.py:37:26
   |
35 |       """
36 |
37 |       CONNECTION_CLASSES = {
   |  __________________________^
38 | |         "mysql": MySQLConnection,
39 | |         "postgresql": PostgreSQLConnection,
40 | |         "sqlserver": SQLServerConnection,
41 | |         "oracle": OracleConnection,
42 | |     }
   | |_____^
43 |
44 |       @staticmethod
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/connection_adapters/connection_test_service.py:95:13
    |
 93 |               db.session.commit()
 94 |
 95 | /             return {
 96 | |                 "success": True,
 97 | |                 "message": f"连接成功,数据库版本: {formatted_version}",
 98 | |                 "version": formatted_version,
 99 | |                 "database_version": instance.database_version,
100 | |                 "main_version": instance.main_version,
101 | |                 "detailed_version": instance.detailed_version,
102 | |             }
    | |_____________^
103 |
104 |           except CONNECTION_TEST_EXCEPTIONS as exc:
    |

TC003 Move standard library import `collections.abc.Iterable` into a type-checking block
 --> app/services/database_sync/adapters/base_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/base_adapter.py:5:39
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Iterable, Sequence
  |                                       ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

D107 Missing docstring in `__init__`
  --> app/services/database_sync/adapters/base_adapter.py:33:9
   |
31 |     """
32 |
33 |     def __init__(self) -> None:
   |         ^^^^^^^^
34 |         self.logger = get_system_logger()
   |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/mysql_adapter.py:7:29
  |
5 | import math
6 | import re
7 | from collections.abc import Sequence
  |                             ^^^^^^^^
8 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/services/database_sync/adapters/mysql_adapter.py:38:25
   |
36 |     """
37 |
38 |     _SYSTEM_DATABASES = {"information_schema", "performance_schema", "mysql", "sys"}
   |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
39 |     MYSQL_CAPACITY_EXCEPTIONS: tuple[type[BaseException], ...] = (
40 |         ConnectionAdapterError,
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/adapters/mysql_adapter.py:126:25
    |
124 |             tablespace_stats = self._collect_tablespace_sizes(connection, instance)
125 |         except self.MYSQL_CAPACITY_EXCEPTIONS as exc:  # pragma: no cover - defensive logging
126 |             self.logger.error(
    |                         ^^^^^
127 |                 "mysql_tablespace_collection_failed",
128 |                 instance=instance.name,
    |

C901 `_collect_tablespace_sizes` is too complex (15 > 10)
   --> app/services/database_sync/adapters/mysql_adapter.py:183:9
    |
181 |         )
182 |
183 |     def _collect_tablespace_sizes(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^
184 |         self,
185 |         connection: DatabaseConnection,
    |

PLR0912 Too many branches (15 > 12)
   --> app/services/database_sync/adapters/mysql_adapter.py:183:9
    |
181 |         )
182 |
183 |     def _collect_tablespace_sizes(
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^
184 |         self,
185 |         connection: DatabaseConnection,
    |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/oracle_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/postgresql_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/services/database_sync/adapters/postgresql_adapter.py:35:25
   |
33 |     """
34 |
35 |     _SYSTEM_DATABASES = {"postgres"}
   |                         ^^^^^^^^^^^^
36 |
37 |     def fetch_inventory(
   |

TC003 Move standard library import `collections.abc.Sequence` into a type-checking block
 --> app/services/database_sync/adapters/sqlserver_adapter.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Sequence
  |                             ^^^^^^^^
6 | from typing import TYPE_CHECKING, Any
  |
help: Move into type-checking block

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/coordinator.py:119:25
    |
117 |                 return True
118 |         except CONNECTION_EXCEPTIONS as exc:
119 |             self.logger.error(
    |                         ^^^^^
120 |                 "capacity_sync_connection_error",
121 |                 instance=self.instance.name,
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/coordinator.py:306:29
    |
304 |             except SQLAlchemyError as exc:
305 |                 db.session.rollback()
306 |                 self.logger.error(
    |                             ^^^^^
307 |                     "capacity_sync_commit_failed",
308 |                     instance=self.instance.name,
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/database_filters.py:39:9
   |
37 |     """负责加载数据库发现/容量同步所需的过滤配置."""
38 |
39 |     def __init__(self, config_path: str | Path | None = None) -> None:
   |         ^^^^^^^^
40 |         self._config_path = Path(config_path) if config_path else _DEFAULT_CONFIG_PATH
41 |         self._normalized_rules: dict[str, _FilterRule] = {}
   |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/database_sync/database_sync_service.py:7:1
   |
 5 |   """
 6 |
 7 | / from __future__ import annotations
 8 | |
 9 | | from typing import TYPE_CHECKING, Any, Self
10 | | from types import TracebackType
11 | |
12 | | from sqlalchemy.exc import SQLAlchemyError
13 | |
14 | | from app.errors import AppError
15 | | from app.services.connection_adapters.adapters.base import ConnectionAdapterError
16 | | from app.utils.structlog_config import get_system_logger
17 | |
18 | | from .coordinator import CapacitySyncCoordinator
   | |________________________________________________^
19 |
20 |   if TYPE_CHECKING:
   |
help: Organize imports

TC003 Move standard library import `types.TracebackType` into a type-checking block
  --> app/services/database_sync/database_sync_service.py:10:19
   |
 9 | from typing import TYPE_CHECKING, Any, Self
10 | from types import TracebackType
   |                   ^^^^^^^^^^^^^
11 |
12 | from sqlalchemy.exc import SQLAlchemyError
   |
help: Move into type-checking block

PLC0415 `import` should be at the top-level of a file
   --> app/services/database_sync/database_sync_service.py:233:5
    |
232 |     """
233 |     from app.models.instance import Instance
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
234 |
235 |     logger = get_system_logger()
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/database_sync_service.py:275:20
    |
273 |         except DATABASE_SYNC_EXCEPTIONS as exc:
274 |             error_msg = f"实例 {instance.name} 采集失败: {exc}"
275 |             logger.error(
    |                    ^^^^^
276 |                 "capacity_collection_failed",
277 |                 instance=instance.name,
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/inventory_manager.py:27:9
   |
25 |     """负责维护 instance_databases 表的增量同步逻辑."""
26 |
27 |     def __init__(
   |         ^^^^^^^^
28 |         self,
29 |         filter_manager: DatabaseSyncFilterManager = database_sync_filter_manager,
   |

C901 `synchronize` is too complex (11 > 10)
  --> app/services/database_sync/inventory_manager.py:34:9
   |
32 |         self.filter_manager = filter_manager
33 |
34 |     def synchronize(
   |         ^^^^^^^^^^^
35 |         self,
36 |         instance: Instance,
   |

PLR0915 Too many statements (54 > 50)
  --> app/services/database_sync/inventory_manager.py:34:9
   |
32 |         self.filter_manager = filter_manager
33 |
34 |     def synchronize(
   |         ^^^^^^^^^^^
35 |         self,
36 |         instance: Instance,
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/inventory_manager.py:127:25
    |
125 |         except SQLAlchemyError as exc:
126 |             db.session.rollback()
127 |             self.logger.error(
    |                         ^^^^^
128 |                 "inventory_sync_commit_failed",
129 |                 instance=instance.name,
    |

D107 Missing docstring in `__init__`
  --> app/services/database_sync/persistence.py:27:9
   |
25 |     """负责容量采集相关的数据持久化."""
26 |
27 |     def __init__(self) -> None:
   |         ^^^^^^^^
28 |         self.logger = get_system_logger()
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:101:25
    |
 99 |         except SQLAlchemyError as exc:
100 |             db.session.rollback()
101 |             self.logger.error(
    |                         ^^^^^
102 |                 "save_database_stats_upsert_failed",
103 |                 instance=instance.name,
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:118:25
    |
116 |         except SQLAlchemyError as exc:
117 |             db.session.rollback()
118 |             self.logger.error(
    |                         ^^^^^
119 |                 "save_database_stats_commit_failed",
120 |                 instance=instance.name,
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/database_sync/persistence.py:191:13
    |
189 |                 database_count=database_count,
190 |             )
191 |             return True
    |             ^^^^^^^^^^^
192 |         except SQLAlchemyError as exc:
193 |             self.logger.error(
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:193:25
    |
191 |             return True
192 |         except SQLAlchemyError as exc:
193 |             self.logger.error(
    |                         ^^^^^
194 |                 "save_instance_stats_failed",
195 |                 instance=instance.name,
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/services/database_sync/persistence.py:250:29
    |
248 |             except SQLAlchemyError as exc:
249 |                 db.session.rollback()
250 |                 self.logger.error(
    |                             ^^^^^
251 |                     "update_instance_total_size_commit_failed",
252 |                     instance=instance.name,
    |

D205 1 blank line required between summary line and description
 --> app/services/database_type_service.py:1:1
  |
1 | / """鲸落 - 数据库类型管理服务
2 | | 提供数据库类型的CRUD操作和业务逻辑.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/classification_rule_service.py:3:1
   |
 1 |   """账户分类规则表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import json
 6 | |
 7 | | from typing import TYPE_CHECKING, Any, cast
 8 | |
 9 | | from flask_login import current_user
10 | |
11 | | from app import db
12 | | from app.forms.definitions.account_classification_rule_constants import DB_TYPE_OPTIONS, OPERATOR_OPTIONS
13 | | from app.models.account_classification import AccountClassification, ClassificationRule
14 | | from app.services.account_classification.orchestrator import (
15 | |     CACHE_INVALIDATION_EXCEPTIONS,
16 | |     AccountClassificationService,
17 | | )
18 | | from app.services.database_type_service import DatabaseTypeService
19 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
20 | | from app.types.converters import as_bool, as_int, as_optional_str, as_str
21 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
22 |
23 |   if TYPE_CHECKING:
   |
help: Organize imports

E501 Line too long (126 > 120)
  --> app/services/form_service/classification_rule_service.py:55:121
   |
53 |         return dict(payload or {})
54 |
55 |     def validate(self, data: MutablePayloadDict, *, resource: ClassificationRule | None) -> ServiceResult[MutablePayloadDict]:
   |                                                                                                                         ^^^^^^
56 |         """校验分类规则数据.
   |

PLR0911 Too many return statements (7 > 6)
  --> app/services/form_service/classification_service.py:59:9
   |
57 |         return dict(payload or {})
58 |
59 |     def validate(self, data: MutablePayloadDict, *, resource: AccountClassification | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
60 |         """校验账户分类数据.
   |

E501 Line too long (129 > 120)
  --> app/services/form_service/classification_service.py:59:121
   |
57 |         return dict(payload or {})
58 |
59 |     def validate(self, data: MutablePayloadDict, *, resource: AccountClassification | None) -> ServiceResult[MutablePayloadDict]:
   |                                                                                                                         ^^^^^^^^^
60 |         """校验账户分类数据.
   |

FBT001 Boolean-typed positional argument in function definition
   --> app/services/form_service/credential_service.py:153:9
    |
151 |         self,
152 |         data: PayloadMapping,
153 |         require_password: bool,
    |         ^^^^^^^^^^^^^^^^
154 |     ) -> ServiceResult[MutablePayloadDict] | None:
155 |         """对凭据表单的核心字段执行逐项校验."""
    |

PLR0911 Too many return statements (7 > 6)
  --> app/services/form_service/password_service.py:44:9
   |
42 |         return sanitize_form_data(payload or {})
43 |
44 |     def validate(self, data: MutablePayloadDict, *, resource: User | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
45 |         """校验密码修改数据.
   |

E501 Line too long (131 > 120)
   --> app/services/form_service/password_service.py:128:117
    |
126 | …rce)
127 | …
128 | …"验证失败", message_key=validation.message_key, extra=validation.extra)
    |                                                              ^^^^^^^^^^^
129 | …
130 | …
    |

D205 1 blank line required between summary line and description
 --> app/services/form_service/resource_service.py:1:1
  |
1 | / """通用资源表单服务基类.
2 | | ---------------------------------
3 | | 负责封装表单校验、模型赋值、数据库提交与统一的结果返回.
4 | | """
  | |___^
5 |
6 |   from __future__ import annotations
  |
help: Insert single blank line

PLR1711 [*] Useless `return` statement at end of function
   --> app/services/form_service/resource_service.py:173:9
    |
171 |         """
172 |         del instance, data
173 |         return
    |         ^^^^^^
174 |
175 |     def build_context(self, *, resource: ResourceT | None) -> ContextDict:
    |
help: Remove useless `return` statement

E501 Line too long (131 > 120)
   --> app/services/form_service/resource_service.py:207:117
    |
205 | …rce)
206 | …
207 | …"验证失败", message_key=validation.message_key, extra=validation.extra)
    |                                                              ^^^^^^^^^^^
208 | …
209 | …
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/scheduler_job_service.py:20:1
   |
18 |           APSchedulerError = Exception  # type: ignore[misc]
19 |
20 | / from apscheduler.job import Job
21 | | from apscheduler.schedulers.base import BaseScheduler
22 | | from apscheduler.triggers.cron import CronTrigger
23 | | from apscheduler.triggers.date import DateTrigger
24 | | from apscheduler.triggers.interval import IntervalTrigger
25 | |
26 | | from app.constants.scheduler_jobs import BUILTIN_TASK_IDS
27 | | from app.errors import NotFoundError, SystemError, ValidationError
28 | | from app.scheduler import get_scheduler
29 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
30 | | from app.types import MutablePayloadDict, PayloadMapping, ResourceIdentifier, SupportsResourceId
31 | | from app.types.converters import as_int, as_optional_str, as_str
32 | | from app.utils.time_utils import time_utils
33 | | from app.utils.structlog_config import log_error, log_info
   | |__________________________________________________________^
34 |
35 |   CRON_PARTS_WITH_YEAR = 7
   |
help: Organize imports

TC002 Move third-party import `apscheduler.job.Job` into a type-checking block
  --> app/services/form_service/scheduler_job_service.py:20:29
   |
18 |         APSchedulerError = Exception  # type: ignore[misc]
19 |
20 | from apscheduler.job import Job
   |                             ^^^
21 | from apscheduler.schedulers.base import BaseScheduler
22 | from apscheduler.triggers.cron import CronTrigger
   |
help: Move into type-checking block

TC002 Move third-party import `apscheduler.schedulers.base.BaseScheduler` into a type-checking block
  --> app/services/form_service/scheduler_job_service.py:21:41
   |
20 | from apscheduler.job import Job
21 | from apscheduler.schedulers.base import BaseScheduler
   |                                         ^^^^^^^^^^^^^
22 | from apscheduler.triggers.cron import CronTrigger
23 | from apscheduler.triggers.date import DateTrigger
   |
help: Move into type-checking block

D105 Missing docstring in magic method
  --> app/services/form_service/scheduler_job_service.py:49:9
   |
47 |     id: ResourceIdentifier = field(init=False)
48 |
49 |     def __post_init__(self) -> None:
   |         ^^^^^^^^^^^^^
50 |         self.id = str(getattr(self.job, "id", ""))
   |

E501 Line too long (128 > 120)
   --> app/services/form_service/scheduler_job_service.py:113:121
    |
111 |         return SchedulerJobResource(scheduler=scheduler, job=job)
112 |
113 |     def validate(self, data: MutablePayloadDict, *, resource: SchedulerJobResource | None) -> ServiceResult[MutablePayloadDict]:
    |                                                                                                                         ^^^^^^^^
114 |         """校验触发器配置是否合法.
    |

E501 Line too long (131 > 120)
   --> app/services/form_service/scheduler_job_service.py:181:121
    |
179 |         )
180 |
181 |     def upsert(self, payload: PayloadMapping, resource: SchedulerJobResource | None = None) -> ServiceResult[SchedulerJobResource]:
    |                                                                                                                         ^^^^^^^^^^^
182 |         """更新内置任务的触发器配置.
    |

E501 Line too long (131 > 120)
   --> app/services/form_service/scheduler_job_service.py:195:117
    |
193 | …rce)
194 | …
195 | …"验证失败", message_key=validation.message_key, extra=validation.extra)
    |                                                              ^^^^^^^^^^^
196 | …
197 | …
    |

C901 `_build_trigger` is too complex (25 > 10)
   --> app/services/form_service/scheduler_job_service.py:211:9
    |
209 |         return ServiceResult.ok(resource)
210 |
211 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
212 |         """根据表单数据构建 APScheduler 触发器.
    |

PLR0911 Too many return statements (10 > 6)
   --> app/services/form_service/scheduler_job_service.py:211:9
    |
209 |         return ServiceResult.ok(resource)
210 |
211 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
212 |         """根据表单数据构建 APScheduler 触发器.
    |

PLR0912 Too many branches (21 > 12)
   --> app/services/form_service/scheduler_job_service.py:211:9
    |
209 |         return ServiceResult.ok(resource)
210 |
211 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
212 |         """根据表单数据构建 APScheduler 触发器.
    |

PLR0915 Too many statements (59 > 50)
   --> app/services/form_service/scheduler_job_service.py:211:9
    |
209 |         return ServiceResult.ok(resource)
210 |
211 |     def _build_trigger(self, data: PayloadMapping) -> CronTrigger | IntervalTrigger | DateTrigger | None:
    |         ^^^^^^^^^^^^^^
212 |         """根据表单数据构建 APScheduler 触发器.
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/services/form_service/user_service.py:3:1
   |
 1 |   """用户表单服务."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import re
 6 | | from typing import TYPE_CHECKING, ClassVar
 7 | |
 8 | | from flask_login import current_user
 9 | |
10 | | from app.constants import UserRole
11 | | from app.models.user import MIN_USER_PASSWORD_LENGTH, User
12 | | from sqlalchemy.orm import Query
13 | |
14 | | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
15 | | from app.types.converters import as_bool, as_optional_str, as_str
16 | | from app.utils.data_validator import sanitize_form_data
17 | | from app.utils.structlog_config import log_info
   | |_______________________________________________^
18 |
19 |   if TYPE_CHECKING:
   |
help: Organize imports

TC002 Move third-party import `sqlalchemy.orm.Query` into a type-checking block
  --> app/services/form_service/user_service.py:12:28
   |
10 | from app.constants import UserRole
11 | from app.models.user import MIN_USER_PASSWORD_LENGTH, User
12 | from sqlalchemy.orm import Query
   |                            ^^^^^
13 |
14 | from app.services.form_service.resource_service import BaseResourceService, ServiceResult
   |
help: Move into type-checking block

C901 `validate` is too complex (11 > 10)
  --> app/services/form_service/user_service.py:53:9
   |
51 |         return sanitize_form_data(payload or {})
52 |
53 |     def validate(self, data: MutablePayloadDict, *, resource: User | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
54 |         """校验用户数据.
   |

PLR0911 Too many return statements (8 > 6)
  --> app/services/form_service/user_service.py:53:9
   |
51 |         return sanitize_form_data(payload or {})
52 |
53 |     def validate(self, data: MutablePayloadDict, *, resource: User | None) -> ServiceResult[MutablePayloadDict]:
   |         ^^^^^^^^
54 |         """校验用户数据.
   |

F821 Undefined name `resource`
   --> app/services/form_service/user_service.py:154:13
    |
152 |         """
153 |         del resource
154 |         del resource
    |             ^^^^^^^^
155 |         return {
156 |             "role_options": [
    |

C901 `create_instances` is too complex (11 > 10)
  --> app/services/instances/batch_service.py:60:9
   |
58 |     """
59 |
60 |     def create_instances(
   |         ^^^^^^^^^^^^^^^^
61 |         self,
62 |         instances_data: list[dict[str, Any]],
   |

TRY300 Consider moving this statement to an `else` block
   --> app/services/instances/batch_service.py:299:13
    |
297 |             stats["deleted_sync_data"] = stats["deleted_account_permissions"]
298 |
299 |             return stats
    |             ^^^^^^^^^^^^
300 |         except SQLAlchemyError as exc:
301 |             db.session.rollback()
    |

TC002 Move third-party import `sqlalchemy.orm.Query` into a type-checking block
  --> app/services/ledgers/database_ledger_service.py:13:28
   |
12 | from sqlalchemy import and_, func, or_
13 | from sqlalchemy.orm import Query, Session
   |                            ^^^^^
14 |
15 | from app import db
   |
help: Move into type-checking block

TC002 Move third-party import `sqlalchemy.orm.Session` into a type-checking block
  --> app/services/ledgers/database_ledger_service.py:13:35
   |
12 | from sqlalchemy import and_, func, or_
13 | from sqlalchemy.orm import Query, Session
   |                                   ^^^^^^^
14 |
15 | from app import db
   |
help: Move into type-checking block

TRY300 Consider moving this statement to an `else` block
   --> app/services/ledgers/database_ledger_service.py:103:13
    |
101 |               ]
102 |
103 | /             return {
104 | |                 "items": rows,
105 | |                 "total": total,
106 | |                 "page": page,
107 | |                 "per_page": per_page,
108 | |             }
    | |_____________^
109 |           except Exception as exc:
110 |               log_error(
    |

D205 1 blank line required between summary line and description
 --> app/services/partition_management_service.py:1:1
  |
1 | / """分区管理服务
2 | | 负责创建、清理与查询数据库容量相关表的分区信息.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/services/partition_management_service.py:65:9
   |
63 |     """PostgreSQL 分区管理服务."""
64 |
65 |     def __init__(self) -> None:
   |         ^^^^^^^^
66 |         self.tables: dict[str, dict[str, str]] = {
67 |             "stats": {
   |

S608 Possible SQL injection vector through string-based query construction
   --> app/services/partition_management_service.py:639:17
    |
638 |         """
639 |         query = f"SELECT COUNT(*) FROM {partition_name};"
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
640 |         try:
641 |             result = db.session.execute(text(query)).scalar()
    |

PYI034 `__enter__` methods in classes like `_RollbackContext` usually return `self` at runtime
   --> app/services/partition_management_service.py:770:17
    |
768 |         """
769 |         class _RollbackContext(contextlib.AbstractContextManager[None]):
770 |             def __enter__(self) -> _RollbackContext:
    |                 ^^^^^^^^^
771 |                 return self
    |
help: Use `Self` as return type

INP001 File `app/services/statistics/account_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/account_statistics_service.py:1:1

INP001 File `app/services/statistics/database_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/database_statistics_service.py:1:1

TRY300 Consider moving this statement to an `else` block
  --> app/services/statistics/database_statistics_service.py:67:9
   |
65 |           deleted_databases = deleted_databases.scalar() or 0
66 |
67 | /         return {
68 | |             "total_databases": total_databases,
69 | |             "active_databases": active_databases,
70 | |             "inactive_databases": inactive_databases,
71 | |             "deleted_databases": deleted_databases,
72 | |         }
   | |_________^
73 |       except Exception as exc:
74 |           log_error("获取数据库统计失败", module="database_statistics", exception=exc)
   |

C901 `fetch_aggregations` is too complex (12 > 10)
  --> app/services/statistics/database_statistics_service.py:94:5
   |
94 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
95 |     *,
96 |     instance_id: int | None,
   |

PLR0913 Too many arguments in function definition (11 > 5)
  --> app/services/statistics/database_statistics_service.py:94:5
   |
94 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
95 |     *,
96 |     instance_id: int | None,
   |

PLR0912 Too many branches (13 > 12)
  --> app/services/statistics/database_statistics_service.py:94:5
   |
94 | def fetch_aggregations(
   |     ^^^^^^^^^^^^^^^^^^
95 |     *,
96 |     instance_id: int | None,
   |

E501 Line too long (129 > 120)
   --> app/services/statistics/database_statistics_service.py:199:121
    |
197 |             pair_values = [(row.instance_id, row.database_name) for row in top_pairs]
198 |             aggregations = (
199 |                 query.filter(tuple_(DatabaseSizeAggregation.instance_id, DatabaseSizeAggregation.database_name).in_(pair_values))
    |                                                                                                                         ^^^^^^^^^
200 |                 .order_by(DatabaseSizeAggregation.period_start.asc())
201 |                 .all()
    |

C901 `fetch_aggregation_summary` is too complex (11 > 10)
   --> app/services/statistics/database_statistics_service.py:235:5
    |
235 | def fetch_aggregation_summary(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
236 |     *,
237 |     instance_id: int | None,
    |

PLR0913 Too many arguments in function definition (7 > 5)
   --> app/services/statistics/database_statistics_service.py:235:5
    |
235 | def fetch_aggregation_summary(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
236 |     *,
237 |     instance_id: int | None,
    |

INP001 File `app/services/statistics/instance_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/instance_statistics_service.py:1:1

TRY300 Consider moving this statement to an `else` block
  --> app/services/statistics/instance_statistics_service.py:55:9
   |
53 |           normal_instances = active_instances
54 |
55 | /         return {
56 | |             "total_instances": total_instances,
57 | |             "active_instances": active_instances,
58 | |             "normal_instances": normal_instances,
59 | |             "disabled_instances": disabled_instances,
60 | |             "deleted_instances": deleted_instances,
61 | |         }
   | |_________^
62 |       except Exception as exc:
63 |           log_error("获取实例汇总失败", module="instance_statistics", exception=exc)
   |

PLC0415 `import` should be at the top-level of a file
  --> app/services/statistics/instance_statistics_service.py:89:9
   |
87 |     """
88 |     try:
89 |         from app.models.instance_size_stat import InstanceSizeStat
   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
90 |
91 |         recent_date = time_utils.now_china().date() - timedelta(days=recent_days)
   |

INP001 File `app/services/statistics/log_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/log_statistics_service.py:1:1

INP001 File `app/services/statistics/partition_statistics_service.py` is part of an implicit namespace package. Add an `__init__.py`.
--> app/services/statistics/partition_statistics_service.py:1:1

D205 1 blank line required between summary line and description
 --> app/services/sync_session_service.py:1:1
  |
1 | / """鲸落 - 同步会话服务
2 | | 管理同步会话和实例记录的业务逻辑.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/services/sync_session_service.py:30:9
   |
28 |     """
29 |
30 |     def __init__(self) -> None:
   |         ^^^^^^^^
31 |         self.system_logger = get_system_logger()
32 |         self.sync_logger = get_sync_logger()
   |

E501 Line too long (123 > 120)
  --> app/services/sync_session_service.py:61:121
   |
59 |         return clean_value(sync_details)
60 |
61 |     def create_session(self, sync_type: str, sync_category: str = "account", created_by: int | None = None) -> SyncSession:
   |                                                                                                                         ^^^
62 |         """创建同步会话.
   |

TRY300 Consider moving this statement to an `else` block
  --> app/services/sync_session_service.py:95:13
   |
93 |             )
94 |
95 |             return session
   |             ^^^^^^^^^^^^^^
96 |         except Exception as e:
97 |             db.session.rollback()
   |

E501 Line too long (137 > 120)
   --> app/services/sync_session_service.py:107:121
    |
105 | …
106 | …
107 | …s: list[int], sync_category: str = "account") -> list[SyncInstanceRecord]:
    |                                                           ^^^^^^^^^^^^^^^^^
108 | …
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:152:13
    |
150 |             )
151 |
152 |             return records
    |             ^^^^^^^^^^^^^^
153 |         except Exception as e:
154 |             db.session.rollback()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:192:13
    |
190 |             )
191 |
192 |             return True
    |             ^^^^^^^^^^^
193 |         except Exception as e:
194 |             db.session.rollback()
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/services/sync_session_service.py:203:9
    |
201 |             return False
202 |
203 |     def complete_instance_sync(
    |         ^^^^^^^^^^^^^^^^^^^^^^
204 |         self,
205 |         record_id: int,
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:257:13
    |
255 |             )
256 |
257 |             return True
    |             ^^^^^^^^^^^
258 |         except Exception as e:
259 |             db.session.rollback()
    |

E501 Line too long (121 > 120)
   --> app/services/sync_session_service.py:268:121
    |
266 |             return False
267 |
268 |     def fail_instance_sync(self, record_id: int, error_message: str, sync_details: dict[str, Any] | None = None) -> bool:
    |                                                                                                                         ^
269 |         """标记实例同步失败.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:302:13
    |
300 |             )
301 |
302 |             return True
    |             ^^^^^^^^^^^
303 |         except Exception as e:
304 |             db.session.rollback()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/services/sync_session_service.py:495:13
    |
493 |                 self.sync_logger.info("取消同步会话", module="sync_session", session_id=session_id)
494 |
495 |             return True
    |             ^^^^^^^^^^^
496 |         except Exception as e:
497 |             db.session.rollback()
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/tasks/accounts_sync_tasks.py:3:1
   |
 1 |   """账户同步相关定时任务."""
 2 |
 3 | / from app import create_app, db
 4 | | from app.constants.sync_constants import SyncCategory, SyncOperationType
 5 | | from app.errors import AppError
 6 | | from app.models.instance import Instance
 7 | | from app.services.accounts_sync.coordinator import AccountSyncCoordinator
 8 | | from app.services.accounts_sync.permission_manager import PermissionSyncError
 9 | | from app.services.connection_adapters.adapters.base import ConnectionAdapterError
10 | | from app.services.sync_session_service import sync_session_service
11 | | from sqlalchemy.exc import SQLAlchemyError
12 | |
13 | | from app.utils.structlog_config import get_sync_logger
14 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
15 |
16 |   ACCOUNT_TASK_EXCEPTIONS: tuple[type[BaseException], ...] = (
   |
help: Organize imports

PLR0915 Too many statements (66 > 50)
  --> app/tasks/accounts_sync_tasks.py:31:5
   |
31 | def sync_accounts(*, manual_run: bool = False, created_by: int | None = None, **_: object) -> None:
   |     ^^^^^^^^^^^^^
32 |     """同步账户任务 - 同步所有实例的账户信息.
   |

E501 Line too long (136 > 120)
   --> app/tasks/accounts_sync_tasks.py:131:121
    |
129 | …         continue
130 | …     except PermissionSyncError as permission_error:
131 | …         sync_session_service.fail_instance_sync(record.id, str(permission_error), sync_details=permission_error.summary)
    |                                                                                                           ^^^^^^^^^^^^^^^^
132 | …         sync_logger.exception(
133 | …             "账户同步权限阶段失败",
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/tasks/accounts_sync_tasks.py:185:33
    |
183 |                     sync_session_service.fail_instance_sync(record.id, str(exc))
184 |
185 |                     sync_logger.error(
    |                                 ^^^^^
186 |                         "实例账户同步异常",
187 |                         module="accounts_sync",
    |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
   --> app/tasks/accounts_sync_tasks.py:221:25
    |
219 |                 db.session.commit()
220 |
221 |             sync_logger.error(
    |                         ^^^^^
222 |                 "账户同步任务失败",
223 |                 module="accounts_sync",
    |

D205 1 blank line required between summary line and description
 --> app/tasks/capacity_aggregation_tasks.py:1:1
  |
1 | / """数据库大小统计聚合定时任务
2 | | 负责计算每周、每月、每季度的统计聚合数据.
3 | | """
  | |___^
4 |
5 |   from collections.abc import Sequence
  |
help: Insert single blank line

C901 `calculate_database_size_aggregations` is too complex (24 > 10)
   --> app/tasks/capacity_aggregation_tasks.py:128:5
    |
128 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     *,
130 |     manual_run: bool = False,
    |

PLR0912 Too many branches (28 > 12)
   --> app/tasks/capacity_aggregation_tasks.py:128:5
    |
128 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     *,
130 |     manual_run: bool = False,
    |

PLR0915 Too many statements (111 > 50)
   --> app/tasks/capacity_aggregation_tasks.py:128:5
    |
128 | def calculate_database_size_aggregations(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
129 |     *,
130 |     manual_run: bool = False,
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_aggregation_tasks.py:545:13
    |
543 |                 message=result.get("message"),
544 |             )
545 |             return result
    |             ^^^^^^^^^^^^^
546 |
547 |         except AGGREGATION_TASK_EXCEPTIONS as exc:
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_aggregation_tasks.py:598:13
    |
596 |             )
597 |
598 |             return result
    |             ^^^^^^^^^^^^^
599 |
600 |         except AGGREGATION_TASK_EXCEPTIONS as exc:
    |

D205 1 blank line required between summary line and description
 --> app/tasks/capacity_collection_tasks.py:1:1
  |
1 | / """数据库大小采集定时任务
2 | | 负责每日自动采集所有数据库实例的大小信息.
3 | | """
  | |___^
4 |
5 |   from typing import Any
  |
help: Insert single blank line

C901 `collect_database_sizes` is too complex (12 > 10)
  --> app/tasks/capacity_collection_tasks.py:36:5
   |
36 | def collect_database_sizes() -> dict[str, Any]:
   |     ^^^^^^^^^^^^^^^^^^^^^^
37 |     """容量同步定时任务.
   |

PLR0915 Too many statements (97 > 50)
  --> app/tasks/capacity_collection_tasks.py:36:5
   |
36 | def collect_database_sizes() -> dict[str, Any]:
   |     ^^^^^^^^^^^^^^^^^^^^^^
37 |     """容量同步定时任务.
   |

E501 Line too long (140 > 120)
  --> app/tasks/capacity_collection_tasks.py:88:121
   |
86 | …
87 | …]
88 | …session.session_id, instance_ids, sync_category=SyncCategory.CAPACITY.value)
   |                                                          ^^^^^^^^^^^^^^^^^^^^
89 | …
   |

E501 Line too long (124 > 120)
   --> app/tasks/capacity_collection_tasks.py:167:121
    |
165 | …                     items_synced=0,
166 | …                     items_created=inventory_result.get("created", 0),
167 | …                     items_updated=inventory_result.get("refreshed", 0) + inventory_result.get("reactivated", 0),
    |                                                                                                               ^^^^
168 | …                     items_deleted=inventory_result.get("deactivated", 0),
169 | …                     sync_details={
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:333:13
    |
331 |             )
332 |
333 |             return result
    |             ^^^^^^^^^^^^^
334 |
335 |         except CAPACITY_TASK_EXCEPTIONS as exc:
    |

C901 `collect_specific_instance_database_sizes` is too complex (11 > 10)
   --> app/tasks/capacity_collection_tasks.py:356:5
    |
356 | def collect_specific_instance_database_sizes(instance_id: int) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
357 |     """采集指定实例的数据库大小信息.
    |

PLR0911 Too many return statements (9 > 6)
   --> app/tasks/capacity_collection_tasks.py:356:5
    |
356 | def collect_specific_instance_database_sizes(instance_id: int) -> dict[str, Any]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
357 |     """采集指定实例的数据库大小信息.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:571:13
    |
569 |                       errors.append(f"实例 {instance.name}: {exc!s}")
570 |
571 | /             return {
572 | |                 "success": True,
573 | |                 "message": f"{db_type} 类型数据库大小采集完成",
574 | |                 "instances_processed": total_processed,
575 | |                 "total_size_mb": total_size_mb,
576 | |                 "errors": errors,
577 | |             }
    | |_____________^
578 |
579 |           except CAPACITY_TASK_EXCEPTIONS as exc:
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/capacity_collection_tasks.py:657:9
    |
655 |           DatabaseSizeCollectorService()
656 |
657 | /         return {
658 | |             "success": True,
659 | |             "config": config_checks,
660 | |             "service_available": True,
661 | |             "message": "配置验证通过",
662 | |         }
    | |_________^
663 |
664 |       except CAPACITY_TASK_EXCEPTIONS as exc:
    |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/log_cleanup_tasks.py:45:13
   |
43 |             cleaned_files = _cleanup_temp_files()
44 |
45 |             from app.models.sync_instance_record import SyncInstanceRecord
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
46 |             from app.models.sync_session import SyncSession
   |

PLC0415 `import` should be at the top-level of a file
  --> app/tasks/log_cleanup_tasks.py:46:13
   |
45 |             from app.models.sync_instance_record import SyncInstanceRecord
46 |             from app.models.sync_session import SyncSession
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
47 |
48 |             deleted_sync_sessions = SyncSession.query.filter(SyncSession.created_at < cutoff_date).delete()
   |

G201 Logging `.exception(...)` should be used instead of `.error(..., exc_info=True)`
  --> app/tasks/log_cleanup_tasks.py:70:25
   |
68 |         except LOG_CLEANUP_EXCEPTIONS as exc:
69 |             db.session.rollback()
70 |             task_logger.error(
   |                         ^^^^^
71 |                 "定时任务清理失败",
72 |                 module="task",
   |

D205 1 blank line required between summary line and description
 --> app/tasks/partition_management_tasks.py:1:1
  |
1 | / """分区管理定时任务
2 | | 负责自动创建、清理和监控数据库大小统计表的分区.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

TRY300 Consider moving this statement to an `else` block
  --> app/tasks/partition_management_tasks.py:69:9
   |
67 |             message="分区创建任务已完成",
68 |         )
69 |         return payload
   |         ^^^^^^^^^^^^^^
70 |     except PARTITION_TASK_EXCEPTIONS as exc:
71 |         app_error = _as_app_error(exc)
   |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/partition_management_tasks.py:106:9
    |
104 |             message="旧分区清理任务已完成",
105 |         )
106 |         return payload
    |         ^^^^^^^^^^^^^^
107 |     except PARTITION_TASK_EXCEPTIONS as exc:
108 |         app_error = _as_app_error(exc)
    |

TRY300 Consider moving this statement to an `else` block
   --> app/tasks/partition_management_tasks.py:170:9
    |
168 |             message="分区健康监控完成",
169 |         )
170 |         return payload
    |         ^^^^^^^^^^^^^^
171 |     except PARTITION_TASK_EXCEPTIONS as exc:
172 |         app_error = _as_app_error(exc)
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/types/__init__.py:6:1
   |
 4 |   """
 5 |
 6 | / from app.types.accounts import PermissionSnapshot, RawAccount, RemoteAccount
 7 | | from app.types.classification import ClassificationEngineResult, RuleExpression
 8 | | from app.types.resources import (
 9 | |     ResourceContext,
10 | |     ResourceIdentifier,
11 | |     ResourceInstance,
12 | |     ResourcePayload,
13 | |     SupportsResourceId,
14 | |     TemplateContext,
15 | | )
16 | | from app.types.structures import (
17 | |     CategoryOptionDict,
18 | |     ColorHex,
19 | |     ColorName,
20 | |     ColorOptionDict,
21 | |     ColorToken,
22 | |     ContextDict,
23 | |     ContextMapping,
24 | |     ContextValue,
25 | |     CssClassName,
26 | |     FormErrorMapping,
27 | |     JsonDict,
28 | |     JsonValue,
29 | |     LoggerExtra,
30 | |     LoggerProtocol,
31 | |     MutablePayloadDict,
32 | |     NumericLike,
33 | |     PayloadMapping,
34 | |     PayloadValue,
35 | |     StructlogEventDict,
36 | | )
37 | | from app.types.query_protocols import QueryProtocol
38 | | from app.types.sync import (
39 | |     CollectionSummary,
40 | |     DiffEntry,
41 | |     InventorySummary,
42 | |     OtherDiffEntry,
43 | |     PermissionDiffPayload,
44 | |     PrivilegeDiffEntry,
45 | |     RemoteAccountMap,
46 | |     SyncConnection,
47 | |     SyncOperationResult,
48 | |     SyncStagesSummary,
49 | |     SyncSummary,
50 | | )
   | |_^
51 |
52 |   __all__ = [
   |
help: Organize imports

RUF022 [*] `__all__` is not sorted
  --> app/types/__init__.py:52:11
   |
50 |   )
51 |
52 |   __all__ = [
   |  ___________^
53 | |     "PermissionSnapshot",
54 | |     "RemoteAccount",
55 | |     "RawAccount",
56 | |     "ClassificationEngineResult",
57 | |     "RuleExpression",
58 | |     "SyncConnection",
59 | |     "SyncSummary",
60 | |     "RemoteAccountMap",
61 | |     "PermissionDiffPayload",
62 | |     "DiffEntry",
63 | |     "PrivilegeDiffEntry",
64 | |     "OtherDiffEntry",
65 | |     "InventorySummary",
66 | |     "CollectionSummary",
67 | |     "SyncStagesSummary",
68 | |     "SyncOperationResult",
69 | |     "ResourceContext",
70 | |     "ResourceIdentifier",
71 | |     "ResourceInstance",
72 | |     "ResourcePayload",
73 | |     "SupportsResourceId",
74 | |     "TemplateContext",
75 | |     "CategoryOptionDict",
76 | |     "ColorHex",
77 | |     "ColorName",
78 | |     "ColorOptionDict",
79 | |     "ColorToken",
80 | |     "ContextDict",
81 | |     "ContextMapping",
82 | |     "ContextValue",
83 | |     "CssClassName",
84 | |     "FormErrorMapping",
85 | |     "JsonDict",
86 | |     "JsonValue",
87 | |     "LoggerExtra",
88 | |     "LoggerProtocol",
89 | |     "MutablePayloadDict",
90 | |     "NumericLike",
91 | |     "PayloadMapping",
92 | |     "PayloadValue",
93 | |     "StructlogEventDict",
94 | |     "QueryProtocol",
95 | | ]
   | |_^
   |
help: Apply an isort-style sorting to `__all__`

TC003 Move standard library import `collections.abc.Mapping` into a type-checking block
 --> app/types/accounts.py:5:29
  |
3 | from __future__ import annotations
4 |
5 | from collections.abc import Mapping
  |                             ^^^^^^^
6 | from typing import TypedDict
  |
help: Move into type-checking block

RUF022 [*] `__all__` is not sorted
  --> app/types/accounts.py:37:11
   |
35 | RawAccount = dict[str, JsonValue | JsonDict | PermissionSnapshot]
36 |
37 | __all__ = ["PermissionSnapshot", "RemoteAccount", "RawAccount"]
   |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
help: Apply an isort-style sorting to `__all__`

I001 [*] Import block is un-sorted or un-formatted
 --> app/types/classification.py:3:1
  |
1 |   """账户分类相关类型定义."""
2 |
3 | / from __future__ import annotations
4 | |
5 | | from typing import Mapping, TypedDict, TypeAlias
6 | |
7 | | from app.types.structures import JsonDict, JsonValue
  | |____________________________________________________^
8 |
9 |   RuleExpression: TypeAlias = Mapping[str, JsonValue]
  |
help: Organize imports

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> app/types/classification.py:5:1
  |
3 | from __future__ import annotations
4 |
5 | from typing import Mapping, TypedDict, TypeAlias
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
6 |
7 | from app.types.structures import JsonDict, JsonValue
  |
help: Import from `collections.abc`

RUF022 [*] `__all__` is not sorted
  --> app/types/classification.py:28:11
   |
28 | __all__ = ["RuleExpression", "ClassificationEngineResult"]
   |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   |
help: Apply an isort-style sorting to `__all__`

D103 Missing docstring in public function
  --> app/types/converters.py:26:5
   |
26 | def as_str(value: PayloadValue | None, *, default: str = "") -> str:
   |     ^^^^^^
27 |     base = _unwrap_sequence(value)
28 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:37:5
   |
37 | def as_optional_str(value: PayloadValue | None) -> str | None:
   |     ^^^^^^^^^^^^^^^
38 |     cleaned = as_str(value, default="").strip()
39 |     return cleaned or None
   |

PLR0911 Too many return statements (7 > 6)
  --> app/types/converters.py:42:5
   |
42 | def as_int(value: PayloadValue | None, *, default: int | None = None) -> int | None:
   |     ^^^^^^
43 |     base = _unwrap_sequence(value)
44 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:42:5
   |
42 | def as_int(value: PayloadValue | None, *, default: int | None = None) -> int | None:
   |     ^^^^^^
43 |     base = _unwrap_sequence(value)
44 |     if base is None:
   |

PLR0911 Too many return statements (7 > 6)
  --> app/types/converters.py:61:5
   |
61 | def as_bool(value: PayloadValue | None, *, default: bool = False) -> bool:
   |     ^^^^^^^
62 |     base = _unwrap_sequence(value)
63 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:61:5
   |
61 | def as_bool(value: PayloadValue | None, *, default: bool = False) -> bool:
   |     ^^^^^^^
62 |     base = _unwrap_sequence(value)
63 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:79:5
   |
79 | def as_list_of_str(value: PayloadValue | None) -> list[str]:
   |     ^^^^^^^^^^^^^^
80 |     base = _unwrap_sequence(value)
81 |     if base is None:
   |

D103 Missing docstring in public function
  --> app/types/converters.py:95:5
   |
95 | def ensure_mapping(value: PayloadValue | None) -> Mapping[str, PayloadValue] | None:
   |     ^^^^^^^^^^^^^^
96 |     base = _unwrap_sequence(value)
97 |     if isinstance(base, Mapping):
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:13:9
   |
11 |     """最小化的 SQLAlchemy Query 协议,用于类型标注."""
12 |
13 |     def join(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]:
   |         ^^^^
14 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:16:9
   |
14 |         ...
15 |
16 |     def filter(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]:
   |         ^^^^^^
17 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:19:9
   |
17 |         ...
18 |
19 |     def filter_by(self, **kwargs: object) -> QueryProtocol[T_co]:
   |         ^^^^^^^^^
20 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:22:9
   |
20 |         ...
21 |
22 |     def order_by(self, *args: object, **kwargs: object) -> QueryProtocol[T_co]:
   |         ^^^^^^^^
23 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:25:9
   |
23 |         ...
24 |
25 |     def limit(self, count: int) -> QueryProtocol[T_co]:
   |         ^^^^^
26 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:28:9
   |
26 |         ...
27 |
28 |     def all(self) -> list[T_co]:
   |         ^^^
29 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:31:9
   |
29 |         ...
30 |
31 |     def count(self) -> int:
   |         ^^^^^
32 |         ...
   |

D102 Missing docstring in public method
  --> app/types/query_protocols.py:34:9
   |
32 |         ...
33 |
34 |     def first(self) -> T_co | None:
   |         ^^^^^
35 |         ...
   |

E501 Line too long (134 > 120)
  --> app/types/structures.py:39:121
   |
37 |     label: str
38 |
39 | ContextValue: TypeAlias = ScalarValue | Sequence["ContextValue"] | Mapping[str, "ContextValue"] | ColorOptionDict | CategoryOptionDict
   |                                                                                                                         ^^^^^^^^^^^^^^
40 | ContextMapping: TypeAlias = Mapping[str, ContextValue]
41 | ContextDict: TypeAlias = dict[str, ContextValue]
   |

D102 Missing docstring in public method
  --> app/types/structures.py:51:9
   |
49 |     """结构化日志协议,统一 logger 的最小接口."""
50 |
51 |     def bind(self, **kwargs: JsonValue) -> LoggerProtocol:
   |         ^^^^
52 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:54:9
   |
52 |         ...
53 |
54 |     def new(self, **kwargs: JsonValue) -> LoggerProtocol:
   |         ^^^
55 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:57:9
   |
55 |         ...
56 |
57 |     def debug(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^
58 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:60:9
   |
58 |         ...
59 |
60 |     def info(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^
61 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:63:9
   |
61 |         ...
62 |
63 |     def warning(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^^^
64 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:66:9
   |
64 |         ...
65 |
66 |     def error(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^
67 |         ...
   |

D102 Missing docstring in public method
  --> app/types/structures.py:69:9
   |
67 |         ...
68 |
69 |     def exception(self, event: str, *args: object, **kwargs: JsonValue) -> object:
   |         ^^^^^^^^^
70 |         ...
   |

RUF022 [*] `__all__` is not sorted
  --> app/types/structures.py:72:11
   |
70 |           ...
71 |
72 |   __all__ = [
   |  ___________^
73 | |     "ScalarValue",
74 | |     "PayloadValue",
75 | |     "PayloadMapping",
76 | |     "MutablePayloadDict",
77 | |     "ContextValue",
78 | |     "ContextMapping",
79 | |     "ContextDict",
80 | |     "FormErrorMapping",
81 | |     "NumericLike",
82 | |     "ColorToken",
83 | |     "ColorHex",
84 | |     "ColorName",
85 | |     "CssClassName",
86 | |     "ColorOptionDict",
87 | |     "CategoryOptionDict",
88 | |     "JsonValue",
89 | |     "JsonDict",
90 | |     "StructlogEventDict",
91 | |     "LoggerExtra",
92 | |     "LoggerProtocol",
93 | | ]
   | |_^
   |
help: Apply an isort-style sorting to `__all__`

I001 [*] Import block is un-sorted or un-formatted
 --> app/types/sync.py:3:1
  |
1 |   """账户/数据库同步相关类型别名."""
2 |
3 | / from __future__ import annotations
4 | |
5 | | from collections.abc import Iterable, Mapping, Sequence
6 | | from typing import TYPE_CHECKING, Any, Literal, Protocol, TypedDict, TypeAlias
  | |______________________________________________________________________________^
7 |
8 |   if TYPE_CHECKING:
  |
help: Organize imports

D102 Missing docstring in public method
  --> app/types/sync.py:21:9
   |
19 |     """数据库连接对象协议."""
20 |
21 |     def connect(self) -> bool:  # pragma: no cover - protocol
   |         ^^^^^^^
22 |         ...
   |

D102 Missing docstring in public method
  --> app/types/sync.py:24:9
   |
22 |         ...
23 |
24 |     def disconnect(self) -> None:  # pragma: no cover - protocol
   |         ^^^^^^^^^^
25 |         ...
   |

D102 Missing docstring in public method
  --> app/types/sync.py:27:9
   |
25 |         ...
26 |
27 |     def execute_query(self, query: str, params: Sequence[JsonValue] | Mapping[str, JsonValue] | None = None) -> Iterable[Sequence[Json…
   |         ^^^^^^^^^^^^^
28 |         ...
   |

E501 Line too long (142 > 120)
  --> app/types/sync.py:27:121
   |
25 | …
26 | …
27 | …e] | Mapping[str, JsonValue] | None = None) -> Iterable[Sequence[JsonValue]]:  # noqa: D401
   |                                                         ^^^^^^^^^^^^^^^^^^^^^^
28 | …
   |

RUF100 [*] Unused `noqa` directive (unused: `D401`)
  --> app/types/sync.py:27:145
   |
25 | …
26 | …
27 | …sonValue] | None = None) -> Iterable[Sequence[JsonValue]]:  # noqa: D401
   |                                                              ^^^^^^^^^^^^
28 | …
   |
help: Remove unused `noqa` directive

RUF022 [*] `__all__` is not sorted
   --> app/types/sync.py:124:11
    |
124 |   __all__ = [
    |  ___________^
125 | |     "SyncConnection",
126 | |     "SyncSummary",
127 | |     "RemoteAccountMap",
128 | |     "PermissionDiffPayload",
129 | |     "DiffEntry",
130 | |     "PrivilegeDiffEntry",
131 | |     "OtherDiffEntry",
132 | |     "InventorySummary",
133 | |     "CollectionSummary",
134 | |     "SyncStagesSummary",
135 | |     "SyncOperationResult",
136 | | ]
    | |_^
    |
help: Apply an isort-style sorting to `__all__`

D205 1 blank line required between summary line and description
 --> app/utils/cache_utils.py:1:1
  |
1 | / """鲸落 - 缓存管理工具
2 | | 基于Flask-Caching的通用缓存管理器,提供装饰器和通用缓存功能.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
  --> app/utils/cache_utils.py:9:29
   |
 7 | import hashlib
 8 | import json
 9 | from collections.abc import Callable
   |                             ^^^^^^^^
10 | from functools import wraps
11 | from typing import Callable as TypingCallable, ParamSpec, TypeVar, cast
   |
help: Move into type-checking block

UP035 [*] Import from `collections.abc` instead: `Callable`
  --> app/utils/cache_utils.py:11:1
   |
 9 | from collections.abc import Callable
10 | from functools import wraps
11 | from typing import Callable as TypingCallable, ParamSpec, TypeVar, cast
   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
12 |
13 | from flask_caching import Cache
   |
help: Import from `collections.abc`

TC002 Move third-party import `flask_caching.Cache` into a type-checking block
  --> app/utils/cache_utils.py:13:27
   |
11 | from typing import Callable as TypingCallable, ParamSpec, TypeVar, cast
12 |
13 | from flask_caching import Cache
   |                           ^^^^^
14 |
15 | from app.utils.structlog_config import get_system_logger
   |
help: Move into type-checking block

D107 Missing docstring in `__init__`
  --> app/utils/cache_utils.py:40:9
   |
38 |     """
39 |
40 |     def __init__(self, cache: Cache) -> None:
   |         ^^^^^^^^
41 |         self.cache = cache
42 |         self.default_timeout = 300  # 5分钟默认超时
   |

E501 Line too long (123 > 120)
   --> app/utils/data_validator.py:305:121
    |
304 |         # 检查域名格式
305 |         domain_pattern = r"^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$"
    |                                                                                                                         ^^^
306 |         return bool(re.match(domain_pattern, host))
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:545:30
    |
544 |         normalized = username.strip()
545 |         if len(normalized) < cls.USERNAME_MIN_LENGTH:
    |                              ^^^
546 |             return f"用户名长度至少{cls.USERNAME_MIN_LENGTH}个字符"
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:546:30
    |
544 |         normalized = username.strip()
545 |         if len(normalized) < cls.USERNAME_MIN_LENGTH:
546 |             return f"用户名长度至少{cls.USERNAME_MIN_LENGTH}个字符"
    |                                     ^^^
547 |
548 |         if len(normalized) > cls.USERNAME_MAX_LENGTH:
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:548:30
    |
546 |             return f"用户名长度至少{cls.USERNAME_MIN_LENGTH}个字符"
547 |
548 |         if len(normalized) > cls.USERNAME_MAX_LENGTH:
    |                              ^^^
549 |             return f"用户名长度不能超过{cls.USERNAME_MAX_LENGTH}个字符"
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:549:32
    |
548 |         if len(normalized) > cls.USERNAME_MAX_LENGTH:
549 |             return f"用户名长度不能超过{cls.USERNAME_MAX_LENGTH}个字符"
    |                                         ^^^
550 |
551 |         if not re.match(r"^[a-zA-Z0-9_.-]+$", normalized):
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:575:28
    |
573 |             return "密码必须是字符串"
574 |
575 |         if len(password) < cls.PASSWORD_MIN_LENGTH:
    |                            ^^^
576 |             return f"密码长度至少{cls.PASSWORD_MIN_LENGTH}个字符"
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:576:29
    |
575 |         if len(password) < cls.PASSWORD_MIN_LENGTH:
576 |             return f"密码长度至少{cls.PASSWORD_MIN_LENGTH}个字符"
    |                                   ^^^
577 |
578 |         if len(password) > cls.PASSWORD_MAX_LENGTH:
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:578:28
    |
576 |             return f"密码长度至少{cls.PASSWORD_MIN_LENGTH}个字符"
577 |
578 |         if len(password) > cls.PASSWORD_MAX_LENGTH:
    |                            ^^^
579 |             return f"密码长度不能超过{cls.PASSWORD_MAX_LENGTH}个字符"
    |

F821 Undefined name `cls`
   --> app/utils/data_validator.py:579:31
    |
578 |         if len(password) > cls.PASSWORD_MAX_LENGTH:
579 |             return f"密码长度不能超过{cls.PASSWORD_MAX_LENGTH}个字符"
    |                                       ^^^
580 |
581 |         return None
    |

D205 1 blank line required between summary line and description
 --> app/utils/database_batch_manager.py:1:1
  |
1 | / """鲸落 - 数据库批量操作管理器
2 | | 提供高效的批量提交机制,优化大量数据处理性能.
3 | | """
  | |___^
4 |
5 |   from types import TracebackType
  |
help: Insert single blank line

TRY300 Consider moving this statement to an `else` block
   --> app/utils/database_batch_manager.py:163:13
    |
161 |             # 清空当前批次
162 |             self.pending_operations.clear()
163 |             return True
    |             ^^^^^^^^^^^
164 |
165 |         except Exception as e:
    |

UP035 [*] Import from `collections.abc` instead: `Callable`
 --> app/utils/decorators.py:4:1
  |
3 | from functools import wraps
4 | from typing import Callable, Optional, ParamSpec, Protocol, TypeVar, overload
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
5 |
6 | from flask import flash, redirect, request, url_for
  |
help: Import from `collections.abc`

F401 [*] `typing.Optional` imported but unused
 --> app/utils/decorators.py:4:30
  |
3 | from functools import wraps
4 | from typing import Callable, Optional, ParamSpec, Protocol, TypeVar, overload
  |                              ^^^^^^^^
5 |
6 | from flask import flash, redirect, request, url_for
  |
help: Remove unused import: `typing.Optional`

D101 Missing docstring in public class
  --> app/utils/decorators.py:19:7
   |
19 | class PermissionUser(Protocol):
   |       ^^^^^^^^^^^^^^
20 |     is_authenticated: bool
21 |     role: str
   |

D417 Missing argument description in the docstring for `admin_required`: `func`
  --> app/utils/decorators.py:26:5
   |
24 | SAFE_CSRF_METHODS = {"GET", "HEAD", "OPTIONS", "TRACE"}
25 |
26 | def admin_required(func: Callable[P, R]) -> Callable[P, R]:
   |     ^^^^^^^^^^^^^^
27 |     """确保被装饰函数仅允许管理员访问的装饰器.
   |

D417 Missing argument description in the docstring for `login_required`: `func`
   --> app/utils/decorators.py:119:5
    |
119 | def login_required(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^^^
120 |     """要求调用者已登录的装饰器.
    |

D417 Missing argument description in the docstring for `require_csrf`: `func`
   --> app/utils/decorators.py:291:5
    |
291 | def require_csrf(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^
292 |     """统一的 CSRF 校验装饰器.
    |

D417 Missing argument description in the docstring for `view_required`: `func`
   --> app/utils/decorators.py:400:5
    |
400 | def view_required(
    |     ^^^^^^^^^^^^^
401 |     func: Callable[P, R] | None = None,
402 |     *,
    |

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/utils/decorators.py:405:5
    |
403 |       permission: str = "view",
404 |   ) -> Callable[[Callable[P, R]], Callable[P, R]] | Callable[P, R]:
405 | /     """校验查看权限的装饰器,可直接使用或指定自定义权限.
406 | |
407 | |     Args:
408 | |         f: 待装饰函数,支持无参直接使用.
409 | |         permission: 自定义权限名称,默认 `view`.
410 | |
411 | |     Returns:
412 | |         满足 Flask 惰性装饰器模式的函数或装饰器.
413 | |
414 | |     """
    | |_______^
415 |
416 |       if func is not None and not callable(func):
    |
help: Remove blank line(s) after function docstring

D417 Missing argument description in the docstring for `create_required`: `func`
   --> app/utils/decorators.py:438:5
    |
438 | def create_required(
    |     ^^^^^^^^^^^^^^^
439 |     func: Callable[P, R] | None = None,
440 |     *,
    |

D417 Missing argument description in the docstring for `update_required`: `func`
   --> app/utils/decorators.py:472:5
    |
472 | def update_required(
    |     ^^^^^^^^^^^^^^^
473 |     func: Callable[P, R] | None = None,
474 |     *,
    |

D417 Missing argument description in the docstring for `delete_required`: `func`
   --> app/utils/decorators.py:506:5
    |
506 | def delete_required(
    |     ^^^^^^^^^^^^^^^
507 |     func: Callable[P, R] | None = None,
508 |     *,
    |

D417 Missing argument description in the docstring for `scheduler_view_required`: `func`
   --> app/utils/decorators.py:530:5
    |
530 | def scheduler_view_required(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^
531 |     """定时任务查看权限装饰器.
    |

D417 Missing argument description in the docstring for `scheduler_manage_required`: `func`
   --> app/utils/decorators.py:543:5
    |
543 | def scheduler_manage_required(func: Callable[P, R]) -> Callable[P, R]:
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
544 |     """定时任务管理权限装饰器.
    |

PLC0415 `import` should be at the top-level of a file
  --> app/utils/logging/error_adapter.py:60:13
   |
58 |         """
59 |         if self.request is None and has_request_context():
60 |             from flask import request as flask_request
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
61 |
62 |             self.request = flask_request
   |

ARG002 Unused method argument: `logger`
  --> app/utils/logging/handlers.py:59:24
   |
57 |         self.enabled = enabled
58 |
59 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
   |                        ^^^^^^
60 |         """处理日志事件,根据配置决定是否丢弃 DEBUG 日志.
   |

ARG002 Unused method argument: `method_name`
  --> app/utils/logging/handlers.py:59:55
   |
57 |         self.enabled = enabled
58 |
59 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
   |                                                       ^^^^^^^^^^^
60 |         """处理日志事件,根据配置决定是否丢弃 DEBUG 日志.
   |

ARG002 Unused method argument: `logger`
   --> app/utils/logging/handlers.py:109:24
    |
107 |         self.worker = worker
108 |
109 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
    |                        ^^^^^^
110 |         """处理日志事件,将其入队等待写入数据库.
    |

ARG002 Unused method argument: `method_name`
   --> app/utils/logging/handlers.py:109:55
    |
107 |         self.worker = worker
108 |
109 |     def __call__(self, logger: structlog.BoundLogger, method_name: str, event_dict: dict[str, Any]) -> dict[str, Any]:
    |                                                       ^^^^^^^^^^^
110 |         """处理日志事件,将其入队等待写入数据库.
    |

TC002 Move third-party import `flask.Flask` into a type-checking block
  --> app/utils/logging/queue_worker.py:13:19
   |
11 | from typing import TYPE_CHECKING
12 |
13 | from flask import Flask
   |                   ^^^^^
14 | from flask_sqlalchemy import SQLAlchemy
   |
help: Move into type-checking block

TC002 Move third-party import `flask_sqlalchemy.SQLAlchemy` into a type-checking block
  --> app/utils/logging/queue_worker.py:14:30
   |
13 | from flask import Flask
14 | from flask_sqlalchemy import SQLAlchemy
   |                              ^^^^^^^^^^
15 |
16 | from app.types import JsonValue
   |
help: Move into type-checking block

N806 Variable `UnifiedLog` in function should be lowercase
   --> app/utils/logging/queue_worker.py:181:17
    |
179 |         db: SQLAlchemy | None = None
180 |         try:
181 |             db, UnifiedLog = _get_logging_dependencies()
    |                 ^^^^^^^^^^
182 |             with self.app.app_context():
183 |                 models = [UnifiedLog.create_log_entry(**entry) for entry in entries]
    |

D205 1 blank line required between summary line and description
 --> app/utils/password_crypto_utils.py:1:1
  |
1 | / """密码管理工具
2 | | 用于安全地存储和获取数据库密码.
3 | | """
  | |___^
4 |
5 |   import base64
  |
help: Insert single blank line

D107 Missing docstring in `__init__`
  --> app/utils/password_crypto_utils.py:32:9
   |
30 |     """
31 |
32 |     def __init__(self) -> None:
   |         ^^^^^^^^
33 |         self.key = self._get_or_create_key()
34 |         self.cipher = Fernet(self.key)
   |

PLC0415 `import` should be at the top-level of a file
  --> app/utils/password_crypto_utils.py:52:17
   |
50 |             # 延迟导入避免循环导入
51 |             try:
52 |                 from app.utils.structlog_config import get_system_logger
   |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
53 |                 system_logger = get_system_logger()
54 |                 system_logger.warning("没有设置PASSWORD_ENCRYPTION_KEY环境变量", module="password_manager")
   |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/password_crypto_utils.py:101:13
    |
 99 |             return decrypted.decode()
100 |         except (InvalidToken, binascii.Error, ValueError) as decryption_error:
101 |             from app.utils.structlog_config import get_system_logger
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
102 |
103 |             system_logger = get_system_logger()
    |

TRY300 Consider moving this statement to an `else` block
   --> app/utils/password_crypto_utils.py:131:13
    |
129 |         try:
130 |             base64.b64decode(password.encode())
131 |             return True
    |             ^^^^^^^^^^^
132 |         except (binascii.Error, ValueError):
133 |             return False
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/query_filter_utils.py:264:9
    |
262 |     query = db.session.query(distinct(UnifiedLog.module))
263 |     if limit_hours is not None:
264 |         from datetime import timedelta
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
265 |
266 |         from app.utils.time_utils import time_utils
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/query_filter_utils.py:266:9
    |
264 |         from datetime import timedelta
265 |
266 |         from app.utils.time_utils import time_utils
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
267 |
268 |         start_time = time_utils.now() - timedelta(hours=limit_hours)
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/rate_limiter.py:106:9
    |
104 |             return self._check_memory(identifier, endpoint, limit, window, current_time, window_start)
105 |
106 |     def _check_cache(
    |         ^^^^^^^^^^^^
107 |         self,
108 |         identifier: str,
    |

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/rate_limiter.py:159:9
    |
157 |         }
158 |
159 |     def _check_memory(
    |         ^^^^^^^^^^^^^
160 |         self,
161 |         identifier: str,
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/rate_limiter.py:245:5
    |
244 |     """
245 |     from app.config import Config
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
246 |
247 |     if limit is None:
    |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/rate_limiter.py:342:5
    |
341 |     """
342 |     from app.config import Config
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
343 |
344 |     if limit is None:
    |

D205 1 blank line required between summary line and description
 --> app/utils/response_utils.py:1:1
  |
1 | / """鲸落 - 统一响应工具
2 | | 提供统一的成功/错误响应结构,避免在业务层散落 JSON 拼装逻辑.
3 | | """
  | |___^
4 |
5 |   from __future__ import annotations
  |
help: Insert single blank line

I001 [*] Import block is un-sorted or un-formatted
  --> app/utils/response_utils.py:5:1
   |
 3 |   """
 4 |
 5 | / from __future__ import annotations
 6 | |
 7 | | from typing import Mapping, TYPE_CHECKING
 8 | |
 9 | | from flask import Response, jsonify
10 | |
11 | | from app.constants import HttpStatus
12 | | from app.constants.system_constants import ErrorCategory, ErrorSeverity, SuccessMessages
13 | | from app.errors import AppError, map_exception_to_status
14 | | from app.utils.structlog_config import ErrorContext, enhanced_error_handler
15 | | from app.utils.time_utils import time_utils
   | |___________________________________________^
16 |
17 |   if TYPE_CHECKING:
   |
help: Organize imports

UP035 [*] Import from `collections.abc` instead: `Mapping`
 --> app/utils/response_utils.py:7:1
  |
5 | from __future__ import annotations
6 |
7 | from typing import Mapping, TYPE_CHECKING
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
8 |
9 | from flask import Response, jsonify
  |
help: Import from `collections.abc`

PLR0913 Too many arguments in function definition (6 > 5)
   --> app/utils/response_utils.py:113:5
    |
113 | def jsonify_unified_error_message(
    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
114 |     message: str,
115 |     *,
    |

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
  --> app/utils/route_safety.py:9:29
   |
 7 | from __future__ import annotations
 8 |
 9 | from collections.abc import Callable
   |                             ^^^^^^^^
10 | from typing import TYPE_CHECKING, Literal, ParamSpec, TypeVar
   |
help: Move into type-checking block

PLR0913 Too many arguments in function definition (7 > 5)
  --> app/utils/route_safety.py:27:5
   |
27 | def log_with_context(
   |     ^^^^^^^^^^^^^^^^
28 |     level: LogLevel,
29 |     event: str,
   |

D202 [*] No blank lines allowed after function docstring (found 1)
  --> app/utils/route_safety.py:37:5
   |
35 |       include_actor: bool = True,
36 |   ) -> None:
37 | /     """记录带有统一上下文字段的结构化日志.
38 | |
39 | |     Args:
40 | |         level: 日志级别,使用 structlog 的方法名,例如 "info"、"error".
41 | |         event: 日志事件描述,建议使用动词短语.
42 | |         module: 所属模块或领域,用于快速过滤.
43 | |         action: 当前操作名称,通常对应视图或任务函数名.
44 | |         context: 额外的业务上下文字段,会直接展开到日志中.
45 | |         extra: 自定义补充字段,例如错误类型、计数等.
46 | |         include_actor: 是否自动附加当前用户 ID,默认为 True.
47 | |
48 | |     """
   | |_______^
49 |
50 |       logger = get_logger("app")
   |
help: Remove blank line(s) after function docstring

PLR0913 Too many arguments in function definition (10 > 5)
  --> app/utils/route_safety.py:70:5
   |
70 | def safe_route_call(
   |     ^^^^^^^^^^^^^^^
71 |     func: Callable[P, R],
72 |     *func_args: P.args,
   |

D202 [*] No blank lines allowed after function docstring (found 1)
   --> app/utils/route_safety.py:84:5
    |
 82 |       **func_kwargs: P.kwargs,
 83 |   ) -> R:
 84 | /     """安全执行视图逻辑,集中处理日志与异常转换.
 85 | |
 86 | |     Args:
 87 | |         func: 真实的业务函数,建议为局部闭包以捕获参数.
 88 | |         *func_args: 传入业务函数的可变位置参数.
 89 | |         module: 记录日志用的模块名称.
 90 | |         action: 业务动作名称,例如 "get_account_permissions".
 91 | |         public_error: 暴露给客户端的统一错误文案.
 92 | |         context: 日志上下文字段,如 `{"account_id": 1}`.
 93 | |         extra: 额外的日志字段,通常承载统计值.
 94 | |         expected_exceptions: 允许直接透传并记录的异常类型集合.
 95 | |         fallback_exception: 将未知异常转换成的业务异常类型,默认为 SystemError.
 96 | |         log_event: 自定义日志事件文案,缺省为 ``f"{action}执行失败"``.
 97 | |         include_actor: 是否在日志中注入当前用户 ID.
 98 | |         **func_kwargs: 传入业务函数的命名参数.
 99 | |
100 | |     Returns:
101 | |         业务函数的执行结果,通常是 Flask 的响应对象.
102 | |
103 | |     Raises:
104 | |         AppError: 当业务逻辑主动抛出或 fallback_exception 包装时.
105 | |
106 | |     """
    | |_______^
107 |
108 |       handled_exceptions = DEFAULT_EXPECTED_EXCEPTIONS
    |
help: Remove blank line(s) after function docstring

D205 1 blank line required between summary line and description
 --> app/utils/safe_query_builder.py:1:1
  |
1 | / """鲸落 - 安全查询构建器
2 | | 提供安全的SQL查询构建功能,防止SQL注入攻击
3 | | 支持MySQL、PostgreSQL、SQL Server、Oracle等多种数据库.
4 | | """
  | |___^
5 |
6 |   from collections.abc import Mapping, Sequence
  |
help: Insert single blank line

TRY300 Consider moving this statement to an `else` block
   --> app/utils/sqlserver_connection_utils.py:150:13
    |
148 |         try:
149 |             socket.gethostbyname(host)
150 |             return True
    |             ^^^^^^^^^^^
151 |         except socket.gaierror:
152 |             return False
    |

TRY300 Consider moving this statement to an `else` block
   --> app/utils/sqlserver_connection_utils.py:172:13
    |
170 |             result = sock.connect_ex((host, port))
171 |             sock.close()
172 |             return result == 0
    |             ^^^^^^^^^^^^^^^^^^
173 |         except OSError:
174 |             return False
    |

E501 Line too long (124 > 120)
   --> app/utils/sqlserver_connection_utils.py:176:121
    |
174 |             return False
175 |
176 |     def get_connection_string_suggestions(self, host: str, port: int, username: str, database: str = "master") -> list[str]:
    |                                                                                                                         ^^^^
177 |         """获取连接字符串建议.
    |

E501 Line too long (126 > 120)
   --> app/utils/sqlserver_connection_utils.py:204:121
    |
203 |         # 带超时的连接字符串
204 |         suggestions.append(f"Server={host},{port};Database={database};User Id={username};Password=***;Connection Timeout=60;")
    |                                                                                                                         ^^^^^^
205 |
206 |         # 带加密的连接字符串
    |

E501 Line too long (145 > 120)
   --> app/utils/sqlserver_connection_utils.py:207:121
    |
206 | …
207 | …e};User Id={username};Password=***;Encrypt=True;TrustServerCertificate=True;")
    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^
208 | …
209 | …
    |

E501 Line too long (146 > 120)
   --> app/utils/sqlserver_connection_utils.py:210:121
    |
209 | …
210 | …e};User Id={username};Password=***;Connection Timeout=60;Command Timeout=300;")
    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^
211 | …
212 | …
    |

E501 Line too long (138 > 120)
   --> app/utils/sqlserver_connection_utils.py:237:121
    |
235 | …
236 | …
237 | …ower() for keyword in ["timeout", "connection", "network", "unreachable"]),
    |                                                           ^^^^^^^^^^^^^^^^^^
238 | …r() for keyword in ["login", "authentication", "password", "user"]),
239 | …wer() for keyword in ["server", "service", "database", "sql"]),
    |

E501 Line too long (131 > 120)
   --> app/utils/sqlserver_connection_utils.py:238:121
    |
236 | …
237 | …e.lower() for keyword in ["timeout", "connection", "network", "unreachable"]),
238 | …ower() for keyword in ["login", "authentication", "password", "user"]),
    |                                                              ^^^^^^^^^^^
239 | ….lower() for keyword in ["server", "service", "database", "sql"]),
240 | …sage.lower() for keyword in ["permission", "access", "denied", "unauthorized"]),
    |

E501 Line too long (126 > 120)
   --> app/utils/sqlserver_connection_utils.py:239:121
    |
237 | …         "has_network_error": any(keyword in error_message.lower() for keyword in ["timeout", "connection", "network", "unreachable"…
238 | …         "has_auth_error": any(keyword in error_message.lower() for keyword in ["login", "authentication", "password", "user"]),
239 | …         "has_server_error": any(keyword in error_message.lower() for keyword in ["server", "service", "database", "sql"]),
    |                                                                                                                       ^^^^^^
240 | …         "has_permission_error": any(keyword in error_message.lower() for keyword in ["permission", "access", "denied", "unauthorize…
241 | …     }
    |

E501 Line too long (140 > 120)
   --> app/utils/sqlserver_connection_utils.py:240:121
    |
238 | …() for keyword in ["login", "authentication", "password", "user"]),
239 | …er() for keyword in ["server", "service", "database", "sql"]),
240 | ….lower() for keyword in ["permission", "access", "denied", "unauthorized"]),
    |                                                          ^^^^^^^^^^^^^^^^^^^^
241 | …
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/utils/structlog_config.py:3:1
   |
 1 |   """WhaleFall 项目的结构化日志配置与辅助函数."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | import atexit
 6 | | import sys
 7 | | from collections.abc import Callable
 8 | | from contextlib import suppress
 9 | | from functools import wraps
10 | | from typing import ParamSpec
11 | |
12 | | import structlog
13 | | from flask import Flask, current_app, g, has_request_context, jsonify
14 | | from flask.typing import ResponseReturnValue
15 | | from flask_login import current_user
16 | | from structlog.typing import BindableLogger, Processor
17 | |
18 | | from app.constants.system_constants import ErrorSeverity
19 | | from app.errors import map_exception_to_status
20 | | from app.utils.logging.context_vars import request_id_var, user_id_var
21 | | from app.utils.logging.error_adapter import (
22 | |     ErrorContext,
23 | |     ErrorMetadata,
24 | |     build_public_context,
25 | |     derive_error_metadata,
26 | |     get_error_suggestions,
27 | | )
28 | | from app.utils.logging.handlers import DatabaseLogHandler, DebugFilter
29 | | from app.utils.logging.queue_worker import LogQueueWorker
30 | | from app.types import ContextDict, JsonValue, LoggerExtra, StructlogEventDict
   | |_____________________________________________________________________________^
31 |
32 |   P = ParamSpec("P")
   |
help: Organize imports

TC003 Move standard library import `collections.abc.Callable` into a type-checking block
 --> app/utils/structlog_config.py:7:29
  |
5 | import atexit
6 | import sys
7 | from collections.abc import Callable
  |                             ^^^^^^^^
8 | from contextlib import suppress
9 | from functools import wraps
  |
help: Move into type-checking block

TC002 Move third-party import `flask.typing.ResponseReturnValue` into a type-checking block
  --> app/utils/structlog_config.py:14:26
   |
12 | import structlog
13 | from flask import Flask, current_app, g, has_request_context, jsonify
14 | from flask.typing import ResponseReturnValue
   |                          ^^^^^^^^^^^^^^^^^^^
15 | from flask_login import current_user
16 | from structlog.typing import BindableLogger, Processor
   |
help: Move into type-checking block

TC002 Move third-party import `structlog.typing.BindableLogger` into a type-checking block
  --> app/utils/structlog_config.py:16:30
   |
14 | from flask.typing import ResponseReturnValue
15 | from flask_login import current_user
16 | from structlog.typing import BindableLogger, Processor
   |                              ^^^^^^^^^^^^^^
17 |
18 | from app.constants.system_constants import ErrorSeverity
   |
help: Move into type-checking block

TC002 Move third-party import `structlog.typing.Processor` into a type-checking block
  --> app/utils/structlog_config.py:16:46
   |
14 | from flask.typing import ResponseReturnValue
15 | from flask_login import current_user
16 | from structlog.typing import BindableLogger, Processor
   |                                              ^^^^^^^^^
17 |
18 | from app.constants.system_constants import ErrorSeverity
   |
help: Move into type-checking block

PLC0415 `import` should be at the top-level of a file
  --> app/utils/time_utils.py:97:13
   |
95 |             return dt.astimezone(CHINA_TZ)
96 |         except (ValueError, TypeError) as e:
97 |             from app.utils.structlog_config import get_system_logger
   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
98 |
99 |             get_system_logger().warning(f"时间转换错误: {e}")
   |

PLC0415 `import` should be at the top-level of a file
   --> app/utils/time_utils.py:130:13
    |
128 |             return dt.astimezone(UTC_TZ)
129 |         except (ValueError, TypeError) as e:
130 |             from app.utils.structlog_config import get_system_logger
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
131 |
132 |             get_system_logger().warning(f"时间转换错误: {e}")
    |

PLR0911 Too many return statements (7 > 6)
   --> app/utils/time_utils.py:180:9
    |
179 |     @staticmethod
180 |     def get_relative_time(dt: str | date | datetime | None) -> str:
    |         ^^^^^^^^^^^^^^^^^
181 |         """获取相对时间描述.
    |

TRY300 Consider moving this statement to an `else` block
   --> app/utils/time_utils.py:279:13
    |
277 |             if isinstance(dt, date):
278 |                 return dt.isoformat()
279 |             return None
    |             ^^^^^^^^^^^
280 |         except (ValueError, TypeError):
281 |             return None
    |

RUF012 Mutable class attributes should be annotated with `typing.ClassVar`
  --> app/utils/version_parser.py:32:24
   |
31 |       # 版本提取正则表达式
32 |       VERSION_PATTERNS = {
   |  ________________________^
33 | |         "mysql": [
34 | |             r"(\d+\.\d+\.\d+)",  # 8.0.32
35 | |             r"(\d+\.\d+)",  # 8.0
36 | |         ],
37 | |         "postgresql": [
38 | |             r"PostgreSQL\s+(\d+\.\d+)",  # PostgreSQL 13.4
39 | |             r"(\d+\.\d+)",  # 13.4
40 | |         ],
41 | |         "sqlserver": [
42 | |             r"Microsoft SQL Server \d+\s+\([^)]+\)\s+\([^)]+\)\s+-\s+(\d+\.\d+\.\d+\.\d+)",  # 14.0.3465.1
43 | |             r"(\d+\.\d+\.\d+\.\d+)",  # 14.0.3465.1
44 | |         ],
45 | |         "oracle": [
46 | |             r"Oracle Database \d+g Release (\d+\.\d+\.\d+\.\d+\.\d+)",  # Oracle Database 11g Release 11.2.0.1.0
47 | |             r"(\d+\.\d+\.\d+\.\d+\.\d+)",  # 11.2.0.1.0
48 | |         ],
49 | |     }
   | |_____^
50 |
51 |       @classmethod
   |

C901 `_extract_main_version` is too complex (11 > 10)
   --> app/utils/version_parser.py:99:9
    |
 98 |     @classmethod
 99 |     def _extract_main_version(cls, version: str, db_type: str) -> str:
    |         ^^^^^^^^^^^^^^^^^^^^^
100 |         """提取主版本号.
    |

PLR0911 Too many return statements (11 > 6)
   --> app/utils/version_parser.py:99:9
    |
 98 |     @classmethod
 99 |     def _extract_main_version(cls, version: str, db_type: str) -> str:
    |         ^^^^^^^^^^^^^^^^^^^^^
100 |         """提取主版本号.
    |

I001 [*] Import block is un-sorted or un-formatted
  --> app/views/scheduler_forms.py:3:1
   |
 1 |   """定时任务表单视图."""
 2 |
 3 | / from __future__ import annotations
 4 | |
 5 | | from typing import Never, TYPE_CHECKING, Any
 6 | |
 7 | | from flask import Response, request
 8 | | from sqlalchemy.exc import SQLAlchemyError
 9 | |
10 | | from app.errors import NotFoundError, SystemError, ValidationError
11 | | from app.forms.definitions.scheduler_job import SCHEDULER_JOB_FORM_DEFINITION
12 | | from app.utils.response_utils import jsonify_unified_error_message, jsonify_unified_success
13 | | from app.views.mixins.resource_forms import ResourceFormView
   | |____________________________________________________________^
14 |
15 |   if TYPE_CHECKING:
   |
help: Organize imports

INP001 File `migrations/env.py` is part of an implicit namespace package. Add an `__init__.py`.
--> migrations/env.py:1:1

ANN201 Missing return type annotation for public function `get_engine`
  --> migrations/env.py:22:5
   |
22 | def get_engine():
   |     ^^^^^^^^^^
23 |     """获取当前 Flask 应用绑定的 SQLAlchemy Engine.
   |
help: Add return type annotation

ANN201 Missing return type annotation for public function `get_engine_url`
  --> migrations/env.py:43:5
   |
43 | def get_engine_url():
   |     ^^^^^^^^^^^^^^
44 |     """生成数据库连接串,供 Alembic 配置使用.
   |
help: Add return type annotation

ANN201 Missing return type annotation for public function `get_metadata`
  --> migrations/env.py:65:5
   |
63 | target_db = current_app.extensions["migrate"].db
64 |
65 | def get_metadata():
   |     ^^^^^^^^^^^^
66 |     """获取迁移需要的元数据对象.
   |
help: Add return type annotation

ANN001 Missing type annotation for function argument `_context`
   --> migrations/env.py:119:37
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                     ^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

ANN001 Missing type annotation for function argument `_revision`
   --> migrations/env.py:119:47
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                               ^^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

ANN001 Missing type annotation for function argument `directives`
   --> migrations/env.py:119:58
    |
117 |     # when there are no changes to the schema
118 |     # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html
119 |     def process_revision_directives(_context, _revision, directives) -> None:
    |                                                          ^^^^^^^^^^
120 |         """在自动迁移期间剔除空的升级操作."""
121 |         if getattr(config.cmd_opts, "autogenerate", False):
    |

N999 Invalid module name: 'gunicorn-dev.conf'
--> nginx/gunicorn/gunicorn-dev.conf.py:1:1

N999 Invalid module name: 'gunicorn-prod.conf'
--> nginx/gunicorn/gunicorn-prod.conf.py:1:1

SIM105 Use `contextlib.suppress(BaseException)` instead of `try`-`except`-`pass`
 --> tmp_ble_test.py:1:1
  |
1 | / try:
2 | |     pass
3 | | except BaseException:
4 | |     pass
  | |________^
  |
help: Replace `try`-`except`-`pass` with `with contextlib.suppress(BaseException): ...`

D100 Missing docstring in public module
--> tmp_ble_test.py:1:1

S110 `try`-`except`-`pass` detected, consider logging the exception
 --> tmp_ble_test.py:3:1
  |
1 |   try:
2 |       pass
3 | / except BaseException:
4 | |     pass
  | |________^
  |

BLE001 Do not catch blind exception: `BaseException`
 --> tmp_ble_test.py:3:8
  |
1 | try:
2 |     pass
3 | except BaseException:
  |        ^^^^^^^^^^^^^
4 |     pass
  |

Found 490 errors.
[*] 88 fixable with the `--fix` option (58 hidden fixes can be enabled with the `--unsafe-fixes` option).
