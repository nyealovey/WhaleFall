# 变更历史描述信息优化方案

## 背景
- 变更历史的描述信息过于散乱，字段语义不清晰，前端展示依赖旧的国际化（i18n）占位符。
- 业务只在中文环境下使用，无需继续维护多语言文案，反而增加了前后端维护成本。
- `privilege_diff`、`other_diff` 字段定义不清，导致接口消费者无法准确渲染差异化信息。

## 目标
1. **取消国际化支持**：所有历史描述信息统一输出中文字符串；i18n key 一律移除。
2. **字段语义清晰**：重新定义 `privilege_diff` 与 `other_diff` 的结构与用途。
3. **输出模板化**：在服务层统一拼接文案，前端直接展示，不再做二次拼接。

## 字段说明
| 字段 | 类型 | 说明 | 示例 | 常见使用场景 |
| --- | --- | --- | --- | --- |
| `privilege_diff` | `list[PrivilegeChange]` | 只包含数据库权限（Grant/Revoke）差异；每条记录体现对象、权限、动作 | `{"object":"db1.table","action":"GRANT","permissions":["SELECT"]}` | 账户权限同步、角色授权变更 |
| `other_diff` | `list[DiffEntry]` | 非权限变化，包括基础属性（锁定状态、备注）、附加信息（关联标签等） | `{"field":"locked","before":false,"after":true,"description":"账户被锁定"}` | 任何与权限无关的字段变更 |

> **约束**：`privilege_diff` 与 `other_diff` 均使用数组，保持时间顺序；若对应类别无差异，则返回空数组而非 `null`。

### PrivilegeChange 结构
```json
{
  "object": "gf-alktmdb-01l.db1.orders",
  "action": "REVOKE",
  "permissions": ["INSERT", "UPDATE"],
  "scope": "TABLE",           // 可选：DATABASE / TABLE / SERVER
  "grantee": "app_user"       // 可选：授权对象
}
```
- 仅记录权限相关差异，避免与其他变更混杂。
- `action` 枚举：`GRANT` / `REVOKE` / `ALTER`（如权限级别调整）。

### DiffEntry 结构
```json
{
  "field": "description",
  "label": "描述信息",
  "before": "旧描述",
  "after": "新描述",
  "description": "账户描述被更新"
}
```
- `label` 为中文显示名称；若为空由前端回退为 `field`。
- `description` 用于直观说明，可由服务层拼接（如“状态从启用 -> 停用”）。

## 文案规范
1. **服务层拼接**：在差异计算后生成最终可读文案，例如：
   ```python
   message = f"账户 {account.username} 权限更新，新增 {len(grants)} 项授权，撤销 {len(revokes)} 项"
   ```
2. **统一中文**：术语统一，如“授权”“撤销”“锁定”“标签”等，不再使用英文或 i18n key。
3. **多条差异**：若 `privilege_diff` 与 `other_diff` 同时存在，摘要中按照“权限变化 + 其他变化”顺序描述。

## 输出示例
```json
{
  "account_id": 101,
  "summary": "账户 app_user 权限更新：新增 1 项授权，撤销 2 项；描述信息已修改。",
  "privilege_diff": [
    {"object":"db1.orders","action":"GRANT","permissions":["SELECT"]},
    {"object":"db1.customers","action":"REVOKE","permissions":["INSERT","UPDATE"]}
  ],
  "other_diff": [
    {"field":"description","label":"描述","before":"旧描述","after":"新描述","description":"描述信息已修改"}
  ],
  "created_at": "2025-11-05T06:00:00Z"
}
```

## 实施步骤
1. **移除 i18n**：删除历史描述中对 `gettext`、`lazy_gettext` 的调用；将模板文本迁移为直写中文。
2. **调整差异计算**：
   - 权限同步流程中，拆分权限与其他字段的 diff；确保 `privilege_diff` 仅记录权限对象。
   - 其他属性变更（锁定、备注、标签等）统一放入 `other_diff`。
3. **统一摘要生成**：由服务层调用 `build_history_summary(privilege_diff, other_diff)` 返回中文摘要。
4. **前端适配**：前端组件直接渲染 `summary`，并根据 `privilege_diff` / `other_diff` 是否为空决定展示模块。

## 测试建议
- 构造三类场景：只修改权限、只修改其他字段、两者同时存在。
- 校验接口返回是否符合字段约定，特别是空数组与中文摘要。
- 确认前端在无 i18n 情况下仍能正确显示内容。

## 后续事项
- 若未来需要重新引入多语言，可在服务层为每个字段提供语言包映射；当前版本默认中文。
- 建议在 `docs/fix_account_sync_success_message.md` 中引用本方案，保持差异描述一致性。
