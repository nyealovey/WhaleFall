# Flaskå•ç‹¬éƒ¨ç½² Makefile
# ç”¨äºéƒ¨ç½²Flaskåº”ç”¨ï¼Œè¿æ¥localhostçš„PostgreSQLå’ŒRedis

.PHONY: help start stop restart status logs logs-app shell health build clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "ğŸŸ Flaskå•ç‹¬éƒ¨ç½²å‘½ä»¤"
	@echo "=================================="
	@echo "éƒ¨ç½²å‘½ä»¤:"
	@echo "  start       - å¯åŠ¨Flaskåº”ç”¨"
	@echo "  stop        - åœæ­¢Flaskåº”ç”¨"
	@echo "  restart     - é‡å¯Flaskåº”ç”¨"
	@echo "  status      - æŸ¥çœ‹åº”ç”¨çŠ¶æ€"
	@echo ""
	@echo "æ—¥å¿—å‘½ä»¤:"
	@echo "  logs        - æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—"
	@echo "  logs-app    - æŸ¥çœ‹Flaskåº”ç”¨æ—¥å¿—"
	@echo ""
	@echo "ç®¡ç†å‘½ä»¤:"
	@echo "  shell       - è¿›å…¥Flaskå®¹å™¨shell"
	@echo "  health      - å¥åº·æ£€æŸ¥"
	@echo "  build       - æ„å»ºFlaské•œåƒ"
	@echo "  clean       - æ¸…ç†Flaskå®¹å™¨å’Œé•œåƒ"
	@echo ""
	@echo "æ³¨æ„: æ­¤éƒ¨ç½²æ–¹å¼ä½¿ç”¨hostç½‘ç»œï¼Œè¿æ¥localhostçš„PostgreSQLå’ŒRedis"
	@echo "=================================="

# å¯åŠ¨Flaskåº”ç”¨
start:
	@echo "ğŸš€ å¯åŠ¨Flaskåº”ç”¨ï¼ˆè¿æ¥localhostæœåŠ¡ï¼‰..."
	@docker-compose -f docker-compose.flask-only.yml up -d
	@echo "âœ… Flaskåº”ç”¨å¯åŠ¨å®Œæˆ"
	@echo "ğŸŒ è®¿é—®åœ°å€: http://localhost"
	@echo "ğŸ“Š ç®¡ç†ç•Œé¢: http://localhost/admin"

# åœæ­¢Flaskåº”ç”¨
stop:
	@echo "â¹ï¸  åœæ­¢Flaskåº”ç”¨..."
	@docker-compose -f docker-compose.flask-only.yml down
	@echo "âœ… Flaskåº”ç”¨å·²åœæ­¢"

# é‡å¯Flaskåº”ç”¨
restart: stop start
	@echo "ğŸ”„ Flaskåº”ç”¨é‡å¯å®Œæˆ"

# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
status:
	@echo "ğŸ“Š Flaskåº”ç”¨çŠ¶æ€:"
	@docker-compose -f docker-compose.flask-only.yml ps
	@echo ""
	@echo "ğŸ” å®¹å™¨è¯¦ç»†ä¿¡æ¯:"
	@docker ps --filter "name=whalefall_app_prod" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹Flaskåº”ç”¨æ—¥å¿—..."
	@docker-compose -f docker-compose.flask-only.yml logs -f

# æŸ¥çœ‹Flaskåº”ç”¨æ—¥å¿—
logs-app:
	@echo "ğŸ“‹ æŸ¥çœ‹Flaskåº”ç”¨æ—¥å¿—..."
	@docker-compose -f docker-compose.flask-only.yml logs -f whalefall

# è¿›å…¥Flaskå®¹å™¨shell
shell:
	@echo "ğŸš è¿›å…¥Flaskå®¹å™¨shell..."
	@docker-compose -f docker-compose.flask-only.yml exec whalefall /bin/bash

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ Flaskåº”ç”¨å¥åº·æ£€æŸ¥..."
	@if curl -f http://localhost/health >/dev/null 2>&1; then \
		echo "âœ… Flaskåº”ç”¨è¿è¡Œæ­£å¸¸"; \
		echo "ğŸŒ è®¿é—®åœ°å€: http://localhost"; \
		echo "ğŸ“Š ç®¡ç†ç•Œé¢: http://localhost/admin"; \
	else \
		echo "âŒ Flaskåº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"; \
		echo "è¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£åœ¨è¿è¡Œ: make status"; \
	fi

# æ„å»ºFlaské•œåƒ
build:
	@echo "ğŸ”¨ æ„å»ºFlaskåº”ç”¨é•œåƒ..."
	@docker-compose -f docker-compose.flask-only.yml build --no-cache
	@echo "âœ… Flaskåº”ç”¨é•œåƒæ„å»ºå®Œæˆ"

# æ¸…ç†Flaskå®¹å™¨å’Œé•œåƒ
clean:
	@echo "ğŸ§¹ æ¸…ç†Flaskå®¹å™¨å’Œé•œåƒ..."
	@docker-compose -f docker-compose.flask-only.yml down --rmi all --volumes --remove-orphans
	@docker image prune -f
	@echo "âœ… Flaskå®¹å™¨å’Œé•œåƒæ¸…ç†å®Œæˆ"

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
version:
	@echo "ğŸ“‹ Flaskåº”ç”¨ç‰ˆæœ¬ä¿¡æ¯ï¼š"
	@echo "é¡¹ç›®ç‰ˆæœ¬: $$(grep APP_VERSION .env 2>/dev/null | cut -d'=' -f2 || echo 'æœªè®¾ç½®')"
	@echo "Dockerç‰ˆæœ¬: $$(docker --version)"
	@echo "Docker Composeç‰ˆæœ¬: $$(docker-compose --version)"
	@echo "Flaskå®¹å™¨çŠ¶æ€: $$(docker ps --filter 'name=whalefall_app_prod' --format '{{.Status}}' 2>/dev/null || echo 'æœªè¿è¡Œ')"

# å¿«é€Ÿå¯åŠ¨ï¼ˆåå°è¿è¡Œï¼‰
start-bg:
	@echo "ğŸš€ åå°å¯åŠ¨Flaskåº”ç”¨..."
	@docker-compose -f docker-compose.flask-only.yml up -d
	@echo "âœ… Flaskåº”ç”¨å·²åœ¨åå°å¯åŠ¨"
	@echo "ğŸŒ è®¿é—®åœ°å€: http://localhost"

# å¿«é€Ÿåœæ­¢
stop-quick:
	@echo "â¹ï¸  å¿«é€Ÿåœæ­¢Flaskåº”ç”¨..."
	@docker-compose -f docker-compose.flask-only.yml down
	@echo "âœ… Flaskåº”ç”¨å·²åœæ­¢"

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
logs-follow:
	@echo "ğŸ“‹ å®æ—¶æŸ¥çœ‹Flaskåº”ç”¨æ—¥å¿—..."
	@docker-compose -f docker-compose.flask-only.yml logs -f --tail=100

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
rebuild: clean build start
	@echo "ğŸ”„ Flaskåº”ç”¨é‡æ–°æ„å»ºå¹¶å¯åŠ¨å®Œæˆ"

# é˜²æ­¢ç›®æ ‡è¢«å½“ä½œæ–‡ä»¶
%:
	@:
